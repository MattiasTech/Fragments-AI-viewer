<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Fragments Viewer (IFC + FRAG)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- One CDN + pinned, compatible versions -->
 <script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.175.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.175.0/examples/jsm/",

    "@thatopen/components":        "https://cdn.jsdelivr.net/npm/@thatopen/components@3.1.2/dist/index.mjs",
    "@thatopen/fragments":         "https://cdn.jsdelivr.net/npm/@thatopen/fragments@3.1.7/dist/index.mjs",
    "@thatopen/components-front":  "https://cdn.jsdelivr.net/npm/@thatopen/components-front@3.1.3/dist/index.js",

    "@thatopen/ui":     "https://cdn.jsdelivr.net/npm/@thatopen/ui@3.1.3/dist/index.js",
    "@thatopen/ui-obc": "https://cdn.jsdelivr.net/npm/@thatopen/ui-obc@3.1.5/dist/index.js",

    "web-ifc": "https://cdn.jsdelivr.net/npm/web-ifc@0.0.69/web-ifc-api.js"
  }
}
</script>
  <style>
    :root { --bg:#0c0f14; --fg:#e6eefc; --panel:#0b1120; --border:#1f2a44; }
    html, body { height:100%; margin:0; }
    body { background:var(--bg); color:var(--fg); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    header { position:fixed; inset:0 0 auto 0; display:flex; gap:.5rem; align-items:center;
             padding:.5rem .75rem; background:var(--panel); border-bottom:1px solid var(--border); z-index:10 }
    header .spacer { flex:1 }
    header .btn { cursor:pointer; border:1px solid #2a3a64; background:#121a2b; color:#cde; padding:.3rem .55rem; border-radius:.35rem; }
    input[type=file] { display:none }

    #stage { position:fixed; inset:40px 0 0 0; }
    #container { width:100%; height:100%; }
    #dropzone { position:absolute; inset:0; border:2px dashed rgba(255,255,255,.25);
                display:grid; place-items:center; pointer-events:none; opacity:0; transition:.2s; }
    #dropzone.active { opacity:1; background:rgba(0,0,0,.25); }

    /* Panel placement */
    bim-panel.viewer-panel { position:fixed; left:12px; top:56px; max-width:380px; z-index:11 }
  </style>
</head>
<body>
  <header>
    <strong>Fragments Viewer</strong>
    <span class="spacer"></span>
    <label class="btn">
      <input id="file" type="file" accept=".ifc,.IFC,.frag,.FRAG" />
      Open IFC/FRAG…
    </label>
    <a class="btn" target="_blank" rel="noopener" href="https://github.com/ThatOpen/engine_components">engine_components</a>
  </header>

  <div id="stage">
    <div id="container"></div>
    <div id="progress" style="position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:60%;max-width:720px;z-index:20;display:none">
      <div style="background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.06);padding:6px;border-radius:6px;">
        <div id="progressBarWrap" style="background:rgba(0,0,0,.25);height:12px;border-radius:4px;overflow:hidden">
          <div id="progressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#3aa1ff,#66ffb3);transition:width .15s ease"></div>
        </div>
        <div id="progressLabel" style="margin-top:6px;color:var(--fg);font-size:12px;text-align:center">Waiting</div>
      </div>
    </div>
    <div id="dropzone"><div style="color:#fff;font:600 16px system-ui">Drop IFC or FRAG here</div></div>
  </div>

  <!-- Optional: offline shell caching if you have sw.js -->
  <script>
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
  </script>

  <script type="module">
    import * as THREE from "three";
    import * as OBC   from "@thatopen/components";
    import * as FRAGS from "@thatopen/fragments";
    import * as BUI     from "@thatopen/ui";

    // Warn when opened directly from file:// where Web Workers will fail
    if (location.protocol === "file:") {
      const msg = [
        "This viewer uses Web Workers and WASM, which cannot run from file://.",
        "Please serve this folder over HTTP and open via http://localhost.",
        "",
        "Quick options (run in PowerShell from this folder):",
        "  • Python 3:  python -m http.server 8080",
        "  • Node.js:   npx http-server -p 8080",
        "",
        "Then open: http://localhost:8080/index.html",
      ].join("\n");
      alert(msg);
    }

    // --- Core Setup ---
    const container = document.getElementById("container");
    const components = new OBC.Components();

    // 1. Set up Fragments and IFC Loader BEFORE initializing components
    const fragments = new FRAGS.FragmentsModels();
    const ifcLoader = components.get(OBC.IfcLoader);

    ifcLoader.settings.wasm = {
        path: "https://cdn.jsdelivr.net/npm/web-ifc@0.0.69/",
        absolute: true,
    };

    // 2. CRITICAL STEP: Connect fragments to the loader
    ifcLoader.fragments = fragments;

    // 3. Now that components are configured, initialize them
    await components.init();

    // 4. Create the 3D world
    const worlds = components.get(OBC.Worlds);
    const world = worlds.create();
    world.scene = new OBC.SimpleScene(components);
    world.renderer = new OBC.SimpleRenderer(components, container);
    world.camera = new OBC.SimpleCamera(components);
    world.scene.setup();
    world.camera.controls.setLookAt(10, 10, 10, 0, 0, 0);

    const grids = components.get(OBC.Grids);
    grids.create(world);

    // --- UI Setup ---
    BUI.Manager.init();
    const panel = document.createElement('bim-panel');
    panel.className = 'viewer-panel';
    panel.setAttribute('label', 'Viewer Controls');
    panel.setAttribute('active', '');
    panel.innerHTML = `
      <bim-panel-section label="Load">
        <bim-label style="white-space:normal">Open an <b>IFC</b> or a prebuilt <b>FRAG</b> file.</bim-label>
        <bim-toolbar><bim-toolbar-group>
            <bim-button id="openBtn" icon="mdi:file-upload">Open IFC/FRAG…</bim-button>
        </bim-toolbar-group></bim-toolbar>
      </bim-panel-section>
      <bim-panel-section label="Navigation">
        <bim-toolbar>
          <bim-toolbar-group>
            <bim-button id="fitBtn"  icon="mdi:focus-field">Fit to model</bim-button>
            <bim-button id="homeBtn" icon="mdi:undo-variant">Reset view</bim-button>
          </bim-toolbar-group>
          <bim-toolbar-group>
            <bim-selector id="projSel" label="Projection" value="persp">
              <bim-option value="persp">Perspective</bim-option>
              <bim-option value="ortho">Orthographic</bim-option>
            </bim-selector>
            <bim-checkbox id="gridCbx" label="Grid" checked></bim-checkbox>
            <bim-checkbox id="wireCbx" label="Wireframe"></bim-checkbox>
          </bim-toolbar-group>
        </bim-toolbar>
      </bim-panel-section>
      <bim-panel-section label="Stats">
        <bim-label id="statsLabel">Meshes: 0 • Tris: 0</bim-label>
      </bim-panel-section>
    `;
    document.body.appendChild(panel);

    // --- UI Events ---
    const fileInput  = document.getElementById("file");
    const openBtn    = panel.querySelector("#openBtn");
    const fitBtn     = panel.querySelector("#fitBtn");
    const homeBtn    = panel.querySelector("#homeBtn");
    const projSel    = panel.querySelector("#projSel");
    const gridCbx    = panel.querySelector("#gridCbx");
    const wireCbx    = panel.querySelector("#wireCbx");
    const statsLabel = panel.querySelector("#statsLabel");

    openBtn.addEventListener("click", () => fileInput.click());
    fitBtn.addEventListener("click", () => world.camera.controls.fitToBox(world.scene.three, true));
    homeBtn.addEventListener("click", () => world.camera.controls.reset(true));
    projSel.addEventListener("change", (e) => world.camera.setProjection(e.target.value));
    gridCbx.addEventListener("change", (e) => grids.list.forEach(g => g.visible = e.target.checked));
    wireCbx.addEventListener("change", (e) => setWireframe(e.target.checked));

    // --- File Handling ---
    fileInput.addEventListener("change", (e) => openFile(e.target.files?.[0]));

    const dropzone = document.getElementById("dropzone");
    ["dragenter","dragover"].forEach(ev => container.addEventListener(ev, (e) => { e.preventDefault(); dropzone.classList.add("active"); }));
    ["dragleave","drop"].forEach(ev => container.addEventListener(ev, (e) => { e.preventDefault(); dropzone.classList.remove("active"); }));
    container.addEventListener("drop", (e) => openFile(e.dataTransfer?.files?.[0]));

    async function openFile(file) {
      if (!file) return;
      if (/\.ifc$/i.test(file.name)) await loadIFC(file);
      else if (/\.frag$/i.test(file.name)) await loadFRAG(file);
      else alert("Please select an .ifc or .frag file.");
      fileInput.value = ""; // Reset for re-selection
    }

    // --- Loading Functions ---
    const progressRoot = document.getElementById('progress');
    const progressLabel = document.getElementById('progressLabel');
    const progressBar = document.getElementById('progressBar');

    async function loadIFC(file) {
      progressRoot.style.display = "block";
      progressLabel.textContent = "Loading IFC...";
      progressBar.style.width = "0%";
      try {
        const model = await ifcLoader.load(file);
        world.scene.three.add(model);
        updateStats();
        world.camera.controls.fitToBox(model, true);
      } catch (error) {
        alert(`Error loading IFC: ${error.message}`);
      } finally {
        progressRoot.style.display = "none";
      }
    }

    async function loadFRAG(file) {
      progressRoot.style.display = "block";
      progressLabel.textContent = "Loading FRAG...";
      progressBar.style.width = "0%";
      try {
        const data = await file.arrayBuffer();
        // Use filename (without extension) as a stable modelId required by fragments
        const modelId = (file.name || "model").replace(/\.[^/.]+$/, "");
        const model = await fragments.load(data, { modelId });
        world.scene.three.add(model.object);
        updateStats();
        world.camera.controls.fitToBox(model.object, true);
      } catch (error) {
        alert(`Error loading FRAG: ${error.message}`);
      } finally {
        progressRoot.style.display = "none";
      }
    }

    // --- Utilities ---
    function setWireframe(enabled) {
      world.scene.three.traverse(child => {
        if (child.isMesh) child.material.wireframe = enabled;
      });
    }

    function updateStats() {
      let meshes = 0, tris = 0;
      world.scene.three.traverse(o => {
        if (o.isMesh) {
          meshes++;
          tris += o.geometry.index ? o.geometry.index.count / 3 : o.geometry.attributes.position.count / 3;
        }
      });
      statsLabel.textContent = `Meshes: ${meshes} • Tris: ${Math.round(tris).toLocaleString()}`;
    }
  </script>
</body>
</html>
