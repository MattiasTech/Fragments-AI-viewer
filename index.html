<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>IFC → Fragments (That Open) • GitHub Pages</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Import map: pin ONE CDN (jsDelivr) and exact versions -->
  <script type="importmap">
  {
    "imports": {
      "three": "https://cdn.jsdelivr.net/npm/three@0.165.0/build/three.module.js",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.165.0/examples/jsm/",
      "@thatopen/fragments": "https://cdn.jsdelivr.net/npm/@thatopen/fragments@3.1.7/dist/index.js"
    }
  }
  </script>
  <style>
    html, body { height: 100%; margin: 0; }
    body { background: #0c0f14; color: #e6eefc; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    header { position: fixed; inset: 0 0 auto 0; display:flex; gap:.5rem; align-items:center; padding:.5rem .75rem; background:#0b1120; border-bottom:1px solid #1f2a44; z-index:10 }
    header strong { letter-spacing:.2px }
    header .spacer { flex:1 }
    header .btn { cursor:pointer; border:1px solid #2a3a64; background:#121a2b; color:#cde; padding:.3rem .55rem; border-radius:.35rem; }
    #stage { position: fixed; inset: 40px 0 0 0; }
    #dropzone {
      position: absolute; inset: 0; border: 2px dashed rgba(255,255,255,.25);
      display: grid; place-items: center; pointer-events: none; opacity: 0; transition: .2s;
    }
    #dropzone.active { opacity: 1; background: rgba(0,0,0,.25); }
    input[type=file] { display:none }
  </style>
</head>
<body>
  <header>
    <strong>That Open • IFC→Fragments Viewer</strong>
    <span class="spacer"></span>
    <label class="btn">
      <input id="file" type="file" accept=".ifc,.IFC,.frag,.FRAG" />
      Open IFC/FRAG…
    </label>
    <button id="downloadFrag" class="btn" disabled title="Download last converted .frag">Download .frag</button>
    <a class="btn" target="_blank" rel="noopener" href="https://docs.thatopen.com/">Docs</a>
  </header>

  <div id="stage">
    <canvas id="c"></canvas>
    <div id="dropzone"><div style="color:#fff;font:600 16px system-ui">Drop IFC/FRAG here</div></div>
  </div>

  <script type="module">
    import * as THREE from "three";
    import { OrbitControls } from "three/addons/controls/OrbitControls.js";
    import * as FRAGS from "@thatopen/fragments";

    // --- Three.js scene ---
    const canvas = document.getElementById("c");
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));

    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0c0f14);

    const camera = new THREE.PerspectiveCamera(60, 2, 0.1, 10_000);
    camera.position.set(60, 25, -30);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.addEventListener("end", () => fragments.update(true));

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x223344, 0.6);
    scene.add(hemi);
    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
    dir.position.set(50, 80, -30);
    scene.add(dir);

    function resize() {
      const { clientWidth: w, clientHeight: h } = renderer.domElement.parentElement;
      camera.aspect = w / h; camera.updateProjectionMatrix();
      renderer.setSize(w, h, false);
    }
    new ResizeObserver(resize).observe(document.getElementById("stage"));
    resize();

    function animate(t=0){ requestAnimationFrame(animate); controls.update(); renderer.render(scene, camera); }
    animate();

    // --- Fragments core + worker (official blob-worker pattern) ---
    // Source: docs tutorial shows fetching That Open’s hosted worker and using a Blob URL.
    // https://thatopen.github.io/engine_fragment/resources/worker.mjs
    const workerBlob = await (await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob();
    const workerUrl = URL.createObjectURL(new File([workerBlob], "worker.mjs", { type: "text/javascript" }));
    const fragments = new FRAGS.FragmentsModels(workerUrl);

    // Add any model to the scene as soon as it’s ready
    fragments.models.list.onItemSet.add(({ value: model }) => {
      model.useCamera(camera);
      scene.add(model.object);
      fragments.update(true);
    });

    // --- IFC → Fragments importer (browser) ---
    const importer = new FRAGS.IfcImporter();
    // Use the exact web-ifc path/version from the docs tutorial (with trailing slash).
    importer.wasm = { absolute: true, path: "https://unpkg.com/web-ifc@0.0.69/" };

    // --- I/O helpers ---
    const fileInput = document.getElementById("file");
    const downloadBtn = document.getElementById("downloadFrag");
    let lastFragBuffer = null;

    async function loadFRAGBuffer(buffer, name) {
      await fragments.load(buffer, { modelId: name });
      await fragments.update(true);
    }

    async function convertIFCToFRAG(file) {
      const bytes = new Uint8Array(await file.arrayBuffer());
      const fragBytes = await importer.process({
        bytes,
        progressCallback: (p) => console.log("IFC→Fragments progress:", p),
      });
      lastFragBuffer = fragBytes;
      downloadBtn.disabled = false;
      await loadFRAGBuffer(fragBytes, file.name.replace(/\.[^/.]+$/, ""));
    }

    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      if (/\.frag$/i.test(file.name)) {
        await loadFRAGBuffer(await file.arrayBuffer(), file.name.replace(/\.[^/.]+$/, ""));
      } else if (/\.ifc$/i.test(file.name)) {
        await convertIFCToFRAG(file);
      } else {
        alert("Please choose an .ifc or .frag file.");
      }
      fileInput.value = "";
    });

    // Drag & drop
    const stage = document.getElementById("stage");
    const dropzone = document.getElementById("dropzone");
    ["dragenter","dragover"].forEach(ev => stage.addEventListener(ev, (e) => {
      e.preventDefault(); dropzone.classList.add("active");
    }));
    ["dragleave","drop"].forEach(ev => stage.addEventListener(ev, (e) => {
      e.preventDefault(); dropzone.classList.remove("active");
    }));
    stage.addEventListener("drop", async (e) => {
      const file = e.dataTransfer.files?.[0]; if (!file) return;
      if (/\.frag$/i.test(file.name)) {
        await loadFRAGBuffer(await file.arrayBuffer(), file.name.replace(/\.[^/.]+$/, ""));
      } else if (/\.ifc$/i.test(file.name)) {
        await convertIFCToFRAG(file);
      } else {
        alert("Drop an .ifc or .frag file.");
      }
    });

    // Download last converted .frag
    downloadBtn.addEventListener("click", () => {
      if (!lastFragBuffer) return;
      const file = new File([lastFragBuffer], "model.frag");
      const a = document.createElement("a");
      a.href = URL.createObjectURL(file);
      a.download = file.name;
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
