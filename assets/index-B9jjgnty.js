const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-CtMMS5qr.js","assets/vendor-NpE_gqg9.js","assets/thatopen-vendor-byvyd1e5.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-DVJp9OOk.js","assets/IdsCreatorPanel-SsiH5t__.js","assets/ModelFilterPanel-QI5d57eT.js"])))=>i.map(i=>d[i]);
import{ck as Ss,cl as js,cm as d,cn as Rt,co as o,cp as W,cq as U,cr as te,cs as ee,ct as vs,cu as ks,cv as Es,cw as Ps,cx as As,cy as Ms,cz as Rs,cA as ie,cB as Xr,cC as Jr,cD as Zr,cE as Qr,cF as je,cG as zs,cH as en,cI as $s,cJ as tn,cK as on,cL as Ds,cM as rn,cN as Ut,cO as Et,cP as Ht,cQ as Fs,cR as Ts,cS as nn,cT as Ns,cU as Os,cV as Jo,cW as Ls,cX as Vs,cY as Bs,cZ as _s,c_ as Gs,c$ as sn,d0 as ln,d1 as Zo,d2 as Qo,d3 as er,d4 as an,d5 as cn,d6 as dn,d7 as qt,d8 as Kt,d9 as tr,da as Ws,db as Us,dc as or,dd as Hs,de as qs}from"./vendor-NpE_gqg9.js";import{l as Ks,_ as Ys,C as Xs,W as Js,S as Zs,a as Qs,O as el,G as tl,F as ol,t as rl,H as nl,Y as sl,$ as un}from"./thatopen-vendor-byvyd1e5.js";import{B as it,V as Z,C as Ae,a3 as ll,c as fn,P as Pt,a6 as rr,l as pn,G as il,S as al,h as mn,$ as cl,y as gn,ab as dl,D as ul}from"./three-vendor-kQcUiZz9.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))b(i);new MutationObserver(i=>{for(const g of i)if(g.type==="childList")for(const x of g.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&b(x)}).observe(document,{childList:!0,subtree:!0});function a(i){const g={};return i.integrity&&(g.integrity=i.integrity),i.referrerPolicy&&(g.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?g.credentials="include":i.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function b(i){if(i.ep)return;i.ep=!0;const g=a(i);fetch(i.href,g)}})();const fl="modulepreload",pl=function(t){return"/Savora-Viewer/"+t},hn={},Mt=function(s,a,b){let i=Promise.resolve();if(a&&a.length>0){let P=function(m){return Promise.all(m.map(k=>Promise.resolve(k).then(j=>({status:"fulfilled",value:j}),j=>({status:"rejected",reason:j}))))};document.getElementsByTagName("link");const x=document.querySelector("meta[property=csp-nonce]"),h=x?.nonce||x?.getAttribute("nonce");i=P(a.map(m=>{if(m=pl(m),m in hn)return;hn[m]=!0;const k=m.endsWith(".css"),j=k?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${j}`))return;const O=document.createElement("link");if(O.rel=k?"stylesheet":fl,k||(O.as="script"),O.crossOrigin="",O.href=m,h&&O.setAttribute("nonce",h),document.head.appendChild(O),k)return new Promise((D,S)=>{O.addEventListener("load",D),O.addEventListener("error",()=>S(new Error(`Unable to preload CSS for ${m}`)))})}))}function g(x){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=x,window.dispatchEvent(h),!h.defaultPrevented)throw x}return i.then(x=>{for(const h of x||[])h.status==="rejected"&&g(h.reason);return s().catch(g)})},ar="bim_viewer_api_config",ml=t=>{try{return btoa(t)}catch{return t}},gl=t=>{try{return atob(t)}catch{return t}},hl=t=>{const s={...t,apiKey:ml(t.apiKey)};localStorage.setItem(ar,JSON.stringify(s))},yl=()=>{const t=localStorage.getItem(ar);if(!t)return null;try{const s=JSON.parse(t);return{...s,apiKey:gl(s.apiKey)}}catch{return null}},bl=()=>{localStorage.removeItem(ar)},xl=t=>{switch(t){case"gemini":return["gemini-2.5-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},xo=t=>{switch(t){case"gemini":return"gemini-2.5-flash";case"openai":return"gpt-4o-mini";default:return""}},wl=async(t,s,a="gemini-2.5-flash")=>{const b=`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${t}`,i=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s}]}]})});if(!i.ok){const x=await i.json().catch(()=>({}));throw new Error(x.error?.message||`Gemini API error: ${i.status} ${i.statusText}`)}const g=await i.json();if(!g.candidates||g.candidates.length===0)throw new Error("No response from Gemini API");return g.candidates[0].content.parts[0].text},Il=async(t,s="gemini-2.0-flash-exp")=>{try{return await wl(t,"Hello, respond with OK",s),!0}catch{return!1}},Cl=async(t,s,a="gpt-4o-mini")=>{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:a,messages:[{role:"user",content:s}]})});if(!i.ok){const x=await i.json().catch(()=>({}));throw new Error(x.error?.message||`OpenAI API error: ${i.status} ${i.statusText}`)}const g=await i.json();if(!g.choices||g.choices.length===0)throw new Error("No response from OpenAI API");return g.choices[0].message.content},Sl=async(t,s="gpt-4o-mini")=>{try{return await Cl(t,"Hello, respond with OK",s),!0}catch{return!1}},jl="fragments-ids",le="elements-v5",de="cache-metadata-v1",vl=6,ve=()=>new Promise((t,s)=>{const a=indexedDB.open(jl,vl);a.onerror=()=>s(a.error??new Error("IndexedDB open failed")),a.onupgradeneeded=()=>{const b=a.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(g=>{b.objectStoreNames.contains(g)&&b.deleteObjectStore(g)}),b.objectStoreNames.contains(le)||b.createObjectStore(le),b.objectStoreNames.contains(de)||b.createObjectStore(de)},a.onsuccess=()=>t(a.result)}),nr={async get(t){const s=await ve();return new Promise((a,b)=>{const x=s.transaction(le,"readonly").objectStore(le).get(t);x.onsuccess=()=>a(x.result??null),x.onerror=()=>b(x.error??new Error("IndexedDB get failed"))})},async set(t,s){const a=await ve();await new Promise((b,i)=>{const g=a.transaction([le,de],"readwrite"),x=g.objectStore(le),h=g.objectStore(de),P=x.put(s,t),m={modelKey:t,timestamp:Date.now(),elementCount:s.length,version:"1.0"};h.put(m,t),P.onsuccess=()=>b(),P.onerror=()=>i(P.error??new Error("IndexedDB set failed"))}),console.log(`üíæ Cached ${s.length} elements to IndexedDB for key: ${t.substring(0,16)}...`)},async append(t,s){if(!s||!s.length)return;const a=await ve();await new Promise((b,i)=>{const g=a.transaction([le,de],"readwrite"),x=g.objectStore(le),h=g.objectStore(de),P=x.get(t);P.onsuccess=()=>{const k=(P.result??[]).concat(s),j=x.put(k,t),O={modelKey:t,timestamp:Date.now(),elementCount:k.length,version:"1.0"};h.put(O,t),j.onsuccess=()=>b(),j.onerror=()=>i(j.error??new Error("IndexedDB append put failed"))},P.onerror=()=>i(P.error??new Error("IndexedDB append get failed"))}),console.log(`üíæ Appended ${s.length} elements to IndexedDB for key: ${t.substring(0,16)}...`)},async writePart(t,s,a){const b=`${t}::part::${String(s).padStart(6,"0")}`,i=`${t}::partindex::${String(s).padStart(6,"0")}`,g=await ve();await new Promise((x,h)=>{const P=g.transaction([le,de],"readwrite"),m=P.objectStore(le),k=P.objectStore(de),j=m.put(a,b);j.onsuccess=()=>{const O=k.get(t);O.onsuccess=()=>{const D=O.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};D.timestamp=Date.now(),D.elementCount=(D.elementCount||0)+a.length;const S=Array.isArray(D.partKeys)?D.partKeys.slice():[];S.includes(b)||S.push(b),D.partKeys=S,k.put(D,t);try{const M=a.map(v=>v.GlobalId).filter(Boolean),T=m.put(M,i);T.onsuccess=()=>{},T.onerror=()=>{}}catch{}x()},O.onerror=()=>x()},j.onerror=()=>h(j.error??new Error("IndexedDB writePart failed"))}),console.log(`üíæ Wrote part ${s} (${a.length} items) for ${t.substring(0,16)}...`)},async getPersistedIds(t){const s=await this.getPartKeys(t);if(!s||!s.length)return new Set;const a=await ve(),b=new Set;return await new Promise(i=>{const x=a.transaction(le,"readonly").objectStore(le);let h=s.length;s.forEach(P=>{const m=P.replace("::part::","::partindex::"),k=x.get(m);k.onsuccess=()=>{const j=k.result??[];for(const O of j)typeof O=="string"&&O&&b.add(O);h-=1,h===0&&i()},k.onerror=()=>{h-=1,h===0&&i()}})}),b},async getPartKeys(t){const s=await this.getMetadata(t);return Array.isArray(s?.partKeys)?s.partKeys:[]},async listParts(t){return(await this.getPartKeys(t)).slice().sort()},async readAllParts(t){const s=await ve(),a=await this.getPartKeys(t);return a.length?new Promise((b,i)=>{const x=s.transaction(le,"readonly").objectStore(le),h=[];let P=a.length;a.forEach(m=>{const k=x.get(m);k.onsuccess=()=>{const j=k.result??[];h.push(...j),P-=1,P===0&&b(h)},k.onerror=()=>{P-=1,P===0&&b(h)}})}):[]},async removeParts(t){const s=await ve(),a=`${t}::part::`,i=(await this.keys()).filter(g=>g.startsWith(a));i.length&&(await new Promise((g,x)=>{const h=s.transaction([le,de],"readwrite"),P=h.objectStore(le),m=h.objectStore(de);i.forEach(k=>P.delete(k)),m.delete(t),h.oncomplete=()=>g(),h.onerror=()=>x(h.error??new Error("IndexedDB removeParts failed"))}),console.log(`üßπ Removed ${i.length} parts for ${t.substring(0,16)}...`))},async getMetadata(t){const s=await ve();return new Promise((a,b)=>{const x=s.transaction(de,"readonly").objectStore(de).get(t);x.onsuccess=()=>a(x.result??null),x.onerror=()=>b(x.error??new Error("IndexedDB metadata get failed"))})},async remove(t){const s=await ve();await new Promise((a,b)=>{const i=s.transaction([le,de],"readwrite"),g=i.objectStore(le),x=i.objectStore(de);g.delete(t),x.delete(t),i.oncomplete=()=>a(),i.onerror=()=>b(i.error??new Error("IndexedDB delete failed"))})},async keys(){const t=await ve();return new Promise((s,a)=>{const g=t.transaction(le,"readonly").objectStore(le).getAllKeys();g.onsuccess=()=>s(g.result??[]),g.onerror=()=>a(g.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const t=await ve();return new Promise((s,a)=>{const g=t.transaction(de,"readonly").objectStore(de).getAll();g.onsuccess=()=>s(g.result??[]),g.onerror=()=>a(g.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(t=720*60*60*1e3){const s=await ve(),a=await this.getAllMetadata(),b=Date.now(),i=a.filter(g=>b-g.timestamp>t).map(g=>g.modelKey);i.length>0&&await new Promise((g,x)=>{const h=s.transaction([le,de],"readwrite"),P=h.objectStore(le),m=h.objectStore(de);i.forEach(k=>{P.delete(k),m.delete(k)}),h.oncomplete=()=>{console.log(`üßπ Cleaned up ${i.length} old cache entries from IndexedDB`),g()},h.onerror=()=>x(h.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(t,s){const a=await this.getMetadata(t);return!a||!a.modelSignature?!1:a.modelSignature===s},async updateSignature(t,s,a){const b=await ve();await new Promise((i,g)=>{const h=b.transaction(de,"readwrite").objectStore(de),P=h.get(t);P.onsuccess=()=>{const m=P.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};m.modelSignature=s,m.modelFiles=a,m.timestamp=Date.now();const k=h.put(m,t);k.onsuccess=()=>i(),k.onerror=()=>g(k.error??new Error("IndexedDB updateSignature failed"))},P.onerror=()=>g(P.error??new Error("IndexedDB updateSignature get failed"))})}},kl=async t=>{const s=new TextEncoder,a=`${t.modelUrl}|${t.extra??""}`,b=s.encode(a),i=await crypto.subtle.digest("SHA-256",b),g=new Uint8Array(i);return btoa(String.fromCharCode(...g)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},Sn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},qe=t=>t==null?[]:Array.isArray(t)?t:[t],yn=t=>{if(t==null)return[];if(typeof t=="string")try{const s=JSON.parse(t);return Array.isArray(s)?s:[]}catch{return[]}if(typeof t=="object"){const s=t;if(typeof s.__cdata=="string")try{const a=JSON.parse(s.__cdata);return Array.isArray(a)?a:[]}catch{return[]}if(Array.isArray(s.item))return s.item;if(s.item!=null)return[s.item];if(Array.isArray(s.Rule))return s.Rule;if(s.Rule!=null)return[s.Rule]}return Array.isArray(t)?t:[]},pi=t=>{if(!t||typeof t!="string")return[];const s=new js(Sn);let a={};try{a=s.parse(t)}catch(m){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",m),[]}const b=a?.IdsCreator??a?.idsCreator??a?.IDS_CREATOR??a?.Ids??a,i=b?.Specification??b?.specification??b?.Specifications??b?.specifications??null;if(i){const m=qe(i);if(m.length)return m.map((k,j)=>{const O=k?.["@_id"]?.trim?.()||`spec-${j+1}`,D=(k?.Name??k?.name??"")?.toString?.()??"",S=(k?.Description??k?.description??"")?.toString?.()??"",M=yn(k?.Applicability??k?.applicability),T=yn(k?.Requirements??k?.requirements);return{id:O,name:D,description:S,applicability:M,requirements:T}})}const g=m=>{if(!m||typeof m!="object")return[];for(const[k,j]of Object.entries(m)){const O=String(k).toLowerCase();if(O.endsWith(":specification")||O==="specification"||O==="ids:specification")return qe(j)}for(const k of Object.values(m))if(k&&typeof k=="object"){const j=g(k);if(j&&j.length)return j}return[]},x=g(a);if(!x.length)return[];const h=m=>{if(!m)return null;if(typeof m=="string")return m;if(typeof m=="object")for(const k of Object.keys(m)){const j=k.toLowerCase();if(j.includes("simplevalue")||j==="#text"||j==="value"){const O=m[k];if(typeof O=="string")return O;if(typeof O=="object"&&(O?.value||O?.Value))return String(O.value??O.Value)}}return null};return x.map((m,k)=>{const j=m?.["@_id"]?.trim?.()||`spec-${k+1}`,O=m?.["@_name"]??m?.name??m?.Name??"",D=String(O??""),S="",M=[],T=[],v=m?.applicability??m?.Applicability??m?.["ids:applicability"]??null,z=qe(v);for(const J of z){let re=null;const X=[J];for(;X.length&&!re;){const H=X.shift();if(!H)continue;const ze=h(H);if(ze){re=ze;break}if(typeof H=="object")for(const Ce of Object.values(H))Ce&&typeof Ce=="object"&&X.push(Ce)}re&&M.push({entity:re})}const K=m?.requirements??m?.Requirements??m?.["ids:requirements"]??null,ge=qe(K),Q=J=>{const re=[],X=[];if(J?.property&&X.push(...qe(J.property)),J?.Property&&X.push(...qe(J.Property)),Array.isArray(J)&&X.push(...J),!X.length&&typeof J=="object")for(const H of Object.values(J))H&&typeof H=="object"&&X.push(H);for(const H of X){const ze=H?.propertySet??H?.PropertySet??H?.["ids:propertySet"]??H?.propertySet,Ce=H?.baseName??H?.BaseName??H?.["ids:baseName"]??H?.baseName,Ye=h(ze)||h(H?.propertySet?.simpleValue)||h(H?.propertySet?.["ids:simpleValue"]),zt=h(Ce)||h(H?.baseName?.simpleValue)||h(H?.baseName?.["ids:simpleValue"]),_e=[],be=H?.allowedValues??H?.AllowedValues??H?.["ids:allowedValues"];if(be){const Ge=be?.values??be?.Values??be?.["ids:values"]??be,$t=qe(Ge?.value??Ge?.Value??Ge?.["ids:value"]??Ge??[]);for(const Xe of $t){const $e=h(Xe)||h(Xe?.simpleValue)||h(Xe?.["ids:simpleValue"]);$e&&_e.push($e)}}if(Ye||zt){const Ge={id:`rule-${k}-${re.length}`,propertyPath:`${Ye??"Pset"}.${zt??"Property"}`,operator:"equals"};_e.length&&(Ge.value=_e.length===1?_e[0]:JSON.stringify(_e)),re.push(Ge)}}return re};for(const J of ge){const re=Q(J);re.length&&T.push(...re)}return{id:j,name:String(D??""),description:String(S),applicability:M,requirements:T}})},mi=t=>{const s=new Ss(Sn);if((t??[]).some(g=>Array.isArray(g.requirements)&&g.requirements.some(x=>x&&typeof x=="object"&&"propertyPath"in x))){const x={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(t??[]).map(P=>{const m=[],k=S=>{if(!S&&S!==0)return null;if(typeof S=="string")return S;if(typeof S=="number")return String(S);if(S?.ifcClass&&typeof S.ifcClass=="string"&&S.ifcClass.trim())return S.ifcClass.trim();const M=S?.entity??S?.ifcType??S?.type;if(M&&typeof M=="string"&&M.trim())return M.trim();const T=S?.sample??S;if(T){if(T._category&&typeof T._category=="object"){const z=T._category.value??T._category.Value;if(typeof z=="string"&&z.trim())return z.trim()}const v=T?.ifcClass??T?.category?.value??T?.type??T?._type;if(v&&typeof v=="string"&&v.trim())return v.trim()}return null};for(const S of qe(P.applicability)){const M=k(S)??null,T=M&&String(M).trim()?String(M):"IFCELEMENT";m.push({"ids:name":{"ids:simpleValue":T}})}const j=[],O=S=>{if(S==null)return"";if(typeof S=="string")return S;if(typeof S=="number")return String(S);if(typeof S=="object"){if(S["ids:simpleValue"])return String(S["ids:simpleValue"]);if(S.__cdata)return String(S.__cdata);if(S.Name)return String(S.Name);if(S.name)return String(S.name);for(const M of Object.keys(S)){const T=S[M];if(typeof T=="string"&&T.trim())return T;if(T&&typeof T=="object"){const v=T;if(typeof v["ids:simpleValue"]=="string")return v["ids:simpleValue"];if(typeof v.value=="string")return v.value}}return""}return""};for(const S of qe(P.requirements))if(S&&typeof S=="object"){const M=S;let T=null,v=null;if(typeof M.propertyPath=="string"){const[X,H]=String(M.propertyPath).split(".");T=X,v=H}else M.propertyPath&&typeof M.propertyPath=="object"?(T=M.propertyPath.pset??M.propertyPath.propertySet??M.propertySet??null,v=M.propertyPath.property??M.propertyPath.prop??M.property??M.propertyName??null):(T=M.propertySet??M.pset??null,v=M.baseName??M.property??M.prop??null);const z=O(T)||"Pset",K=O(v)||"Property",ge=Zt(z)||z,Q=Zt(K)||K,J={};if(J["ids:propertySet"]={"ids:simpleValue":ge},J["ids:baseName"]={"ids:simpleValue":Q},(M.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(M.value!=null&&String(M.value).trim()){let X=null;try{const H=typeof M.value=="string"?JSON.parse(M.value):M.value;Array.isArray(H)&&(X=H.map(ze=>String(ze)))}catch{}X||typeof M.value=="string"&&M.value.includes(",")&&(X=M.value.split(",").map(H=>Co(H.trim())).filter(Boolean)),X&&X.length?J["ids:allowedValues"]={"ids:values":{"ids:value":X.map(H=>({"ids:simpleValue":Co(String(H))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":Co(String(M.value))}}}}j.push({"ids:property":J})}const D={"@_ifcVersion":"IFC4","@_name":P.name??""};return m.length&&(D["ids:applicability"]={"ids:entity":m.map(S=>({"ids:name":S["ids:name"]?S["ids:name"]:S}))}),j.length&&(D["ids:requirements"]={"ids:property":j.map(S=>S["ids:property"])}),D})}},h=s.build(x);return h.startsWith("<?xml")?h:`<?xml version="1.0" encoding="UTF-8"?>
${h}`}const b={IdsCreator:{Specification:(t??[]).map(g=>({"@_id":g.id,Name:g.name,Description:g.description,Applicability:{__cdata:JSON.stringify(g.applicability??[])},Requirements:{__cdata:JSON.stringify(g.requirements??[])}}))}},i=s.build(b);return i.startsWith("<?xml")?i:`<?xml version="1.0" encoding="UTF-8"?>
${i}`},Zt=t=>t?t.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Co=t=>!t||typeof t!="string"?t:t.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),jn=t=>{if(t==null)return"";if(typeof t=="string")return Co(t.trim());if(typeof t=="number"||typeof t=="boolean")return String(t);try{return JSON.stringify(t)}catch{return String(t)}},El=t=>{if(!t)return{};const s={};for(const[a,b]of Object.entries(t)){if(!b||typeof b!="object")continue;const i=Zt(a)||a;for(const[g,x]of Object.entries(b)){const h=Zt(g)||g,P=`${i}.${h}`;P in s||(s[P]=jn(x))}}return s};let at=null;const Pl=()=>{at=null},Al=t=>t.slice().sort().join("|"),Ml=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],Rl=(t,s)=>{if(!t||typeof t!="object")return;const a=s.map(g=>g.toLowerCase()),b=new WeakSet,i=[t];for(;i.length;){const g=i.pop();if(!(!g||typeof g!="object")&&!b.has(g)){if(b.add(g),Array.isArray(g)){for(const x of g)x&&typeof x=="object"&&i.push(x);continue}for(const[x,h]of Object.entries(g)){const P=x.toLowerCase();if(a.some(m=>P.includes(m)))if(typeof h=="string"){const m=h.trim();if(m)return m}else{if(typeof h=="number"&&Number.isFinite(h))return h.toString();if(typeof h=="boolean")return h?"true":"false";if(h&&typeof h=="object"){const m=h;if(typeof m.value=="string"){const k=m.value.trim();if(k)return k}if(typeof m.Value=="string"){const k=m.Value.trim();if(k)return k}m.value&&typeof m.value=="object"&&i.push(m.value),m.Value&&typeof m.Value=="object"&&i.push(m.Value)}}h&&typeof h=="object"&&i.push(h)}}}},zl=t=>{if(!t||typeof t!="object")return null;const s=t;for(const b of Ml){const i=s[b];if(typeof i=="string"&&i.trim().length)return i.trim()}return Rl(t,["globalid","global id","guid","uniqueid"])?.trim()??null},wo=async(t,s,a)=>{console.log("üîç [collectElementsDirect] START with",s.length,"globalIds"),console.log("üîç [collectElementsDirect] Has getElementProps?",!!t.getElementProps);const b=[],i=Math.max(s.length,1);a?.onProgress?.({done:0,total:i});const g=t.getElementProps;console.log("üîç [collectElementsDirect] Using getElementProps method");for(let x=0;x<s.length;x++){const h=s[x];try{const{ifcClass:P,psets:m,attributes:k}=await g.call(t,h),j=El(m);if("GlobalId"in j||(j.GlobalId=h),k)for(const[O,D]of Object.entries(k)){const M=`Attributes.${Zt(O)||O}`;M in j||(j[M]=jn(D))}j.ifcClass||(j.ifcClass=P),b.push({GlobalId:h,ifcClass:P,properties:j}),(x%50===0||x===s.length-1)&&a?.onProgress?.({done:b.length,total:i})}catch(P){console.warn(`IDS adapter (direct) failed to load element ${h}`,P)}}return a?.onProgress?.({done:b.length,total:i}),console.log("üîç [collectElementsDirect] COMPLETE - returning",b.length,"elements"),b},$l=async(t,s,a)=>{if(typeof t.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const b=Math.max(1,(navigator.hardwareConcurrency||4)-1);console.log(`üöÄ Starting parallel property extraction with ${b} workers`);const i=[],g=[],x=[];for(let m=0;m<b;m++){const k=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});i.push(k);const j=new Promise((O,D)=>{const S=T=>{const v=T.data;if(v){if(v.type==="error"){D(new Error(v.message||`Worker ${m} failed.`));return}if(v.type==="progress"){const z=x.reduce((K,ge)=>K+ge.length,0)+v.done;a?.onProgress?.({done:z,total:Math.max(s,z)});return}v.type==="done"&&(x[m]=v.elements??[],O(v.elements??[]))}},M=T=>{D(T.error??new Error(T.message||`Worker ${m} error.`))};k.addEventListener("message",S),k.addEventListener("error",M)});g.push(j),k.postMessage({type:"build-props",reset:!0,total:s})}a?.onProgress?.({done:0,total:s});const h=new Set;let P=0;try{for await(const m of t.iterElements({batchSize:128})){if(!Array.isArray(m)||!m.length)continue;const k=[];m.forEach(j=>{if(!j||typeof j!="object")return;const O=j.data;if(!O)return;const D=zl(O);if(!D||h.has(D))return;h.add(D);const S=typeof O.ifcClass=="string"?O.ifcClass:void 0;k.push({globalId:D,ifcClass:S,data:O})}),k.length&&(i[P].postMessage({type:"build-props",elements:k}),P=(P+1)%b)}}catch(m){throw i.forEach(k=>{k.postMessage({type:"cancel"}),k.terminate()}),m}i.forEach(m=>{m.postMessage({type:"build-props",final:!0})});try{const k=(await Promise.all(g)).flat();return console.log(`‚úÖ Parallel processing complete: ${k.length} elements processed by ${b} workers`),a?.onProgress?.({done:k.length,total:Math.max(s,k.length)}),k}finally{i.forEach(m=>m.terminate())}},Dl=async(t,s)=>{try{const a=typeof s.countElements=="function"?await s.countElements():void 0;return await kl({modelUrl:t,extra:a!=null?String(a):void 0})}catch(a){return console.warn("IDS adapter: failed to compute model key for cache",a),null}},Fl=async(t,s)=>{if(console.log("üîç [collectElementsForIds] START",{hasFilterGlobalIds:!!s?.filterGlobalIds,filterCount:s?.filterGlobalIds?.length}),!t)return console.log("üîç [collectElementsForIds] No viewerApi"),[];let a;if(s?.filterGlobalIds&&s.filterGlobalIds.length>0)console.log("üîç [collectElementsForIds] Using provided filterGlobalIds directly (skipping listGlobalIds)"),a=s.filterGlobalIds;else{console.log("üîç [collectElementsForIds] Calling listGlobalIds...");const P=await t.listGlobalIds();console.log("üîç [collectElementsForIds] Got all GlobalIds:",P.length),a=P}if(console.log("üîç [collectElementsForIds] GlobalIds to validate:",a.length),!a.length)return console.log("üîç [collectElementsForIds] No GlobalIds to process"),at=null,[];console.log("üîç [collectElementsForIds] Building cache token...");const b=Al(a);console.log("üîç [collectElementsForIds] Token built:",b.substring(0,20)+"...");const i=Math.max(a.length,1);if(s?.onPhase?.("BUILDING_PROPERTIES"),s?.onProgress?.({done:0,total:i}),console.log("üîç [collectElementsForIds] Checking memory cache..."),at&&at.token===b)return console.log("üîç [collectElementsForIds] Memory cache HIT! Returning",at.elements.length,"elements"),at.elements;console.log("üîç [collectElementsForIds] Memory cache MISS");const g=s?.filterGlobalIds&&s.filterGlobalIds.length>0;let x=null;if(g)console.log("üîç [collectElementsForIds] Skipping persistent cache (filtering mode)");else if(console.log("üîç [collectElementsForIds] Resolving persistent key..."),x=await Dl(b,t),console.log("üîç [collectElementsForIds] Persistent key:",x),x){console.log("üîç [collectElementsForIds] Checking IndexedDB cache...");try{const P=await nr.get(x);if(console.log("üîç [collectElementsForIds] IndexedDB returned:",P?.length||0,"elements"),P&&P.length){const m=await nr.getMetadata(x),k=m?Math.round((Date.now()-m.timestamp)/1e3/60):0;return console.log(`‚ö° Using cached elements from IndexedDB: ${P.length} elements (cached ${k} minutes ago)`),s?.onProgress?.({done:P.length,total:i}),at={token:b,elements:P},P}console.log("üîç [collectElementsForIds] IndexedDB cache MISS or empty")}catch(P){console.warn("IDS adapter: failed to read cached elements from IndexedDB",P)}}let h=[];if(console.log("üîç [collectElementsForIds] Decision point:",{isFiltering:g,willUseDirect:g,globalIdsCount:a.length}),g)console.log(`üìå Filtering mode: collecting ${a.length} specific elements directly`),console.log("üîç [collectElementsForIds] Calling collectElementsDirect..."),h=await wo(t,a,s),console.log("üîç [collectElementsForIds] collectElementsDirect returned:",h.length,"elements");else{console.log("üîç [collectElementsForIds] Full model mode - using workers");const P=typeof t.countElements=="function"?await t.countElements().catch(()=>a.length):a.length;if(console.log("üîç [collectElementsForIds] Total elements:",P),typeof t.iterElements=="function")try{console.log("üîç [collectElementsForIds] Calling buildWithWorker..."),h=await $l(t,P??a.length,s),console.log("üîç [collectElementsForIds] buildWithWorker returned:",h.length,"elements"),h.length||(console.log("üîç [collectElementsForIds] No elements from worker, falling back to direct"),h=await wo(t,a,s))}catch(m){console.warn("IDS adapter: property build worker failed, falling back to direct collection",m),h=await wo(t,a,s)}else console.log("üîç [collectElementsForIds] iterElements not available, using direct"),h=await wo(t,a,s)}return x&&h.length&&nr.set(x,h).catch(P=>console.warn("IDS adapter: failed to persist elements cache",P)),at={token:b,elements:h},s?.onProgress?.({done:Math.min(h.length,i),total:i}),h},Tl={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let yt=Tl;const ir=new Set;let ht=null;const Nl=()=>{ir.forEach(t=>{try{t()}catch(s){console.error("IDS store listener error",s)}})},ce=t=>{yt=t(yt),Nl()};let ct=null,So=null;const Ol=()=>(ct||(ct=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),ct),Ll=(t,s)=>{const a=Ol(),b=new Promise((i,g)=>{const x=P=>{const m=P.data;if(m){if(m.type==="error"){a.removeEventListener("message",x),a.removeEventListener("error",h),g(new Error(m.message||"IDS worker failed"));return}if(m.type==="phase"){s?.onPhase?.(m.label);return}if(m.type==="progress"){s?.onProgress?.(m);return}if(m.type==="done"){a.removeEventListener("message",x),a.removeEventListener("error",h),i(m);return}}},h=P=>{a.removeEventListener("message",x),a.removeEventListener("error",h),g(P.error??new Error(P.message))};a.addEventListener("message",x),a.addEventListener("error",h),a.postMessage(t)});return So=b.finally(()=>{So=null}),b},bn=()=>{ce(t=>({...t,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:t=>(ir.add(t),()=>ir.delete(t)),getState:()=>yt,setIdsXmlText:(t,s)=>{const a=t.replace(/\uFEFF/g,"").trim(),b=s?.fileNames??[];ce(i=>({...i,idsXmlText:a,idsFileNames:b,error:null})),bn()},appendDocuments:t=>{if(!t.length)return;const s=fe.getState(),a=[];s.idsXmlText.trim().length&&a.push(s.idsXmlText.trim()),a.push(...t.map(g=>g.content.trim()).filter(Boolean));const b=a.join(`

`),i=[...s.idsFileNames,...t.map(g=>g.name)];fe.setIdsXmlText(b,{fileNames:i})},clearResults:()=>{bn()},setValidationMode:t=>{ce(s=>({...s,validationMode:t}))},filterRows:(t,s)=>{ce(a=>{if(!t)return{...a,filteredRows:a.rows,filterDescription:null};const b=a.rows.filter(i=>{try{return t(i)}catch(g){return console.warn("IDS filter predicate threw an error",g),!0}});return{...a,filteredRows:b,filterDescription:s??null}})},runCheck:async t=>{if(!t){ce(i=>({...i,error:"Viewer API is not available."}));return}if(yt.isChecking){await So;return}const s=yt.idsXmlText.trim();if(!s){ce(i=>({...i,error:"Load at least one IDS XML file before running the check."}));return}let a;if(yt.validationMode==="selected")if(console.log("üéØ Selected Only mode is active"),t.getSelectedGlobalIds){if(console.log("üéØ Getting selected GlobalIds..."),a=await t.getSelectedGlobalIds(),console.log("üéØ Selected GlobalIds:",a),!a||a.length===0){console.error("‚ùå No elements selected"),ce(i=>({...i,error:"No elements selected. Please select elements or switch to another mode."}));return}console.log(`üéØ Validating ${a.length} selected elements`)}else{console.warn("‚ö†Ô∏è getSelectedGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Selected elements validation is not supported by this viewer."}));return}else if(yt.validationMode==="visible")if(console.log("üëÅÔ∏è Visible Only mode is active"),t.getVisibleGlobalIds){if(console.log("üëÅÔ∏è Getting visible GlobalIds..."),a=await t.getVisibleGlobalIds(),console.log("üëÅÔ∏è Visible GlobalIds:",a),!a||a.length===0){console.error("‚ùå No visible elements found"),ce(i=>({...i,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}console.log(`üëÅÔ∏è Validating ${a.length} visible elements`)}else{console.warn("‚ö†Ô∏è getVisibleGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Visible elements validation is not supported by this viewer."}));return}ce(i=>({...i,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),ht=new AbortController;const b=ht.signal;try{if(b.aborted)throw new Error("Validation cancelled");const i=await Fl(t,{filterGlobalIds:a,onPhase:m=>{ce(k=>({...k,phase:m}))},onProgress:m=>{ce(k=>({...k,progress:m}))}});if(!i.length)throw new Error("No IFC elements were found in the current viewer.");if(b.aborted)throw new Error("Validation cancelled");ce(m=>({...m,phase:"CHECKING_IDS",progress:null}));const g={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},x=await Ll({type:"validate",idsXml:s,elements:i},{onPhase:m=>{const k=g[m];k&&ce(j=>({...j,phase:k}))},onProgress:m=>{ce(k=>({...k,progress:{done:m.done,total:m.total}}))}}),h=x.rules??[],P=x.rows??[];if(a&&a.length>0&&typeof t.addToCache=="function"){console.log(`üì¶ Adding ${a.length} validated elements to cache...`);try{await t.addToCache(a),console.log("üì¶ Successfully updated cache with validated elements")}catch(m){console.warn("üì¶ Failed to add elements to cache:",m)}}ce(m=>({...m,isChecking:!1,rules:h,rows:P,filteredRows:P,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),ht=null}catch(i){const g=i instanceof Error?i.message:"Failed to run IDS validation.";console.error("IDS run failed",i),ce(x=>({...x,isChecking:!1,error:g,phase:"ERROR",progress:null})),ht=null}},invalidateCaches:()=>{Pl(),ct&&(ct.terminate(),ct=null,So=null),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{console.log("üõë Cancelling IDS validation..."),ht&&(ht.abort(),ht=null),ct&&ct.postMessage({type:"cancel"}),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},Vl=t=>d.useSyncExternalStore(fe.subscribe,()=>t({...fe.getState(),...fe}),()=>t({...fe.getState(),...fe})),Bl=t=>d.useSyncExternalStore(fe.subscribe,()=>t(fe.getState()),()=>t(fe.getState())),_l=()=>{const t=d.useCallback(fe.setIdsXmlText,[]),s=d.useCallback(fe.appendDocuments,[]),a=d.useCallback(fe.clearResults,[]),b=d.useCallback(fe.filterRows,[]),i=d.useCallback(fe.runCheck,[]),g=d.useCallback(fe.setValidationMode,[]),x=d.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:t,appendDocuments:s,clearResults:a,filterRows:b,runCheck:i,setValidationMode:g,cancelValidation:x,invalidateCaches:fe.invalidateCaches}},vn=fe,Gl=Object.freeze(Object.defineProperty({__proto__:null,idsStore:vn,useIdsActions:_l,useIdsStore:Vl,useIdsStoreSelector:Bl},Symbol.toStringTag,{value:"Module"})),Wl=Rt.lazy(()=>Mt(()=>import("./ChatWindow-CtMMS5qr.js"),__vite__mapDeps([0,1,2,3]))),Ul=Rt.lazy(()=>Mt(()=>import("./IdsPanel-DVJp9OOk.js"),__vite__mapDeps([4,1,2,3]))),Hl=Rt.lazy(()=>Mt(()=>import("./IdsCreatorPanel-SsiH5t__.js"),__vite__mapDeps([5,1,2,3]))),ql=Rt.lazy(()=>Mt(()=>import("./ModelFilterPanel-QI5d57eT.js"),__vite__mapDeps([6,1]))),sr=(t,s)=>{if(t.length!==s.length)return!1;for(let a=0;a<t.length;a+=1){const b=t[a],i=s[a];if(!i||b.modelId!==i.modelId||b.localId!==i.localId)return!1}return!0},Kl={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Yl=(t,s)=>{if(!t)return s;const a=[t.ifcCategory,t.Category,t.category,t.ifcClass,t.class,t.type,t.Type,t.system,t.System];for(const b of a)if(typeof b=="string"&&b.trim())return b.trim();if(Array.isArray(t.categories)&&t.categories.length){const b=t.categories.find(i=>typeof i=="string"&&i.trim());if(b)return b.trim()}return typeof t.name=="string"&&t.name.trim()?t.name.trim():typeof t.Name=="string"&&t.Name.trim()?t.Name.trim():typeof t.label=="string"&&t.label.trim()?t.label.trim():s},Xl=(t,s,a)=>{const b=new Map;let i=0,g=0,x=0;a.traverse(j=>{const O=!!j?.isInstancedMesh,D=!!j?.isMesh;if(!O&&!D)return;let S=0;if(O){let v=0;typeof j.count=="number"?v=j.count:typeof j.instanceCount=="number"?v=j.instanceCount:Array.isArray(j.instanceIdMap)?v=j.instanceIdMap.length:Array.isArray(j.userData?.ids)?v=j.userData.ids.length:typeof j.userData?.size=="number"&&(v=j.userData.size),Number.isFinite(v)&&v>0&&(S=v,g+=v)}else S=1,x+=1;S<=0&&(S=1),i+=S;const M=Yl(j?.userData??{},j?.type??"Mesh"),T=b.get(M)??0;b.set(M,T+S)});const h=Array.from(b.entries()).map(([j,O])=>({category:j,count:O})).sort((j,O)=>O.count-j.count),P=new it().setFromObject(a),m=new Z,k=new Z;return P.getSize(m),P.getCenter(k),{modelId:t,label:s,elementCount:i,instancedCount:g,meshCount:x,categoryCounts:h,bboxSize:{x:m.x,y:m.y,z:m.z},bboxCenter:{x:k.x,y:k.y,z:k.z},collectedAt:Date.now()}},Jl=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),Ke=t=>{if(!t)return"";let s=t.replace(/[_\-]+/g," ");return s=s.replace(/([a-z\d])([A-Z])/g,"$1 $2"),s=s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),s=s.replace(/\s+/g," ").trim(),s?s.split(" ").map(b=>{const i=b.toUpperCase();return Jl.has(i)||i.length<=3&&/^[A-Z]+$/.test(i)?i:/^\d+(\.\d+)?$/.test(b)||!b.length?b:b.charAt(0).toUpperCase()+b.slice(1)}).join(" "):""},Zl=(t,s=200)=>t?t.length<=s?t:`${t.slice(0,s)}‚Ä¶`:"",Me=t=>{if(t==null)return"";if(typeof t=="number")return Number.isFinite(t)?t.toString():"";if(typeof t=="boolean")return t?"true":"false";if(t instanceof Date)return t.toISOString();if(typeof t=="string")return t.trim();try{const s=JSON.stringify(t);return s?s.length>500?`${s.slice(0,500)}‚Ä¶`:s:""}catch{return String(t)}},Re=t=>t==null?"":typeof t!="object"?Me(t):"value"in t?Re(t.value):"Value"in t?Re(t.Value):Array.isArray(t)?t.map(s=>Re(s)).filter(Boolean).join(", "):typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?`${Me(t.x)}, ${Me(t.y)}, ${Me(t.z)}`:Me(t),me=(t,s)=>{if(!t||typeof t!="object")return;const a=s.map(g=>g.toLowerCase()),b=new WeakSet,i=[t];for(;i.length;){const g=i.pop();if(!(!g||typeof g!="object")&&!b.has(g)){if(b.add(g),Array.isArray(g)){for(const x of g)x&&typeof x=="object"&&i.push(x);continue}for(const[x,h]of Object.entries(g)){const P=x.toLowerCase();if(a.some(m=>P.includes(m)))if(typeof h=="string"){const m=h.trim();if(m)return m}else{if(typeof h=="number"&&Number.isFinite(h))return h.toString();if(typeof h=="boolean")return h?"true":"false";if(h&&typeof h=="object"){const m=Re(h);if(m)return m}}h&&typeof h=="object"&&i.push(h)}}}},Ql=(t,s)=>{if(!t||typeof t!="object")return jo(t,300);const a=[],b=Be(t)??me(t,["name","label","description"]);b&&a.push(`name:${b}`);const i=me(t,["category","ifcclass","ifc type","type"]);i&&a.push(`category:${i}`);const g=me(t,["globalid","global id","guid"]);g&&a.push(`globalId:${g}`);const x=me(t,["expressid","express id"]);if(x&&x!==g&&a.push(`expressId:${x}`),s>0)try{const{rows:P}=Xt(t);if(P.length){const k=P.slice(0,s).map(j=>`${j.label}=${j.value}`).join(" | ");k&&a.push(`props:${k}`),P.length>s&&a.push(`propsTruncated:${P.length-s}`)}}catch(P){console.warn("Failed to build detailed property data for AI summary",P)}const h=a.filter(Boolean).join(" | ");return h?h.length>1200?`${h.slice(0,1200)}‚Ä¶`:h:jo(t,300)},xn={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},ei=new Set(["modelIdMap"]),At=t=>t.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),lt=t=>t?t.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Jt=["HasProperties","hasProperties","Properties","properties"],lr=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],wn=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Io=t=>{if(!t||typeof t!="object")return!1;const s=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSET"?!0:Jt.some(a=>Array.isArray(t[a]))},kn=t=>{if(!t||typeof t!="object")return!1;const s=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},ti=t=>{if(!t||typeof t!="object")return Me(t);const s=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const a of s){if(!(a in t))continue;const b=t[a];if(b==null)continue;if(Array.isArray(b)){const g=b.map(x=>Re(x)).filter(Boolean).join(", ");if(g)return g;continue}const i=Re(b);if(i)return i}for(const[a,b]of Object.entries(t))if((typeof b=="string"||typeof b=="number"||typeof b=="boolean")&&a.toLowerCase().includes("value")){const i=Me(b);if(i)return i}return""},oi=(t,s,a)=>{const b=Jt.map(h=>Array.isArray(t[h])?t[h]:null).filter(h=>!!h);if(!b.length)return[];const i=Ke(s)||s,g=[],x=new Map;return b.flat().forEach((h,P)=>{if(!h||typeof h!="object"||!kn(h))return;const m=Be(h)??(typeof h.Name=="string"?h.Name:void 0)??(typeof h.PropertyName=="string"?h.PropertyName:void 0),k=`Property ${P+1}`,j=m&&m.trim().length?m.trim():k,O=Ke(j)||j,D=ti(h),S=At(j)||"property",M=(x.get(S)??0)+1;x.set(S,M);const T=`${S}-${M}`,v=`Property Sets / ${i} / ${O}`,z=[v.toLowerCase()];D&&z.push(D.toLowerCase()),g.push({label:v,value:D||"",path:`property-sets/${a}/${T}`,searchText:z.join(" ").trim(),rawPsetName:s,rawPropertyName:j,rawValue:h.__rawValue??h})}),g},Yt=t=>{if(!t||typeof t!="object")return[];const s=[],a=new WeakSet,b=new Map,i=D=>{let S;if(typeof D=="string"){const z=D.trim();z.length&&(S=z)}!S&&D&&typeof D=="object"&&(S=Be(D)??(typeof D.Name=="string"?D.Name:void 0)??(typeof D.id=="string"?D.id:void 0)),(!S||!S.length)&&(S="Property Set");const M=Ke(S)||S,T=At(S)||"property-set",v=(b.get(T)??0)+1;return b.set(T,v),{rawName:S,friendlyName:M,uniqueKey:`${T}-${v}`}},g=(D,S,M)=>{const T=`Property ${M+1}`,v=D?.trim?.()?D.trim():T;if(kn(S)){const z={...S};return z.Name==null&&z.PropertyName==null&&(z.Name=v),z.PropertyName==null&&(z.PropertyName=z.Name??v),z.__rawValue==null&&(z.__rawValue=S),z}if(S&&typeof S=="object"){const z={...S};return z.Name==null&&z.PropertyName==null&&(z.Name=v),z.PropertyName==null&&(z.PropertyName=z.Name??v),z.type==null&&z.Type==null&&(z.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in z)&&!("nominalValue"in z)&&!("Value"in z)&&!("value"in z)&&(z.NominalValue=S),z.__rawValue=S,z}return{type:"IFCPROPERTYSINGLEVALUE",Name:v,PropertyName:v,NominalValue:S,__rawValue:S}},x=(D,S)=>{const M=[],T=(v,z)=>{const K=`Property ${M.length+1}`,ge=(typeof v=="string"&&v.trim().length?v.trim():void 0)??Be(v)??(typeof v?.Name=="string"?v.Name:void 0)??(typeof v?.PropertyName=="string"?v.PropertyName:void 0)??K;M.push(g(ge,z,M.length))};if(S&&typeof S=="object")for(const v of Jt){const z=S[v];Array.isArray(z)&&z.length&&z.forEach(K=>T(K,K))}if(!M.length)if(Array.isArray(S))S.forEach(v=>T(v,v));else if(S&&typeof S=="object")for(const[v,z]of Object.entries(S))z!=null&&(wn.has(v)||Jt.includes(v)||lr.includes(v)||T(v,z));else S!=null&&T(void 0,S);return{type:"IFCPROPERTYSET",Name:D,HasProperties:M}},h=(D,S)=>{const T=oi(S&&typeof S=="object"?S:{},D.rawName,D.uniqueKey);T.length&&s.push(...T)},P=D=>{if(!(!D||typeof D!="object")&&!a.has(D)){if(a.add(D),Array.isArray(D)){D.forEach(S=>{if(!S||typeof S!="object")return;const M=i(S),T=Io(S)?S:x(M.rawName,S);h(M,T),T&&typeof T=="object"&&a.add(T)});return}for(const[S,M]of Object.entries(D)){if(M==null)continue;const T=i(S),v=Io(M)?M:x(T.rawName,M);h(T,v),M&&typeof M=="object"&&a.add(M)}}},m=D=>{if(!D||typeof D!="object"||a.has(D))return;if(a.add(D),Array.isArray(D)){D.forEach(m);return}let S=!1;for(const M of lr)Object.prototype.hasOwnProperty.call(D,M)&&(P(D[M]),S=!0);if(Io(D)){const M=i(D);h(M,D)}!S&&!Io(D)&&Object.entries(D).forEach(([M,T])=>{lr.includes(M)||wn.has(M)||Jt.includes(M)||T&&typeof T=="object"&&m(T)})};m(t);const k=new Map,j=new Set;for(const D of s){const S=`${D.label}::${D.value}`;if(j.has(S))continue;const M=`${D.rawPsetName||"unknown"}::${D.rawPropertyName||"unknown"}::${D.value}`;k.has(M)||(j.add(S),k.set(M,D))}const O=Array.from(k.values());return s.length,O.length,O},ke={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},In=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],ri=(t,s)=>{const a=typeof t=="string"?t.trim().toLowerCase():"";if(a&&In.some(b=>a.startsWith(b)))return!0;if(s&&typeof s=="object"){const b=Re(s._category??s.category??s.Category??null),i=typeof b=="string"?b.trim().toLowerCase():"";if(i&&In.some(x=>i.startsWith(x))||(s.NominalValue!=null||s.nominalValue!=null)&&(s.Name!=null||s.PropertyName!=null)&&a.includes("property"))return!0}return!1},Cn="fragmentsViewer.favoritePropertyPaths",ni=1e4,si=500,Be=t=>{if(!t||typeof t!="object")return;let s,a;typeof t.Name=="string"?s=t.Name:t.Name&&typeof t.Name=="object"&&(s=Re(t.Name)||void 0),typeof t.name=="string"?a=t.name:t.name&&typeof t.name=="object"&&(a=Re(t.name)||void 0);const b=s??a;if(!b)return;const i=b.trim();return i.length?i:void 0},Xt=t=>{if(!t||typeof t!="object")return{rows:[],tree:[]};const s=[],a=new WeakSet,b=(x,h,P)=>{if(x==null)return null;const m=h.map(v=>{const z=v?.trim?.()??v;return typeof z=="string"&&z.length?Ke(z)||z:typeof v=="string"?v:String(v??"")}),k=m.filter(Boolean).join(" / "),j=P.length?P.join("/"):At(k||"value"),O=m[m.length-1]??"Value",D=v=>{const z=k.toLowerCase(),K=[z];v&&K.push(v.toLowerCase());const ge=K.join(" ").trim()||z,Q={label:k,value:v??"",path:j,searchText:ge};return s.push(Q),ge};if(typeof x!="object"||x instanceof Date){const v=Me(x),z=D(v);return{id:j,label:O,fullLabel:k,value:v||void 0,children:[],searchText:z}}if(a.has(x)){const v="[Circular reference]",z=D(v);return{id:j,label:O,fullLabel:k,value:v,children:[],searchText:z}}a.add(x);let S;const M=[];if(Array.isArray(x))x.forEach((v,z)=>{const K=Be(v),ge=`${O} ${z+1}`,Q=K&&K.trim().length?K.trim():ge,J=Ke(Q)||Q,re=K&&K.trim().length?At(K):String(z),X=b(v,[...h,J],[...P,re]);X&&M.push(X)}),M.length===0&&(S=Me(x));else{if("NominalValue"in x||"nominalValue"in x){const v=x.NominalValue??x.nominalValue,z=Re(v);z&&(S=z)}!S&&"value"in x&&typeof x.value!="object"&&(S=Me(x.value)),!S&&"Value"in x&&typeof x.Value!="object"&&(S=Me(x.Value));for(const[v,z]of Object.entries(x)){if(z==null||v==="Name"||v==="name"||v==="IsDefinedBy"||v==="isDefinedBy"||v==="psets"||v==="Psets"||v==="propertySets"||v==="PropertySets"||v==="property_sets"||v==="Property_Sets")continue;if(v==="NominalValue"||v==="nominalValue"){const ze=Ke("Nominal Value")||"Nominal Value",Ce=b(z,[...h,ze],[...P,"nominal-value"]);Ce&&M.push(Ce);continue}const K=xn[v]??v,ge=Ke(K)||K,Q=Be(z)?.trim(),J=Q&&Q.length?Ke(Q)||Q:ge,re=Q&&Q.length?At(Q):At(K),X=[...h,J],H=b(z,X,[...P,re]);H&&M.push(H)}!S&&M.length===0&&(S=Me(x))}const T=D(S);return{id:j,label:O,fullLabel:k,value:S,children:M,searchText:T}},i=[];for(const[x,h]of Object.entries(t)){if(h==null||ei.has(x))continue;const P=xn[x]??x,m=b(h,[P],[x]);m&&i.push(m)}if(s.length){const x=s.filter(h=>{const P=h.label.toLowerCase();return P.startsWith("property sets /")?!(P.includes("/ has properties")||P.includes("/ nominal value")):!0});x.length!==s.length&&s.splice(0,s.length,...x)}const g=Yt(t);if(g.length){const x=[],h=new Set;for(const m of g)h.has(m.path)||(h.add(m.path),x.push(m));const P=[];for(const m of s)h.has(m.path)||P.push(m);s.splice(0,s.length,...x,...P)}return{rows:s,tree:i}},li=()=>{const t=d.useRef(null),s=d.useRef(null),a=d.useRef(null),b=d.useRef(null),i=d.useRef(null),g=d.useRef(!1),x=d.useRef(null),h=d.useRef(null),P=d.useRef(null),[m,k]=d.useState(!1),[j,O]=d.useState([]),[D,S]=d.useState(!1),[M,T]=d.useState(50);d.useCallback(async(e,r)=>{{console.warn("dumpModelRawData is dev-only.");return}},[j]),d.useCallback(async(e,r=50,n=128)=>{},[]);const[v,z]=d.useState([]),[K,ge]=d.useState(null),[Q,J]=d.useState(!0),[re,X]=d.useState(!1),[H,ze]=d.useState(!1),[Ce,Ye]=d.useState(null),[zt,_e]=d.useState(!1),[be,Ge]=d.useState(!1),$t=d.useRef(null),Xe=d.useRef(!1),$e=d.useRef(null),Fe=d.useRef(null),Qt=d.useRef(0),De=d.useRef(null),eo=d.useRef(null),Je=d.useRef(null),Te=d.useRef(null),Dt=d.useRef(!1),bt=d.useRef(null),to=d.useRef("click"),[oo,En]=d.useState({width:360,height:520}),vo=d.useRef(null),ro=d.useRef(!1),ko=d.useRef(null),cr=d.useRef(!1),dr=d.useRef(null),dt=d.useRef(null),Eo=d.useRef(null),no=d.useRef(null),Po=d.useRef(null),Ft=d.useRef(null),ur=d.useRef(null),fr=d.useRef(null),We=d.useRef(null),Ne=d.useRef([]),Oe=d.useRef(null),Tt=d.useRef(null),xt=d.useRef(null),[so,Ee]=d.useState(null),[ae,Pn]=d.useState([]),[pr,An]=d.useState(""),[wt,Mn]=d.useState(""),[Se,mr]=d.useState([]),[ut,gr]=d.useState("favorites"),[Rn,ii]=d.useState(!1),[zn,ai]=d.useState(!1),[$n,ci]=d.useState(!1),[ft,Dn]=d.useState("models"),[Ze,Ao]=d.useState(!1),[Fn,hr]=d.useState(0),[Qe,lo]=d.useState(!1),[Tn,yr]=d.useState(!1),[Nn,br]=d.useState(!1),[he,Mo]=d.useState("disabled"),[Ue,Ro]=d.useState(""),[Nt,io]=d.useState(""),[zo,xr]=d.useState(!1),[wr,Ir]=d.useState(!1),[Cr,It]=d.useState(null),[xe,Sr]=d.useState("click"),[He,On]=d.useState(!1),[Ct,Ln]=d.useState(!1),Vn=d.useRef(new Map),$o=d.useRef(null),[Bn,Do]=d.useState(0),[et,jr]=d.useState(!1),[vr,_n]=d.useState({}),[Fo,kr]=d.useState(null),[Ot,Er]=d.useState([]),[Gn,To]=d.useState(!1),[tt,Pr]=d.useState("selected"),[ot,ao]=d.useState(""),[pt,Ar]=d.useState(!1),[Mr,co]=d.useState(null),[St,No]=d.useState(!1),[ne,uo]=d.useState({x:!1,y:!1,z:!1}),[Le,Rr]=d.useState({x:0,y:0,z:0}),[Lt,zr]=d.useState(!1),[Vt,Wn]=d.useState(!1),jt=d.useRef(!1),Oo=d.useRef([]),Lo=d.useRef(new Map),fo=d.useRef(null),[$r,Dr]=d.useState(null),Fr=d.useRef(null),mt=d.useCallback(()=>a.current?.camera??null,[]),Vo=d.useCallback(()=>mt()?.three??null,[mt]);d.useEffect(()=>{to.current=xe},[xe]),d.useEffect(()=>{const e=Fr.current;!e||!("mouseButtons"in e)||(xe==="rectangle"?e.mouseButtons={left:0,middle:2,right:0,wheel:16}:e.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),d.useEffect(()=>{try{const e=window.localStorage.getItem(Cn);if(!e)return;const r=JSON.parse(e);if(!Array.isArray(r))return;const n=r.filter(l=>typeof l=="string"&&l.trim().length>0);n.length&&mr(n)}catch(e){console.warn("Failed to restore favourites from storage",e)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(Cn,JSON.stringify(Se))}catch(e){console.warn("Failed to persist favourites to storage",e)}},[Se]);const po=pr.trim(),Un=po.length>0,Tr=d.useMemo(()=>{const e=po.toLowerCase();return e?ae.filter(r=>r.searchText.includes(e)).slice(0,si):[]},[po,ae]),mo=d.useMemo(()=>{const e=new Map;return ae.forEach(r=>e.set(r.path,r)),e},[ae]),Bo=d.useMemo(()=>ae.slice(0,ni),[ae]),Nr=Math.max(ae.length-Bo.length,0),Or=d.useMemo(()=>new Set(Se),[Se]),_o=d.useMemo(()=>Se.length?Se.map(e=>mo.get(e)).filter(e=>!!e):[],[Se,mo]),Go=d.useMemo(()=>{if(!Se.length)return 0;let e=0;for(const r of Se)mo.has(r)||(e+=1);return e},[Se,mo]),Lr=d.useCallback(e=>{mr(r=>r.includes(e)?r.filter(n=>n!==e):[...r,e])},[]),go=d.useMemo(()=>j.map(e=>`${e.id}:${e.label}`).join("|"),[j]),Wo=d.useCallback(e=>{const r=Or.has(e.path);return o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[o.jsx(U,{variant:"body2",sx:{fontWeight:600},children:e.label}),o.jsx(te,{title:r?"Remove from favourites":"Add to favourites",children:o.jsx("span",{children:o.jsx(ee,{size:"small",onClick:()=>Lr(e.path),color:r?"primary":"default",children:r?o.jsx(vs,{fontSize:"small"}):o.jsx(ks,{fontSize:"small"})})})})]}),o.jsx(U,{variant:"body2",color:"text.secondary",children:e.value?Zl(e.value,360):"‚Äî"})]},e.path)},[Or,Lr]);d.useEffect(()=>{if(!j.length){ao("");return}ao(e=>e&&j.some(r=>r.id===e)?e:j[0].id)},[j]);const Vr=d.useCallback(async e=>{const r=i.current;if(!r)return[];const n=r.list.get(e);if(!n)return[];let l=[];try{const f=await n.getLocalIds();Array.isArray(f)?l=f:f&&typeof f[Symbol.iterator]=="function"&&(l=Array.from(f))}catch(f){return console.warn(`Failed to retrieve local IDs for model ${e}`,f),[]}if(!l.length)return[];const c=32,u=[];for(let f=0;f<l.length;f+=c){const w=l.slice(f,f+c);let y=[];try{y=await n.getItemsData(w,ke)}catch(p){console.warn(`Failed to fetch items data for model ${e} chunk starting at ${w[0]}`,p);continue}y.forEach((p,E)=>{const R=w[E];if(p)try{const{rows:F}=Xt(p);F.forEach(C=>{u.push({path:`localId:${R} / ${C.label}`,value:C.value})})}catch(F){console.warn(`Failed to process properties for model ${e} localId ${R}`,F)}})}return u},[]),Br=d.useCallback(e=>{const r=[];return r.push("Path,Value"),e.forEach(({path:n,value:l})=>{const c=n.replace(/"/g,'""'),u=(l??"").replace(/"/g,'""');r.push(`"${c}","${u}"`)}),r.join(`\r
`)},[]),Hn=d.useCallback(()=>{co(null),Pr(ae.length?"selected":"model"),j.length&&!j.some(e=>e.id===ot)&&ao(j[0].id),To(!0)},[ae.length,j,ot]),qn=d.useCallback(async()=>{if(!K){alert("No element selected");return}try{const e=new WeakSet,r=JSON.stringify(K,(n,l)=>{if(typeof l=="object"&&l!==null){if(e.has(l))return"[Circular Reference]";e.add(l)}return l instanceof Map?`[Map with ${l.size} entries]`:l instanceof Set?`[Set with ${l.size} items]`:l instanceof WeakMap||l instanceof WeakSet?"[WeakMap/WeakSet]":typeof l=="function"?"[Function]":typeof l=="symbol"?"[Symbol]":l},2);await navigator.clipboard.writeText(r),alert("Raw element data copied to clipboard!")}catch(e){console.error("Failed to copy raw data:",e),alert("Failed to copy data to clipboard. See console for details.")}},[K]),_r=d.useCallback(()=>{pt||(To(!1),co(null))},[pt]),Kn=d.useCallback(async()=>{if(!pt){Ar(!0),co(null);try{let e=[];if(tt==="selected"){if(!ae.length)throw new Error("No properties available for the current selection.");e=ae.map(w=>({path:w.label,value:w.value}))}else{if(!ot)throw new Error("Select a model to export.");if(e=await Vr(ot),!e.length)throw new Error("No properties were found for the chosen model.")}const r=Br(e),n=new Blob([r],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(n),c=document.createElement("a"),u=tt==="selected"?"selection":`model-${ot}`,f=new Date().toISOString().replace(/[:.]/g,"-");c.href=l,c.download=`fragment-properties-${u}-${f}.csv`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l),To(!1)}catch(e){console.warn("Failed to export properties",e),co(e.message??"Failed to export properties.")}finally{Ar(!1)}}},[Br,ot,tt,Vr,pt,ae]),Pe=d.useCallback(e=>{const r=e??null;ge(r);const{rows:n}=Xt(r);if(Pn(n),gr(Se.length?"favorites":"all"),n.length){Er(n.map(u=>({path:u.label,value:u.value})));const l="Path	Value",c=n.map(u=>`${u.label}	${u.value??""}`);kr([l,...c].join(`\r
`))}else Er([]),kr(null)},[Se.length]),Gr=d.useCallback(()=>{jr(e=>!e)},[]),Yn=d.useCallback(()=>{Ao(!0),hr(e=>e+1)},[]),Xn=d.useCallback(()=>{Ao(!1)},[]),Wr=d.useCallback(()=>{Ao(e=>{const r=!e;return r&&hr(n=>n+1),r})},[]),Jn=d.useCallback(()=>{yr(!0)},[]),Ur=d.useCallback(()=>{yr(!1)},[]),Hr=d.useCallback(()=>{const e=yl();e?(Mo(e.provider),Ro(e.apiKey),io(e.model||xo(e.provider))):(Mo("disabled"),Ro(""),io("")),It(null),br(!0)},[]),ho=d.useCallback(()=>{br(!1),xr(!1),It(null)},[]),Zn=d.useCallback(()=>{if(he==="disabled")bl();else{const e={provider:he,apiKey:Ue,model:Nt||xo(he)};hl(e)}ho()},[he,Ue,Nt,ho]),Qn=d.useCallback(e=>{Mo(e),io(xo(e)),It(null)},[]),es=d.useCallback(async()=>{if(!(!Ue||he==="disabled")){Ir(!0),It(null);try{let e=!1;const r=Nt||xo(he);he==="gemini"?e=await Il(Ue,r):he==="openai"&&(e=await Sl(Ue,r)),It(e?"success":"error")}catch{It("error")}finally{Ir(!1)}}},[he,Ue,Nt]),Bt=d.useCallback(e=>{if(!e||typeof e!="object")return"IfcProduct";if(e.constructor&&typeof e.constructor.name=="string"&&e.constructor.name.toUpperCase().startsWith("IFC")){const c=e.constructor.name.trim();if(c!=="Object"&&c!=="Array")return c}const r=Re(e._category??e.category??e.Category??null);if(r&&r.trim().length&&r.toUpperCase().startsWith("IFC"))return r.trim();const n=[e.expressID!==void 0?null:e.type,e.ifcClass,e.IfcClass,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.ifcType,e.IfcType,e?.attributes?.ifcClass,e?.Attributes?.IfcClass];for(const c of n)if(typeof c=="string"&&c.trim().length){const u=c.trim();if(u.toUpperCase().startsWith("IFC")&&!u.toUpperCase().includes("IDENTIFIER")&&!u.toUpperCase().includes("LABEL")&&!u.toUpperCase().includes("TEXT"))return u}const l=me(e,["ifcclass","ifc type","express type"]);return l&&l.toUpperCase().startsWith("IFC")?l:"IfcProduct"},[]),Uo=d.useCallback((e,r,n)=>{const l={},c={},u={};Yt(e).forEach(E=>{const R=E.label.split("/").map(L=>L.trim()),F=E.rawPsetName??R[1]??"",C=E.rawPropertyName??R[R.length-1]??"",I=lt(F),A=lt(C);if(!I||!A)return;c[I]||(c[I]={}),A in c[I]||(c[I][A]=E.value);const B=`${I}.${A}`;B in l||(l[B]=E.value)}),l.GlobalId=r,l.ifcClass=n,u.ifcClass=n,u.GlobalId=r,l["Attributes.GlobalId"]=r,l["Attributes.IfcClass"]=n,l["Attributes.ifcClass"]=n;const w=Be(e);w&&(u.Name=w,l["Attributes.Name"]=w);const y=me(e,["category","ifccategory"]);y&&(u.Category=y,l["Attributes.Category"]=y);const p=me(e,["type","typename"]);p&&(u.Type=p,l["Attributes.Type"]=p);for(const[E,R]of Object.entries(e??{})){if(R==null||typeof R!="object"||Array.isArray(R))continue;const F=Re(R);if(!F)continue;const C=String(E).replace(/^_+/,""),I=`Attributes.${Ke(C)}`;if(I in l||(l[I]=F),C in u||(u[C]=F),/guid|globalid|_guid/i.test(E)){const A=String(F).trim();A&&!l.GlobalId&&(l.GlobalId=A,u.GlobalId=A)}}return{flattened:l,psets:c,attributes:u}},[]),Ho=d.useCallback(()=>{const e=i.current;return e?`${Array.from(e.list.keys()).sort().join("|")}|${j.length}`:"empty"},[j]),ts=d.useCallback(async()=>{console.log("üîë [computeModelSignature] START");const e=i.current;if(!e||e.list.size===0)return console.log("‚ö†Ô∏è [computeModelSignature] No fragments available"),{signature:"empty",elementCount:0,modelFiles:[]};console.log(`üìä [computeModelSignature] Found ${e.list.size} models in fragments`);const r=Array.from(e.list.keys()).sort();console.log("üîë [computeModelSignature] Model IDs:",r);const n=j.map(w=>({id:w.id,name:w.label}));console.log("üìÅ [computeModelSignature] Model files:",n),console.log("üî¢ [computeModelSignature] Counting elements across all models...");let l=0;for(const[w,y]of e.list){console.log(`üîç [computeModelSignature] Getting local IDs for model ${w}...`);try{const p=await y.getLocalIds();console.log(`‚úÖ [computeModelSignature] Got local IDs for model ${w}, type:`,typeof p);const E=Array.isArray(p)?p:p&&typeof p[Symbol.iterator]=="function"?Array.from(p):[];console.log(`üìä [computeModelSignature] Model ${w} has ${E.length} elements`),l+=E.length}catch(p){console.error(`‚ùå [computeModelSignature] Failed to count elements in model ${w}`,p)}}console.log(`üìä [computeModelSignature] Total elements across all models: ${l}`);const u=[...r,...j.map(w=>`${w.id}:${w.label}`),`count:${l}`].join("|");console.log("üîë [computeModelSignature] Generated signature (first 100 chars):",u.substring(0,100));const f={signature:u,elementCount:l,modelFiles:n};return console.log("‚úÖ [computeModelSignature] COMPLETE:",f),f},[j]),yo=d.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0){const l={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Oe.current=l,l}const r=Ho();if(Oe.current&&Oe.current.signature===r)return Oe.current;if(Tt.current)return Tt.current;const n=(async()=>{const l=new Map,c=[],u=new Map;for(const[w,y]of e.list){let p=[];try{const R=await y.getLocalIds();Array.isArray(R)?p=R:R&&typeof R[Symbol.iterator]=="function"&&(p=Array.from(R))}catch(R){console.warn(`IDS cache: failed to read local IDs for model ${w}`,R);continue}if(u.set(w,p.slice()),!p.length)continue;const E=48;for(let R=0;R<p.length;R+=E){const F=p.slice(R,R+E);let C=[];try{C=await y.getItemsData(F,ke)}catch(I){console.warn(`IDS cache: failed to fetch items data for model ${w}`,I);continue}C.forEach((I,A)=>{if(!I)return;const B=F[A],L=Bt(I),V=typeof I.GlobalId=="string"&&I.GlobalId.trim()||typeof I.GlobalID=="string"&&I.GlobalID.trim()||me(I,["globalid","global id","guid"]);if(!V){if(ri(L,I))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:w,localId:B,itemData:I});return}const $=V.trim();if(!$.length||l.has($))return;const{flattened:N,psets:_,attributes:Y}=Uo(I,$,L),q={GlobalId:$,ifcClass:L,properties:N},G=I;(typeof G.GlobalId!="string"||!G.GlobalId.trim())&&(G.GlobalId=$),l.set($,{element:q,modelId:w,localId:B,psets:_,attributes:Y,raw:G}),c.push(q)})}}const f={signature:r,records:l,elements:c,modelLocalIds:u};return Oe.current=f,f})().finally(()=>{Tt.current=null});return Tt.current=n,n},[Ho,Uo,Bt]),vt=d.useCallback(async e=>{const r=new Map;console.log(`üîç [groupLocalIdsByModel] Grouping ${e.length} GlobalIds using ThatOpen API...`);const n=i.current;if(!n)return console.error("üîç [groupLocalIdsByModel] Fragments not available"),{grouped:r,cache:Oe.current};for(const[l,c]of n.list)try{const u=await c.getLocalIdsByGuids(e),f=[];for(let w=0;w<u.length;w++){const y=u[w];y!==null&&f.push(y)}f.length>0&&r.set(l,f)}catch(u){console.warn(`üîç [groupLocalIdsByModel] Failed for model ${l}:`,u)}return console.log(`üîç [groupLocalIdsByModel] Grouped ${e.length} GlobalIds into ${r.size} models (${Array.from(r.values()).reduce((l,c)=>l+c.length,0)} total local IDs)`),{grouped:r,cache:Oe.current}},[]),qo=Rt.useMemo(()=>({listGlobalIds:async()=>(await yo()).elements.map(r=>r.GlobalId),getSelectedGlobalIds:async()=>{console.log("üìç getSelectedGlobalIds called, selectedRef.current:",Ne.current);const e=Ne.current;if(!e||e.length===0)return console.log("üìç No selection found"),[];const r=i.current;if(!r)return console.warn("üìç Fragments not available"),[];console.log("üìç Processing selection:",e);const n=[];for(const l of e){const c=r.list.get(l.modelId);if(!c){console.warn("üìç Model not found for item:",l);continue}try{const[u]=await c.getItemsData([l.localId],{attributesDefault:!1});if(u){const f=me(u,["globalid","global id","guid"]);f&&typeof f=="string"?(n.push(f),console.log("üìç Found GlobalId for item:",l,"‚Üí",f)):console.warn("üìç No GlobalId found in data for item:",l)}}catch(u){console.error("üìç Error fetching data for item:",l,u)}}return console.log("üìç Final selectedGlobalIds:",n),n},getVisibleGlobalIds:async()=>{console.log("üëÅÔ∏è getVisibleGlobalIds called");const e=i.current;if(!e)return console.warn("üëÅÔ∏è Fragments not available"),[];const r=[];for(const[n,l]of e.list)try{console.log(`üëÅÔ∏è Getting visible elements from model: ${n}`);const c=await l.getItemsByVisibility(!0);if(console.log(`üëÅÔ∏è Model ${n}: ${c.length} visible elements`),c.length===0)continue;const u=100;for(let f=0;f<c.length;f+=u){const w=c.slice(f,Math.min(f+u,c.length));try{const y=await l.getItemsData(w,{attributesDefault:!1,attributes:["GlobalId"]});for(const p of y){const E=me(p,["globalid","global id","guid"]);E&&typeof E=="string"&&r.push(E)}}catch(y){console.error(`üëÅÔ∏è Error fetching GlobalIds for batch in model ${n}:`,y)}}}catch(c){console.error(`üëÅÔ∏è Error getting visible elements from model ${n}:`,c)}return console.log(`üëÅÔ∏è Total visible GlobalIds: ${r.length}`),r},getElementProps:async e=>{console.log("üîç [getElementProps] START for",e);const r=i.current;if(!r)throw new Error("Fragments not available");console.log("üîç [getElementProps] Searching across",r.list.size,"models");for(const[n,l]of r.list)try{const u=(await l.getLocalIdsByGuids([e]))[0];if(u!=null){console.log(`üîç [getElementProps] Found in model ${n}, localId: ${u}`);const[f]=await l.getItemsData([u],ke);if(!f){console.warn(`üîç [getElementProps] No data returned for localId ${u}`);continue}console.log("üîç [getElementProps] Got data, extracting properties...");const w=Bt(f);console.log("üîç [getElementProps] ifcClass:",w);const y={},p={},E=Yt(f);console.log("üîç [getElementProps] Got",E.length,"property rows"),E.forEach(I=>{const A=I.label.split("/").map(N=>N.trim()),B=I.rawPsetName??A[1]??"",L=I.rawPropertyName??A[A.length-1]??"",V=lt(B),$=lt(L);!V||!$||(y[V]||(y[V]={}),$ in y[V]||(y[V][$]=I.value))}),p.ifcClass=w,p.GlobalId=e;const R=Be(f);R&&(p.Name=R);const F=me(f,["category","ifccategory"]);F&&(p.Category=F);const C=me(f,["type","typename"]);return C&&(p.Type=C),console.log(`üîç [getElementProps] SUCCESS: ${Object.keys(y).length} psets, ${Object.keys(p).length} attributes`),{ifcClass:w,psets:y,attributes:p}}}catch(c){console.warn(`üîç [getElementProps] Error in model ${n}:`,c);continue}throw console.error(`üîç [getElementProps] Element with GlobalId ${e} not found in any model`),new Error(`Element with GlobalId ${e} is not available.`)},getElementPropsFast:async e=>{console.log("üîç [getElementPropsFast] START for",e);const r=Ne.current,n=i.current;if(console.log("üîç [getElementPropsFast] Selection:",r),console.log("üîç [getElementPropsFast] Fragments available:",!!n),!n)throw console.error("üîç [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");console.log("üîç [getElementPropsFast] Searching in",r.length,"selected items");for(let l=0;l<r.length;l++){const c=r[l];console.log(`üîç [getElementPropsFast] Checking item ${l+1}/${r.length}:`,c);const u=n.list.get(c.modelId);if(!u){console.log(`üîç [getElementPropsFast] Model not found for ${c.modelId}`);continue}try{console.log(`üîç [getElementPropsFast] Calling getItemsData for localId ${c.localId}...`);const[f]=await u.getItemsData([c.localId],ke);if(console.log("üîç [getElementPropsFast] Got data:",!!f),f){console.log("üîç [getElementPropsFast] Data keys:",Object.keys(f)),console.log("üîç [getElementPropsFast] data._category:",f._category),console.log("üîç [getElementPropsFast] data.ifcClass:",f.ifcClass),console.log("üîç [getElementPropsFast] data.type:",f.type),console.log("üîç [getElementPropsFast] data.constructor.name:",f.constructor?.name);const w=me(f,["globalid","global id","guid"]);if(console.log(`üîç [getElementPropsFast] Element GlobalId: ${w}, looking for: ${e}`),w===e){console.log("üîç [getElementPropsFast] MATCH! Extracting properties...");const y=Bt(f);console.log("üîç [getElementPropsFast] ifcClass extracted:",y);const p={},E={};console.log("üîç [getElementPropsFast] Calling collectIfcPropertySetRows...");const R=Yt(f);console.log("üîç [getElementPropsFast] Got",R.length,"property rows"),R.forEach(A=>{const B=A.label.split("/").map(_=>_.trim()),L=A.rawPsetName??B[1]??"",V=A.rawPropertyName??B[B.length-1]??"",$=lt(L),N=lt(V);!$||!N||(p[$]||(p[$]={}),N in p[$]||(p[$][N]=A.value))}),console.log("üîç [getElementPropsFast] Extracted",Object.keys(p).length,"psets"),E.ifcClass=y,E.GlobalId=e;const F=Be(f);F&&(E.Name=F);const C=me(f,["category","ifccategory"]);C&&(E.Category=C);const I=me(f,["type","typename"]);return I&&(E.Type=I),console.log(`üìå Fast props for ${e}:`,{ifcClass:y,psetCount:Object.keys(p).length}),console.log("üîç [getElementPropsFast] SUCCESS - returning properties"),{ifcClass:y,psets:p,attributes:E}}}}catch(f){console.error("üîç [getElementPropsFast] Error for item:",c,f)}}return console.log(`üìå ${e} not in selection, falling back to cache`),console.log("üîç [getElementPropsFast] FALLBACK to getElementProps"),xt.current.getElementProps(e)},countElements:async()=>(await yo()).elements.length,iterElements:e=>{const r=Math.max(1,Math.floor(e?.batchSize??500));return console.log("üîÑ [viewerApi.iterElements] START",{batchSize:r}),{async*[Symbol.asyncIterator](){const n=i.current;if(!n||n.list.size===0){console.warn("‚ö†Ô∏è [viewerApi.iterElements] No fragments available");return}console.log(`üîÑ [viewerApi.iterElements] Processing ${n.list.size} models with batch size ${r}`);let l=[],c=0;for(const[u,f]of n.list){let w=[];try{const p=await f.getLocalIds();w=Array.isArray(p)?p:p&&typeof p[Symbol.iterator]=="function"?Array.from(p):[],console.log(`‚úÖ [viewerApi.iterElements] Model ${u}: ${w.length} elements`)}catch(p){console.error(`‚ùå [viewerApi.iterElements] Failed to get local IDs for model ${u}`,p);continue}const y=Math.min(500,Math.max(100,r));for(let p=0;p<w.length;p+=y){const E=w.slice(p,p+y);try{const R=await f.getItemsData(E,ke);for(let F=0;F<R.length;F++){const C=R[F];C&&l.push({modelId:u,localId:E[F],data:C})}for(;l.length>=r;){const F=l.splice(0,r);c+=F.length,(c%5e3===0||c===r)&&console.log(`üì§ [viewerApi.iterElements] Yielded ${c} elements...`),yield F}}catch(R){console.error(`‚ùå [viewerApi.iterElements] Failed to fetch chunk at ${p}`,R)}}}l.length>0&&(c+=l.length,yield l),console.log(`‚úÖ [viewerApi.iterElements] Complete: ${c} elements`)}}},_iterElementsLegacy:e=>{const r=Math.max(1,Math.floor(e?.batchSize??100));return{async*[Symbol.asyncIterator](){const n=await yo(),l=Array.from(n.records.values());for(let c=0;c<l.length;c+=r){const u=l.slice(c,c+r).map(f=>({modelId:f.modelId,localId:f.localId,data:{...f.raw,GlobalId:f.element.GlobalId}}));u.length&&(yield u)}}}},buildIdsCache:async()=>{try{return(await yo()).elements.length}catch(e){throw console.error("viewerApi.buildIdsCache failed",e),e}},getModelSignature:async()=>await ts(),addToCache:async e=>{console.log(`üì¶ [addToCache] Adding ${e.length} elements to cache`);const r=i.current;if(!r){console.warn("üì¶ [addToCache] Fragments not available");return}let n=Oe.current;n||(n={signature:Ho(),records:new Map,elements:[],modelLocalIds:new Map},Oe.current=n);const l=Ne.current;console.log(`üì¶ [addToCache] Selection has ${l.length} items`);for(const c of e){if(n.records.has(c)){console.log(`üì¶ [addToCache] ${c} already in cache, skipping`);continue}console.log(`üì¶ [addToCache] Searching for ${c} in ${l.length} selected items...`);let u=!1;for(const f of l){console.log(`üì¶ [addToCache] Checking item: modelId=${f.modelId}, localId=${f.localId}`);const w=r.list.get(f.modelId);if(!w){console.log(`üì¶ [addToCache] Model not found: ${f.modelId}`);continue}try{const[y]=await w.getItemsData([f.localId],ke);if(y){let p=y._guid||y.GlobalId;if(p&&typeof p=="object"&&(p=p.value||p),console.log(`üì¶ [addToCache] Item GlobalId: ${p}, looking for: ${c}, match: ${p===c}`),p===c){const E=Bt(y),R={};Yt(y).forEach(N=>{const _=N.label.split("/").map(se=>se.trim()),Y=N.rawPsetName??_[1]??"",q=N.rawPropertyName??_[_.length-1]??"",G=lt(Y),pe=lt(q);!G||!pe||(R[G]||(R[G]={}),pe in R[G]||(R[G][pe]=N.value))});const C={ifcClass:E,GlobalId:c},I=Be(y);I&&(C.Name=I);const A=me(y,["category","ifccategory"]);A&&(C.Category=A);const B=me(y,["type","typename"]);B&&(C.Type=B);const L={GlobalId:c,ifcClass:E,properties:Uo(y,c,E)},V={element:L,modelId:f.modelId,localId:f.localId,psets:R,attributes:C,raw:y};n.records.set(c,V),n.elements.push(L);const $=n.modelLocalIds.get(f.modelId)||[];$.push(f.localId),n.modelLocalIds.set(f.modelId,$),console.log(`üì¶ [addToCache] Added ${c} to cache (model: ${f.modelId}, localId: ${f.localId})`),u=!0;break}}}catch(y){console.debug("üì¶ [addToCache] Error checking selection item:",y)}}u||console.warn(`üì¶ [addToCache] Could not find ${c} in selection`)}console.log(`üì¶ [addToCache] Cache now has ${n.records.size} elements`)},color:async(e,r)=>{if(!e.length)return;const n=De.current,l=i.current,c=a.current;if(!n||!g.current||!l||!c)return;console.log(`üé® [color] Called with ${e.length} GlobalIds, rgba:`,r);let u,f;try{console.log("üé® [color] Calling groupLocalIdsByModel...");const p=await vt(e);u=p.grouped,f=p.cache,console.log(`üé® [color] groupLocalIdsByModel returned ${u.size} models`)}catch(p){console.error("üé® [color] groupLocalIdsByModel failed:",p);return}const w=new Ae(r.r,r.g,r.b),y=w.getHex();console.log(`üé® [color] Grouped into ${u.size} models, colorHex: ${y.toString(16)}`),eo.current||(eo.current=new Map);for(const[p,E]of u){const R=l.list.get(p);if(!(!R||!E.length)){console.log(`üé® [color] Processing model ${p} with ${E.length} localIds`);try{const F=Array.from(E);if(typeof n.add=="function")try{if(console.log(`üé® [color] Trying highlighter.add with colorHex: ${y.toString(16)}`),n.add(R,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using add method`),c&&typeof c.update=="function")try{c.update(),console.log("üé® [color] Forced world update")}catch(C){console.debug("World update failed:",C)}continue}catch(C){console.debug("add failed:",C)}if(typeof n.highlightById=="function")try{console.log("üé® [color] Trying highlightById..."),await n.highlightById(R,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using highlightById`);continue}catch(C){console.debug("highlightById failed:",C)}if(typeof n.highlightByID=="function")try{console.log("üé® [color] Trying highlightByID..."),await n.highlightByID(R,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using highlightByID`);continue}catch(C){console.debug("highlightByID failed:",C)}if(n.styles&&typeof n.styles.set=="function")try{if(!F||F.length===0){console.debug(`Skipping highlight for model ${p} - no IDs`);continue}const C=`ids-color-${y.toString(16).padStart(6,"0")}`;if(n.styles.set(C,{color:w,fillOpacity:1}),typeof n.create=="function")try{(!n.list||!n.list.has(C))&&n.create(C)}catch(I){console.debug("highlighter.create failed:",I)}if(typeof n.select=="function")try{n.select(R,F,C)}catch(I){throw console.debug("highlighter.select failed:",I),I}console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using styles.set`);continue}catch(C){console.debug("styles.set failed:",C)}console.warn(`‚ùå Could not color model ${p} - all highlighter methods failed`)}catch(F){console.error(`Failed to color model ${p}:`,F)}}}},clearColors:async()=>{const e=De.current,r=i.current;if(g.current){if(r&&Je.current&&Je.current.size>0)try{for(const[n,l]of Je.current){const{color:c,transparent:u,opacity:f}=l;n.transparent=u,n.opacity=f,c!==void 0&&("color"in n?n.color.setHex(c):"lodColor"in n&&n.lodColor.setHex(c)),n.needsUpdate=!0}Je.current.clear(),console.log("Restored original material properties")}catch(n){console.warn("Failed to restore original materials",n)}try{if(e){if(e.styles&&typeof e.styles.delete=="function")try{e.styles.delete("ghost"),console.log("Cleared ghost styles")}catch(n){console.warn("Failed to clear ghost styles",n)}typeof e.clear=="function"&&(await Promise.resolve(e.clear()),console.log("Cleared highlighter colors using clear()")),e.styles&&typeof e.styles.clear=="function"&&(e.styles.clear(),console.log("Cleared highlighter styles"))}}catch(n){console.warn("Failed to clear IDS highlights",n)}eo.current&&eo.current.clear();try{const n=Fe.current;if(n&&n.mesh&&n.mesh.instanceColor){const l=new Ae(1,1,1);n.mesh.setColorAt(n.index,l),n.mesh.instanceColor.needsUpdate=!0}}catch(n){console.warn("Failed to reset instanced mesh highlight",n)}Fe.current=null}},isolate:async e=>{const r=We.current,n=i.current;if(!r||!n||!g.current||(await Promise.resolve(r.set(!0)),!e.length||!g.current))return;const{grouped:l}=await vt(e);if(l.size===0){console.warn("isolate: No elements found in cache for isolation");return}const c=new Map;l.forEach((f,w)=>{c.set(w,new Set(f))});const u={};for(const[f,w]of c.entries()){const y=n.list.get(f);if(y)try{let p=[];const E=await y.getLocalIds();Array.isArray(E)?p=E:E&&typeof E[Symbol.iterator]=="function"&&(p=Array.from(E));const R=p.filter(F=>!w.has(F));R.length>0&&(u[f]=new Set(R))}catch(p){console.error("isolate: Failed to get local IDs for model",f,p)}}Object.keys(u).length>0&&await Promise.resolve(r.set(!1,u))},clearIsolation:async()=>{const e=We.current;e&&await Promise.resolve(e.set(!0))},ghost:async e=>{console.log(`[ghost] Applying ghost mode by coloring ${e.length} matching elements`);const r=i.current,n=a.current;if(!r||!g.current||!n){console.warn("[ghost] Fragments or world not ready");return}const{grouped:l}=await vt(e);if(l.size===0){console.warn("[ghost] No elements found");return}const c=[...r.core.models.materials.list.values()];console.log(`[ghost] Found ${c.length} materials to ghost`),Je.current||(Je.current=new Map);for(const p of c)if(!p.userData?.customId){if(!Je.current.has(p)){let E;"color"in p?E=p.color.getHex():"lodColor"in p&&(E=p.lodColor.getHex()),Je.current.set(p,{color:E,transparent:p.transparent,opacity:p.opacity})}p.transparent=!0,p.opacity=.15,p.needsUpdate=!0}console.log(`[ghost] Ghosted ${c.length} materials`);const u=De.current;if(!u){console.warn("[ghost] Highlighter not available"),n.update();return}const w=new Ae(0,1,1).getHex();let y=0;for(const[p,E]of l.entries()){const R=r.list.get(p);if(R)try{typeof u.add=="function"&&(u.add(R,Array.from(E),w),y+=E.length,console.log(`[ghost] Colored ${E.length} elements in model ${p}`))}catch(F){console.error(`[ghost] Failed to color elements in model ${p}:`,F)}}n.update(),console.log(`[ghost] Complete: ghosted ${c.length} materials, colored ${y} matching elements in cyan`)},getItemsData:async(e,r)=>{console.log("üîç [getItemsData] START",{globalIds:e.length,config:r});const n=i.current;if(!n)return console.error("üîç [getItemsData] Fragments not available"),[];const{grouped:l}=await vt(e),c=[];for(const[u,f]of l.entries()){const w=n.list.get(u);if(w)try{const y=await w.getItemsData(Array.from(f),r);c.push(...y)}catch(y){console.error(`üîç [getItemsData] Failed for model ${u}`,y)}}return console.log("‚úÖ [getItemsData] Complete:",c.length,"items"),c},getItemsByCategory:async e=>{console.log("üîç [getItemsByCategory] START",{categories:e.length});const r=i.current;if(!r)return console.error("üîç [getItemsByCategory] Fragments not available"),{};const n={};for(const[l,c]of r.list)try{const u=await c.getItemsOfCategories(e);if(u&&Object.keys(u).length>0){const f=Object.values(u).flat();f.length>0&&(n[l]=f)}}catch(u){console.error(`üîç [getItemsByCategory] Failed for model ${l}`,u)}return console.log("‚úÖ [getItemsByCategory] Complete:",Object.keys(n).length,"models"),n},getItemsDataByModel:async(e,r,n)=>{console.log("üîç [getItemsDataByModel] START",{modelId:e,localIds:r.length,config:n});const l=i.current;if(!l)return console.error("üîç [getItemsDataByModel] Fragments not available"),[];const c=l.list.get(e);if(!c)return console.error(`üîç [getItemsDataByModel] Model ${e} not found`),[];try{const u=await c.getItemsData(r,n);return console.log("‚úÖ [getItemsDataByModel] Complete:",u.length,"items"),u}catch(u){return console.error(`üîç [getItemsDataByModel] Failed for model ${e}`,u),[]}},fitViewTo:async e=>{if(!e.length)return;const r=a.current,n=i.current;if(!r||!n||!g.current)return;const l=r.camera??null,c=l?.controls??null,u=l?.three??null,{grouped:f}=await vt(e),w=new it;let y=!1;for(const[C,I]of f.entries()){const A=n.list.get(C);if(!A||!A.object)continue;const B=new it().setFromObject(A.object);B.isEmpty()||(y?w.union(B):(w.copy(B),y=!0))}if(!y)return;const p=new Z,E=new Z;w.getCenter(p),w.getSize(E);const F=(Math.max(E.x,E.y,E.z)||10)*1.5;c?c.setLookAt(p.x+F,p.y+F,p.z+F,p.x,p.y,p.z,!0):u&&(u.position.set(p.x+F,p.y+F,p.z+F),u.lookAt(p))}}),[vt]);xt.current=qo;const os=d.useCallback(()=>{lo(!0),Do(e=>e+1)},[]),rs=d.useCallback(()=>{lo(!1);const e=xt.current;e&&(Promise.resolve(e.clearColors()).catch(()=>{}),e.clearIsolation&&Promise.resolve(e.clearIsolation()).catch(()=>{}))},[]),qr=d.useCallback(()=>{lo(e=>{const r=!e;return r&&Do(n=>n+1),r})},[]),ns=d.useCallback(async e=>{try{const{setIdsXmlText:r,runCheck:n}=await Mt(()=>Promise.resolve().then(()=>Gl),void 0).then(l=>l.idsStore);r(e),lo(!0),Do(l=>l+1),setTimeout(async()=>{xt.current&&await n(xt.current)},100)}catch(r){console.error("Failed to validate from IDS Creator:",r),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Ne.current=v},[v]),d.useEffect(()=>{Oe.current=null,Tt.current=null;try{vn.invalidateCaches()}catch(e){console.warn("Failed to invalidate IDS caches",e)}},[j]),d.useEffect(()=>{const e=t.current;if(!e)return;let r=!1;cr.current||(Ks.init(),Ys.init(),cr.current=!0);try{e.replaceChildren()}catch{}const n=new Xs;b.current=n;const c=n.get(Js).create();c.name="main",c.scene=new Zs(n),c.scene.setup(),c.renderer=new Qs(n,e);const u=c.renderer.three;u.shadowMap.enabled=!1,u.sortObjects=!1,c.camera=new el(n),c.camera.controls?.setLookAt(10,10,10,0,0,0),c.camera.three.near=.1,c.camera.three.far=1e9,c.camera.three.updateProjectionMatrix();const f=c.camera.controls;f&&(Fr.current=f,"mouseButtons"in f&&(f.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in f&&(f.dollySpeed=1));const w=new ll(16777215,1);c.scene.three.add(w),a.current=c;const y=new Es;y.showPanel(2),y.dom.style.position="absolute",y.dom.style.left="8px",y.dom.style.top="8px",y.dom.style.zIndex="1000",e.appendChild(y.dom),c.renderer.onBeforeUpdate.add(()=>y.begin()),c.renderer.onAfterUpdate.add(()=>y.end());let p=null;const E=async C=>{if(!g.current)return;const I=[];for(const[N,_]of Object.entries(C))_.forEach(Y=>{Number.isInteger(Y)&&I.push({modelId:N,localId:Y})});const A=Ne.current;if(!!sr(I,A))return;z(I),kt();const L=i.current;if(!L||!I.length){Pe(null);return}const V=I[0],$=L.list.get(V.modelId);if(!$){Pe(null);return}try{const[N]=await $.getItemsData([V.localId],ke);Pe(N||null)}catch(N){console.warn("Failed to fetch properties for selection",N)}},R=()=>{z([]),Pe(null)};return(async()=>{try{await Promise.resolve(n.init())}catch($){console.error("Failed to initialize viewer components",$);return}if(r)return;try{n.get(tl).create(c)}catch($){console.warn("Failed to create grid component",$)}const I=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),A=URL.createObjectURL(new File([I],"worker.mjs",{type:"text/javascript"}));P.current=A;const B=n.get(ol);await B.init(A),i.current=B,g.current=!0;const L=n.get(rl);L.setup({world:c}),L.zoomToSelection=!0;try{typeof L.create=="function"&&L.create("select")}catch{}De.current=L;const V=n.get(nl);We.current=V;try{const $=n.get(sl);if($.world=c,$.color=new Ae("#ff0000"),"snapDistance"in $&&($.snapDistance=.5),"preview"in $){const N=$.preview;N&&(N.enabled=!0,N.color&&(N.color=new Ae("#00ff00")))}if("workingPlane"in $){const N=$.workingPlane;N&&typeof N=="object"&&(N.visible=!0)}$.list?.onItemAdded&&$.list.onItemAdded.add(N=>{const _=N.value||N.distance?.()||0;console.log(`‚úÖ Measurement created: ${_.toFixed(3)} units`),Dr(_.toFixed(3)),N.dimensionLabel&&(N.dimensionLabel.visible=!0)}),$.enabled=!1,fo.current=$,console.log("‚úÖ Measurement tool initialized:",$),console.log("Measurement tool properties:",Object.keys($))}catch($){console.error("Failed to initialize measurement tool:",$)}L.events.select.onHighlight.add(E),L.events.select.onClear.add(R),p=()=>{L.events.select.onHighlight.remove?.(E),L.events.select.onClear.remove?.(R)},mt()?.controls?.addEventListener("rest",()=>B.core.update(!0));try{const N=(await Mt(()=>import("./thatopen-vendor-byvyd1e5.js").then(q=>q.i),__vite__mapDeps([2,3,1]))).IfcImporter,_=new N,Y="/Savora-Viewer/";_.wasm={path:`${Y}web-ifc/`,absolute:!0},x.current=_}catch($){console.warn("Failed to lazy-load FRAGS.IfcImporter:",$)}r||Ge(!0)})().catch(C=>{console.error("Failed to initialize viewer fragments",C)}),()=>{r=!0,(async()=>{const C=g.current;g.current=!1,p?.(),p=null;try{C&&await We.current?.set?.(!0)}catch{}if(i.current){const I=[...i.current.list.keys()];await Promise.all(I.map(A=>i.current.core.disposeModel(A)))}try{C&&De.current?.clear?.()}catch{}P.current&&URL.revokeObjectURL(P.current);try{n.dispose()}catch{}try{e.replaceChildren()}catch{}De.current=null,We.current=null})()}},[]),d.useEffect(()=>{if(!be)return;const e=b.current,r=i.current;if(!e||!r)return;const n=go,l=(c,u,f)=>{if(!c)return;let w=u.current;w||(w=f(),u.current=w),w&&w.parentElement!==c&&c.replaceChildren(w)};l(dr.current,dt,()=>{const[c,u]=un.modelsList({components:e});return Eo.current=u,c}),dt.current&&((!dt.current.dataset.initialized||n!==fr.current)&&Eo.current?.({components:e}),dt.current.dataset.initialized||(dt.current.dataset.initialized="true",dt.current.style.width="100%")),no.current!==ur.current&&(Po.current=null,Ft.current=null,ur.current=no.current),l(no.current,Po,()=>{const[c,u]=un.spatialTree({components:e,models:Array.from(r.list.values())});Ft.current=u,c.style.width="100%",c.style.height="100%",c.style.overflow="auto";const f=c;return f.queryString=wt.trim()?wt.trim():null,c}),Ft.current&&Ft.current({components:e,models:Array.from(r.list.values())}),fr.current=n},[be,Q,wt,go]),d.useEffect(()=>{if(!be)return;const e=b.current,r=i.current,n=Ft.current;!e||!r||!n||n({components:e,models:Array.from(r.list.values())})},[be,go]),d.useEffect(()=>{const e=Po.current;if(!e)return;const r=wt.trim();e.queryString=r||null},[wt]);const ss=async()=>{const e=s.current,r=e?.files?.[0];if(!r)return;const n=r.name.split(".").pop()?.toLowerCase(),l=i.current,c=x.current,u=a.current;if(!l||!u){alert("Viewer is still initializing. Please try again in a moment."),e&&(e.value="");return}const f=mt(),w=f?.three??null,y=f?.controls??null;let p=!1;try{const E=`${r.name}-${Date.now()}`;let R;if(n==="ifc"){if(!c)throw new Error("IFC importer is not ready.");Ye(0),p=!0,Xe.current=!1,_e(!1);const A=new AbortController;$t.current=A;const B=new Uint8Array(await r.arrayBuffer()),L=await c.process({bytes:B,progressCallback:($,N)=>{if(Xe.current)return;const _=typeof $=="number"?$:0,Y=_<=1?_*100:_,q=Math.max(0,Math.min(100,Y));Ye(Number(q.toFixed(1))),console.log(`IFC conversion progress: ${q.toFixed(1)}%`,N)},signal:A.signal});if(Xe.current)throw{__cancelled:!0};let V;if(L instanceof ArrayBuffer){const $=new Uint8Array(L),N=new Uint8Array($.byteLength);N.set($),V=N.buffer}else if(L instanceof Uint8Array){const $=new Uint8Array(L.byteLength);$.set(L),V=$.buffer}else{const $=L,N=new Uint8Array($),_=new Uint8Array(N.byteLength);_.set(N),V=_.buffer}R=await l.core.load(V,{modelId:E})}else if(n==="frag"){const A=await r.arrayBuffer();R=await l.core.load(A,{modelId:E})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}h.current=E,w?R.useCamera(w):console.warn("World camera not ready; skipping model camera binding."),u.scene.three.add(R.object),await l.core.update(!0),await new Promise(A=>requestAnimationFrame(()=>A()));const F=new it().setFromObject(R.object),C=new Z;F.getCenter(C),(Math.abs(C.x)>1e6||Math.abs(C.y)>1e6||Math.abs(C.z)>1e6)&&R.object.position.sub(C);try{y&&await y.fitToBox(R.object,!0)}catch{const A=new Z;F.getSize(A);const L=(Math.max(A.x,A.y,A.z)||10)*2.5;y?y.setLookAt(C.x+L,C.y+L,C.z+L,C.x,C.y,C.z,!0):w&&(w.position.set(C.x+L,C.y+L,C.z+L),w.lookAt(C))}_n(A=>({...A,[E]:Xl(E,r.name,R.object)})),k(!0),O(A=>[...A,{id:E,label:r.name}]),kt();const I=b.current;I&&Eo.current?.({components:I}),p&&Ye(100)}catch(E){E&&(E.__cancelled||E?.name==="AbortError")?console.info("IFC conversion cancelled by user."):(console.error(E),alert("Failed to load model. See console for more details.")),k(!1)}finally{e&&(e.value=""),p&&setTimeout(()=>Ye(null),200),$t.current=null,_e(!1)}},ls=d.useCallback(()=>{if(Ce!==null){Xe.current=!0,_e(!0);try{$t.current?.abort()}catch{}Ye(null)}},[Ce]),kt=d.useCallback(()=>{J(!0),X(!1)},[]),Kr=d.useCallback(()=>{J(e=>{const r=!e;return r&&X(!1),r})},[]),is=d.useCallback(()=>{J(!1)},[]),as=d.useCallback(()=>{X(e=>!e)},[]),Yr=d.useMemo(()=>Math.min(360,Math.max(180,oo.height*.45)),[oo.height]),cs=+!zn+ +!$n,Ko=!Rn&&cs===0;d.useEffect(()=>{const e=dt.current;e&&(e.style.width="100%",e.style.maxHeight=Ko?"100%":`${Yr}px`,e.style.height=Ko?"100%":"auto")},[Ko,Yr,go]);const ds=d.useCallback(async e=>{const r=I=>{const A=[],B=new Set;if(!I||typeof I!="object")return{terms:A,modelIds:B};for(const[L,V]of Object.entries(I)){if(V==null)continue;const $=L.trim().toLowerCase(),N=Array.isArray(V)?V:[V];if(N.length){if($==="modelid"||$==="modelids"||$==="model"){for(const _ of N){const Y=typeof _=="string"?_.trim():String(_??"").trim();Y&&B.add(Y)}continue}if(["text","query","keyword","search"].includes($)){for(const _ of N){if(_==null)continue;const Y=typeof _=="string"?_.trim().toLowerCase():String(_??"").trim().toLowerCase();Y&&A.push({type:"text",value:Y})}continue}for(const _ of N){if(_==null)continue;let Y=null;typeof _=="string"?Y=_.trim():(typeof _=="number"||typeof _=="boolean")&&(Y=String(_)),Y&&A.push({type:"field",key:$,value:Y.toLowerCase()})}}}return{terms:A,modelIds:B}},n=i.current;if(!n){console.warn("AI selection requested but fragments are unavailable.");return}if(!g.current){console.warn("AI selection requested before fragments were fully initialized.");return}const l=De.current,c=We.current,{terms:u,modelIds:f}=r(e.filter),w=e.mode?.toLowerCase?.(),y=w==="isolate"||w==="focus";if(e.action==="clear"){try{l?.clear?.()}catch{}if(c)try{await c.set(!0)}catch(I){console.warn("Failed to reset visibility while clearing AI selection",I)}try{const I=Fe.current;if(I&&I.mesh&&I.mesh.instanceColor){const A=new Ae(1,1,1);I.mesh.setColorAt(I.index,A),I.mesh.instanceColor.needsUpdate=!0}}catch{}Fe.current=null,$e.current&&($e.current.visible=!1),z([]),Pe(null);return}if(u.length===0){console.warn("AI selection command did not include usable filters",e);return}const p=++Qt.current,E=[],R=60;for(const I of n.list.values()){const A=typeof I?.modelId=="string"?I.modelId:"";if(f.size&&!f.has(A))continue;let B=[];try{const V=await I.getLocalIds();Array.isArray(V)?B=V.slice():V&&typeof V[Symbol.iterator]=="function"&&(B=Array.from(V))}catch(V){console.warn("Failed to fetch local IDs for model",A,V)}const L={model:I,modelId:A,allIds:B,matched:new Set};if(E.push(L),!!B.length)for(let V=0;V<B.length;V+=R){if(p!==Qt.current)return;const $=B.slice(V,V+R);let N=[];try{N=await I.getItemsData($,ke)}catch(_){console.warn("Failed to retrieve property batch for AI selection",_);continue}$.forEach((_,Y)=>{const q=N?.[Y];if(!q)return;let G=[];try{G=Xt(q).rows}catch(ue){console.warn("Failed to build property rows for AI selection",ue)}const pe=G.map(ue=>ue.searchText),se=jo(q,6e3).toLowerCase();u.every(ue=>{if(ue.type==="text")return pe.some(oe=>oe.includes(ue.value))||se.includes(ue.value);const Ve=Kl[ue.key]??[ue.key];return pe.some(oe=>Ve.some(Ie=>oe.includes(Ie))&&oe.includes(ue.value))?!0:Ve.some(oe=>se.includes(oe)&&se.includes(ue.value))})&&L.matched.add(_)})}}if(p!==Qt.current)return;const F=E.filter(I=>I.matched.size>0);if(!F.length){console.info("AI selection produced no matches for command",e);return}try{const I=Fe.current;if(I&&I.mesh&&I.mesh.instanceColor){const A=new Ae(1,1,1);I.mesh.setColorAt(I.index,A),I.mesh.instanceColor.needsUpdate=!0}}catch{}if(Fe.current=null,$e.current&&($e.current.visible=!1),c)try{await c.set(!0)}catch(I){console.warn("Failed to reset hidden state before AI selection",I)}if(l){try{l.clear?.()}catch{}const I=y?16754240:6737151;for(const A of F){const B=Array.from(A.matched);if(B.length)try{typeof l.highlightById=="function"?await l.highlightById(A.model,B,I):typeof l.highlightByID=="function"?await l.highlightByID(A.model,B,I):typeof l.add=="function"&&l.add(A.model,B,I)}catch(L){console.warn("Failed to apply AI highlight for model",A.modelId,L)}}}if(y&&c){const I={};for(const A of E){if(!A.allIds.length||A.matched.size===A.allIds.length)continue;const B=A.allIds.filter(L=>!A.matched.has(L));B.length&&(I[A.modelId]=new Set(B))}if(Object.keys(I).length)try{await c.set(!1,I)}catch(A){console.warn("Failed to isolate AI-selected elements",A)}}const C=F.flatMap(I=>Array.from(I.matched).map(A=>({modelId:I.modelId,localId:A})));z(C),kt();try{const I=F[0],A=Array.from(I.matched)[0];if(A!==void 0){const[B]=await I.model.getItemsData([A],ke);p===Qt.current&&Pe(B||null)}}catch(I){console.warn("Failed to fetch properties for AI selection result",I)}},[kt,z,Pe]),bo=d.useCallback(e=>{if(!ro.current)return;const r=vo.current;if(!r)return;const n=e.clientX-r.startX,l=e.clientY-r.startY,c=280,u=260;En(f=>{const w=r.width,y=r.height,p=Math.max(c,w+n),E=Math.max(u,y+l);return p===f.width&&E===f.height?f:{width:Math.round(p),height:Math.round(E)}})},[]),_t=d.useCallback(()=>{ro.current&&(ro.current=!1,vo.current=null,window.removeEventListener("pointermove",bo),window.removeEventListener("pointerup",_t))},[bo]),us=d.useCallback(e=>{e.preventDefault(),e.stopPropagation();const r=ko.current;r&&(ro.current=!0,vo.current={startX:e.clientX,startY:e.clientY,width:r.offsetWidth,height:r.offsetHeight},window.addEventListener("pointermove",bo),window.addEventListener("pointerup",_t))},[bo,_t]);d.useEffect(()=>()=>{_t()},[_t]);const fs=d.useCallback(async()=>{const e=i.current,r=[];if(!e||e.list.size===0||j.length===0)r.push("No models are currently loaded in the viewer.");else{r.push(`Loaded models (${j.length}): ${j.map(l=>`${l.label} [${l.id}]`).join(", ")}`),r.push(`Fragments models in memory: ${e.list.size}`);try{const l=new it;for(const u of e.list.values())l.expandByObject(u.object);const c=new Z;l.getSize(c),r.push(`Scene bounds approx size => x:${c.x.toFixed(2)} y:${c.y.toFixed(2)} z:${c.z.toFixed(2)}`)}catch(l){console.warn("Failed to compute bounds for AI context",l)}const n=j.map(l=>vr[l.id]).filter(l=>!!l);if(n.length){let l=0;const c=new Map;r.push("Model geometry snapshots:");for(const f of n){l+=f.elementCount;for(const{category:y,count:p}of f.categoryCounts)c.set(y,(c.get(y)??0)+p);const w=f.categoryCounts.slice(0,5).map(({category:y,count:p})=>`${y}: ${p}`);r.push(`- ${f.label} [${f.modelId}] ‚Üí elements‚âà${f.elementCount}, instanced‚âà${f.instancedCount}, meshes‚âà${f.meshCount}`),w.length&&r.push(`  top categories: ${w.join(" | ")}`),r.push(`  bbox size (approx): x:${f.bboxSize.x.toFixed(2)} y:${f.bboxSize.y.toFixed(2)} z:${f.bboxSize.z.toFixed(2)}`)}const u=Array.from(c.entries()).sort((f,w)=>w[1]-f[1]).slice(0,10).map(([f,w])=>`${f}: ${w}`);r.push(`Global approx element total: ${l}`),u.length&&r.push(`Global top categories: ${u.join(" | ")}`)}else r.push("Geometry summaries are initializing ‚Äî load a model or wait a moment after loading.")}if(v.length){r.push(`Active selection count: ${v.length}`);for(let n=0;n<v.length;n+=1){const l=v[n];r.push(`Selection #${n+1} ‚Üí modelId:${l.modelId}, localId:${l.localId}`);let c=null;if(n===0&&K&&Object.keys(K).length)c=K;else if(e){const u=e.list.get(l.modelId);if(u)try{const[f]=await u.getItemsData([l.localId],ke);c=f||null}catch(f){console.warn("Failed to fetch properties for AI context (multi)",f)}}if(c){r.push("  Property snapshot (compact JSON):"),r.push(`  ${jo(c,4e3)}`);const u=Xt(c).rows;if(u.length){r.push(`  Flattened properties (${u.length} entries):`);for(const f of u.slice(0,120))r.push(`  - ${f.label}: ${f.value}`);u.length>120&&r.push(`  (Truncated ${u.length-120} additional properties)`)}}else r.push("  Properties for this selection are not available yet.")}}else if(r.push("No active selection ‚Äî exporting properties for every loaded element."),e&&e.list.size)for(const n of j){const l=e.list.get(n.id);if(!l){r.push(`Model ${n.label} [${n.id}] could not be found in the fragments registry.`);continue}try{const c=await l.getLocalIds(),u=Array.isArray(c)?c:c?Array.from(c):[];if(!u||u.length===0){r.push(`Model ${n.label} [${n.id}] has no retrievable local IDs.`);continue}r.push(`Model ${n.label} [${n.id}] ‚Äî enumerating ${u.length} items:`);const f=u.length<=40?12:u.length<=120?6:3,w=50;for(let y=0;y<u.length;y+=w){const p=u.slice(y,y+w);let E=[];try{E=await l.getItemsData(p,ke)}catch(R){const F=p[0],C=p[p.length-1];r.push(`  Failed to retrieve properties for items ${F}‚Äì${C}: ${R?.message??R}`);continue}p.forEach((R,F)=>{const C=E?.[F];if(!C){r.push(`- localId:${R} (no data available)`);return}const I=Ql(C,f).replace(/\s+/g," ").trim();r.push(`- localId:${R} | ${I}`)})}}catch(c){r.push(`Failed to enumerate items for model ${n.label} [${n.id}]: ${c?.message??c}`)}}else r.push("Fragments data is not available to enumerate model items.");if(Ot.length){r.push("ItemsData extracted name/value pairs (last selection):");const n=150,l=Ot.slice(0,n);for(const c of l)r.push(`- ${c.path}: ${c.value}`);Ot.length>n&&r.push(`(Truncated ${Ot.length-n} additional rows)`)}return Fo&&(r.push("ItemsData table snapshot for last selection (tab-separated):"),r.push(Fo)),r.length===0&&r.push("Viewer is idle: no models or selections to describe."),r.join(`
`)},[j,v,K,ae,vr,Fo,Ot]),ps=d.useCallback(async()=>{const e=a.current,r=i.current,n=h.current;if(!e||!r||!n||!g.current)return;const l=r.list.get(n);if(!l)return;await r.core.update(!0),await new Promise(f=>requestAnimationFrame(()=>f()));const c=l.object,u=new it().setFromObject(c);if(!u.isEmpty()){const f=mt(),w=f?.controls??null,y=f?.three??null;try{w&&await w.fitToBox(c,!0)}catch{const E=new Z,R=new Z;u.getCenter(E),u.getSize(R);const C=(Math.max(R.x,R.y,R.z)||10)*2.5;w?w.setLookAt(E.x+C,E.y+C,E.z+C,E.x,E.y,E.z,!0):y&&(y.position.set(E.x+C,E.y+C,E.z+C),y.lookAt(E))}}},[]),ms=d.useCallback(async()=>{const e=Ne.current,r=We.current;if(!e||e.length===0||!r||!g.current){Ee(null);return}const n={};for(const l of e)n[l.modelId]||(n[l.modelId]=new Set),n[l.modelId].add(l.localId);try{await r.set(!1,n);try{De.current?.clear?.()}catch{}z([]),Pe(null)}catch(l){console.warn("Failed to hide selected element",l)}finally{Ee(null)}},[Ee,z,Pe]),gs=d.useCallback(async()=>{const e=We.current;if(!e||!g.current){Ee(null);return}try{await e.set(!0)}catch(r){console.warn("Failed to reset hidden items",r)}finally{Ee(null)}},[Ee]),hs=d.useCallback(()=>{Ee(null)},[Ee]);d.useEffect(()=>{const e=t.current,r=a.current;if(!e||!r)return;const n=r.renderer?.three.domElement;if(!n)return;const l=new fn,c=async(C,I,A,B)=>{console.log("üî∑ Rectangle Selection Started (viewport coords)",{left:C,top:I,right:A,bottom:B});const L=i.current;if(!L){console.warn("‚ùå No fragments manager");return}console.log("üì¶ Models available:",L.list.size);const V=Vo();if(!V){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const $=n.getBoundingClientRect();console.log("üìè Canvas bounds:",{rectLeft:$.left,rectTop:$.top,rectWidth:$.width,rectHeight:$.height}),new pn;const N=new Map,_=10,Y=A-C,q=B-I;if(console.log("üìê Rectangle size:",{width:Y,height:q,sampleSize:_}),Y<3||q<3){console.log("‚ö†Ô∏è Rectangle too small, using click selection"),await u((C+A)/2,(I+B)/2);return}let G=0,pe=0,se=!0;for(let we=C;we<=A;we+=_)for(let oe=I;oe<=B;oe+=_){G++;const Ie=(we-$.left)/$.width*2-1,rt=-((oe-$.top)/$.height)*2+1;l.set(Ie,rt),se&&console.log("üîç First sample point:",{screenCoords:{x:we,y:oe},rectBounds:{left:$.left,top:$.top,width:$.width,height:$.height},mouseNDC:{x:Ie,y:rt},mouseVector:l.clone()});for(const nt of L.list.values())try{const Gt=new fn(Ie,rt);se&&console.log("üî¨ Raycast params:",{mouseVec:Gt.clone(),cameraType:V.type,domElement:n?.tagName,modelId:nt.modelId});const st=await nt.raycast({camera:V,mouse:Gt,dom:n});if(se&&console.log("üî¨ Raycast result:",{hit:st,hasDistance:st&&typeof st.distance=="number",hitType:typeof st}),st&&typeof st.distance=="number"){pe++;const Wt=st.localId;console.log("üéØ Hit found:",{point:{x:we,y:oe},mouseNDC:{x:Ie,y:rt},localId:Wt,distance:st.distance,modelId:nt.modelId}),Wt!=null&&Number.isInteger(Wt)&&(N.has(nt.modelId)||N.set(nt.modelId,new Set),N.get(nt.modelId).add(Wt))}}catch(Gt){se&&console.warn("‚ùå Raycast error on first sample:",Gt),console.debug("Skipping model due to raycast error:",Gt)}se&&(se=!1)}console.log("üìä Sampling complete:",{samplePoints:G,hitCount:pe,uniqueObjects:N.size});const ye=[];for(const[we,oe]of N.entries())for(const Ie of oe)ye.push({modelId:we,localId:Ie});if(console.log("‚úÖ Rectangle Selection Result:",{totalSelected:ye.length,byModel:Array.from(N.entries()).map(([we,oe])=>({modelId:we,count:oe.size}))}),ye.length===0){console.warn("‚ö†Ô∏è No objects found in rectangle"),z([]),Pe(null);return}const ue=Ne.current;if(!!sr(ye,ue)){console.log("‚ÑπÔ∏è Selection unchanged");return}if(console.log("üîÑ Updating selection with",ye.length,"objects"),z(ye),kt(),ye.length>0){const we=ye[0],oe=L.list.get(we.modelId);if(oe)try{const[Ie]=await oe.getItemsData([we.localId],ke);Pe(Ie||null)}catch(Ie){console.warn("Failed to fetch properties for rectangle selection",Ie)}}},u=async(C,I)=>{const A=i.current;if(!A)return;const B=Vo();if(!B){console.warn("Picking skipped: viewer camera not ready.");return}const L=n.getBoundingClientRect();l.x=(C-L.left)/L.width*2-1,l.y=-((I-L.top)/L.height)*2+1,console.log("üñ±Ô∏è Click selection:",{viewport:{x:C,y:I},canvasBounds:{left:L.left,top:L.top,width:L.width,height:L.height},mouseNDC:{x:l.x,y:l.y}});let V=null;const $=new pn;$.setFromCamera(l,B);for(const q of A.list.values())try{const G=await q.raycast({camera:B,mouse:l,dom:r.renderer.three.domElement});if(G&&typeof G.distance=="number"){const pe=G.point instanceof Z?G.point.clone():$.ray.at(G.distance,new Z);(!V||G.distance<V.dist)&&(V={dist:G.distance,model:q,localId:G.localId,point:pe,object:G.object,instanceId:G.instanceId})}}catch(G){console.debug("Skipping model due to raycast error:",G)}if(!V)return;const N=De.current;if(N&&N.enabled!==!1)try{typeof N.clear=="function"&&!He?N.clear():He&&console.log("üö´ Skipping hl.clear() - ghost mode active");const q=6737151;N.onBeforeHighlight?typeof N.highlightByID=="function"?await N.highlightByID(V.model.uuid,[V.localId],q):typeof N.add=="function"?N.add(V.model.uuid,[V.localId]):typeof N.highlight=="function"&&await N.highlight(V.model,[V.localId],q):console.warn("‚ö†Ô∏è Highlighter not fully initialized, skipping highlight")}catch(q){console.warn("Highlighter failed, using fallback:",q);try{const G=V.object,pe=V.instanceId;if(G&&G.isInstancedMesh&&Number.isInteger(pe)){const se=Fe.current;if(se&&se.mesh&&se.mesh.instanceColor){const Ve=new Ae(1,1,1);try{se.mesh.setColorAt(se.index,Ve),se.mesh.instanceColor.needsUpdate=!0}catch{}}const ye=G,ue=new Ae(6737151);try{ye.setColorAt(pe,ue),ye.instanceColor.needsUpdate=!0}catch{}Fe.current={mesh:ye,index:pe}}}catch{}}try{const q=V.point??new Z;let G=$e.current;if(!G){G=new il;const ye=new it,ue=i.current;if(ue&&ue.list.size)for(const nt of ue.list.values())ye.expandByObject(nt.object);const Ve=new al;ye.getBoundingSphere(Ve);const we=isFinite(Ve.radius)&&Ve.radius>0?Ve.radius*.01:.3,oe=Math.max(.05,Math.min(2,we)),Ie=new mn(new cl(oe*.5,16,16),new gn({color:16763904,depthTest:!1})),rt=new mn(new dl(oe*.8,oe,32),new gn({color:16772744,side:ul,depthTest:!1,transparent:!0,opacity:.9}));rt.rotation.x=Math.PI/2,Ie.renderOrder=999,rt.renderOrder=999,G.add(Ie),G.add(rt),r.scene.three.add(G),$e.current=G}G.position.copy(q);const pe=G.children[1],se=Vo();se&&pe.lookAt(se.position),G.visible=!0}catch{}const _=Ne.current,Y=[{modelId:V.model.modelId,localId:V.localId}];if(!sr(Y,_)){z(Y),kt();try{const[q]=await V.model.getItemsData([V.localId],ke);Pe(q||null)}catch{}}He&&(console.log("üü† Ghost mode active - scheduling orange highlight re-apply"),setTimeout(()=>{try{const q=$o.current;if(console.log("üü† Re-applying orange highlight to saved selection:",{selectionKeys:q?Object.keys(q):[],selectionSize:q?Object.keys(q).length:0}),q&&Object.keys(q).length>0){const G=i.current;G?(G.highlight({customId:"ghost-selected",color:new Ae(16750592),renderedFaces:1,opacity:1,transparent:!1},q),G.core.update(!0),console.log("‚úÖ Orange highlight applied successfully")):console.warn("‚ö†Ô∏è Fragments not available for re-apply")}else console.warn("‚ö†Ô∏è No saved selection to re-apply")}catch(q){console.warn("Failed to re-apply ghost highlight:",q)}},50))},f=async C=>{if(Ee(null),C.button===0)if(console.log("üëÜ PointerDown:",{mode:to.current,measuring:jt.current,x:C.clientX,y:C.clientY}),to.current==="rectangle"&&!jt.current){if(console.log("üü¶ Starting rectangle selection"),Dt.current=!0,bt.current={x:C.clientX,y:C.clientY},!Te.current){const A=document.createElement("div");A.style.position="fixed",A.style.border="2px solid #1976d2",A.style.backgroundColor="rgba(25, 118, 210, 0.1)",A.style.pointerEvents="none",A.style.zIndex="10000",document.body.appendChild(A),Te.current=A}const I=Te.current;I.style.left=`${C.clientX}px`,I.style.top=`${C.clientY}px`,I.style.width="0px",I.style.height="0px",I.style.display="block"}else await u(C.clientX,C.clientY)},w=C=>{if(!Dt.current||!bt.current||!Te.current)return;const I=bt.current,A=Te.current,B=Math.min(C.clientX,I.x),L=Math.min(C.clientY,I.y),V=Math.abs(C.clientX-I.x),$=Math.abs(C.clientY-I.y);A.style.left=`${B}px`,A.style.top=`${L}px`,A.style.width=`${V}px`,A.style.height=`${$}px`},y=async C=>{if(console.log("üëÜ PointerUp:",{drawing:Dt.current,x:C.clientX,y:C.clientY}),Dt.current&&bt.current&&Te.current){console.log("üü¶ Completing rectangle selection");const I=bt.current,A=Te.current;A.style.display="none",Dt.current=!1;const B=Math.min(C.clientX,I.x),L=Math.min(C.clientY,I.y),V=Math.max(C.clientX,I.x),$=Math.max(C.clientY,I.y);await c(B,L,V,$),bt.current=null}},p=async C=>{Ee(null),!jt.current&&to.current==="click"&&await u(C.clientX,C.clientY)},E=()=>{if(jt.current){const C=fo.current;C&&typeof C.create=="function"&&(console.log("üìè Creating measurement point"),C.create())}},R=C=>{C.preventDefault();const I=Ne.current;if(!I||I.length===0){Ee(null);return}Ee({mouseX:C.clientX+2,mouseY:C.clientY-6})},F=C=>{if(jt.current&&(C.code==="Delete"||C.code==="Backspace")){const I=fo.current;I&&typeof I.delete=="function"&&(console.log("Deleting measurement under cursor"),I.delete())}};return n.addEventListener("pointerdown",f,{capture:!0}),n.addEventListener("pointermove",w),n.addEventListener("pointerup",y),n.addEventListener("click",p),n.addEventListener("dblclick",E),n.addEventListener("contextmenu",R),window.addEventListener("keydown",F),()=>{n.removeEventListener("pointerdown",f,{capture:!0}),n.removeEventListener("pointermove",w),n.removeEventListener("pointerup",y),n.removeEventListener("click",p),n.removeEventListener("dblclick",E),n.removeEventListener("contextmenu",R),window.removeEventListener("keydown",F),Te.current&&(Te.current.remove(),Te.current=null);try{const C=$e.current;C&&(r.scene.three.remove(C),C.traverse(I=>{if(I.geometry&&I.geometry.dispose?.(),I.material){const A=Array.isArray(I.material)?I.material:[I.material];for(const B of A)B?.dispose?.()}}),$e.current=null)}catch{}try{const C=Fe.current;if(C&&C.mesh&&C.mesh.instanceColor){const I=new Ae(1,1,1);C.mesh.setColorAt(C.index,I),C.mesh.instanceColor.needsUpdate=!0}Fe.current=null}catch{}}},[]);const ys=d.useCallback(()=>{a.current;const e=mt(),r=e?.controls??null,n=e?.three??null;r?r.reset(!0):n&&(n.position.set(10,10,10),n.lookAt(0,0,0))},[]),Yo=d.useCallback(e=>{uo(r=>{const n={...r,[e]:!r[e]},l=a.current;if(!l)return n;const c=l.renderer?.three,u=l.scene?.three;if(!c||!u)return n;const f=[],w=Lo.current;if(!n[e]){const y=w.get(e);y&&(u.remove(y),y.dispose(),w.delete(e))}if(n.x){const y=new Pt(new Z(1,0,0),Le.x);if(f.push(y),!w.has("x")){const p=new rr(y,10,16711680);u.add(p),w.set("x",p)}}if(n.y){const y=new Pt(new Z(0,1,0),Le.y);if(f.push(y),!w.has("y")){const p=new rr(y,10,65280);u.add(p),w.set("y",p)}}if(n.z){const y=new Pt(new Z(0,0,1),Le.z);if(f.push(y),!w.has("z")){const p=new rr(y,10,255);u.add(p),w.set("z",p)}}return c.clippingPlanes=f,c.localClippingEnabled=f.length>0,Oo.current=f,n})},[Le]),Xo=d.useCallback((e,r)=>{Rr(n=>{const l={...n,[e]:r};return requestAnimationFrame(()=>{const u=a.current;if(!u)return;const f=u.renderer?.three;if(!f)return;const w=[],y=Lo.current;if(ne.x){const p=new Pt(new Z(1,0,0),l.x);w.push(p);const E=y.get("x");E&&(E.plane.constant=l.x)}if(ne.y){const p=new Pt(new Z(0,1,0),l.y);w.push(p);const E=y.get("y");E&&(E.plane.constant=l.y)}if(ne.z){const p=new Pt(new Z(0,0,1),l.z);w.push(p);const E=y.get("z");E&&(E.plane.constant=l.z)}f.clippingPlanes=w,Oo.current=w}),l})},[ne]),bs=d.useCallback(()=>{zr(e=>{const r=!e;return uo(r?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),r})},[]),xs=d.useCallback(()=>{console.log("üéØ toggleMeasurement called"),Wn(e=>{const r=!e;jt.current=r;const n=fo.current;if(console.log("Measurement tool:",n),console.log("New state:",r),n)if(n.enabled=r,console.log("Measurement tool enabled set to:",r),console.log("Measurement tool world:",n.world),console.log("Measurement tool properties:",{enabled:n.enabled,world:!!n.world,list:n.list?.size||0}),r)console.log("üìè Measurement mode activated - DOUBLE-CLICK two points on the model to measure distance");else try{n.list&&typeof n.list.clear=="function"&&(n.list.clear(),console.log("All measurements cleared")),Dr(null)}catch(l){console.warn("Failed to clear measurements:",l)}else console.warn("‚ö†Ô∏è Measurement tool not initialized!");return r})},[]),ws=d.useCallback(()=>{console.log("üëª toggleGhostMode called"),On(e=>{const r=!e,n=i.current,l=De.current,c=Vn.current;if(!n)return console.warn("‚ö†Ô∏è FragmentsManager not available for ghost mode"),e;try{if(r){const u=l?.selection?.select||{};console.log("üëª Saving selection snapshot:",{selectionKeys:Object.keys(u),selectionSize:Object.keys(u).length,selection:u}),$o.current=u;const f=[...n.core.models.materials.list.values()];for(const w of f){if(w.userData.customId)continue;let y;"color"in w?y=w.color.getHex():y=w.lodColor.getHex(),c.set(w,{color:y,transparent:w.transparent,opacity:w.opacity}),w.transparent=!0,w.opacity=.05,w.needsUpdate=!0,"color"in w?w.color.setColorName("white"):w.lodColor.setColorName("white")}Object.keys(u).length>0?(console.log("üü† Applying initial orange highlight to selection"),n.highlight({customId:"ghost-selected",color:new Ae(16750592),renderedFaces:1,opacity:1,transparent:!1},u),console.log("‚úÖ Initial orange highlight applied")):console.warn("‚ö†Ô∏è No selection to highlight in ghost mode"),n.core.update(!0),console.log("üëª Ghost mode enabled")}else{for(const[u,f]of c){const{color:w,transparent:y,opacity:p}=f;u.transparent=y,u.opacity=p,"color"in u?u.color.setHex(w):u.lodColor.setHex(w),u.needsUpdate=!0}c.clear(),$o.current=null,n.resetHighlight(),n.core.update(!0),console.log("‚úÖ Ghost mode disabled")}}catch(u){return console.warn("Failed to toggle ghost mode:",u),e}return r})},[]),Is=d.useCallback(()=>{console.log("üîí toggleIsolateMode called"),Ln(e=>{const r=!e,n=We.current,l=De.current;if(!n)return console.warn("‚ö†Ô∏è Hider not available for isolate mode"),e;try{if(r){const c=l?.selection?.select||{},u={};for(const[f,w]of Object.entries(c))w&&typeof w.size=="number"&&w.size>0&&(u[f]=w);if(Object.keys(u).length>0)n.isolate(u),console.log("üîí Isolate mode enabled - showing only selected objects");else return console.warn("‚ö†Ô∏è No selection to isolate"),e}else n.set(!0),console.log("‚úÖ Isolate mode disabled - showing all objects")}catch(c){return console.warn("Failed to toggle isolate mode:",c),e}return r})},[]),Cs=d.useCallback(()=>{uo({x:!1,y:!1,z:!1}),Rr({x:0,y:0,z:0}),zr(!1);const e=a.current;if(e){const r=e.renderer?.three,n=e.scene?.three;if(r&&(r.clippingPlanes=[],r.localClippingEnabled=!1),n){const l=Lo.current;l.forEach(c=>{n.remove(c),c.dispose()}),l.clear()}}Oo.current=[]},[]),gt=d.useCallback(e=>{console.log("setCameraView called with view:",e);const r=a.current,n=i.current,l=h.current,c=mt(),u=c?.three;if(console.log("Debug:",{hasWorld:!!r,hasFragments:!!n,id:l,hasCamera:!!c,hasThreeCamera:!!u}),!u||!r||!n||!l){console.log("Early return: missing dependencies");return}const f=n.list.get(l);if(console.log("Model record:",f),!f){console.log("Early return: no record found for id:",l);return}const w=new it().setFromObject(f.object);if(console.log("Bounding box:",w,"isEmpty:",w.isEmpty()),w.isEmpty()){console.log("Early return: bounding box is empty");return}const y=new Z,p=new Z;w.getCenter(y),w.getSize(p);const R=Math.max(p.x,p.y,p.z)*2||20;let F;switch(e){case"top":F=new Z(y.x,y.y,y.z+R);break;case"bottom":F=new Z(y.x,y.y,y.z-R);break;case"front":F=new Z(y.x,y.y+R,y.z);break;case"back":F=new Z(y.x,y.y-R,y.z);break;case"left":F=new Z(y.x-R,y.y,y.z);break;case"right":F=new Z(y.x+R,y.y,y.z);break;case"iso":F=new Z(y.x+R*.7,y.y+R*.7,y.z+R*.7);break;default:return}const C=c?.controls;C&&typeof C.setLookAt=="function"?(C.setLookAt(F.x,F.y,F.z,y.x,y.y,y.z,!0),console.log("Camera moved to:",e,"position:",F,"looking at:",y)):(u.position.copy(F),u.lookAt(y),u.updateProjectionMatrix(),console.log("Camera moved (fallback) to:",e))},[]);return o.jsxs("div",{style:{width:"100%",height:"100%"},children:[o.jsx(Ps,{position:"static",children:o.jsxs(As,{children:[o.jsx(W,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[o.jsx(W,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:o.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),o.jsx(U,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),o.jsx(te,{title:"Settings",children:o.jsx(ee,{color:"inherit",onClick:Hr,sx:{mr:1},children:o.jsx(Ms,{})})}),o.jsx(te,{title:"About",children:o.jsx(ee,{color:"inherit",onClick:Jn,sx:{mr:1},children:o.jsx(Rs,{})})}),o.jsx(ie,{color:"inherit",onClick:Kr,startIcon:o.jsx(Xr,{}),"aria-pressed":Q,sx:{mr:1,borderRadius:1.5,backgroundColor:Q?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Q?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Q?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),o.jsx(ie,{color:"inherit",onClick:Wr,startIcon:o.jsx(Jr,{}),"aria-pressed":Ze,sx:{mr:1,borderRadius:1.5,backgroundColor:Ze?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Ze?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Ze?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),o.jsx(ie,{color:"inherit",onClick:qr,startIcon:o.jsx(Zr,{}),"aria-pressed":Qe,sx:{mr:1,borderRadius:1.5,backgroundColor:Qe?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Qe?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Qe?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),o.jsx(ie,{color:"inherit",onClick:Gr,startIcon:o.jsx(Qr,{}),"aria-pressed":et,sx:{mr:1,borderRadius:1.5,backgroundColor:et?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:et?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:et?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),o.jsx("div",{ref:t,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:Ce!==null&&o.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:o.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[o.jsx(U,{variant:"subtitle1",sx:{mb:1},children:"Converting IFC‚Ä¶"}),o.jsx(zs,{variant:"determinate",value:Math.max(0,Math.min(100,Ce)),sx:{height:10,borderRadius:1}}),o.jsxs(U,{variant:"caption",sx:{mt:1,display:"block"},children:[Ce.toFixed(1),"%"]}),o.jsx("div",{style:{marginTop:12},children:o.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:ls,disabled:zt,children:zt?"Cancelling‚Ä¶":"Cancel"})})]})})}),Q&&o.jsx(en,{nodeRef:ko,handle:".explorer-header",bounds:"parent",children:o.jsxs(je,{ref:ko,elevation:8,sx:{position:"fixed",top:120,right:30,width:oo.width,height:re?"auto":oo.height,minWidth:280,minHeight:re?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[o.jsxs(W,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[o.jsx(U,{variant:"subtitle1",children:"Model Explorer"}),o.jsxs(W,{children:[o.jsx(ee,{size:"small",color:"inherit",onClick:as,title:re?"Expand panel":"Minimize panel",children:re?o.jsx($s,{}):o.jsx(tn,{})}),o.jsx(ee,{size:"small",color:"inherit",onClick:is,title:"Close Model Explorer",children:o.jsx(on,{})})]})]}),!re&&o.jsxs(W,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[o.jsx(ie,{variant:"contained",size:"small",onClick:()=>s.current?.click(),disabled:!be,children:"Open IFC / FRAG"}),o.jsx(te,{title:"Open parametric filter",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",onClick:()=>ze(!0),disabled:!be,startIcon:o.jsx(Ds,{}),children:"Filter"})})}),!1,o.jsx(U,{variant:"caption",color:"text.secondary"}),o.jsx("input",{ref:s,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:ss})]}),o.jsxs(rn,{value:ft,onChange:(e,r)=>Dn(r),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[o.jsx(Ut,{value:"models",label:"Models"}),o.jsx(Ut,{value:"properties",label:"Properties"}),o.jsx(Ut,{value:"tree",label:"Model Tree"})]}),o.jsx(W,{role:"tabpanel",hidden:ft!=="models",sx:{display:ft==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:o.jsx(W,{ref:dr,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!be&&o.jsx(U,{variant:"body2",color:"text.secondary",children:"Initializing components‚Ä¶"})})}),o.jsx(W,{role:"tabpanel",hidden:ft!=="properties",sx:{display:ft==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsxs(rn,{value:ut,onChange:(e,r)=>gr(r),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[o.jsx(Ut,{value:"favorites",label:`Favourites (${_o.length})`}),o.jsx(Ut,{value:"all",label:`All (${ae.length})`})]}),o.jsxs(W,{role:"tabpanel",hidden:ut!=="favorites",sx:{display:ut==="favorites"?"flex":"none",flexDirection:"column",flex:ut==="favorites"?1:0,minHeight:0},children:[_o.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:_o.map(Wo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:Se.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Go>0&&Se.length>0&&o.jsx(Et,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Go===1?"1 favourite property is not available for this selection.":`${Go} favourite properties are not available for this selection.`})]}),o.jsxs(W,{role:"tabpanel",hidden:ut!=="all",sx:{display:ut==="all"?"flex":"none",flexDirection:"column",flex:ut==="all"?1:0,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[o.jsx(Ht,{size:"small",fullWidth:!0,value:pr,onChange:e=>An(e.target.value),placeholder:"Search properties‚Ä¶",disabled:!ae.length}),o.jsx(te,{title:"Copy raw element JSON",children:o.jsx("span",{children:o.jsx(ee,{size:"small",onClick:qn,disabled:!K,color:"primary",children:o.jsx(Fs,{fontSize:"small"})})})}),o.jsx(te,{title:"Export properties",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",startIcon:o.jsx(Ts,{}),onClick:Hn,disabled:!ae.length&&!j.length,children:"Export"})})})]}),ae.length?Un?Tr.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Tr.map(Wo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:`No properties matched "${po}".`})}):o.jsxs(W,{sx:{position:"relative",flex:1,minHeight:200},children:[o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Bo.map(Wo)}),Nr>0&&o.jsx(Et,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${Bo.length} properties. ${Nr} more not shown.`})]}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / ‚Ä¶ breakdown."})})]})]})}),o.jsx(W,{role:"tabpanel",hidden:ft!=="tree",sx:{display:ft==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsx(Ht,{size:"small",fullWidth:!0,value:wt,onChange:e=>Mn(e.target.value),placeholder:"Search the model tree‚Ä¶",disabled:!j.length,sx:{flexShrink:0}}),o.jsxs(W,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[o.jsx(W,{ref:no,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!be||!j.length)&&o.jsx(W,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:be?"Load a model to populate the full model tree.":"Viewer is initializing the model tree‚Ä¶"})})]})]})})]}),o.jsx(W,{onPointerDown:us,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:Q?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Kr,title:Q?"Close Model Explorer":"Open Model Explorer",sx:{color:Q?"white":"inherit"},children:o.jsx(Xr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:Ze?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Wr,title:Ze?"Close AI Assistant":"Open AI Assistant",sx:{color:Ze?"white":"inherit"},children:o.jsx(Jr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Qe?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:qr,title:Qe?"Close IDS Checker":"Open IDS Checker",sx:{color:Qe?"white":"inherit"},children:o.jsx(Zr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:et?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Gr,title:et?"Close IDS Creator":"Open IDS Creator",sx:{color:et?"white":"inherit"},children:o.jsx(Qr,{})})}),St?o.jsx(en,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:o.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[o.jsxs(W,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[o.jsx(U,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(ee,{size:"small",onClick:()=>No(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:o.jsx(tn,{fontSize:"small"})}),o.jsx(ee,{size:"small",onClick:()=>No(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:o.jsx(on,{fontSize:"small"})})]})]}),o.jsxs(W,{sx:{p:1.5},children:[o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:ps,disabled:!m,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(nn,{fontSize:"small"})})}),o.jsx(te,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:ys,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:o.jsx(Ns,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),o.jsxs(W,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[o.jsx(te,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),o.jsx(te,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),o.jsx(te,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),o.jsx(te,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),o.jsx(te,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),o.jsx(te,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>gt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),o.jsx(te,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:o.jsxs(ie,{size:"small",onClick:()=>gt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[o.jsx(Os,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),o.jsx(te,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),o.jsx(te,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Le.x.toFixed(1)]}),o.jsx(Jo,{value:Le.x,onChange:(e,r)=>Xo("x",r),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Le.y.toFixed(1)]}),o.jsx(Jo,{value:Le.y,onChange:(e,r)=>Xo("y",r),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Le.z.toFixed(1)]}),o.jsx(Jo,{value:Le.z,onChange:(e,r)=>Xo("z",r),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:bs,sx:{border:"2px solid",borderColor:Lt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Lt?"warning.main":"white",color:Lt?"white":"warning.dark","&:hover":{backgroundColor:Lt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:o.jsx(Ls,{fontSize:"small"})})}),o.jsx(te,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:Cs,disabled:!ne.x&&!ne.y&&!ne.z&&!Lt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(Vs,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[o.jsx(te,{title:Vt?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:xs,sx:{border:"2px solid",borderColor:Vt?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Vt?"success.main":"white",color:Vt?"white":"success.dark","&:hover":{backgroundColor:Vt?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx(Bs,{fontSize:"small"})})}),$r&&o.jsxs(U,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[$r," units"]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Sr("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:o.jsx(_s,{fontSize:"small"})})}),o.jsx(te,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Sr("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:o.jsx(Gs,{fontSize:"small"})})}),o.jsx(te,{title:He?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:ws,sx:{border:"2px solid",borderColor:He?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:He?"warning.main":"white",color:He?"white":"warning.dark","&:hover":{backgroundColor:He?"warning.dark":"warning.light",borderColor:"warning.main",color:He?"white":"warning.dark"}},children:o.jsx(sn,{fontSize:"small"})})}),o.jsx(te,{title:Ct?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:Is,sx:{border:"2px solid",borderColor:Ct?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ct?"info.main":"white",color:Ct?"white":"info.dark","&:hover":{backgroundColor:Ct?"info.dark":"info.light",borderColor:"info.main",color:Ct?"white":"info.dark"}},children:o.jsx(ln,{fontSize:"small"})})})]}),xe==="rectangle"&&o.jsx(Et,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]})]})," "]})}):null,o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:St?"primary.main":"background.paper","&:hover":{bgcolor:St?"primary.dark":"action.hover"}},children:o.jsx(ee,{onClick:()=>No(!St),title:St?"Close View Controls":"Open View Controls",sx:{color:St?"white":"action.active"},children:o.jsx(nn,{})})}),o.jsx(d.Suspense,{fallback:null,children:H&&o.jsx(ql,{open:H,onClose:()=>ze(!1),viewerApi:xt.current??null})}),o.jsxs(Zo,{open:Nn,onClose:ho,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Qo,{children:"Settings"}),o.jsx(er,{dividers:!0,children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[o.jsxs(an,{component:"fieldset",children:[o.jsx(cn,{component:"legend",sx:{mb:1},children:"AI Provider"}),o.jsxs(dn,{value:he,onChange:e=>Qn(e.target.value),children:[o.jsx(qt,{value:"gemini",control:o.jsx(Kt,{}),label:"Google Gemini"}),o.jsx(qt,{value:"openai",control:o.jsx(Kt,{}),label:"OpenAI (ChatGPT)"}),o.jsx(qt,{value:"disabled",control:o.jsx(Kt,{}),label:"Disabled (No AI)"})]})]}),he!=="disabled"&&o.jsxs(o.Fragment,{children:[o.jsx(Ht,{label:"API Key",type:zo?"text":"password",value:Ue,onChange:e=>Ro(e.target.value),fullWidth:!0,placeholder:`Enter your ${he==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:o.jsx(ee,{onClick:()=>xr(!zo),edge:"end",size:"small",children:zo?o.jsx(sn,{}):o.jsx(ln,{})})},helperText:he==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),o.jsx(Ht,{select:!0,label:"Model",value:Nt,onChange:e=>io(e.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:xl(he).map(e=>o.jsx("option",{value:e,children:e},e))}),o.jsxs(W,{sx:{display:"flex",gap:1,alignItems:"center"},children:[o.jsx(ie,{variant:"outlined",onClick:es,disabled:!Ue||wr,size:"small",children:wr?"Testing...":"Test Connection"}),Cr==="success"&&o.jsx(U,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úì Connection successful"}),Cr==="error"&&o.jsx(U,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úó Connection failed"})]}),o.jsx(Et,{severity:"info",variant:"outlined",children:o.jsxs(U,{variant:"body2",children:[o.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",he==="gemini"?"Google":"OpenAI","."]})})]})]})}),o.jsxs(tr,{children:[o.jsx(ie,{onClick:ho,children:"Cancel"}),o.jsx(ie,{onClick:Zn,variant:"contained",color:"primary",disabled:he!=="disabled"&&!Ue,children:"Save"})]})]}),o.jsxs(Zo,{open:Tn,onClose:Ur,fullWidth:!0,maxWidth:"md",children:[o.jsx(Qo,{children:"About Savora Viewer"}),o.jsxs(er,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[o.jsx(U,{variant:"h6",gutterBottom:!0,children:"Version 0.2.1 Preview"}),o.jsxs(U,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",o.jsx("br",{}),"For bug reporting and more information, visit our ",o.jsx(Ws,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",o.jsx("br",{}),o.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),o.jsx(U,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Multiple format support (IFC, Fragments)",o.jsx("br",{}),"‚Ä¢ Pan, zoom, rotate navigation",o.jsx("br",{}),"‚Ä¢ Selection via point-and-click or rectangular region",o.jsx("br",{}),"‚Ä¢ Orthogonal projection for accurate measurements",o.jsx("br",{}),"‚Ä¢ View management (zoom to fit, home, cube orientation)",o.jsx("br",{}),"‚Ä¢ Toggle performance stats",o.jsx("br",{}),"‚Ä¢ Object measurement tools",o.jsx("br",{}),"‚Ä¢ Clipping planes for sectional views"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Spatial and classification hierarchy navigation",o.jsx("br",{}),"‚Ä¢ Tree-based model structure view",o.jsx("br",{}),"‚Ä¢ Properties panel with expand/collapse",o.jsx("br",{}),"‚Ä¢ Search and filter functionality",o.jsx("br",{}),"‚Ä¢ Property export (CSV, JSON)",o.jsx("br",{}),"‚Ä¢ Favorites system for quick access",o.jsx("br",{}),"‚Ä¢ Parametric filtering with Ghost/Isolate modes"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Validate models against Information Delivery Specification (IDS)",o.jsx("br",{}),"‚Ä¢ Load IDS files from local storage",o.jsx("br",{}),"‚Ä¢ Visual feedback: green (pass) and red (fail) indicators",o.jsx("br",{}),"‚Ä¢ Filter models by validation results",o.jsx("br",{}),"‚Ä¢ Export validation reports"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Visual authoring tool for IDS specifications",o.jsx("br",{}),"‚Ä¢ Capture and define validation rules",o.jsx("br",{}),"‚Ä¢ Property picker for easy specification setup",o.jsx("br",{}),"‚Ä¢ Save and load IDS files",o.jsx("br",{}),"‚Ä¢ Integration with IDS Checker for immediate validation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Natural language queries about model contents",o.jsx("br",{}),"‚Ä¢ Intelligent model analysis and insights",o.jsx("br",{}),"‚Ä¢ Context-aware responses based on selected elements",o.jsx("br",{}),"‚Ä¢ Interactive chat interface",o.jsx("br",{}),"‚Ä¢ Selection and filtering via conversation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Floating toolbar for model operations",o.jsx("br",{}),"‚Ä¢ Tooltips and keyboard shortcuts",o.jsx("br",{}),"‚Ä¢ Collapsible side panels",o.jsx("br",{}),"‚Ä¢ Responsive layout",o.jsx("br",{}),"‚Ä¢ Dark theme optimized for long viewing sessions"]})]}),o.jsx(tr,{children:o.jsx(ie,{onClick:Ur,color:"primary",children:"Close"})})]}),o.jsxs(Zo,{open:Gn,onClose:_r,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Qo,{children:"Export properties"}),o.jsxs(er,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[o.jsxs(an,{component:"fieldset",variant:"standard",children:[o.jsx(cn,{component:"legend",children:"Scope"}),o.jsxs(dn,{value:tt,onChange:e=>Pr(e.target.value),children:[o.jsx(qt,{value:"selected",control:o.jsx(Kt,{}),label:"Selected items",disabled:!ae.length}),o.jsx(qt,{value:"model",control:o.jsx(Kt,{}),label:"Specific model",disabled:!j.length})]})]}),o.jsx(Us,{in:tt==="model",unmountOnExit:!0,children:o.jsx(Ht,{select:!0,fullWidth:!0,label:"Model",value:ot,onChange:e=>ao(e.target.value),disabled:!j.length,children:j.map(e=>o.jsx(or,{value:e.id,children:e.label},e.id))})}),tt==="selected"&&!ae.length&&o.jsx(Et,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Mr&&o.jsx(Et,{severity:"error",variant:"outlined",children:Mr})]}),o.jsxs(tr,{children:[o.jsx(ie,{onClick:_r,disabled:pt,children:"Cancel"}),o.jsx(ie,{variant:"contained",onClick:Kn,disabled:pt||tt==="selected"&&!ae.length||tt==="model"&&!ot,children:pt?"Exporting‚Ä¶":"Export CSV"})]})]}),o.jsxs(d.Suspense,{fallback:null,children:[o.jsx(Ul,{isOpen:Qe,onOpen:os,onClose:rs,viewerApi:qo,hasModel:j.length>0,expandSignal:Bn}),o.jsx(Hl,{isOpen:et,onClose:()=>jr(!1),viewerApi:qo,selectedItemData:K,onValidate:ns}),o.jsx(Wl,{getModelDataForAI:fs,isOpen:Ze,onOpen:Yn,onClose:Xn,expandSignal:Fn,onRequestSelection:ds,onOpenSettings:Hr})]}),o.jsxs(Hs,{open:!!so,onClose:hs,anchorReference:"anchorPosition",anchorPosition:so?{top:so.mouseY,left:so.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[o.jsx(or,{onClick:ms,disabled:v.length===0,children:"Hide selected element"}),o.jsx(or,{onClick:gs,children:"Reset hidden elements"})]})]})};function jo(t,s=2e3){try{if(t==null)return"null";const a=typeof t=="string"?t:JSON.stringify(t,null,2);return a?a.length<=s?a:`${a.slice(0,s)}
... [truncated ${a.length-s} chars]`:""}catch{return String(t)}}qs.createRoot(document.getElementById("root")).render(o.jsx(Rt.StrictMode,{children:o.jsx(li,{})}));export{Cl as a,Vl as b,mi as g,nr as i,yl as l,pi as p,wl as s,_l as u};
