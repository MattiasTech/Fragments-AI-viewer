(function(){"use strict";const L=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",x=L+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",Z="["+L+"]["+x+"]*",H=new RegExp("^"+Z+"$");function $(e,t){const s=[];let r=t.exec(e);for(;r;){const i=[];i.startIndex=t.lastIndex-r[0].length;const n=r.length;for(let o=0;o<n;o++)i.push(r[o]);s.push(i),r=t.exec(e)}return s}const O=function(e){const t=H.exec(e);return!(t===null||typeof t>"u")};function K(e){return typeof e<"u"}const W={allowBooleanAttributes:!1,unpairedTags:[]};function Q(e,t){t=Object.assign({},W,t);const s=[];let r=!1,i=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let n=0;n<e.length;n++)if(e[n]==="<"&&e[n+1]==="?"){if(n+=2,n=U(e,n),n.err)return n}else if(e[n]==="<"){let o=n;if(n++,e[n]==="!"){n=B(e,n);continue}else{let u=!1;e[n]==="/"&&(u=!0,n++);let a="";for(;n<e.length&&e[n]!==">"&&e[n]!==" "&&e[n]!=="	"&&e[n]!==`
`&&e[n]!=="\r";n++)a+=e[n];if(a=a.trim(),a[a.length-1]==="/"&&(a=a.substring(0,a.length-1),n--),!ie(a)){let c;return a.trim().length===0?c="Invalid space after '<'.":c="Tag '"+a+"' is an invalid name.",g("InvalidTag",c,h(e,n))}const l=ee(e,n);if(l===!1)return g("InvalidAttr","Attributes for '"+a+"' have open quote.",h(e,n));let d=l.value;if(n=l.index,d[d.length-1]==="/"){const c=n-d.length;d=d.substring(0,d.length-1);const f=q(d,t);if(f===!0)r=!0;else return g(f.err.code,f.err.msg,h(e,c+f.err.line))}else if(u)if(l.tagClosed){if(d.trim().length>0)return g("InvalidTag","Closing tag '"+a+"' can't have attributes or invalid starting.",h(e,o));if(s.length===0)return g("InvalidTag","Closing tag '"+a+"' has not been opened.",h(e,o));{const c=s.pop();if(a!==c.tagName){let f=h(e,c.tagStartPos);return g("InvalidTag","Expected closing tag '"+c.tagName+"' (opened in line "+f.line+", col "+f.col+") instead of closing tag '"+a+"'.",h(e,o))}s.length==0&&(i=!0)}}else return g("InvalidTag","Closing tag '"+a+"' doesn't have proper closing.",h(e,n));else{const c=q(d,t);if(c!==!0)return g(c.err.code,c.err.msg,h(e,n-d.length+c.err.line));if(i===!0)return g("InvalidXml","Multiple possible root nodes found.",h(e,n));t.unpairedTags.indexOf(a)!==-1||s.push({tagName:a,tagStartPos:o}),r=!0}for(n++;n<e.length;n++)if(e[n]==="<")if(e[n+1]==="!"){n++,n=B(e,n);continue}else if(e[n+1]==="?"){if(n=U(e,++n),n.err)return n}else break;else if(e[n]==="&"){const c=ne(e,n);if(c==-1)return g("InvalidChar","char '&' is not expected.",h(e,n));n=c}else if(i===!0&&!j(e[n]))return g("InvalidXml","Extra text at the end",h(e,n));e[n]==="<"&&n--}}else{if(j(e[n]))continue;return g("InvalidChar","char '"+e[n]+"' is not expected.",h(e,n))}if(r){if(s.length==1)return g("InvalidTag","Unclosed tag '"+s[0].tagName+"'.",h(e,s[0].tagStartPos));if(s.length>0)return g("InvalidXml","Invalid '"+JSON.stringify(s.map(n=>n.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return g("InvalidXml","Start tag expected.",1);return!0}function j(e){return e===" "||e==="	"||e===`
`||e==="\r"}function U(e,t){const s=t;for(;t<e.length;t++)if(e[t]=="?"||e[t]==" "){const r=e.substr(s,t-s);if(t>5&&r==="xml")return g("InvalidXml","XML declaration allowed only at the start of the document.",h(e,t));if(e[t]=="?"&&e[t+1]==">"){t++;break}else continue}return t}function B(e,t){if(e.length>t+5&&e[t+1]==="-"&&e[t+2]==="-"){for(t+=3;t<e.length;t++)if(e[t]==="-"&&e[t+1]==="-"&&e[t+2]===">"){t+=2;break}}else if(e.length>t+8&&e[t+1]==="D"&&e[t+2]==="O"&&e[t+3]==="C"&&e[t+4]==="T"&&e[t+5]==="Y"&&e[t+6]==="P"&&e[t+7]==="E"){let s=1;for(t+=8;t<e.length;t++)if(e[t]==="<")s++;else if(e[t]===">"&&(s--,s===0))break}else if(e.length>t+9&&e[t+1]==="["&&e[t+2]==="C"&&e[t+3]==="D"&&e[t+4]==="A"&&e[t+5]==="T"&&e[t+6]==="A"&&e[t+7]==="["){for(t+=8;t<e.length;t++)if(e[t]==="]"&&e[t+1]==="]"&&e[t+2]===">"){t+=2;break}}return t}const J='"',D="'";function ee(e,t){let s="",r="",i=!1;for(;t<e.length;t++){if(e[t]===J||e[t]===D)r===""?r=e[t]:r!==e[t]||(r="");else if(e[t]===">"&&r===""){i=!0;break}s+=e[t]}return r!==""?!1:{value:s,index:t,tagClosed:i}}const te=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function q(e,t){const s=$(e,te),r={};for(let i=0;i<s.length;i++){if(s[i][1].length===0)return g("InvalidAttr","Attribute '"+s[i][2]+"' has no space in starting.",v(s[i]));if(s[i][3]!==void 0&&s[i][4]===void 0)return g("InvalidAttr","Attribute '"+s[i][2]+"' is without value.",v(s[i]));if(s[i][3]===void 0&&!t.allowBooleanAttributes)return g("InvalidAttr","boolean attribute '"+s[i][2]+"' is not allowed.",v(s[i]));const n=s[i][2];if(!re(n))return g("InvalidAttr","Attribute '"+n+"' is an invalid name.",v(s[i]));if(!r.hasOwnProperty(n))r[n]=1;else return g("InvalidAttr","Attribute '"+n+"' is repeated.",v(s[i]))}return!0}function se(e,t){let s=/\d/;for(e[t]==="x"&&(t++,s=/[\da-fA-F]/);t<e.length;t++){if(e[t]===";")return t;if(!e[t].match(s))break}return-1}function ne(e,t){if(t++,e[t]===";")return-1;if(e[t]==="#")return t++,se(e,t);let s=0;for(;t<e.length;t++,s++)if(!(e[t].match(/\w/)&&s<20)){if(e[t]===";")break;return-1}return t}function g(e,t,s){return{err:{code:e,msg:t,line:s.line||s,col:s.col}}}function re(e){return O(e)}function ie(e){return O(e)}function h(e,t){const s=e.substring(0,t).split(/\r?\n/);return{line:s.length,col:s[s.length-1].length+1}}function v(e){return e.startIndex+e[1].length}const oe={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,t){return t},attributeValueProcessor:function(e,t){return t},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,t,s){return e},captureMetaData:!1},ae=function(e){return Object.assign({},oe,e)};let V;typeof Symbol!="function"?V="@@xmlMetadata":V=Symbol("XML Node Metadata");class N{constructor(t){this.tagname=t,this.child=[],this[":@"]={}}add(t,s){t==="__proto__"&&(t="#__proto__"),this.child.push({[t]:s})}addChild(t,s){t.tagname==="__proto__"&&(t.tagname="#__proto__"),t[":@"]&&Object.keys(t[":@"]).length>0?this.child.push({[t.tagname]:t.child,":@":t[":@"]}):this.child.push({[t.tagname]:t.child}),s!==void 0&&(this.child[this.child.length-1][V]={startIndex:s})}static getMetaDataSymbol(){return V}}class le{constructor(t){this.suppressValidationErr=!t}readDocType(t,s){const r={};if(t[s+3]==="O"&&t[s+4]==="C"&&t[s+5]==="T"&&t[s+6]==="Y"&&t[s+7]==="P"&&t[s+8]==="E"){s=s+9;let i=1,n=!1,o=!1,u="";for(;s<t.length;s++)if(t[s]==="<"&&!o){if(n&&m(t,"!ENTITY",s)){s+=7;let a,l;[a,l,s]=this.readEntityExp(t,s+1,this.suppressValidationErr),l.indexOf("&")===-1&&(r[a]={regx:RegExp(`&${a};`,"g"),val:l})}else if(n&&m(t,"!ELEMENT",s)){s+=8;const{index:a}=this.readElementExp(t,s+1);s=a}else if(n&&m(t,"!ATTLIST",s))s+=8;else if(n&&m(t,"!NOTATION",s)){s+=9;const{index:a}=this.readNotationExp(t,s+1,this.suppressValidationErr);s=a}else if(m(t,"!--",s))o=!0;else throw new Error("Invalid DOCTYPE");i++,u=""}else if(t[s]===">"){if(o?t[s-1]==="-"&&t[s-2]==="-"&&(o=!1,i--):i--,i===0)break}else t[s]==="["?n=!0:u+=t[s];if(i!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:s}}readEntityExp(t,s){s=b(t,s);let r="";for(;s<t.length&&!/\s/.test(t[s])&&t[s]!=='"'&&t[s]!=="'";)r+=t[s],s++;if(S(r),s=b(t,s),!this.suppressValidationErr){if(t.substring(s,s+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(t[s]==="%")throw new Error("Parameter entities are not supported")}let i="";return[s,i]=this.readIdentifierVal(t,s,"entity"),s--,[r,i,s]}readNotationExp(t,s){s=b(t,s);let r="";for(;s<t.length&&!/\s/.test(t[s]);)r+=t[s],s++;!this.suppressValidationErr&&S(r),s=b(t,s);const i=t.substring(s,s+6).toUpperCase();if(!this.suppressValidationErr&&i!=="SYSTEM"&&i!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${i}"`);s+=i.length,s=b(t,s);let n=null,o=null;if(i==="PUBLIC")[s,n]=this.readIdentifierVal(t,s,"publicIdentifier"),s=b(t,s),(t[s]==='"'||t[s]==="'")&&([s,o]=this.readIdentifierVal(t,s,"systemIdentifier"));else if(i==="SYSTEM"&&([s,o]=this.readIdentifierVal(t,s,"systemIdentifier"),!this.suppressValidationErr&&!o))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:n,systemIdentifier:o,index:--s}}readIdentifierVal(t,s,r){let i="";const n=t[s];if(n!=='"'&&n!=="'")throw new Error(`Expected quoted string, found "${n}"`);for(s++;s<t.length&&t[s]!==n;)i+=t[s],s++;if(t[s]!==n)throw new Error(`Unterminated ${r} value`);return s++,[s,i]}readElementExp(t,s){s=b(t,s);let r="";for(;s<t.length&&!/\s/.test(t[s]);)r+=t[s],s++;if(!this.suppressValidationErr&&!O(r))throw new Error(`Invalid element name: "${r}"`);s=b(t,s);let i="";if(t[s]==="E"&&m(t,"MPTY",s))s+=4;else if(t[s]==="A"&&m(t,"NY",s))s+=2;else if(t[s]==="("){for(s++;s<t.length&&t[s]!==")";)i+=t[s],s++;if(t[s]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${t[s]}"`);return{elementName:r,contentModel:i.trim(),index:s}}readAttlistExp(t,s){s=b(t,s);let r="";for(;s<t.length&&!/\s/.test(t[s]);)r+=t[s],s++;S(r),s=b(t,s);let i="";for(;s<t.length&&!/\s/.test(t[s]);)i+=t[s],s++;if(!S(i))throw new Error(`Invalid attribute name: "${i}"`);s=b(t,s);let n="";if(t.substring(s,s+8).toUpperCase()==="NOTATION"){if(n="NOTATION",s+=8,s=b(t,s),t[s]!=="(")throw new Error(`Expected '(', found "${t[s]}"`);s++;let u=[];for(;s<t.length&&t[s]!==")";){let a="";for(;s<t.length&&t[s]!=="|"&&t[s]!==")";)a+=t[s],s++;if(a=a.trim(),!S(a))throw new Error(`Invalid notation name: "${a}"`);u.push(a),t[s]==="|"&&(s++,s=b(t,s))}if(t[s]!==")")throw new Error("Unterminated list of notations");s++,n+=" ("+u.join("|")+")"}else{for(;s<t.length&&!/\s/.test(t[s]);)n+=t[s],s++;const u=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!u.includes(n.toUpperCase()))throw new Error(`Invalid attribute type: "${n}"`)}s=b(t,s);let o="";return t.substring(s,s+8).toUpperCase()==="#REQUIRED"?(o="#REQUIRED",s+=8):t.substring(s,s+7).toUpperCase()==="#IMPLIED"?(o="#IMPLIED",s+=7):[s,o]=this.readIdentifierVal(t,s,"ATTLIST"),{elementName:r,attributeName:i,attributeType:n,defaultValue:o,index:s}}}const b=(e,t)=>{for(;t<e.length&&/\s/.test(e[t]);)t++;return t};function m(e,t,s){for(let r=0;r<t.length;r++)if(t[r]!==e[s+r+1])return!1;return!0}function S(e){if(O(e))return e;throw new Error(`Invalid entity name ${e}`)}const ue=/^[-+]?0x[a-fA-F0-9]+$/,fe=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ce={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function de(e,t={}){if(t=Object.assign({},ce,t),!e||typeof e!="string")return e;let s=e.trim();if(t.skipLike!==void 0&&t.skipLike.test(s))return e;if(e==="0")return 0;if(t.hex&&ue.test(s))return Ee(s,16);if(s.search(/.+[eE].+/)!==-1)return ge(e,s,t);{const r=fe.exec(s);if(r){const i=r[1]||"",n=r[2];let o=he(r[3]);const u=i?e[n.length+1]===".":e[n.length]===".";if(!t.leadingZeros&&(n.length>1||n.length===1&&!u))return e;{const a=Number(s),l=String(a);if(a===0)return a;if(l.search(/[eE]/)!==-1)return t.eNotation?a:e;if(s.indexOf(".")!==-1)return l==="0"||l===o||l===`${i}${o}`?a:e;let d=n?o:s;return n?d===l||i+d===l?a:e:d===l||d===i+l?a:e}}else return e}}const pe=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function ge(e,t,s){if(!s.eNotation)return e;const r=t.match(pe);if(r){let i=r[1]||"";const n=r[3].indexOf("e")===-1?"E":"e",o=r[2],u=i?e[o.length+1]===n:e[o.length]===n;return o.length>1&&u?e:o.length===1&&(r[3].startsWith(`.${n}`)||r[3][0]===n)?Number(t):s.leadingZeros&&!u?(t=(r[1]||"")+r[3],Number(t)):e}else return e}function he(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substring(0,e.length-1))),e}function Ee(e,t){if(parseInt)return parseInt(e,t);if(Number.parseInt)return Number.parseInt(e,t);if(window&&window.parseInt)return window.parseInt(e,t);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function be(e){return typeof e=="function"?e:Array.isArray(e)?t=>{for(const s of e)if(typeof s=="string"&&t===s||s instanceof RegExp&&s.test(t))return!0}:()=>!1}class Te{constructor(t){this.options=t,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(s,r)=>String.fromCodePoint(Number.parseInt(r,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(s,r)=>String.fromCodePoint(Number.parseInt(r,16))}},this.addExternalEntities=ye,this.parseXml=Ae,this.parseTextData=Ie,this.resolveNameSpace=we,this.buildAttributesMap=me,this.isItStopNode=Pe,this.replaceEntitiesValue=ve,this.readStopNodeData=Ve,this.saveTextToParentTag=Se,this.addChild=Ce,this.ignoreAttributesFn=be(this.options.ignoreAttributes)}}function ye(e){const t=Object.keys(e);for(let s=0;s<t.length;s++){const r=t[s];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function Ie(e,t,s,r,i,n,o){if(e!==void 0&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){o||(e=this.replaceEntitiesValue(e));const u=this.options.tagValueProcessor(t,e,s,i,n);return u==null?e:typeof u!=typeof e||u!==e?u:this.options.trimValues?R(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?R(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function we(e){if(this.options.removeNSPrefix){const t=e.split(":"),s=e.charAt(0)==="/"?"/":"";if(t[0]==="xmlns")return"";t.length===2&&(e=s+t[1])}return e}const Ne=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function me(e,t,s){if(this.options.ignoreAttributes!==!0&&typeof e=="string"){const r=$(e,Ne),i=r.length,n={};for(let o=0;o<i;o++){const u=this.resolveNameSpace(r[o][1]);if(this.ignoreAttributesFn(u,t))continue;let a=r[o][4],l=this.options.attributeNamePrefix+u;if(u.length)if(this.options.transformAttributeName&&(l=this.options.transformAttributeName(l)),l==="__proto__"&&(l="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const d=this.options.attributeValueProcessor(u,a,t);d==null?n[l]=a:typeof d!=typeof a||d!==a?n[l]=d:n[l]=R(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[l]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=n,o}return n}}const Ae=function(e){e=e.replace(/\r\n?/g,`
`);const t=new N("!xml");let s=t,r="",i="";const n=new le(this.options.processEntities);for(let o=0;o<e.length;o++)if(e[o]==="<")if(e[o+1]==="/"){const a=A(e,">",o,"Closing Tag is not closed.");let l=e.substring(o+2,a).trim();if(this.options.removeNSPrefix){const f=l.indexOf(":");f!==-1&&(l=l.substr(f+1))}this.options.transformTagName&&(l=this.options.transformTagName(l)),s&&(r=this.saveTextToParentTag(r,s,i));const d=i.substring(i.lastIndexOf(".")+1);if(l&&this.options.unpairedTags.indexOf(l)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${l}>`);let c=0;d&&this.options.unpairedTags.indexOf(d)!==-1?(c=i.lastIndexOf(".",i.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=i.lastIndexOf("."),i=i.substring(0,c),s=this.tagsNodeStack.pop(),r="",o=a}else if(e[o+1]==="?"){let a=F(e,o,!1,"?>");if(!a)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,s,i),!(this.options.ignoreDeclaration&&a.tagName==="?xml"||this.options.ignorePiTags)){const l=new N(a.tagName);l.add(this.options.textNodeName,""),a.tagName!==a.tagExp&&a.attrExpPresent&&(l[":@"]=this.buildAttributesMap(a.tagExp,i,a.tagName)),this.addChild(s,l,i,o)}o=a.closeIndex+1}else if(e.substr(o+1,3)==="!--"){const a=A(e,"-->",o+4,"Comment is not closed.");if(this.options.commentPropName){const l=e.substring(o+4,a-2);r=this.saveTextToParentTag(r,s,i),s.add(this.options.commentPropName,[{[this.options.textNodeName]:l}])}o=a}else if(e.substr(o+1,2)==="!D"){const a=n.readDocType(e,o);this.docTypeEntities=a.entities,o=a.i}else if(e.substr(o+1,2)==="!["){const a=A(e,"]]>",o,"CDATA is not closed.")-2,l=e.substring(o+9,a);r=this.saveTextToParentTag(r,s,i);let d=this.parseTextData(l,s.tagname,i,!0,!1,!0,!0);d==null&&(d=""),this.options.cdataPropName?s.add(this.options.cdataPropName,[{[this.options.textNodeName]:l}]):s.add(this.options.textNodeName,d),o=a+2}else{let a=F(e,o,this.options.removeNSPrefix),l=a.tagName;const d=a.rawTagName;let c=a.tagExp,f=a.attrExpPresent,w=a.closeIndex;this.options.transformTagName&&(l=this.options.transformTagName(l)),s&&r&&s.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,s,i,!1));const p=s;p&&this.options.unpairedTags.indexOf(p.tagname)!==-1&&(s=this.tagsNodeStack.pop(),i=i.substring(0,i.lastIndexOf("."))),l!==t.tagname&&(i+=i?"."+l:l);const E=o;if(this.isItStopNode(this.options.stopNodes,i,l)){let T="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),c=l):c=c.substr(0,c.length-1),o=a.closeIndex;else if(this.options.unpairedTags.indexOf(l)!==-1)o=a.closeIndex;else{const k=this.readStopNodeData(e,d,w+1);if(!k)throw new Error(`Unexpected end of ${d}`);o=k.i,T=k.tagContent}const C=new N(l);l!==c&&f&&(C[":@"]=this.buildAttributesMap(c,i,l)),T&&(T=this.parseTextData(T,l,i,!0,f,!0,!0)),i=i.substr(0,i.lastIndexOf(".")),C.add(this.options.textNodeName,T),this.addChild(s,C,i,E)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),c=l):c=c.substr(0,c.length-1),this.options.transformTagName&&(l=this.options.transformTagName(l));const T=new N(l);l!==c&&f&&(T[":@"]=this.buildAttributesMap(c,i,l)),this.addChild(s,T,i,E),i=i.substr(0,i.lastIndexOf("."))}else{const T=new N(l);this.tagsNodeStack.push(s),l!==c&&f&&(T[":@"]=this.buildAttributesMap(c,i,l)),this.addChild(s,T,i,E),s=T}r="",o=w}}else r+=e[o];return t.child};function Ce(e,t,s,r){this.options.captureMetaData||(r=void 0);const i=this.options.updateTag(t.tagname,s,t[":@"]);i===!1||(typeof i=="string"&&(t.tagname=i),e.addChild(t,r))}const ve=function(e){if(this.options.processEntities){for(let t in this.docTypeEntities){const s=this.docTypeEntities[t];e=e.replace(s.regx,s.val)}for(let t in this.lastEntities){const s=this.lastEntities[t];e=e.replace(s.regex,s.val)}if(this.options.htmlEntities)for(let t in this.htmlEntities){const s=this.htmlEntities[t];e=e.replace(s.regex,s.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Se(e,t,s,r){return e&&(r===void 0&&(r=t.child.length===0),e=this.parseTextData(e,t.tagname,s,!1,t[":@"]?Object.keys(t[":@"]).length!==0:!1,r),e!==void 0&&e!==""&&t.add(this.options.textNodeName,e),e=""),e}function Pe(e,t,s){const r="*."+s;for(const i in e){const n=e[i];if(r===n||t===n)return!0}return!1}function Oe(e,t,s=">"){let r,i="";for(let n=t;n<e.length;n++){let o=e[n];if(r)o===r&&(r="");else if(o==='"'||o==="'")r=o;else if(o===s[0])if(s[1]){if(e[n+1]===s[1])return{data:i,index:n}}else return{data:i,index:n};else o==="	"&&(o=" ");i+=o}}function A(e,t,s,r){const i=e.indexOf(t,s);if(i===-1)throw new Error(r);return i+t.length-1}function F(e,t,s,r=">"){const i=Oe(e,t+1,r);if(!i)return;let n=i.data;const o=i.index,u=n.search(/\s/);let a=n,l=!0;u!==-1&&(a=n.substring(0,u),n=n.substring(u+1).trimStart());const d=a;if(s){const c=a.indexOf(":");c!==-1&&(a=a.substr(c+1),l=a!==i.data.substr(c+1))}return{tagName:a,tagExp:n,closeIndex:o,attrExpPresent:l,rawTagName:d}}function Ve(e,t,s){const r=s;let i=1;for(;s<e.length;s++)if(e[s]==="<")if(e[s+1]==="/"){const n=A(e,">",s,`${t} is not closed`);if(e.substring(s+2,n).trim()===t&&(i--,i===0))return{tagContent:e.substring(r,s),i:n};s=n}else if(e[s+1]==="?")s=A(e,"?>",s+1,"StopNode is not closed.");else if(e.substr(s+1,3)==="!--")s=A(e,"-->",s+3,"StopNode is not closed.");else if(e.substr(s+1,2)==="![")s=A(e,"]]>",s,"StopNode is not closed.")-2;else{const n=F(e,s,">");n&&((n&&n.tagName)===t&&n.tagExp[n.tagExp.length-1]!=="/"&&i++,s=n.closeIndex)}}function R(e,t,s){if(t&&typeof e=="string"){const r=e.trim();return r==="true"?!0:r==="false"?!1:de(e,s)}else return K(e)?e:""}const _=N.getMetaDataSymbol();function Me(e,t){return z(e,t)}function z(e,t,s){let r;const i={};for(let n=0;n<e.length;n++){const o=e[n],u=Fe(o);let a="";if(s===void 0?a=u:a=s+"."+u,u===t.textNodeName)r===void 0?r=o[u]:r+=""+o[u];else{if(u===void 0)continue;if(o[u]){let l=z(o[u],t,a);const d=_e(l,t);o[_]!==void 0&&(l[_]=o[_]),o[":@"]?Re(l,o[":@"],a,t):Object.keys(l).length===1&&l[t.textNodeName]!==void 0&&!t.alwaysCreateTextNode?l=l[t.textNodeName]:Object.keys(l).length===0&&(t.alwaysCreateTextNode?l[t.textNodeName]="":l=""),i[u]!==void 0&&i.hasOwnProperty(u)?(Array.isArray(i[u])||(i[u]=[i[u]]),i[u].push(l)):t.isArray(u,a,d)?i[u]=[l]:i[u]=l}}}return typeof r=="string"?r.length>0&&(i[t.textNodeName]=r):r!==void 0&&(i[t.textNodeName]=r),i}function Fe(e){const t=Object.keys(e);for(let s=0;s<t.length;s++){const r=t[s];if(r!==":@")return r}}function Re(e,t,s,r){if(t){const i=Object.keys(t),n=i.length;for(let o=0;o<n;o++){const u=i[o];r.isArray(u,s+"."+u,!0,!0)?e[u]=[t[u]]:e[u]=t[u]}}}function _e(e,t){const{textNodeName:s}=t,r=Object.keys(e).length;return!!(r===0||r===1&&(e[s]||typeof e[s]=="boolean"||e[s]===0))}class G{constructor(t){this.externalEntities={},this.options=ae(t)}parse(t,s){if(typeof t!="string"&&t.toString)t=t.toString();else if(typeof t!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(s){s===!0&&(s={});const n=Q(t,s);if(n!==!0)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const r=new Te(this.options);r.addExternalEntities(this.externalEntities);const i=r.parseXml(t);return this.options.preserveOrder||i===void 0?i:Me(i,this.options)}addEntity(t,s){if(s.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(t.indexOf("&")!==-1||t.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(s==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[t]=s}static getMetaDataSymbol(){return N.getMetaDataSymbol()}}const ke=new G({ignoreAttributes:!1,allowBooleanAttributes:!0,attributeNamePrefix:"@_",removeNSPrefix:!0,trimValues:!0}),Le=/[^a-zA-Z0-9_.:-]+/g,Y=e=>e?e.trim().replace(/\s+/g,"_").replace(Le,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",$e=e=>e?e.trim():"",P=e=>Array.isArray(e)?e:e==null?[]:[e],y=e=>{if(e!=null){if(typeof e=="string")return e.trim();if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="object"){const t=[e["@_value"],e.value,e.Value,e["#text"],e.simpleValue,e.SimpleValue,e["ids:simpleValue"],e["ids:SimpleValue"],e.text,e.Text];for(const s of t)if(typeof s=="string"){const r=s.trim();if(r.length)return r}for(const s of t)if(s&&typeof s=="object"){const r=y(s);if(r)return r}for(const s of Object.values(e)){if(typeof s=="string"){const r=s.trim();if(r.length)return r}if(s&&typeof s=="object"){const r=y(s);if(r)return r}}}}},X=e=>{if(!e)return;switch(e.trim().toLowerCase()){case"required":return{min:1};case"optional":return{min:0};case"prohibited":case"forbidden":case"excluded":return{min:0,max:0};default:return}},je=(e,t)=>{const s=X(t);if(s)return s;const r=y(e)??t;if(!r)return;const i=r.split(":");if(i.length===1){const l=X(i[0]);if(l)return l}const[n,o]=i,u=Number(n),a=o===void 0||o==="*"?void 0:Number(o);if(Number.isFinite(u)&&!(a!==void 0&&!Number.isFinite(a)))return{min:u,max:a}},Ue=e=>{const t=e.trim();if(!t)return[];const s=t.match(/<ids:ids[\s\S]*?<\/ids:ids>/gi);return s&&s.length?s:[t]},Be=e=>{if(!e)return[];const t=e.ids??e.IDS??e;if(!t)return[];const s=t.specification??t.Specification??[];return P(s)},qe=e=>{const t=new Set,s=i=>{if(i==null)return;(Array.isArray(i)?i:[i]).forEach(o=>{const u=y(o);u?t.add(u):o&&typeof o=="object"&&Object.values(o).forEach(a=>{const l=y(a);l&&t.add(l)})})},r=e.allowedValues??e.AllowedValues??e["ids:allowedValues"];return r&&(s(r),[r.values,r.Values,r["ids:values"]].forEach(n=>{if(!n)return;(Array.isArray(n)?n:[n]).forEach(u=>{s(u),s(u.value??u.Value??u["ids:value"])})})),s(e.value??e.Value??e["ids:value"]),s(e.accept??e.Accept??e["ids:accept"]),Array.from(t.values()).filter(i=>i.length)},ze=e=>{if(!e||typeof e!="object")return null;const t=y(e.propertySet??e.PropertySet??e["ids:propertySet"]??e["ids:PropertySet"]),r=y(e.baseName??e.BaseName??e["ids:baseName"]??e["ids:BaseName"])??y(e.name??e.Name??e["ids:name"]??e["ids:Name"]);if(!t||!r)return null;const i=`${Y(t)}.${Y(r)}`,n=je(e.cardinality??e.Cardinality??e["ids:cardinality"],e["@_cardinality"]??e["@_Cardinality"]),o=(typeof e["@_dataType"]=="string"&&e["@_dataType"])??(typeof e["@_DataType"]=="string"&&e["@_DataType"])??(typeof e["@_datatype"]=="string"&&e["@_datatype"])??(typeof e.dataType=="string"&&e.dataType)??(typeof e.DataType=="string"&&e.DataType),u=qe(e),a=y(e.description??e.Description??e["ids:description"]);return{path:i,expected:u.length?u:void 0,cardinality:n,description:a,dataType:o?o.trim().toUpperCase():void 0}},Ge=e=>{if(!e)return"unknown";const t=e.trim().toUpperCase();return t.length?t==="IFCBOOLEAN"||t==="IFCLOGICAL"?"boolean":/(REAL|INTEGER|NUMBER|MEASURE|RATIO|COUNT|AREA|VOLUME|LENGTH|MASS|PRESSURE|POWER|TIME|FREQUENCY|TEMPERATURE|FORCE|MOMENT|THICKNESS|WIDTH|HEIGHT|DEPTH|DENSITY|ENERGY|SPEED|COEFFICIENT|FACTOR|ANGLE)/.test(t)?"numeric":/(TEXT|LABEL|IDENTIFIER|STRING|URI)/.test(t)?"string":"unknown":"unknown"},Ye=e=>{if(!e)return null;const s=e.replace(/,/g,".").match(/[-+]?[0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?/);if(!s)return null;const r=Number.parseFloat(s[0]);return Number.isFinite(r)?r:null},Xe=e=>{const t=e.trim().toLowerCase();return t?["true","t","yes","y","1","on"].includes(t)?"TRUE":["false","f","no","n","0","off"].includes(t)?"FALSE":null:null},xe=(e,t)=>{const s=Ge(t);if(s==="unknown")return{ok:!0,normalized:e};if(s==="numeric"){const r=Ye(e);return r===null?{ok:!1,reason:`Value is not numeric (expected ${t}).`}:{ok:!0,normalized:String(r)}}if(s==="boolean"){const r=Xe(e);return r?{ok:!0,normalized:r}:{ok:!1,reason:`Value is not a valid boolean (expected ${t}).`}}if(s==="string"){const r=e.trim();return r.length?{ok:!0,normalized:r}:{ok:!1,reason:`Value is empty (expected ${t}).`}}return{ok:!0,normalized:e}},Ze=e=>{const t=[];if(e.expected&&e.expected.length&&t.push(`Values: ${e.expected.join(", ")}`),e.dataType&&t.push(`Type: ${e.dataType}`),e.cardinality){const s=e.cardinality.max===void 0?"*":e.cardinality.max;t.push(`Cardinality: ${e.cardinality.min}:${s}`)}return t.length?t.join(" | "):void 0},He=(e,t)=>{const s=y(e["@_id"]??e["@_identifier"])??`spec-${t+1}`,r=y(e["@_name"]??e.name??e.Name)??s,i=e.applicability??e.Applicability??e["ids:applicability"]??e["ids:Applicability"],o=P(i?.entity??i?.Entity??i?.["ids:entity"]??i?.["ids:Entity"]).map(f=>{const w=y(f["@_name"]??f.name??f.Name??f["ids:name"]??f["ids:Name"]);return $e(w??y(f))}).filter(f=>f.length),a=[e.requirement,e.Requirement,e["ids:requirement"],e.requirements,e.Requirements,e["ids:requirements"]].flatMap(f=>P(f).filter(Boolean)),l=[],d=f=>{if(!f||typeof f!="object")return[];const p=[f.property,f.Property,f["ids:property"],f.properties,f.Properties,f["ids:properties"]].flatMap(E=>P(E).filter(Boolean));return p.length?p:f.propertySet||f.PropertySet||f["ids:propertySet"]?[f]:[]},c=f=>{if(!f||typeof f!="object")return;d(f).forEach(p=>{const E=ze(p);E&&l.push(E)}),P(f.requirement??f.Requirement??f["ids:requirement"]??f.requirements??f.Requirements??f["ids:requirements"]).forEach(p=>c(p))};return a.length?a.forEach(f=>{c(f)}):c(e),l.length?{id:s,title:r,applicability:{ifcClasses:o},properties:l}:null},Ke=e=>{const t=Ue(e),s=[];return t.forEach(r=>{try{const i=ke.parse(r);Be(i).forEach((o,u)=>{const a=He(o,u+s.length);a&&s.push(a)})}catch(i){console.warn("Failed to parse IDS specification",i)}}),s},We=(e,t)=>{if(t in e){const r=e[t];return typeof r=="string"?r:r?.toString()}const s=t.toLowerCase();for(const[r,i]of Object.entries(e))if(r.toLowerCase()===s)return typeof i=="string"?i:i?.toString()},Qe=(e,t)=>{const s=We(e.properties,t.path),i=(s==null?"":typeof s=="string"?s:String(s)).trim();if(!i.length){if(t.cardinality&&t.cardinality.min>0)return{status:"FAILED",reason:"Property missing",actual:i};if(!t.cardinality)return{status:"FAILED",reason:"Property missing",actual:i}}let n=i;if(t.dataType&&i.length){const o=xe(i,t.dataType);if(!o.ok)return{status:"FAILED",reason:o.reason,actual:i};o.normalized!==void 0&&(n=o.normalized)}return t.expected&&t.expected.length&&!t.expected.some(u=>u===n)?{status:"FAILED",reason:`Value does not match expected list (${t.expected.join(", ")})`,actual:i}:{status:"PASSED",actual:i}},Je=(e,t)=>{const s=e.map(n=>({id:n.id,title:n.title,passed:[],failed:[],na:[]})),r=[],i=new Map;return e.forEach((n,o)=>{s[o],n.applicability.ifcClasses.length&&i.set(n.id,new Set(n.applicability.ifcClasses.map(u=>u.toLowerCase())))}),t.forEach(n=>{e.forEach((o,u)=>{const a=s[u],l=i.get(o.id),d=n.ifcClass?.toLowerCase?.()??"";if(l&&l.size&&!l.has(d)){a.na.push(n.GlobalId),r.push({ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,status:"NA",reason:"Entity not applicable"});return}if(!o.properties.length){a.na.push(n.GlobalId);return}const c=[],f=[];let w=!1;if(o.properties.forEach(p=>{const E=Qe(n,p),T=Ze(p),C={ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,propertyPath:p.path,expected:T,actual:E.actual};E.status==="FAILED"?(w=!0,c.push({...C,reason:E.reason??p.description,status:"FAILED"})):f.push({...C,status:"PASSED"})}),w){a.failed.push(n.GlobalId),r.push(...c);return}f.length?(a.passed.push(n.GlobalId),r.push(...f)):(a.na.push(n.GlobalId),r.push({ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,status:"NA",reason:"No property checks produced a result"}))})}),{rules:s,rows:r}},I=self,De=new G({ignoreAttributes:!1,removeNSPrefix:!1,attributeNamePrefix:"@_",trimValues:!0});let M=!1;const et=(e,t)=>{const s=(r,i)=>{const n=new Set(r);i.forEach(o=>{n.has(o)||(n.add(o),r.push(o))})};s(e.passed,t.passed),s(e.failed,t.failed),s(e.na,t.na)},tt=async e=>{const t=e.idsXml?.trim?.()??"";if(!t){I.postMessage({type:"error",message:"Empty IDS payload received."});return}I.postMessage({type:"phase",label:"compiling"});try{De.parse(t)}catch{I.postMessage({type:"error",message:"Failed to parse IDS XML. Please verify the file contents."});return}const s=Ke(t);if(!s.length){I.postMessage({type:"error",message:"No valid IDS specifications were found in the provided documents."});return}const r=Array.isArray(e.elements)?e.elements:[],i=r.length,n=e.chunk&&e.chunk>0?e.chunk:200;I.postMessage({type:"phase",label:"validating"}),I.postMessage({type:"progress",done:0,total:i});const o=new Map,u=[];for(let d=0;d<r.length;d+=n){if(M){I.postMessage({type:"error",message:"Validation cancelled"}),M=!1;return}const c=r.slice(d,d+n),f=Je(s,c);f.rules.forEach(p=>{const E=o.get(p.id);E?et(E,p):o.set(p.id,{id:p.id,title:p.title,passed:[...p.passed],failed:[...p.failed],na:[...p.na]})}),f.rows.forEach(p=>{u.push(p)});const w=Math.min(d+c.length,i);I.postMessage({type:"progress",done:w,total:i})}I.postMessage({type:"phase",label:"finalizing"});const l={type:"done",rules:Array.from(o.values()),rows:u};I.postMessage(l),I.postMessage({type:"phase",label:"idle"})};I.onmessage=e=>{const t=e.data;if(t){if(t.type==="cancel"){M=!0;return}t.type==="validate"&&(M=!1,tt(t).catch(s=>{const r={type:"error",message:s instanceof Error?s.message:"Unknown IDS worker error"};I.postMessage(r)}))}}})();
