const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-BBTmsr9t.js","assets/vendor-NpE_gqg9.js","assets/thatopen-vendor-byvyd1e5.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-CdLybG9Y.js","assets/IdsCreatorPanel-DGierL19.js","assets/ModelFilterPanel-CSdmHdUa.js"])))=>i.map(i=>d[i]);
import{ck as vs,cl as ks,cm as d,cn as At,co as o,cp as W,cq as U,cr as te,cs as ee,ct as Es,cu as Ps,cv as As,cw as Ms,cx as Rs,cy as zs,cz as $s,cA as ie,cB as Zr,cC as Qr,cD as en,cE as tn,cF as je,cG as Ds,cH as on,cI as Fs,cJ as rn,cK as nn,cL as Ts,cM as sn,cN as Wt,cO as vt,cP as Ut,cQ as Ns,cR as Os,cS as ln,cT as Ls,cU as Vs,cV as Jo,cW as _s,cX as Bs,cY as Gs,cZ as Ws,c_ as Us,c$ as an,d0 as cn,d1 as Zo,d2 as Qo,d3 as er,d4 as dn,d5 as un,d6 as fn,d7 as Ht,d8 as qt,d9 as tr,da as Hs,db as qs,dc as or,dd as Ks,de as Ys}from"./vendor-NpE_gqg9.js";import{l as Xs,_ as Js,C as Zs,W as Qs,S as el,a as tl,O as ol,G as rl,F as nl,t as sl,H as ll,Y as il,$ as pn}from"./thatopen-vendor-byvyd1e5.js";import{B as st,V as Z,C as De,a3 as al,c as mn,P as kt,a6 as rr,l as hn,G as cl,S as dl,h as gn,$ as ul,y as yn,ab as fl,D as pl}from"./three-vendor-kQcUiZz9.js";(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))b(i);new MutationObserver(i=>{for(const h of i)if(h.type==="childList")for(const x of h.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&b(x)}).observe(document,{childList:!0,subtree:!0});function a(i){const h={};return i.integrity&&(h.integrity=i.integrity),i.referrerPolicy&&(h.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?h.credentials="include":i.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function b(i){if(i.ep)return;i.ep=!0;const h=a(i);fetch(i.href,h)}})();const ml="modulepreload",hl=function(t){return"/Savora-Viewer/"+t},bn={},Pt=function(l,a,b){let i=Promise.resolve();if(a&&a.length>0){let E=function(m){return Promise.all(m.map(k=>Promise.resolve(k).then(j=>({status:"fulfilled",value:j}),j=>({status:"rejected",reason:j}))))};document.getElementsByTagName("link");const x=document.querySelector("meta[property=csp-nonce]"),g=x?.nonce||x?.getAttribute("nonce");i=E(a.map(m=>{if(m=hl(m),m in bn)return;bn[m]=!0;const k=m.endsWith(".css"),j=k?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${m}"]${j}`))return;const O=document.createElement("link");if(O.rel=k?"stylesheet":ml,k||(O.as="script"),O.crossOrigin="",O.href=m,g&&O.setAttribute("nonce",g),document.head.appendChild(O),k)return new Promise((D,C)=>{O.addEventListener("load",D),O.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${m}`)))})}))}function h(x){const g=new Event("vite:preloadError",{cancelable:!0});if(g.payload=x,window.dispatchEvent(g),!g.defaultPrevented)throw x}return i.then(x=>{for(const g of x||[])g.status==="rejected"&&h(g.reason);return l().catch(h)})},ar="bim_viewer_api_config",gl=t=>{try{return btoa(t)}catch{return t}},yl=t=>{try{return atob(t)}catch{return t}},bl=t=>{const l={...t,apiKey:gl(t.apiKey)};localStorage.setItem(ar,JSON.stringify(l))},xl=()=>{const t=localStorage.getItem(ar);if(!t)return null;try{const l=JSON.parse(t);return{...l,apiKey:yl(l.apiKey)}}catch{return null}},wl=()=>{localStorage.removeItem(ar)},Il=t=>{switch(t){case"gemini":return["gemini-2.5-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},bo=t=>{switch(t){case"gemini":return"gemini-2.5-flash";case"openai":return"gpt-4o-mini";default:return""}},Cl=async(t,l,a="gemini-2.5-flash")=>{const b=`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${t}`,i=await fetch(b,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:l}]}]})});if(!i.ok){const x=await i.json().catch(()=>({}));throw new Error(x.error?.message||`Gemini API error: ${i.status} ${i.statusText}`)}const h=await i.json();if(!h.candidates||h.candidates.length===0)throw new Error("No response from Gemini API");return h.candidates[0].content.parts[0].text},Sl=async(t,l="gemini-2.0-flash-exp")=>{try{return await Cl(t,"Hello, respond with OK",l),!0}catch{return!1}},jl=async(t,l,a="gpt-4o-mini")=>{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:a,messages:[{role:"user",content:l}]})});if(!i.ok){const x=await i.json().catch(()=>({}));throw new Error(x.error?.message||`OpenAI API error: ${i.status} ${i.statusText}`)}const h=await i.json();if(!h.choices||h.choices.length===0)throw new Error("No response from OpenAI API");return h.choices[0].message.content},vl=async(t,l="gpt-4o-mini")=>{try{return await jl(t,"Hello, respond with OK",l),!0}catch{return!1}},kl="fragments-ids",le="elements-v5",de="cache-metadata-v1",El=6,ve=()=>new Promise((t,l)=>{const a=indexedDB.open(kl,El);a.onerror=()=>l(a.error??new Error("IndexedDB open failed")),a.onupgradeneeded=()=>{const b=a.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(h=>{b.objectStoreNames.contains(h)&&b.deleteObjectStore(h)}),b.objectStoreNames.contains(le)||b.createObjectStore(le),b.objectStoreNames.contains(de)||b.createObjectStore(de)},a.onsuccess=()=>t(a.result)}),nr={async get(t){const l=await ve();return new Promise((a,b)=>{const x=l.transaction(le,"readonly").objectStore(le).get(t);x.onsuccess=()=>a(x.result??null),x.onerror=()=>b(x.error??new Error("IndexedDB get failed"))})},async set(t,l){const a=await ve();await new Promise((b,i)=>{const h=a.transaction([le,de],"readwrite"),x=h.objectStore(le),g=h.objectStore(de),E=x.put(l,t),m={modelKey:t,timestamp:Date.now(),elementCount:l.length,version:"1.0"};g.put(m,t),E.onsuccess=()=>b(),E.onerror=()=>i(E.error??new Error("IndexedDB set failed"))}),console.log(`üíæ Cached ${l.length} elements to IndexedDB for key: ${t.substring(0,16)}...`)},async append(t,l){if(!l||!l.length)return;const a=await ve();await new Promise((b,i)=>{const h=a.transaction([le,de],"readwrite"),x=h.objectStore(le),g=h.objectStore(de),E=x.get(t);E.onsuccess=()=>{const k=(E.result??[]).concat(l),j=x.put(k,t),O={modelKey:t,timestamp:Date.now(),elementCount:k.length,version:"1.0"};g.put(O,t),j.onsuccess=()=>b(),j.onerror=()=>i(j.error??new Error("IndexedDB append put failed"))},E.onerror=()=>i(E.error??new Error("IndexedDB append get failed"))}),console.log(`üíæ Appended ${l.length} elements to IndexedDB for key: ${t.substring(0,16)}...`)},async writePart(t,l,a){const b=`${t}::part::${String(l).padStart(6,"0")}`,i=`${t}::partindex::${String(l).padStart(6,"0")}`,h=await ve();await new Promise((x,g)=>{const E=h.transaction([le,de],"readwrite"),m=E.objectStore(le),k=E.objectStore(de),j=m.put(a,b);j.onsuccess=()=>{const O=k.get(t);O.onsuccess=()=>{const D=O.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};D.timestamp=Date.now(),D.elementCount=(D.elementCount||0)+a.length;const C=Array.isArray(D.partKeys)?D.partKeys.slice():[];C.includes(b)||C.push(b),D.partKeys=C,k.put(D,t);try{const M=a.map(v=>v.GlobalId).filter(Boolean),N=m.put(M,i);N.onsuccess=()=>{},N.onerror=()=>{}}catch{}x()},O.onerror=()=>x()},j.onerror=()=>g(j.error??new Error("IndexedDB writePart failed"))}),console.log(`üíæ Wrote part ${l} (${a.length} items) for ${t.substring(0,16)}...`)},async getPersistedIds(t){const l=await this.getPartKeys(t);if(!l||!l.length)return new Set;const a=await ve(),b=new Set;return await new Promise(i=>{const x=a.transaction(le,"readonly").objectStore(le);let g=l.length;l.forEach(E=>{const m=E.replace("::part::","::partindex::"),k=x.get(m);k.onsuccess=()=>{const j=k.result??[];for(const O of j)typeof O=="string"&&O&&b.add(O);g-=1,g===0&&i()},k.onerror=()=>{g-=1,g===0&&i()}})}),b},async getPartKeys(t){const l=await this.getMetadata(t);return Array.isArray(l?.partKeys)?l.partKeys:[]},async listParts(t){return(await this.getPartKeys(t)).slice().sort()},async readAllParts(t){const l=await ve(),a=await this.getPartKeys(t);return a.length?new Promise((b,i)=>{const x=l.transaction(le,"readonly").objectStore(le),g=[];let E=a.length;a.forEach(m=>{const k=x.get(m);k.onsuccess=()=>{const j=k.result??[];g.push(...j),E-=1,E===0&&b(g)},k.onerror=()=>{E-=1,E===0&&b(g)}})}):[]},async removeParts(t){const l=await ve(),a=`${t}::part::`,i=(await this.keys()).filter(h=>h.startsWith(a));i.length&&(await new Promise((h,x)=>{const g=l.transaction([le,de],"readwrite"),E=g.objectStore(le),m=g.objectStore(de);i.forEach(k=>E.delete(k)),m.delete(t),g.oncomplete=()=>h(),g.onerror=()=>x(g.error??new Error("IndexedDB removeParts failed"))}),console.log(`üßπ Removed ${i.length} parts for ${t.substring(0,16)}...`))},async getMetadata(t){const l=await ve();return new Promise((a,b)=>{const x=l.transaction(de,"readonly").objectStore(de).get(t);x.onsuccess=()=>a(x.result??null),x.onerror=()=>b(x.error??new Error("IndexedDB metadata get failed"))})},async remove(t){const l=await ve();await new Promise((a,b)=>{const i=l.transaction([le,de],"readwrite"),h=i.objectStore(le),x=i.objectStore(de);h.delete(t),x.delete(t),i.oncomplete=()=>a(),i.onerror=()=>b(i.error??new Error("IndexedDB delete failed"))})},async keys(){const t=await ve();return new Promise((l,a)=>{const h=t.transaction(le,"readonly").objectStore(le).getAllKeys();h.onsuccess=()=>l(h.result??[]),h.onerror=()=>a(h.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const t=await ve();return new Promise((l,a)=>{const h=t.transaction(de,"readonly").objectStore(de).getAll();h.onsuccess=()=>l(h.result??[]),h.onerror=()=>a(h.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(t=720*60*60*1e3){const l=await ve(),a=await this.getAllMetadata(),b=Date.now(),i=a.filter(h=>b-h.timestamp>t).map(h=>h.modelKey);i.length>0&&await new Promise((h,x)=>{const g=l.transaction([le,de],"readwrite"),E=g.objectStore(le),m=g.objectStore(de);i.forEach(k=>{E.delete(k),m.delete(k)}),g.oncomplete=()=>{console.log(`üßπ Cleaned up ${i.length} old cache entries from IndexedDB`),h()},g.onerror=()=>x(g.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(t,l){const a=await this.getMetadata(t);return!a||!a.modelSignature?!1:a.modelSignature===l},async updateSignature(t,l,a){const b=await ve();await new Promise((i,h)=>{const g=b.transaction(de,"readwrite").objectStore(de),E=g.get(t);E.onsuccess=()=>{const m=E.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};m.modelSignature=l,m.modelFiles=a,m.timestamp=Date.now();const k=g.put(m,t);k.onsuccess=()=>i(),k.onerror=()=>h(k.error??new Error("IndexedDB updateSignature failed"))},E.onerror=()=>h(E.error??new Error("IndexedDB updateSignature get failed"))})}},Pl=async t=>{const l=new TextEncoder,a=`${t.modelUrl}|${t.extra??""}`,b=l.encode(a),i=await crypto.subtle.digest("SHA-256",b),h=new Uint8Array(i);return btoa(String.fromCharCode(...h)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},vn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},He=t=>t==null?[]:Array.isArray(t)?t:[t],xn=t=>{if(t==null)return[];if(typeof t=="string")try{const l=JSON.parse(t);return Array.isArray(l)?l:[]}catch{return[]}if(typeof t=="object"){const l=t;if(typeof l.__cdata=="string")try{const a=JSON.parse(l.__cdata);return Array.isArray(a)?a:[]}catch{return[]}if(Array.isArray(l.item))return l.item;if(l.item!=null)return[l.item];if(Array.isArray(l.Rule))return l.Rule;if(l.Rule!=null)return[l.Rule]}return Array.isArray(t)?t:[]},hi=t=>{if(!t||typeof t!="string")return[];const l=new ks(vn);let a={};try{a=l.parse(t)}catch(m){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",m),[]}const b=a?.IdsCreator??a?.idsCreator??a?.IDS_CREATOR??a?.Ids??a,i=b?.Specification??b?.specification??b?.Specifications??b?.specifications??null;if(i){const m=He(i);if(m.length)return m.map((k,j)=>{const O=k?.["@_id"]?.trim?.()||`spec-${j+1}`,D=(k?.Name??k?.name??"")?.toString?.()??"",C=(k?.Description??k?.description??"")?.toString?.()??"",M=xn(k?.Applicability??k?.applicability),N=xn(k?.Requirements??k?.requirements);return{id:O,name:D,description:C,applicability:M,requirements:N}})}const h=m=>{if(!m||typeof m!="object")return[];for(const[k,j]of Object.entries(m)){const O=String(k).toLowerCase();if(O.endsWith(":specification")||O==="specification"||O==="ids:specification")return He(j)}for(const k of Object.values(m))if(k&&typeof k=="object"){const j=h(k);if(j&&j.length)return j}return[]},x=h(a);if(!x.length)return[];const g=m=>{if(!m)return null;if(typeof m=="string")return m;if(typeof m=="object")for(const k of Object.keys(m)){const j=k.toLowerCase();if(j.includes("simplevalue")||j==="#text"||j==="value"){const O=m[k];if(typeof O=="string")return O;if(typeof O=="object"&&(O?.value||O?.Value))return String(O.value??O.Value)}}return null};return x.map((m,k)=>{const j=m?.["@_id"]?.trim?.()||`spec-${k+1}`,O=m?.["@_name"]??m?.name??m?.Name??"",D=String(O??""),C="",M=[],N=[],v=m?.applicability??m?.Applicability??m?.["ids:applicability"]??null,$=He(v);for(const J of $){let re=null;const Y=[J];for(;Y.length&&!re;){const H=Y.shift();if(!H)continue;const Re=g(H);if(Re){re=Re;break}if(typeof H=="object")for(const Ce of Object.values(H))Ce&&typeof Ce=="object"&&Y.push(Ce)}re&&M.push({entity:re})}const q=m?.requirements??m?.Requirements??m?.["ids:requirements"]??null,he=He(q),Q=J=>{const re=[],Y=[];if(J?.property&&Y.push(...He(J.property)),J?.Property&&Y.push(...He(J.Property)),Array.isArray(J)&&Y.push(...J),!Y.length&&typeof J=="object")for(const H of Object.values(J))H&&typeof H=="object"&&Y.push(H);for(const H of Y){const Re=H?.propertySet??H?.PropertySet??H?.["ids:propertySet"]??H?.propertySet,Ce=H?.baseName??H?.BaseName??H?.["ids:baseName"]??H?.baseName,Ke=g(Re)||g(H?.propertySet?.simpleValue)||g(H?.propertySet?.["ids:simpleValue"]),Mt=g(Ce)||g(H?.baseName?.simpleValue)||g(H?.baseName?.["ids:simpleValue"]),_e=[],be=H?.allowedValues??H?.AllowedValues??H?.["ids:allowedValues"];if(be){const Be=be?.values??be?.Values??be?.["ids:values"]??be,Rt=He(Be?.value??Be?.Value??Be?.["ids:value"]??Be??[]);for(const Ye of Rt){const ze=g(Ye)||g(Ye?.simpleValue)||g(Ye?.["ids:simpleValue"]);ze&&_e.push(ze)}}if(Ke||Mt){const Be={id:`rule-${k}-${re.length}`,propertyPath:`${Ke??"Pset"}.${Mt??"Property"}`,operator:"equals"};_e.length&&(Be.value=_e.length===1?_e[0]:JSON.stringify(_e)),re.push(Be)}}return re};for(const J of he){const re=Q(J);re.length&&N.push(...re)}return{id:j,name:String(D??""),description:String(C),applicability:M,requirements:N}})},gi=t=>{const l=new vs(vn);if((t??[]).some(h=>Array.isArray(h.requirements)&&h.requirements.some(x=>x&&typeof x=="object"&&"propertyPath"in x))){const x={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(t??[]).map(E=>{const m=[],k=C=>{if(!C&&C!==0)return null;if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(C?.ifcClass&&typeof C.ifcClass=="string"&&C.ifcClass.trim())return C.ifcClass.trim();const M=C?.entity??C?.ifcType??C?.type;if(M&&typeof M=="string"&&M.trim())return M.trim();const N=C?.sample??C;if(N){if(N._category&&typeof N._category=="object"){const $=N._category.value??N._category.Value;if(typeof $=="string"&&$.trim())return $.trim()}const v=N?.ifcClass??N?.category?.value??N?.type??N?._type;if(v&&typeof v=="string"&&v.trim())return v.trim()}return null};for(const C of He(E.applicability)){const M=k(C)??null,N=M&&String(M).trim()?String(M):"IFCELEMENT";m.push({"ids:name":{"ids:simpleValue":N}})}const j=[],O=C=>{if(C==null)return"";if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(typeof C=="object"){if(C["ids:simpleValue"])return String(C["ids:simpleValue"]);if(C.__cdata)return String(C.__cdata);if(C.Name)return String(C.Name);if(C.name)return String(C.name);for(const M of Object.keys(C)){const N=C[M];if(typeof N=="string"&&N.trim())return N;if(N&&typeof N=="object"){const v=N;if(typeof v["ids:simpleValue"]=="string")return v["ids:simpleValue"];if(typeof v.value=="string")return v.value}}return""}return""};for(const C of He(E.requirements))if(C&&typeof C=="object"){const M=C;let N=null,v=null;if(typeof M.propertyPath=="string"){const[Y,H]=String(M.propertyPath).split(".");N=Y,v=H}else M.propertyPath&&typeof M.propertyPath=="object"?(N=M.propertyPath.pset??M.propertyPath.propertySet??M.propertySet??null,v=M.propertyPath.property??M.propertyPath.prop??M.property??M.propertyName??null):(N=M.propertySet??M.pset??null,v=M.baseName??M.property??M.prop??null);const $=O(N)||"Pset",q=O(v)||"Property",he=Jt($)||$,Q=Jt(q)||q,J={};if(J["ids:propertySet"]={"ids:simpleValue":he},J["ids:baseName"]={"ids:simpleValue":Q},(M.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(M.value!=null&&String(M.value).trim()){let Y=null;try{const H=typeof M.value=="string"?JSON.parse(M.value):M.value;Array.isArray(H)&&(Y=H.map(Re=>String(Re)))}catch{}Y||typeof M.value=="string"&&M.value.includes(",")&&(Y=M.value.split(",").map(H=>Io(H.trim())).filter(Boolean)),Y&&Y.length?J["ids:allowedValues"]={"ids:values":{"ids:value":Y.map(H=>({"ids:simpleValue":Io(String(H))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":Io(String(M.value))}}}}j.push({"ids:property":J})}const D={"@_ifcVersion":"IFC4","@_name":E.name??""};return m.length&&(D["ids:applicability"]={"ids:entity":m.map(C=>({"ids:name":C["ids:name"]?C["ids:name"]:C}))}),j.length&&(D["ids:requirements"]={"ids:property":j.map(C=>C["ids:property"])}),D})}},g=l.build(x);return g.startsWith("<?xml")?g:`<?xml version="1.0" encoding="UTF-8"?>
${g}`}const b={IdsCreator:{Specification:(t??[]).map(h=>({"@_id":h.id,Name:h.name,Description:h.description,Applicability:{__cdata:JSON.stringify(h.applicability??[])},Requirements:{__cdata:JSON.stringify(h.requirements??[])}}))}},i=l.build(b);return i.startsWith("<?xml")?i:`<?xml version="1.0" encoding="UTF-8"?>
${i}`},Jt=t=>t?t.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Io=t=>!t||typeof t!="string"?t:t.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),kn=t=>{if(t==null)return"";if(typeof t=="string")return Io(t.trim());if(typeof t=="number"||typeof t=="boolean")return String(t);try{return JSON.stringify(t)}catch{return String(t)}},Al=t=>{if(!t)return{};const l={};for(const[a,b]of Object.entries(t)){if(!b||typeof b!="object")continue;const i=Jt(a)||a;for(const[h,x]of Object.entries(b)){const g=Jt(h)||h,E=`${i}.${g}`;E in l||(l[E]=kn(x))}}return l};let lt=null;const Ml=()=>{lt=null},Rl=t=>t.slice().sort().join("|"),zl=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],$l=(t,l)=>{if(!t||typeof t!="object")return;const a=l.map(h=>h.toLowerCase()),b=new WeakSet,i=[t];for(;i.length;){const h=i.pop();if(!(!h||typeof h!="object")&&!b.has(h)){if(b.add(h),Array.isArray(h)){for(const x of h)x&&typeof x=="object"&&i.push(x);continue}for(const[x,g]of Object.entries(h)){const E=x.toLowerCase();if(a.some(m=>E.includes(m)))if(typeof g=="string"){const m=g.trim();if(m)return m}else{if(typeof g=="number"&&Number.isFinite(g))return g.toString();if(typeof g=="boolean")return g?"true":"false";if(g&&typeof g=="object"){const m=g;if(typeof m.value=="string"){const k=m.value.trim();if(k)return k}if(typeof m.Value=="string"){const k=m.Value.trim();if(k)return k}m.value&&typeof m.value=="object"&&i.push(m.value),m.Value&&typeof m.Value=="object"&&i.push(m.Value)}}g&&typeof g=="object"&&i.push(g)}}}},Dl=t=>{if(!t||typeof t!="object")return null;const l=t;for(const b of zl){const i=l[b];if(typeof i=="string"&&i.trim().length)return i.trim()}return $l(t,["globalid","global id","guid","uniqueid"])?.trim()??null},xo=async(t,l,a)=>{console.log("üîç [collectElementsDirect] START with",l.length,"globalIds"),console.log("üîç [collectElementsDirect] Has getElementProps?",!!t.getElementProps);const b=[],i=Math.max(l.length,1);a?.onProgress?.({done:0,total:i});const h=t.getElementProps;console.log("üîç [collectElementsDirect] Using getElementProps method");for(let x=0;x<l.length;x++){const g=l[x];try{const{ifcClass:E,psets:m,attributes:k}=await h.call(t,g),j=Al(m);if("GlobalId"in j||(j.GlobalId=g),k)for(const[O,D]of Object.entries(k)){const M=`Attributes.${Jt(O)||O}`;M in j||(j[M]=kn(D))}j.ifcClass||(j.ifcClass=E),b.push({GlobalId:g,ifcClass:E,properties:j}),(x%50===0||x===l.length-1)&&a?.onProgress?.({done:b.length,total:i})}catch(E){console.warn(`IDS adapter (direct) failed to load element ${g}`,E)}}return a?.onProgress?.({done:b.length,total:i}),console.log("üîç [collectElementsDirect] COMPLETE - returning",b.length,"elements"),b},Fl=async(t,l,a)=>{if(typeof t.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const b=Math.max(1,(navigator.hardwareConcurrency||4)-1);console.log(`üöÄ Starting parallel property extraction with ${b} workers`);const i=[],h=[],x=[];for(let m=0;m<b;m++){const k=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});i.push(k);const j=new Promise((O,D)=>{const C=N=>{const v=N.data;if(v){if(v.type==="error"){D(new Error(v.message||`Worker ${m} failed.`));return}if(v.type==="progress"){const $=x.reduce((q,he)=>q+he.length,0)+v.done;a?.onProgress?.({done:$,total:Math.max(l,$)});return}v.type==="done"&&(x[m]=v.elements??[],O(v.elements??[]))}},M=N=>{D(N.error??new Error(N.message||`Worker ${m} error.`))};k.addEventListener("message",C),k.addEventListener("error",M)});h.push(j),k.postMessage({type:"build-props",reset:!0,total:l})}a?.onProgress?.({done:0,total:l});const g=new Set;let E=0;try{for await(const m of t.iterElements({batchSize:128})){if(!Array.isArray(m)||!m.length)continue;const k=[];m.forEach(j=>{if(!j||typeof j!="object")return;const O=j.data;if(!O)return;const D=Dl(O);if(!D||g.has(D))return;g.add(D);const C=typeof O.ifcClass=="string"?O.ifcClass:void 0;k.push({globalId:D,ifcClass:C,data:O})}),k.length&&(i[E].postMessage({type:"build-props",elements:k}),E=(E+1)%b)}}catch(m){throw i.forEach(k=>{k.postMessage({type:"cancel"}),k.terminate()}),m}i.forEach(m=>{m.postMessage({type:"build-props",final:!0})});try{const k=(await Promise.all(h)).flat();return console.log(`‚úÖ Parallel processing complete: ${k.length} elements processed by ${b} workers`),a?.onProgress?.({done:k.length,total:Math.max(l,k.length)}),k}finally{i.forEach(m=>m.terminate())}},Tl=async(t,l)=>{try{const a=typeof l.countElements=="function"?await l.countElements():void 0;return await Pl({modelUrl:t,extra:a!=null?String(a):void 0})}catch(a){return console.warn("IDS adapter: failed to compute model key for cache",a),null}},Nl=async(t,l)=>{if(console.log("üîç [collectElementsForIds] START",{hasFilterGlobalIds:!!l?.filterGlobalIds,filterCount:l?.filterGlobalIds?.length}),!t)return console.log("üîç [collectElementsForIds] No viewerApi"),[];let a;if(l?.filterGlobalIds&&l.filterGlobalIds.length>0)console.log("üîç [collectElementsForIds] Using provided filterGlobalIds directly (skipping listGlobalIds)"),a=l.filterGlobalIds;else{console.log("üîç [collectElementsForIds] Calling listGlobalIds...");const E=await t.listGlobalIds();console.log("üîç [collectElementsForIds] Got all GlobalIds:",E.length),a=E}if(console.log("üîç [collectElementsForIds] GlobalIds to validate:",a.length),!a.length)return console.log("üîç [collectElementsForIds] No GlobalIds to process"),lt=null,[];console.log("üîç [collectElementsForIds] Building cache token...");const b=Rl(a);console.log("üîç [collectElementsForIds] Token built:",b.substring(0,20)+"...");const i=Math.max(a.length,1);if(l?.onPhase?.("BUILDING_PROPERTIES"),l?.onProgress?.({done:0,total:i}),console.log("üîç [collectElementsForIds] Checking memory cache..."),lt&&lt.token===b)return console.log("üîç [collectElementsForIds] Memory cache HIT! Returning",lt.elements.length,"elements"),lt.elements;console.log("üîç [collectElementsForIds] Memory cache MISS");const h=l?.filterGlobalIds&&l.filterGlobalIds.length>0;let x=null;if(h)console.log("üîç [collectElementsForIds] Skipping persistent cache (filtering mode)");else if(console.log("üîç [collectElementsForIds] Resolving persistent key..."),x=await Tl(b,t),console.log("üîç [collectElementsForIds] Persistent key:",x),x){console.log("üîç [collectElementsForIds] Checking IndexedDB cache...");try{const E=await nr.get(x);if(console.log("üîç [collectElementsForIds] IndexedDB returned:",E?.length||0,"elements"),E&&E.length){const m=await nr.getMetadata(x),k=m?Math.round((Date.now()-m.timestamp)/1e3/60):0;return console.log(`‚ö° Using cached elements from IndexedDB: ${E.length} elements (cached ${k} minutes ago)`),l?.onProgress?.({done:E.length,total:i}),lt={token:b,elements:E},E}console.log("üîç [collectElementsForIds] IndexedDB cache MISS or empty")}catch(E){console.warn("IDS adapter: failed to read cached elements from IndexedDB",E)}}let g=[];if(console.log("üîç [collectElementsForIds] Decision point:",{isFiltering:h,willUseDirect:h,globalIdsCount:a.length}),h)console.log(`üìå Filtering mode: collecting ${a.length} specific elements directly`),console.log("üîç [collectElementsForIds] Calling collectElementsDirect..."),g=await xo(t,a,l),console.log("üîç [collectElementsForIds] collectElementsDirect returned:",g.length,"elements");else{console.log("üîç [collectElementsForIds] Full model mode - using workers");const E=typeof t.countElements=="function"?await t.countElements().catch(()=>a.length):a.length;if(console.log("üîç [collectElementsForIds] Total elements:",E),typeof t.iterElements=="function")try{console.log("üîç [collectElementsForIds] Calling buildWithWorker..."),g=await Fl(t,E??a.length,l),console.log("üîç [collectElementsForIds] buildWithWorker returned:",g.length,"elements"),g.length||(console.log("üîç [collectElementsForIds] No elements from worker, falling back to direct"),g=await xo(t,a,l))}catch(m){console.warn("IDS adapter: property build worker failed, falling back to direct collection",m),g=await xo(t,a,l)}else console.log("üîç [collectElementsForIds] iterElements not available, using direct"),g=await xo(t,a,l)}return x&&g.length&&nr.set(x,g).catch(E=>console.warn("IDS adapter: failed to persist elements cache",E)),lt={token:b,elements:g},l?.onProgress?.({done:Math.min(g.length,i),total:i}),g},Ol={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let ht=Ol;const ir=new Set;let mt=null;const Ll=()=>{ir.forEach(t=>{try{t()}catch(l){console.error("IDS store listener error",l)}})},ce=t=>{ht=t(ht),Ll()};let it=null,Co=null;const Vl=()=>(it||(it=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),it),_l=(t,l)=>{const a=Vl(),b=new Promise((i,h)=>{const x=E=>{const m=E.data;if(m){if(m.type==="error"){a.removeEventListener("message",x),a.removeEventListener("error",g),h(new Error(m.message||"IDS worker failed"));return}if(m.type==="phase"){l?.onPhase?.(m.label);return}if(m.type==="progress"){l?.onProgress?.(m);return}if(m.type==="done"){a.removeEventListener("message",x),a.removeEventListener("error",g),i(m);return}}},g=E=>{a.removeEventListener("message",x),a.removeEventListener("error",g),h(E.error??new Error(E.message))};a.addEventListener("message",x),a.addEventListener("error",g),a.postMessage(t)});return Co=b.finally(()=>{Co=null}),b},wn=()=>{ce(t=>({...t,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:t=>(ir.add(t),()=>ir.delete(t)),getState:()=>ht,setIdsXmlText:(t,l)=>{const a=t.replace(/\uFEFF/g,"").trim(),b=l?.fileNames??[];ce(i=>({...i,idsXmlText:a,idsFileNames:b,error:null})),wn()},appendDocuments:t=>{if(!t.length)return;const l=fe.getState(),a=[];l.idsXmlText.trim().length&&a.push(l.idsXmlText.trim()),a.push(...t.map(h=>h.content.trim()).filter(Boolean));const b=a.join(`

`),i=[...l.idsFileNames,...t.map(h=>h.name)];fe.setIdsXmlText(b,{fileNames:i})},clearResults:()=>{wn()},setValidationMode:t=>{ce(l=>({...l,validationMode:t}))},filterRows:(t,l)=>{ce(a=>{if(!t)return{...a,filteredRows:a.rows,filterDescription:null};const b=a.rows.filter(i=>{try{return t(i)}catch(h){return console.warn("IDS filter predicate threw an error",h),!0}});return{...a,filteredRows:b,filterDescription:l??null}})},runCheck:async t=>{if(!t){ce(i=>({...i,error:"Viewer API is not available."}));return}if(ht.isChecking){await Co;return}const l=ht.idsXmlText.trim();if(!l){ce(i=>({...i,error:"Load at least one IDS XML file before running the check."}));return}let a;if(ht.validationMode==="selected")if(console.log("üéØ Selected Only mode is active"),t.getSelectedGlobalIds){if(console.log("üéØ Getting selected GlobalIds..."),a=await t.getSelectedGlobalIds(),console.log("üéØ Selected GlobalIds:",a),!a||a.length===0){console.error("‚ùå No elements selected"),ce(i=>({...i,error:"No elements selected. Please select elements or switch to another mode."}));return}console.log(`üéØ Validating ${a.length} selected elements`)}else{console.warn("‚ö†Ô∏è getSelectedGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Selected elements validation is not supported by this viewer."}));return}else if(ht.validationMode==="visible")if(console.log("üëÅÔ∏è Visible Only mode is active"),t.getVisibleGlobalIds){if(console.log("üëÅÔ∏è Getting visible GlobalIds..."),a=await t.getVisibleGlobalIds(),console.log("üëÅÔ∏è Visible GlobalIds:",a),!a||a.length===0){console.error("‚ùå No visible elements found"),ce(i=>({...i,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}console.log(`üëÅÔ∏è Validating ${a.length} visible elements`)}else{console.warn("‚ö†Ô∏è getVisibleGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Visible elements validation is not supported by this viewer."}));return}ce(i=>({...i,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),mt=new AbortController;const b=mt.signal;try{if(b.aborted)throw new Error("Validation cancelled");const i=await Nl(t,{filterGlobalIds:a,onPhase:m=>{ce(k=>({...k,phase:m}))},onProgress:m=>{ce(k=>({...k,progress:m}))}});if(!i.length)throw new Error("No IFC elements were found in the current viewer.");if(b.aborted)throw new Error("Validation cancelled");ce(m=>({...m,phase:"CHECKING_IDS",progress:null}));const h={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},x=await _l({type:"validate",idsXml:l,elements:i},{onPhase:m=>{const k=h[m];k&&ce(j=>({...j,phase:k}))},onProgress:m=>{ce(k=>({...k,progress:{done:m.done,total:m.total}}))}}),g=x.rules??[],E=x.rows??[];if(a&&a.length>0&&typeof t.addToCache=="function"){console.log(`üì¶ Adding ${a.length} validated elements to cache...`);try{await t.addToCache(a),console.log("üì¶ Successfully updated cache with validated elements")}catch(m){console.warn("üì¶ Failed to add elements to cache:",m)}}ce(m=>({...m,isChecking:!1,rules:g,rows:E,filteredRows:E,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),mt=null}catch(i){const h=i instanceof Error?i.message:"Failed to run IDS validation.";console.error("IDS run failed",i),ce(x=>({...x,isChecking:!1,error:h,phase:"ERROR",progress:null})),mt=null}},invalidateCaches:()=>{Ml(),it&&(it.terminate(),it=null,Co=null),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{console.log("üõë Cancelling IDS validation..."),mt&&(mt.abort(),mt=null),it&&it.postMessage({type:"cancel"}),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},Bl=t=>d.useSyncExternalStore(fe.subscribe,()=>t({...fe.getState(),...fe}),()=>t({...fe.getState(),...fe})),Gl=t=>d.useSyncExternalStore(fe.subscribe,()=>t(fe.getState()),()=>t(fe.getState())),Wl=()=>{const t=d.useCallback(fe.setIdsXmlText,[]),l=d.useCallback(fe.appendDocuments,[]),a=d.useCallback(fe.clearResults,[]),b=d.useCallback(fe.filterRows,[]),i=d.useCallback(fe.runCheck,[]),h=d.useCallback(fe.setValidationMode,[]),x=d.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:t,appendDocuments:l,clearResults:a,filterRows:b,runCheck:i,setValidationMode:h,cancelValidation:x,invalidateCaches:fe.invalidateCaches}},En=fe,Ul=Object.freeze(Object.defineProperty({__proto__:null,idsStore:En,useIdsActions:Wl,useIdsStore:Bl,useIdsStoreSelector:Gl},Symbol.toStringTag,{value:"Module"})),Hl=At.lazy(()=>Pt(()=>import("./ChatWindow-BBTmsr9t.js"),__vite__mapDeps([0,1,2,3]))),ql=At.lazy(()=>Pt(()=>import("./IdsPanel-CdLybG9Y.js"),__vite__mapDeps([4,1,2,3]))),Kl=At.lazy(()=>Pt(()=>import("./IdsCreatorPanel-DGierL19.js"),__vite__mapDeps([5,1,2,3]))),Yl=At.lazy(()=>Pt(()=>import("./ModelFilterPanel-CSdmHdUa.js"),__vite__mapDeps([6,1]))),sr=(t,l)=>{if(t.length!==l.length)return!1;for(let a=0;a<t.length;a+=1){const b=t[a],i=l[a];if(!i||b.modelId!==i.modelId||b.localId!==i.localId)return!1}return!0},Xl={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Jl=(t,l)=>{if(!t)return l;const a=[t.ifcCategory,t.Category,t.category,t.ifcClass,t.class,t.type,t.Type,t.system,t.System];for(const b of a)if(typeof b=="string"&&b.trim())return b.trim();if(Array.isArray(t.categories)&&t.categories.length){const b=t.categories.find(i=>typeof i=="string"&&i.trim());if(b)return b.trim()}return typeof t.name=="string"&&t.name.trim()?t.name.trim():typeof t.Name=="string"&&t.Name.trim()?t.Name.trim():typeof t.label=="string"&&t.label.trim()?t.label.trim():l},Zl=(t,l,a)=>{const b=new Map;let i=0,h=0,x=0;a.traverse(j=>{const O=!!j?.isInstancedMesh,D=!!j?.isMesh;if(!O&&!D)return;let C=0;if(O){let v=0;typeof j.count=="number"?v=j.count:typeof j.instanceCount=="number"?v=j.instanceCount:Array.isArray(j.instanceIdMap)?v=j.instanceIdMap.length:Array.isArray(j.userData?.ids)?v=j.userData.ids.length:typeof j.userData?.size=="number"&&(v=j.userData.size),Number.isFinite(v)&&v>0&&(C=v,h+=v)}else C=1,x+=1;C<=0&&(C=1),i+=C;const M=Jl(j?.userData??{},j?.type??"Mesh"),N=b.get(M)??0;b.set(M,N+C)});const g=Array.from(b.entries()).map(([j,O])=>({category:j,count:O})).sort((j,O)=>O.count-j.count),E=new st().setFromObject(a),m=new Z,k=new Z;return E.getSize(m),E.getCenter(k),{modelId:t,label:l,elementCount:i,instancedCount:h,meshCount:x,categoryCounts:g,bboxSize:{x:m.x,y:m.y,z:m.z},bboxCenter:{x:k.x,y:k.y,z:k.z},collectedAt:Date.now()}},Ql=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),qe=t=>{if(!t)return"";let l=t.replace(/[_\-]+/g," ");return l=l.replace(/([a-z\d])([A-Z])/g,"$1 $2"),l=l.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),l=l.replace(/\s+/g," ").trim(),l?l.split(" ").map(b=>{const i=b.toUpperCase();return Ql.has(i)||i.length<=3&&/^[A-Z]+$/.test(i)?i:/^\d+(\.\d+)?$/.test(b)||!b.length?b:b.charAt(0).toUpperCase()+b.slice(1)}).join(" "):""},ei=(t,l=200)=>t?t.length<=l?t:`${t.slice(0,l)}‚Ä¶`:"",Ae=t=>{if(t==null)return"";if(typeof t=="number")return Number.isFinite(t)?t.toString():"";if(typeof t=="boolean")return t?"true":"false";if(t instanceof Date)return t.toISOString();if(typeof t=="string")return t.trim();try{const l=JSON.stringify(t);return l?l.length>500?`${l.slice(0,500)}‚Ä¶`:l:""}catch{return String(t)}},Me=t=>t==null?"":typeof t!="object"?Ae(t):"value"in t?Me(t.value):"Value"in t?Me(t.Value):Array.isArray(t)?t.map(l=>Me(l)).filter(Boolean).join(", "):typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?`${Ae(t.x)}, ${Ae(t.y)}, ${Ae(t.z)}`:Ae(t),me=(t,l)=>{if(!t||typeof t!="object")return;const a=l.map(h=>h.toLowerCase()),b=new WeakSet,i=[t];for(;i.length;){const h=i.pop();if(!(!h||typeof h!="object")&&!b.has(h)){if(b.add(h),Array.isArray(h)){for(const x of h)x&&typeof x=="object"&&i.push(x);continue}for(const[x,g]of Object.entries(h)){const E=x.toLowerCase();if(a.some(m=>E.includes(m)))if(typeof g=="string"){const m=g.trim();if(m)return m}else{if(typeof g=="number"&&Number.isFinite(g))return g.toString();if(typeof g=="boolean")return g?"true":"false";if(g&&typeof g=="object"){const m=Me(g);if(m)return m}}g&&typeof g=="object"&&i.push(g)}}}},ti=(t,l)=>{if(!t||typeof t!="object")return So(t,300);const a=[],b=Ve(t)??me(t,["name","label","description"]);b&&a.push(`name:${b}`);const i=me(t,["category","ifcclass","ifc type","type"]);i&&a.push(`category:${i}`);const h=me(t,["globalid","global id","guid"]);h&&a.push(`globalId:${h}`);const x=me(t,["expressid","express id"]);if(x&&x!==h&&a.push(`expressId:${x}`),l>0)try{const{rows:E}=Yt(t);if(E.length){const k=E.slice(0,l).map(j=>`${j.label}=${j.value}`).join(" | ");k&&a.push(`props:${k}`),E.length>l&&a.push(`propsTruncated:${E.length-l}`)}}catch(E){console.warn("Failed to build detailed property data for AI summary",E)}const g=a.filter(Boolean).join(" | ");return g?g.length>1200?`${g.slice(0,1200)}‚Ä¶`:g:So(t,300)},In={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},oi=new Set(["modelIdMap"]),Et=t=>t.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),nt=t=>t?t.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Xt=["HasProperties","hasProperties","Properties","properties"],lr=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],Cn=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),wo=t=>{if(!t||typeof t!="object")return!1;const l=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return l&&l.toUpperCase()==="IFCPROPERTYSET"?!0:Xt.some(a=>Array.isArray(t[a]))},Pn=t=>{if(!t||typeof t!="object")return!1;const l=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return l&&l.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},ri=t=>{if(!t||typeof t!="object")return Ae(t);const l=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const a of l){if(!(a in t))continue;const b=t[a];if(b==null)continue;if(Array.isArray(b)){const h=b.map(x=>Me(x)).filter(Boolean).join(", ");if(h)return h;continue}const i=Me(b);if(i)return i}for(const[a,b]of Object.entries(t))if((typeof b=="string"||typeof b=="number"||typeof b=="boolean")&&a.toLowerCase().includes("value")){const i=Ae(b);if(i)return i}return""},ni=(t,l,a)=>{const b=Xt.map(g=>Array.isArray(t[g])?t[g]:null).filter(g=>!!g);if(!b.length)return[];const i=qe(l)||l,h=[],x=new Map;return b.flat().forEach((g,E)=>{if(!g||typeof g!="object"||!Pn(g))return;const m=Ve(g)??(typeof g.Name=="string"?g.Name:void 0)??(typeof g.PropertyName=="string"?g.PropertyName:void 0),k=`Property ${E+1}`,j=m&&m.trim().length?m.trim():k,O=qe(j)||j,D=ri(g),C=Et(j)||"property",M=(x.get(C)??0)+1;x.set(C,M);const N=`${C}-${M}`,v=`Property Sets / ${i} / ${O}`,$=[v.toLowerCase()];D&&$.push(D.toLowerCase()),h.push({label:v,value:D||"",path:`property-sets/${a}/${N}`,searchText:$.join(" ").trim(),rawPsetName:l,rawPropertyName:j,rawValue:g.__rawValue??g})}),h},Kt=t=>{if(!t||typeof t!="object")return[];const l=[],a=new WeakSet,b=new Map,i=D=>{let C;if(typeof D=="string"){const $=D.trim();$.length&&(C=$)}!C&&D&&typeof D=="object"&&(C=Ve(D)??(typeof D.Name=="string"?D.Name:void 0)??(typeof D.id=="string"?D.id:void 0)),(!C||!C.length)&&(C="Property Set");const M=qe(C)||C,N=Et(C)||"property-set",v=(b.get(N)??0)+1;return b.set(N,v),{rawName:C,friendlyName:M,uniqueKey:`${N}-${v}`}},h=(D,C,M)=>{const N=`Property ${M+1}`,v=D?.trim?.()?D.trim():N;if(Pn(C)){const $={...C};return $.Name==null&&$.PropertyName==null&&($.Name=v),$.PropertyName==null&&($.PropertyName=$.Name??v),$.__rawValue==null&&($.__rawValue=C),$}if(C&&typeof C=="object"){const $={...C};return $.Name==null&&$.PropertyName==null&&($.Name=v),$.PropertyName==null&&($.PropertyName=$.Name??v),$.type==null&&$.Type==null&&($.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in $)&&!("nominalValue"in $)&&!("Value"in $)&&!("value"in $)&&($.NominalValue=C),$.__rawValue=C,$}return{type:"IFCPROPERTYSINGLEVALUE",Name:v,PropertyName:v,NominalValue:C,__rawValue:C}},x=(D,C)=>{const M=[],N=(v,$)=>{const q=`Property ${M.length+1}`,he=(typeof v=="string"&&v.trim().length?v.trim():void 0)??Ve(v)??(typeof v?.Name=="string"?v.Name:void 0)??(typeof v?.PropertyName=="string"?v.PropertyName:void 0)??q;M.push(h(he,$,M.length))};if(C&&typeof C=="object")for(const v of Xt){const $=C[v];Array.isArray($)&&$.length&&$.forEach(q=>N(q,q))}if(!M.length)if(Array.isArray(C))C.forEach(v=>N(v,v));else if(C&&typeof C=="object")for(const[v,$]of Object.entries(C))$!=null&&(Cn.has(v)||Xt.includes(v)||lr.includes(v)||N(v,$));else C!=null&&N(void 0,C);return{type:"IFCPROPERTYSET",Name:D,HasProperties:M}},g=(D,C)=>{const N=ni(C&&typeof C=="object"?C:{},D.rawName,D.uniqueKey);N.length&&l.push(...N)},E=D=>{if(!(!D||typeof D!="object")&&!a.has(D)){if(a.add(D),Array.isArray(D)){D.forEach(C=>{if(!C||typeof C!="object")return;const M=i(C),N=wo(C)?C:x(M.rawName,C);g(M,N),N&&typeof N=="object"&&a.add(N)});return}for(const[C,M]of Object.entries(D)){if(M==null)continue;const N=i(C),v=wo(M)?M:x(N.rawName,M);g(N,v),M&&typeof M=="object"&&a.add(M)}}},m=D=>{if(!D||typeof D!="object"||a.has(D))return;if(a.add(D),Array.isArray(D)){D.forEach(m);return}let C=!1;for(const M of lr)Object.prototype.hasOwnProperty.call(D,M)&&(E(D[M]),C=!0);if(wo(D)){const M=i(D);g(M,D)}!C&&!wo(D)&&Object.entries(D).forEach(([M,N])=>{lr.includes(M)||Cn.has(M)||Xt.includes(M)||N&&typeof N=="object"&&m(N)})};m(t);const k=new Map,j=new Set;for(const D of l){const C=`${D.label}::${D.value}`;if(j.has(C))continue;const M=`${D.rawPsetName||"unknown"}::${D.rawPropertyName||"unknown"}::${D.value}`;k.has(M)||(j.add(C),k.set(M,D))}const O=Array.from(k.values());return l.length,O.length,O},ke={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Sn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],si=(t,l)=>{const a=typeof t=="string"?t.trim().toLowerCase():"";if(a&&Sn.some(b=>a.startsWith(b)))return!0;if(l&&typeof l=="object"){const b=Me(l._category??l.category??l.Category??null),i=typeof b=="string"?b.trim().toLowerCase():"";if(i&&Sn.some(x=>i.startsWith(x))||(l.NominalValue!=null||l.nominalValue!=null)&&(l.Name!=null||l.PropertyName!=null)&&a.includes("property"))return!0}return!1},jn="fragmentsViewer.favoritePropertyPaths",li=1e4,ii=500,Ve=t=>{if(!t||typeof t!="object")return;let l,a;typeof t.Name=="string"?l=t.Name:t.Name&&typeof t.Name=="object"&&(l=Me(t.Name)||void 0),typeof t.name=="string"?a=t.name:t.name&&typeof t.name=="object"&&(a=Me(t.name)||void 0);const b=l??a;if(!b)return;const i=b.trim();return i.length?i:void 0},Yt=t=>{if(!t||typeof t!="object")return{rows:[],tree:[]};const l=[],a=new WeakSet,b=(x,g,E)=>{if(x==null)return null;const m=g.map(v=>{const $=v?.trim?.()??v;return typeof $=="string"&&$.length?qe($)||$:typeof v=="string"?v:String(v??"")}),k=m.filter(Boolean).join(" / "),j=E.length?E.join("/"):Et(k||"value"),O=m[m.length-1]??"Value",D=v=>{const $=k.toLowerCase(),q=[$];v&&q.push(v.toLowerCase());const he=q.join(" ").trim()||$,Q={label:k,value:v??"",path:j,searchText:he};return l.push(Q),he};if(typeof x!="object"||x instanceof Date){const v=Ae(x),$=D(v);return{id:j,label:O,fullLabel:k,value:v||void 0,children:[],searchText:$}}if(a.has(x)){const v="[Circular reference]",$=D(v);return{id:j,label:O,fullLabel:k,value:v,children:[],searchText:$}}a.add(x);let C;const M=[];if(Array.isArray(x))x.forEach((v,$)=>{const q=Ve(v),he=`${O} ${$+1}`,Q=q&&q.trim().length?q.trim():he,J=qe(Q)||Q,re=q&&q.trim().length?Et(q):String($),Y=b(v,[...g,J],[...E,re]);Y&&M.push(Y)}),M.length===0&&(C=Ae(x));else{if("NominalValue"in x||"nominalValue"in x){const v=x.NominalValue??x.nominalValue,$=Me(v);$&&(C=$)}!C&&"value"in x&&typeof x.value!="object"&&(C=Ae(x.value)),!C&&"Value"in x&&typeof x.Value!="object"&&(C=Ae(x.Value));for(const[v,$]of Object.entries(x)){if($==null||v==="Name"||v==="name"||v==="IsDefinedBy"||v==="isDefinedBy"||v==="psets"||v==="Psets"||v==="propertySets"||v==="PropertySets"||v==="property_sets"||v==="Property_Sets")continue;if(v==="NominalValue"||v==="nominalValue"){const Re=qe("Nominal Value")||"Nominal Value",Ce=b($,[...g,Re],[...E,"nominal-value"]);Ce&&M.push(Ce);continue}const q=In[v]??v,he=qe(q)||q,Q=Ve($)?.trim(),J=Q&&Q.length?qe(Q)||Q:he,re=Q&&Q.length?Et(Q):Et(q),Y=[...g,J],H=b($,Y,[...E,re]);H&&M.push(H)}!C&&M.length===0&&(C=Ae(x))}const N=D(C);return{id:j,label:O,fullLabel:k,value:C,children:M,searchText:N}},i=[];for(const[x,g]of Object.entries(t)){if(g==null||oi.has(x))continue;const E=In[x]??x,m=b(g,[E],[x]);m&&i.push(m)}if(l.length){const x=l.filter(g=>{const E=g.label.toLowerCase();return E.startsWith("property sets /")?!(E.includes("/ has properties")||E.includes("/ nominal value")):!0});x.length!==l.length&&l.splice(0,l.length,...x)}const h=Kt(t);if(h.length){const x=[],g=new Set;for(const m of h)g.has(m.path)||(g.add(m.path),x.push(m));const E=[];for(const m of l)g.has(m.path)||E.push(m);l.splice(0,l.length,...x,...E)}return{rows:l,tree:i}},ai=()=>{const t=d.useRef(null),l=d.useRef(null),a=d.useRef(null),b=d.useRef(null),i=d.useRef(null),h=d.useRef(!1),x=d.useRef(null),g=d.useRef(null),E=d.useRef(null),[m,k]=d.useState(!1),[j,O]=d.useState([]),[D,C]=d.useState(!1),[M,N]=d.useState(50);d.useCallback(async(e,r)=>{{console.warn("dumpModelRawData is dev-only.");return}},[j]),d.useCallback(async(e,r=50,s=128)=>{},[]);const[v,$]=d.useState([]),[q,he]=d.useState(null),[Q,J]=d.useState(!0),[re,Y]=d.useState(!1),[H,Re]=d.useState(!1),[Ce,Ke]=d.useState(null),[Mt,_e]=d.useState(!1),[be,Be]=d.useState(!1),Rt=d.useRef(null),Ye=d.useRef(!1),ze=d.useRef(null),Ge=d.useRef(null),Zt=d.useRef(0),$e=d.useRef(null),Qt=d.useRef(null);d.useRef(null);const Fe=d.useRef(null),eo=d.useRef(!1),gt=d.useRef(null),jo=d.useRef("click"),[to,An]=d.useState({width:360,height:520}),vo=d.useRef(null),oo=d.useRef(!1),ko=d.useRef(null),cr=d.useRef(!1),dr=d.useRef(null),at=d.useRef(null),Eo=d.useRef(null),ro=d.useRef(null),Po=d.useRef(null),zt=d.useRef(null),ur=d.useRef(null),fr=d.useRef(null),We=d.useRef(null),Te=d.useRef([]),Ne=d.useRef(null),$t=d.useRef(null),yt=d.useRef(null),[no,Ee]=d.useState(null),[ae,Mn]=d.useState([]),[pr,Rn]=d.useState(""),[bt,zn]=d.useState(""),[Se,mr]=d.useState([]),[ct,hr]=d.useState("favorites"),[$n,ci]=d.useState(!1),[Dn,di]=d.useState(!1),[Fn,ui]=d.useState(!1),[dt,Tn]=d.useState("models"),[Xe,Ao]=d.useState(!1),[Nn,gr]=d.useState(0),[Je,so]=d.useState(!1),[On,yr]=d.useState(!1),[Ln,br]=d.useState(!1),[ge,Mo]=d.useState("disabled"),[Ue,Ro]=d.useState(""),[Dt,lo]=d.useState(""),[zo,xr]=d.useState(!1),[wr,Ir]=d.useState(!1),[Cr,xt]=d.useState(null),[xe,Sr]=d.useState("click"),[wt,Vn]=d.useState(!1),[It,_n]=d.useState(!1),$o=d.useRef(!1),Bn=d.useRef(new Map),jr=d.useRef(null),Ft=d.useRef(!1),vr=d.useRef(new Map),[Gn,Do]=d.useState(0),[Ze,kr]=d.useState(!1),[Er,Wn]=d.useState({}),[Fo,Pr]=d.useState(null),[Tt,Ar]=d.useState([]),[Un,To]=d.useState(!1),[Qe,Mr]=d.useState("selected"),[et,io]=d.useState(""),[ut,Rr]=d.useState(!1),[zr,ao]=d.useState(null),[Ct,No]=d.useState(!1),[ne,co]=d.useState({x:!1,y:!1,z:!1}),[Oe,$r]=d.useState({x:0,y:0,z:0}),[Nt,Dr]=d.useState(!1),[Ot,Hn]=d.useState(!1),Lt=d.useRef(!1),Oo=d.useRef([]),Lo=d.useRef(new Map),uo=d.useRef(null),[Fr,Tr]=d.useState(null),Nr=d.useRef(null),ft=d.useCallback(()=>a.current?.camera??null,[]),Vo=d.useCallback(()=>ft()?.three??null,[ft]);d.useEffect(()=>{jo.current=xe},[xe]),d.useEffect(()=>{const e=Nr.current;!e||!("mouseButtons"in e)||(xe==="rectangle"?e.mouseButtons={left:0,middle:2,right:0,wheel:16}:e.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),d.useEffect(()=>{try{const e=window.localStorage.getItem(jn);if(!e)return;const r=JSON.parse(e);if(!Array.isArray(r))return;const s=r.filter(n=>typeof n=="string"&&n.trim().length>0);s.length&&mr(s)}catch(e){console.warn("Failed to restore favourites from storage",e)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(jn,JSON.stringify(Se))}catch(e){console.warn("Failed to persist favourites to storage",e)}},[Se]);const fo=pr.trim(),qn=fo.length>0,Or=d.useMemo(()=>{const e=fo.toLowerCase();return e?ae.filter(r=>r.searchText.includes(e)).slice(0,ii):[]},[fo,ae]),po=d.useMemo(()=>{const e=new Map;return ae.forEach(r=>e.set(r.path,r)),e},[ae]),_o=d.useMemo(()=>ae.slice(0,li),[ae]),Lr=Math.max(ae.length-_o.length,0),Vr=d.useMemo(()=>new Set(Se),[Se]),Bo=d.useMemo(()=>Se.length?Se.map(e=>po.get(e)).filter(e=>!!e):[],[Se,po]),Go=d.useMemo(()=>{if(!Se.length)return 0;let e=0;for(const r of Se)po.has(r)||(e+=1);return e},[Se,po]),_r=d.useCallback(e=>{mr(r=>r.includes(e)?r.filter(s=>s!==e):[...r,e])},[]),mo=d.useMemo(()=>j.map(e=>`${e.id}:${e.label}`).join("|"),[j]),Wo=d.useCallback(e=>{const r=Vr.has(e.path);return o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[o.jsx(U,{variant:"body2",sx:{fontWeight:600},children:e.label}),o.jsx(te,{title:r?"Remove from favourites":"Add to favourites",children:o.jsx("span",{children:o.jsx(ee,{size:"small",onClick:()=>_r(e.path),color:r?"primary":"default",children:r?o.jsx(Es,{fontSize:"small"}):o.jsx(Ps,{fontSize:"small"})})})})]}),o.jsx(U,{variant:"body2",color:"text.secondary",children:e.value?ei(e.value,360):"‚Äî"})]},e.path)},[Vr,_r]);d.useEffect(()=>{if(!j.length){io("");return}io(e=>e&&j.some(r=>r.id===e)?e:j[0].id)},[j]);const Br=d.useCallback(async e=>{const r=i.current;if(!r)return[];const s=r.list.get(e);if(!s)return[];let n=[];try{const f=await s.getLocalIds();Array.isArray(f)?n=f:f&&typeof f[Symbol.iterator]=="function"&&(n=Array.from(f))}catch(f){return console.warn(`Failed to retrieve local IDs for model ${e}`,f),[]}if(!n.length)return[];const c=32,u=[];for(let f=0;f<n.length;f+=c){const p=n.slice(f,f+c);let y=[];try{y=await s.getItemsData(p,ke)}catch(w){console.warn(`Failed to fetch items data for model ${e} chunk starting at ${p[0]}`,w);continue}y.forEach((w,A)=>{const z=p[A];if(w)try{const{rows:F}=Yt(w);F.forEach(S=>{u.push({path:`localId:${z} / ${S.label}`,value:S.value})})}catch(F){console.warn(`Failed to process properties for model ${e} localId ${z}`,F)}})}return u},[]),Gr=d.useCallback(e=>{const r=[];return r.push("Path,Value"),e.forEach(({path:s,value:n})=>{const c=s.replace(/"/g,'""'),u=(n??"").replace(/"/g,'""');r.push(`"${c}","${u}"`)}),r.join(`\r
`)},[]),Kn=d.useCallback(()=>{ao(null),Mr(ae.length?"selected":"model"),j.length&&!j.some(e=>e.id===et)&&io(j[0].id),To(!0)},[ae.length,j,et]),Yn=d.useCallback(async()=>{if(!q){alert("No element selected");return}try{const e=new WeakSet,r=JSON.stringify(q,(s,n)=>{if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular Reference]";e.add(n)}return n instanceof Map?`[Map with ${n.size} entries]`:n instanceof Set?`[Set with ${n.size} items]`:n instanceof WeakMap||n instanceof WeakSet?"[WeakMap/WeakSet]":typeof n=="function"?"[Function]":typeof n=="symbol"?"[Symbol]":n},2);await navigator.clipboard.writeText(r),alert("Raw element data copied to clipboard!")}catch(e){console.error("Failed to copy raw data:",e),alert("Failed to copy data to clipboard. See console for details.")}},[q]),Wr=d.useCallback(()=>{ut||(To(!1),ao(null))},[ut]),Xn=d.useCallback(async()=>{if(!ut){Rr(!0),ao(null);try{let e=[];if(Qe==="selected"){if(!ae.length)throw new Error("No properties available for the current selection.");e=ae.map(p=>({path:p.label,value:p.value}))}else{if(!et)throw new Error("Select a model to export.");if(e=await Br(et),!e.length)throw new Error("No properties were found for the chosen model.")}const r=Gr(e),s=new Blob([r],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),c=document.createElement("a"),u=Qe==="selected"?"selection":`model-${et}`,f=new Date().toISOString().replace(/[:.]/g,"-");c.href=n,c.download=`fragment-properties-${u}-${f}.csv`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(n),To(!1)}catch(e){console.warn("Failed to export properties",e),ao(e.message??"Failed to export properties.")}finally{Rr(!1)}}},[Gr,et,Qe,Br,ut,ae]),Pe=d.useCallback(e=>{const r=e??null;he(r);const{rows:s}=Yt(r);if(Mn(s),hr(Se.length?"favorites":"all"),s.length){Ar(s.map(u=>({path:u.label,value:u.value})));const n="Path	Value",c=s.map(u=>`${u.label}	${u.value??""}`);Pr([n,...c].join(`\r
`))}else Ar([]),Pr(null)},[Se.length]),Ur=d.useCallback(()=>{kr(e=>!e)},[]),Jn=d.useCallback(()=>{Ao(!0),gr(e=>e+1)},[]),Zn=d.useCallback(()=>{Ao(!1)},[]),Hr=d.useCallback(()=>{Ao(e=>{const r=!e;return r&&gr(s=>s+1),r})},[]),Qn=d.useCallback(()=>{yr(!0)},[]),qr=d.useCallback(()=>{yr(!1)},[]),Kr=d.useCallback(()=>{const e=xl();e?(Mo(e.provider),Ro(e.apiKey),lo(e.model||bo(e.provider))):(Mo("disabled"),Ro(""),lo("")),xt(null),br(!0)},[]),ho=d.useCallback(()=>{br(!1),xr(!1),xt(null)},[]),es=d.useCallback(()=>{if(ge==="disabled")wl();else{const e={provider:ge,apiKey:Ue,model:Dt||bo(ge)};bl(e)}ho()},[ge,Ue,Dt,ho]),ts=d.useCallback(e=>{Mo(e),lo(bo(e)),xt(null)},[]),os=d.useCallback(async()=>{if(!(!Ue||ge==="disabled")){Ir(!0),xt(null);try{let e=!1;const r=Dt||bo(ge);ge==="gemini"?e=await Sl(Ue,r):ge==="openai"&&(e=await vl(Ue,r)),xt(e?"success":"error")}catch{xt("error")}finally{Ir(!1)}}},[ge,Ue,Dt]),Vt=d.useCallback(e=>{if(!e||typeof e!="object")return"IfcProduct";if(e.constructor&&typeof e.constructor.name=="string"&&e.constructor.name.toUpperCase().startsWith("IFC")){const c=e.constructor.name.trim();if(c!=="Object"&&c!=="Array")return c}const r=Me(e._category??e.category??e.Category??null);if(r&&r.trim().length&&r.toUpperCase().startsWith("IFC"))return r.trim();const s=[e.expressID!==void 0?null:e.type,e.ifcClass,e.IfcClass,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.ifcType,e.IfcType,e?.attributes?.ifcClass,e?.Attributes?.IfcClass];for(const c of s)if(typeof c=="string"&&c.trim().length){const u=c.trim();if(u.toUpperCase().startsWith("IFC")&&!u.toUpperCase().includes("IDENTIFIER")&&!u.toUpperCase().includes("LABEL")&&!u.toUpperCase().includes("TEXT"))return u}const n=me(e,["ifcclass","ifc type","express type"]);return n&&n.toUpperCase().startsWith("IFC")?n:"IfcProduct"},[]),Uo=d.useCallback((e,r,s)=>{const n={},c={},u={};Kt(e).forEach(A=>{const z=A.label.split("/").map(L=>L.trim()),F=A.rawPsetName??z[1]??"",S=A.rawPropertyName??z[z.length-1]??"",I=nt(F),P=nt(S);if(!I||!P)return;c[I]||(c[I]={}),P in c[I]||(c[I][P]=A.value);const _=`${I}.${P}`;_ in n||(n[_]=A.value)}),n.GlobalId=r,n.ifcClass=s,u.ifcClass=s,u.GlobalId=r,n["Attributes.GlobalId"]=r,n["Attributes.IfcClass"]=s,n["Attributes.ifcClass"]=s;const p=Ve(e);p&&(u.Name=p,n["Attributes.Name"]=p);const y=me(e,["category","ifccategory"]);y&&(u.Category=y,n["Attributes.Category"]=y);const w=me(e,["type","typename"]);w&&(u.Type=w,n["Attributes.Type"]=w);for(const[A,z]of Object.entries(e??{})){if(z==null||typeof z!="object"||Array.isArray(z))continue;const F=Me(z);if(!F)continue;const S=String(A).replace(/^_+/,""),I=`Attributes.${qe(S)}`;if(I in n||(n[I]=F),S in u||(u[S]=F),/guid|globalid|_guid/i.test(A)){const P=String(F).trim();P&&!n.GlobalId&&(n.GlobalId=P,u.GlobalId=P)}}return{flattened:n,psets:c,attributes:u}},[]),Ho=d.useCallback(()=>{const e=i.current;return e?`${Array.from(e.list.keys()).sort().join("|")}|${j.length}`:"empty"},[j]),rs=d.useCallback(async()=>{console.log("üîë [computeModelSignature] START");const e=i.current;if(!e||e.list.size===0)return console.log("‚ö†Ô∏è [computeModelSignature] No fragments available"),{signature:"empty",elementCount:0,modelFiles:[]};console.log(`üìä [computeModelSignature] Found ${e.list.size} models in fragments`);const r=Array.from(e.list.keys()).sort();console.log("üîë [computeModelSignature] Model IDs:",r);const s=j.map(p=>({id:p.id,name:p.label}));console.log("üìÅ [computeModelSignature] Model files:",s),console.log("üî¢ [computeModelSignature] Counting elements across all models...");let n=0;for(const[p,y]of e.list){console.log(`üîç [computeModelSignature] Getting local IDs for model ${p}...`);try{const w=await y.getLocalIds();console.log(`‚úÖ [computeModelSignature] Got local IDs for model ${p}, type:`,typeof w);const A=Array.isArray(w)?w:w&&typeof w[Symbol.iterator]=="function"?Array.from(w):[];console.log(`üìä [computeModelSignature] Model ${p} has ${A.length} elements`),n+=A.length}catch(w){console.error(`‚ùå [computeModelSignature] Failed to count elements in model ${p}`,w)}}console.log(`üìä [computeModelSignature] Total elements across all models: ${n}`);const u=[...r,...j.map(p=>`${p.id}:${p.label}`),`count:${n}`].join("|");console.log("üîë [computeModelSignature] Generated signature (first 100 chars):",u.substring(0,100));const f={signature:u,elementCount:n,modelFiles:s};return console.log("‚úÖ [computeModelSignature] COMPLETE:",f),f},[j]),go=d.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0){const n={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Ne.current=n,n}const r=Ho();if(Ne.current&&Ne.current.signature===r)return Ne.current;if($t.current)return $t.current;const s=(async()=>{const n=new Map,c=[],u=new Map;for(const[p,y]of e.list){let w=[];try{const z=await y.getLocalIds();Array.isArray(z)?w=z:z&&typeof z[Symbol.iterator]=="function"&&(w=Array.from(z))}catch(z){console.warn(`IDS cache: failed to read local IDs for model ${p}`,z);continue}if(u.set(p,w.slice()),!w.length)continue;const A=48;for(let z=0;z<w.length;z+=A){const F=w.slice(z,z+A);let S=[];try{S=await y.getItemsData(F,ke)}catch(I){console.warn(`IDS cache: failed to fetch items data for model ${p}`,I);continue}S.forEach((I,P)=>{if(!I)return;const _=F[P],L=Vt(I),V=typeof I.GlobalId=="string"&&I.GlobalId.trim()||typeof I.GlobalID=="string"&&I.GlobalID.trim()||me(I,["globalid","global id","guid"]);if(!V){if(si(L,I))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:p,localId:_,itemData:I});return}const R=V.trim();if(!R.length||n.has(R))return;const{flattened:T,psets:B,attributes:K}=Uo(I,R,L),X={GlobalId:R,ifcClass:L,properties:T},G=I;(typeof G.GlobalId!="string"||!G.GlobalId.trim())&&(G.GlobalId=R),n.set(R,{element:X,modelId:p,localId:_,psets:B,attributes:K,raw:G}),c.push(X)})}}const f={signature:r,records:n,elements:c,modelLocalIds:u};return Ne.current=f,f})().finally(()=>{$t.current=null});return $t.current=s,s},[Ho,Uo,Vt]),St=d.useCallback(async e=>{const r=new Map,s=i.current;if(!s)return console.error("üîç [groupLocalIdsByModel] Fragments not available"),{grouped:r,cache:Ne.current};for(const[n,c]of s.list)try{const u=await c.getLocalIdsByGuids(e),f=[];for(let p=0;p<u.length;p++){const y=u[p];y!==null&&f.push(y)}f.length>0&&r.set(n,f)}catch(u){console.warn(`üîç [groupLocalIdsByModel] Failed for model ${n}:`,u)}return{grouped:r,cache:Ne.current}},[]),qo=At.useMemo(()=>({listGlobalIds:async()=>(await go()).elements.map(r=>r.GlobalId),getSelectedGlobalIds:async()=>{console.log("üìç getSelectedGlobalIds called, selectedRef.current:",Te.current);const e=Te.current;if(!e||e.length===0)return console.log("üìç No selection found"),[];const r=i.current;if(!r)return console.warn("üìç Fragments not available"),[];console.log("üìç Processing selection:",e);const s=[];for(const n of e){const c=r.list.get(n.modelId);if(!c){console.warn("üìç Model not found for item:",n);continue}try{const[u]=await c.getItemsData([n.localId],{attributesDefault:!1});if(u){const f=me(u,["globalid","global id","guid"]);f&&typeof f=="string"?(s.push(f),console.log("üìç Found GlobalId for item:",n,"‚Üí",f)):console.warn("üìç No GlobalId found in data for item:",n)}}catch(u){console.error("üìç Error fetching data for item:",n,u)}}return console.log("üìç Final selectedGlobalIds:",s),s},getVisibleGlobalIds:async()=>{console.log("üëÅÔ∏è getVisibleGlobalIds called");const e=i.current;if(!e)return console.warn("üëÅÔ∏è Fragments not available"),[];const r=[];for(const[s,n]of e.list)try{console.log(`üëÅÔ∏è Getting visible elements from model: ${s}`);const c=await n.getItemsByVisibility(!0);if(console.log(`üëÅÔ∏è Model ${s}: ${c.length} visible elements`),c.length===0)continue;const u=100;for(let f=0;f<c.length;f+=u){const p=c.slice(f,Math.min(f+u,c.length));try{const y=await n.getItemsData(p,{attributesDefault:!1,attributes:["GlobalId"]});for(const w of y){const A=me(w,["globalid","global id","guid"]);A&&typeof A=="string"&&r.push(A)}}catch(y){console.error(`üëÅÔ∏è Error fetching GlobalIds for batch in model ${s}:`,y)}}}catch(c){console.error(`üëÅÔ∏è Error getting visible elements from model ${s}:`,c)}return console.log(`üëÅÔ∏è Total visible GlobalIds: ${r.length}`),r},getElementProps:async e=>{console.log("üîç [getElementProps] START for",e);const r=i.current;if(!r)throw new Error("Fragments not available");console.log("üîç [getElementProps] Searching across",r.list.size,"models");for(const[s,n]of r.list)try{const u=(await n.getLocalIdsByGuids([e]))[0];if(u!=null){console.log(`üîç [getElementProps] Found in model ${s}, localId: ${u}`);const[f]=await n.getItemsData([u],ke);if(!f){console.warn(`üîç [getElementProps] No data returned for localId ${u}`);continue}console.log("üîç [getElementProps] Got data, extracting properties...");const p=Vt(f);console.log("üîç [getElementProps] ifcClass:",p);const y={},w={},A=Kt(f);console.log("üîç [getElementProps] Got",A.length,"property rows"),A.forEach(I=>{const P=I.label.split("/").map(T=>T.trim()),_=I.rawPsetName??P[1]??"",L=I.rawPropertyName??P[P.length-1]??"",V=nt(_),R=nt(L);!V||!R||(y[V]||(y[V]={}),R in y[V]||(y[V][R]=I.value))}),w.ifcClass=p,w.GlobalId=e;const z=Ve(f);z&&(w.Name=z);const F=me(f,["category","ifccategory"]);F&&(w.Category=F);const S=me(f,["type","typename"]);return S&&(w.Type=S),console.log(`üîç [getElementProps] SUCCESS: ${Object.keys(y).length} psets, ${Object.keys(w).length} attributes`),{ifcClass:p,psets:y,attributes:w}}}catch(c){console.warn(`üîç [getElementProps] Error in model ${s}:`,c);continue}throw console.error(`üîç [getElementProps] Element with GlobalId ${e} not found in any model`),new Error(`Element with GlobalId ${e} is not available.`)},getElementPropsFast:async e=>{console.log("üîç [getElementPropsFast] START for",e);const r=Te.current,s=i.current;if(console.log("üîç [getElementPropsFast] Selection:",r),console.log("üîç [getElementPropsFast] Fragments available:",!!s),!s)throw console.error("üîç [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");console.log("üîç [getElementPropsFast] Searching in",r.length,"selected items");for(let n=0;n<r.length;n++){const c=r[n];console.log(`üîç [getElementPropsFast] Checking item ${n+1}/${r.length}:`,c);const u=s.list.get(c.modelId);if(!u){console.log(`üîç [getElementPropsFast] Model not found for ${c.modelId}`);continue}try{console.log(`üîç [getElementPropsFast] Calling getItemsData for localId ${c.localId}...`);const[f]=await u.getItemsData([c.localId],ke);if(console.log("üîç [getElementPropsFast] Got data:",!!f),f){console.log("üîç [getElementPropsFast] Data keys:",Object.keys(f)),console.log("üîç [getElementPropsFast] data._category:",f._category),console.log("üîç [getElementPropsFast] data.ifcClass:",f.ifcClass),console.log("üîç [getElementPropsFast] data.type:",f.type),console.log("üîç [getElementPropsFast] data.constructor.name:",f.constructor?.name);const p=me(f,["globalid","global id","guid"]);if(console.log(`üîç [getElementPropsFast] Element GlobalId: ${p}, looking for: ${e}`),p===e){console.log("üîç [getElementPropsFast] MATCH! Extracting properties...");const y=Vt(f);console.log("üîç [getElementPropsFast] ifcClass extracted:",y);const w={},A={};console.log("üîç [getElementPropsFast] Calling collectIfcPropertySetRows...");const z=Kt(f);console.log("üîç [getElementPropsFast] Got",z.length,"property rows"),z.forEach(P=>{const _=P.label.split("/").map(B=>B.trim()),L=P.rawPsetName??_[1]??"",V=P.rawPropertyName??_[_.length-1]??"",R=nt(L),T=nt(V);!R||!T||(w[R]||(w[R]={}),T in w[R]||(w[R][T]=P.value))}),console.log("üîç [getElementPropsFast] Extracted",Object.keys(w).length,"psets"),A.ifcClass=y,A.GlobalId=e;const F=Ve(f);F&&(A.Name=F);const S=me(f,["category","ifccategory"]);S&&(A.Category=S);const I=me(f,["type","typename"]);return I&&(A.Type=I),console.log(`üìå Fast props for ${e}:`,{ifcClass:y,psetCount:Object.keys(w).length}),console.log("üîç [getElementPropsFast] SUCCESS - returning properties"),{ifcClass:y,psets:w,attributes:A}}}}catch(f){console.error("üîç [getElementPropsFast] Error for item:",c,f)}}return console.log(`üìå ${e} not in selection, falling back to cache`),console.log("üîç [getElementPropsFast] FALLBACK to getElementProps"),yt.current.getElementProps(e)},countElements:async()=>(await go()).elements.length,iterElements:e=>{const r=Math.max(1,Math.floor(e?.batchSize??500));return console.log("üîÑ [viewerApi.iterElements] START",{batchSize:r}),{async*[Symbol.asyncIterator](){const s=i.current;if(!s||s.list.size===0){console.warn("‚ö†Ô∏è [viewerApi.iterElements] No fragments available");return}console.log(`üîÑ [viewerApi.iterElements] Processing ${s.list.size} models with batch size ${r}`);let n=[],c=0;for(const[u,f]of s.list){let p=[];try{const w=await f.getLocalIds();p=Array.isArray(w)?w:w&&typeof w[Symbol.iterator]=="function"?Array.from(w):[],console.log(`‚úÖ [viewerApi.iterElements] Model ${u}: ${p.length} elements`)}catch(w){console.error(`‚ùå [viewerApi.iterElements] Failed to get local IDs for model ${u}`,w);continue}const y=Math.min(500,Math.max(100,r));for(let w=0;w<p.length;w+=y){const A=p.slice(w,w+y);try{const z=await f.getItemsData(A,ke);for(let F=0;F<z.length;F++){const S=z[F];S&&n.push({modelId:u,localId:A[F],data:S})}for(;n.length>=r;){const F=n.splice(0,r);c+=F.length,(c%5e3===0||c===r)&&console.log(`üì§ [viewerApi.iterElements] Yielded ${c} elements...`),yield F}}catch(z){console.error(`‚ùå [viewerApi.iterElements] Failed to fetch chunk at ${w}`,z)}}}n.length>0&&(c+=n.length,yield n),console.log(`‚úÖ [viewerApi.iterElements] Complete: ${c} elements`)}}},_iterElementsLegacy:e=>{const r=Math.max(1,Math.floor(e?.batchSize??100));return{async*[Symbol.asyncIterator](){const s=await go(),n=Array.from(s.records.values());for(let c=0;c<n.length;c+=r){const u=n.slice(c,c+r).map(f=>({modelId:f.modelId,localId:f.localId,data:{...f.raw,GlobalId:f.element.GlobalId}}));u.length&&(yield u)}}}},buildIdsCache:async()=>{try{return(await go()).elements.length}catch(e){throw console.error("viewerApi.buildIdsCache failed",e),e}},getModelSignature:async()=>await rs(),addToCache:async e=>{console.log(`üì¶ [addToCache] Adding ${e.length} elements to cache`);const r=i.current;if(!r){console.warn("üì¶ [addToCache] Fragments not available");return}let s=Ne.current;s||(s={signature:Ho(),records:new Map,elements:[],modelLocalIds:new Map},Ne.current=s);const n=Te.current;console.log(`üì¶ [addToCache] Selection has ${n.length} items`);for(const c of e){if(s.records.has(c)){console.log(`üì¶ [addToCache] ${c} already in cache, skipping`);continue}console.log(`üì¶ [addToCache] Searching for ${c} in ${n.length} selected items...`);let u=!1;for(const f of n){console.log(`üì¶ [addToCache] Checking item: modelId=${f.modelId}, localId=${f.localId}`);const p=r.list.get(f.modelId);if(!p){console.log(`üì¶ [addToCache] Model not found: ${f.modelId}`);continue}try{const[y]=await p.getItemsData([f.localId],ke);if(y){let w=y._guid||y.GlobalId;if(w&&typeof w=="object"&&(w=w.value||w),console.log(`üì¶ [addToCache] Item GlobalId: ${w}, looking for: ${c}, match: ${w===c}`),w===c){const A=Vt(y),z={};Kt(y).forEach(T=>{const B=T.label.split("/").map(se=>se.trim()),K=T.rawPsetName??B[1]??"",X=T.rawPropertyName??B[B.length-1]??"",G=nt(K),pe=nt(X);!G||!pe||(z[G]||(z[G]={}),pe in z[G]||(z[G][pe]=T.value))});const S={ifcClass:A,GlobalId:c},I=Ve(y);I&&(S.Name=I);const P=me(y,["category","ifccategory"]);P&&(S.Category=P);const _=me(y,["type","typename"]);_&&(S.Type=_);const L={GlobalId:c,ifcClass:A,properties:Uo(y,c,A)},V={element:L,modelId:f.modelId,localId:f.localId,psets:z,attributes:S,raw:y};s.records.set(c,V),s.elements.push(L);const R=s.modelLocalIds.get(f.modelId)||[];R.push(f.localId),s.modelLocalIds.set(f.modelId,R),console.log(`üì¶ [addToCache] Added ${c} to cache (model: ${f.modelId}, localId: ${f.localId})`),u=!0;break}}}catch(y){console.debug("üì¶ [addToCache] Error checking selection item:",y)}}u||console.warn(`üì¶ [addToCache] Could not find ${c} in selection`)}console.log(`üì¶ [addToCache] Cache now has ${s.records.size} elements`)},color:async(e,r)=>{if(!e.length)return;const s=$e.current,n=i.current,c=a.current;if(!s||!h.current||!n||!c)return;console.log(`üé® [color] Called with ${e.length} GlobalIds, rgba:`,r);let u,f;try{const w=await St(e);u=w.grouped,f=w.cache}catch(w){console.error("üé® [color] groupLocalIdsByModel failed:",w);return}const p=new De(r.r,r.g,r.b),y=p.getHex();console.log(`üé® [color] Grouped into ${u.size} models, colorHex: ${y.toString(16)}`),Qt.current||(Qt.current=new Map);for(const[w,A]of u){const z=n.list.get(w);if(!(!z||!A.length)){console.log(`üé® [color] Processing model ${w} with ${A.length} localIds`);try{const F=Array.from(A);if(typeof s.add=="function")try{if(console.log(`üé® [color] Trying highlighter.add with colorHex: ${y.toString(16)}`),s.add(z,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${w} using add method`),c&&typeof c.update=="function")try{c.update(),console.log("üé® [color] Forced world update")}catch(S){console.debug("World update failed:",S)}continue}catch(S){console.debug("add failed:",S)}if(typeof s.highlightById=="function")try{console.log("üé® [color] Trying highlightById..."),await s.highlightById(z,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${w} using highlightById`);continue}catch(S){console.debug("highlightById failed:",S)}if(typeof s.highlightByID=="function")try{console.log("üé® [color] Trying highlightByID..."),await s.highlightByID(z,F,y),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${w} using highlightByID`);continue}catch(S){console.debug("highlightByID failed:",S)}if(s.styles&&typeof s.styles.set=="function")try{if(!F||F.length===0){console.debug(`Skipping highlight for model ${w} - no IDs`);continue}const S=`ids-color-${y.toString(16).padStart(6,"0")}`;if(s.styles.set(S,{color:p,fillOpacity:1}),typeof s.create=="function")try{(!s.list||!s.list.has(S))&&s.create(S)}catch(I){console.debug("highlighter.create failed:",I)}if(typeof s.select=="function")try{s.select(z,F,S)}catch(I){throw console.debug("highlighter.select failed:",I),I}console.log(`‚úÖ Successfully colored ${F.length} elements in model ${w} using styles.set`);continue}catch(S){console.debug("styles.set failed:",S)}console.warn(`‚ùå Could not color model ${w} - all highlighter methods failed`)}catch(F){console.error(`Failed to color model ${w}:`,F)}}}},clearColors:async()=>{const e=$e.current,r=i.current;if(!h.current||!r)return;const s=vr.current;if(s.size>0){for(const[n,c]of s){const{color:u,transparent:f,opacity:p}=c;n.transparent=f,n.opacity=p,"color"in n?n.color.setHex(u):n.lodColor.setHex(u),n.needsUpdate=!0}s.clear()}e&&Ft.current&&(e.enabled=!0,Ft.current=!1),r&&(r.resetHighlight(),r.core.update(!0));try{if(e){if(e.styles&&typeof e.styles.delete=="function")try{e.styles.delete("ghost")}catch(n){console.warn("Failed to clear ghost styles",n)}typeof e.clear=="function"&&await Promise.resolve(e.clear()),e.styles&&typeof e.styles.clear=="function"&&e.styles.clear()}}catch(n){console.warn("Failed to clear IDS highlights",n)}Qt.current&&Qt.current.clear();try{const n=Ge.current;if(n&&n.mesh&&n.mesh.instanceColor){const c=new De(1,1,1);n.mesh.setColorAt(n.index,c),n.mesh.instanceColor.needsUpdate=!0}}catch{}},isolate:async e=>{const r=We.current,s=i.current;if(!r||!s||!h.current||(await Promise.resolve(r.set(!0)),!e.length||!h.current))return;const{grouped:n}=await St(e);if(n.size===0){console.warn("isolate: No elements found in cache for isolation");return}const c=new Map;n.forEach((f,p)=>{c.set(p,new Set(f))});const u={};for(const[f,p]of c.entries()){const y=s.list.get(f);if(y)try{let w=[];const A=await y.getLocalIds();Array.isArray(A)?w=A:A&&typeof A[Symbol.iterator]=="function"&&(w=Array.from(A));const z=w.filter(F=>!p.has(F));z.length>0&&(u[f]=new Set(z))}catch(w){console.error("isolate: Failed to get local IDs for model",f,w)}}Object.keys(u).length>0&&await Promise.resolve(r.set(!1,u))},clearIsolation:async()=>{const e=We.current;e&&await Promise.resolve(e.set(!0))},ghost:async e=>{const r=i.current,s=$e.current;if(!r||!h.current||!s)return;const{grouped:n}=await St(e);if(n.size===0)return;const c={};for(const[p,y]of n.entries())c[p]=new Set(y);s.enabled=!1,Ft.current=!0;const u=[...r.core.models.materials.list.values()],f=vr.current;for(const p of u){if(p.userData.customId)continue;let y;"color"in p?y=p.color.getHex():y=p.lodColor.getHex(),f.set(p,{color:y,transparent:p.transparent,opacity:p.opacity}),p.transparent=!0,p.opacity=.05,p.needsUpdate=!0,"color"in p?p.color.setColorName("white"):p.lodColor.setColorName("white")}if(Object.keys(c).length>0)try{r.highlight({customId:"filter-ghost",color:new De(16750592),renderedFaces:1,opacity:1,transparent:!1},c)}catch{}r.core.update(!0)},getItemsData:async(e,r)=>{console.log("üîç [getItemsData] START",{globalIds:e.length,config:r});const s=i.current;if(!s)return console.error("üîç [getItemsData] Fragments not available"),[];const{grouped:n}=await St(e),c=[];for(const[u,f]of n.entries()){const p=s.list.get(u);if(p)try{const y=await p.getItemsData(Array.from(f),r);c.push(...y)}catch(y){console.error(`üîç [getItemsData] Failed for model ${u}`,y)}}return console.log("‚úÖ [getItemsData] Complete:",c.length,"items"),c},getItemsByCategory:async e=>{const r=i.current;if(!r)return console.error("üîç [getItemsByCategory] Fragments not available"),{};const s={};for(const[n,c]of r.list)try{const u=await c.getItemsOfCategories(e);if(u&&Object.keys(u).length>0){const f=Object.values(u).flat();f.length>0&&(s[n]=f)}}catch(u){console.error(`üîç [getItemsByCategory] Failed for model ${n}`,u)}return s},getItemsDataByModel:async(e,r,s)=>{const n=i.current;if(!n)return console.error("üîç [getItemsDataByModel] Fragments not available"),[];const c=n.list.get(e);if(!c)return console.error(`üîç [getItemsDataByModel] Model ${e} not found`),[];try{return await c.getItemsData(r,s)}catch(u){return console.error(`üîç [getItemsDataByModel] Failed for model ${e}`,u),[]}},fitViewTo:async e=>{if(!e.length)return;const r=a.current,s=i.current;if(!r||!s||!h.current)return;const n=r.camera??null,c=n?.controls??null,u=n?.three??null,{grouped:f}=await St(e),p=new st;let y=!1;for(const[S,I]of f.entries()){const P=s.list.get(S);if(!P||!P.object)continue;const _=new st().setFromObject(P.object);_.isEmpty()||(y?p.union(_):(p.copy(_),y=!0))}if(!y)return;const w=new Z,A=new Z;p.getCenter(w),p.getSize(A);const F=(Math.max(A.x,A.y,A.z)||10)*1.5;c?c.setLookAt(w.x+F,w.y+F,w.z+F,w.x,w.y,w.z,!0):u&&(u.position.set(w.x+F,w.y+F,w.z+F),u.lookAt(w))}}),[St]);yt.current=qo;const ns=d.useCallback(()=>{so(!0),Do(e=>e+1)},[]),ss=d.useCallback(()=>{so(!1);const e=yt.current;e&&(Promise.resolve(e.clearColors()).catch(()=>{}),e.clearIsolation&&Promise.resolve(e.clearIsolation()).catch(()=>{}))},[]),Yr=d.useCallback(()=>{so(e=>{const r=!e;return r&&Do(s=>s+1),r})},[]),ls=d.useCallback(async e=>{try{const{setIdsXmlText:r,runCheck:s}=await Pt(()=>Promise.resolve().then(()=>Ul),void 0).then(n=>n.idsStore);r(e),so(!0),Do(n=>n+1),setTimeout(async()=>{yt.current&&await s(yt.current)},100)}catch(r){console.error("Failed to validate from IDS Creator:",r),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Te.current=v},[v]),d.useEffect(()=>{Ne.current=null,$t.current=null;try{En.invalidateCaches()}catch(e){console.warn("Failed to invalidate IDS caches",e)}},[j]),d.useEffect(()=>{const e=t.current;if(!e)return;let r=!1;cr.current||(Xs.init(),Js.init(),cr.current=!0);try{e.replaceChildren()}catch{}const s=new Zs;b.current=s;const c=s.get(Qs).create();c.name="main",c.scene=new el(s),c.scene.setup(),c.renderer=new tl(s,e);const u=c.renderer.three;u.shadowMap.enabled=!1,u.sortObjects=!1,c.camera=new ol(s),c.camera.controls?.setLookAt(10,10,10,0,0,0),c.camera.three.near=.1,c.camera.three.far=1e9,c.camera.three.updateProjectionMatrix();const f=c.camera.controls;f&&(Nr.current=f,"mouseButtons"in f&&(f.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in f&&(f.dollySpeed=1));const p=new al(16777215,1);c.scene.three.add(p),a.current=c;const y=new As;y.showPanel(2),y.dom.style.position="absolute",y.dom.style.left="8px",y.dom.style.top="8px",y.dom.style.zIndex="1000",e.appendChild(y.dom),c.renderer.onBeforeUpdate.add(()=>y.begin()),c.renderer.onAfterUpdate.add(()=>y.end());let w=null;const A=async S=>{if(!h.current)return;const I=[];for(const[T,B]of Object.entries(S))B.forEach(K=>{Number.isInteger(K)&&I.push({modelId:T,localId:K})});const P=Te.current;if(!!sr(I,P))return;$(I),jt();const L=i.current;if(!L||!I.length){Pe(null);return}const V=I[0],R=L.list.get(V.modelId);if(!R){Pe(null);return}try{const[T]=await R.getItemsData([V.localId],ke);Pe(T||null)}catch(T){console.warn("Failed to fetch properties for selection",T)}},z=()=>{$o.current||Ft.current||($([]),Pe(null))};return(async()=>{try{await Promise.resolve(s.init())}catch(R){console.error("Failed to initialize viewer components",R);return}if(r)return;try{s.get(rl).create(c)}catch(R){console.warn("Failed to create grid component",R)}const I=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),P=URL.createObjectURL(new File([I],"worker.mjs",{type:"text/javascript"}));E.current=P;const _=s.get(nl);await _.init(P),i.current=_,h.current=!0;const L=s.get(sl);L.setup({world:c}),L.zoomToSelection=!0;try{typeof L.create=="function"&&L.create("select");let R=0;const T=10;for(;R<T&&(!L.selection||!L.selection.select);)await new Promise(B=>setTimeout(B,20)),R++;(!L.selection||!L.selection.select)&&console.warn("Highlighter selection system still initializing (non-blocking)")}catch(R){console.warn("Error during highlighter initialization:",R)}$e.current=L;const V=s.get(ll);We.current=V;try{const R=s.get(il);if(R.world=c,R.color=new De("#ff0000"),"snapDistance"in R&&(R.snapDistance=.5),"preview"in R){const T=R.preview;T&&(T.enabled=!0,T.color&&(T.color=new De("#00ff00")))}if("workingPlane"in R){const T=R.workingPlane;T&&typeof T=="object"&&(T.visible=!0)}R.list?.onItemAdded&&R.list.onItemAdded.add(T=>{const B=T.value||T.distance?.()||0;console.log(`‚úÖ Measurement created: ${B.toFixed(3)} units`),Tr(B.toFixed(3)),T.dimensionLabel&&(T.dimensionLabel.visible=!0)}),R.enabled=!1,uo.current=R,console.log("‚úÖ Measurement tool initialized:",R),console.log("Measurement tool properties:",Object.keys(R))}catch(R){console.error("Failed to initialize measurement tool:",R)}L.events.select.onHighlight.add(A),L.events.select.onClear.add(z),w=()=>{L.events.select.onHighlight.remove?.(A),L.events.select.onClear.remove?.(z)},ft()?.controls?.addEventListener("rest",()=>_.core.update(!0));try{const T=(await Pt(()=>import("./thatopen-vendor-byvyd1e5.js").then(X=>X.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new T,K="/Savora-Viewer/";B.wasm={path:`${K}web-ifc/`,absolute:!0},x.current=B}catch(R){console.warn("Failed to lazy-load FRAGS.IfcImporter:",R)}r||Be(!0)})().catch(S=>{console.error("Failed to initialize viewer fragments",S)}),()=>{r=!0,(async()=>{const S=h.current;h.current=!1,w?.(),w=null;try{S&&await We.current?.set?.(!0)}catch{}if(i.current){const I=[...i.current.list.keys()];await Promise.all(I.map(P=>i.current.core.disposeModel(P)))}try{S&&$e.current?.clear?.()}catch{}E.current&&URL.revokeObjectURL(E.current);try{s.dispose()}catch{}try{e.replaceChildren()}catch{}$e.current=null,We.current=null})()}},[]),d.useEffect(()=>{if(!be)return;const e=b.current,r=i.current;if(!e||!r)return;const s=mo,n=(c,u,f)=>{if(!c)return;let p=u.current;p||(p=f(),u.current=p),p&&p.parentElement!==c&&c.replaceChildren(p)};n(dr.current,at,()=>{const[c,u]=pn.modelsList({components:e});return Eo.current=u,c}),at.current&&((!at.current.dataset.initialized||s!==fr.current)&&Eo.current?.({components:e}),at.current.dataset.initialized||(at.current.dataset.initialized="true",at.current.style.width="100%")),ro.current!==ur.current&&(Po.current=null,zt.current=null,ur.current=ro.current),n(ro.current,Po,()=>{const[c,u]=pn.spatialTree({components:e,models:Array.from(r.list.values())});zt.current=u,c.style.width="100%",c.style.height="100%",c.style.overflow="auto";const f=c;return f.queryString=bt.trim()?bt.trim():null,c}),zt.current&&zt.current({components:e,models:Array.from(r.list.values())}),fr.current=s},[be,Q,bt,mo]),d.useEffect(()=>{if(!be)return;const e=b.current,r=i.current,s=zt.current;!e||!r||!s||s({components:e,models:Array.from(r.list.values())})},[be,mo]),d.useEffect(()=>{const e=Po.current;if(!e)return;const r=bt.trim();e.queryString=r||null},[bt]);const is=async()=>{const e=l.current,r=e?.files?.[0];if(!r)return;const s=r.name.split(".").pop()?.toLowerCase(),n=i.current,c=x.current,u=a.current;if(!n||!u){alert("Viewer is still initializing. Please try again in a moment."),e&&(e.value="");return}const f=ft(),p=f?.three??null,y=f?.controls??null;let w=!1;try{const A=`${r.name}-${Date.now()}`;let z;if(s==="ifc"){if(!c)throw new Error("IFC importer is not ready.");Ke(0),w=!0,Ye.current=!1,_e(!1);const P=new AbortController;Rt.current=P;const _=new Uint8Array(await r.arrayBuffer()),L=await c.process({bytes:_,progressCallback:(R,T)=>{if(Ye.current)return;const B=typeof R=="number"?R:0,K=B<=1?B*100:B,X=Math.max(0,Math.min(100,K));Ke(Number(X.toFixed(1))),console.log(`IFC conversion progress: ${X.toFixed(1)}%`,T)},signal:P.signal});if(Ye.current)throw{__cancelled:!0};let V;if(L instanceof ArrayBuffer){const R=new Uint8Array(L),T=new Uint8Array(R.byteLength);T.set(R),V=T.buffer}else if(L instanceof Uint8Array){const R=new Uint8Array(L.byteLength);R.set(L),V=R.buffer}else{const R=L,T=new Uint8Array(R),B=new Uint8Array(T.byteLength);B.set(T),V=B.buffer}z=await n.core.load(V,{modelId:A})}else if(s==="frag"){const P=await r.arrayBuffer();z=await n.core.load(P,{modelId:A})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}g.current=A,p?z.useCamera(p):console.warn("World camera not ready; skipping model camera binding."),u.scene.three.add(z.object),await n.core.update(!0),await new Promise(P=>requestAnimationFrame(()=>P()));const F=new st().setFromObject(z.object),S=new Z;F.getCenter(S),(Math.abs(S.x)>1e6||Math.abs(S.y)>1e6||Math.abs(S.z)>1e6)&&z.object.position.sub(S);try{y&&await y.fitToBox(z.object,!0)}catch{const P=new Z;F.getSize(P);const L=(Math.max(P.x,P.y,P.z)||10)*2.5;y?y.setLookAt(S.x+L,S.y+L,S.z+L,S.x,S.y,S.z,!0):p&&(p.position.set(S.x+L,S.y+L,S.z+L),p.lookAt(S))}Wn(P=>({...P,[A]:Zl(A,r.name,z.object)})),k(!0),O(P=>[...P,{id:A,label:r.name}]),jt();const I=b.current;I&&Eo.current?.({components:I}),w&&Ke(100)}catch(A){A&&(A.__cancelled||A?.name==="AbortError")?console.info("IFC conversion cancelled by user."):(console.error(A),alert("Failed to load model. See console for more details.")),k(!1)}finally{e&&(e.value=""),w&&setTimeout(()=>Ke(null),200),Rt.current=null,_e(!1)}},as=d.useCallback(()=>{if(Ce!==null){Ye.current=!0,_e(!0);try{Rt.current?.abort()}catch{}Ke(null)}},[Ce]),jt=d.useCallback(()=>{J(!0),Y(!1)},[]),Xr=d.useCallback(()=>{J(e=>{const r=!e;return r&&Y(!1),r})},[]),cs=d.useCallback(()=>{J(!1)},[]),ds=d.useCallback(()=>{Y(e=>!e)},[]),Jr=d.useMemo(()=>Math.min(360,Math.max(180,to.height*.45)),[to.height]),us=+!Dn+ +!Fn,Ko=!$n&&us===0;d.useEffect(()=>{const e=at.current;e&&(e.style.width="100%",e.style.maxHeight=Ko?"100%":`${Jr}px`,e.style.height=Ko?"100%":"auto")},[Ko,Jr,mo]);const fs=d.useCallback(async e=>{const r=I=>{const P=[],_=new Set;if(!I||typeof I!="object")return{terms:P,modelIds:_};for(const[L,V]of Object.entries(I)){if(V==null)continue;const R=L.trim().toLowerCase(),T=Array.isArray(V)?V:[V];if(T.length){if(R==="modelid"||R==="modelids"||R==="model"){for(const B of T){const K=typeof B=="string"?B.trim():String(B??"").trim();K&&_.add(K)}continue}if(["text","query","keyword","search"].includes(R)){for(const B of T){if(B==null)continue;const K=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();K&&P.push({type:"text",value:K})}continue}for(const B of T){if(B==null)continue;let K=null;typeof B=="string"?K=B.trim():(typeof B=="number"||typeof B=="boolean")&&(K=String(B)),K&&P.push({type:"field",key:R,value:K.toLowerCase()})}}}return{terms:P,modelIds:_}},s=i.current;if(!s){console.warn("AI selection requested but fragments are unavailable.");return}if(!h.current){console.warn("AI selection requested before fragments were fully initialized.");return}const n=$e.current,c=We.current,{terms:u,modelIds:f}=r(e.filter),p=e.mode?.toLowerCase?.(),y=p==="isolate"||p==="focus";if(e.action==="clear"){try{n?.clear?.()}catch{}if(c)try{await c.set(!0)}catch(I){console.warn("Failed to reset visibility while clearing AI selection",I)}try{const I=Ge.current;if(I&&I.mesh&&I.mesh.instanceColor){const P=new De(1,1,1);I.mesh.setColorAt(I.index,P),I.mesh.instanceColor.needsUpdate=!0}}catch{}Ge.current=null,ze.current&&(ze.current.visible=!1),$([]),Pe(null);return}if(u.length===0){console.warn("AI selection command did not include usable filters",e);return}const w=++Zt.current,A=[],z=60;for(const I of s.list.values()){const P=typeof I?.modelId=="string"?I.modelId:"";if(f.size&&!f.has(P))continue;let _=[];try{const V=await I.getLocalIds();Array.isArray(V)?_=V.slice():V&&typeof V[Symbol.iterator]=="function"&&(_=Array.from(V))}catch(V){console.warn("Failed to fetch local IDs for model",P,V)}const L={model:I,modelId:P,allIds:_,matched:new Set};if(A.push(L),!!_.length)for(let V=0;V<_.length;V+=z){if(w!==Zt.current)return;const R=_.slice(V,V+z);let T=[];try{T=await I.getItemsData(R,ke)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}R.forEach((B,K)=>{const X=T?.[K];if(!X)return;let G=[];try{G=Yt(X).rows}catch(ue){console.warn("Failed to build property rows for AI selection",ue)}const pe=G.map(ue=>ue.searchText),se=So(X,6e3).toLowerCase();u.every(ue=>{if(ue.type==="text")return pe.some(oe=>oe.includes(ue.value))||se.includes(ue.value);const Le=Xl[ue.key]??[ue.key];return pe.some(oe=>Le.some(Ie=>oe.includes(Ie))&&oe.includes(ue.value))?!0:Le.some(oe=>se.includes(oe)&&se.includes(ue.value))})&&L.matched.add(B)})}}if(w!==Zt.current)return;const F=A.filter(I=>I.matched.size>0);if(!F.length){console.info("AI selection produced no matches for command",e);return}try{const I=Ge.current;if(I&&I.mesh&&I.mesh.instanceColor){const P=new De(1,1,1);I.mesh.setColorAt(I.index,P),I.mesh.instanceColor.needsUpdate=!0}}catch{}if(Ge.current=null,ze.current&&(ze.current.visible=!1),c)try{await c.set(!0)}catch(I){console.warn("Failed to reset hidden state before AI selection",I)}if(n){try{n.clear?.()}catch{}const I=y?16754240:6737151;for(const P of F){const _=Array.from(P.matched);if(_.length)try{typeof n.highlightById=="function"?await n.highlightById(P.model,_,I):typeof n.highlightByID=="function"?await n.highlightByID(P.model,_,I):typeof n.add=="function"&&n.add(P.model,_,I)}catch(L){console.warn("Failed to apply AI highlight for model",P.modelId,L)}}}if(y&&c){const I={};for(const P of A){if(!P.allIds.length||P.matched.size===P.allIds.length)continue;const _=P.allIds.filter(L=>!P.matched.has(L));_.length&&(I[P.modelId]=new Set(_))}if(Object.keys(I).length)try{await c.set(!1,I)}catch(P){console.warn("Failed to isolate AI-selected elements",P)}}const S=F.flatMap(I=>Array.from(I.matched).map(P=>({modelId:I.modelId,localId:P})));$(S),jt();try{const I=F[0],P=Array.from(I.matched)[0];if(P!==void 0){const[_]=await I.model.getItemsData([P],ke);w===Zt.current&&Pe(_||null)}}catch(I){console.warn("Failed to fetch properties for AI selection result",I)}},[jt,$,Pe]),yo=d.useCallback(e=>{if(!oo.current)return;const r=vo.current;if(!r)return;const s=e.clientX-r.startX,n=e.clientY-r.startY,c=280,u=260;An(f=>{const p=r.width,y=r.height,w=Math.max(c,p+s),A=Math.max(u,y+n);return w===f.width&&A===f.height?f:{width:Math.round(w),height:Math.round(A)}})},[]),_t=d.useCallback(()=>{oo.current&&(oo.current=!1,vo.current=null,window.removeEventListener("pointermove",yo),window.removeEventListener("pointerup",_t))},[yo]),ps=d.useCallback(e=>{e.preventDefault(),e.stopPropagation();const r=ko.current;r&&(oo.current=!0,vo.current={startX:e.clientX,startY:e.clientY,width:r.offsetWidth,height:r.offsetHeight},window.addEventListener("pointermove",yo),window.addEventListener("pointerup",_t))},[yo,_t]);d.useEffect(()=>()=>{_t()},[_t]);const ms=d.useCallback(async()=>{const e=i.current,r=[];if(!e||e.list.size===0||j.length===0)r.push("No models are currently loaded in the viewer.");else{r.push(`Loaded models (${j.length}): ${j.map(n=>`${n.label} [${n.id}]`).join(", ")}`),r.push(`Fragments models in memory: ${e.list.size}`);try{const n=new st;for(const u of e.list.values())n.expandByObject(u.object);const c=new Z;n.getSize(c),r.push(`Scene bounds approx size => x:${c.x.toFixed(2)} y:${c.y.toFixed(2)} z:${c.z.toFixed(2)}`)}catch(n){console.warn("Failed to compute bounds for AI context",n)}const s=j.map(n=>Er[n.id]).filter(n=>!!n);if(s.length){let n=0;const c=new Map;r.push("Model geometry snapshots:");for(const f of s){n+=f.elementCount;for(const{category:y,count:w}of f.categoryCounts)c.set(y,(c.get(y)??0)+w);const p=f.categoryCounts.slice(0,5).map(({category:y,count:w})=>`${y}: ${w}`);r.push(`- ${f.label} [${f.modelId}] ‚Üí elements‚âà${f.elementCount}, instanced‚âà${f.instancedCount}, meshes‚âà${f.meshCount}`),p.length&&r.push(`  top categories: ${p.join(" | ")}`),r.push(`  bbox size (approx): x:${f.bboxSize.x.toFixed(2)} y:${f.bboxSize.y.toFixed(2)} z:${f.bboxSize.z.toFixed(2)}`)}const u=Array.from(c.entries()).sort((f,p)=>p[1]-f[1]).slice(0,10).map(([f,p])=>`${f}: ${p}`);r.push(`Global approx element total: ${n}`),u.length&&r.push(`Global top categories: ${u.join(" | ")}`)}else r.push("Geometry summaries are initializing ‚Äî load a model or wait a moment after loading.")}if(v.length){r.push(`Active selection count: ${v.length}`);for(let s=0;s<v.length;s+=1){const n=v[s];r.push(`Selection #${s+1} ‚Üí modelId:${n.modelId}, localId:${n.localId}`);let c=null;if(s===0&&q&&Object.keys(q).length)c=q;else if(e){const u=e.list.get(n.modelId);if(u)try{const[f]=await u.getItemsData([n.localId],ke);c=f||null}catch(f){console.warn("Failed to fetch properties for AI context (multi)",f)}}if(c){r.push("  Property snapshot (compact JSON):"),r.push(`  ${So(c,4e3)}`);const u=Yt(c).rows;if(u.length){r.push(`  Flattened properties (${u.length} entries):`);for(const f of u.slice(0,120))r.push(`  - ${f.label}: ${f.value}`);u.length>120&&r.push(`  (Truncated ${u.length-120} additional properties)`)}}else r.push("  Properties for this selection are not available yet.")}}else if(r.push("No active selection ‚Äî exporting properties for every loaded element."),e&&e.list.size)for(const s of j){const n=e.list.get(s.id);if(!n){r.push(`Model ${s.label} [${s.id}] could not be found in the fragments registry.`);continue}try{const c=await n.getLocalIds(),u=Array.isArray(c)?c:c?Array.from(c):[];if(!u||u.length===0){r.push(`Model ${s.label} [${s.id}] has no retrievable local IDs.`);continue}r.push(`Model ${s.label} [${s.id}] ‚Äî enumerating ${u.length} items:`);const f=u.length<=40?12:u.length<=120?6:3,p=50;for(let y=0;y<u.length;y+=p){const w=u.slice(y,y+p);let A=[];try{A=await n.getItemsData(w,ke)}catch(z){const F=w[0],S=w[w.length-1];r.push(`  Failed to retrieve properties for items ${F}‚Äì${S}: ${z?.message??z}`);continue}w.forEach((z,F)=>{const S=A?.[F];if(!S){r.push(`- localId:${z} (no data available)`);return}const I=ti(S,f).replace(/\s+/g," ").trim();r.push(`- localId:${z} | ${I}`)})}}catch(c){r.push(`Failed to enumerate items for model ${s.label} [${s.id}]: ${c?.message??c}`)}}else r.push("Fragments data is not available to enumerate model items.");if(Tt.length){r.push("ItemsData extracted name/value pairs (last selection):");const s=150,n=Tt.slice(0,s);for(const c of n)r.push(`- ${c.path}: ${c.value}`);Tt.length>s&&r.push(`(Truncated ${Tt.length-s} additional rows)`)}return Fo&&(r.push("ItemsData table snapshot for last selection (tab-separated):"),r.push(Fo)),r.length===0&&r.push("Viewer is idle: no models or selections to describe."),r.join(`
`)},[j,v,q,ae,Er,Fo,Tt]),hs=d.useCallback(async()=>{const e=a.current,r=i.current,s=g.current;if(!e||!r||!s||!h.current)return;const n=r.list.get(s);if(!n)return;await r.core.update(!0),await new Promise(f=>requestAnimationFrame(()=>f()));const c=n.object,u=new st().setFromObject(c);if(!u.isEmpty()){const f=ft(),p=f?.controls??null,y=f?.three??null;try{p&&await p.fitToBox(c,!0)}catch{const A=new Z,z=new Z;u.getCenter(A),u.getSize(z);const S=(Math.max(z.x,z.y,z.z)||10)*2.5;p?p.setLookAt(A.x+S,A.y+S,A.z+S,A.x,A.y,A.z,!0):y&&(y.position.set(A.x+S,A.y+S,A.z+S),y.lookAt(A))}}},[]),gs=d.useCallback(async()=>{const e=Te.current,r=We.current;if(!e||e.length===0||!r||!h.current){Ee(null);return}const s={};for(const n of e)s[n.modelId]||(s[n.modelId]=new Set),s[n.modelId].add(n.localId);try{await r.set(!1,s);try{$e.current?.clear?.()}catch{}$([]),Pe(null)}catch(n){console.warn("Failed to hide selected element",n)}finally{Ee(null)}},[Ee,$,Pe]),ys=d.useCallback(async()=>{const e=We.current;if(!e||!h.current){Ee(null);return}try{await e.set(!0)}catch(r){console.warn("Failed to reset hidden items",r)}finally{Ee(null)}},[Ee]),bs=d.useCallback(()=>{Ee(null)},[Ee]);d.useEffect(()=>{const e=t.current,r=a.current;if(!e||!r)return;const s=r.renderer?.three.domElement;if(!s)return;const n=new mn,c=async(S,I,P,_)=>{console.log("üî∑ Rectangle Selection Started (viewport coords)",{left:S,top:I,right:P,bottom:_});const L=i.current;if(!L){console.warn("‚ùå No fragments manager");return}console.log("üì¶ Models available:",L.list.size);const V=Vo();if(!V){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const R=s.getBoundingClientRect();console.log("üìè Canvas bounds:",{rectLeft:R.left,rectTop:R.top,rectWidth:R.width,rectHeight:R.height}),new hn;const T=new Map,B=10,K=P-S,X=_-I;if(console.log("üìê Rectangle size:",{width:K,height:X,sampleSize:B}),K<3||X<3){console.log("‚ö†Ô∏è Rectangle too small, using click selection"),await u((S+P)/2,(I+_)/2);return}let G=0,pe=0,se=!0;for(let we=S;we<=P;we+=B)for(let oe=I;oe<=_;oe+=B){G++;const Ie=(we-R.left)/R.width*2-1,tt=-((oe-R.top)/R.height)*2+1;n.set(Ie,tt),se&&console.log("üîç First sample point:",{screenCoords:{x:we,y:oe},rectBounds:{left:R.left,top:R.top,width:R.width,height:R.height},mouseNDC:{x:Ie,y:tt},mouseVector:n.clone()});for(const ot of L.list.values())try{const Bt=new mn(Ie,tt);se&&console.log("üî¨ Raycast params:",{mouseVec:Bt.clone(),cameraType:V.type,domElement:s?.tagName,modelId:ot.modelId});const rt=await ot.raycast({camera:V,mouse:Bt,dom:s});if(se&&console.log("üî¨ Raycast result:",{hit:rt,hasDistance:rt&&typeof rt.distance=="number",hitType:typeof rt}),rt&&typeof rt.distance=="number"){pe++;const Gt=rt.localId;console.log("üéØ Hit found:",{point:{x:we,y:oe},mouseNDC:{x:Ie,y:tt},localId:Gt,distance:rt.distance,modelId:ot.modelId}),Gt!=null&&Number.isInteger(Gt)&&(T.has(ot.modelId)||T.set(ot.modelId,new Set),T.get(ot.modelId).add(Gt))}}catch(Bt){se&&console.warn("‚ùå Raycast error on first sample:",Bt),console.debug("Skipping model due to raycast error:",Bt)}se&&(se=!1)}console.log("üìä Sampling complete:",{samplePoints:G,hitCount:pe,uniqueObjects:T.size});const ye=[];for(const[we,oe]of T.entries())for(const Ie of oe)ye.push({modelId:we,localId:Ie});if(console.log("‚úÖ Rectangle Selection Result:",{totalSelected:ye.length,byModel:Array.from(T.entries()).map(([we,oe])=>({modelId:we,count:oe.size}))}),ye.length===0){console.warn("‚ö†Ô∏è No objects found in rectangle"),$([]),Pe(null);return}const ue=Te.current;if(!!sr(ye,ue)){console.log("‚ÑπÔ∏è Selection unchanged");return}if(console.log("üîÑ Updating selection with",ye.length,"objects"),$(ye),jt(),ye.length>0){const we=ye[0],oe=L.list.get(we.modelId);if(oe)try{const[Ie]=await oe.getItemsData([we.localId],ke);Pe(Ie||null)}catch(Ie){console.warn("Failed to fetch properties for rectangle selection",Ie)}}},u=async(S,I)=>{const P=i.current;if(!P)return;const _=Vo();if(!_){console.warn("Picking skipped: viewer camera not ready.");return}const L=s.getBoundingClientRect();n.x=(S-L.left)/L.width*2-1,n.y=-((I-L.top)/L.height)*2+1;let V=null;const R=new hn;R.setFromCamera(n,_);for(const X of P.list.values())try{const G=await X.raycast({camera:_,mouse:n,dom:r.renderer.three.domElement});if(G&&typeof G.distance=="number"){const pe=G.point instanceof Z?G.point.clone():R.ray.at(G.distance,new Z);(!V||G.distance<V.dist)&&(V={dist:G.distance,model:X,localId:G.localId,point:pe,object:G.object,instanceId:G.instanceId})}}catch{}if(!V)return;const T=$e.current;if(T&&T.enabled!==!1)try{typeof T.clear=="function"&&!$o.current&&!Ft.current&&T.clear();const X=6737151,G=T.selection&&T.selection.select;if(!T.onBeforeHighlight||!G)return;typeof T.highlightByID=="function"?await T.highlightByID(V.model.uuid,[V.localId],X):typeof T.add=="function"?T.add(V.model.uuid,[V.localId]):typeof T.highlight=="function"&&await T.highlight(V.model,[V.localId],X)}catch(X){console.warn("Highlighter failed, using fallback:",X);try{const G=V.object,pe=V.instanceId;if(G&&G.isInstancedMesh&&Number.isInteger(pe)){const se=Ge.current;if(se&&se.mesh&&se.mesh.instanceColor){const Le=new De(1,1,1);try{se.mesh.setColorAt(se.index,Le),se.mesh.instanceColor.needsUpdate=!0}catch{}}const ye=G,ue=new De(6737151);try{ye.setColorAt(pe,ue),ye.instanceColor.needsUpdate=!0}catch{}Ge.current={mesh:ye,index:pe}}}catch{}}try{const X=V.point??new Z;let G=ze.current;if(!G){G=new cl;const ye=new st,ue=i.current;if(ue&&ue.list.size)for(const ot of ue.list.values())ye.expandByObject(ot.object);const Le=new dl;ye.getBoundingSphere(Le);const we=isFinite(Le.radius)&&Le.radius>0?Le.radius*.01:.3,oe=Math.max(.05,Math.min(2,we)),Ie=new gn(new ul(oe*.5,16,16),new yn({color:16763904,depthTest:!1})),tt=new gn(new fl(oe*.8,oe,32),new yn({color:16772744,side:pl,depthTest:!1,transparent:!0,opacity:.9}));tt.rotation.x=Math.PI/2,Ie.renderOrder=999,tt.renderOrder=999,G.add(Ie),G.add(tt),r.scene.three.add(G),ze.current=G}G.position.copy(X);const pe=G.children[1],se=Vo();se&&pe.lookAt(se.position),G.visible=!0}catch{}const B=Te.current,K=[{modelId:V.model.modelId,localId:V.localId}];if(!sr(K,B)){$(K),jt();try{const[X]=await V.model.getItemsData([V.localId],ke);Pe(X||null)}catch{}}},f=async S=>{if(Ee(null),S.button===0)if(jo.current==="rectangle"&&!Lt.current){if(eo.current=!0,gt.current={x:S.clientX,y:S.clientY},!Fe.current){const P=document.createElement("div");P.style.position="fixed",P.style.border="2px solid #1976d2",P.style.backgroundColor="rgba(25, 118, 210, 0.1)",P.style.pointerEvents="none",P.style.zIndex="10000",document.body.appendChild(P),Fe.current=P}const I=Fe.current;I.style.left=`${S.clientX}px`,I.style.top=`${S.clientY}px`,I.style.width="0px",I.style.height="0px",I.style.display="block"}else await u(S.clientX,S.clientY)},p=S=>{if(!eo.current||!gt.current||!Fe.current)return;const I=gt.current,P=Fe.current,_=Math.min(S.clientX,I.x),L=Math.min(S.clientY,I.y),V=Math.abs(S.clientX-I.x),R=Math.abs(S.clientY-I.y);P.style.left=`${_}px`,P.style.top=`${L}px`,P.style.width=`${V}px`,P.style.height=`${R}px`},y=async S=>{if(eo.current&&gt.current&&Fe.current){const I=gt.current,P=Fe.current;P.style.display="none",eo.current=!1;const _=Math.min(S.clientX,I.x),L=Math.min(S.clientY,I.y),V=Math.max(S.clientX,I.x),R=Math.max(S.clientY,I.y);await c(_,L,V,R),gt.current=null}},w=async S=>{Ee(null),!Lt.current&&jo.current==="click"&&await u(S.clientX,S.clientY)},A=()=>{if(Lt.current){const S=uo.current;S&&typeof S.create=="function"&&S.create()}},z=S=>{S.preventDefault();const I=Te.current;if(!I||I.length===0){Ee(null);return}Ee({mouseX:S.clientX+2,mouseY:S.clientY-6})},F=S=>{if(Lt.current&&(S.code==="Delete"||S.code==="Backspace")){const I=uo.current;I&&typeof I.delete=="function"&&(console.log("Deleting measurement under cursor"),I.delete())}};return s.addEventListener("pointerdown",f,{capture:!0}),s.addEventListener("pointermove",p),s.addEventListener("pointerup",y),s.addEventListener("click",w),s.addEventListener("dblclick",A),s.addEventListener("contextmenu",z),window.addEventListener("keydown",F),()=>{s.removeEventListener("pointerdown",f,{capture:!0}),s.removeEventListener("pointermove",p),s.removeEventListener("pointerup",y),s.removeEventListener("click",w),s.removeEventListener("dblclick",A),s.removeEventListener("contextmenu",z),window.removeEventListener("keydown",F),Fe.current&&(Fe.current.remove(),Fe.current=null);try{const S=ze.current;S&&(r.scene.three.remove(S),S.traverse(I=>{if(I.geometry&&I.geometry.dispose?.(),I.material){const P=Array.isArray(I.material)?I.material:[I.material];for(const _ of P)_?.dispose?.()}}),ze.current=null)}catch{}try{const S=Ge.current;if(S&&S.mesh&&S.mesh.instanceColor){const I=new De(1,1,1);S.mesh.setColorAt(S.index,I),S.mesh.instanceColor.needsUpdate=!0}Ge.current=null}catch{}}},[]);const xs=d.useCallback(()=>{a.current;const e=ft(),r=e?.controls??null,s=e?.three??null;r?r.reset(!0):s&&(s.position.set(10,10,10),s.lookAt(0,0,0))},[]),Yo=d.useCallback(e=>{co(r=>{const s={...r,[e]:!r[e]},n=a.current;if(!n)return s;const c=n.renderer?.three,u=n.scene?.three;if(!c||!u)return s;const f=[],p=Lo.current;if(!s[e]){const y=p.get(e);y&&(u.remove(y),y.dispose(),p.delete(e))}if(s.x){const y=new kt(new Z(1,0,0),Oe.x);if(f.push(y),!p.has("x")){const w=new rr(y,10,16711680);u.add(w),p.set("x",w)}}if(s.y){const y=new kt(new Z(0,1,0),Oe.y);if(f.push(y),!p.has("y")){const w=new rr(y,10,65280);u.add(w),p.set("y",w)}}if(s.z){const y=new kt(new Z(0,0,1),Oe.z);if(f.push(y),!p.has("z")){const w=new rr(y,10,255);u.add(w),p.set("z",w)}}return c.clippingPlanes=f,c.localClippingEnabled=f.length>0,Oo.current=f,s})},[Oe]),Xo=d.useCallback((e,r)=>{$r(s=>{const n={...s,[e]:r};return requestAnimationFrame(()=>{const u=a.current;if(!u)return;const f=u.renderer?.three;if(!f)return;const p=[],y=Lo.current;if(ne.x){const w=new kt(new Z(1,0,0),n.x);p.push(w);const A=y.get("x");A&&(A.plane.constant=n.x)}if(ne.y){const w=new kt(new Z(0,1,0),n.y);p.push(w);const A=y.get("y");A&&(A.plane.constant=n.y)}if(ne.z){const w=new kt(new Z(0,0,1),n.z);p.push(w);const A=y.get("z");A&&(A.plane.constant=n.z)}f.clippingPlanes=p,Oo.current=p}),n})},[ne]),ws=d.useCallback(()=>{Dr(e=>{const r=!e;return co(r?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),r})},[]),Is=d.useCallback(()=>{console.log("üéØ toggleMeasurement called"),Hn(e=>{const r=!e;Lt.current=r;const s=uo.current;if(console.log("Measurement tool:",s),console.log("New state:",r),s)if(s.enabled=r,console.log("Measurement tool enabled set to:",r),console.log("Measurement tool world:",s.world),console.log("Measurement tool properties:",{enabled:s.enabled,world:!!s.world,list:s.list?.size||0}),r)console.log("üìè Measurement mode activated - DOUBLE-CLICK two points on the model to measure distance");else try{s.list&&typeof s.list.clear=="function"&&(s.list.clear(),console.log("All measurements cleared")),Tr(null)}catch(n){console.warn("Failed to clear measurements:",n)}else console.warn("‚ö†Ô∏è Measurement tool not initialized!");return r})},[]),Cs=d.useCallback(()=>{Vn(e=>{const r=!e;$o.current=r;const s=i.current,n=$e.current,c=Bn.current;if(!s)return e;try{if(r){if(!n)return e;const u=n.selection?.select||{};jr.current=u,n.enabled=!1;const f=[...s.core.models.materials.list.values()];for(const p of f){if(p.userData.customId)continue;let y;"color"in p?y=p.color.getHex():y=p.lodColor.getHex(),c.set(p,{color:y,transparent:p.transparent,opacity:p.opacity}),p.transparent=!0,p.opacity=.05,p.needsUpdate=!0,"color"in p?p.color.setColorName("white"):p.lodColor.setColorName("white")}if(Object.keys(u).length>0)try{s.highlight({customId:"ghost-selected",color:new De(16750592),renderedFaces:1,opacity:1,transparent:!1},u)}catch(p){console.warn("Failed to apply ghost highlight:",p)}s.core.update(!0)}else{for(const[u,f]of c){const{color:p,transparent:y,opacity:w}=f;u.transparent=y,u.opacity=w,"color"in u?u.color.setHex(p):u.lodColor.setHex(p),u.needsUpdate=!0}c.clear(),n&&(n.enabled=!0),jr.current=null,s.resetHighlight(),s.core.update(!0)}}catch(u){return console.warn("Failed to toggle ghost mode:",u),e}return r})},[]),Ss=d.useCallback(()=>{console.log("üîí toggleIsolateMode called"),_n(e=>{const r=!e,s=We.current,n=$e.current;if(!s)return console.warn("‚ö†Ô∏è Hider not available for isolate mode"),e;try{if(r){const c=n?.selection?.select||{},u={};for(const[f,p]of Object.entries(c))p&&typeof p.size=="number"&&p.size>0&&(u[f]=p);if(Object.keys(u).length>0)s.isolate(u),console.log("üîí Isolate mode enabled - showing only selected objects");else return console.warn("‚ö†Ô∏è No selection to isolate"),e}else s.set(!0),console.log("‚úÖ Isolate mode disabled - showing all objects")}catch(c){return console.warn("Failed to toggle isolate mode:",c),e}return r})},[]),js=d.useCallback(()=>{co({x:!1,y:!1,z:!1}),$r({x:0,y:0,z:0}),Dr(!1);const e=a.current;if(e){const r=e.renderer?.three,s=e.scene?.three;if(r&&(r.clippingPlanes=[],r.localClippingEnabled=!1),s){const n=Lo.current;n.forEach(c=>{s.remove(c),c.dispose()}),n.clear()}}Oo.current=[]},[]),pt=d.useCallback(e=>{console.log("setCameraView called with view:",e);const r=a.current,s=i.current,n=g.current,c=ft(),u=c?.three;if(console.log("Debug:",{hasWorld:!!r,hasFragments:!!s,id:n,hasCamera:!!c,hasThreeCamera:!!u}),!u||!r||!s||!n){console.log("Early return: missing dependencies");return}const f=s.list.get(n);if(console.log("Model record:",f),!f){console.log("Early return: no record found for id:",n);return}const p=new st().setFromObject(f.object);if(console.log("Bounding box:",p,"isEmpty:",p.isEmpty()),p.isEmpty()){console.log("Early return: bounding box is empty");return}const y=new Z,w=new Z;p.getCenter(y),p.getSize(w);const z=Math.max(w.x,w.y,w.z)*2||20;let F;switch(e){case"top":F=new Z(y.x,y.y,y.z+z);break;case"bottom":F=new Z(y.x,y.y,y.z-z);break;case"front":F=new Z(y.x,y.y+z,y.z);break;case"back":F=new Z(y.x,y.y-z,y.z);break;case"left":F=new Z(y.x-z,y.y,y.z);break;case"right":F=new Z(y.x+z,y.y,y.z);break;case"iso":F=new Z(y.x+z*.7,y.y+z*.7,y.z+z*.7);break;default:return}const S=c?.controls;S&&typeof S.setLookAt=="function"?(S.setLookAt(F.x,F.y,F.z,y.x,y.y,y.z,!0),console.log("Camera moved to:",e,"position:",F,"looking at:",y)):(u.position.copy(F),u.lookAt(y),u.updateProjectionMatrix(),console.log("Camera moved (fallback) to:",e))},[]);return o.jsxs("div",{style:{width:"100%",height:"100%"},children:[o.jsx(Ms,{position:"static",children:o.jsxs(Rs,{children:[o.jsx(W,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[o.jsx(W,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:o.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),o.jsx(U,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),o.jsx(te,{title:"Settings",children:o.jsx(ee,{color:"inherit",onClick:Kr,sx:{mr:1},children:o.jsx(zs,{})})}),o.jsx(te,{title:"About",children:o.jsx(ee,{color:"inherit",onClick:Qn,sx:{mr:1},children:o.jsx($s,{})})}),o.jsx(ie,{color:"inherit",onClick:Xr,startIcon:o.jsx(Zr,{}),"aria-pressed":Q,sx:{mr:1,borderRadius:1.5,backgroundColor:Q?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Q?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Q?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),o.jsx(ie,{color:"inherit",onClick:Hr,startIcon:o.jsx(Qr,{}),"aria-pressed":Xe,sx:{mr:1,borderRadius:1.5,backgroundColor:Xe?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Xe?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Xe?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),o.jsx(ie,{color:"inherit",onClick:Yr,startIcon:o.jsx(en,{}),"aria-pressed":Je,sx:{mr:1,borderRadius:1.5,backgroundColor:Je?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Je?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Je?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),o.jsx(ie,{color:"inherit",onClick:Ur,startIcon:o.jsx(tn,{}),"aria-pressed":Ze,sx:{mr:1,borderRadius:1.5,backgroundColor:Ze?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Ze?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Ze?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),o.jsx("div",{ref:t,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:Ce!==null&&o.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:o.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[o.jsx(U,{variant:"subtitle1",sx:{mb:1},children:"Converting IFC‚Ä¶"}),o.jsx(Ds,{variant:"determinate",value:Math.max(0,Math.min(100,Ce)),sx:{height:10,borderRadius:1}}),o.jsxs(U,{variant:"caption",sx:{mt:1,display:"block"},children:[Ce.toFixed(1),"%"]}),o.jsx("div",{style:{marginTop:12},children:o.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:as,disabled:Mt,children:Mt?"Cancelling‚Ä¶":"Cancel"})})]})})}),Q&&o.jsx(on,{nodeRef:ko,handle:".explorer-header",bounds:"parent",children:o.jsxs(je,{ref:ko,elevation:8,sx:{position:"fixed",top:120,right:30,width:to.width,height:re?"auto":to.height,minWidth:280,minHeight:re?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[o.jsxs(W,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[o.jsx(U,{variant:"subtitle1",children:"Model Explorer"}),o.jsxs(W,{children:[o.jsx(ee,{size:"small",color:"inherit",onClick:ds,title:re?"Expand panel":"Minimize panel",children:re?o.jsx(Fs,{}):o.jsx(rn,{})}),o.jsx(ee,{size:"small",color:"inherit",onClick:cs,title:"Close Model Explorer",children:o.jsx(nn,{})})]})]}),!re&&o.jsxs(W,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[o.jsx(ie,{variant:"contained",size:"small",onClick:()=>l.current?.click(),disabled:!be,children:"Open IFC / FRAG"}),o.jsx(te,{title:"Open parametric filter",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",onClick:()=>Re(!0),disabled:!be,startIcon:o.jsx(Ts,{}),children:"Filter"})})}),!1,o.jsx(U,{variant:"caption",color:"text.secondary"}),o.jsx("input",{ref:l,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:is})]}),o.jsxs(sn,{value:dt,onChange:(e,r)=>Tn(r),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[o.jsx(Wt,{value:"models",label:"Models"}),o.jsx(Wt,{value:"properties",label:"Properties"}),o.jsx(Wt,{value:"tree",label:"Model Tree"})]}),o.jsx(W,{role:"tabpanel",hidden:dt!=="models",sx:{display:dt==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:o.jsx(W,{ref:dr,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!be&&o.jsx(U,{variant:"body2",color:"text.secondary",children:"Initializing components‚Ä¶"})})}),o.jsx(W,{role:"tabpanel",hidden:dt!=="properties",sx:{display:dt==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsxs(sn,{value:ct,onChange:(e,r)=>hr(r),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[o.jsx(Wt,{value:"favorites",label:`Favourites (${Bo.length})`}),o.jsx(Wt,{value:"all",label:`All (${ae.length})`})]}),o.jsxs(W,{role:"tabpanel",hidden:ct!=="favorites",sx:{display:ct==="favorites"?"flex":"none",flexDirection:"column",flex:ct==="favorites"?1:0,minHeight:0},children:[Bo.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Bo.map(Wo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:Se.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Go>0&&Se.length>0&&o.jsx(vt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Go===1?"1 favourite property is not available for this selection.":`${Go} favourite properties are not available for this selection.`})]}),o.jsxs(W,{role:"tabpanel",hidden:ct!=="all",sx:{display:ct==="all"?"flex":"none",flexDirection:"column",flex:ct==="all"?1:0,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[o.jsx(Ut,{size:"small",fullWidth:!0,value:pr,onChange:e=>Rn(e.target.value),placeholder:"Search properties‚Ä¶",disabled:!ae.length}),o.jsx(te,{title:"Copy raw element JSON",children:o.jsx("span",{children:o.jsx(ee,{size:"small",onClick:Yn,disabled:!q,color:"primary",children:o.jsx(Ns,{fontSize:"small"})})})}),o.jsx(te,{title:"Export properties",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",startIcon:o.jsx(Os,{}),onClick:Kn,disabled:!ae.length&&!j.length,children:"Export"})})})]}),ae.length?qn?Or.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Or.map(Wo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:`No properties matched "${fo}".`})}):o.jsxs(W,{sx:{position:"relative",flex:1,minHeight:200},children:[o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:_o.map(Wo)}),Lr>0&&o.jsx(vt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${_o.length} properties. ${Lr} more not shown.`})]}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / ‚Ä¶ breakdown."})})]})]})}),o.jsx(W,{role:"tabpanel",hidden:dt!=="tree",sx:{display:dt==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsx(Ut,{size:"small",fullWidth:!0,value:bt,onChange:e=>zn(e.target.value),placeholder:"Search the model tree‚Ä¶",disabled:!j.length,sx:{flexShrink:0}}),o.jsxs(W,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[o.jsx(W,{ref:ro,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!be||!j.length)&&o.jsx(W,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:be?"Load a model to populate the full model tree.":"Viewer is initializing the model tree‚Ä¶"})})]})]})})]}),o.jsx(W,{onPointerDown:ps,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:Q?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Xr,title:Q?"Close Model Explorer":"Open Model Explorer",sx:{color:Q?"white":"inherit"},children:o.jsx(Zr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:Xe?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Hr,title:Xe?"Close AI Assistant":"Open AI Assistant",sx:{color:Xe?"white":"inherit"},children:o.jsx(Qr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Je?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Yr,title:Je?"Close IDS Checker":"Open IDS Checker",sx:{color:Je?"white":"inherit"},children:o.jsx(en,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:Ze?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(ee,{onClick:Ur,title:Ze?"Close IDS Creator":"Open IDS Creator",sx:{color:Ze?"white":"inherit"},children:o.jsx(tn,{})})}),Ct?o.jsx(on,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:o.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[o.jsxs(W,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[o.jsx(U,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(ee,{size:"small",onClick:()=>No(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:o.jsx(rn,{fontSize:"small"})}),o.jsx(ee,{size:"small",onClick:()=>No(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:o.jsx(nn,{fontSize:"small"})})]})]}),o.jsxs(W,{sx:{p:1.5},children:[o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:hs,disabled:!m,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(ln,{fontSize:"small"})})}),o.jsx(te,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:xs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:o.jsx(Ls,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),o.jsxs(W,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[o.jsx(te,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),o.jsx(te,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),o.jsx(te,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),o.jsx(te,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),o.jsx(te,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),o.jsx(te,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>pt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),o.jsx(te,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:o.jsxs(ie,{size:"small",onClick:()=>pt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[o.jsx(Vs,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),o.jsx(te,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),o.jsx(te,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Yo("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Oe.x.toFixed(1)]}),o.jsx(Jo,{value:Oe.x,onChange:(e,r)=>Xo("x",r),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Oe.y.toFixed(1)]}),o.jsx(Jo,{value:Oe.y,onChange:(e,r)=>Xo("y",r),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Oe.z.toFixed(1)]}),o.jsx(Jo,{value:Oe.z,onChange:(e,r)=>Xo("z",r),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:ws,sx:{border:"2px solid",borderColor:Nt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Nt?"warning.main":"white",color:Nt?"white":"warning.dark","&:hover":{backgroundColor:Nt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:o.jsx(_s,{fontSize:"small"})})}),o.jsx(te,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:js,disabled:!ne.x&&!ne.y&&!ne.z&&!Nt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(Bs,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[o.jsx(te,{title:Ot?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:Is,sx:{border:"2px solid",borderColor:Ot?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ot?"success.main":"white",color:Ot?"white":"success.dark","&:hover":{backgroundColor:Ot?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx(Gs,{fontSize:"small"})})}),Fr&&o.jsxs(U,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Fr," units"]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Sr("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:o.jsx(Ws,{fontSize:"small"})})}),o.jsx(te,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:()=>Sr("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:o.jsx(Us,{fontSize:"small"})})}),o.jsx(te,{title:wt?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:Cs,sx:{border:"2px solid",borderColor:wt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:wt?"warning.main":"white",color:wt?"white":"warning.dark","&:hover":{backgroundColor:wt?"warning.dark":"warning.light",borderColor:"warning.main",color:wt?"white":"warning.dark"}},children:o.jsx(an,{fontSize:"small"})})}),o.jsx(te,{title:It?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ee,{size:"small",onClick:Ss,sx:{border:"2px solid",borderColor:It?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:It?"info.main":"white",color:It?"white":"info.dark","&:hover":{backgroundColor:It?"info.dark":"info.light",borderColor:"info.main",color:It?"white":"info.dark"}},children:o.jsx(cn,{fontSize:"small"})})})]}),xe==="rectangle"&&o.jsx(vt,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]})]})," "]})}):null,o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:Ct?"primary.main":"background.paper","&:hover":{bgcolor:Ct?"primary.dark":"action.hover"}},children:o.jsx(ee,{onClick:()=>No(!Ct),title:Ct?"Close View Controls":"Open View Controls",sx:{color:Ct?"white":"action.active"},children:o.jsx(ln,{})})}),o.jsx(d.Suspense,{fallback:null,children:H&&o.jsx(Yl,{open:H,onClose:()=>Re(!1),viewerApi:yt.current??null})}),o.jsxs(Zo,{open:Ln,onClose:ho,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Qo,{children:"Settings"}),o.jsx(er,{dividers:!0,children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[o.jsxs(dn,{component:"fieldset",children:[o.jsx(un,{component:"legend",sx:{mb:1},children:"AI Provider"}),o.jsxs(fn,{value:ge,onChange:e=>ts(e.target.value),children:[o.jsx(Ht,{value:"gemini",control:o.jsx(qt,{}),label:"Google Gemini"}),o.jsx(Ht,{value:"openai",control:o.jsx(qt,{}),label:"OpenAI (ChatGPT)"}),o.jsx(Ht,{value:"disabled",control:o.jsx(qt,{}),label:"Disabled (No AI)"})]})]}),ge!=="disabled"&&o.jsxs(o.Fragment,{children:[o.jsx(Ut,{label:"API Key",type:zo?"text":"password",value:Ue,onChange:e=>Ro(e.target.value),fullWidth:!0,placeholder:`Enter your ${ge==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:o.jsx(ee,{onClick:()=>xr(!zo),edge:"end",size:"small",children:zo?o.jsx(an,{}):o.jsx(cn,{})})},helperText:ge==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),o.jsx(Ut,{select:!0,label:"Model",value:Dt,onChange:e=>lo(e.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:Il(ge).map(e=>o.jsx("option",{value:e,children:e},e))}),o.jsxs(W,{sx:{display:"flex",gap:1,alignItems:"center"},children:[o.jsx(ie,{variant:"outlined",onClick:os,disabled:!Ue||wr,size:"small",children:wr?"Testing...":"Test Connection"}),Cr==="success"&&o.jsx(U,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úì Connection successful"}),Cr==="error"&&o.jsx(U,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úó Connection failed"})]}),o.jsx(vt,{severity:"info",variant:"outlined",children:o.jsxs(U,{variant:"body2",children:[o.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",ge==="gemini"?"Google":"OpenAI","."]})})]})]})}),o.jsxs(tr,{children:[o.jsx(ie,{onClick:ho,children:"Cancel"}),o.jsx(ie,{onClick:es,variant:"contained",color:"primary",disabled:ge!=="disabled"&&!Ue,children:"Save"})]})]}),o.jsxs(Zo,{open:On,onClose:qr,fullWidth:!0,maxWidth:"md",children:[o.jsx(Qo,{children:"About Savora Viewer"}),o.jsxs(er,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[o.jsx(U,{variant:"h6",gutterBottom:!0,children:"Version 0.2.1 Preview"}),o.jsxs(U,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",o.jsx("br",{}),"For bug reporting and more information, visit our ",o.jsx(Hs,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",o.jsx("br",{}),o.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),o.jsx(U,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Multiple format support (IFC, Fragments)",o.jsx("br",{}),"‚Ä¢ Pan, zoom, rotate navigation",o.jsx("br",{}),"‚Ä¢ Selection via point-and-click or rectangular region",o.jsx("br",{}),"‚Ä¢ Orthogonal projection for accurate measurements",o.jsx("br",{}),"‚Ä¢ View management (zoom to fit, home, cube orientation)",o.jsx("br",{}),"‚Ä¢ Toggle performance stats",o.jsx("br",{}),"‚Ä¢ Object measurement tools",o.jsx("br",{}),"‚Ä¢ Clipping planes for sectional views"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Spatial and classification hierarchy navigation",o.jsx("br",{}),"‚Ä¢ Tree-based model structure view",o.jsx("br",{}),"‚Ä¢ Properties panel with expand/collapse",o.jsx("br",{}),"‚Ä¢ Search and filter functionality",o.jsx("br",{}),"‚Ä¢ Property export (CSV, JSON)",o.jsx("br",{}),"‚Ä¢ Favorites system for quick access",o.jsx("br",{}),"‚Ä¢ Parametric filtering with Ghost/Isolate modes"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Validate models against Information Delivery Specification (IDS)",o.jsx("br",{}),"‚Ä¢ Load IDS files from local storage",o.jsx("br",{}),"‚Ä¢ Visual feedback: green (pass) and red (fail) indicators",o.jsx("br",{}),"‚Ä¢ Filter models by validation results",o.jsx("br",{}),"‚Ä¢ Export validation reports"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Visual authoring tool for IDS specifications",o.jsx("br",{}),"‚Ä¢ Capture and define validation rules",o.jsx("br",{}),"‚Ä¢ Property picker for easy specification setup",o.jsx("br",{}),"‚Ä¢ Save and load IDS files",o.jsx("br",{}),"‚Ä¢ Integration with IDS Checker for immediate validation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Natural language queries about model contents",o.jsx("br",{}),"‚Ä¢ Intelligent model analysis and insights",o.jsx("br",{}),"‚Ä¢ Context-aware responses based on selected elements",o.jsx("br",{}),"‚Ä¢ Interactive chat interface",o.jsx("br",{}),"‚Ä¢ Selection and filtering via conversation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Floating toolbar for model operations",o.jsx("br",{}),"‚Ä¢ Tooltips and keyboard shortcuts",o.jsx("br",{}),"‚Ä¢ Collapsible side panels",o.jsx("br",{}),"‚Ä¢ Responsive layout",o.jsx("br",{}),"‚Ä¢ Dark theme optimized for long viewing sessions"]})]}),o.jsx(tr,{children:o.jsx(ie,{onClick:qr,color:"primary",children:"Close"})})]}),o.jsxs(Zo,{open:Un,onClose:Wr,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Qo,{children:"Export properties"}),o.jsxs(er,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[o.jsxs(dn,{component:"fieldset",variant:"standard",children:[o.jsx(un,{component:"legend",children:"Scope"}),o.jsxs(fn,{value:Qe,onChange:e=>Mr(e.target.value),children:[o.jsx(Ht,{value:"selected",control:o.jsx(qt,{}),label:"Selected items",disabled:!ae.length}),o.jsx(Ht,{value:"model",control:o.jsx(qt,{}),label:"Specific model",disabled:!j.length})]})]}),o.jsx(qs,{in:Qe==="model",unmountOnExit:!0,children:o.jsx(Ut,{select:!0,fullWidth:!0,label:"Model",value:et,onChange:e=>io(e.target.value),disabled:!j.length,children:j.map(e=>o.jsx(or,{value:e.id,children:e.label},e.id))})}),Qe==="selected"&&!ae.length&&o.jsx(vt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),zr&&o.jsx(vt,{severity:"error",variant:"outlined",children:zr})]}),o.jsxs(tr,{children:[o.jsx(ie,{onClick:Wr,disabled:ut,children:"Cancel"}),o.jsx(ie,{variant:"contained",onClick:Xn,disabled:ut||Qe==="selected"&&!ae.length||Qe==="model"&&!et,children:ut?"Exporting‚Ä¶":"Export CSV"})]})]}),o.jsxs(d.Suspense,{fallback:null,children:[o.jsx(ql,{isOpen:Je,onOpen:ns,onClose:ss,viewerApi:qo,hasModel:j.length>0,expandSignal:Gn}),o.jsx(Kl,{isOpen:Ze,onClose:()=>kr(!1),viewerApi:qo,selectedItemData:q,onValidate:ls}),o.jsx(Hl,{getModelDataForAI:ms,isOpen:Xe,onOpen:Jn,onClose:Zn,expandSignal:Nn,onRequestSelection:fs,onOpenSettings:Kr})]}),o.jsxs(Ks,{open:!!no,onClose:bs,anchorReference:"anchorPosition",anchorPosition:no?{top:no.mouseY,left:no.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[o.jsx(or,{onClick:gs,disabled:v.length===0,children:"Hide selected element"}),o.jsx(or,{onClick:ys,children:"Reset hidden elements"})]})]})};function So(t,l=2e3){try{if(t==null)return"null";const a=typeof t=="string"?t:JSON.stringify(t,null,2);return a?a.length<=l?a:`${a.slice(0,l)}
... [truncated ${a.length-l} chars]`:""}catch{return String(t)}}Ys.createRoot(document.getElementById("root")).render(o.jsx(At.StrictMode,{children:o.jsx(ai,{})}));export{jl as a,Bl as b,gi as g,nr as i,xl as l,hi as p,Cl as s,Wl as u};
