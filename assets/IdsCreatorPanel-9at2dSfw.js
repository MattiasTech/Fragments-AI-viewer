import{cm as o,cn as Ce,co as e,cH as Ie,cF as ke,cp as d,cq as f,cP as G,cs as b,dE as we,dF as De,dr as Ne,cI as Pe,cJ as qe,cK as Ae,cA as D,dG as Re,dt as T,du as H,dH as Oe,dw as J,dI as U,dA as se,cQ as $e,dJ as ze,dK as Ee,d7 as Le,d8 as Be,d9 as Ve,d3 as _,d4 as Y,d5 as X,d6 as j,de as We,dL as Fe}from"./vendor-CbOrIqGz.js";import{g as ae,p as Me}from"./index-CDDEq_cA.js";import"./thatopen-vendor-89_NjnSE.js";import"./three-vendor-kQcUiZz9.js";const _e=({isOpen:oe,onClose:ce,viewerApi:Ge,selectedItemData:N,onValidate:P})=>{const K=o.useRef(null),Q=o.useRef(null),[C,de]=o.useState(!1),[y,q]=o.useState([]),[c,A]=o.useState(null),[I,Z]=o.useState("new-project.ids"),h=o.useCallback((t,r)=>{q(l=>l.map(n=>n.id===t?r(n):n))},[]),ue=o.useCallback(t=>{q(r=>{const l=r.filter(n=>n.id!==t);return A(n=>n&&n!==t?n:l[0]?.id??null),l})},[]),R=o.useMemo(()=>{if(!N)return null;try{const t={...N};["geometry","expressID","bits","handle","buffer"].forEach(n=>delete t[n]);const l=new WeakSet;return JSON.stringify(t,(n,i)=>{if(typeof i=="bigint")return i.toString();if(typeof i=="object"&&i!==null){if(l.has(i))return"[Circular]";l.add(i)}return typeof i=="string"&&i.length>1e3?i.substring(0,1e3)+"... (truncated)":i},2)}catch(t){return console.warn("Failed to stringify selected item data for IDS creator inspector",t),"Unable to display selected element properties (Data too large)."}},[N]),u=o.useMemo(()=>{if(!R||R.startsWith("Unable"))return null;try{return JSON.parse(R)}catch{return null}},[R]),O=o.useMemo(()=>{if(!u)return[];const t=[],r=n=>n==null?"—":typeof n=="object"?"value"in n?r(n.value):"Value"in n?r(n.Value):n instanceof Date?n.toLocaleString():Array.isArray(n)?`[${n.length} items]`:"[Object]":String(n),l=u.IsDefinedBy||u.isDefinedBy;return Array.isArray(l)&&l.forEach(n=>{if(!n||typeof n!="object")return;const i=n.Name?.value||n.name?.value||n.Name||n.name||n.type;if(!i||typeof i!="string")return;const s=n.HasProperties||n.hasProperties||n.properties||n.Properties;Array.isArray(s)&&s.forEach(a=>{if(!a||typeof a!="object")return;const p=a.Name?.value||a.name?.value||a.Name||a.name;if(!p||typeof p!="string")return;const x=a.NominalValue?.value||a.nominalValue?.value||a.NominalValue||a.nominalValue||a.value||a.Value,v=`${i} / ${p}`;t.push({label:v,value:r(x),psetName:i})})}),t.sort((n,i)=>n.psetName!==i.psetName?n.psetName.localeCompare(i.psetName):n.label.localeCompare(i.label)),t},[u]),ee=o.useCallback(t=>{const r={};if(!t||typeof t!="object")return{};const l=(s,a)=>{const p=typeof s=="string"?s:s?.toString?.()==="[object Object]"?null:String(s);!p||p==="[object Object]"||p==="null"||p==="undefined"||(r[p]||(r[p]=new Set),Array.isArray(a)&&a.forEach(x=>x&&r[p].add(String(x))))},n=s=>{if(!s)return null;if(typeof s=="string")return s;if(typeof s=="number")return String(s);if(typeof s=="object"){if(s.value!==void 0)return n(s.value);if(s.Value!==void 0)return n(s.Value)}return null};try{const s=t.IsDefinedBy||t.isDefinedBy;if(Array.isArray(s))for(const a of s){if(!a||typeof a!="object")continue;const p=n(a.Name)||n(a.name);if(!p)continue;const x=a.HasProperties||a.hasProperties;if(!Array.isArray(x))continue;const v=[];for(const B of x){if(!B||typeof B!="object")continue;const ie=n(B.Name)||n(B.name);ie&&v.push(ie)}v.length>0&&l(p,v)}}catch(s){console.error("Error extracting property sets from IsDefinedBy:",s)}const i={};for(const[s,a]of Object.entries(r))s&&s!=="[object Object]"&&(i[s]=Array.from(a).sort());return i},[]),m=o.useMemo(()=>y.find(t=>t.id===c),[y,c]),pe=o.useCallback(t=>{if(!c)return;const r=t.target.value;h(c,l=>({...l,name:r}))},[c,h]),te=o.useCallback(t=>{if(c){if(!u){alert("Select an element in the viewer first to capture its data.");return}h(c,r=>{let l=u;try{l=JSON.parse(JSON.stringify(u))}catch{l=u}let n=u?.ifcClass;!n&&u?._category?.value&&(n=u._category.value),!n&&u?.constructor?.name&&(n=u.constructor.name);const i={capturedAt:new Date().toISOString(),sourceGlobalId:u?.GlobalId||u?._guid?.value||"unknown",ifcClass:n,sample:l};return t==="applicability"?{...r,applicability:[...r.applicability,i]}:{...r,requirements:[...r.requirements,i]}})}},[c,u,h]),fe=o.useCallback((t,r)=>{c&&h(c,l=>{if(t==="applicability"){const i=[...l.applicability];return i.splice(r,1),{...l,applicability:i}}const n=[...l.requirements];return n.splice(r,1),{...l,requirements:n}})},[c,h]),xe=()=>{const t=`spec-${Date.now()}`,r={id:t,name:"New Specification",description:"",applicability:[],requirements:[]};q(l=>[...l,r]),A(t)},[me,k]=o.useState(!1),[V,re]=o.useState(null),[g,$]=o.useState(null),[w,z]=o.useState(null),[E,ne]=o.useState({}),[W,F]=o.useState("equals"),[M,L]=o.useState("");o.useCallback(t=>{const r=m?.applicability?.[t]?.sample;if(!r)return;const l=ee(r);ne(l),re(t),$(Object.keys(l)[0]??null),z(Object.keys(l)[0]?l[Object.keys(l)[0]][0]??null:null),L(""),k(!0)},[m]);const he=o.useCallback(()=>{if(!c||V==null||!g||!w)return;const t=y.find(i=>i.id===c);if(!t)return;const r=t.applicability?.[V]?.sample;let l;try{const i=r?.IsDefinedBy||r?.isDefinedBy;if(Array.isArray(i)){for(const s of i)if((s?.Name?.value||s?.name?.value)===g){const p=s.HasProperties||s.hasProperties;if(Array.isArray(p)){for(const x of p)if((x?.Name?.value||x?.name?.value)===w){l=x?.NominalValue?.value||x?.nominalValue?.value||x?.NominalValue||x?.nominalValue;break}}break}}}catch(i){console.error("Error extracting property value:",i)}const n={id:`rule-${Date.now()}`,propertyPath:`${g}.${w}`,operator:W,value:M||(l!=null?String(l):""),sample:r??null};h(c,i=>{if((S.current??null)!=null){const s=S.current,a=[...i.requirements];return a[s]=n,S.current=null,{...i,requirements:a}}return{...i,requirements:[...i.requirements,n]}}),k(!1)},[c,V,g,w,W,M,y,h]),S=Ce.useRef(null),le=o.useCallback(t=>{if(!t)return"Captured element";const r=t.sample??t,l=t.sourceGlobalId||r?.GlobalId||r?._guid||r?.guid||r?.Tag&&r.Tag.value||"unknown",n=t.ifcClass||r&&r._category&&r._category.value||r?.ifcClass||"IfcElement",i=r&&(r.Name&&r.Name.value||r.ObjectType||r.Name)||void 0;return l!=="unknown"?`${n} (${l})`:i?`${n} — ${String(i).substring(0,40)}`:`${n} (captured)`},[]),ye=o.useCallback(t=>{c&&h(c,r=>{const l=r.applicability?.[t]??null;if(!l)return r;const n=JSON.parse(JSON.stringify(l));return{...r,requirements:[...r.requirements,n]}})},[c,h]),be=o.useCallback(t=>{if(!m)return;const r=m.requirements[t];let l=null;if(r&&r.sample){const s=m.applicability.findIndex(a=>a&&a.sourceGlobalId===r.sourceGlobalId);l=s>=0?s:null}S.current=t,re(l);const n=r?.sample??(l!=null?m.applicability?.[l]?.sample:null),i=n?ee(n):{};if(ne(i),r&&r.propertyPath){const[s,a]=String(r.propertyPath).split(".");$(s??Object.keys(i)[0]??null),z(a??(s?i[s]?.[0]??null:Object.values(i)[0]?.[0]??null)),F(r.operator??"equals"),L(r.value??"")}else $(Object.keys(i)[0]??null),z(Object.keys(i)[0]?i[Object.keys(i)[0]][0]??null:null),F("equals"),L("");k(!0)},[m]),je=o.useCallback(t=>{c&&h(c,r=>{const l=[...r.requirements];return l.splice(t,1),{...r,requirements:l}})},[c,h]),ge=o.useCallback(()=>{try{const t=ae(y),r=new Blob([t],{type:"application/xml"}),l=URL.createObjectURL(r),n=document.createElement("a");n.href=l,n.download=I.endsWith(".ids")?I:`${I}.ids`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(l)}catch(t){console.error("Failed to generate or save IDS file:",t),alert("Error: Could not save IDS file. See console for details.")}},[y,I]),Se=o.useCallback(()=>{if(P){if(y.length===0){alert("Please add at least one specification before validating.");return}try{const t=ae(y);P(t)}catch(t){console.error("Failed to generate IDS XML for validation:",t),alert("Error: Could not generate IDS XML. See console for details.")}}},[y,P]),ve=o.useCallback(t=>{const r=t.target.files?.[0];if(!r)return;Z(r.name);const l=new FileReader;l.onload=n=>{try{const i=n.target?.result,s=Me(i);q(s),A(s[0]?.id||null)}catch(i){console.error("Failed to parse IDS file:",i),alert("Error: Could not parse IDS file. Ensure it is a valid .ids XML file.")}},l.readAsText(r),t.target.value=""},[]);return oe?e.jsx(Ie,{nodeRef:K,handle:".ids-creator-header",bounds:"parent",children:e.jsxs(ke,{ref:K,elevation:8,sx:{position:"fixed",top:140,left:40,width:900,height:C?"auto":600,minWidth:400,minHeight:C?56:300,maxWidth:"90vw",maxHeight:"80vh",display:"flex",flexDirection:"column",zIndex:1850,boxSizing:"border-box",overflow:"hidden"},children:[e.jsxs(d,{className:"ids-creator-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move",gap:2},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{whiteSpace:"nowrap"},children:"IDS Creator:"}),e.jsx(G,{value:I.replace(/\.ids$/,""),onChange:t=>Z(t.target.value),variant:"outlined",size:"small",placeholder:"filename",sx:{flex:1,maxWidth:300,"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255, 255, 255, 0.3)"},"&:hover fieldset":{borderColor:"rgba(255, 255, 255, 0.5)"},"&.Mui-focused fieldset":{borderColor:"rgba(255, 255, 255, 0.7)"}},"& .MuiInputBase-input":{py:.75}}}),e.jsx(f,{variant:"body2",sx:{color:"rgba(255, 255, 255, 0.7)"},children:".ids"})]}),e.jsxs(d,{children:[e.jsx("input",{ref:Q,type:"file",accept:".ids, .xml",style:{display:"none"},onChange:ve}),e.jsx(b,{size:"small",color:"inherit",title:"Load IDS File",onClick:()=>Q.current?.click(),children:e.jsx(we,{})}),e.jsx(b,{size:"small",color:"inherit",title:"Save IDS File",onClick:ge,children:e.jsx(De,{})}),P&&e.jsx(b,{size:"small",color:"inherit",title:"Validate in IDS Checker",onClick:Se,disabled:y.length===0,children:e.jsx(Ne,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:()=>de(t=>!t),title:C?"Expand panel":"Minimize panel",children:C?e.jsx(Pe,{}):e.jsx(qe,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:ce,title:"Close IDS Creator",children:e.jsx(Ae,{})})]})]}),!C&&e.jsxs(d,{sx:{flex:1,display:"flex",minHeight:0},children:[e.jsxs(d,{sx:{width:250,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column"},children:[e.jsx(d,{sx:{p:1,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(D,{startIcon:e.jsx(Re,{}),fullWidth:!0,variant:"outlined",onClick:xe,children:"Add Specification"})}),e.jsx(T,{sx:{overflowY:"auto",flex:1},children:y.map(t=>e.jsx(H,{disablePadding:!0,secondaryAction:e.jsx(b,{edge:"end",size:"small",title:"Delete specification",onClick:r=>{r.stopPropagation(),ue(t.id)},children:e.jsx(U,{fontSize:"small"})}),children:e.jsx(Oe,{selected:t.id===c,onClick:()=>A(t.id),children:e.jsx(J,{primary:t.name})})},t.id))})]}),e.jsx(d,{sx:{flex:1,p:2,overflowY:"auto",display:"flex",flexDirection:"column",gap:2},children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{label:"Specification Name",value:m.name,onChange:pe,variant:"outlined",size:"small"}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Applicability (Which elements?)"}),e.jsxs(d,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture one or more example elements from the viewer to describe what this specification applies to."}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{size:"small",variant:"outlined",onClick:()=>te("applicability"),disabled:!u,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:u?"Current viewer selection will be stored as a template.":"Select an element to enable capture."})]}),m.applicability.length?e.jsx(T,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.applicability.map((t,r)=>{const l=t;l?.ifcClass?`${l.ifcClass}${l.sourceGlobalId||"unknown"}`:l?.sourceGlobalId;const n=l?.capturedAt?new Date(l.capturedAt).toLocaleString():"";return e.jsx(H,{secondaryAction:e.jsxs(d,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(b,{size:"small",title:"Copy to requirements",onClick:()=>ye(r),children:e.jsx($e,{fontSize:"small"})}),e.jsx(b,{edge:"end",size:"small",title:"Remove captured applicability",onClick:()=>fe("applicability",r),children:e.jsx(U,{fontSize:"small"})})]}),children:e.jsx(J,{primary:le(l),secondary:n?`Captured ${n}`:void 0})},`${l?.sourceGlobalId||"entry"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No applicability examples captured yet."})]}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Requirements (What must be true?)"}),e.jsxs(d,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture the same or other elements to store property snapshots you want to enforce as requirements."}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(D,{size:"small",variant:"outlined",onClick:()=>te("requirements"),disabled:!u,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:u?"Snapshot will be added to requirements.":"Select an element to enable capture."})]}),m.requirements.length?e.jsx(T,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.requirements.map((t,r)=>{const l=t,n=le(l),i=l?.capturedAt?new Date(l.capturedAt).toLocaleString():"";return e.jsxs(H,{children:[e.jsx(J,{primary:l.propertyPath?`${l.propertyPath} ${l.operator?`(${l.operator})`:""}`:n,secondary:l.propertyPath?`Expected: ${l.value??"(any)"}${i?` — captured ${i}`:""}`:i?`Captured ${i}`:void 0}),e.jsxs(ze,{children:[e.jsx(b,{size:"small",title:"Edit requirement",onClick:()=>be(r),children:e.jsx(Ee,{fontSize:"small"})}),e.jsx(b,{size:"small",title:"Remove requirement",onClick:()=>je(r),children:e.jsx(U,{fontSize:"small"})})]})]},`${l?.id||l?.sourceGlobalId||"req"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No requirement snapshots captured yet."})]})]}):e.jsx(d,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(f,{color:"text.secondary",children:"Load or create a specification to begin."})})}),e.jsxs(d,{sx:{width:300,borderLeft:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(d,{sx:{p:1.5,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle2",children:"Property Sets"}),e.jsx(f,{variant:"caption",color:"text.secondary",children:O.length>0?`${O.length} properties`:"Select an element"})]}),O.length>0?e.jsx(d,{sx:{flex:1,overflowY:"auto",p:1},children:e.jsx(d,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:O.map((t,r)=>e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[e.jsx(f,{variant:"caption",sx:{fontWeight:600,color:"text.secondary"},children:t.label}),e.jsx(f,{variant:"body2",sx:{wordBreak:"break-word"},children:t.value})]},r))})}):N?e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"No property sets found for this element."})}):e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"Select an element in the viewer to inspect its property sets."})})]})]}),e.jsxs(Le,{open:me,onClose:()=>k(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Be,{children:S.current!=null?"Edit Requirement":"Create Requirement"}),e.jsxs(Ve,{children:[e.jsxs(d,{sx:{display:"flex",gap:2,mt:1},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"pset-label",children:"Property Set"}),e.jsx(X,{labelId:"pset-label",value:g??"",label:"Property Set",onChange:t=>$(String(t.target.value)||null),children:Object.keys(E).length?Object.keys(E).map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]}),e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"prop-label",children:"Property"}),e.jsx(X,{labelId:"prop-label",value:w??"",label:"Property",onChange:t=>z(String(t.target.value)||null),children:g&&E[g]?E[g].map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]})]}),e.jsxs(d,{sx:{display:"flex",gap:2,mt:2},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"op-label",children:"Operator"}),e.jsxs(X,{labelId:"op-label",value:W,label:"Operator",onChange:t=>F(String(t.target.value)),children:[e.jsx(j,{value:"exists",children:"exists"}),e.jsx(j,{value:"equals",children:"equals"}),e.jsx(j,{value:"not-equals",children:"not equals"}),e.jsx(j,{value:"contains",children:"contains"}),e.jsx(j,{value:"matches",children:"matches (regex)"})]})]}),e.jsx(G,{fullWidth:!0,label:"Value (optional)",value:M,onChange:t=>L(t.target.value)})]})]}),e.jsxs(We,{children:[e.jsx(D,{onClick:()=>{k(!1),S.current=null},children:"Cancel"}),e.jsx(D,{variant:"contained",onClick:he,startIcon:e.jsx(Fe,{}),children:S.current!=null?"Save":"Create"})]})]})]})}):null};export{_e as default};
