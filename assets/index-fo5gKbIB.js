const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-D2pzQq-y.js","assets/vendor-CG379c7K.js","assets/thatopen-vendor-BXeQhCq_.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-Dge6kak2.js","assets/IdsCreatorPanel-BmOhSWSt.js","assets/QtoPanel-DSdgbAdx.js","assets/ModelFilterPanel-BGO2kxn2.js"])))=>i.map(i=>d[i]);
import{ck as ei,cl as ti,cm as d,cn as jt,co as r,cp as G,cq as U,cr as Q,cs as X,ct as ri,cu as oi,cv as ni,cw as si,cx as ii,cy as li,cz as ai,cA as se,cB as xn,cC as wn,cD as In,cE as Cn,cF as je,cG as ci,cH as Sn,cI as di,cJ as jn,cK as vn,cL as ui,cM as kn,cN as Xt,cO as $t,cP as Jt,cQ as fi,cR as pi,cS as Pn,cT as hi,cU as mi,cV as co,cW as gi,cX as yi,cY as bi,cZ as xi,c_ as En,c$ as An,d0 as Rn,d1 as wi,d2 as Ii,d3 as uo,d4 as Ci,d5 as Si,d6 as Er,d7 as fo,d8 as po,d9 as ho,da as Mn,db as zn,dc as Zt,dd as Qt,de as mo,df as ji,dg as vi,dh as ki,di as Pi}from"./vendor-CG379c7K.js";import{l as Ei,_ as Ai,C as Ri,W as Mi,S as zi,a as Di,O as $i,G as Fi,F as Ni,t as Oi,H as Ti,Y as Li,$ as Dn}from"./thatopen-vendor-BXeQhCq_.js";import{B as dt,V as ee,C as Te,a3 as Vi,c as go,P as Ft,a6 as yo,l as $n,G as _i,S as Bi,h as Fn,$ as Gi,y as Nn,ab as Wi,D as Ui}from"./three-vendor-kQcUiZz9.js";(function(){const i=document.createElement("link").relList;if(i&&i.supports&&i.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))g(l);new MutationObserver(l=>{for(const b of l)if(b.type==="childList")for(const h of b.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&g(h)}).observe(document,{childList:!0,subtree:!0});function c(l){const b={};return l.integrity&&(b.integrity=l.integrity),l.referrerPolicy&&(b.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?b.credentials="include":l.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function g(l){if(l.ep)return;l.ep=!0;const b=c(l);fetch(l.href,b)}})();const Hi="modulepreload",qi=function(t){return"/Savora-Viewer/"+t},On={},St=function(i,c,g){let l=Promise.resolve();if(c&&c.length>0){let v=function(y){return Promise.all(y.map(E=>Promise.resolve(E).then(P=>({status:"fulfilled",value:P}),P=>({status:"rejected",reason:P}))))};document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),p=h?.nonce||h?.getAttribute("nonce");l=v(c.map(y=>{if(y=qi(y),y in On)return;On[y]=!0;const E=y.endsWith(".css"),P=E?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${P}`))return;const V=document.createElement("link");if(V.rel=E?"stylesheet":Hi,E||(V.as="script"),V.crossOrigin="",V.href=y,p&&V.setAttribute("nonce",p),document.head.appendChild(V),E)return new Promise((N,j)=>{V.addEventListener("load",N),V.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${y}`)))})}))}function b(h){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=h,window.dispatchEvent(p),!p.defaultPrevented)throw h}return l.then(h=>{for(const p of h||[])p.status==="rejected"&&b(p.reason);return i().catch(b)})},Co="bim_viewer_api_config",Ki=t=>{try{return btoa(t)}catch{return t}},Yi=t=>{try{return atob(t)}catch{return t}},Xi=t=>{const i={...t,apiKey:Ki(t.apiKey)};localStorage.setItem(Co,JSON.stringify(i))},Ji=()=>{const t=localStorage.getItem(Co);if(!t)return null;try{const i=JSON.parse(t);return{...i,apiKey:Yi(i.apiKey)}}catch{return null}},Zi=()=>{localStorage.removeItem(Co)},Qi=t=>{switch(t){case"gemini":return["gemini-3.0-pro","gemini-3.0-flash","gemini-2.5-flash","gemini-2.0-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5.2","gpt-5.1","gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},Ar=t=>{switch(t){case"gemini":return"gemini-2.0-flash";case"openai":return"gpt-4o-mini";default:return""}},el=async(t,i,c="gemini-2.0-flash")=>{const g=`https://generativelanguage.googleapis.com/v1beta/models/${c}:generateContent?key=${t}`,l=3;let b=0;for(;b<l;)try{const h=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:i}]}]})});if(h.status===429){b++;const v=Math.pow(2,b)*1e3;console.warn(`Gemini API rate limited (429). Retrying in ${v}ms... (Attempt ${b}/${l})`),await new Promise(y=>setTimeout(y,v));continue}if(!h.ok){const v=await h.json().catch(()=>({}));throw new Error(v.error?.message||`Gemini API error: ${h.status} ${h.statusText}`)}const p=await h.json();if(!p.candidates||p.candidates.length===0)throw new Error("No response from Gemini API");return p.candidates[0].content.parts[0].text}catch(h){throw b===l-1,h}throw new Error("Gemini API request failed after max retries")},tl=async(t,i="gemini-2.0-flash-exp")=>{try{return await el(t,"Hello, respond with OK",i),!0}catch{return!1}},rl=async(t,i,c="gpt-4o-mini")=>{const l=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:c,messages:[{role:"user",content:i}]})});if(!l.ok){const h=await l.json().catch(()=>({}));throw new Error(h.error?.message||`OpenAI API error: ${l.status} ${l.statusText}`)}const b=await l.json();if(!b.choices||b.choices.length===0)throw new Error("No response from OpenAI API");return b.choices[0].message.content},ol=async(t,i="gpt-4o-mini")=>{try{return await rl(t,"Hello, respond with OK",i),!0}catch{return!1}},nl="fragments-ids",ie="elements-v5",de="cache-metadata-v1",sl=6,ke=()=>new Promise((t,i)=>{const c=indexedDB.open(nl,sl);c.onerror=()=>i(c.error??new Error("IndexedDB open failed")),c.onupgradeneeded=()=>{const g=c.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(b=>{g.objectStoreNames.contains(b)&&g.deleteObjectStore(b)}),g.objectStoreNames.contains(ie)||g.createObjectStore(ie),g.objectStoreNames.contains(de)||g.createObjectStore(de)},c.onsuccess=()=>t(c.result)}),bo={async get(t){const i=await ke();return new Promise((c,g)=>{const h=i.transaction(ie,"readonly").objectStore(ie).get(t);h.onsuccess=()=>c(h.result??null),h.onerror=()=>g(h.error??new Error("IndexedDB get failed"))})},async set(t,i){const c=await ke();await new Promise((g,l)=>{const b=c.transaction([ie,de],"readwrite"),h=b.objectStore(ie),p=b.objectStore(de),v=h.put(i,t),y={modelKey:t,timestamp:Date.now(),elementCount:i.length,version:"1.0"};p.put(y,t),v.onsuccess=()=>g(),v.onerror=()=>l(v.error??new Error("IndexedDB set failed"))})},async append(t,i){if(!i||!i.length)return;const c=await ke();await new Promise((g,l)=>{const b=c.transaction([ie,de],"readwrite"),h=b.objectStore(ie),p=b.objectStore(de),v=h.get(t);v.onsuccess=()=>{const E=(v.result??[]).concat(i),P=h.put(E,t),V={modelKey:t,timestamp:Date.now(),elementCount:E.length,version:"1.0"};p.put(V,t),P.onsuccess=()=>g(),P.onerror=()=>l(P.error??new Error("IndexedDB append put failed"))},v.onerror=()=>l(v.error??new Error("IndexedDB append get failed"))})},async writePart(t,i,c){const g=`${t}::part::${String(i).padStart(6,"0")}`,l=`${t}::partindex::${String(i).padStart(6,"0")}`,b=await ke();await new Promise((h,p)=>{const v=b.transaction([ie,de],"readwrite"),y=v.objectStore(ie),E=v.objectStore(de),P=y.put(c,g);P.onsuccess=()=>{const V=E.get(t);V.onsuccess=()=>{const N=V.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};N.timestamp=Date.now(),N.elementCount=(N.elementCount||0)+c.length;const j=Array.isArray(N.partKeys)?N.partKeys.slice():[];j.includes(g)||j.push(g),N.partKeys=j,E.put(N,t);try{const z=c.map(k=>k.GlobalId).filter(Boolean),L=y.put(z,l);L.onsuccess=()=>{},L.onerror=()=>{}}catch{}h()},V.onerror=()=>h()},P.onerror=()=>p(P.error??new Error("IndexedDB writePart failed"))})},async getPersistedIds(t){const i=await this.getPartKeys(t);if(!i||!i.length)return new Set;const c=await ke(),g=new Set;return await new Promise(l=>{const h=c.transaction(ie,"readonly").objectStore(ie);let p=i.length;i.forEach(v=>{const y=v.replace("::part::","::partindex::"),E=h.get(y);E.onsuccess=()=>{const P=E.result??[];for(const V of P)typeof V=="string"&&V&&g.add(V);p-=1,p===0&&l()},E.onerror=()=>{p-=1,p===0&&l()}})}),g},async getPartKeys(t){const i=await this.getMetadata(t);return Array.isArray(i?.partKeys)?i.partKeys:[]},async listParts(t){return(await this.getPartKeys(t)).slice().sort()},async readAllParts(t){const i=await ke(),c=await this.getPartKeys(t);return c.length?new Promise((g,l)=>{const h=i.transaction(ie,"readonly").objectStore(ie),p=[];let v=c.length;c.forEach(y=>{const E=h.get(y);E.onsuccess=()=>{const P=E.result??[];p.push(...P),v-=1,v===0&&g(p)},E.onerror=()=>{v-=1,v===0&&g(p)}})}):[]},async removeParts(t){const i=await ke(),c=`${t}::part::`,l=(await this.keys()).filter(b=>b.startsWith(c));l.length&&await new Promise((b,h)=>{const p=i.transaction([ie,de],"readwrite"),v=p.objectStore(ie),y=p.objectStore(de);l.forEach(E=>v.delete(E)),y.delete(t),p.oncomplete=()=>b(),p.onerror=()=>h(p.error??new Error("IndexedDB removeParts failed"))})},async getMetadata(t){const i=await ke();return new Promise((c,g)=>{const h=i.transaction(de,"readonly").objectStore(de).get(t);h.onsuccess=()=>c(h.result??null),h.onerror=()=>g(h.error??new Error("IndexedDB metadata get failed"))})},async remove(t){const i=await ke();await new Promise((c,g)=>{const l=i.transaction([ie,de],"readwrite"),b=l.objectStore(ie),h=l.objectStore(de);b.delete(t),h.delete(t),l.oncomplete=()=>c(),l.onerror=()=>g(l.error??new Error("IndexedDB delete failed"))})},async keys(){const t=await ke();return new Promise((i,c)=>{const b=t.transaction(ie,"readonly").objectStore(ie).getAllKeys();b.onsuccess=()=>i(b.result??[]),b.onerror=()=>c(b.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const t=await ke();return new Promise((i,c)=>{const b=t.transaction(de,"readonly").objectStore(de).getAll();b.onsuccess=()=>i(b.result??[]),b.onerror=()=>c(b.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(t=720*60*60*1e3){const i=await ke(),c=await this.getAllMetadata(),g=Date.now(),l=c.filter(b=>g-b.timestamp>t).map(b=>b.modelKey);l.length>0&&await new Promise((b,h)=>{const p=i.transaction([ie,de],"readwrite"),v=p.objectStore(ie),y=p.objectStore(de);l.forEach(E=>{v.delete(E),y.delete(E)}),p.oncomplete=()=>{b()},p.onerror=()=>h(p.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(t,i){const c=await this.getMetadata(t);return!c||!c.modelSignature?!1:c.modelSignature===i},async updateSignature(t,i,c){const g=await ke();await new Promise((l,b)=>{const p=g.transaction(de,"readwrite").objectStore(de),v=p.get(t);v.onsuccess=()=>{const y=v.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};y.modelSignature=i,y.modelFiles=c,y.timestamp=Date.now();const E=p.put(y,t);E.onsuccess=()=>l(),E.onerror=()=>b(E.error??new Error("IndexedDB updateSignature failed"))},v.onerror=()=>b(v.error??new Error("IndexedDB updateSignature get failed"))})}},il=async t=>{const i=new TextEncoder,c=`${t.modelUrl}|${t.extra??""}`,g=i.encode(c),l=await crypto.subtle.digest("SHA-256",g),b=new Uint8Array(l);return btoa(String.fromCharCode(...b)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},Un={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},tt=t=>t==null?[]:Array.isArray(t)?t:[t],Tn=t=>{if(t==null)return[];if(typeof t=="string")try{const i=JSON.parse(t);return Array.isArray(i)?i:[]}catch{return[]}if(typeof t=="object"){const i=t;if(typeof i.__cdata=="string")try{const c=JSON.parse(i.__cdata);return Array.isArray(c)?c:[]}catch{return[]}if(Array.isArray(i.item))return i.item;if(i.item!=null)return[i.item];if(Array.isArray(i.Rule))return i.Rule;if(i.Rule!=null)return[i.Rule]}return Array.isArray(t)?t:[]},Xl=t=>{if(!t||typeof t!="string")return[];const i=new ti(Un);let c={};try{c=i.parse(t)}catch(y){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",y),[]}const g=c?.IdsCreator??c?.idsCreator??c?.IDS_CREATOR??c?.Ids??c,l=g?.Specification??g?.specification??g?.Specifications??g?.specifications??null;if(l){const y=tt(l);if(y.length)return y.map((E,P)=>{const V=E?.["@_id"]?.trim?.()||`spec-${P+1}`,N=(E?.Name??E?.name??"")?.toString?.()??"",j=(E?.Description??E?.description??"")?.toString?.()??"",z=Tn(E?.Applicability??E?.applicability),L=Tn(E?.Requirements??E?.requirements);return{id:V,name:N,description:j,applicability:z,requirements:L}})}const b=y=>{if(!y||typeof y!="object")return[];for(const[E,P]of Object.entries(y)){const V=String(E).toLowerCase();if(V.endsWith(":specification")||V==="specification"||V==="ids:specification")return tt(P)}for(const E of Object.values(y))if(E&&typeof E=="object"){const P=b(E);if(P&&P.length)return P}return[]},h=b(c);if(!h.length)return[];const p=y=>{if(!y)return null;if(typeof y=="string")return y;if(typeof y=="object")for(const E of Object.keys(y)){const P=E.toLowerCase();if(P.includes("simplevalue")||P==="#text"||P==="value"){const V=y[E];if(typeof V=="string")return V;if(typeof V=="object"&&(V?.value||V?.Value))return String(V.value??V.Value)}}return null};return h.map((y,E)=>{const P=y?.["@_id"]?.trim?.()||`spec-${E+1}`,V=y?.["@_name"]??y?.name??y?.Name??"",N=String(V??""),j="",z=[],L=[],k=y?.applicability??y?.Applicability??y?.["ids:applicability"]??null,$=tt(k);for(const J of $){let oe=null;const Y=[J];for(;Y.length&&!oe;){const H=Y.shift();if(!H)continue;const $e=p(H);if($e){oe=$e;break}if(typeof H=="object")for(const we of Object.values(H))we&&typeof we=="object"&&Y.push(we)}oe&&z.push({entity:oe})}const q=y?.requirements??y?.Requirements??y?.["ids:requirements"]??null,he=tt(q),te=J=>{const oe=[],Y=[];if(J?.property&&Y.push(...tt(J.property)),J?.Property&&Y.push(...tt(J.Property)),Array.isArray(J)&&Y.push(...J),!Y.length&&typeof J=="object")for(const H of Object.values(J))H&&typeof H=="object"&&Y.push(H);for(const H of Y){const $e=H?.propertySet??H?.PropertySet??H?.["ids:propertySet"]??H?.propertySet,we=H?.baseName??H?.BaseName??H?.["ids:baseName"]??H?.baseName,ot=p($e)||p(H?.propertySet?.simpleValue)||p(H?.propertySet?.["ids:simpleValue"]),Ot=p(we)||p(H?.baseName?.simpleValue)||p(H?.baseName?.["ids:simpleValue"]),Ke=[],ye=H?.allowedValues??H?.AllowedValues??H?.["ids:allowedValues"];if(ye){const Ye=ye?.values??ye?.Values??ye?.["ids:values"]??ye,Tt=tt(Ye?.value??Ye?.Value??Ye?.["ids:value"]??Ye??[]);for(const nt of Tt){const Fe=p(nt)||p(nt?.simpleValue)||p(nt?.["ids:simpleValue"]);Fe&&Ke.push(Fe)}}if(ot||Ot){const Ye={id:`rule-${E}-${oe.length}`,propertyPath:`${ot??"Pset"}.${Ot??"Property"}`,operator:"equals"};Ke.length&&(Ye.value=Ke.length===1?Ke[0]:JSON.stringify(Ke)),oe.push(Ye)}}return oe};for(const J of he){const oe=te(J);oe.length&&L.push(...oe)}return{id:P,name:String(N??""),description:String(j),applicability:z,requirements:L}})},Jl=t=>{const i=new ei(Un);if((t??[]).some(b=>Array.isArray(b.requirements)&&b.requirements.some(h=>h&&typeof h=="object"&&"propertyPath"in h))){const h={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(t??[]).map(v=>{const y=[],E=j=>{if(!j&&j!==0)return null;if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(j?.ifcClass&&typeof j.ifcClass=="string"&&j.ifcClass.trim())return j.ifcClass.trim();const z=j?.entity??j?.ifcType??j?.type;if(z&&typeof z=="string"&&z.trim())return z.trim();const L=j?.sample??j;if(L){if(L._category&&typeof L._category=="object"){const $=L._category.value??L._category.Value;if(typeof $=="string"&&$.trim())return $.trim()}const k=L?.ifcClass??L?.category?.value??L?.type??L?._type;if(k&&typeof k=="string"&&k.trim())return k.trim()}return null};for(const j of tt(v.applicability)){const z=E(j)??null,L=z&&String(z).trim()?String(z):"IFCELEMENT";y.push({"ids:name":{"ids:simpleValue":L}})}const P=[],V=j=>{if(j==null)return"";if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(typeof j=="object"){if(j["ids:simpleValue"])return String(j["ids:simpleValue"]);if(j.__cdata)return String(j.__cdata);if(j.Name)return String(j.Name);if(j.name)return String(j.name);for(const z of Object.keys(j)){const L=j[z];if(typeof L=="string"&&L.trim())return L;if(L&&typeof L=="object"){const k=L;if(typeof k["ids:simpleValue"]=="string")return k["ids:simpleValue"];if(typeof k.value=="string")return k.value}}return""}return""};for(const j of tt(v.requirements))if(j&&typeof j=="object"){const z=j;let L=null,k=null;if(typeof z.propertyPath=="string"){const[Y,H]=String(z.propertyPath).split(".");L=Y,k=H}else z.propertyPath&&typeof z.propertyPath=="object"?(L=z.propertyPath.pset??z.propertyPath.propertySet??z.propertySet??null,k=z.propertyPath.property??z.propertyPath.prop??z.property??z.propertyName??null):(L=z.propertySet??z.pset??null,k=z.baseName??z.property??z.prop??null);const $=V(L)||"Pset",q=V(k)||"Property",he=rr($)||$,te=rr(q)||q,J={};if(J["ids:propertySet"]={"ids:simpleValue":he},J["ids:baseName"]={"ids:simpleValue":te},(z.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(z.value!=null&&String(z.value).trim()){let Y=null;try{const H=typeof z.value=="string"?JSON.parse(z.value):z.value;Array.isArray(H)&&(Y=H.map($e=>String($e)))}catch{}Y||typeof z.value=="string"&&z.value.includes(",")&&(Y=z.value.split(",").map(H=>Dr(H.trim())).filter(Boolean)),Y&&Y.length?J["ids:allowedValues"]={"ids:values":{"ids:value":Y.map(H=>({"ids:simpleValue":Dr(String(H))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":Dr(String(z.value))}}}}P.push({"ids:property":J})}const N={"@_ifcVersion":"IFC4","@_name":v.name??""};return y.length&&(N["ids:applicability"]={"ids:entity":y.map(j=>({"ids:name":j["ids:name"]?j["ids:name"]:j}))}),P.length&&(N["ids:requirements"]={"ids:property":P.map(j=>j["ids:property"])}),N})}},p=i.build(h);return p.startsWith("<?xml")?p:`<?xml version="1.0" encoding="UTF-8"?>
${p}`}const g={IdsCreator:{Specification:(t??[]).map(b=>({"@_id":b.id,Name:b.name,Description:b.description,Applicability:{__cdata:JSON.stringify(b.applicability??[])},Requirements:{__cdata:JSON.stringify(b.requirements??[])}}))}},l=i.build(g);return l.startsWith("<?xml")?l:`<?xml version="1.0" encoding="UTF-8"?>
${l}`},rr=t=>t?t.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Dr=t=>!t||typeof t!="string"?t:t.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),Hn=t=>{if(t==null)return"";if(typeof t=="string")return Dr(t.trim());if(typeof t=="number"||typeof t=="boolean")return String(t);try{return JSON.stringify(t)}catch{return String(t)}},ll=t=>{if(!t)return{};const i={};for(const[c,g]of Object.entries(t)){if(!g||typeof g!="object")continue;const l=rr(c)||c;for(const[b,h]of Object.entries(g)){const p=rr(b)||b,v=`${l}.${p}`;v in i||(i[v]=Hn(h))}}return i};let It=null;const al=()=>{It=null},cl=t=>t.slice().sort().join("|"),dl=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],ul=(t,i)=>{if(!t||typeof t!="object")return;const c=i.map(b=>b.toLowerCase()),g=new WeakSet,l=[t];for(;l.length;){const b=l.pop();if(!(!b||typeof b!="object")&&!g.has(b)){if(g.add(b),Array.isArray(b)){for(const h of b)h&&typeof h=="object"&&l.push(h);continue}for(const[h,p]of Object.entries(b)){const v=h.toLowerCase();if(c.some(y=>v.includes(y)))if(typeof p=="string"){const y=p.trim();if(y)return y}else{if(typeof p=="number"&&Number.isFinite(p))return p.toString();if(typeof p=="boolean")return p?"true":"false";if(p&&typeof p=="object"){const y=p;if(typeof y.value=="string"){const E=y.value.trim();if(E)return E}if(typeof y.Value=="string"){const E=y.Value.trim();if(E)return E}y.value&&typeof y.value=="object"&&l.push(y.value),y.Value&&typeof y.Value=="object"&&l.push(y.Value)}}p&&typeof p=="object"&&l.push(p)}}}},fl=t=>{if(!t||typeof t!="object")return null;const i=t;for(const g of dl){const l=i[g];if(typeof l=="string"&&l.trim().length)return l.trim()}return ul(t,["globalid","global id","guid","uniqueid"])?.trim()??null},Rr=async(t,i,c)=>{const g=[],l=Math.max(i.length,1);c?.onProgress?.({done:0,total:l});const b=t.getElementProps;for(let h=0;h<i.length;h++){const p=i[h];try{const{ifcClass:v,psets:y,attributes:E}=await b.call(t,p),P=ll(y);if("GlobalId"in P||(P.GlobalId=p),E)for(const[V,N]of Object.entries(E)){const z=`Attributes.${rr(V)||V}`;z in P||(P[z]=Hn(N))}P.ifcClass||(P.ifcClass=v),g.push({GlobalId:p,ifcClass:v,properties:P}),(h%50===0||h===i.length-1)&&c?.onProgress?.({done:g.length,total:l})}catch(v){console.warn(`IDS adapter (direct) failed to load element ${p}`,v)}}return c?.onProgress?.({done:g.length,total:l}),g},pl=async(t,i,c)=>{if(typeof t.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const g=Math.max(1,(navigator.hardwareConcurrency||4)-1),l=[],b=[],h=[];for(let y=0;y<g;y++){const E=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});l.push(E);const P=new Promise((V,N)=>{const j=L=>{const k=L.data;if(k){if(k.type==="error"){N(new Error(k.message||`Worker ${y} failed.`));return}if(k.type==="progress"){const $=h.reduce((q,he)=>q+he.length,0)+k.done;c?.onProgress?.({done:$,total:Math.max(i,$)});return}k.type==="done"&&(h[y]=k.elements??[],V(k.elements??[]))}},z=L=>{N(L.error??new Error(L.message||`Worker ${y} error.`))};E.addEventListener("message",j),E.addEventListener("error",z)});b.push(P),E.postMessage({type:"build-props",reset:!0,total:i})}c?.onProgress?.({done:0,total:i});const p=new Set;let v=0;try{for await(const y of t.iterElements({batchSize:128})){if(!Array.isArray(y)||!y.length)continue;const E=[];y.forEach(P=>{if(!P||typeof P!="object")return;const V=P.data;if(!V)return;const N=fl(V);if(!N||p.has(N))return;p.add(N);const j=typeof V.ifcClass=="string"?V.ifcClass:void 0;E.push({globalId:N,ifcClass:j,data:V})}),E.length&&(l[v].postMessage({type:"build-props",elements:E}),v=(v+1)%g)}}catch(y){throw l.forEach(E=>{E.postMessage({type:"cancel"}),E.terminate()}),y}l.forEach(y=>{y.postMessage({type:"build-props",final:!0})});try{const E=(await Promise.all(b)).flat();return c?.onProgress?.({done:E.length,total:Math.max(i,E.length)}),E}finally{l.forEach(y=>y.terminate())}},hl=async(t,i)=>{try{const c=typeof i.countElements=="function"?await i.countElements():void 0;return await il({modelUrl:t,extra:c!=null?String(c):void 0})}catch(c){return console.warn("IDS adapter: failed to compute model key for cache",c),null}},qn=async(t,i)=>{if(!t)return[];let c;if(i?.filterGlobalIds&&i.filterGlobalIds.length>0?c=i.filterGlobalIds:c=await t.listGlobalIds(),!c.length)return It=null,[];const g=cl(c),l=Math.max(c.length,1);if(i?.onPhase?.("BUILDING_PROPERTIES"),i?.onProgress?.({done:0,total:l}),It&&It.token===g)return It.elements;const b=i?.filterGlobalIds&&i.filterGlobalIds.length>0;let h=null;if(!b&&(h=await hl(g,t),h))try{const v=await bo.get(h);if(v&&v.length){const y=await bo.getMetadata(h),E=y?Math.round((Date.now()-y.timestamp)/1e3/60):0;return i?.onProgress?.({done:v.length,total:l}),It={token:g,elements:v},v}}catch(v){console.warn("IDS adapter: failed to read cached elements from IndexedDB",v)}let p=[];if(b)p=await Rr(t,c,i);else{const v=typeof t.countElements=="function"?await t.countElements().catch(()=>c.length):c.length;if(typeof t.iterElements=="function")try{p=await pl(t,v??c.length,i),p.length||(p=await Rr(t,c,i))}catch(y){console.warn("IDS adapter: property build worker failed, falling back to direct collection",y),p=await Rr(t,c,i)}else p=await Rr(t,c,i)}return h&&p.length&&bo.set(h,p).catch(v=>console.warn("IDS adapter: failed to persist elements cache",v)),It={token:g,elements:p},i?.onProgress?.({done:Math.min(p.length,l),total:l}),p};class ft{static instance;viewerApi=null;elements=[];indices={byCategory:new Map,byGlobalId:new Map,searchIndex:new Map};isIndexing=!1;isReady=!1;constructor(){}static getInstance(){return ft.instance||(ft.instance=new ft),ft.instance}setViewerApi(i){this.viewerApi=i}async indexModel(i=!1){if(!this.viewerApi){console.warn("AIQueryEngine: ViewerApi not set");return}if(!this.isIndexing)try{this.isIndexing=!0,console.log("AIQueryEngine: Starting indexing...");const c=await qn(this.viewerApi);this.elements=c,this.buildIndices(c),this.isReady=!0,console.log(`AIQueryEngine: Indexed ${c.length} elements.`)}catch(c){console.error("AIQueryEngine: Indexing failed",c)}finally{this.isIndexing=!1}}buildIndices(i){this.indices.byCategory.clear(),this.indices.byGlobalId.clear(),this.indices.searchIndex.clear();for(const c of i){const g=c.ifcClass.toUpperCase();this.indices.byCategory.has(g)||this.indices.byCategory.set(g,[]),this.indices.byCategory.get(g).push(c),this.indices.byGlobalId.set(c.GlobalId,c);const l=new Set,b=h=>{if(!h)return;String(h).toLowerCase().split(/[^a-z0-9]+/g).forEach(v=>{v.length>2&&l.add(v)})};if(b(c.ifcClass),c.properties)for(const[h,p]of Object.entries(c.properties))b(p);for(const h of l)this.indices.searchIndex.has(h)||this.indices.searchIndex.set(h,new Set),this.indices.searchIndex.get(h).add(c.GlobalId)}}search(i){if(!i)return[];const c=i.toLowerCase().split(/[^a-z0-9]+/g).filter(l=>l.length>2);if(c.length===0)return[];let g=null;for(const l of c){const b=this.indices.searchIndex.get(l);if(b)if(g===null)g=new Set(b);else{const h=g;g=new Set([...h].filter(p=>b.has(p)))}else{let h=new Set;for(const[p,v]of this.indices.searchIndex.entries())if(p.includes(l))for(const y of v)h.add(y);if(h.size===0)return[];if(g===null)g=h;else{const p=g;g=new Set([...p].filter(v=>h.has(v)))}}}return!g||g.size===0?[]:Array.from(g).map(l=>this.indices.byGlobalId.get(l)).filter(Boolean)}async generateContext(i,c){!this.isReady&&!this.isIndexing&&await this.indexModel();const g=[],l=this.elements.length,b=Array.from(this.indices.byCategory.entries()).map(([p,v])=>`${p}: ${v.length}`).sort().join(", ");g.push(`Total Elements: ${l}`),g.push(`Categories: ${b}`),c&&c.length>0&&g.push(`
--- Active Selection (${c.length}) ---`);const h=this.search(i);if(h.length>0&&h.length<50){g.push(`
--- Relevant Elements based on your query (${h.length}) ---`);for(const p of h)g.push(`- ${p.ifcClass} [${p.GlobalId}]`),g.push(`  Properties: ${JSON.stringify(p.properties).slice(0,300)}...`)}else if(h.length>=50){g.push(`
--- Found ${h.length} elements matching your keywords ---`);const p=new Map;h.forEach(v=>p.set(v.ifcClass,(p.get(v.ifcClass)||0)+1)),g.push(`Matching categories: ${Array.from(p.entries()).map(v=>`${v[0]}: ${v[1]}`).join(", ")}`)}for(const[p,v]of this.indices.byCategory.entries())(i.toUpperCase().includes(p)||i.toUpperCase().includes(p.replace("IFC","")))&&(v.length>20?(g.push(`
--- ${p} Summary ---`),g.push(`${p} count: ${v.length}`),g.push(`Sample element: ${JSON.stringify(v[0].properties).slice(0,200)}...`)):(g.push(`
--- ${p} Details ---`),v.forEach(y=>{g.push(`${p} [${y.GlobalId}]: ${JSON.stringify(y.properties)}`)})));return g.join(`
`)}isReadyStatus(){return this.isReady}}const Kn="savora-ui-settings";function Yn(){try{const t=localStorage.getItem(Kn);if(t)return JSON.parse(t)}catch(t){console.warn("Failed to load UI settings:",t)}return{}}function ml(t){try{const c={...Yn(),...t};localStorage.setItem(Kn,JSON.stringify(c))}catch(i){console.warn("Failed to save UI settings:",i)}}function gl(t){return Yn()[t]}function yl(t,i){ml({[t]:i})}const bl={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:gl("idsPanelScanScope")||"all"};let Ct=bl;const Io=new Set;let wt=null;const xl=()=>{Io.forEach(t=>{try{t()}catch(i){console.error("IDS store listener error",i)}})},ce=t=>{Ct=t(Ct),xl()};let ut=null,$r=null;const wl=()=>(ut||(ut=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),ut),Il=(t,i)=>{const c=wl(),g=new Promise((l,b)=>{const h=v=>{const y=v.data;if(y){if(y.type==="error"){c.removeEventListener("message",h),c.removeEventListener("error",p),b(new Error(y.message||"IDS worker failed"));return}if(y.type==="phase"){i?.onPhase?.(y.label);return}if(y.type==="progress"){i?.onProgress?.(y);return}if(y.type==="done"){c.removeEventListener("message",h),c.removeEventListener("error",p),l(y);return}}},p=v=>{c.removeEventListener("message",h),c.removeEventListener("error",p),b(v.error??new Error(v.message))};c.addEventListener("message",h),c.addEventListener("error",p),c.postMessage(t)});return $r=g.finally(()=>{$r=null}),g},Ln=()=>{ce(t=>({...t,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:t=>(Io.add(t),()=>Io.delete(t)),getState:()=>Ct,setIdsXmlText:(t,i)=>{const c=t.replace(/\uFEFF/g,"").trim(),g=i?.fileNames??[];ce(l=>({...l,idsXmlText:c,idsFileNames:g,error:null})),Ln()},appendDocuments:t=>{if(!t.length)return;const i=fe.getState(),c=[];i.idsXmlText.trim().length&&c.push(i.idsXmlText.trim()),c.push(...t.map(b=>b.content.trim()).filter(Boolean));const g=c.join(`

`),l=[...i.idsFileNames,...t.map(b=>b.name)];fe.setIdsXmlText(g,{fileNames:l})},clearResults:()=>{Ln()},setValidationMode:t=>{yl("idsPanelScanScope",t),ce(i=>({...i,validationMode:t}))},filterRows:(t,i)=>{ce(c=>{if(!t)return{...c,filteredRows:c.rows,filterDescription:null};const g=c.rows.filter(l=>{try{return t(l)}catch(b){return console.warn("IDS filter predicate threw an error",b),!0}});return{...c,filteredRows:g,filterDescription:i??null}})},runCheck:async t=>{if(!t){ce(l=>({...l,error:"Viewer API is not available."}));return}if(Ct.isChecking){await $r;return}const i=Ct.idsXmlText.trim();if(!i){ce(l=>({...l,error:"Load at least one IDS XML file before running the check."}));return}let c;if(Ct.validationMode==="selected")if(t.getSelectedGlobalIds){if(c=await t.getSelectedGlobalIds(),!c||c.length===0){console.error("âŒ No elements selected"),ce(l=>({...l,error:"No elements selected. Please select elements or switch to another mode."}));return}}else{console.warn("âš ï¸ getSelectedGlobalIds not available on viewerApi"),ce(l=>({...l,error:"Selected elements validation is not supported by this viewer."}));return}else if(Ct.validationMode==="visible")if(t.getVisibleGlobalIds){if(c=await t.getVisibleGlobalIds(),!c||c.length===0){console.error("âŒ No visible elements found"),ce(l=>({...l,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}}else{console.warn("âš ï¸ getVisibleGlobalIds not available on viewerApi"),ce(l=>({...l,error:"Visible elements validation is not supported by this viewer."}));return}ce(l=>({...l,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),wt=new AbortController;const g=wt.signal;try{if(g.aborted)throw new Error("Validation cancelled");const l=await qn(t,{filterGlobalIds:c,onPhase:y=>{ce(E=>({...E,phase:y}))},onProgress:y=>{ce(E=>({...E,progress:y}))}});if(!l.length)throw new Error("No IFC elements were found in the current viewer.");if(g.aborted)throw new Error("Validation cancelled");ce(y=>({...y,phase:"CHECKING_IDS",progress:null}));const b={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},h=await Il({type:"validate",idsXml:i,elements:l},{onPhase:y=>{const E=b[y];E&&ce(P=>({...P,phase:E}))},onProgress:y=>{ce(E=>({...E,progress:{done:y.done,total:y.total}}))}}),p=h.rules??[],v=h.rows??[];if(c&&c.length>0&&typeof t.addToCache=="function")try{await t.addToCache(c)}catch(y){console.warn("ðŸ“¦ Failed to add elements to cache:",y)}ce(y=>({...y,isChecking:!1,rules:p,rows:v,filteredRows:v,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),wt=null}catch(l){const b=l instanceof Error?l.message:"Failed to run IDS validation.";console.error("IDS run failed",l),ce(h=>({...h,isChecking:!1,error:b,phase:"ERROR",progress:null})),wt=null}},invalidateCaches:()=>{al(),ut&&(ut.terminate(),ut=null,$r=null),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{wt&&(wt.abort(),wt=null),ut&&ut.postMessage({type:"cancel"}),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},Cl=t=>d.useSyncExternalStore(fe.subscribe,()=>t({...fe.getState(),...fe}),()=>t({...fe.getState(),...fe})),Sl=t=>d.useSyncExternalStore(fe.subscribe,()=>t(fe.getState()),()=>t(fe.getState())),jl=()=>{const t=d.useCallback(fe.setIdsXmlText,[]),i=d.useCallback(fe.appendDocuments,[]),c=d.useCallback(fe.clearResults,[]),g=d.useCallback(fe.filterRows,[]),l=d.useCallback(fe.runCheck,[]),b=d.useCallback(fe.setValidationMode,[]),h=d.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:t,appendDocuments:i,clearResults:c,filterRows:g,runCheck:l,setValidationMode:b,cancelValidation:h,invalidateCaches:fe.invalidateCaches}},Xn=fe,vl=Object.freeze(Object.defineProperty({__proto__:null,idsStore:Xn,useIdsActions:jl,useIdsStore:Cl,useIdsStoreSelector:Sl},Symbol.toStringTag,{value:"Module"})),kl=jt.lazy(()=>St(()=>import("./ChatWindow-D2pzQq-y.js"),__vite__mapDeps([0,1,2,3]))),Pl=jt.lazy(()=>St(()=>import("./IdsPanel-Dge6kak2.js"),__vite__mapDeps([4,1,2,3]))),El=jt.lazy(()=>St(()=>import("./IdsCreatorPanel-BmOhSWSt.js"),__vite__mapDeps([5,1,2,3]))),Al=jt.lazy(()=>St(()=>import("./QtoPanel-DSdgbAdx.js"),__vite__mapDeps([6,1,2,3])).then(t=>({default:t.QtoPanel}))),Rl=jt.lazy(()=>St(()=>import("./ModelFilterPanel-BGO2kxn2.js"),__vite__mapDeps([7,1]))),xo=(t,i)=>{if(t.length!==i.length)return!1;for(let c=0;c<t.length;c+=1){const g=t[c],l=i[c];if(!l||g.modelId!==l.modelId||g.localId!==l.localId)return!1}return!0},Ml={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},zl=(t,i)=>{if(!t)return i;const c=[t.ifcCategory,t.Category,t.category,t.ifcClass,t.class,t.type,t.Type,t.system,t.System];for(const g of c)if(typeof g=="string"&&g.trim())return g.trim();if(Array.isArray(t.categories)&&t.categories.length){const g=t.categories.find(l=>typeof l=="string"&&l.trim());if(g)return g.trim()}return typeof t.name=="string"&&t.name.trim()?t.name.trim():typeof t.Name=="string"&&t.Name.trim()?t.Name.trim():typeof t.label=="string"&&t.label.trim()?t.label.trim():i},Dl=(t,i,c)=>{const g=new Map;let l=0,b=0,h=0;c.traverse(P=>{const V=!!P?.isInstancedMesh,N=!!P?.isMesh;if(!V&&!N)return;let j=0;if(V){let k=0;typeof P.count=="number"?k=P.count:typeof P.instanceCount=="number"?k=P.instanceCount:Array.isArray(P.instanceIdMap)?k=P.instanceIdMap.length:Array.isArray(P.userData?.ids)?k=P.userData.ids.length:typeof P.userData?.size=="number"&&(k=P.userData.size),Number.isFinite(k)&&k>0&&(j=k,b+=k)}else j=1,h+=1;j<=0&&(j=1),l+=j;const z=zl(P?.userData??{},P?.type??"Mesh"),L=g.get(z)??0;g.set(z,L+j)});const p=Array.from(g.entries()).map(([P,V])=>({category:P,count:V})).sort((P,V)=>V.count-P.count),v=new dt().setFromObject(c),y=new ee,E=new ee;return v.getSize(y),v.getCenter(E),{modelId:t,label:i,elementCount:l,instancedCount:b,meshCount:h,categoryCounts:p,bboxSize:{x:y.x,y:y.y,z:y.z},bboxCenter:{x:E.x,y:E.y,z:E.z},collectedAt:Date.now()}},$l=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),rt=t=>{if(!t)return"";let i=t.replace(/[_\-]+/g," ");return i=i.replace(/([a-z\d])([A-Z])/g,"$1 $2"),i=i.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),i=i.replace(/\s+/g," ").trim(),i?i.split(" ").map(g=>{const l=g.toUpperCase();return $l.has(l)||l.length<=3&&/^[A-Z]+$/.test(l)?l:/^\d+(\.\d+)?$/.test(g)||!g.length?g:g.charAt(0).toUpperCase()+g.slice(1)}).join(" "):""},Fl=(t,i=200)=>t?t.length<=i?t:`${t.slice(0,i)}â€¦`:"",De=t=>{if(t==null)return"";if(typeof t=="number")return Number.isFinite(t)?t.toString():"";if(typeof t=="boolean")return t?"true":"false";if(t instanceof Date)return t.toISOString();if(typeof t=="string")return t.trim();try{const i=JSON.stringify(t);return i?i.length>500?`${i.slice(0,500)}â€¦`:i:""}catch{return String(t)}},Ee=t=>t==null?"":typeof t!="object"?De(t):"value"in t?Ee(t.value):"Value"in t?Ee(t.Value):Array.isArray(t)?t.map(i=>Ee(i)).filter(Boolean).join(", "):typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?`${De(t.x)}, ${De(t.y)}, ${De(t.z)}`:De(t),ge=(t,i)=>{if(!t||typeof t!="object")return;const c=i.map(b=>b.toLowerCase()),g=new WeakSet,l=[t];for(;l.length;){const b=l.pop();if(!(!b||typeof b!="object")&&!g.has(b)){if(g.add(b),Array.isArray(b)){for(const h of b)h&&typeof h=="object"&&l.push(h);continue}for(const[h,p]of Object.entries(b)){const v=h.toLowerCase();if(c.some(y=>v.includes(y)))if(typeof p=="string"){const y=p.trim();if(y)return y}else{if(typeof p=="number"&&Number.isFinite(p))return p.toString();if(typeof p=="boolean")return p?"true":"false";if(p&&typeof p=="object"){const y=Ee(p);if(y)return y}}p&&typeof p=="object"&&l.push(p)}}}},Vn={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},Nl=new Set(["modelIdMap"]),Nt=t=>t.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),ct=t=>t?t.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",tr=["HasProperties","hasProperties","Properties","properties"],wo=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],_n=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Mr=t=>{if(!t||typeof t!="object")return!1;const i=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return i&&i.toUpperCase()==="IFCPROPERTYSET"?!0:tr.some(c=>Array.isArray(t[c]))},Jn=t=>{if(!t||typeof t!="object")return!1;const i=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return i&&i.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},Ol=t=>{if(!t||typeof t!="object")return De(t);const i=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const c of i){if(!(c in t))continue;const g=t[c];if(g==null)continue;if(Array.isArray(g)){const b=g.map(h=>Ee(h)).filter(Boolean).join(", ");if(b)return b;continue}const l=Ee(g);if(l)return l}for(const[c,g]of Object.entries(t))if((typeof g=="string"||typeof g=="number"||typeof g=="boolean")&&c.toLowerCase().includes("value")){const l=De(g);if(l)return l}return""},Tl=(t,i,c)=>{const g=tr.map(p=>Array.isArray(t[p])?t[p]:null).filter(p=>!!p);if(!g.length)return[];const l=rt(i)||i,b=[],h=new Map;return g.flat().forEach((p,v)=>{if(!p||typeof p!="object"||!Jn(p))return;const y=qe(p)??(typeof p.Name=="string"?p.Name:void 0)??(typeof p.PropertyName=="string"?p.PropertyName:void 0),E=`Property ${v+1}`,P=y&&y.trim().length?y.trim():E,V=rt(P)||P,N=Ol(p),j=Nt(P)||"property",z=(h.get(j)??0)+1;h.set(j,z);const L=`${j}-${z}`,k=`Property Sets / ${l} / ${V}`,$=[k.toLowerCase()];N&&$.push(N.toLowerCase()),b.push({label:k,value:N||"",path:`property-sets/${c}/${L}`,searchText:$.join(" ").trim(),rawPsetName:i,rawPropertyName:P,rawValue:p.__rawValue??p})}),b},er=t=>{if(!t||typeof t!="object")return[];const i=[],c=new WeakSet,g=new Map,l=N=>{let j;if(typeof N=="string"){const $=N.trim();$.length&&(j=$)}!j&&N&&typeof N=="object"&&(j=qe(N)??(typeof N.Name=="string"?N.Name:void 0)??(typeof N.id=="string"?N.id:void 0)),(!j||!j.length)&&(j="Property Set");const z=rt(j)||j,L=Nt(j)||"property-set",k=(g.get(L)??0)+1;return g.set(L,k),{rawName:j,friendlyName:z,uniqueKey:`${L}-${k}`}},b=(N,j,z)=>{const L=`Property ${z+1}`,k=N?.trim?.()?N.trim():L;if(Jn(j)){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.__rawValue==null&&($.__rawValue=j),$}if(j&&typeof j=="object"){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.type==null&&$.Type==null&&($.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in $)&&!("nominalValue"in $)&&!("Value"in $)&&!("value"in $)&&($.NominalValue=j),$.__rawValue=j,$}return{type:"IFCPROPERTYSINGLEVALUE",Name:k,PropertyName:k,NominalValue:j,__rawValue:j}},h=(N,j)=>{const z=[],L=(k,$)=>{const q=`Property ${z.length+1}`,he=(typeof k=="string"&&k.trim().length?k.trim():void 0)??qe(k)??(typeof k?.Name=="string"?k.Name:void 0)??(typeof k?.PropertyName=="string"?k.PropertyName:void 0)??q;z.push(b(he,$,z.length))};if(j&&typeof j=="object")for(const k of tr){const $=j[k];Array.isArray($)&&$.length&&$.forEach(q=>L(q,q))}if(!z.length)if(Array.isArray(j))j.forEach(k=>L(k,k));else if(j&&typeof j=="object")for(const[k,$]of Object.entries(j))$!=null&&(_n.has(k)||tr.includes(k)||wo.includes(k)||L(k,$));else j!=null&&L(void 0,j);return{type:"IFCPROPERTYSET",Name:N,HasProperties:z}},p=(N,j)=>{const L=Tl(j&&typeof j=="object"?j:{},N.rawName,N.uniqueKey);L.length&&i.push(...L)},v=N=>{if(!(!N||typeof N!="object")&&!c.has(N)){if(c.add(N),Array.isArray(N)){N.forEach(j=>{if(!j||typeof j!="object")return;const z=l(j),L=Mr(j)?j:h(z.rawName,j);p(z,L),L&&typeof L=="object"&&c.add(L)});return}for(const[j,z]of Object.entries(N)){if(z==null)continue;const L=l(j),k=Mr(z)?z:h(L.rawName,z);p(L,k),z&&typeof z=="object"&&c.add(z)}}},y=N=>{if(!N||typeof N!="object"||c.has(N))return;if(c.add(N),Array.isArray(N)){N.forEach(y);return}let j=!1;for(const z of wo)Object.prototype.hasOwnProperty.call(N,z)&&(v(N[z]),j=!0);if(Mr(N)){const z=l(N);p(z,N)}!j&&!Mr(N)&&Object.entries(N).forEach(([z,L])=>{wo.includes(z)||_n.has(z)||tr.includes(z)||L&&typeof L=="object"&&y(L)})};y(t);const E=new Map,P=new Set;for(const N of i){const j=`${N.label}::${N.value}`;if(P.has(j))continue;const z=`${N.rawPsetName||"unknown"}::${N.rawPropertyName||"unknown"}::${N.value}`;E.has(z)||(P.add(j),E.set(z,N))}const V=Array.from(E.values());return i.length,V.length,V},Pe={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Bn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],Ll=(t,i)=>{const c=typeof t=="string"?t.trim().toLowerCase():"";if(c&&Bn.some(g=>c.startsWith(g)))return!0;if(i&&typeof i=="object"){const g=Ee(i._category??i.category??i.Category??null),l=typeof g=="string"?g.trim().toLowerCase():"";if(l&&Bn.some(h=>l.startsWith(h))||(i.NominalValue!=null||i.nominalValue!=null)&&(i.Name!=null||i.PropertyName!=null)&&c.includes("property"))return!0}return!1},Gn="fragmentsViewer.favoritePropertyPaths",Vl=1e4,_l=500,qe=t=>{if(!t||typeof t!="object")return;let i,c;typeof t.Name=="string"?i=t.Name:t.Name&&typeof t.Name=="object"&&(i=Ee(t.Name)||void 0),typeof t.name=="string"?c=t.name:t.name&&typeof t.name=="object"&&(c=Ee(t.name)||void 0);const g=i??c;if(!g)return;const l=g.trim();return l.length?l:void 0},zr=t=>{if(!t||typeof t!="object")return{rows:[],tree:[]};const i=[],c=new WeakSet,g=(h,p,v)=>{if(h==null)return null;const y=p.map(k=>{const $=k?.trim?.()??k;return typeof $=="string"&&$.length?rt($)||$:typeof k=="string"?k:String(k??"")}),E=y.filter(Boolean).join(" / "),P=v.length?v.join("/"):Nt(E||"value"),V=y[y.length-1]??"Value",N=k=>{const $=E.toLowerCase(),q=[$];k&&q.push(k.toLowerCase());const he=q.join(" ").trim()||$,te={label:E,value:k??"",path:P,searchText:he};return i.push(te),he};if(typeof h!="object"||h instanceof Date){const k=De(h),$=N(k);return{id:P,label:V,fullLabel:E,value:k||void 0,children:[],searchText:$}}if(c.has(h)){const k="[Circular reference]",$=N(k);return{id:P,label:V,fullLabel:E,value:k,children:[],searchText:$}}c.add(h);let j;const z=[];if(Array.isArray(h))h.forEach((k,$)=>{const q=qe(k),he=`${V} ${$+1}`,te=q&&q.trim().length?q.trim():he,J=rt(te)||te,oe=q&&q.trim().length?Nt(q):String($),Y=g(k,[...p,J],[...v,oe]);Y&&z.push(Y)}),z.length===0&&(j=De(h));else{if("NominalValue"in h||"nominalValue"in h){const k=h.NominalValue??h.nominalValue,$=Ee(k);$&&(j=$)}!j&&"value"in h&&typeof h.value!="object"&&(j=De(h.value)),!j&&"Value"in h&&typeof h.Value!="object"&&(j=De(h.Value));for(const[k,$]of Object.entries(h)){if($==null||k==="Name"||k==="name"||k==="IsDefinedBy"||k==="isDefinedBy"||k==="psets"||k==="Psets"||k==="propertySets"||k==="PropertySets"||k==="property_sets"||k==="Property_Sets")continue;if(k==="NominalValue"||k==="nominalValue"){const $e=rt("Nominal Value")||"Nominal Value",we=g($,[...p,$e],[...v,"nominal-value"]);we&&z.push(we);continue}const q=Vn[k]??k,he=rt(q)||q,te=qe($)?.trim(),J=te&&te.length?rt(te)||te:he,oe=te&&te.length?Nt(te):Nt(q),Y=[...p,J],H=g($,Y,[...v,oe]);H&&z.push(H)}!j&&z.length===0&&(j=De(h))}const L=N(j);return{id:P,label:V,fullLabel:E,value:j,children:z,searchText:L}},l=[];for(const[h,p]of Object.entries(t)){if(p==null||Nl.has(h))continue;const v=Vn[h]??h,y=g(p,[v],[h]);y&&l.push(y)}if(i.length){const h=i.filter(p=>{const v=p.label.toLowerCase();return v.startsWith("property sets /")?!(v.includes("/ has properties")||v.includes("/ nominal value")):!0});h.length!==i.length&&i.splice(0,i.length,...h)}const b=er(t);if(b.length){const h=[],p=new Set;for(const y of b)p.has(y.path)||(p.add(y.path),h.push(y));const v=[];for(const y of i)p.has(y.path)||v.push(y);i.splice(0,i.length,...h,...v)}return{rows:i,tree:l}},Bl=()=>{const t=d.useRef(null),i=d.useRef(null),c=d.useRef(null),g=d.useRef(null),l=d.useRef(null),b=d.useRef(!1),h=d.useRef(null),p=d.useRef(null),v=d.useRef(null),[y,E]=d.useState(!1),[P,V]=d.useState([]),[N,j]=d.useState(!1),[z,L]=d.useState(50);d.useCallback(async(e,s)=>{{console.warn("dumpModelRawData is dev-only.");return}},[P]),d.useCallback(async(e,s=50,n=128)=>{},[]);const[k,$]=d.useState([]),[q,he]=d.useState(null),[te,J]=d.useState(!0),[oe,Y]=d.useState(!1),[H,$e]=d.useState(!1),[we,ot]=d.useState(null),[Ot,Ke]=d.useState(!1),[ye,Ye]=d.useState(!1),Tt=d.useRef(null),nt=d.useRef(!1),Fe=d.useRef(null),Xe=d.useRef(null),or=d.useRef(0),be=d.useRef(null),nr=d.useRef(null),Fr=d.useRef(new Set);d.useRef(null);const Le=d.useRef(null),sr=d.useRef(!1),vt=d.useRef(null),Nr=d.useRef("click"),[ir,Zn]=d.useState({width:360,height:520}),Or=d.useRef(null),lr=d.useRef(!1),Tr=d.useRef(null),So=d.useRef(!1),jo=d.useRef(null),pt=d.useRef(null),Lr=d.useRef(null),ar=d.useRef(null),Vr=d.useRef(null),Lt=d.useRef(null),vo=d.useRef(null),ko=d.useRef(null),Ae=d.useRef(null),Je=d.useRef([]),Ve=d.useRef(null),Vt=d.useRef(null),kt=d.useRef(null),[cr,Re]=d.useState(null),[le,Qn]=d.useState([]),[Po,es]=d.useState(""),[Pt,ts]=d.useState(""),[Ie,Eo]=d.useState([]),[ht,Ao]=d.useState("favorites"),[rs,Gl]=d.useState(!1),[os,Wl]=d.useState(!1),[ns,Ul]=d.useState(!1),[mt,ss]=d.useState("models"),[_e,dr]=d.useState(!1),[is,Ro]=d.useState(0),[Be,_t]=d.useState(!1),[ls,Mo]=d.useState(!1),[as,zo]=d.useState(!1),[cs,ds]=d.useState(0),[me,_r]=d.useState("disabled"),[Ze,Br]=d.useState(""),[Bt,ur]=d.useState(""),[Gr,Do]=d.useState(!1),[$o,Fo]=d.useState(!1),[No,Et]=d.useState(null),[xe,Oo]=d.useState("click"),[At,To]=d.useState(!1),[Rt,us]=d.useState(!1),fr=d.useRef(!1),fs=d.useRef(new Map),Lo=d.useRef(null),Qe=d.useRef(!1),Vo=d.useRef(new Map),Mt=d.useRef(null),[ps,Wr]=d.useState(0),[st,_o]=d.useState(!1),[pr,Bo]=d.useState(!1),[Go,hs]=d.useState({}),[Ur,Wo]=d.useState(null),[Gt,Uo]=d.useState([]),[ms,Hr]=d.useState(!1),[it,Ho]=d.useState("selected"),[lt,hr]=d.useState(""),[gt,qo]=d.useState(!1),[Ko,mr]=d.useState(null),[zt,qr]=d.useState(!1),[yt,gs]=d.useState(!0),[Kr,ys]=d.useState(0),[gr,bs]=d.useState([]),[Yo,Xo]=d.useState(""),et=d.useRef(null),[ne,yr]=d.useState({x:!1,y:!1,z:!1}),[Ge,Jo]=d.useState({x:0,y:0,z:0}),[Wt,Zo]=d.useState(!1),[Ut,xs]=d.useState(!1),Ht=d.useRef(!1),Yr=d.useRef([]),Xr=d.useRef(new Map),br=d.useRef(null),[Qo,en]=d.useState(null),tn=d.useRef(null),bt=d.useCallback(()=>c.current?.camera??null,[]),Jr=d.useCallback(()=>bt()?.three??null,[bt]);d.useEffect(()=>{Nr.current=xe},[xe]),d.useEffect(()=>{const e=tn.current;!e||!("mouseButtons"in e)||(xe==="rectangle"?e.mouseButtons={left:0,middle:2,right:0,wheel:16}:e.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),d.useEffect(()=>{try{const e=window.localStorage.getItem(Gn);if(!e)return;const s=JSON.parse(e);if(!Array.isArray(s))return;const n=s.filter(o=>typeof o=="string"&&o.trim().length>0);n.length&&Eo(n)}catch(e){console.warn("Failed to restore favourites from storage",e)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(Gn,JSON.stringify(Ie))}catch(e){console.warn("Failed to persist favourites to storage",e)}},[Ie]);const xr=Po.trim(),ws=xr.length>0,rn=d.useMemo(()=>{const e=xr.toLowerCase();return e?le.filter(s=>s.searchText.includes(e)).slice(0,_l):[]},[xr,le]),wr=d.useMemo(()=>{const e=new Map;return le.forEach(s=>e.set(s.path,s)),e},[le]),Zr=d.useMemo(()=>le.slice(0,Vl),[le]),on=Math.max(le.length-Zr.length,0),nn=d.useMemo(()=>new Set(Ie),[Ie]),Qr=d.useMemo(()=>Ie.length?Ie.map(e=>wr.get(e)).filter(e=>!!e):[],[Ie,wr]),eo=d.useMemo(()=>{if(!Ie.length)return 0;let e=0;for(const s of Ie)wr.has(s)||(e+=1);return e},[Ie,wr]),sn=d.useCallback(e=>{Eo(s=>s.includes(e)?s.filter(n=>n!==e):[...s,e])},[]),Ir=d.useMemo(()=>P.map(e=>`${e.id}:${e.label}`).join("|"),[P]),to=d.useCallback(e=>{const s=nn.has(e.path);return r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(U,{variant:"body2",sx:{fontWeight:600},children:e.label}),r.jsx(Q,{title:s?"Remove from favourites":"Add to favourites",children:r.jsx("span",{children:r.jsx(X,{size:"small",onClick:()=>sn(e.path),color:s?"primary":"default",children:s?r.jsx(ri,{fontSize:"small"}):r.jsx(oi,{fontSize:"small"})})})})]}),r.jsx(U,{variant:"body2",color:"text.secondary",children:e.value?Fl(e.value,360):"â€”"})]},e.path)},[nn,sn]);d.useEffect(()=>{if(!P.length){hr("");return}hr(e=>e&&P.some(s=>s.id===e)?e:P[0].id)},[P]);const ln=d.useCallback(async e=>{const s=l.current;if(!s)return[];const n=s.list.get(e);if(!n)return[];let o=[];try{const w=await n.getLocalIds();Array.isArray(w)?o=w:w&&typeof w[Symbol.iterator]=="function"&&(o=Array.from(w))}catch(w){return console.warn(`Failed to retrieve local IDs for model ${e}`,w),[]}if(!o.length)return[];const a=32,f=[];for(let w=0;w<o.length;w+=a){const m=o.slice(w,w+a);let u=[];try{u=await n.getItemsData(m,Pe)}catch(I){console.warn(`Failed to fetch items data for model ${e} chunk starting at ${m[0]}`,I);continue}u.forEach((I,C)=>{const A=m[C];if(I)try{const{rows:R}=zr(I);R.forEach(S=>{f.push({path:`localId:${A} / ${S.label}`,value:S.value})})}catch(R){console.warn(`Failed to process properties for model ${e} localId ${A}`,R)}})}return f},[]),an=d.useCallback(e=>{const s=[];return s.push("Path,Value"),e.forEach(({path:n,value:o})=>{const a=n.replace(/"/g,'""'),f=(o??"").replace(/"/g,'""');s.push(`"${a}","${f}"`)}),s.join(`\r
`)},[]),Ce=d.useCallback(e=>{const s=e??null;he(s);const{rows:n}=zr(s);if(Qn(n),Ao(Ie.length?"favorites":"all"),n.length){Uo(n.map(f=>({path:f.label,value:f.value})));const o="Path	Value",a=n.map(f=>`${f.label}	${f.value??""}`);Wo([o,...a].join(`\r
`))}else Uo([]),Wo(null)},[Ie.length]),Se=d.useCallback(async()=>{if(be.current){const e=be.current;e.enabled=!0;try{typeof e.clear=="function"&&await e.clear(),typeof e.create=="function"&&(await new Promise(n=>setTimeout(n,0)),e.list?.has("select")||e.selection?.select||(console.debug('Re-creating missing "select" style in resetViewerTools'),e.create("select")))}catch(s){console.warn("Failed to clear/reset highlighter:",s)}}if(Ae.current)try{await Ae.current.set(!0)}catch(e){console.warn("Failed to reset isolation:",e)}if(fr.current=!1,To(!1),Qe.current=!1,Mt.current=null,l.current)try{l.current.resetHighlight(),l.current.core.update(!0)}catch(e){console.warn("Failed to reset fragments highlight:",e)}$([]),Ce(null)},[Ce]),Is=d.useCallback(()=>{mr(null),Ho(le.length?"selected":"model"),P.length&&!P.some(e=>e.id===lt)&&hr(P[0].id),Hr(!0)},[le.length,P,lt]),Cs=d.useCallback(async()=>{if(!q){alert("No element selected");return}try{const e=new WeakSet,s=JSON.stringify(q,(n,o)=>{if(typeof o=="object"&&o!==null){if(e.has(o))return"[Circular Reference]";e.add(o)}return o instanceof Map?`[Map with ${o.size} entries]`:o instanceof Set?`[Set with ${o.size} items]`:o instanceof WeakMap||o instanceof WeakSet?"[WeakMap/WeakSet]":typeof o=="function"?"[Function]":typeof o=="symbol"?"[Symbol]":o},2);await navigator.clipboard.writeText(s),alert("Raw element data copied to clipboard!")}catch(e){console.error("Failed to copy raw data:",e),alert("Failed to copy data to clipboard. See console for details.")}},[q]),cn=d.useCallback(()=>{gt||(Hr(!1),mr(null),Se())},[gt,Se]),Ss=d.useCallback(async()=>{if(!gt){qo(!0),mr(null);try{let e=[];if(it==="selected"){if(!le.length)throw new Error("No properties available for the current selection.");e=le.map(m=>({path:m.label,value:m.value}))}else{if(!lt)throw new Error("Select a model to export.");if(e=await ln(lt),!e.length)throw new Error("No properties were found for the chosen model.")}const s=an(e),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),a=document.createElement("a"),f=it==="selected"?"selection":`model-${lt}`,w=new Date().toISOString().replace(/[:.]/g,"-");a.href=o,a.download=`fragment-properties-${f}-${w}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),Hr(!1)}catch(e){console.warn("Failed to export properties",e),mr(e.message??"Failed to export properties.")}finally{qo(!1)}}},[an,lt,it,ln,gt,le]),dn=d.useCallback(()=>{_o(e=>!e)},[]),js=d.useCallback(()=>{Bo(e=>!e)},[]),vs=d.useCallback(()=>{dr(!0),Ro(e=>e+1)},[]),ks=d.useCallback(()=>{dr(!1),Se()},[Se]),un=d.useCallback(()=>{_e?(dr(!1),Se()):(dr(!0),Ro(e=>e+1))},[_e,Se]),Ps=d.useCallback(()=>{Mo(!0)},[]),fn=d.useCallback(()=>{Mo(!1),Se()},[Se]),pn=d.useCallback(()=>{const e=Ji();e?(_r(e.provider),Br(e.apiKey),ur(e.model||Ar(e.provider))):(_r("disabled"),Br(""),ur("")),Et(null),zo(!0)},[]),Cr=d.useCallback(()=>{zo(!1),Do(!1),Et(null),Se()},[Se]),Es=d.useCallback(()=>{if(me==="disabled")Zi();else{const e={provider:me,apiKey:Ze,model:Bt||Ar(me)};Xi(e)}ds(e=>e+1),Cr()},[me,Ze,Bt,Cr]),As=d.useCallback(e=>{_r(e),ur(Ar(e)),Et(null)},[]),Rs=d.useCallback(async()=>{if(!(!Ze||me==="disabled")){Fo(!0),Et(null);try{let e=!1;const s=Bt||Ar(me);me==="gemini"?e=await tl(Ze,s):me==="openai"&&(e=await ol(Ze,s)),Et(e?"success":"error")}catch{Et("error")}finally{Fo(!1)}}},[me,Ze,Bt]),qt=d.useCallback(e=>{if(!e||typeof e!="object")return"IfcProduct";if(e.constructor&&typeof e.constructor.name=="string"&&e.constructor.name.toUpperCase().startsWith("IFC")){const a=e.constructor.name.trim();if(a!=="Object"&&a!=="Array")return a}const s=Ee(e._category??e.category??e.Category??null);if(s&&s.trim().length&&s.toUpperCase().startsWith("IFC"))return s.trim();const n=[e.expressID!==void 0?null:e.type,e.ifcClass,e.IfcClass,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.ifcType,e.IfcType,e?.attributes?.ifcClass,e?.Attributes?.IfcClass];for(const a of n)if(typeof a=="string"&&a.trim().length){const f=a.trim();if(f.toUpperCase().startsWith("IFC")&&!f.toUpperCase().includes("IDENTIFIER")&&!f.toUpperCase().includes("LABEL")&&!f.toUpperCase().includes("TEXT"))return f}const o=ge(e,["ifcclass","ifc type","express type"]);return o&&o.toUpperCase().startsWith("IFC")?o:"IfcProduct"},[]),ro=d.useCallback((e,s,n)=>{const o={},a={},f={};er(e).forEach(C=>{const A=C.label.split("/").map(_=>_.trim()),R=C.rawPsetName??A[1]??"",S=C.rawPropertyName??A[A.length-1]??"",x=ct(R),M=ct(S);if(!x||!M)return;a[x]||(a[x]={}),M in a[x]||(a[x][M]=C.value);const D=`${x}.${M}`;D in o||(o[D]=C.value)}),o.GlobalId=s,o.ifcClass=n,f.ifcClass=n,f.GlobalId=s,o["Attributes.GlobalId"]=s,o["Attributes.IfcClass"]=n,o["Attributes.ifcClass"]=n;const m=qe(e);m&&(f.Name=m,o["Attributes.Name"]=m);const u=ge(e,["category","ifccategory"]);u&&(f.Category=u,o["Attributes.Category"]=u);const I=ge(e,["type","typename"]);I&&(f.Type=I,o["Attributes.Type"]=I);for(const[C,A]of Object.entries(e??{})){if(A==null||typeof A!="object"||Array.isArray(A))continue;const R=Ee(A);if(!R)continue;const S=String(C).replace(/^_+/,""),x=`Attributes.${rt(S)}`;if(x in o||(o[x]=R),S in f||(f[S]=R),/guid|globalid|_guid/i.test(C)){const M=String(R).trim();M&&!o.GlobalId&&(o.GlobalId=M,f.GlobalId=M)}}return{flattened:o,psets:a,attributes:f}},[]),oo=d.useCallback(()=>{const e=l.current;return e?`${Array.from(e.list.keys()).sort().join("|")}|${P.length}`:"empty"},[P]),Ms=d.useCallback(async()=>{const e=l.current;if(!e||e.list.size===0)return{signature:"empty",elementCount:0,modelFiles:[]};const s=Array.from(e.list.keys()).sort(),n=P.map(m=>({id:m.id,name:m.label}));let o=0;for(const[m,u]of e.list)try{const I=await u.getLocalIds(),C=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[];o+=C.length}catch(I){console.error(`âŒ [computeModelSignature] Failed to count elements in model ${m}`,I)}return{signature:[...s,...P.map(m=>`${m.id}:${m.label}`),`count:${o}`].join("|"),elementCount:o,modelFiles:n}},[P]),Sr=d.useCallback(async()=>{const e=l.current;if(!e||e.list.size===0){const o={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Ve.current=o,o}const s=oo();if(Ve.current&&Ve.current.signature===s)return Ve.current;if(Vt.current)return Vt.current;const n=(async()=>{const o=new Map,a=[],f=new Map;for(const[m,u]of e.list){let I=[];try{const A=await u.getLocalIds();Array.isArray(A)?I=A:A&&typeof A[Symbol.iterator]=="function"&&(I=Array.from(A))}catch(A){console.warn(`IDS cache: failed to read local IDs for model ${m}`,A);continue}if(f.set(m,I.slice()),!I.length)continue;const C=48;for(let A=0;A<I.length;A+=C){const R=I.slice(A,A+C);let S=[];try{S=await u.getItemsData(R,Pe)}catch(x){console.warn(`IDS cache: failed to fetch items data for model ${m}`,x);continue}S.forEach((x,M)=>{if(!x)return;const D=R[M],_=qt(x),T=typeof x.GlobalId=="string"&&x.GlobalId.trim()||typeof x.GlobalID=="string"&&x.GlobalID.trim()||ge(x,["globalid","global id","guid"]);if(!T){if(Ll(_,x))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:m,localId:D,itemData:x});return}const O=T.trim();if(!O.length||o.has(O))return;const{flattened:F,psets:B,attributes:K}=ro(x,O,_),Z={GlobalId:O,ifcClass:_,properties:F},W=x;(typeof W.GlobalId!="string"||!W.GlobalId.trim())&&(W.GlobalId=O),o.set(O,{element:Z,modelId:m,localId:D,psets:B,attributes:K,raw:W}),a.push(Z)})}}const w={signature:s,records:o,elements:a,modelLocalIds:f};return Ve.current=w,w})().finally(()=>{Vt.current=null});return Vt.current=n,n},[oo,ro,qt]),Dt=d.useCallback(async e=>{const s=new Map,n=l.current;if(!n)return console.error("ðŸ” [groupLocalIdsByModel] Fragments not available"),{grouped:s,cache:Ve.current};for(const[o,a]of n.list)try{const f=await a.getLocalIdsByGuids(e),w=[];for(let m=0;m<f.length;m++){const u=f[m];u!==null&&w.push(u)}w.length>0&&s.set(o,w)}catch(f){console.warn(`ðŸ” [groupLocalIdsByModel] Failed for model ${o}:`,f)}return{grouped:s,cache:Ve.current}},[]),Ne=jt.useMemo(()=>({listGlobalIds:async()=>(await Sr()).elements.map(s=>s.GlobalId),getSelectedGlobalIds:async()=>{const e=Je.current;if(!e||e.length===0)return[];const s=l.current;if(!s)return console.warn("ðŸ“ Fragments not available"),[];const n=[];for(const o of e){const a=s.list.get(o.modelId);if(!a){console.warn("ðŸ“ Model not found for item:",o);continue}try{const[f]=await a.getItemsData([o.localId],{attributesDefault:!1});if(f){const w=ge(f,["globalid","global id","guid"]);w&&typeof w=="string"?n.push(w):console.warn("ðŸ“ No GlobalId found in data for item:",o)}}catch(f){console.error("ðŸ“ Error fetching data for item:",o,f)}}return n},getVisibleGlobalIds:async()=>{const e=l.current;if(!e)return console.warn("ðŸ‘ï¸ Fragments not available"),[];const s=[];let n=0,o=0;for(const[a,f]of e.list)try{let w=[];try{const C=await f.getLocalIds();w=Array.isArray(C)?C:C&&typeof C[Symbol.iterator]=="function"?Array.from(C):[],n+=w.length}catch(C){console.error(`ðŸ‘ï¸ Failed to get local IDs for model ${a}:`,C);continue}const m=await f.getItemsByVisibility(!0);o+=m.length;const u=m.length>0?m:w;if(u.length===0)continue;const I=100;for(let C=0;C<u.length;C+=I){const A=u.slice(C,Math.min(C+I,u.length));try{const R=await f.getItemsData(A,{attributesDefault:!1,attributes:["GlobalId"]});for(const S of R){const x=ge(S,["globalid","global id","guid"]);x&&typeof x=="string"&&s.push(x)}}catch(R){console.error(`ðŸ‘ï¸ Error fetching GlobalIds for batch in model ${a}:`,R)}}}catch(w){console.error(`ðŸ‘ï¸ Error getting visible elements from model ${a}:`,w)}return console.log(`ðŸ‘ï¸ getVisibleGlobalIds: Found ${s.length} visible elements (${o} reported visible out of ${n} total)`),s},getElementProps:async e=>{const s=l.current;if(!s)throw new Error("Fragments not available");for(const[n,o]of s.list)try{const f=(await o.getLocalIdsByGuids([e]))[0];if(f!=null){const[w]=await o.getItemsData([f],Pe);if(!w){console.warn(`ðŸ” [getElementProps] No data returned for localId ${f}`);continue}const m=qt(w),u={},I={};er(w).forEach(x=>{const M=x.label.split("/").map(F=>F.trim()),D=x.rawPsetName??M[1]??"",_=x.rawPropertyName??M[M.length-1]??"",T=ct(D),O=ct(_);!T||!O||(u[T]||(u[T]={}),O in u[T]||(u[T][O]=x.value))}),I.ifcClass=m,I.GlobalId=e;const A=qe(w);A&&(I.Name=A);const R=ge(w,["category","ifccategory"]);R&&(I.Category=R);const S=ge(w,["type","typename"]);return S&&(I.Type=S),{ifcClass:m,psets:u,attributes:I}}}catch(a){console.warn(`ðŸ” [getElementProps] Error in model ${n}:`,a);continue}throw console.error(`ðŸ” [getElementProps] Element with GlobalId ${e} not found in any model`),new Error(`Element with GlobalId ${e} is not available.`)},getElementPropsFast:async e=>{const s=Je.current,n=l.current;if(!n)throw console.error("ðŸ” [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");for(let o=0;o<s.length;o++){const a=s[o],f=n.list.get(a.modelId);if(f)try{const[w]=await f.getItemsData([a.localId],Pe);if(w&&ge(w,["globalid","global id","guid"])===e){const u=qt(w),I={},C={};er(w).forEach(M=>{const D=M.label.split("/").map(B=>B.trim()),_=M.rawPsetName??D[1]??"",T=M.rawPropertyName??D[D.length-1]??"",O=ct(_),F=ct(T);!O||!F||(I[O]||(I[O]={}),F in I[O]||(I[O][F]=M.value))}),C.ifcClass=u,C.GlobalId=e;const R=qe(w);R&&(C.Name=R);const S=ge(w,["category","ifccategory"]);S&&(C.Category=S);const x=ge(w,["type","typename"]);return x&&(C.Type=x),{ifcClass:u,psets:I,attributes:C}}}catch(w){console.error("ðŸ” [getElementPropsFast] Error for item:",a,w)}}return kt.current.getElementProps(e)},countElements:async()=>(await Sr()).elements.length,iterElements:e=>{const s=Math.max(1,Math.floor(e?.batchSize??500));return{async*[Symbol.asyncIterator](){const n=l.current;if(!n||n.list.size===0){console.warn("âš ï¸ [viewerApi.iterElements] No fragments available");return}let o=[],a=0;for(const[f,w]of n.list){let m=[];try{const I=await w.getLocalIds();m=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[]}catch(I){console.error(`âŒ [viewerApi.iterElements] Failed to get local IDs for model ${f}`,I);continue}const u=Math.min(500,Math.max(100,s));for(let I=0;I<m.length;I+=u){const C=m.slice(I,I+u);try{const A=await w.getItemsData(C,Pe);for(let R=0;R<A.length;R++){const S=A[R];S&&o.push({modelId:f,localId:C[R],data:S})}for(;o.length>=s;){const R=o.splice(0,s);a+=R.length,a%5e3,yield R}}catch(A){console.error(`âŒ [viewerApi.iterElements] Failed to fetch chunk at ${I}`,A)}}}o.length>0&&(a+=o.length,yield o)}}},_iterElementsLegacy:e=>{const s=Math.max(1,Math.floor(e?.batchSize??100));return{async*[Symbol.asyncIterator](){const n=await Sr(),o=Array.from(n.records.values());for(let a=0;a<o.length;a+=s){const f=o.slice(a,a+s).map(w=>({modelId:w.modelId,localId:w.localId,data:{...w.raw,GlobalId:w.element.GlobalId}}));f.length&&(yield f)}}}},buildIdsCache:async()=>{try{return(await Sr()).elements.length}catch(e){throw console.error("viewerApi.buildIdsCache failed",e),e}},getModelSignature:async()=>await Ms(),addToCache:async e=>{const s=l.current;if(!s){console.warn("ðŸ“¦ [addToCache] Fragments not available");return}let n=Ve.current;n||(n={signature:oo(),records:new Map,elements:[],modelLocalIds:new Map},Ve.current=n);const o=Je.current;for(const a of e){if(n.records.has(a))continue;let f=!1;for(const w of o){const m=s.list.get(w.modelId);if(m)try{const[u]=await m.getItemsData([w.localId],Pe);if(u){let I=u._guid||u.GlobalId;if(I&&typeof I=="object"&&(I=I.value||I),I===a){const C=qt(u),A={};er(u).forEach(F=>{const B=F.label.split("/").map(ue=>ue.trim()),K=F.rawPsetName??B[1]??"",Z=F.rawPropertyName??B[B.length-1]??"",W=ct(K),pe=ct(Z);!W||!pe||(A[W]||(A[W]={}),pe in A[W]||(A[W][pe]=F.value))});const S={ifcClass:C,GlobalId:a},x=qe(u);x&&(S.Name=x);const M=ge(u,["category","ifccategory"]);M&&(S.Category=M);const D=ge(u,["type","typename"]);D&&(S.Type=D);const _={GlobalId:a,ifcClass:C,properties:ro(u,a,C)},T={element:_,modelId:w.modelId,localId:w.localId,psets:A,attributes:S,raw:u};n.records.set(a,T),n.elements.push(_);const O=n.modelLocalIds.get(w.modelId)||[];O.push(w.localId),n.modelLocalIds.set(w.modelId,O),f=!0;break}}}catch(u){console.debug("ðŸ“¦ [addToCache] Error checking selection item:",u)}}f||console.warn(`ðŸ“¦ [addToCache] Could not find ${a} in selection`)}},color:async(e,s)=>{if(!e.length)return;const n=be.current,o=l.current,a=c.current;if(!n||!b.current||!o||!a)return;let f,w;try{const I=await Dt(e);f=I.grouped,w=I.cache}catch(I){console.error("ðŸŽ¨ [color] groupLocalIdsByModel failed:",I);return}const m=new Te(s.r,s.g,s.b),u=m.getHex();nr.current||(nr.current=new Map);for(const[I,C]of f){const A=o.list.get(I);if(!(!A||!C.length))try{const R=Array.from(C);if(n.styles&&typeof n.styles.set=="function")try{if(!R||R.length===0){console.debug(`Skipping highlight for model ${I} - no IDs`);continue}const S=`ids-color-${u.toString(16).padStart(6,"0")}`;if(Fr.current.add(S),n.styles.set(S,{color:m,fillOpacity:1}),typeof n.create=="function")try{(!n.list||!n.list.has(S))&&n.create(S)}catch(x){console.debug("highlighter.create failed:",x)}if(typeof n.select=="function")try{n.select(A,R,S)}catch(x){throw console.debug("highlighter.select failed:",x),x}continue}catch(S){console.debug("styles.set failed:",S)}if(typeof n.add=="function")try{if(n.add(A,R,u),a&&typeof a.update=="function")try{a.update()}catch(S){console.debug("World update failed:",S)}continue}catch(S){console.debug("add failed:",S)}if(typeof n.highlightById=="function")try{await n.highlightById(A,R,u);continue}catch(S){console.debug("highlightById failed:",S)}if(typeof n.highlightByID=="function")try{await n.highlightByID(A,R,u);continue}catch(S){console.debug("highlightByID failed:",S)}console.warn(`âŒ Could not color model ${I} - all highlighter methods failed`)}catch(R){console.error(`Failed to color model ${I}:`,R)}}},clearColors:async()=>{const e=be.current,s=l.current;if(!b.current||!s)return;const n=Vo.current;if(n.size>0){for(const[o,a]of n){const{color:f,transparent:w,opacity:m}=a;o.transparent=w,o.opacity=m,"color"in o?o.color.setHex(f):o.lodColor.setHex(f),o.needsUpdate=!0}n.clear()}e&&Qe.current&&(e.enabled=!0,Qe.current=!1,Mt.current=null),Mt.current=null,s&&(s.resetHighlight(),s.core.update(!0));try{if(e){if(e.styles&&typeof e.styles.delete=="function")try{e.styles.delete("ghost")}catch(o){console.warn("Failed to clear ghost styles",o)}if(typeof e.clear=="function"&&await Promise.resolve(e.clear()),e.styles&&typeof e.styles.delete=="function")Fr.current.forEach(o=>{try{e.styles.delete(o)}catch{}}),Fr.current.clear();else if(e.styles&&typeof e.styles.clear=="function"&&(e.styles.clear(),typeof e.create=="function"))try{e.create("select")}catch{}}}catch(o){console.warn("Failed to clear IDS highlights",o)}nr.current&&nr.current.clear();try{const o=Xe.current;if(o&&o.mesh&&o.mesh.instanceColor){const a=new Te(1,1,1);o.mesh.setColorAt(o.index,a),o.mesh.instanceColor.needsUpdate=!0}}catch{}},isolate:async e=>{const s=Ae.current,n=l.current;if(!s||!n||!b.current||(await Promise.resolve(s.set(!0)),!e.length||!b.current))return;const{grouped:o}=await Dt(e);if(o.size===0){console.warn("isolate: No elements found in cache for isolation");return}const a=new Map;o.forEach((w,m)=>{a.set(m,new Set(w))});const f={};for(const[w,m]of a.entries()){const u=n.list.get(w);if(u)try{let I=[];const C=await u.getLocalIds();Array.isArray(C)?I=C:C&&typeof C[Symbol.iterator]=="function"&&(I=Array.from(C));const A=I.filter(R=>!m.has(R));A.length>0&&(f[w]=new Set(A))}catch(I){console.error("isolate: Failed to get local IDs for model",w,I)}}Object.keys(f).length>0&&await Promise.resolve(s.set(!1,f))},clearIsolation:async()=>{const e=Ae.current;e&&await Promise.resolve(e.set(!0))},ghost:async e=>{const s=l.current,n=be.current;if(console.log(`ðŸŽ­ ghost() called with ${e.length} global IDs`),!s||!b.current||!n){console.warn("ðŸŽ­ ghost() aborted: fragments or highlighter not ready");return}const{grouped:o}=await Dt(e);if(o.size===0){console.warn("ðŸŽ­ ghost() aborted: no grouped IDs");return}const a={};let f=0;for(const[u,I]of o.entries())a[u]=new Set(I),f+=I.length;console.log(`ðŸŽ­ ghost() applying to ${f} objects across ${o.size} models`),Mt.current=a,n.enabled=!1,Qe.current=!0;const w=[...s.core.models.materials.list.values()],m=Vo.current;for(const u of w){if(u.userData.customId)continue;let I;"color"in u?I=u.color.getHex():I=u.lodColor.getHex(),m.set(u,{color:I,transparent:u.transparent,opacity:u.opacity}),u.transparent=!0,u.opacity=.05,u.needsUpdate=!0,"color"in u?u.color.setColorName("white"):u.lodColor.setColorName("white")}if(Object.keys(a).length>0)try{s.highlight({customId:"filter-ghost",color:new Te(16750592),renderedFaces:1,opacity:1,transparent:!1},a)}catch{}s.core.update(!0)},getItemsData:async(e,s)=>{const n=l.current;if(!n)return console.error("ðŸ” [getItemsData] Fragments not available"),[];const{grouped:o}=await Dt(e),a=[];for(const[f,w]of o.entries()){const m=n.list.get(f);if(m)try{const u=await m.getItemsData(Array.from(w),s);a.push(...u)}catch(u){console.error(`ðŸ” [getItemsData] Failed for model ${f}`,u)}}return a},getLoadedCategories:async()=>{const e=l.current;if(!e)return[];const s=["IfcWall","IfcWallStandardCase","IfcSlab","IfcRoof","IfcWindow","IfcDoor","IfcColumn","IfcBeam","IfcStair","IfcStairFlight","IfcRailing","IfcCurtainWall","IfcPlate","IfcMember","IfcBuildingElementProxy","IfcFurnishingElement","IfcFlowTerminal","IfcSpace","IfcDuctSegment","IfcPipeSegment","IfcFlowFitting","IfcFlowController","IfcDiscreteAccessory","IfcSite","IfcBuilding","IfcBuildingStorey","IfcGroup","IfcZone","IfcSystem","IfcDistributionSystem","IfcProject","IfcOpeningElement","IfcAnnotation","IfcGrid","IfcCovering","IfcFooting","IfcPile","IfcRamp","IfcRampFlight","IfcFlowSegment","IfcFlowStorageDevice","IfcFlowMovingDevice","IfcFlowTreatmentDevice","IfcEnergyConversionDevice","IfcCivilElement","IfcGeographicElement","IfcVirtualElement"],n=[];for(const a of s)n.push((async()=>{const f=new RegExp(`^${a}$`,"i");for(const[w,m]of e.list)try{const u=await m.getItemsOfCategories([f]);if(u&&Object.keys(u).length>0&&Object.values(u).some(C=>C&&C.length>0))return a}catch{}return null})());return(await Promise.all(n)).filter(a=>a!==null).sort()},getItemsByCategory:async e=>{const s=l.current;if(!s)return console.error("ðŸ” [getItemsByCategory] Fragments not available"),{};const n={};for(const[o,a]of s.list)try{const f=await a.getItemsOfCategories(e);if(f&&Object.keys(f).length>0){const w=Object.values(f).flat();w.length>0&&(n[o]=w)}}catch(f){console.error(`ðŸ” [getItemsByCategory] Failed for model ${o}`,f)}return n},getItemsDataByModel:async(e,s,n)=>{const o=l.current;if(!o)return console.error("ðŸ” [getItemsDataByModel] Fragments not available"),[];const a=o.list.get(e);if(!a)return console.error(`ðŸ” [getItemsDataByModel] Model ${e} not found`),[];try{return await a.getItemsData(s,n)}catch(f){return console.error(`ðŸ” [getItemsDataByModel] Failed for model ${e}`,f),[]}},fitViewTo:async e=>{if(!e.length)return;const s=c.current,n=l.current;if(!s||!n||!b.current)return;const o=s.camera??null,a=o?.controls??null,f=o?.three??null,{grouped:w}=await Dt(e),m=new dt;let u=!1;for(const[S,x]of w.entries()){const M=n.list.get(S);if(!M||!M.object)continue;const D=new dt().setFromObject(M.object);D.isEmpty()||(u?m.union(D):(m.copy(D),u=!0))}if(!u)return;const I=new ee,C=new ee;m.getCenter(I),m.getSize(C);const R=(Math.max(C.x,C.y,C.z)||10)*1.5;a?a.setLookAt(I.x+R,I.y+R,I.z+R,I.x,I.y,I.z,!0):f&&(f.position.set(I.x+R,I.y+R,I.z+R),f.lookAt(I))}}),[Dt]);kt.current=Ne;const hn=d.useCallback(async()=>{if(y)try{if(!Ne.getItemsByCategory||!Ne.getItemsDataByModel){console.warn("viewerApi missing required methods for level extraction");return}const e=await Ne.getItemsByCategory([/IfcBuildingStorey/i]),s=[];for(const[o,a]of Object.entries(e)){if(a.length===0)continue;const f=await Ne.getItemsDataByModel(o,a,Pe);for(let w=0;w<f.length;w++){const m=f[w];let u=ge(m,["name","label","longname"]);u||(u=qe(m)),u||(u=`Level ${w+1}`);let I=ge(m,["elevation","z"]);!I&&m.Elevation&&(I=Ee(m.Elevation));const C=ge(m,["globalid","guid","_guid"]);if(C){const A=I?parseFloat(I):0;s.push({name:u,elevation:isNaN(A)?0:A,globalId:C})}}}s.sort((o,a)=>o.elevation-a.elevation);const n=[];if(s.length>0){const o=s[0].elevation;s.forEach(a=>{n.push({name:a.name,elevation:a.elevation-o,originalElevation:a.elevation,globalId:a.globalId})})}if(bs(n),n.length>0&&(Xo(n[0].globalId),et.current&&l.current))try{let o=0;for(const[m,u]of l.current.list)if(typeof u.getCoordinates=="function")try{const I=await u.getCoordinates();if(Array.isArray(I)&&I.length>=2){o=I[1];break}}catch{}const f=n[0].originalElevation+o,w=et.current.three;w&&w.position&&(w.position.y=f)}catch{}}catch(e){console.error("Failed to extract levels",e)}},[y,Ne]);d.useEffect(()=>{y&&hn()},[y,hn]);const zs=d.useCallback(()=>{_t(!0),Wr(e=>e+1)},[]),Ds=d.useCallback(()=>{_t(!1),Se()},[Se]),mn=d.useCallback(()=>{Be?(_t(!1),Se()):(_t(!0),Wr(e=>e+1))},[Be,Se]),$s=d.useCallback(async e=>{try{const{setIdsXmlText:s,runCheck:n}=await St(()=>Promise.resolve().then(()=>vl),void 0).then(o=>o.idsStore);s(e),_t(!0),Wr(o=>o+1),setTimeout(async()=>{kt.current&&await n(kt.current)},100)}catch(s){console.error("Failed to validate from IDS Creator:",s),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Je.current=k},[k]),d.useEffect(()=>{Ve.current=null,Vt.current=null;try{Xn.invalidateCaches()}catch(e){console.warn("Failed to invalidate IDS caches",e)}},[P]),d.useEffect(()=>{const e=t.current;if(!e)return;let s=!1;So.current||(Ei.init(),Ai.init(),So.current=!0);try{e.replaceChildren()}catch{}const n=new Ri;g.current=n;const a=n.get(Mi).create();a.name="main",a.scene=new zi(n),a.scene.setup(),a.renderer=new Di(n,e);const f=a.renderer.three;f.shadowMap.enabled=!1,f.sortObjects=!1,a.camera=new $i(n),a.camera.controls?.setLookAt(10,10,10,0,0,0),a.camera.three.near=.1,a.camera.three.far=1e9,a.camera.three.updateProjectionMatrix();const w=a.camera.controls;w&&(tn.current=w,"mouseButtons"in w&&(w.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in w&&(w.dollySpeed=1));const m=new Vi(16777215,1);a.scene.three.add(m),c.current=a;const u=new ni;u.showPanel(2),u.dom.style.position="absolute",u.dom.style.left="8px",u.dom.style.top="8px",u.dom.style.zIndex="1000",e.appendChild(u.dom),a.renderer.onBeforeUpdate.add(()=>u.begin()),a.renderer.onAfterUpdate.add(()=>u.end());let I=null;const C=async S=>{if(!b.current)return;const x=[];for(const[F,B]of Object.entries(S))B.forEach(K=>{Number.isInteger(K)&&x.push({modelId:F,localId:K})});const M=Je.current;if(!!xo(x,M))return;$(x),at();const _=l.current;if(!_||!x.length){Ce(null);return}const T=x[0],O=_.list.get(T.modelId);if(!O){Ce(null);return}try{const[F]=await O.getItemsData([T.localId],Pe);Ce(F||null)}catch(F){console.warn("Failed to fetch properties for selection",F)}},A=()=>{fr.current||Qe.current||($([]),Ce(null))};return(async()=>{try{await Promise.resolve(n.init())}catch(O){console.error("Failed to initialize viewer components",O);return}if(s)return;try{const F=n.get(Fi).create(a);et.current=F,F&&(F.visible=!0)}catch(O){console.warn("Failed to create grid component",O)}const x=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),M=URL.createObjectURL(new File([x],"worker.mjs",{type:"text/javascript"}));v.current=M;const D=n.get(Ni);await D.init(M),l.current=D,b.current=!0;const _=n.get(Oi);_.setup({world:a}),_.zoomToSelection=!1;try{typeof _.create=="function"&&_.create("select");let O=0;const F=10;for(;O<F&&(!_.selection||!_.selection.select);)await new Promise(B=>setTimeout(B,20)),O++;(!_.selection||!_.selection.select)&&console.warn("Highlighter selection system still initializing (non-blocking)")}catch(O){console.warn("Error during highlighter initialization:",O)}be.current=_;const T=n.get(Ti);Ae.current=T;try{const O=n.get(Li);if(O.world=a,O.color=new Te("#ff0000"),"snapDistance"in O&&(O.snapDistance=.5),"preview"in O){const F=O.preview;F&&(F.enabled=!0,F.color&&(F.color=new Te("#00ff00")))}if("workingPlane"in O){const F=O.workingPlane;F&&typeof F=="object"&&(F.visible=!0)}O.list?.onItemAdded&&O.list.onItemAdded.add(F=>{const B=F.value||F.distance?.()||0;en(B.toFixed(3)),F.dimensionLabel&&(F.dimensionLabel.visible=!0)}),O.enabled=!1,br.current=O}catch(O){console.error("Failed to initialize measurement tool:",O)}_.events.select.onHighlight.add(C),_.events.select.onClear.add(A),I=()=>{_.events.select.onHighlight.remove?.(C),_.events.select.onClear.remove?.(A)},bt()?.controls?.addEventListener("rest",()=>D.core.update(!0));try{const F=(await St(()=>import("./thatopen-vendor-BXeQhCq_.js").then(Z=>Z.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new F,K="/Savora-Viewer/";B.wasm={path:`${K}web-ifc/`,absolute:!0},h.current=B}catch(O){console.warn("Failed to lazy-load FRAGS.IfcImporter:",O)}s||Ye(!0)})().catch(S=>{console.error("Failed to initialize viewer fragments",S)}),()=>{s=!0,(async()=>{const S=b.current;b.current=!1,I?.(),I=null;try{S&&await Ae.current?.set?.(!0)}catch{}if(l.current){const x=[...l.current.list.keys()];await Promise.all(x.map(M=>l.current.core.disposeModel(M)))}try{S&&be.current?.clear?.()}catch{}v.current&&URL.revokeObjectURL(v.current);try{n.dispose()}catch{}try{e.replaceChildren()}catch{}be.current=null,Ae.current=null})()}},[]),d.useEffect(()=>{if(!ye)return;const e=g.current,s=l.current;if(!e||!s)return;const n=Ir,o=(a,f,w)=>{if(!a)return;let m=f.current;m||(m=w(),f.current=m),m&&m.parentElement!==a&&a.replaceChildren(m)};o(jo.current,pt,()=>{const[a,f]=Dn.modelsList({components:e});return Lr.current=f,a}),pt.current&&((!pt.current.dataset.initialized||n!==ko.current)&&Lr.current?.({components:e}),pt.current.dataset.initialized||(pt.current.dataset.initialized="true",pt.current.style.width="100%")),ar.current!==vo.current&&(Vr.current=null,Lt.current=null,vo.current=ar.current),o(ar.current,Vr,()=>{const[a,f]=Dn.spatialTree({components:e,models:Array.from(s.list.values())});Lt.current=f,a.style.width="100%",a.style.height="100%",a.style.overflow="auto";const w=a;return w.queryString=Pt.trim()?Pt.trim():null,a}),Lt.current&&Lt.current({components:e,models:Array.from(s.list.values())}),ko.current=n},[ye,te,Pt,Ir]),d.useEffect(()=>{if(!ye)return;const e=g.current,s=l.current,n=Lt.current;!e||!s||!n||n({components:e,models:Array.from(s.list.values())})},[ye,Ir]),d.useEffect(()=>{const e=Vr.current;if(!e)return;const s=Pt.trim();e.queryString=s||null},[Pt]);const Fs=async()=>{const e=i.current,s=e?.files?.[0];if(!s)return;const n=s.name.split(".").pop()?.toLowerCase(),o=l.current,a=h.current,f=c.current;if(!o||!f){alert("Viewer is still initializing. Please try again in a moment."),e&&(e.value="");return}const w=bt(),m=w?.three??null,u=w?.controls??null;let I=!1;try{const C=`${s.name}-${Date.now()}`;let A;if(n==="ifc"){if(!a)throw new Error("IFC importer is not ready.");console.log("ðŸ”§ Starting IFC conversion:",s.name),ot(0),I=!0,nt.current=!1,Ke(!1);const D=new AbortController;Tt.current=D;const _=new Uint8Array(await s.arrayBuffer());console.log("ðŸ”§ IFC file size:",_.byteLength,"bytes");const T=await a.process({bytes:_,progressCallback:(F,B)=>{if(nt.current)return;const K=typeof F=="number"?F:0,Z=K<=1?K*100:K,W=Math.max(0,Math.min(100,Z));ot(Number(W.toFixed(1)))},signal:D.signal});if(console.log("ðŸ”§ IFC conversion complete"),nt.current)throw{__cancelled:!0};let O;if(T instanceof ArrayBuffer){const F=new Uint8Array(T),B=new Uint8Array(F.byteLength);B.set(F),O=B.buffer}else if(T instanceof Uint8Array){const F=new Uint8Array(T.byteLength);F.set(T),O=F.buffer}else{const F=T,B=new Uint8Array(F),K=new Uint8Array(B.byteLength);K.set(B),O=K.buffer}A=await o.core.load(O,{modelId:C})}else if(n==="frag"){const D=await s.arrayBuffer();A=await o.core.load(D,{modelId:C})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}p.current=C,m?A.useCamera(m):console.warn("World camera not ready; skipping model camera binding."),f.scene.three.add(A.object),await o.core.update(!0);const R=be.current;if(R)try{R.enabled=!0,typeof R.update=="function"&&R.update(),typeof R.create=="function"&&(R.list?.has("select")||R.create("select"))}catch(D){console.warn("Failed to update highlighter after load:",D)}await new Promise(D=>requestAnimationFrame(()=>D()));const S=new dt().setFromObject(A.object),x=new ee;S.getCenter(x),(Math.abs(x.x)>1e6||Math.abs(x.y)>1e6||Math.abs(x.z)>1e6)&&(console.log("âš ï¸  Model is georeferenced (far from origin), recentering..."),A.object.position.sub(x),console.log("  - New position:",A.object.position.x.toFixed(3),A.object.position.y.toFixed(3),A.object.position.z.toFixed(3)));try{u&&await u.fitToBox(A.object,!0)}catch{const D=new ee;S.getSize(D);const T=(Math.max(D.x,D.y,D.z)||10)*2.5;u?u.setLookAt(x.x+T,x.y+T,x.z+T,x.x,x.y,x.z,!0):m&&(m.position.set(x.x+T,x.y+T,x.z+T),m.lookAt(x))}hs(D=>({...D,[C]:Dl(C,s.name,A.object)})),E(!0),V(D=>[...D,{id:C,label:s.name}]),at();const M=g.current;M&&Lr.current?.({components:M}),I&&ot(100)}catch(C){C&&(C.__cancelled||C?.name==="AbortError")||(console.error(C),alert("Failed to load model. See console for more details.")),E(!1)}finally{e&&(e.value=""),I&&setTimeout(()=>ot(null),200),Tt.current=null,Ke(!1)}},Ns=d.useCallback(()=>{if(we!==null){nt.current=!0,Ke(!0);try{Tt.current?.abort()}catch{}ot(null)}},[we]),at=d.useCallback(()=>{J(!0),Y(!1)},[]),gn=d.useCallback(()=>{J(e=>{const s=!e;return s&&Y(!1),s})},[]),Os=d.useCallback(()=>{J(!1)},[]),Ts=d.useCallback(()=>{Y(e=>!e)},[]),yn=d.useMemo(()=>Math.min(360,Math.max(180,ir.height*.45)),[ir.height]),Ls=+!os+ +!ns,no=!rs&&Ls===0;d.useEffect(()=>{const e=pt.current;e&&(e.style.width="100%",e.style.maxHeight=no?"100%":`${yn}px`,e.style.height=no?"100%":"auto")},[no,yn,Ir]);const Vs=d.useCallback(async e=>{const s=x=>{const M=[],D=new Set;if(!x||typeof x!="object")return{terms:M,modelIds:D};for(const[_,T]of Object.entries(x)){if(T==null)continue;const O=_.trim().toLowerCase(),F=Array.isArray(T)?T:[T];if(F.length){if(O==="modelid"||O==="modelids"||O==="model"){for(const B of F){const K=typeof B=="string"?B.trim():String(B??"").trim();K&&D.add(K)}continue}if(["text","query","keyword","search"].includes(O)){for(const B of F){if(B==null)continue;const K=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();K&&M.push({type:"text",value:K})}continue}for(const B of F){if(B==null)continue;let K=null;typeof B=="string"?K=B.trim():(typeof B=="number"||typeof B=="boolean")&&(K=String(B)),K&&M.push({type:"field",key:O,value:K.toLowerCase()})}}}return{terms:M,modelIds:D}},n=l.current;if(!n){console.warn("AI selection requested but fragments are unavailable.");return}if(!b.current){console.warn("AI selection requested before fragments were fully initialized.");return}const o=be.current,a=Ae.current,{terms:f,modelIds:w}=s(e.filter),m=e.mode?.toLowerCase?.(),u=m==="isolate"||m==="focus";if(e.action==="clear"){try{o?.clear?.()}catch{}if(a)try{await a.set(!0)}catch(x){console.warn("Failed to reset visibility while clearing AI selection",x)}try{const x=Xe.current;if(x&&x.mesh&&x.mesh.instanceColor){const M=new Te(1,1,1);x.mesh.setColorAt(x.index,M),x.mesh.instanceColor.needsUpdate=!0}}catch{}Xe.current=null,Fe.current&&(Fe.current.visible=!1),$([]),Ce(null);return}if(f.length===0){console.warn("AI selection command did not include usable filters",e);return}const I=++or.current,C=[],A=60;for(const x of n.list.values()){const M=typeof x?.modelId=="string"?x.modelId:"";if(w.size&&!w.has(M))continue;let D=[];try{const T=await x.getLocalIds();Array.isArray(T)?D=T.slice():T&&typeof T[Symbol.iterator]=="function"&&(D=Array.from(T))}catch(T){console.warn("Failed to fetch local IDs for model",M,T)}const _={model:x,modelId:M,allIds:D,matched:new Set};if(C.push(_),!!D.length)for(let T=0;T<D.length;T+=A){if(I!==or.current)return;const O=D.slice(T,T+A);let F=[];try{F=await x.getItemsData(O,Pe)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}O.forEach((B,K)=>{const Z=F?.[K];if(!Z)return;let W=[];try{W=zr(Z).rows}catch(ae){console.warn("Failed to build property rows for AI selection",ae)}const pe=W.map(ae=>ae.searchText),ue=Wn(Z,6e3).toLowerCase();f.every(ae=>{if(ae.type==="text")return pe.some(ve=>ve.includes(ae.value))||ue.includes(ae.value);const Me=Ml[ae.key]??[ae.key];return pe.some(ve=>Me.some(Ue=>ve.includes(Ue))&&ve.includes(ae.value))?!0:Me.some(ve=>ue.includes(ve)&&ue.includes(ae.value))})&&_.matched.add(B)})}}if(I!==or.current)return;const R=C.filter(x=>x.matched.size>0);if(!R.length)return;try{const x=Xe.current;if(x&&x.mesh&&x.mesh.instanceColor){const M=new Te(1,1,1);x.mesh.setColorAt(x.index,M),x.mesh.instanceColor.needsUpdate=!0}}catch{}if(Xe.current=null,Fe.current&&(Fe.current.visible=!1),a)try{await a.set(!0)}catch(x){console.warn("Failed to reset hidden state before AI selection",x)}if(o){try{o.clear?.()}catch{}const x=u?16754240:6737151;for(const M of R){const D=Array.from(M.matched);if(D.length)try{typeof o.highlightById=="function"?await o.highlightById(M.model,D,x):typeof o.highlightByID=="function"?await o.highlightByID(M.model,D,x):typeof o.add=="function"&&o.add(M.model,D,x)}catch(_){console.warn("Failed to apply AI highlight for model",M.modelId,_)}}}if(u&&a){const x={};for(const M of C){if(!M.allIds.length||M.matched.size===M.allIds.length)continue;const D=M.allIds.filter(_=>!M.matched.has(_));D.length&&(x[M.modelId]=new Set(D))}if(Object.keys(x).length)try{await a.set(!1,x)}catch(M){console.warn("Failed to isolate AI-selected elements",M)}}const S=R.flatMap(x=>Array.from(x.matched).map(M=>({modelId:x.modelId,localId:M})));$(S),at();try{const x=R[0],M=Array.from(x.matched)[0];if(M!==void 0){const[D]=await x.model.getItemsData([M],Pe);I===or.current&&Ce(D||null)}}catch(x){console.warn("Failed to fetch properties for AI selection result",x)}},[at,$,Ce]),jr=d.useCallback(e=>{if(!lr.current)return;const s=Or.current;if(!s)return;const n=e.clientX-s.startX,o=e.clientY-s.startY,a=280,f=260;Zn(w=>{const m=s.width,u=s.height,I=Math.max(a,m+n),C=Math.max(f,u+o);return I===w.width&&C===w.height?w:{width:Math.round(I),height:Math.round(C)}})},[]),Kt=d.useCallback(()=>{lr.current&&(lr.current=!1,Or.current=null,window.removeEventListener("pointermove",jr),window.removeEventListener("pointerup",Kt))},[jr]),_s=d.useCallback(e=>{e.preventDefault(),e.stopPropagation();const s=Tr.current;s&&(lr.current=!0,Or.current={startX:e.clientX,startY:e.clientY,width:s.offsetWidth,height:s.offsetHeight},window.addEventListener("pointermove",jr),window.addEventListener("pointerup",Kt))},[jr,Kt]);d.useEffect(()=>()=>{Kt()},[Kt]),d.useEffect(()=>{Ne&&(ft.getInstance().setViewerApi(Ne),ft.getInstance().indexModel())},[Ne]);const Bs=d.useCallback(async e=>{const s=l.current,n=[];if(!s||s.list.size===0||P.length===0)n.push("No models are currently loaded in the viewer.");else{try{const a=await ft.getInstance().generateContext(e||"");n.push(a),n.push("---")}catch(a){console.warn("AI Engine not ready",a)}n.push(`Loaded models (${P.length}): ${P.map(a=>`${a.label} [${a.id}]`).join(", ")}`),n.push(`Fragments models in memory: ${s.list.size}`);try{const a=new dt;for(const w of s.list.values())a.expandByObject(w.object);const f=new ee;a.getSize(f),n.push(`Scene bounds approx size => x:${f.x.toFixed(2)} y:${f.y.toFixed(2)} z:${f.z.toFixed(2)}`)}catch(a){console.warn("Failed to compute bounds for AI context",a)}const o=P.map(a=>Go[a.id]).filter(a=>!!a);if(o.length){let a=0;const f=new Map;n.push("Model geometry snapshots:");for(const m of o){a+=m.elementCount;for(const{category:I,count:C}of m.categoryCounts)f.set(I,(f.get(I)??0)+C);const u=m.categoryCounts.slice(0,5).map(({category:I,count:C})=>`${I}: ${C}`);n.push(`- ${m.label} [${m.modelId}] â†’ elementsâ‰ˆ${m.elementCount}, instancedâ‰ˆ${m.instancedCount}, meshesâ‰ˆ${m.meshCount}`),u.length&&n.push(`  top categories: ${u.join(" | ")}`),n.push(`  bbox size (approx): x:${m.bboxSize.x.toFixed(2)} y:${m.bboxSize.y.toFixed(2)} z:${m.bboxSize.z.toFixed(2)}`)}const w=Array.from(f.entries()).sort((m,u)=>u[1]-m[1]).slice(0,10).map(([m,u])=>`${m}: ${u}`);n.push(`Global approx element total: ${a}`),w.length&&n.push(`Global top categories: ${w.join(" | ")}`)}else n.push("Geometry summaries are initializing â€” load a model or wait a moment after loading.")}if(k.length){n.push(`Active selection count: ${k.length}`);for(let o=0;o<k.length;o+=1){const a=k[o];n.push(`Selection #${o+1} â†’ modelId:${a.modelId}, localId:${a.localId}`);let f=null;if(o===0&&q&&Object.keys(q).length)f=q;else if(s){const w=s.list.get(a.modelId);if(w)try{const[m]=await w.getItemsData([a.localId],Pe);f=m||null}catch(m){console.warn("Failed to fetch properties for AI context (multi)",m)}}if(f){n.push("  Property snapshot (compact JSON):"),n.push(`  ${Wn(f,4e3)}`);const w=zr(f).rows;if(w.length){n.push(`  Flattened properties (${w.length} entries):`);for(const m of w.slice(0,120))n.push(`  - ${m.label}: ${m.value}`);w.length>120&&n.push(`  (Truncated ${w.length-120} additional properties)`)}}else n.push("  Properties for this selection are not available yet.")}}if(Gt.length){n.push("ItemsData extracted name/value pairs (last selection):");const o=150,a=Gt.slice(0,o);for(const f of a)n.push(`- ${f.path}: ${f.value}`);Gt.length>o&&n.push(`(Truncated ${Gt.length-o} additional rows)`)}return Ur&&(n.push("ItemsData table snapshot for last selection (tab-separated):"),n.push(Ur)),n.length===0&&n.push("Viewer is idle: no models or selections to describe."),n.join(`
`)},[P,k,q,le,Go,Ur,Gt]),Gs=d.useCallback(async()=>{const e=c.current,s=l.current,n=p.current;if(!e||!s||!n||!b.current)return;const o=s.list.get(n);if(!o)return;await s.core.update(!0),await new Promise(w=>requestAnimationFrame(()=>w()));const a=o.object,f=new dt().setFromObject(a);if(!f.isEmpty()){const w=bt(),m=w?.controls??null,u=w?.three??null;try{m&&await m.fitToBox(a,!0)}catch{const C=new ee,A=new ee;f.getCenter(C),f.getSize(A);const S=(Math.max(A.x,A.y,A.z)||10)*2.5;m?m.setLookAt(C.x+S,C.y+S,C.z+S,C.x,C.y,C.z,!0):u&&(u.position.set(C.x+S,C.y+S,C.z+S),u.lookAt(C))}}},[]),Ws=d.useCallback(async()=>{const e=Je.current,s=Ae.current;if(!e||e.length===0||!s||!b.current){Re(null);return}const n={};for(const o of e)n[o.modelId]||(n[o.modelId]=new Set),n[o.modelId].add(o.localId);try{await s.set(!1,n);try{be.current?.clear?.()}catch{}$([]),Ce(null)}catch(o){console.warn("Failed to hide selected element",o)}finally{Re(null)}},[Re,$,Ce]),Us=d.useCallback(async()=>{const e=Ae.current;if(!e||!b.current){Re(null);return}try{await e.set(!0)}catch(s){console.warn("Failed to reset hidden items",s)}finally{Re(null)}},[Re]),Hs=d.useCallback(()=>{Re(null)},[Re]);d.useEffect(()=>{const e=t.current,s=c.current;if(!e||!s)return;const n=s.renderer?.three.domElement;if(!n)return;const o=new go,a=async(S,x,M,D)=>{const _=l.current;if(!_){console.warn("âŒ No fragments manager");return}const T=Jr();if(!T){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const O=n.getBoundingClientRect();new $n;const F=new Map,B=10,K=M-S,Z=D-x;console.log(`Rectangle selection: ${Math.round(K)}x${Math.round(Z)} pixels, models: ${_.list.size}`),console.log(`Filter ghost mode active: ${Qe.current}`);let W=0;for(const ze of _.list.values())try{const re=await ze.getLocalIds(),He=Array.isArray(re)?re.length:re&&typeof re[Symbol.iterator]=="function"?Array.from(re).length:0;W+=He}catch(re){console.debug("Failed to get object count for model:",re)}if(console.log(`Total objects in models: ${W}`),K<3||Z<3){await f((S+M)/2,(x+D)/2);return}let pe=0,ue=0,We=0;const ae=(S+M)/2,Me=(x+D)/2,Yt=(ae-O.left)/O.width*2-1,ve=-((Me-O.top)/O.height)*2+1;console.log(`Testing center point: screen=(${Math.round(ae)}, ${Math.round(Me)}), NDC=(${Yt.toFixed(3)}, ${ve.toFixed(3)})`);for(const ze of _.list.values())try{const re=await ze.raycast({camera:T,mouse:new go(Yt,ve),dom:n});re&&typeof re.distance=="number"?console.log(`âœ“ Center point HIT! distance=${re.distance.toFixed(2)}, localId=${re.localId}`):console.log(`âœ— Center point MISS (hit=${!!re})`)}catch(re){console.log("âœ— Center point ERROR:",re)}let Ue=!0;for(let ze=S;ze<=M;ze+=B)for(let re=x;re<=D;re+=B){pe++;const He=(ze-O.left)/O.width*2-1,bn=-((re-O.top)/O.height)*2+1;o.set(He,bn);for(const vr of _.list.values())try{const kr=new go(He,bn),ao=await vr.raycast({camera:T,mouse:kr,dom:n});if(ao&&typeof ao.distance=="number"){ue++;const Pr=ao.localId;Pr!=null&&Number.isInteger(Pr)&&(F.has(vr.modelId)||F.set(vr.modelId,new Set),F.get(vr.modelId).add(Pr))}}catch(kr){We++,Ue&&console.warn("âŒ Raycast error on first sample:",kr),console.debug("Skipping model due to raycast error:",kr)}Ue&&(Ue=!1)}const Oe=[];for(const[ze,re]of F.entries())for(const He of re)Oe.push({modelId:ze,localId:He});if(Oe.length===0){console.warn(`âš ï¸ No objects found in rectangle (sampled ${pe} points, ${ue} hits, ${We} errors)`),console.log(`Rectangle bounds: left=${Math.round(S)}, top=${Math.round(x)}, right=${Math.round(M)}, bottom=${Math.round(D)}`),console.log(`Canvas rect: ${Math.round(O.left)}, ${Math.round(O.top)}, ${Math.round(O.width)}x${Math.round(O.height)}`),$([]),Ce(null);return}console.log(`âœ“ Rectangle selection found ${Oe.length} objects from ${ue} hits`);const lo=Je.current;if(!xo(Oe,lo)&&($(Oe),at(),Oe.length>0)){const ze=Oe[0],re=_.list.get(ze.modelId);if(re)try{const[He]=await re.getItemsData([ze.localId],Pe);Ce(He||null)}catch(He){console.warn("Failed to fetch properties for rectangle selection",He)}}},f=async(S,x)=>{const M=l.current;if(!M)return;const D=Jr();if(!D){console.warn("Picking skipped: viewer camera not ready.");return}const _=n.getBoundingClientRect();o.x=(S-_.left)/_.width*2-1,o.y=-((x-_.top)/_.height)*2+1;let T=null;const O=new $n;O.setFromCamera(o,D);for(const Z of M.list.values())try{const W=await Z.raycast({camera:D,mouse:o,dom:s.renderer.three.domElement});if(W&&typeof W.distance=="number"){const pe=W.point instanceof ee?W.point.clone():O.ray.at(W.distance,new ee);(!T||W.distance<T.dist)&&(T={dist:W.distance,model:Z,localId:W.localId,point:pe,object:W.object,instanceId:W.instanceId})}}catch{}if(!T)return;const F=be.current;if(F&&F.enabled!==!1)try{typeof F.clear=="function"&&!fr.current&&!Qe.current&&F.selection&&F.selection.select&&F.clear();const Z=6737151,W=F.selection&&F.selection.select;if(!F.onBeforeHighlight||!W)return;typeof F.highlightByID=="function"?F.selection&&F.selection.select&&await F.highlightByID(T.model.uuid,[T.localId],Z):typeof F.add=="function"?F.selection&&F.selection.select&&F.add(T.model.uuid,[T.localId]):typeof F.highlight=="function"&&F.selection&&F.selection.select&&await F.highlight(T.model,[T.localId],Z)}catch(Z){console.warn("Highlighter failed, using fallback:",Z);try{const W=T.object,pe=T.instanceId;if(W&&W.isInstancedMesh&&Number.isInteger(pe)){const ue=Xe.current;if(ue&&ue.mesh&&ue.mesh.instanceColor){const Me=new Te(1,1,1);try{ue.mesh.setColorAt(ue.index,Me),ue.mesh.instanceColor.needsUpdate=!0}catch{}}const We=W,ae=new Te(6737151);try{We.setColorAt(pe,ae),We.instanceColor.needsUpdate=!0}catch{}Xe.current={mesh:We,index:pe}}}catch{}}try{const Z=T.point??new ee;let W=Fe.current;if(!W){W=new _i;const We=new dt,ae=l.current;if(ae&&ae.list.size)for(const lo of ae.list.values())We.expandByObject(lo.object);const Me=new Bi;We.getBoundingSphere(Me);const Yt=isFinite(Me.radius)&&Me.radius>0?Me.radius*.01:.3,ve=Math.max(.05,Math.min(2,Yt)),Ue=new Fn(new Gi(ve*.5,16,16),new Nn({color:16763904,depthTest:!1})),Oe=new Fn(new Wi(ve*.8,ve,32),new Nn({color:16772744,side:Ui,depthTest:!1,transparent:!0,opacity:.9}));Oe.rotation.x=Math.PI/2,Ue.renderOrder=999,Oe.renderOrder=999,W.add(Ue),W.add(Oe),s.scene.three.add(W),Fe.current=W}W.position.copy(Z);const pe=W.children[1],ue=Jr();ue&&pe.lookAt(ue.position),W.visible=!0}catch{}const B=Je.current,K=[{modelId:T.model.modelId,localId:T.localId}];if(!xo(K,B)){$(K),at();try{const[Z]=await T.model.getItemsData([T.localId],Pe);Ce(Z||null)}catch{}}},w=async S=>{if(Re(null),S.button===0)if(Nr.current==="rectangle"&&!Ht.current){if(sr.current=!0,vt.current={x:S.clientX,y:S.clientY},!Le.current){const M=document.createElement("div");M.style.position="fixed",M.style.border="2px solid #1976d2",M.style.backgroundColor="rgba(25, 118, 210, 0.1)",M.style.pointerEvents="none",M.style.zIndex="10000",document.body.appendChild(M),Le.current=M}const x=Le.current;x.style.left=`${S.clientX}px`,x.style.top=`${S.clientY}px`,x.style.width="0px",x.style.height="0px",x.style.display="block"}else await f(S.clientX,S.clientY)},m=S=>{if(!sr.current||!vt.current||!Le.current)return;const x=vt.current,M=Le.current,D=Math.min(S.clientX,x.x),_=Math.min(S.clientY,x.y),T=Math.abs(S.clientX-x.x),O=Math.abs(S.clientY-x.y);M.style.left=`${D}px`,M.style.top=`${_}px`,M.style.width=`${T}px`,M.style.height=`${O}px`},u=async S=>{if(sr.current&&vt.current&&Le.current){const x=vt.current,M=Le.current;M.style.display="none",sr.current=!1;const D=Math.min(S.clientX,x.x),_=Math.min(S.clientY,x.y),T=Math.max(S.clientX,x.x),O=Math.max(S.clientY,x.y);await a(D,_,T,O),vt.current=null}},I=async S=>{Re(null),!Ht.current&&Nr.current==="click"&&await f(S.clientX,S.clientY)},C=()=>{if(Ht.current){const S=br.current;S&&typeof S.create=="function"&&S.create()}},A=S=>{S.preventDefault();const x=Je.current;if(!x||x.length===0){Re(null);return}Re({mouseX:S.clientX+2,mouseY:S.clientY-6})},R=S=>{if(Ht.current&&(S.code==="Delete"||S.code==="Backspace")){const x=br.current;x&&typeof x.delete=="function"&&x.delete()}};return n.addEventListener("pointerdown",w,{capture:!0}),n.addEventListener("pointermove",m),n.addEventListener("pointerup",u),n.addEventListener("click",I),n.addEventListener("dblclick",C),n.addEventListener("contextmenu",A),window.addEventListener("keydown",R),()=>{n.removeEventListener("pointerdown",w,{capture:!0}),n.removeEventListener("pointermove",m),n.removeEventListener("pointerup",u),n.removeEventListener("click",I),n.removeEventListener("dblclick",C),n.removeEventListener("contextmenu",A),window.removeEventListener("keydown",R),Le.current&&(Le.current.remove(),Le.current=null);try{const S=Fe.current;S&&(s.scene.three.remove(S),S.traverse(x=>{if(x.geometry&&x.geometry.dispose?.(),x.material){const M=Array.isArray(x.material)?x.material:[x.material];for(const D of M)D?.dispose?.()}}),Fe.current=null)}catch{}try{const S=Xe.current;if(S&&S.mesh&&S.mesh.instanceColor){const x=new Te(1,1,1);S.mesh.setColorAt(S.index,x),S.mesh.instanceColor.needsUpdate=!0}Xe.current=null}catch{}}},[]);const qs=d.useCallback(()=>{c.current;const e=bt(),s=e?.controls??null,n=e?.three??null;s?s.reset(!0):n&&(n.position.set(10,10,10),n.lookAt(0,0,0))},[]),so=d.useCallback(e=>{yr(s=>{const n={...s,[e]:!s[e]},o=c.current;if(!o)return n;const a=o.renderer?.three,f=o.scene?.three;if(!a||!f)return n;const w=[],m=Xr.current;if(!n[e]){const u=m.get(e);u&&(f.remove(u),u.dispose(),m.delete(e))}if(n.x){const u=new Ft(new ee(1,0,0),Ge.x);if(w.push(u),!m.has("x")){const I=new yo(u,10,16711680);f.add(I),m.set("x",I)}}if(n.y){const u=new Ft(new ee(0,1,0),Ge.y);if(w.push(u),!m.has("y")){const I=new yo(u,10,65280);f.add(I),m.set("y",I)}}if(n.z){const u=new Ft(new ee(0,0,1),Ge.z);if(w.push(u),!m.has("z")){const I=new yo(u,10,255);f.add(I),m.set("z",I)}}return a.clippingPlanes=w,a.localClippingEnabled=w.length>0,Yr.current=w,n})},[Ge]),io=d.useCallback((e,s)=>{Jo(n=>{const o={...n,[e]:s};return requestAnimationFrame(()=>{const f=c.current;if(!f)return;const w=f.renderer?.three;if(!w)return;const m=[],u=Xr.current;if(ne.x){const I=new Ft(new ee(1,0,0),o.x);m.push(I);const C=u.get("x");C&&(C.plane.constant=o.x)}if(ne.y){const I=new Ft(new ee(0,1,0),o.y);m.push(I);const C=u.get("y");C&&(C.plane.constant=o.y)}if(ne.z){const I=new Ft(new ee(0,0,1),o.z);m.push(I);const C=u.get("z");C&&(C.plane.constant=o.z)}w.clippingPlanes=m,Yr.current=m}),o})},[ne]),Ks=d.useCallback(()=>{Zo(e=>{const s=!e;return yr(s?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),s})},[]),Ys=d.useCallback(()=>{xs(e=>{const s=!e;Ht.current=s;const n=br.current;if(n){if(n.enabled=s,!s)try{n.list&&typeof n.list.clear=="function"&&n.list.clear(),en(null)}catch(o){console.warn("Failed to clear measurements:",o)}}else console.warn("âš ï¸ Measurement tool not initialized!");return s})},[]),Xs=d.useCallback(()=>{To(e=>{const s=!e;fr.current=s;const n=l.current,o=be.current,a=fs.current;if(!n)return e;try{if(s){if(!o)return e;const f=o.selection?.select||{};Lo.current=f,o.enabled=!1;const w=[...n.core.models.materials.list.values()];for(const m of w){if(m.userData.customId)continue;let u;"color"in m?u=m.color.getHex():u=m.lodColor.getHex(),a.set(m,{color:u,transparent:m.transparent,opacity:m.opacity}),m.transparent=!0,m.opacity=.05,m.needsUpdate=!0,"color"in m?m.color.setColorName("white"):m.lodColor.setColorName("white")}if(Object.keys(f).length>0)try{n.highlight({customId:"ghost-selected",color:new Te(16750592),renderedFaces:1,opacity:1,transparent:!1},f)}catch(m){console.warn("Failed to apply ghost highlight:",m)}n.core.update(!0)}else{for(const[f,w]of a){const{color:m,transparent:u,opacity:I}=w;f.transparent=u,f.opacity=I,"color"in f?f.color.setHex(m):f.lodColor.setHex(m),f.needsUpdate=!0}a.clear(),o&&(o.enabled=!0),Lo.current=null,n.resetHighlight(),n.core.update(!0)}}catch(f){return console.warn("Failed to toggle ghost mode:",f),e}return s})},[]),Js=d.useCallback(()=>{us(e=>{const s=!e,n=Ae.current,o=be.current;if(!n)return console.warn("âš ï¸ Hider not available for isolate mode"),e;try{if(s){const a=o?.selection?.select||{},f={};for(const[w,m]of Object.entries(a))m&&typeof m.size=="number"&&m.size>0&&(f[w]=m);if(Object.keys(f).length>0)n.isolate(f);else return console.warn("âš ï¸ No selection to isolate"),e}else n.set(!0)}catch(a){return console.warn("Failed to toggle isolate mode:",a),e}return s})},[]),Zs=d.useCallback(async()=>{const e=l.current,s=be.current,n=Ae.current;if(!e||!b.current){console.warn("Fragments not ready");return}if(!s){console.warn("Highlighter not available");return}try{let o={},a=0;const f=Qe.current,w=Mt.current!==null;if(console.log(`Filter state: ghostMode=${f}, hasSelection=${w}`),f&&w){if(o=Mt.current,a=Object.values(o).reduce((C,A)=>C+A.size,0),a===0){console.warn("No filtered objects found. Try using the Model Filter first.");return}console.log(`Selecting ${a} filtered objects (ghost mode)`)}else if(n&&n.list&&n.list.size>0){console.log(`Checking for hidden objects in ${e.list.size} models`);for(const[C,A]of e.list)try{let R=[];const S=await A.getLocalIds();if(Array.isArray(S)?R=S:S&&typeof S[Symbol.iterator]=="function"&&(R=Array.from(S)),R.length===0)continue;const x=n.list?.get?.(C),M=x&&x.size>0?x:new Set,D=R.filter(_=>!M.has(_));D.length>0&&(o[C]=new Set(D),a+=D.length),console.log(`Model ${C}: ${D.length} visible of ${R.length} total (${M.size} hidden)`)}catch(R){console.error("Failed to get IDs for model",C,R)}if(a===0){console.warn("No visible objects found (all are hidden)");return}console.log(`Selecting ${a} visible objects (isolate/hide mode)`)}else{for(const[C,A]of e.list)try{let R=[];const S=await A.getLocalIds();if(Array.isArray(S)?R=S:S&&typeof S[Symbol.iterator]=="function"&&(R=Array.from(S)),R.length===0)continue;let x=new Set;if(n)try{const D=n.list?.get?.(C);D&&D.size>0&&(x=D)}catch(D){console.debug("Could not get hidden IDs for model",C,D)}const M=R.filter(D=>!x.has(D));M.length>0&&(o[C]=new Set(M),a+=M.length)}catch(R){console.error("Failed to get IDs for model",C,R)}if(a===0){console.warn("No visible objects found");return}console.log(`Selecting ${a} visible objects`)}if(!Qe.current&&typeof s.clear=="function")try{s.clear()}catch(C){console.debug("Failed to clear highlighter:",C)}let m=0,u=0;for(const[C,A]of Object.entries(o))try{if(s.selection&&s.selection.select){s.selection.select[C]||(s.selection.select[C]=new Set);const R=s.selection.select[C];A.forEach(S=>R.add(S)),m++}else u++}catch(R){console.debug("Failed to add objects to selection for model",C,R),u++}if(s.events&&s.events.select)try{const C=s.events.select;if(C.onHighlight&&typeof C.onHighlight.trigger=="function"){const A={};for(const[R,S]of Object.entries(o))A[R]=S;C.onHighlight.trigger(A)}}catch(C){console.debug("Failed to trigger highlight event:",C)}const I=[];for(const[C,A]of Object.entries(o))A.forEach(R=>{I.push({modelId:C,localId:R})});$(I),at(),u>0?console.log(`âœ“ Selected ${a} visible objects (${m} models highlighted, ${u} failed)`):console.log(`âœ“ Selected ${a} visible objects from ${m} models`)}catch(o){console.error("Failed to select visible objects:",o)}},[$,at]),Qs=d.useCallback(()=>{yr({x:!1,y:!1,z:!1}),Jo({x:0,y:0,z:0}),Zo(!1);const e=c.current;if(e){const s=e.renderer?.three,n=e.scene?.three;if(s&&(s.clippingPlanes=[],s.localClippingEnabled=!1),n){const o=Xr.current;o.forEach(a=>{n.remove(a),a.dispose()}),o.clear()}}Yr.current=[]},[]),xt=d.useCallback(e=>{const s=c.current,n=l.current,o=p.current,a=bt(),f=a?.three;if(!f||!s||!n||!o)return;const w=n.list.get(o);if(!w)return;const m=new dt().setFromObject(w.object);if(m.isEmpty())return;const u=new ee,I=new ee;m.getCenter(u),m.getSize(I);const A=Math.max(I.x,I.y,I.z)*2||20;let R;switch(e){case"top":R=new ee(u.x,u.y,u.z+A);break;case"bottom":R=new ee(u.x,u.y,u.z-A);break;case"front":R=new ee(u.x,u.y+A,u.z);break;case"back":R=new ee(u.x,u.y-A,u.z);break;case"left":R=new ee(u.x-A,u.y,u.z);break;case"right":R=new ee(u.x+A,u.y,u.z);break;case"iso":R=new ee(u.x+A*.7,u.y+A*.7,u.z+A*.7);break;default:return}const S=a?.controls;S&&typeof S.setLookAt=="function"?S.setLookAt(R.x,R.y,R.z,u.x,u.y,u.z,!0):(f.position.copy(R),f.lookAt(u),f.updateProjectionMatrix())},[]);return r.jsxs("div",{style:{width:"100%",height:"100%"},children:[r.jsx(si,{position:"static",children:r.jsxs(ii,{children:[r.jsx(G,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(G,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:r.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),r.jsx(U,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),r.jsx(Q,{title:"Settings",children:r.jsx(X,{color:"inherit",onClick:pn,sx:{mr:1},children:r.jsx(li,{})})}),r.jsx(Q,{title:"About",children:r.jsx(X,{color:"inherit",onClick:Ps,sx:{mr:1},children:r.jsx(ai,{})})}),r.jsx(se,{color:"inherit",onClick:gn,startIcon:r.jsx(xn,{}),"aria-pressed":te,sx:{mr:1,borderRadius:1.5,backgroundColor:te?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:te?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:te?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),r.jsx(se,{color:"inherit",onClick:un,startIcon:r.jsx(wn,{}),"aria-pressed":_e,sx:{mr:1,borderRadius:1.5,backgroundColor:_e?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:_e?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:_e?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),r.jsx(se,{color:"inherit",onClick:mn,startIcon:r.jsx(In,{}),"aria-pressed":Be,sx:{mr:1,borderRadius:1.5,backgroundColor:Be?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Be?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Be?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),r.jsx(se,{color:"inherit",onClick:dn,startIcon:r.jsx(Cn,{}),"aria-pressed":st,sx:{mr:1,borderRadius:1.5,backgroundColor:st?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:st?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:st?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"}),r.jsx(se,{color:"inherit",onClick:js,sx:{mr:1,borderRadius:1.5,backgroundColor:pr?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:pr?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:pr?"Close QTO":"Open QTO",children:"QTO"})]})}),r.jsx("div",{ref:t,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:we!==null&&r.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:r.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[r.jsx(U,{variant:"subtitle1",sx:{mb:1},children:"Converting IFCâ€¦"}),r.jsx(ci,{variant:"determinate",value:Math.max(0,Math.min(100,we)),sx:{height:10,borderRadius:1}}),r.jsxs(U,{variant:"caption",sx:{mt:1,display:"block"},children:[we.toFixed(1),"%"]}),r.jsx("div",{style:{marginTop:12},children:r.jsx(se,{size:"small",variant:"outlined",color:"inherit",onClick:Ns,disabled:Ot,children:Ot?"Cancellingâ€¦":"Cancel"})})]})})}),te&&r.jsx(Sn,{nodeRef:Tr,handle:".explorer-header",bounds:"parent",children:r.jsxs(je,{ref:Tr,elevation:8,sx:{position:"fixed",top:120,right:30,width:ir.width,height:oe?"auto":ir.height,minWidth:280,minHeight:oe?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[r.jsxs(G,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[r.jsx(U,{variant:"subtitle1",children:"Model Explorer"}),r.jsxs(G,{children:[r.jsx(X,{size:"small",color:"inherit",onClick:Ts,title:oe?"Expand panel":"Minimize panel",children:oe?r.jsx(di,{}):r.jsx(jn,{})}),r.jsx(X,{size:"small",color:"inherit",onClick:Os,title:"Close Model Explorer",children:r.jsx(vn,{})})]})]}),!oe&&r.jsxs(G,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[r.jsx(se,{variant:"contained",size:"small",onClick:()=>i.current?.click(),disabled:!ye,children:"Open IFC / FRAG"}),r.jsx(Q,{title:"Open parametric filter",children:r.jsx("span",{children:r.jsx(se,{variant:"outlined",size:"small",onClick:()=>$e(!0),disabled:!ye,startIcon:r.jsx(ui,{}),children:"Filter"})})}),!1,r.jsx(U,{variant:"caption",color:"text.secondary"}),r.jsx("input",{ref:i,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:Fs})]}),r.jsxs(kn,{value:mt,onChange:(e,s)=>ss(s),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[r.jsx(Xt,{value:"models",label:"Models"}),r.jsx(Xt,{value:"properties",label:"Properties"}),r.jsx(Xt,{value:"tree",label:"Model Tree"})]}),r.jsx(G,{role:"tabpanel",hidden:mt!=="models",sx:{display:mt==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:r.jsx(G,{ref:jo,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!ye&&r.jsx(U,{variant:"body2",color:"text.secondary",children:"Initializing componentsâ€¦"})})}),r.jsx(G,{role:"tabpanel",hidden:mt!=="properties",sx:{display:mt==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsxs(kn,{value:ht,onChange:(e,s)=>Ao(s),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[r.jsx(Xt,{value:"favorites",label:`Favourites (${Qr.length})`}),r.jsx(Xt,{value:"all",label:`All (${le.length})`})]}),r.jsxs(G,{role:"tabpanel",hidden:ht!=="favorites",sx:{display:ht==="favorites"?"flex":"none",flexDirection:"column",flex:ht==="favorites"?1:0,minHeight:0},children:[Qr.length?r.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Qr.map(to)})}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:Ie.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),eo>0&&Ie.length>0&&r.jsx($t,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:eo===1?"1 favourite property is not available for this selection.":`${eo} favourite properties are not available for this selection.`})]}),r.jsxs(G,{role:"tabpanel",hidden:ht!=="all",sx:{display:ht==="all"?"flex":"none",flexDirection:"column",flex:ht==="all"?1:0,minHeight:0},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[r.jsx(Jt,{size:"small",fullWidth:!0,value:Po,onChange:e=>es(e.target.value),placeholder:"Search propertiesâ€¦",disabled:!le.length}),r.jsx(Q,{title:"Copy raw element JSON",children:r.jsx("span",{children:r.jsx(X,{size:"small",onClick:Cs,disabled:!q,color:"primary",children:r.jsx(fi,{fontSize:"small"})})})}),r.jsx(Q,{title:"Export properties",children:r.jsx("span",{children:r.jsx(se,{variant:"outlined",size:"small",startIcon:r.jsx(pi,{}),onClick:Is,disabled:!le.length&&!P.length,children:"Export"})})})]}),le.length?ws?rn.length?r.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:rn.map(to)})}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:`No properties matched "${xr}".`})}):r.jsxs(G,{sx:{position:"relative",flex:1,minHeight:200},children:[r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Zr.map(to)}),on>0&&r.jsx($t,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${Zr.length} properties. ${on} more not shown.`})]}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Setsâ€¦ breakdown."})})]})]})}),r.jsx(G,{role:"tabpanel",hidden:mt!=="tree",sx:{display:mt==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsx(Jt,{size:"small",fullWidth:!0,value:Pt,onChange:e=>ts(e.target.value),placeholder:"Search the model treeâ€¦",disabled:!P.length,sx:{flexShrink:0}}),r.jsxs(G,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[r.jsx(G,{ref:ar,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!ye||!P.length)&&r.jsx(G,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:ye?"Load a model to populate the full model tree.":"Viewer is initializing the model treeâ€¦"})})]})]})})]}),r.jsx(G,{onPointerDown:_s,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:te?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:gn,title:te?"Close Model Explorer":"Open Model Explorer",sx:{color:te?"white":"inherit"},children:r.jsx(xn,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:_e?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:un,title:_e?"Close AI Assistant":"Open AI Assistant",sx:{color:_e?"white":"inherit"},children:r.jsx(wn,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Be?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:mn,title:Be?"Close IDS Checker":"Open IDS Checker",sx:{color:Be?"white":"inherit"},children:r.jsx(In,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:st?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:dn,title:st?"Close IDS Creator":"Open IDS Creator",sx:{color:st?"white":"inherit"},children:r.jsx(Cn,{})})}),zt?r.jsx(Sn,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:r.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[r.jsxs(G,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[r.jsx(U,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(X,{size:"small",onClick:()=>qr(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(jn,{fontSize:"small"})}),r.jsx(X,{size:"small",onClick:()=>qr(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(vn,{fontSize:"small"})})]})]}),r.jsxs(G,{sx:{p:1.5},children:[r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Gs,disabled:!y,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(Pn,{fontSize:"small"})})}),r.jsx(Q,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:qs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:r.jsx(hi,{fontSize:"small"})})})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),r.jsxs(G,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[r.jsx(Q,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),r.jsx(Q,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),r.jsx(Q,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),r.jsx(Q,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),r.jsx(Q,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),r.jsx(Q,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(se,{size:"small",onClick:()=>xt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),r.jsx(Q,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:r.jsxs(se,{size:"small",onClick:()=>xt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[r.jsx(mi,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>so("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),r.jsx(Q,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>so("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),r.jsx(Q,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>so("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Ge.x.toFixed(1)]}),r.jsx(co,{value:Ge.x,onChange:(e,s)=>io("x",s),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Ge.y.toFixed(1)]}),r.jsx(co,{value:Ge.y,onChange:(e,s)=>io("y",s),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Ge.z.toFixed(1)]}),r.jsx(co,{value:Ge.z,onChange:(e,s)=>io("z",s),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Ks,sx:{border:"2px solid",borderColor:Wt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Wt?"warning.main":"white",color:Wt?"white":"warning.dark","&:hover":{backgroundColor:Wt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:r.jsx(gi,{fontSize:"small"})})}),r.jsx(Q,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Qs,disabled:!ne.x&&!ne.y&&!ne.z&&!Wt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(yi,{fontSize:"small"})})})]}),r.jsxs(G,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[r.jsx(Q,{title:Ut?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Ys,sx:{border:"2px solid",borderColor:Ut?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ut?"success.main":"white",color:Ut?"white":"success.dark","&:hover":{backgroundColor:Ut?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(bi,{fontSize:"small"})})}),Qo&&r.jsxs(U,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Qo," units"]})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>Oo("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:r.jsx(xi,{fontSize:"small"})})}),r.jsx(Q,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>Oo("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:r.jsx(En,{fontSize:"small"})})}),r.jsx(Q,{title:At?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Xs,sx:{border:"2px solid",borderColor:At?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:At?"warning.main":"white",color:At?"white":"warning.dark","&:hover":{backgroundColor:At?"warning.dark":"warning.light",borderColor:"warning.main",color:At?"white":"warning.dark"}},children:r.jsx(An,{fontSize:"small"})})}),r.jsx(Q,{title:Rt?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Js,sx:{border:"2px solid",borderColor:Rt?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Rt?"info.main":"white",color:Rt?"white":"info.dark","&:hover":{backgroundColor:Rt?"info.dark":"info.light",borderColor:"info.main",color:Rt?"white":"info.dark"}},children:r.jsx(Rn,{fontSize:"small"})})}),r.jsx(Q,{title:"Select all visible objects",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Zs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white",color:"success.main","&:hover":{backgroundColor:"success.light",borderColor:"success.main",color:"success.dark"}},children:r.jsx(En,{fontSize:"small"})})})]}),xe==="rectangle"&&r.jsx($t,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Grid Settings"}),r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1},children:[r.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:r.jsx(Q,{title:yt?"Hide Grid":"Show Grid",children:r.jsx(X,{size:"small",onClick:()=>{const e=!yt;gs(e),et.current&&(et.current.visible=e)},sx:{border:"1px solid",borderColor:yt?"primary.main":"rgba(0,0,0,0.23)",bgcolor:yt?"primary.main":"white",color:yt?"white":"primary.main","&:hover":{bgcolor:yt?"primary.dark":"rgba(0,0,0,0.04)"}},children:yt?r.jsx(wi,{fontSize:"small"}):r.jsx(Ii,{fontSize:"small"})})})}),r.jsxs(G,{sx:{px:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.7rem"},children:["Offset: ",Kr.toFixed(2),"m"]}),r.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:r.jsx("input",{type:"range",min:"-5",max:"5",step:"0.1",value:Kr,onChange:async e=>{const s=parseFloat(e.target.value);ys(s);const n=gr.find(o=>o.globalId===Yo);if(n&&et.current&&l.current){let o=0;for(const[w,m]of l.current.list)if(typeof m.getCoordinates=="function")try{const u=await m.getCoordinates();if(Array.isArray(u)&&u.length>=2){o=u[1];break}}catch{}const a=n.originalElevation+o+s,f=et.current.three;f&&f.position&&(f.position.y=a)}},style:{width:"100%",cursor:"pointer"}})})]}),gr.length>0&&r.jsxs(uo,{size:"small",fullWidth:!0,children:[r.jsx(Ci,{id:"grid-level-select-label",sx:{fontSize:"0.75rem"},children:"Align to Level"}),r.jsx(Si,{labelId:"grid-level-select-label",value:Yo,label:"Align to Level",onChange:async e=>{const s=e.target.value;Xo(s);const n=gr.find(o=>o.globalId===s);if(n&&et.current&&l.current){let o=0;for(const[w,m]of l.current.list)if(typeof m.getCoordinates=="function")try{const u=await m.getCoordinates();if(Array.isArray(u)&&u.length>=2){o=u[1];break}}catch{}const a=n.originalElevation+o+Kr,f=et.current.three;f&&f.position&&(f.position.y=a)}},sx:{fontSize:"0.75rem",height:"32px",".MuiSelect-select":{py:.5}},children:gr.map(e=>r.jsxs(Er,{value:e.globalId,sx:{fontSize:"0.75rem"},children:[e.name," (",e.elevation.toFixed(2),"m)"]},e.globalId))})]})]})]})]})," "]})}):null,r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:zt?"primary.main":"background.paper","&:hover":{bgcolor:zt?"primary.dark":"action.hover"}},children:r.jsx(X,{onClick:()=>qr(!zt),title:zt?"Close View Controls":"Open View Controls",sx:{color:zt?"white":"action.active"},children:r.jsx(Pn,{})})}),r.jsx(d.Suspense,{fallback:null,children:H&&r.jsx(Rl,{open:H,onClose:()=>$e(!1),viewerApi:kt.current??null})}),r.jsxs(fo,{open:as,onClose:Cr,fullWidth:!0,maxWidth:"sm",children:[r.jsx(po,{children:"Settings"}),r.jsx(ho,{dividers:!0,children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[r.jsxs(uo,{component:"fieldset",children:[r.jsx(Mn,{component:"legend",sx:{mb:1},children:"AI Provider"}),r.jsxs(zn,{value:me,onChange:e=>As(e.target.value),children:[r.jsx(Zt,{value:"gemini",control:r.jsx(Qt,{}),label:"Google Gemini"}),r.jsx(Zt,{value:"openai",control:r.jsx(Qt,{}),label:"OpenAI (ChatGPT)"}),r.jsx(Zt,{value:"disabled",control:r.jsx(Qt,{}),label:"Disabled (No AI)"})]})]}),me!=="disabled"&&r.jsxs(r.Fragment,{children:[r.jsx(Jt,{label:"API Key",type:Gr?"text":"password",value:Ze,onChange:e=>Br(e.target.value),fullWidth:!0,placeholder:`Enter your ${me==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:r.jsx(X,{onClick:()=>Do(!Gr),edge:"end",size:"small",children:Gr?r.jsx(An,{}):r.jsx(Rn,{})})},helperText:me==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),r.jsx(Jt,{select:!0,label:"Model",value:Bt,onChange:e=>ur(e.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:Qi(me).map(e=>r.jsx("option",{value:e,children:e},e))}),r.jsxs(G,{sx:{display:"flex",gap:1,alignItems:"center"},children:[r.jsx(se,{variant:"outlined",onClick:Rs,disabled:!Ze||$o,size:"small",children:$o?"Testing...":"Test Connection"}),No==="success"&&r.jsx(U,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ“ Connection successful"}),No==="error"&&r.jsx(U,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ— Connection failed"})]}),r.jsx($t,{severity:"info",variant:"outlined",children:r.jsxs(U,{variant:"body2",children:[r.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",me==="gemini"?"Google":"OpenAI","."]})})]})]})}),r.jsxs(mo,{children:[r.jsx(se,{onClick:Cr,children:"Cancel"}),r.jsx(se,{onClick:Es,variant:"contained",color:"primary",disabled:me!=="disabled"&&!Ze,children:"Save"})]})]}),r.jsxs(fo,{open:ls,onClose:fn,fullWidth:!0,maxWidth:"md",children:[r.jsx(po,{children:"About Savora Viewer"}),r.jsxs(ho,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[r.jsx(U,{variant:"h6",gutterBottom:!0,children:"Version 0.2.3 Preview"}),r.jsxs(U,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",r.jsx("br",{}),"For bug reporting and more information, visit our ",r.jsx(ji,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",r.jsx("br",{}),r.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),r.jsx(U,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Multiple format support (IFC, Fragments)",r.jsx("br",{}),"â€¢ Pan, zoom, rotate navigation",r.jsx("br",{}),"â€¢ Selection via point-and-click or rectangular region",r.jsx("br",{}),"â€¢ Orthogonal projection for accurate measurements",r.jsx("br",{}),"â€¢ View management (zoom to fit, home, cube orientation)",r.jsx("br",{}),"â€¢ Toggle performance stats",r.jsx("br",{}),"â€¢ Object measurement tools",r.jsx("br",{}),"â€¢ Clipping planes for sectional views"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Spatial and classification hierarchy navigation",r.jsx("br",{}),"â€¢ Tree-based model structure view",r.jsx("br",{}),"â€¢ Properties panel with expand/collapse",r.jsx("br",{}),"â€¢ Search and filter functionality",r.jsx("br",{}),"â€¢ Property export (CSV, JSON)",r.jsx("br",{}),"â€¢ Favorites system for quick access",r.jsx("br",{}),"â€¢ Parametric filtering with Ghost/Isolate modes"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Validate models against Information Delivery Specification (IDS)",r.jsx("br",{}),"â€¢ Load IDS files from local storage",r.jsx("br",{}),"â€¢ Visual feedback: green (pass) and red (fail) indicators",r.jsx("br",{}),"â€¢ Filter models by validation results",r.jsx("br",{}),"â€¢ Export validation reports"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Visual authoring tool for IDS specifications",r.jsx("br",{}),"â€¢ Capture and define validation rules",r.jsx("br",{}),"â€¢ Property picker for easy specification setup",r.jsx("br",{}),"â€¢ Save and load IDS files",r.jsx("br",{}),"â€¢ Integration with IDS Checker for immediate validation"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Natural language queries about model contents",r.jsx("br",{}),"â€¢ Intelligent model analysis and insights",r.jsx("br",{}),"â€¢ Context-aware responses based on selected elements",r.jsx("br",{}),"â€¢ Interactive chat interface",r.jsx("br",{}),"â€¢ Selection and filtering via conversation"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Floating toolbar for model operations",r.jsx("br",{}),"â€¢ Tooltips and keyboard shortcuts",r.jsx("br",{}),"â€¢ Collapsible side panels",r.jsx("br",{}),"â€¢ Responsive layout",r.jsx("br",{}),"â€¢ Dark theme optimized for long viewing sessions"]})]}),r.jsx(mo,{children:r.jsx(se,{onClick:fn,color:"primary",children:"Close"})})]}),r.jsxs(fo,{open:ms,onClose:cn,fullWidth:!0,maxWidth:"sm",children:[r.jsx(po,{children:"Export properties"}),r.jsxs(ho,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(uo,{component:"fieldset",variant:"standard",children:[r.jsx(Mn,{component:"legend",children:"Scope"}),r.jsxs(zn,{value:it,onChange:e=>Ho(e.target.value),children:[r.jsx(Zt,{value:"selected",control:r.jsx(Qt,{}),label:"Selected items",disabled:!le.length}),r.jsx(Zt,{value:"model",control:r.jsx(Qt,{}),label:"Specific model",disabled:!P.length})]})]}),r.jsx(vi,{in:it==="model",unmountOnExit:!0,children:r.jsx(Jt,{select:!0,fullWidth:!0,label:"Model",value:lt,onChange:e=>hr(e.target.value),disabled:!P.length,children:P.map(e=>r.jsx(Er,{value:e.id,children:e.label},e.id))})}),it==="selected"&&!le.length&&r.jsx($t,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Ko&&r.jsx($t,{severity:"error",variant:"outlined",children:Ko})]}),r.jsxs(mo,{children:[r.jsx(se,{onClick:cn,disabled:gt,children:"Cancel"}),r.jsx(se,{variant:"contained",onClick:Ss,disabled:gt||it==="selected"&&!le.length||it==="model"&&!lt,children:gt?"Exportingâ€¦":"Export CSV"})]})]}),r.jsxs(d.Suspense,{fallback:null,children:[r.jsx(Pl,{isOpen:Be,onOpen:zs,onClose:Ds,viewerApi:Ne,hasModel:P.length>0,expandSignal:ps}),r.jsx(El,{isOpen:st,onClose:()=>_o(!1),viewerApi:Ne,selectedItemData:q,onValidate:$s}),r.jsx(Al,{isOpen:pr,onClose:()=>Bo(!1),viewerApi:kt.current}),r.jsx(kl,{getModelDataForAI:Bs,isOpen:_e,onOpen:vs,onClose:ks,expandSignal:is,onRequestSelection:Vs,onOpenSettings:pn,configVersion:cs})]}),r.jsxs(ki,{open:!!cr,onClose:Hs,anchorReference:"anchorPosition",anchorPosition:cr?{top:cr.mouseY,left:cr.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[r.jsx(Er,{onClick:Ws,disabled:k.length===0,children:"Hide selected element"}),r.jsx(Er,{onClick:Us,children:"Reset hidden elements"})]})]})};function Wn(t,i=2e3){try{if(t==null)return"null";const c=typeof t=="string"?t:JSON.stringify(t,null,2);return c?c.length<=i?c:`${c.slice(0,i)}
... [truncated ${c.length-i} chars]`:""}catch{return String(t)}}Pi.createRoot(document.getElementById("root")).render(r.jsx(jt.StrictMode,{children:r.jsx(Bl,{})}));export{rl as a,Cl as b,gl as c,yl as d,Jl as g,bo as i,Ji as l,Xl as p,el as s,jl as u};
