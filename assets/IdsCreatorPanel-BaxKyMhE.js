import{cm as a,cn as ve,co as e,cF as Ce,cD as Ie,cp as u,cq as p,cP as G,cs as b,dy as ke,dz as we,dh as qe,cG as De,cH as Pe,cI as Re,cy as q,dA as Oe,dj as T,dk as U,dB as Ae,dm as V,dC as H,dr as ie,cQ as Ne,dD as ze,dE as $e,c_ as Le,c$ as Ee,d0 as Fe,d1 as J,du as _,dv as Y,d6 as j,d7 as We,dF as Be}from"./vendor-DcICA_3z.js";import{g as se,p as Me}from"./index-LLVaTGtV.js";import"./thatopen-vendor-CcC7XCOM.js";import"./three-vendor-BFJjymLZ.js";const Je=({isOpen:ae,onClose:oe,viewerApi:Ge,selectedItemData:D,onValidate:P})=>{const X=a.useRef(null),Q=a.useRef(null),[C,ce]=a.useState(!1),[y,R]=a.useState([]),[o,O]=a.useState(null),[I,K]=a.useState("new-project.ids"),m=a.useCallback((t,l)=>{R(r=>r.map(n=>n.id===t?l(n):n))},[]),de=a.useCallback(t=>{R(l=>{const r=l.filter(n=>n.id!==t);return O(n=>n&&n!==t?n:r[0]?.id??null),r})},[]),v=a.useMemo(()=>{if(!D)return null;try{const t=new WeakSet;return JSON.stringify(D,(l,r)=>{if(typeof r=="bigint")return r.toString();if(typeof r=="object"&&r!==null){if(t.has(r))return"[Circular]";t.add(r)}return r},2)}catch(t){return console.warn("Failed to stringify selected item data for IDS creator inspector",t),"Unable to display selected element properties."}},[D]),d=a.useMemo(()=>{if(!v||v.startsWith("Unable"))return null;try{return JSON.parse(v)}catch{return null}},[v]),Z=a.useCallback(t=>{const l={};if(!t||typeof t!="object")return{};const r=(s,c)=>{const f=typeof s=="string"?s:s?.toString?.()==="[object Object]"?null:String(s);!f||f==="[object Object]"||f==="null"||f==="undefined"||(l[f]||(l[f]=new Set),Array.isArray(c)&&c.forEach(h=>h&&l[f].add(String(h))))},n=s=>{if(!s)return null;if(typeof s=="string")return s;if(typeof s=="number")return String(s);if(typeof s=="object"){if(s.value!==void 0)return n(s.value);if(s.Value!==void 0)return n(s.Value)}return null};try{const s=t.IsDefinedBy||t.isDefinedBy;if(Array.isArray(s))for(const c of s){if(!c||typeof c!="object")continue;const f=n(c.Name)||n(c.name);if(!f)continue;const h=c.HasProperties||c.hasProperties;if(!Array.isArray(h))continue;const L=[];for(const E of h){if(!E||typeof E!="object")continue;const ne=n(E.Name)||n(E.name);ne&&L.push(ne)}L.length>0&&r(f,L)}}catch(s){console.error("Error extracting property sets from IsDefinedBy:",s)}const i={};for(const[s,c]of Object.entries(l))s&&s!=="[object Object]"&&(i[s]=Array.from(c).sort());return i},[]),x=a.useMemo(()=>y.find(t=>t.id===o),[y,o]),ue=a.useCallback(t=>{if(!o)return;const l=t.target.value;m(o,r=>({...r,name:l}))},[o,m]),ee=a.useCallback(t=>{if(o){if(!d){alert("Select an element in the viewer first to capture its data.");return}m(o,l=>{let r=d;try{r=JSON.parse(JSON.stringify(d))}catch{r=d}let n=d?.ifcClass;!n&&d?._category?.value&&(n=d._category.value),!n&&d?.constructor?.name&&(n=d.constructor.name);const i={capturedAt:new Date().toISOString(),sourceGlobalId:d?.GlobalId||d?._guid?.value||"unknown",ifcClass:n,sample:r};return t==="applicability"?{...l,applicability:[...l.applicability,i]}:{...l,requirements:[...l.requirements,i]}})}},[o,d,m]),pe=a.useCallback((t,l)=>{o&&m(o,r=>{if(t==="applicability"){const i=[...r.applicability];return i.splice(l,1),{...r,applicability:i}}const n=[...r.requirements];return n.splice(l,1),{...r,requirements:n}})},[o,m]),xe=()=>{const t=`spec-${Date.now()}`,l={id:t,name:"New Specification",description:"",applicability:[],requirements:[]};R(r=>[...r,l]),O(t)},[fe,k]=a.useState(!1),[F,te]=a.useState(null),[g,A]=a.useState(null),[w,N]=a.useState(null),[z,re]=a.useState({}),[W,B]=a.useState("equals"),[M,$]=a.useState("");a.useCallback(t=>{const l=x?.applicability?.[t]?.sample;if(!l)return;const r=Z(l);re(r),te(t),A(Object.keys(r)[0]??null),N(Object.keys(r)[0]?r[Object.keys(r)[0]][0]??null:null),$(""),k(!0)},[x]);const me=a.useCallback(()=>{if(!o||F==null||!g||!w)return;const t=y.find(i=>i.id===o);if(!t)return;const l=t.applicability?.[F]?.sample;let r;try{const i=l?.IsDefinedBy||l?.isDefinedBy;if(Array.isArray(i)){for(const s of i)if((s?.Name?.value||s?.name?.value)===g){const f=s.HasProperties||s.hasProperties;if(Array.isArray(f)){for(const h of f)if((h?.Name?.value||h?.name?.value)===w){r=h?.NominalValue?.value||h?.nominalValue?.value||h?.NominalValue||h?.nominalValue;break}}break}}}catch(i){console.error("Error extracting property value:",i)}const n={id:`rule-${Date.now()}`,propertyPath:`${g}.${w}`,operator:W,value:M||(r!=null?String(r):""),sample:l??null};m(o,i=>{if((S.current??null)!=null){const s=S.current,c=[...i.requirements];return c[s]=n,S.current=null,{...i,requirements:c}}return{...i,requirements:[...i.requirements,n]}}),k(!1)},[o,F,g,w,W,M,y,m]),S=ve.useRef(null),le=a.useCallback(t=>{if(!t)return"Captured element";const l=t.sample??t,r=t.sourceGlobalId||l?.GlobalId||l?._guid||l?.guid||l?.Tag&&l.Tag.value||"unknown",n=t.ifcClass||l&&l._category&&l._category.value||l?.ifcClass||"IfcElement",i=l&&(l.Name&&l.Name.value||l.ObjectType||l.Name)||void 0;return r!=="unknown"?`${n} (${r})`:i?`${n} â€” ${String(i).substring(0,40)}`:`${n} (captured)`},[]),he=a.useCallback(t=>{o&&m(o,l=>{const r=l.applicability?.[t]??null;if(!r)return l;const n=JSON.parse(JSON.stringify(r));return{...l,requirements:[...l.requirements,n]}})},[o,m]),ye=a.useCallback(t=>{if(!x)return;const l=x.requirements[t];let r=null;if(l&&l.sample){const s=x.applicability.findIndex(c=>c&&c.sourceGlobalId===l.sourceGlobalId);r=s>=0?s:null}S.current=t,te(r);const n=l?.sample??(r!=null?x.applicability?.[r]?.sample:null),i=n?Z(n):{};if(re(i),l&&l.propertyPath){const[s,c]=String(l.propertyPath).split(".");A(s??Object.keys(i)[0]??null),N(c??(s?i[s]?.[0]??null:Object.values(i)[0]?.[0]??null)),B(l.operator??"equals"),$(l.value??"")}else A(Object.keys(i)[0]??null),N(Object.keys(i)[0]?i[Object.keys(i)[0]][0]??null:null),B("equals"),$("");k(!0)},[x]),be=a.useCallback(t=>{o&&m(o,l=>{const r=[...l.requirements];return r.splice(t,1),{...l,requirements:r}})},[o,m]),je=a.useCallback(()=>{try{const t=se(y),l=new Blob([t],{type:"application/xml"}),r=URL.createObjectURL(l),n=document.createElement("a");n.href=r,n.download=I.endsWith(".ids")?I:`${I}.ids`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(r)}catch(t){console.error("Failed to generate or save IDS file:",t),alert("Error: Could not save IDS file. See console for details.")}},[y,I]),ge=a.useCallback(()=>{if(P){if(y.length===0){alert("Please add at least one specification before validating.");return}try{const t=se(y);P(t)}catch(t){console.error("Failed to generate IDS XML for validation:",t),alert("Error: Could not generate IDS XML. See console for details.")}}},[y,P]),Se=a.useCallback(t=>{const l=t.target.files?.[0];if(!l)return;K(l.name);const r=new FileReader;r.onload=n=>{try{const i=n.target?.result,s=Me(i);R(s),O(s[0]?.id||null)}catch(i){console.error("Failed to parse IDS file:",i),alert("Error: Could not parse IDS file. Ensure it is a valid .ids XML file.")}},r.readAsText(l),t.target.value=""},[]);return ae?e.jsx(Ce,{nodeRef:X,handle:".ids-creator-header",bounds:"parent",children:e.jsxs(Ie,{ref:X,elevation:8,sx:{position:"fixed",top:140,left:40,width:900,height:C?"auto":600,minWidth:400,minHeight:C?56:300,maxWidth:"90vw",maxHeight:"80vh",display:"flex",flexDirection:"column",zIndex:1850,boxSizing:"border-box",overflow:"hidden"},children:[e.jsxs(u,{className:"ids-creator-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"secondary.main",color:"white",cursor:"move",gap:2},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[e.jsx(p,{variant:"subtitle1",sx:{whiteSpace:"nowrap"},children:"IDS Creator:"}),e.jsx(G,{value:I.replace(/\.ids$/,""),onChange:t=>K(t.target.value),variant:"outlined",size:"small",placeholder:"filename",sx:{flex:1,maxWidth:300,"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255, 255, 255, 0.3)"},"&:hover fieldset":{borderColor:"rgba(255, 255, 255, 0.5)"},"&.Mui-focused fieldset":{borderColor:"rgba(255, 255, 255, 0.7)"}},"& .MuiInputBase-input":{py:.75}}}),e.jsx(p,{variant:"body2",sx:{color:"rgba(255, 255, 255, 0.7)"},children:".ids"})]}),e.jsxs(u,{children:[e.jsx("input",{ref:Q,type:"file",accept:".ids, .xml",style:{display:"none"},onChange:Se}),e.jsx(b,{size:"small",color:"inherit",title:"Load IDS File",onClick:()=>Q.current?.click(),children:e.jsx(ke,{})}),e.jsx(b,{size:"small",color:"inherit",title:"Save IDS File",onClick:je,children:e.jsx(we,{})}),P&&e.jsx(b,{size:"small",color:"inherit",title:"Validate in IDS Checker",onClick:ge,disabled:y.length===0,children:e.jsx(qe,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:()=>ce(t=>!t),title:C?"Expand panel":"Minimize panel",children:C?e.jsx(De,{}):e.jsx(Pe,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:oe,title:"Close IDS Creator",children:e.jsx(Re,{})})]})]}),!C&&e.jsxs(u,{sx:{flex:1,display:"flex",minHeight:0},children:[e.jsxs(u,{sx:{width:250,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column"},children:[e.jsx(u,{sx:{p:1,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(q,{startIcon:e.jsx(Oe,{}),fullWidth:!0,variant:"outlined",onClick:xe,children:"Add Specification"})}),e.jsx(T,{sx:{overflowY:"auto",flex:1},children:y.map(t=>e.jsx(U,{disablePadding:!0,secondaryAction:e.jsx(b,{edge:"end",size:"small",title:"Delete specification",onClick:l=>{l.stopPropagation(),de(t.id)},children:e.jsx(H,{fontSize:"small"})}),children:e.jsx(Ae,{selected:t.id===o,onClick:()=>O(t.id),children:e.jsx(V,{primary:t.name})})},t.id))})]}),e.jsx(u,{sx:{flex:1,p:2,overflowY:"auto",display:"flex",flexDirection:"column",gap:2},children:x?e.jsxs(e.Fragment,{children:[e.jsx(G,{label:"Specification Name",value:x.name,onChange:ue,variant:"outlined",size:"small"}),e.jsx(ie,{}),e.jsx(p,{variant:"h6",children:"Applicability (Which elements?)"}),e.jsxs(u,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(p,{variant:"body2",color:"text.secondary",children:"Capture one or more example elements from the viewer to describe what this specification applies to."}),e.jsxs(u,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(q,{size:"small",variant:"outlined",onClick:()=>ee("applicability"),disabled:!d,children:"Use current selection"}),e.jsx(p,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:d?"Current viewer selection will be stored as a template.":"Select an element to enable capture."})]}),x.applicability.length?e.jsx(T,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:x.applicability.map((t,l)=>{const r=t;r?.ifcClass?`${r.ifcClass}${r.sourceGlobalId||"unknown"}`:r?.sourceGlobalId;const n=r?.capturedAt?new Date(r.capturedAt).toLocaleString():"";return e.jsx(U,{secondaryAction:e.jsxs(u,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(b,{size:"small",title:"Copy to requirements",onClick:()=>he(l),children:e.jsx(Ne,{fontSize:"small"})}),e.jsx(b,{edge:"end",size:"small",title:"Remove captured applicability",onClick:()=>pe("applicability",l),children:e.jsx(H,{fontSize:"small"})})]}),children:e.jsx(V,{primary:le(r),secondary:n?`Captured ${n}`:void 0})},`${r?.sourceGlobalId||"entry"}-${l}`)})}):e.jsx(p,{variant:"body2",color:"text.secondary",children:"No applicability examples captured yet."})]}),e.jsx(ie,{}),e.jsx(p,{variant:"h6",children:"Requirements (What must be true?)"}),e.jsxs(u,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(p,{variant:"body2",color:"text.secondary",children:"Capture the same or other elements to store property snapshots you want to enforce as requirements."}),e.jsxs(u,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(q,{size:"small",variant:"outlined",onClick:()=>ee("requirements"),disabled:!d,children:"Use current selection"}),e.jsx(p,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:d?"Snapshot will be added to requirements.":"Select an element to enable capture."})]}),x.requirements.length?e.jsx(T,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:x.requirements.map((t,l)=>{const r=t,n=le(r),i=r?.capturedAt?new Date(r.capturedAt).toLocaleString():"";return e.jsxs(U,{children:[e.jsx(V,{primary:r.propertyPath?`${r.propertyPath} ${r.operator?`(${r.operator})`:""}`:n,secondary:r.propertyPath?`Expected: ${r.value??"(any)"}${i?` â€” captured ${i}`:""}`:i?`Captured ${i}`:void 0}),e.jsxs(ze,{children:[e.jsx(b,{size:"small",title:"Edit requirement",onClick:()=>ye(l),children:e.jsx($e,{fontSize:"small"})}),e.jsx(b,{size:"small",title:"Remove requirement",onClick:()=>be(l),children:e.jsx(H,{fontSize:"small"})})]})]},`${r?.id||r?.sourceGlobalId||"req"}-${l}`)})}):e.jsx(p,{variant:"body2",color:"text.secondary",children:"No requirement snapshots captured yet."})]})]}):e.jsx(u,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(p,{color:"text.secondary",children:"Load or create a specification to begin."})})}),e.jsxs(u,{sx:{width:300,borderLeft:"1px solid",borderColor:"divider",p:1,overflowY:"auto"},children:[e.jsx(p,{variant:"subtitle2",sx:{mb:1},children:"Model Inspector"}),v?e.jsx("pre",{style:{fontSize:"0.75rem",margin:0,whiteSpace:"pre-wrap",wordBreak:"break-all"},children:v}):D?e.jsx(p,{variant:"body2",color:"text.secondary",children:"Unable to display selected element properties."}):e.jsx(p,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to inspect its properties."})]})]}),e.jsxs(Le,{open:fe,onClose:()=>k(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ee,{children:S.current!=null?"Edit Requirement":"Create Requirement"}),e.jsxs(Fe,{children:[e.jsxs(u,{sx:{display:"flex",gap:2,mt:1},children:[e.jsxs(J,{fullWidth:!0,children:[e.jsx(_,{id:"pset-label",children:"Property Set"}),e.jsx(Y,{labelId:"pset-label",value:g??"",label:"Property Set",onChange:t=>A(String(t.target.value)||null),children:Object.keys(z).length?Object.keys(z).map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]}),e.jsxs(J,{fullWidth:!0,children:[e.jsx(_,{id:"prop-label",children:"Property"}),e.jsx(Y,{labelId:"prop-label",value:w??"",label:"Property",onChange:t=>N(String(t.target.value)||null),children:g&&z[g]?z[g].map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]})]}),e.jsxs(u,{sx:{display:"flex",gap:2,mt:2},children:[e.jsxs(J,{fullWidth:!0,children:[e.jsx(_,{id:"op-label",children:"Operator"}),e.jsxs(Y,{labelId:"op-label",value:W,label:"Operator",onChange:t=>B(String(t.target.value)),children:[e.jsx(j,{value:"exists",children:"exists"}),e.jsx(j,{value:"equals",children:"equals"}),e.jsx(j,{value:"not-equals",children:"not equals"}),e.jsx(j,{value:"contains",children:"contains"}),e.jsx(j,{value:"matches",children:"matches (regex)"})]})]}),e.jsx(G,{fullWidth:!0,label:"Value (optional)",value:M,onChange:t=>$(t.target.value)})]})]}),e.jsxs(We,{children:[e.jsx(q,{onClick:()=>{k(!1),S.current=null},children:"Cancel"}),e.jsx(q,{variant:"contained",onClick:me,startIcon:e.jsx(Be,{}),children:S.current!=null?"Save":"Create"})]})]})]})}):null};export{Je as default};
