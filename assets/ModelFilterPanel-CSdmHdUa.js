import{cm as n,co as t,cH as ge,cF as me,cp as d,dK as q,cq as b,cs as H,cI as xe,cJ as pe,cK as ye,cO as Ie,d4 as w,dz as U,dA as A,dc as K,dL as be,ds as je,dn as Fe,dw as Y,dM as Ce,cP as J,dj as Q,dN as Pe,dO as X,cG as Se,cA as Z,dB as Be}from"./vendor-NpE_gqg9.js";const z="GlobalId",ve=["equals","contains","matches","greater-than","less-than","not-equals"],Te=["IfcWall","IfcColumn","IfcBeam","IfcSlab","IfcDoor","IfcWindow","IfcStair","IfcRoof","IfcSpace"];function ze({open:P,onClose:ee,viewerApi:s}){const M=n.useRef(null),[m,te]=n.useState(!1),[f,se]=n.useState([]),[x,$]=n.useState(z),[S,le]=n.useState("equals"),[j,ae]=n.useState(""),[F,re]=n.useState("ghost"),[oe]=n.useState(Te),[ne,N]=n.useState([]),[_,k]=n.useState(!1),[p,B]=n.useState(!1),[C,v]=n.useState(null),[E,O]=n.useState(!1),[h,G]=n.useState(null),[V,W]=n.useState(""),ie=e=>e.GlobalId&&typeof e.GlobalId=="object"&&"value"in e.GlobalId?e.GlobalId.value:e._guid&&typeof e._guid=="object"&&"value"in e._guid?e._guid.value:null,ce=(e,l)=>{const r=a=>a&&typeof a=="object"&&"value"in a?a.value:a,o=l.split(".");if(o.length===1)return r(e[o[0]]);const[i,c]=o,u=e.IsDefinedBy;if(Array.isArray(u))for(const a of u){if(r(a.Name)!==i)continue;const I=a.HasProperties;if(Array.isArray(I)){for(const y of I)if(r(y.Name)===c)return r(y.NominalValue)}}},ue=(e,l,r)=>{if(e==null)return!1;const o=String(e),i=String(r);switch(l){case"equals":return o===i;case"not-equals":return o!==i;case"contains":return o.toLowerCase().includes(i.toLowerCase());case"matches":try{return new RegExp(i).test(o)}catch{return!1}case"greater-than":return parseFloat(o)>parseFloat(i);case"less-than":return parseFloat(o)<parseFloat(i);default:return!1}},T=(e,l="",r=3,o=0)=>{if(o>=r)return[];const i=[];for(const c in e){if(!e.hasOwnProperty(c)||c.startsWith("_"))continue;const u=l?`${l}.${c}`:c,a=e[c];Array.isArray(a)&&a.length>0&&typeof a[0]=="object"?i.push(...T(a[0],u,r,o+1)):a&&typeof a=="object"&&!Array.isArray(a)?i.push(...T(a,u,r,o+1)):a!=null&&typeof a!="function"&&i.push(u)}return i},R=n.useCallback(async()=>{if(!(!s||!s.getItemsByCategory||!s.getItemsDataByModel)){k(!0);try{const e=f.length>0?f.map(g=>new RegExp(`^${g}$`,"i")):[/.*/],l=await s.getItemsByCategory(e),[r,o]=Object.entries(l)[0]||[null,[]];if(!r||o.length===0){N([]);return}const i=Math.min(10,o.length),c=o.slice(0,i),u={attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasAssignments:{attributes:!0,relations:!1}}},a=await s.getItemsDataByModel(r,c,u);console.log(`âœ… [Property Discovery] Loaded ${a.length} samples`);const I=new Set;for(const g of a)T(g).forEach(D=>{const he=D.startsWith("IsDefinedBy.")?D.substring(12):D;I.add(he)});const y=Array.from(I).filter(g=>!g.startsWith("_")).sort();N(y)}catch(e){console.error("Property discovery failed:",e)}finally{k(!1)}}},[s,f]);n.useEffect(()=>{P&&!m&&R()},[P,f,R,m]);const de=n.useCallback(async()=>{if(!s||!s.getItemsByCategory||!s.getItemsDataByModel){alert("âŒ Viewer API not ready");return}if(!x||!j){alert("âš ï¸ Please select a property and enter a value");return}B(!0),v({current:0,total:1});const e=[];try{let l;if(f.length>0){const c=f.map(u=>new RegExp(`^${u}$`,"i"));l=await s.getItemsByCategory(c)}else l=await s.getItemsByCategory([/.*/]);const r=Object.values(l).reduce((c,u)=>c+u.length,0);if(console.log(`ðŸ” [Filter] Found ${r} items to check`),r===0){alert("âš ï¸ No elements found matching the category filter"),B(!1);return}let o=0;const i=x.includes("Pset_")||x.includes(".")?{attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}}:{attributesDefault:!1,attributes:["Name","GlobalId"]};for(const[c,u]of Object.entries(l)){if(u.length===0)continue;if(console.log(`ðŸ” [Filter] Processing model ${c}: ${u.length} elements`),!s.getItemsDataByModel){console.error("getItemsDataByModel not available");continue}const a=await s.getItemsDataByModel(c,u,i);console.log(`âœ… [Filter] Loaded ${a.length} items from model ${c}`);let I=0;for(const y of a){const g=ie(y);if(!g)continue;const L=ce(y,x);ue(L,S,j)&&e.push(g),o++,o%100===0&&v({current:o,total:r})}}G(e),W(`${e.length} of ${r} elements`),e.length===0?alert("â„¹ï¸ No elements matched the filter criteria"):e.length===r&&alert(`âœ… All ${r} elements matched the filter!

Tip: Try a different value or use "not equals" operator to see some elements filtered out.`)}catch(l){console.error("Filter failed:",l),alert(`âŒ Filter failed: ${l.message}`)}finally{B(!1),v(null)}},[s,x,S,j,f]);n.useEffect(()=>{let e=!0;const l=async()=>{if(!(!s||!h||h.length===0||p))try{console.log(`[Filter] Applying ${F} mode...`),s.clearColors&&await s.clearColors(),s.clearIsolation&&await s.clearIsolation(),F==="ghost"?typeof s.ghost=="function"?await s.ghost(h):console.warn("Ghost mode not supported by viewer API"):await s.isolate(h),typeof s.fitViewTo=="function"&&await s.fitViewTo(h),e&&O(!0)}catch(r){console.error("[Filter] Failed to apply filter to view:",r)}};return h&&h.length>0&&!p&&l(),()=>{e=!1}},[h,s,F,p,f]);const fe=n.useCallback(async()=>{if(s)try{s.clearIsolation&&(await s.clearIsolation(),console.log("ðŸ”„ [Filter] Cleared isolation")),s.clearColors&&(await s.clearColors(),console.log("ðŸ”„ [Filter] Cleared colors")),O(!1),G([]),W(""),console.log("âœ… [Filter] Filter cleared")}catch(e){console.error("âŒ [Filter] Failed to clear filter:",e)}},[s]);return P?t.jsx(ge,{nodeRef:M,handle:".filter-header",bounds:"parent",children:t.jsxs(me,{ref:M,elevation:8,sx:{position:"fixed",top:120,left:30,width:420,maxHeight:m?"auto":"80vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[t.jsxs(d,{className:"filter-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[t.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(q,{}),t.jsx(b,{variant:"subtitle1",children:"Parametric Filter"})]}),t.jsxs(d,{children:[t.jsx(H,{size:"small",color:"inherit",onClick:()=>te(!m),title:m?"Expand panel":"Minimize panel",children:m?t.jsx(xe,{}):t.jsx(pe,{})}),t.jsx(H,{size:"small",color:"inherit",onClick:ee,title:"Close",children:t.jsx(ye,{})})]})]}),!m&&t.jsxs(d,{sx:{p:2,overflowY:"auto",flex:1},children:[E&&V&&t.jsxs(Ie,{severity:"success",sx:{mb:2},children:[t.jsx("strong",{children:"Active Filter:"})," ",V," match"]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"1. Category Filter (Optional)"}),t.jsxs(w,{size:"small",fullWidth:!0,children:[t.jsx(U,{children:"IFC Types"}),t.jsx(A,{multiple:!0,value:f,onChange:e=>se(typeof e.target.value=="string"?[]:e.target.value),renderValue:e=>t.jsx(d,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.length===0?t.jsx("em",{children:"All types"}):e.map(l=>t.jsx(Fe,{label:l,size:"small"},l))}),MenuProps:{style:{zIndex:1900}},children:oe.map(e=>t.jsxs(K,{value:e,children:[t.jsx(be,{checked:f.indexOf(e)>-1}),t.jsx(je,{primary:e})]},e))})]})]}),t.jsx(Y,{sx:{my:2}}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"2. Define Filter"}),t.jsx(Ce,{fullWidth:!0,size:"small",value:x,onChange:(e,l)=>$(l||z),onInputChange:(e,l)=>$(l||z),options:ne,freeSolo:!0,loading:_,componentsProps:{popper:{style:{zIndex:1900}}},renderInput:e=>t.jsx(J,{...e,label:"Property Path",helperText:"e.g., NV_PSteel.NV_STATUS or Pset_WallCommon.FireRating",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[_?t.jsx(Q,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),sx:{mb:2}}),t.jsxs(d,{sx:{display:"flex",gap:1,mb:2},children:[t.jsxs(w,{size:"small",sx:{minWidth:150},children:[t.jsx(U,{children:"Operator"}),t.jsx(A,{value:S,onChange:e=>le(e.target.value),label:"Operator",MenuProps:{style:{zIndex:1900}},children:ve.map(e=>t.jsx(K,{value:e,children:e},e))})]}),t.jsx(J,{size:"small",fullWidth:!0,label:"Value",value:j,onChange:e=>ae(e.target.value),placeholder:"Enter value..."})]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"caption",color:"text.secondary",gutterBottom:!0,sx:{display:"block"},children:"Filter Mode:"}),t.jsxs(Pe,{value:F,exclusive:!0,onChange:(e,l)=>{l!==null&&re(l)},size:"small",fullWidth:!0,children:[t.jsx(X,{value:"ghost",children:"Ghost (Transparent)"}),t.jsx(X,{value:"isolate",children:"Isolate (Hide)"})]}),t.jsx(b,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:F==="ghost"?"Makes non-matching elements transparent":"Hides non-matching elements completely"})]})]}),t.jsx(Y,{sx:{my:2}}),p&&C&&t.jsxs(d,{sx:{mb:2},children:[t.jsxs(b,{variant:"caption",color:"text.secondary",children:["Filtering: ",C.current," / ",C.total]}),t.jsx(Se,{variant:"determinate",value:C.current/C.total*100})]}),t.jsxs(d,{sx:{display:"flex",gap:1},children:[t.jsx(Z,{variant:"contained",onClick:de,disabled:p||!x||!j,startIcon:p?t.jsx(Q,{size:20}):t.jsx(q,{}),fullWidth:!0,children:p?"Filtering...":"Apply Filter"}),E&&t.jsx(Z,{variant:"outlined",onClick:fe,startIcon:t.jsx(Be,{}),children:"Clear"})]})]})]})}):null}export{ze as default};
