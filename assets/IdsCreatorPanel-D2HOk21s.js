import{cm as o,cn as Ce,co as e,cH as Ie,cF as ke,cp as u,cq as f,cP as G,cs as j,dE as Ne,dF as we,dr as Pe,cI as De,cJ as Ae,cK as qe,cA as w,dG as Re,dt as H,du as T,dH as Oe,dw as J,dI as U,dA as se,cQ as ze,dJ as $e,dK as Ve,d7 as Be,d8 as Ee,d9 as Le,d3 as _,d4 as Y,d5 as X,d6 as g,dL as Me,de as We,dM as Fe}from"./vendor-DY-rktTO.js";import{g as ae,p as Ge}from"./index-D65qpV-J.js";import"./thatopen-vendor-C9781ij5.js";import"./three-vendor-kQcUiZz9.js";const Ye=({isOpen:oe,onClose:ce,viewerApi:He,selectedItemData:P,onValidate:D})=>{const K=o.useRef(null),Q=o.useRef(null),[I,de]=o.useState(!1),[y,A]=o.useState([]),[d,q]=o.useState(null),[k,Z]=o.useState("new-project.ids"),h=o.useCallback((t,r)=>{A(n=>n.map(l=>l.id===t?r(l):l))},[]),ue=o.useCallback(t=>{A(r=>{const n=r.filter(l=>l.id!==t);return q(l=>l&&l!==t?l:n[0]?.id??null),n})},[]),R=o.useMemo(()=>{if(!P)return null;try{const t={...P};["geometry","expressID","bits","handle","buffer"].forEach(l=>delete t[l]);const n=new WeakSet;return JSON.stringify(t,(l,i)=>{if(typeof i=="bigint")return i.toString();if(typeof i=="object"&&i!==null){if(n.has(i))return"[Circular]";n.add(i)}return typeof i=="string"&&i.length>1e3?i.substring(0,1e3)+"... (truncated)":i},2)}catch(t){return console.warn("Failed to stringify selected item data for IDS creator inspector",t),"Unable to display selected element properties (Data too large)."}},[P]),p=o.useMemo(()=>{if(!R||R.startsWith("Unable"))return null;try{return JSON.parse(R)}catch{return null}},[R]),O=o.useMemo(()=>{if(!p)return[];const t=[],r=l=>l==null?"—":typeof l=="object"?"value"in l?r(l.value):"Value"in l?r(l.Value):l instanceof Date?l.toLocaleString():Array.isArray(l)?`[${l.length} items]`:"[Object]":String(l),n=p.IsDefinedBy||p.isDefinedBy;return Array.isArray(n)&&n.forEach(l=>{if(!l||typeof l!="object")return;const i=l.Name?.value||l.name?.value||l.Name||l.name||l.type;if(!i||typeof i!="string")return;const s=l.HasProperties||l.hasProperties||l.properties||l.Properties;Array.isArray(s)&&s.forEach(a=>{if(!a||typeof a!="object")return;const c=a.Name?.value||a.name?.value||a.Name||a.name;if(!c||typeof c!="string")return;const x=a.NominalValue?.value||a.nominalValue?.value||a.NominalValue||a.nominalValue||a.value||a.Value,C=`${i} / ${c}`;t.push({label:C,value:r(x),psetName:i})})}),t.sort((l,i)=>l.psetName!==i.psetName?l.psetName.localeCompare(i.psetName):l.label.localeCompare(i.label)),t},[p]),ee=o.useCallback(t=>{const r={};if(!t||typeof t!="object")return{};const n=(s,a)=>{const c=typeof s=="string"?s:s?.toString?.()==="[object Object]"?null:String(s);!c||c==="[object Object]"||c==="null"||c==="undefined"||(r[c]||(r[c]=new Set),Array.isArray(a)&&a.forEach(x=>x&&r[c].add(String(x))))},l=s=>{if(!s)return null;if(typeof s=="string")return s;if(typeof s=="number")return String(s);if(typeof s=="object"){if(s.value!==void 0)return l(s.value);if(s.Value!==void 0)return l(s.Value)}return null};try{const s=t.IsDefinedBy||t.isDefinedBy;if(Array.isArray(s))for(const a of s){if(!a||typeof a!="object")continue;const c=l(a.Name)||l(a.name);if(!c)continue;const x=a.HasProperties||a.hasProperties;if(!Array.isArray(x))continue;const C=[];for(const L of x){if(!L||typeof L!="object")continue;const ie=l(L.Name)||l(L.name);ie&&C.push(ie)}C.length>0&&n(c,C)}}catch(s){console.error("Error extracting property sets from IsDefinedBy:",s)}const i={};for(const[s,a]of Object.entries(r))s&&s!=="[object Object]"&&(i[s]=Array.from(a).sort());return i},[]),m=o.useMemo(()=>y.find(t=>t.id===d),[y,d]),pe=o.useCallback(t=>{if(!d)return;const r=t.target.value;h(d,n=>({...n,name:r}))},[d,h]),te=o.useCallback(t=>{if(d){if(!p){alert("Select an element in the viewer first to capture its data.");return}h(d,r=>{let n=p;try{n=JSON.parse(JSON.stringify(p))}catch{n=p}let l=p?.ifcClass;!l&&p?._category?.value&&(l=p._category.value),!l&&p?.constructor?.name&&(l=p.constructor.name);const i={capturedAt:new Date().toISOString(),sourceGlobalId:p?.GlobalId||p?._guid?.value||"unknown",ifcClass:l,sample:n};return t==="applicability"?{...r,applicability:[...r.applicability,i]}:{...r,requirements:[...r.requirements,i]}})}},[d,p,h]),fe=o.useCallback((t,r)=>{d&&h(d,n=>{if(t==="applicability"){const i=[...n.applicability];return i.splice(r,1),{...n,applicability:i}}const l=[...n.requirements];return l.splice(r,1),{...n,requirements:l}})},[d,h]),me=()=>{const t=`spec-${Date.now()}`,r={id:t,name:"New Specification",description:"",applicability:[],requirements:[]};A(n=>[...n,r]),q(t)},[xe,N]=o.useState(!1),[z,re]=o.useState(null),[b,$]=o.useState(null),[v,V]=o.useState(null),[B,ne]=o.useState({}),[M,W]=o.useState("equals"),[F,E]=o.useState("");o.useCallback(t=>{const r=m?.applicability?.[t]?.sample;if(!r)return;const n=ee(r);ne(n),re(t),$(Object.keys(n)[0]??null),V(Object.keys(n)[0]?n[Object.keys(n)[0]][0]??null:null),E(""),N(!0)},[m]);const he=o.useCallback(()=>{if(!d||z==null||!b||!v)return;const t=y.find(i=>i.id===d);if(!t)return;const r=t.applicability?.[z]?.sample;let n;try{const i=r?.IsDefinedBy||r?.isDefinedBy;if(Array.isArray(i)){for(const s of i)if((s?.Name?.value||s?.name?.value)===b){const c=s.HasProperties||s.hasProperties;if(Array.isArray(c)){for(const x of c)if((x?.Name?.value||x?.name?.value)===v){n=x?.NominalValue?.value||x?.nominalValue?.value||x?.NominalValue||x?.nominalValue;break}}break}}}catch(i){console.error("Error extracting property value:",i)}const l={id:`rule-${Date.now()}`,propertyPath:`${b}.${v}`,operator:M,value:F||(n!=null?String(n):""),sample:r??null};h(d,i=>{if((S.current??null)!=null){const s=S.current,a=[...i.requirements];return a[s]=l,S.current=null,{...i,requirements:a}}return{...i,requirements:[...i.requirements,l]}}),N(!1)},[d,z,b,v,M,F,y,h]),S=Ce.useRef(null),le=o.useCallback(t=>{if(!t)return"Captured element";const r=t.sample??t,n=t.sourceGlobalId||r?.GlobalId||r?._guid||r?.guid||r?.Tag&&r.Tag.value||"unknown",l=t.ifcClass||r&&r._category&&r._category.value||r?.ifcClass||"IfcElement",i=r&&(r.Name&&r.Name.value||r.ObjectType||r.Name)||void 0;return n!=="unknown"?`${l} (${n})`:i?`${l} — ${String(i).substring(0,40)}`:`${l} (captured)`},[]),ye=o.useCallback(t=>{d&&h(d,r=>{const n=r.applicability?.[t]??null;if(!n)return r;const l=JSON.parse(JSON.stringify(n));return{...r,requirements:[...r.requirements,l]}})},[d,h]),be=o.useCallback(t=>{if(!m)return;const r=m.requirements[t];let n=null;if(r&&r.sample){const s=m.applicability.findIndex(a=>a&&a.sourceGlobalId===r.sourceGlobalId);n=s>=0?s:null}S.current=t,re(n);const l=r?.sample??(n!=null?m.applicability?.[n]?.sample:null),i=l?ee(l):{};if(ne(i),r&&r.propertyPath){const[s,a]=String(r.propertyPath).split(".");$(s??Object.keys(i)[0]??null),V(a??(s?i[s]?.[0]??null:Object.values(i)[0]?.[0]??null)),W(r.operator??"equals"),E(r.value??"")}else $(Object.keys(i)[0]??null),V(Object.keys(i)[0]?i[Object.keys(i)[0]][0]??null:null),W("equals"),E("");N(!0)},[m]),je=o.useCallback(t=>{d&&h(d,r=>{const n=[...r.requirements];return n.splice(t,1),{...r,requirements:n}})},[d,h]),ge=o.useCallback(()=>{try{const t=ae(y),r=new Blob([t],{type:"application/xml"}),n=URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=k.endsWith(".ids")?k:`${k}.ids`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n)}catch(t){console.error("Failed to generate or save IDS file:",t),alert("Error: Could not save IDS file. See console for details.")}},[y,k]),ve=o.useCallback(()=>{if(D){if(y.length===0){alert("Please add at least one specification before validating.");return}try{const t=ae(y);D(t)}catch(t){console.error("Failed to generate IDS XML for validation:",t),alert("Error: Could not generate IDS XML. See console for details.")}}},[y,D]),Se=o.useCallback(t=>{const r=t.target.files?.[0];if(!r)return;Z(r.name);const n=new FileReader;n.onload=l=>{try{const i=l.target?.result,s=Ge(i);A(s),q(s[0]?.id||null)}catch(i){console.error("Failed to parse IDS file:",i),alert("Error: Could not parse IDS file. Ensure it is a valid .ids XML file.")}},n.readAsText(r),t.target.value=""},[]);return oe?e.jsx(Ie,{nodeRef:K,handle:".ids-creator-header",bounds:"parent",children:e.jsxs(ke,{ref:K,elevation:8,sx:{position:"fixed",top:140,left:40,width:900,height:I?"auto":600,minWidth:400,minHeight:I?56:300,maxWidth:"90vw",maxHeight:"80vh",display:"flex",flexDirection:"column",zIndex:1850,boxSizing:"border-box",overflow:"hidden"},children:[e.jsxs(u,{className:"ids-creator-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move",gap:2},children:[e.jsxs(u,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{whiteSpace:"nowrap"},children:"IDS Creator:"}),e.jsx(G,{value:k.replace(/\.ids$/,""),onChange:t=>Z(t.target.value),variant:"outlined",size:"small",placeholder:"filename",sx:{flex:1,maxWidth:300,"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255, 255, 255, 0.3)"},"&:hover fieldset":{borderColor:"rgba(255, 255, 255, 0.5)"},"&.Mui-focused fieldset":{borderColor:"rgba(255, 255, 255, 0.7)"}},"& .MuiInputBase-input":{py:.75}}}),e.jsx(f,{variant:"body2",sx:{color:"rgba(255, 255, 255, 0.7)"},children:".ids"})]}),e.jsxs(u,{children:[e.jsx("input",{ref:Q,type:"file",accept:".ids, .xml",style:{display:"none"},onChange:Se}),e.jsx(j,{size:"small",color:"inherit",title:"Load IDS File",onClick:()=>Q.current?.click(),children:e.jsx(Ne,{})}),e.jsx(j,{size:"small",color:"inherit",title:"Save IDS File",onClick:ge,children:e.jsx(we,{})}),D&&e.jsx(j,{size:"small",color:"inherit",title:"Validate in IDS Checker",onClick:ve,disabled:y.length===0,children:e.jsx(Pe,{})}),e.jsx(j,{size:"small",color:"inherit",onClick:()=>de(t=>!t),title:I?"Expand panel":"Minimize panel",children:I?e.jsx(De,{}):e.jsx(Ae,{})}),e.jsx(j,{size:"small",color:"inherit",onClick:ce,title:"Close IDS Creator",children:e.jsx(qe,{})})]})]}),!I&&e.jsxs(u,{sx:{flex:1,display:"flex",minHeight:0},children:[e.jsxs(u,{sx:{width:250,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column"},children:[e.jsx(u,{sx:{p:1,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(w,{startIcon:e.jsx(Re,{}),fullWidth:!0,variant:"outlined",onClick:me,children:"Add Specification"})}),e.jsx(H,{sx:{overflowY:"auto",flex:1},children:y.map(t=>e.jsx(T,{disablePadding:!0,secondaryAction:e.jsx(j,{edge:"end",size:"small",title:"Delete specification",onClick:r=>{r.stopPropagation(),ue(t.id)},children:e.jsx(U,{fontSize:"small"})}),children:e.jsx(Oe,{selected:t.id===d,onClick:()=>q(t.id),children:e.jsx(J,{primary:t.name})})},t.id))})]}),e.jsx(u,{sx:{flex:1,p:2,overflowY:"auto",display:"flex",flexDirection:"column",gap:2},children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{label:"Specification Name",value:m.name,onChange:pe,variant:"outlined",size:"small"}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Applicability (Which elements?)"}),e.jsxs(u,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture one or more example elements from the viewer to describe what this specification applies to."}),e.jsxs(u,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(w,{size:"small",variant:"outlined",onClick:()=>te("applicability"),disabled:!p,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:p?"Current viewer selection will be stored as a template.":"Select an element to enable capture."})]}),m.applicability.length?e.jsx(H,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.applicability.map((t,r)=>{const n=t;n?.ifcClass?`${n.ifcClass}${n.sourceGlobalId||"unknown"}`:n?.sourceGlobalId;const l=n?.capturedAt?new Date(n.capturedAt).toLocaleString():"";return e.jsx(T,{secondaryAction:e.jsxs(u,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(j,{size:"small",title:"Copy to requirements",onClick:()=>ye(r),children:e.jsx(ze,{fontSize:"small"})}),e.jsx(j,{edge:"end",size:"small",title:"Remove captured applicability",onClick:()=>fe("applicability",r),children:e.jsx(U,{fontSize:"small"})})]}),children:e.jsx(J,{primary:le(n),secondary:l?`Captured ${l}`:void 0})},`${n?.sourceGlobalId||"entry"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No applicability examples captured yet."})]}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Requirements (What must be true?)"}),e.jsxs(u,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture the same or other elements to store property snapshots you want to enforce as requirements."}),e.jsxs(u,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(w,{size:"small",variant:"outlined",onClick:()=>te("requirements"),disabled:!p,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:p?"Snapshot will be added to requirements.":"Select an element to enable capture."})]}),m.requirements.length?e.jsx(H,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.requirements.map((t,r)=>{const n=t,l=le(n),i=n?.capturedAt?new Date(n.capturedAt).toLocaleString():"";return e.jsxs(T,{children:[e.jsx(J,{primary:n.propertyPath?`${n.propertyPath} ${n.operator?`(${n.operator})`:""}`:l,secondary:n.propertyPath?`Expected: ${n.value??"(any)"}${i?` — captured ${i}`:""}`:i?`Captured ${i}`:void 0}),e.jsxs($e,{children:[e.jsx(j,{size:"small",title:"Edit requirement",onClick:()=>be(r),children:e.jsx(Ve,{fontSize:"small"})}),e.jsx(j,{size:"small",title:"Remove requirement",onClick:()=>je(r),children:e.jsx(U,{fontSize:"small"})})]})]},`${n?.id||n?.sourceGlobalId||"req"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No requirement snapshots captured yet."})]})]}):e.jsx(u,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(f,{color:"text.secondary",children:"Load or create a specification to begin."})})}),e.jsxs(u,{sx:{width:300,borderLeft:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(u,{sx:{p:1.5,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle2",children:"Property Sets"}),e.jsx(f,{variant:"caption",color:"text.secondary",children:O.length>0?`${O.length} properties`:"Select an element"})]}),O.length>0?e.jsx(u,{sx:{flex:1,overflowY:"auto",p:1},children:e.jsx(u,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:O.map((t,r)=>e.jsxs(u,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[e.jsx(f,{variant:"caption",sx:{fontWeight:600,color:"text.secondary"},children:t.label}),e.jsx(f,{variant:"body2",sx:{wordBreak:"break-word"},children:t.value})]},r))})}):P?e.jsx(u,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"No property sets found for this element."})}):e.jsx(u,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"Select an element in the viewer to inspect its property sets."})})]})]}),e.jsxs(Be,{open:xe,onClose:()=>N(!1),maxWidth:"sm",fullWidth:!0,sx:{zIndex:2e3},children:[e.jsx(Ee,{children:S.current!=null?"Edit Requirement":"Create Requirement"}),e.jsxs(Le,{children:[e.jsxs(u,{sx:{display:"flex",gap:2,mt:1},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"pset-label",children:"Property Set"}),e.jsx(X,{labelId:"pset-label",value:b??"",label:"Property Set",onChange:t=>$(String(t.target.value)||null),MenuProps:{style:{zIndex:2100}},children:Object.keys(B).length?Object.keys(B).map(t=>e.jsx(g,{value:t,children:t},t)):e.jsx(g,{value:"",children:"(none)"})})]}),e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"prop-label",children:"Property"}),e.jsx(X,{labelId:"prop-label",value:v??"",label:"Property",onChange:t=>V(String(t.target.value)||null),MenuProps:{style:{zIndex:2100}},children:b&&B[b]?B[b].map(t=>e.jsx(g,{value:t,children:t},t)):e.jsx(g,{value:"",children:"(none)"})})]})]}),e.jsxs(u,{sx:{display:"flex",gap:2,mt:2},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"op-label",children:"Operator"}),e.jsxs(X,{labelId:"op-label",value:M,label:"Operator",onChange:t=>W(String(t.target.value)),MenuProps:{style:{zIndex:2100}},children:[e.jsx(g,{value:"exists",children:"exists"}),e.jsx(g,{value:"equals",children:"equals"}),e.jsx(g,{value:"not-equals",children:"not equals"}),e.jsx(g,{value:"contains",children:"contains"}),e.jsx(g,{value:"matches",children:"matches (regex)"})]})]}),e.jsx(Me,{fullWidth:!0,freeSolo:!0,options:(()=>{const t=m?.applicability?.[z??-1]?.sample;if(!t||!b||!v)return[];try{const r=t.IsDefinedBy||t.isDefinedBy;if(Array.isArray(r)){for(const n of r)if((n.Name?.value||n.name?.value||n.Name||n.name)===b){const i=n.HasProperties||n.hasProperties;if(Array.isArray(i)){for(const s of i)if((s.Name?.value||s.name?.value||s.Name||s.name)===v){let c=s.NominalValue?.value||s.nominalValue?.value||s.NominalValue||s.nominalValue||s.value||s.Value;if(typeof c=="boolean"&&(c=c?"true":"false"),c!=null)return[String(c)]}}}}}catch{return[]}return[]})(),value:F,onInputChange:(t,r)=>E(r),renderInput:t=>e.jsx(G,{...t,label:"Value (optional or select)"}),componentsProps:{popper:{style:{zIndex:2100}}}})]})]}),e.jsxs(We,{children:[e.jsx(w,{onClick:()=>{N(!1),S.current=null},children:"Cancel"}),e.jsx(w,{variant:"contained",onClick:he,startIcon:e.jsx(Fe,{}),children:S.current!=null?"Save":"Create"})]})]})]})}):null};export{Ye as default};
