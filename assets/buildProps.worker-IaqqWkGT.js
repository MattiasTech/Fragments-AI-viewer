(function(){"use strict";const f=self,b=(s,e)=>{if(!s||typeof s!="object")return;const c=e.map(t=>t.toLowerCase()),r=new WeakSet,i=[s];for(;i.length;){const t=i.pop();if(!(!t||typeof t!="object")&&!r.has(t)){if(r.add(t),Array.isArray(t)){for(const o of t)o&&typeof o=="object"&&i.push(o);continue}for(const[o,n]of Object.entries(t)){const l=o.toLowerCase();if(c.some(a=>l.includes(a)))if(typeof n=="string"){const a=n.trim();if(a)return a}else{if(typeof n=="number"&&Number.isFinite(n))return n.toString();if(typeof n=="boolean")return n?"true":"false"}n&&typeof n=="object"&&i.push(n)}}}},E=s=>{if(!s||typeof s!="object")return"IfcProduct";const e=s,c=new Set(["IFCIDENTIFIER","IFCLABEL","IFCTEXT","IFCBOOLEAN","IFCINTEGER","IFCREAL","IFCLENGTHMEASURE","IFCPOSITIVELENGTHMEASURE","IFCAREAMEASURE","IFCVOLUMEMEASURE","IFCPOSITIVERATIOMEASURE","IFCPLANEANGLEMEASURE","IFCPOSITIVEINTEGER","IFCLOGICAL"]);if(e.constructor&&typeof e.constructor=="function"&&e.constructor.name){const t=e.constructor.name.toUpperCase();if(t.startsWith("IFC")&&!c.has(t))return t}if(e._category&&typeof e._category=="object"){const t=e._category;if(t.value&&typeof t.value=="string"){const o=t.value.trim().toUpperCase();if(o.startsWith("IFC")&&!c.has(o))return o}}const r=[e.ifcClass,e.IfcClass,e.type,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.attributes?.ifcClass,e.Attributes?.IfcClass];for(const t of r)if(typeof t=="string"&&t.trim().length){const o=t.trim().toUpperCase();if(!c.has(o))return t.trim()}const i=b(s,["ifcclass","ifc type","type"]);if(i){const t=i.trim().toUpperCase();if(!c.has(t))return i}return"IfcProduct"};let m=new Set,y=0,p=0,u=!1;const I=()=>{m=new Set,y=0,p=0,u=!1},g=(s,e,c)=>{const r={GlobalId:e,ifcClass:c,"Attributes.GlobalId":e,"Attributes.IfcClass":c};if(!s||typeof s!="object")return r;const i=s,t=i.Name||i.name||i.NAME;t&&typeof t=="string"&&(r["Attributes.Name"]=t);for(const[o,n]of Object.entries(i))if(!(n==null||o.startsWith("_"))&&!(o==="type"||o==="Type"||o==="expressID"||o==="GlobalId")){if(typeof n=="string"||typeof n=="number"||typeof n=="boolean"){r[`Attributes.${o}`]=n;continue}if(typeof n=="object"&&!Array.isArray(n)){const l=n,a=l.value||l.Value||l.NominalValue||l.nominalValue;a!=null&&(typeof a=="string"||typeof a=="number")&&(r[`Attributes.${o}`]=a)}}return r},d=s=>{if(s.reset&&I(),typeof s.total=="number"&&!Number.isNaN(s.total)&&(y=s.total),!u){if(Array.isArray(s.elements)&&s.elements.length){const e=[];for(const c of s.elements){if(u)break;const r=c.globalId?.trim();if(!r||m.has(r))continue;const i=c.data;if(!i||typeof i!="object")continue;const t=c.ifcClass?.trim()||E(i),o=g(i,r,t),n={GlobalId:r,ifcClass:t,properties:o};m.add(r),e.push(n)}if(e.length){p+=e.length;const c={type:"batch",elements:e,partIndex:s.partIndex};if(f.postMessage(c),p%5e3<e.length||s.final){const r={type:"progress",done:p,total:y||Math.max(p,y)};f.postMessage(r)}}}if(s.final){if(u){const e={type:"error",message:"Build cancelled"};f.postMessage(e)}else{const e={type:"done"};f.postMessage(e)}I()}}};f.onmessage=s=>{const e=s.data;if(e)switch(e.type){case"build-props":d(e);break;case"cancel":u=!0,f.postMessage({type:"error",message:"Build cancelled"}),I();break;default:f.postMessage({type:"error",message:"Unknown message type"})}}})();
