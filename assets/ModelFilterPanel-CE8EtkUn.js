import{cm as n,co as t,cF as me,cD as pe,cp as d,dH as w,cq as j,cs as H,cG as ye,cH as xe,cI as Ie,cP as A,d2 as U,dw as Y,dx as J,d7 as K,dI as be,dp as je,dk as Fe,dt as Q,dJ as Pe,cQ as X,df as Z,dK as Ce,dL as ee,cE as Se,cy as te,dy as ve}from"./vendor-CgTU62Zb.js";const M="GlobalId",De=["equals","contains","matches","greater-than","less-than","not-equals"],Be=["IfcWall","IfcColumn","IfcBeam","IfcSlab","IfcDoor","IfcWindow","IfcStair","IfcRoof","IfcSpace"];function $e({open:v,onClose:se,viewerApi:s}){const z=n.useRef(null),[x,le]=n.useState(!1),[f,oe]=n.useState([]),[m,N]=n.useState(M),[F,ae]=n.useState("equals"),[I,re]=n.useState(""),[P,ne]=n.useState("ghost"),[ie]=n.useState(Be),[ce,k]=n.useState([]),[E,_]=n.useState(!1),[b,D]=n.useState(!1),[C,B]=n.useState(null),[G,O]=n.useState(!1),[p,V]=n.useState(null),[R,W]=n.useState(""),ue=e=>e.GlobalId&&typeof e.GlobalId=="object"&&"value"in e.GlobalId?e.GlobalId.value:e._guid&&typeof e._guid=="object"&&"value"in e._guid?e._guid.value:null,de=(e,l)=>{const a=o=>o&&typeof o=="object"&&"value"in o?o.value:o,r=l.split(".");if(r.length===1)return a(e[r[0]]);const[i,c]=r,u=e.IsDefinedBy;if(Array.isArray(u))for(const o of u){if(a(o.Name)!==i)continue;const g=o.HasProperties;if(Array.isArray(g)){for(const y of g)if(a(y.Name)===c)return a(y.NominalValue)}}},L=(e,l,a)=>{if(e==null)return!1;const r=String(e),i=String(a);switch(l){case"equals":return r===i;case"not-equals":return r!==i;case"contains":return r.toLowerCase().includes(i.toLowerCase());case"matches":try{return new RegExp(i).test(r)}catch{return!1}case"greater-than":return parseFloat(r)>parseFloat(i);case"less-than":return parseFloat(r)<parseFloat(i);default:return!1}},T=(e,l="",a=3,r=0)=>{if(r>=a)return[];const i=[];for(const c in e){if(!e.hasOwnProperty(c)||c.startsWith("_"))continue;const u=l?`${l}.${c}`:c,o=e[c];Array.isArray(o)&&o.length>0&&typeof o[0]=="object"?i.push(...T(o[0],u,a,r+1)):o&&typeof o=="object"&&!Array.isArray(o)?i.push(...T(o,u,a,r+1)):o!=null&&typeof o!="function"&&i.push(u)}return i},q=n.useCallback(async()=>{if(!(!s||!s.getItemsByCategory||!s.getItemsDataByModel)){_(!0),console.log("üîç [Property Discovery] START");try{const e=f.length>0?f.map(h=>new RegExp(`^${h}$`,"i")):[/.*/],l=await s.getItemsByCategory(e),[a,r]=Object.entries(l)[0]||[null,[]];if(!a||r.length===0){console.log("üîç [Property Discovery] No elements found"),k([]);return}const i=Math.min(10,r.length),c=r.slice(0,i);console.log(`üîç [Property Discovery] Sampling ${i} elements from model ${a}`);const u={attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasAssignments:{attributes:!0,relations:!1}}},o=await s.getItemsDataByModel(a,c,u);console.log(`‚úÖ [Property Discovery] Loaded ${o.length} samples`);const g=new Set;for(const h of o)T(h).forEach($=>{const he=$.startsWith("IsDefinedBy.")?$.substring(12):$;g.add(he)});const y=Array.from(g).filter(h=>!h.startsWith("_")).sort();console.log(`‚úÖ [Property Discovery] Found ${y.length} unique properties`),k(y)}catch(e){console.error("Property discovery failed:",e)}finally{_(!1)}}},[s,f]);n.useEffect(()=>{v&&!x&&q()},[v,f,q,x]);const fe=n.useCallback(async()=>{if(!s||!s.getItemsByCategory||!s.getItemsDataByModel){alert("‚ùå Viewer API not ready");return}if(!m||!I){alert("‚ö†Ô∏è Please select a property and enter a value");return}D(!0),B({current:0,total:1});const e=[];try{console.log("üîç [Filter] Step 1: Getting items by category...");let l;if(f.length>0){const c=f.map(u=>new RegExp(`^${u}$`,"i"));l=await s.getItemsByCategory(c)}else l=await s.getItemsByCategory([/.*/]);const a=Object.values(l).reduce((c,u)=>c+u.length,0);if(console.log(`üîç [Filter] Found ${a} items to check`),a===0){alert("‚ö†Ô∏è No elements found matching the category filter"),D(!1);return}console.log("üîç [Filter] Step 2: Loading properties for",a,"filtered elements...");let r=0;const i=m.includes("Pset_")||m.includes(".")?{attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}}:{attributesDefault:!1,attributes:["Name","GlobalId"]};for(const[c,u]of Object.entries(l)){if(u.length===0)continue;if(console.log(`üîç [Filter] Processing model ${c}: ${u.length} elements`),!s.getItemsDataByModel){console.error("getItemsDataByModel not available");continue}const o=await s.getItemsDataByModel(c,u,i);console.log(`‚úÖ [Filter] Loaded ${o.length} items from model ${c}`);let g=0;for(const y of o){const h=ue(y);if(!h)continue;const S=de(y,m);g<5&&(console.log(`üîç [Filter Debug] Item ${g+1}:`,{globalId:h,field:m,actualValue:S,operator:F,expectedValue:I,matches:L(S,F,I)}),g++),L(S,F,I)&&e.push(h),r++,r%100===0&&B({current:r,total:a})}}console.log(`‚úÖ [Filter] Complete: ${e.length} matches out of ${a} elements`),V(e),W(`${e.length} of ${a} elements`),e.length===0?alert("‚ÑπÔ∏è No elements matched the filter criteria"):e.length===a&&alert(`‚úÖ All ${a} elements matched the filter!

Tip: Try a different value or use "not equals" operator to see some elements filtered out.`)}catch(l){console.error("Filter failed:",l),alert(`‚ùå Filter failed: ${l.message}`)}finally{D(!1),B(null)}},[s,m,F,I,f]);n.useEffect(()=>{let e=!0;const l=async()=>{if(!(!s||!p||p.length===0||b))try{console.log(`[Filter] Applying ${P} mode...`),s.clearColors&&await s.clearColors(),s.clearIsolation&&await s.clearIsolation(),P==="ghost"?s.ghost?(await s.ghost(p),console.log("[Filter] Applied ghost mode")):console.warn("Ghost mode not supported by viewer API"):(await s.isolate(p),console.log("[Filter] Applied isolate mode")),typeof s.fitViewTo=="function"&&(await s.fitViewTo(p),console.log("[Filter] Fitted view to filtered elements")),e&&O(!0)}catch(a){console.error("[Filter] Failed to apply filter to view:",a)}};return p&&p.length>0&&!b&&l(),()=>{e=!1}},[p,s,P,b,f]);const ge=n.useCallback(async()=>{if(s)try{s.clearIsolation&&(await s.clearIsolation(),console.log("üîÑ [Filter] Cleared isolation")),s.clearColors&&(await s.clearColors(),console.log("üîÑ [Filter] Cleared colors")),O(!1),V([]),W(""),console.log("‚úÖ [Filter] Filter cleared")}catch(e){console.error("‚ùå [Filter] Failed to clear filter:",e)}},[s]);return v?t.jsx(me,{nodeRef:z,handle:".filter-header",bounds:"parent",children:t.jsxs(pe,{ref:z,elevation:8,sx:{position:"fixed",top:120,left:30,width:420,maxHeight:x?"auto":"80vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[t.jsxs(d,{className:"filter-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[t.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(w,{}),t.jsx(j,{variant:"subtitle1",children:"Parametric Filter"})]}),t.jsxs(d,{children:[t.jsx(H,{size:"small",color:"inherit",onClick:()=>le(!x),title:x?"Expand panel":"Minimize panel",children:x?t.jsx(ye,{}):t.jsx(xe,{})}),t.jsx(H,{size:"small",color:"inherit",onClick:se,title:"Close",children:t.jsx(Ie,{})})]})]}),!x&&t.jsxs(d,{sx:{p:2,overflowY:"auto",flex:1},children:[t.jsxs(A,{severity:"info",sx:{mb:2},children:[t.jsx("strong",{children:"On-Demand Mode:"})," Properties loaded when filtering. No extraction needed!"]}),G&&R&&t.jsxs(A,{severity:"success",sx:{mb:2},children:[t.jsx("strong",{children:"Active Filter:"})," ",R," match"]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"subtitle2",gutterBottom:!0,children:"1. Category Filter (Optional)"}),t.jsxs(U,{size:"small",fullWidth:!0,children:[t.jsx(Y,{children:"IFC Types"}),t.jsx(J,{multiple:!0,value:f,onChange:e=>oe(typeof e.target.value=="string"?[]:e.target.value),renderValue:e=>t.jsx(d,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.length===0?t.jsx("em",{children:"All types"}):e.map(l=>t.jsx(Fe,{label:l,size:"small"},l))}),MenuProps:{style:{zIndex:1900}},children:ie.map(e=>t.jsxs(K,{value:e,children:[t.jsx(be,{checked:f.indexOf(e)>-1}),t.jsx(je,{primary:e})]},e))})]})]}),t.jsx(Q,{sx:{my:2}}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"subtitle2",gutterBottom:!0,children:"2. Define Filter"}),t.jsx(Pe,{fullWidth:!0,size:"small",value:m,onChange:(e,l)=>N(l||M),onInputChange:(e,l)=>N(l||M),options:ce,freeSolo:!0,loading:E,componentsProps:{popper:{style:{zIndex:1900}}},renderInput:e=>t.jsx(X,{...e,label:"Property Path",helperText:"e.g., NV_PSteel.NV_STATUS or Pset_WallCommon.FireRating",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[E?t.jsx(Z,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),sx:{mb:2}}),t.jsxs(d,{sx:{display:"flex",gap:1,mb:2},children:[t.jsxs(U,{size:"small",sx:{minWidth:150},children:[t.jsx(Y,{children:"Operator"}),t.jsx(J,{value:F,onChange:e=>ae(e.target.value),label:"Operator",MenuProps:{style:{zIndex:1900}},children:De.map(e=>t.jsx(K,{value:e,children:e},e))})]}),t.jsx(X,{size:"small",fullWidth:!0,label:"Value",value:I,onChange:e=>re(e.target.value),placeholder:"Enter value..."})]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"caption",color:"text.secondary",gutterBottom:!0,sx:{display:"block"},children:"Filter Mode:"}),t.jsxs(Ce,{value:P,exclusive:!0,onChange:(e,l)=>{l!==null&&ne(l)},size:"small",fullWidth:!0,children:[t.jsx(ee,{value:"ghost",children:"Ghost (Transparent)"}),t.jsx(ee,{value:"isolate",children:"Isolate (Hide)"})]}),t.jsx(j,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:P==="ghost"?"Makes non-matching elements transparent":"Hides non-matching elements completely"})]})]}),t.jsx(Q,{sx:{my:2}}),b&&C&&t.jsxs(d,{sx:{mb:2},children:[t.jsxs(j,{variant:"caption",color:"text.secondary",children:["Filtering: ",C.current," / ",C.total]}),t.jsx(Se,{variant:"determinate",value:C.current/C.total*100})]}),t.jsxs(d,{sx:{display:"flex",gap:1},children:[t.jsx(te,{variant:"contained",onClick:fe,disabled:b||!m||!I,startIcon:b?t.jsx(Z,{size:20}):t.jsx(w,{}),fullWidth:!0,children:b?"Filtering...":"Apply Filter"}),G&&t.jsx(te,{variant:"outlined",onClick:ge,startIcon:t.jsx(ve,{}),children:"Clear"})]})]})]})}):null}export{$e as default};
