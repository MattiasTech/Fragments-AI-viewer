const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-9MKqMghO.js","assets/vendor-CgTU62Zb.js","assets/IdsPanel-DW1gVJWR.js","assets/thatopen-vendor-NKp5mY5i.js","assets/three-vendor-kQcUiZz9.js","assets/IdsCreatorPanel-CXSrvxaA.js","assets/ModelFilterPanel-CE8EtkUn.js"])))=>i.map(i=>d[i]);
import{ck as Cn,cl as Sn,cm as g,cn as mt,co as n,cp as W,cq as X,cr as ie,cs as ne,ct as En,cu as jn,cv as vn,cw as Pn,cx as kn,cy as ce,cz as ar,cA as An,cB as cr,cC as dr,cD as he,cE as $n,cF as ur,cG as Mn,cH as Rn,cI as fr,cJ as zn,cK as Eo,cL as jo,cM as Xt,cN as Fn,cO as pr,cP as Jt,cQ as vo,cR as Dn,cS as Tn,cT as Nn,cU as mr,cV as Ln,cW as On,cX as Po,cY as Vn,cZ as _n,c_ as Bn,c$ as Gn,d0 as Wn,d1 as Un,d2 as Hn,d3 as qn,d4 as Yn,d5 as gr,d6 as hr,d7 as ko,d8 as Kn,d9 as Xn,da as Jn}from"./vendor-CgTU62Zb.js";import{l as Zn,_ as Qn,C as es,W as ts,S as os,a as rs,O as ns,G as ss,F as ls,t as is,H as as,Y as cs,$ as yr}from"./thatopen-vendor-NKp5mY5i.js";import{B as qe,V as K,C as Me,a3 as ds,c as us,P as ut,a6 as Ao,l as fs,G as ps,S as ms,h as br,$ as gs,y as xr,ab as hs,D as ys}from"./three-vendor-kQcUiZz9.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))y(c);new MutationObserver(c=>{for(const h of c)if(h.type==="childList")for(const x of h.addedNodes)x.tagName==="LINK"&&x.rel==="modulepreload"&&y(x)}).observe(document,{childList:!0,subtree:!0});function i(c){const h={};return c.integrity&&(h.integrity=c.integrity),c.referrerPolicy&&(h.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?h.credentials="include":c.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function y(c){if(c.ep)return;c.ep=!0;const h=i(c);fetch(c.href,h)}})();const bs="modulepreload",xs=function(e){return"/Fragments-AI-viewer/"+e},wr={},pt=function(s,i,y){let c=Promise.resolve();if(i&&i.length>0){let v=function(d){return Promise.all(d.map(j=>Promise.resolve(j).then(S=>({status:"fulfilled",value:S}),S=>({status:"rejected",reason:S}))))};document.getElementsByTagName("link");const x=document.querySelector("meta[property=csp-nonce]"),m=x?.nonce||x?.getAttribute("nonce");c=v(i.map(d=>{if(d=xs(d),d in wr)return;wr[d]=!0;const j=d.endsWith(".css"),S=j?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${S}`))return;const N=document.createElement("link");if(N.rel=j?"stylesheet":bs,j||(N.as="script"),N.crossOrigin="",N.href=d,m&&N.setAttribute("nonce",m),document.head.appendChild(N),j)return new Promise((R,I)=>{N.addEventListener("load",R),N.addEventListener("error",()=>I(new Error(`Unable to preload CSS for ${d}`)))})}))}function h(x){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=x,window.dispatchEvent(m),!m.defaultPrevented)throw x}return c.then(x=>{for(const m of x||[])m.status==="rejected"&&h(m.reason);return s().catch(h)})},ws="fragments-ids",te="elements-v5",le="cache-metadata-v1",Is=6,ye=()=>new Promise((e,s)=>{const i=indexedDB.open(ws,Is);i.onerror=()=>s(i.error??new Error("IndexedDB open failed")),i.onupgradeneeded=()=>{const y=i.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(h=>{y.objectStoreNames.contains(h)&&y.deleteObjectStore(h)}),y.objectStoreNames.contains(te)||y.createObjectStore(te),y.objectStoreNames.contains(le)||y.createObjectStore(le)},i.onsuccess=()=>e(i.result)}),$o={async get(e){const s=await ye();return new Promise((i,y)=>{const x=s.transaction(te,"readonly").objectStore(te).get(e);x.onsuccess=()=>i(x.result??null),x.onerror=()=>y(x.error??new Error("IndexedDB get failed"))})},async set(e,s){const i=await ye();await new Promise((y,c)=>{const h=i.transaction([te,le],"readwrite"),x=h.objectStore(te),m=h.objectStore(le),v=x.put(s,e),d={modelKey:e,timestamp:Date.now(),elementCount:s.length,version:"1.0"};m.put(d,e),v.onsuccess=()=>y(),v.onerror=()=>c(v.error??new Error("IndexedDB set failed"))}),console.log(`💾 Cached ${s.length} elements to IndexedDB for key: ${e.substring(0,16)}...`)},async append(e,s){if(!s||!s.length)return;const i=await ye();await new Promise((y,c)=>{const h=i.transaction([te,le],"readwrite"),x=h.objectStore(te),m=h.objectStore(le),v=x.get(e);v.onsuccess=()=>{const j=(v.result??[]).concat(s),S=x.put(j,e),N={modelKey:e,timestamp:Date.now(),elementCount:j.length,version:"1.0"};m.put(N,e),S.onsuccess=()=>y(),S.onerror=()=>c(S.error??new Error("IndexedDB append put failed"))},v.onerror=()=>c(v.error??new Error("IndexedDB append get failed"))}),console.log(`💾 Appended ${s.length} elements to IndexedDB for key: ${e.substring(0,16)}...`)},async writePart(e,s,i){const y=`${e}::part::${String(s).padStart(6,"0")}`,c=`${e}::partindex::${String(s).padStart(6,"0")}`,h=await ye();await new Promise((x,m)=>{const v=h.transaction([te,le],"readwrite"),d=v.objectStore(te),j=v.objectStore(le),S=d.put(i,y);S.onsuccess=()=>{const N=j.get(e);N.onsuccess=()=>{const R=N.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};R.timestamp=Date.now(),R.elementCount=(R.elementCount||0)+i.length;const I=Array.isArray(R.partKeys)?R.partKeys.slice():[];I.includes(y)||I.push(y),R.partKeys=I,j.put(R,e);try{const $=i.map(E=>E.GlobalId).filter(Boolean),T=d.put($,c);T.onsuccess=()=>{},T.onerror=()=>{}}catch{}x()},N.onerror=()=>x()},S.onerror=()=>m(S.error??new Error("IndexedDB writePart failed"))}),console.log(`💾 Wrote part ${s} (${i.length} items) for ${e.substring(0,16)}...`)},async getPersistedIds(e){const s=await this.getPartKeys(e);if(!s||!s.length)return new Set;const i=await ye(),y=new Set;return await new Promise(c=>{const x=i.transaction(te,"readonly").objectStore(te);let m=s.length;s.forEach(v=>{const d=v.replace("::part::","::partindex::"),j=x.get(d);j.onsuccess=()=>{const S=j.result??[];for(const N of S)typeof N=="string"&&N&&y.add(N);m-=1,m===0&&c()},j.onerror=()=>{m-=1,m===0&&c()}})}),y},async getPartKeys(e){const s=await this.getMetadata(e);return Array.isArray(s?.partKeys)?s.partKeys:[]},async listParts(e){return(await this.getPartKeys(e)).slice().sort()},async readAllParts(e){const s=await ye(),i=await this.getPartKeys(e);return i.length?new Promise((y,c)=>{const x=s.transaction(te,"readonly").objectStore(te),m=[];let v=i.length;i.forEach(d=>{const j=x.get(d);j.onsuccess=()=>{const S=j.result??[];m.push(...S),v-=1,v===0&&y(m)},j.onerror=()=>{v-=1,v===0&&y(m)}})}):[]},async removeParts(e){const s=await ye(),i=`${e}::part::`,c=(await this.keys()).filter(h=>h.startsWith(i));c.length&&(await new Promise((h,x)=>{const m=s.transaction([te,le],"readwrite"),v=m.objectStore(te),d=m.objectStore(le);c.forEach(j=>v.delete(j)),d.delete(e),m.oncomplete=()=>h(),m.onerror=()=>x(m.error??new Error("IndexedDB removeParts failed"))}),console.log(`🧹 Removed ${c.length} parts for ${e.substring(0,16)}...`))},async getMetadata(e){const s=await ye();return new Promise((i,y)=>{const x=s.transaction(le,"readonly").objectStore(le).get(e);x.onsuccess=()=>i(x.result??null),x.onerror=()=>y(x.error??new Error("IndexedDB metadata get failed"))})},async remove(e){const s=await ye();await new Promise((i,y)=>{const c=s.transaction([te,le],"readwrite"),h=c.objectStore(te),x=c.objectStore(le);h.delete(e),x.delete(e),c.oncomplete=()=>i(),c.onerror=()=>y(c.error??new Error("IndexedDB delete failed"))})},async keys(){const e=await ye();return new Promise((s,i)=>{const h=e.transaction(te,"readonly").objectStore(te).getAllKeys();h.onsuccess=()=>s(h.result??[]),h.onerror=()=>i(h.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const e=await ye();return new Promise((s,i)=>{const h=e.transaction(le,"readonly").objectStore(le).getAll();h.onsuccess=()=>s(h.result??[]),h.onerror=()=>i(h.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(e=720*60*60*1e3){const s=await ye(),i=await this.getAllMetadata(),y=Date.now(),c=i.filter(h=>y-h.timestamp>e).map(h=>h.modelKey);c.length>0&&await new Promise((h,x)=>{const m=s.transaction([te,le],"readwrite"),v=m.objectStore(te),d=m.objectStore(le);c.forEach(j=>{v.delete(j),d.delete(j)}),m.oncomplete=()=>{console.log(`🧹 Cleaned up ${c.length} old cache entries from IndexedDB`),h()},m.onerror=()=>x(m.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(e,s){const i=await this.getMetadata(e);return!i||!i.modelSignature?!1:i.modelSignature===s},async updateSignature(e,s,i){const y=await ye();await new Promise((c,h)=>{const m=y.transaction(le,"readwrite").objectStore(le),v=m.get(e);v.onsuccess=()=>{const d=v.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};d.modelSignature=s,d.modelFiles=i,d.timestamp=Date.now();const j=m.put(d,e);j.onsuccess=()=>c(),j.onerror=()=>h(j.error??new Error("IndexedDB updateSignature failed"))},v.onerror=()=>h(v.error??new Error("IndexedDB updateSignature get failed"))})}},Cs=async e=>{const s=new TextEncoder,i=`${e.modelUrl}|${e.extra??""}`,y=s.encode(i),c=await crypto.subtle.digest("SHA-256",y),h=new Uint8Array(c);return btoa(String.fromCharCode(...h)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},kr={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},Ne=e=>e==null?[]:Array.isArray(e)?e:[e],Ir=e=>{if(e==null)return[];if(typeof e=="string")try{const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}if(typeof e=="object"){const s=e;if(typeof s.__cdata=="string")try{const i=JSON.parse(s.__cdata);return Array.isArray(i)?i:[]}catch{return[]}if(Array.isArray(s.item))return s.item;if(s.item!=null)return[s.item];if(Array.isArray(s.Rule))return s.Rule;if(s.Rule!=null)return[s.Rule]}return Array.isArray(e)?e:[]},ll=e=>{if(!e||typeof e!="string")return[];const s=new Sn(kr);let i={};try{i=s.parse(e)}catch(d){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",d),[]}const y=i?.IdsCreator??i?.idsCreator??i?.IDS_CREATOR??i?.Ids??i,c=y?.Specification??y?.specification??y?.Specifications??y?.specifications??null;if(c){const d=Ne(c);if(d.length)return d.map((j,S)=>{const N=j?.["@_id"]?.trim?.()||`spec-${S+1}`,R=(j?.Name??j?.name??"")?.toString?.()??"",I=(j?.Description??j?.description??"")?.toString?.()??"",$=Ir(j?.Applicability??j?.applicability),T=Ir(j?.Requirements??j?.requirements);return{id:N,name:R,description:I,applicability:$,requirements:T}})}const h=d=>{if(!d||typeof d!="object")return[];for(const[j,S]of Object.entries(d)){const N=String(j).toLowerCase();if(N.endsWith(":specification")||N==="specification"||N==="ids:specification")return Ne(S)}for(const j of Object.values(d))if(j&&typeof j=="object"){const S=h(j);if(S&&S.length)return S}return[]},x=h(i);if(!x.length)return[];const m=d=>{if(!d)return null;if(typeof d=="string")return d;if(typeof d=="object")for(const j of Object.keys(d)){const S=j.toLowerCase();if(S.includes("simplevalue")||S==="#text"||S==="value"){const N=d[j];if(typeof N=="string")return N;if(typeof N=="object"&&(N?.value||N?.Value))return String(N.value??N.Value)}}return null};return x.map((d,j)=>{const S=d?.["@_id"]?.trim?.()||`spec-${j+1}`,N=d?.["@_name"]??d?.name??d?.Name??"",R=String(N??""),I="",$=[],T=[],E=d?.applicability??d?.Applicability??d?.["ids:applicability"]??null,z=Ne(E);for(const Y of z){let Q=null;const q=[Y];for(;q.length&&!Q;){const G=q.shift();if(!G)continue;const Ee=m(G);if(Ee){Q=Ee;break}if(typeof G=="object")for(const me of Object.values(G))me&&typeof me=="object"&&q.push(me)}Q&&$.push({entity:Q})}const U=d?.requirements??d?.Requirements??d?.["ids:requirements"]??null,ue=Ne(U),J=Y=>{const Q=[],q=[];if(Y?.property&&q.push(...Ne(Y.property)),Y?.Property&&q.push(...Ne(Y.Property)),Array.isArray(Y)&&q.push(...Y),!q.length&&typeof Y=="object")for(const G of Object.values(Y))G&&typeof G=="object"&&q.push(G);for(const G of q){const Ee=G?.propertySet??G?.PropertySet??G?.["ids:propertySet"]??G?.propertySet,me=G?.baseName??G?.BaseName??G?.["ids:baseName"]??G?.baseName,Oe=m(Ee)||m(G?.propertySet?.simpleValue)||m(G?.propertySet?.["ids:simpleValue"]),gt=m(me)||m(G?.baseName?.simpleValue)||m(G?.baseName?.["ids:simpleValue"]),ze=[],fe=G?.allowedValues??G?.AllowedValues??G?.["ids:allowedValues"];if(fe){const Fe=fe?.values??fe?.Values??fe?.["ids:values"]??fe,ht=Ne(Fe?.value??Fe?.Value??Fe?.["ids:value"]??Fe??[]);for(const Ve of ht){const je=m(Ve)||m(Ve?.simpleValue)||m(Ve?.["ids:simpleValue"]);je&&ze.push(je)}}if(Oe||gt){const Fe={id:`rule-${j}-${Q.length}`,propertyPath:`${Oe??"Pset"}.${gt??"Property"}`,operator:"equals"};ze.length&&(Fe.value=ze.length===1?ze[0]:JSON.stringify(ze)),Q.push(Fe)}}return Q};for(const Y of ue){const Q=J(Y);Q.length&&T.push(...Q)}return{id:S,name:String(R??""),description:String(I),applicability:$,requirements:T}})},il=e=>{const s=new Cn(kr);if((e??[]).some(h=>Array.isArray(h.requirements)&&h.requirements.some(x=>x&&typeof x=="object"&&"propertyPath"in x))){const x={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(e??[]).map(v=>{const d=[],j=I=>{if(!I&&I!==0)return null;if(typeof I=="string")return I;if(typeof I=="number")return String(I);if(I?.ifcClass&&typeof I.ifcClass=="string"&&I.ifcClass.trim())return I.ifcClass.trim();const $=I?.entity??I?.ifcType??I?.type;if($&&typeof $=="string"&&$.trim())return $.trim();const T=I?.sample??I;if(T){if(T._category&&typeof T._category=="object"){const z=T._category.value??T._category.Value;if(typeof z=="string"&&z.trim())return z.trim()}const E=T?.ifcClass??T?.category?.value??T?.type??T?._type;if(E&&typeof E=="string"&&E.trim())return E.trim()}return null};for(const I of Ne(v.applicability)){const $=j(I)??null,T=$&&String($).trim()?String($):"IFCELEMENT";d.push({"ids:name":{"ids:simpleValue":T}})}const S=[],N=I=>{if(I==null)return"";if(typeof I=="string")return I;if(typeof I=="number")return String(I);if(typeof I=="object"){if(I["ids:simpleValue"])return String(I["ids:simpleValue"]);if(I.__cdata)return String(I.__cdata);if(I.Name)return String(I.Name);if(I.name)return String(I.name);for(const $ of Object.keys(I)){const T=I[$];if(typeof T=="string"&&T.trim())return T;if(T&&typeof T=="object"){const E=T;if(typeof E["ids:simpleValue"]=="string")return E["ids:simpleValue"];if(typeof E.value=="string")return E.value}}return""}return""};for(const I of Ne(v.requirements))if(I&&typeof I=="object"){const $=I;let T=null,E=null;if(typeof $.propertyPath=="string"){const[q,G]=String($.propertyPath).split(".");T=q,E=G}else $.propertyPath&&typeof $.propertyPath=="object"?(T=$.propertyPath.pset??$.propertyPath.propertySet??$.propertySet??null,E=$.propertyPath.property??$.propertyPath.prop??$.property??$.propertyName??null):(T=$.propertySet??$.pset??null,E=$.baseName??$.property??$.prop??null);const z=N(T)||"Pset",U=N(E)||"Property",ue=At(z)||z,J=At(U)||U,Y={};if(Y["ids:propertySet"]={"ids:simpleValue":ue},Y["ids:baseName"]={"ids:simpleValue":J},($.operator??"equals")==="exists")Y["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if($.value!=null&&String($.value).trim()){let q=null;try{const G=typeof $.value=="string"?JSON.parse($.value):$.value;Array.isArray(G)&&(q=G.map(Ee=>String(Ee)))}catch{}q||typeof $.value=="string"&&$.value.includes(",")&&(q=$.value.split(",").map(G=>eo(G.trim())).filter(Boolean)),q&&q.length?Y["ids:allowedValues"]={"ids:values":{"ids:value":q.map(G=>({"ids:simpleValue":eo(String(G))}))}}:Y["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":eo(String($.value))}}}}S.push({"ids:property":Y})}const R={"@_ifcVersion":"IFC4","@_name":v.name??""};return d.length&&(R["ids:applicability"]={"ids:entity":d.map(I=>({"ids:name":I["ids:name"]?I["ids:name"]:I}))}),S.length&&(R["ids:requirements"]={"ids:property":S.map(I=>I["ids:property"])}),R})}},m=s.build(x);return m.startsWith("<?xml")?m:`<?xml version="1.0" encoding="UTF-8"?>
${m}`}const y={IdsCreator:{Specification:(e??[]).map(h=>({"@_id":h.id,Name:h.name,Description:h.description,Applicability:{__cdata:JSON.stringify(h.applicability??[])},Requirements:{__cdata:JSON.stringify(h.requirements??[])}}))}},c=s.build(y);return c.startsWith("<?xml")?c:`<?xml version="1.0" encoding="UTF-8"?>
${c}`},At=e=>e?e.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",eo=e=>!e||typeof e!="string"?e:e.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),Ar=e=>{if(e==null)return"";if(typeof e=="string")return eo(e.trim());if(typeof e=="number"||typeof e=="boolean")return String(e);try{return JSON.stringify(e)}catch{return String(e)}},Ss=e=>{if(!e)return{};const s={};for(const[i,y]of Object.entries(e)){if(!y||typeof y!="object")continue;const c=At(i)||i;for(const[h,x]of Object.entries(y)){const m=At(h)||h,v=`${c}.${m}`;v in s||(s[v]=Ar(x))}}return s};let Ye=null;const Es=()=>{Ye=null},js=e=>e.slice().sort().join("|"),vs=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],Ps=(e,s)=>{if(!e||typeof e!="object")return;const i=s.map(h=>h.toLowerCase()),y=new WeakSet,c=[e];for(;c.length;){const h=c.pop();if(!(!h||typeof h!="object")&&!y.has(h)){if(y.add(h),Array.isArray(h)){for(const x of h)x&&typeof x=="object"&&c.push(x);continue}for(const[x,m]of Object.entries(h)){const v=x.toLowerCase();if(i.some(d=>v.includes(d)))if(typeof m=="string"){const d=m.trim();if(d)return d}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const d=m;if(typeof d.value=="string"){const j=d.value.trim();if(j)return j}if(typeof d.Value=="string"){const j=d.Value.trim();if(j)return j}d.value&&typeof d.value=="object"&&c.push(d.value),d.Value&&typeof d.Value=="object"&&c.push(d.Value)}}m&&typeof m=="object"&&c.push(m)}}}},ks=e=>{if(!e||typeof e!="object")return null;const s=e;for(const y of vs){const c=s[y];if(typeof c=="string"&&c.trim().length)return c.trim()}return Ps(e,["globalid","global id","guid","uniqueid"])?.trim()??null},Zt=async(e,s,i)=>{console.log("🔍 [collectElementsDirect] START with",s.length,"globalIds"),console.log("🔍 [collectElementsDirect] Has getElementProps?",!!e.getElementProps);const y=[],c=Math.max(s.length,1);i?.onProgress?.({done:0,total:c});const h=e.getElementProps;console.log("🔍 [collectElementsDirect] Using getElementProps method");for(let x=0;x<s.length;x++){const m=s[x];try{const{ifcClass:v,psets:d,attributes:j}=await h.call(e,m),S=Ss(d);if("GlobalId"in S||(S.GlobalId=m),j)for(const[N,R]of Object.entries(j)){const $=`Attributes.${At(N)||N}`;$ in S||(S[$]=Ar(R))}S.ifcClass||(S.ifcClass=v),y.push({GlobalId:m,ifcClass:v,properties:S}),(x%50===0||x===s.length-1)&&i?.onProgress?.({done:y.length,total:c})}catch(v){console.warn(`IDS adapter (direct) failed to load element ${m}`,v)}}return i?.onProgress?.({done:y.length,total:c}),console.log("🔍 [collectElementsDirect] COMPLETE - returning",y.length,"elements"),y},As=async(e,s,i)=>{if(typeof e.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const y=Math.max(1,(navigator.hardwareConcurrency||4)-1);console.log(`🚀 Starting parallel property extraction with ${y} workers`);const c=[],h=[],x=[];for(let d=0;d<y;d++){const j=new Worker(new URL("/Fragments-AI-viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});c.push(j);const S=new Promise((N,R)=>{const I=T=>{const E=T.data;if(E){if(E.type==="error"){R(new Error(E.message||`Worker ${d} failed.`));return}if(E.type==="progress"){const z=x.reduce((U,ue)=>U+ue.length,0)+E.done;i?.onProgress?.({done:z,total:Math.max(s,z)});return}E.type==="done"&&(x[d]=E.elements??[],N(E.elements??[]))}},$=T=>{R(T.error??new Error(T.message||`Worker ${d} error.`))};j.addEventListener("message",I),j.addEventListener("error",$)});h.push(S),j.postMessage({type:"build-props",reset:!0,total:s})}i?.onProgress?.({done:0,total:s});const m=new Set;let v=0;try{for await(const d of e.iterElements({batchSize:128})){if(!Array.isArray(d)||!d.length)continue;const j=[];d.forEach(S=>{if(!S||typeof S!="object")return;const N=S.data;if(!N)return;const R=ks(N);if(!R||m.has(R))return;m.add(R);const I=typeof N.ifcClass=="string"?N.ifcClass:void 0;j.push({globalId:R,ifcClass:I,data:N})}),j.length&&(c[v].postMessage({type:"build-props",elements:j}),v=(v+1)%y)}}catch(d){throw c.forEach(j=>{j.postMessage({type:"cancel"}),j.terminate()}),d}c.forEach(d=>{d.postMessage({type:"build-props",final:!0})});try{const j=(await Promise.all(h)).flat();return console.log(`✅ Parallel processing complete: ${j.length} elements processed by ${y} workers`),i?.onProgress?.({done:j.length,total:Math.max(s,j.length)}),j}finally{c.forEach(d=>d.terminate())}},$s=async(e,s)=>{try{const i=typeof s.countElements=="function"?await s.countElements():void 0;return await Cs({modelUrl:e,extra:i!=null?String(i):void 0})}catch(i){return console.warn("IDS adapter: failed to compute model key for cache",i),null}},Ms=async(e,s)=>{if(console.log("🔍 [collectElementsForIds] START",{hasFilterGlobalIds:!!s?.filterGlobalIds,filterCount:s?.filterGlobalIds?.length}),!e)return console.log("🔍 [collectElementsForIds] No viewerApi"),[];let i;if(s?.filterGlobalIds&&s.filterGlobalIds.length>0)console.log("🔍 [collectElementsForIds] Using provided filterGlobalIds directly (skipping listGlobalIds)"),i=s.filterGlobalIds;else{console.log("🔍 [collectElementsForIds] Calling listGlobalIds...");const v=await e.listGlobalIds();console.log("🔍 [collectElementsForIds] Got all GlobalIds:",v.length),i=v}if(console.log("🔍 [collectElementsForIds] GlobalIds to validate:",i.length),!i.length)return console.log("🔍 [collectElementsForIds] No GlobalIds to process"),Ye=null,[];console.log("🔍 [collectElementsForIds] Building cache token...");const y=js(i);console.log("🔍 [collectElementsForIds] Token built:",y.substring(0,20)+"...");const c=Math.max(i.length,1);if(s?.onPhase?.("BUILDING_PROPERTIES"),s?.onProgress?.({done:0,total:c}),console.log("🔍 [collectElementsForIds] Checking memory cache..."),Ye&&Ye.token===y)return console.log("🔍 [collectElementsForIds] Memory cache HIT! Returning",Ye.elements.length,"elements"),Ye.elements;console.log("🔍 [collectElementsForIds] Memory cache MISS");const h=s?.filterGlobalIds&&s.filterGlobalIds.length>0;let x=null;if(h)console.log("🔍 [collectElementsForIds] Skipping persistent cache (filtering mode)");else if(console.log("🔍 [collectElementsForIds] Resolving persistent key..."),x=await $s(y,e),console.log("🔍 [collectElementsForIds] Persistent key:",x),x){console.log("🔍 [collectElementsForIds] Checking IndexedDB cache...");try{const v=await $o.get(x);if(console.log("🔍 [collectElementsForIds] IndexedDB returned:",v?.length||0,"elements"),v&&v.length){const d=await $o.getMetadata(x),j=d?Math.round((Date.now()-d.timestamp)/1e3/60):0;return console.log(`⚡ Using cached elements from IndexedDB: ${v.length} elements (cached ${j} minutes ago)`),s?.onProgress?.({done:v.length,total:c}),Ye={token:y,elements:v},v}console.log("🔍 [collectElementsForIds] IndexedDB cache MISS or empty")}catch(v){console.warn("IDS adapter: failed to read cached elements from IndexedDB",v)}}let m=[];if(console.log("🔍 [collectElementsForIds] Decision point:",{isFiltering:h,willUseDirect:h,globalIdsCount:i.length}),h)console.log(`📌 Filtering mode: collecting ${i.length} specific elements directly`),console.log("🔍 [collectElementsForIds] Calling collectElementsDirect..."),m=await Zt(e,i,s),console.log("🔍 [collectElementsForIds] collectElementsDirect returned:",m.length,"elements");else{console.log("🔍 [collectElementsForIds] Full model mode - using workers");const v=typeof e.countElements=="function"?await e.countElements().catch(()=>i.length):i.length;if(console.log("🔍 [collectElementsForIds] Total elements:",v),typeof e.iterElements=="function")try{console.log("🔍 [collectElementsForIds] Calling buildWithWorker..."),m=await As(e,v??i.length,s),console.log("🔍 [collectElementsForIds] buildWithWorker returned:",m.length,"elements"),m.length||(console.log("🔍 [collectElementsForIds] No elements from worker, falling back to direct"),m=await Zt(e,i,s))}catch(d){console.warn("IDS adapter: property build worker failed, falling back to direct collection",d),m=await Zt(e,i,s)}else console.log("🔍 [collectElementsForIds] iterElements not available, using direct"),m=await Zt(e,i,s)}return x&&m.length&&$o.set(x,m).catch(v=>console.warn("IDS adapter: failed to persist elements cache",v)),Ye={token:y,elements:m},s?.onProgress?.({done:Math.min(m.length,c),total:c}),m},Rs={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let nt=Rs;const Ro=new Set;let rt=null;const zs=()=>{Ro.forEach(e=>{try{e()}catch(s){console.error("IDS store listener error",s)}})},se=e=>{nt=e(nt),zs()};let Ke=null,to=null;const Fs=()=>(Ke||(Ke=new Worker(new URL("/Fragments-AI-viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),Ke),Ds=(e,s)=>{const i=Fs(),y=new Promise((c,h)=>{const x=v=>{const d=v.data;if(d){if(d.type==="error"){i.removeEventListener("message",x),i.removeEventListener("error",m),h(new Error(d.message||"IDS worker failed"));return}if(d.type==="phase"){s?.onPhase?.(d.label);return}if(d.type==="progress"){s?.onProgress?.(d);return}if(d.type==="done"){i.removeEventListener("message",x),i.removeEventListener("error",m),c(d);return}}},m=v=>{i.removeEventListener("message",x),i.removeEventListener("error",m),h(v.error??new Error(v.message))};i.addEventListener("message",x),i.addEventListener("error",m),i.postMessage(e)});return to=y.finally(()=>{to=null}),y},Cr=()=>{se(e=>({...e,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},ae={subscribe:e=>(Ro.add(e),()=>Ro.delete(e)),getState:()=>nt,setIdsXmlText:(e,s)=>{const i=e.replace(/\uFEFF/g,"").trim(),y=s?.fileNames??[];se(c=>({...c,idsXmlText:i,idsFileNames:y,error:null})),Cr()},appendDocuments:e=>{if(!e.length)return;const s=ae.getState(),i=[];s.idsXmlText.trim().length&&i.push(s.idsXmlText.trim()),i.push(...e.map(h=>h.content.trim()).filter(Boolean));const y=i.join(`

`),c=[...s.idsFileNames,...e.map(h=>h.name)];ae.setIdsXmlText(y,{fileNames:c})},clearResults:()=>{Cr()},setValidationMode:e=>{se(s=>({...s,validationMode:e}))},filterRows:(e,s)=>{se(i=>{if(!e)return{...i,filteredRows:i.rows,filterDescription:null};const y=i.rows.filter(c=>{try{return e(c)}catch(h){return console.warn("IDS filter predicate threw an error",h),!0}});return{...i,filteredRows:y,filterDescription:s??null}})},runCheck:async e=>{if(!e){se(c=>({...c,error:"Viewer API is not available."}));return}if(nt.isChecking){await to;return}const s=nt.idsXmlText.trim();if(!s){se(c=>({...c,error:"Load at least one IDS XML file before running the check."}));return}let i;if(nt.validationMode==="selected")if(console.log("🎯 Selected Only mode is active"),e.getSelectedGlobalIds){if(console.log("🎯 Getting selected GlobalIds..."),i=await e.getSelectedGlobalIds(),console.log("🎯 Selected GlobalIds:",i),!i||i.length===0){console.error("❌ No elements selected"),se(c=>({...c,error:"No elements selected. Please select elements or switch to another mode."}));return}console.log(`🎯 Validating ${i.length} selected elements`)}else{console.warn("⚠️ getSelectedGlobalIds not available on viewerApi"),se(c=>({...c,error:"Selected elements validation is not supported by this viewer."}));return}else if(nt.validationMode==="visible")if(console.log("👁️ Visible Only mode is active"),e.getVisibleGlobalIds){if(console.log("👁️ Getting visible GlobalIds..."),i=await e.getVisibleGlobalIds(),console.log("👁️ Visible GlobalIds:",i),!i||i.length===0){console.error("❌ No visible elements found"),se(c=>({...c,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}console.log(`👁️ Validating ${i.length} visible elements`)}else{console.warn("⚠️ getVisibleGlobalIds not available on viewerApi"),se(c=>({...c,error:"Visible elements validation is not supported by this viewer."}));return}se(c=>({...c,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),rt=new AbortController;const y=rt.signal;try{if(y.aborted)throw new Error("Validation cancelled");const c=await Ms(e,{filterGlobalIds:i,onPhase:d=>{se(j=>({...j,phase:d}))},onProgress:d=>{se(j=>({...j,progress:d}))}});if(!c.length)throw new Error("No IFC elements were found in the current viewer.");if(y.aborted)throw new Error("Validation cancelled");se(d=>({...d,phase:"CHECKING_IDS",progress:null}));const h={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},x=await Ds({type:"validate",idsXml:s,elements:c},{onPhase:d=>{const j=h[d];j&&se(S=>({...S,phase:j}))},onProgress:d=>{se(j=>({...j,progress:{done:d.done,total:d.total}}))}}),m=x.rules??[],v=x.rows??[];if(i&&i.length>0&&typeof e.addToCache=="function"){console.log(`📦 Adding ${i.length} validated elements to cache...`);try{await e.addToCache(i),console.log("📦 Successfully updated cache with validated elements")}catch(d){console.warn("📦 Failed to add elements to cache:",d)}}se(d=>({...d,isChecking:!1,rules:m,rows:v,filteredRows:v,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),rt=null}catch(c){const h=c instanceof Error?c.message:"Failed to run IDS validation.";console.error("IDS run failed",c),se(x=>({...x,isChecking:!1,error:h,phase:"ERROR",progress:null})),rt=null}},invalidateCaches:()=>{Es(),Ke&&(Ke.terminate(),Ke=null,to=null),se(e=>({...e,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{console.log("🛑 Cancelling IDS validation..."),rt&&(rt.abort(),rt=null),Ke&&Ke.postMessage({type:"cancel"}),se(e=>({...e,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},Ts=e=>g.useSyncExternalStore(ae.subscribe,()=>e({...ae.getState(),...ae}),()=>e({...ae.getState(),...ae})),Ns=e=>g.useSyncExternalStore(ae.subscribe,()=>e(ae.getState()),()=>e(ae.getState())),Ls=()=>{const e=g.useCallback(ae.setIdsXmlText,[]),s=g.useCallback(ae.appendDocuments,[]),i=g.useCallback(ae.clearResults,[]),y=g.useCallback(ae.filterRows,[]),c=g.useCallback(ae.runCheck,[]),h=g.useCallback(ae.setValidationMode,[]),x=g.useCallback(ae.cancelValidation,[]);return{setIdsXmlText:e,appendDocuments:s,clearResults:i,filterRows:y,runCheck:c,setValidationMode:h,cancelValidation:x,invalidateCaches:ae.invalidateCaches}},$r=ae,Os=Object.freeze(Object.defineProperty({__proto__:null,idsStore:$r,useIdsActions:Ls,useIdsStore:Ts,useIdsStoreSelector:Ns},Symbol.toStringTag,{value:"Module"})),Vs=mt.lazy(()=>pt(()=>import("./ChatWindow-9MKqMghO.js"),__vite__mapDeps([0,1]))),_s=mt.lazy(()=>pt(()=>import("./IdsPanel-DW1gVJWR.js"),__vite__mapDeps([2,1,3,4]))),Bs=mt.lazy(()=>pt(()=>import("./IdsCreatorPanel-CXSrvxaA.js"),__vite__mapDeps([5,1,3,4]))),Gs=mt.lazy(()=>pt(()=>import("./ModelFilterPanel-CE8EtkUn.js"),__vite__mapDeps([6,1]))),Sr=(e,s)=>{if(e.length!==s.length)return!1;for(let i=0;i<e.length;i+=1){const y=e[i],c=s[i];if(!c||y.modelId!==c.modelId||y.localId!==c.localId)return!1}return!0},Ws={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Us=(e,s)=>{if(!e)return s;const i=[e.ifcCategory,e.Category,e.category,e.ifcClass,e.class,e.type,e.Type,e.system,e.System];for(const y of i)if(typeof y=="string"&&y.trim())return y.trim();if(Array.isArray(e.categories)&&e.categories.length){const y=e.categories.find(c=>typeof c=="string"&&c.trim());if(y)return y.trim()}return typeof e.name=="string"&&e.name.trim()?e.name.trim():typeof e.Name=="string"&&e.Name.trim()?e.Name.trim():typeof e.label=="string"&&e.label.trim()?e.label.trim():s},Hs=(e,s,i)=>{const y=new Map;let c=0,h=0,x=0;i.traverse(S=>{const N=!!S?.isInstancedMesh,R=!!S?.isMesh;if(!N&&!R)return;let I=0;if(N){let E=0;typeof S.count=="number"?E=S.count:typeof S.instanceCount=="number"?E=S.instanceCount:Array.isArray(S.instanceIdMap)?E=S.instanceIdMap.length:Array.isArray(S.userData?.ids)?E=S.userData.ids.length:typeof S.userData?.size=="number"&&(E=S.userData.size),Number.isFinite(E)&&E>0&&(I=E,h+=E)}else I=1,x+=1;I<=0&&(I=1),c+=I;const $=Us(S?.userData??{},S?.type??"Mesh"),T=y.get($)??0;y.set($,T+I)});const m=Array.from(y.entries()).map(([S,N])=>({category:S,count:N})).sort((S,N)=>N.count-S.count),v=new qe().setFromObject(i),d=new K,j=new K;return v.getSize(d),v.getCenter(j),{modelId:e,label:s,elementCount:c,instancedCount:h,meshCount:x,categoryCounts:m,bboxSize:{x:d.x,y:d.y,z:d.z},bboxCenter:{x:j.x,y:j.y,z:j.z},collectedAt:Date.now()}},qs=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),Le=e=>{if(!e)return"";let s=e.replace(/[_\-]+/g," ");return s=s.replace(/([a-z\d])([A-Z])/g,"$1 $2"),s=s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),s=s.replace(/\s+/g," ").trim(),s?s.split(" ").map(y=>{const c=y.toUpperCase();return qs.has(c)||c.length<=3&&/^[A-Z]+$/.test(c)?c:/^\d+(\.\d+)?$/.test(y)||!y.length?y:y.charAt(0).toUpperCase()+y.slice(1)}).join(" "):""},Ys=(e,s=200)=>e?e.length<=s?e:`${e.slice(0,s)}…`:"",Ce=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const s=JSON.stringify(e);return s?s.length>500?`${s.slice(0,500)}…`:s:""}catch{return String(e)}},Se=e=>e==null?"":typeof e!="object"?Ce(e):"value"in e?Se(e.value):"Value"in e?Se(e.Value):Array.isArray(e)?e.map(s=>Se(s)).filter(Boolean).join(", "):typeof e.x=="number"&&typeof e.y=="number"&&typeof e.z=="number"?`${Ce(e.x)}, ${Ce(e.y)}, ${Ce(e.z)}`:Ce(e),de=(e,s)=>{if(!e||typeof e!="object")return;const i=s.map(h=>h.toLowerCase()),y=new WeakSet,c=[e];for(;c.length;){const h=c.pop();if(!(!h||typeof h!="object")&&!y.has(h)){if(y.add(h),Array.isArray(h)){for(const x of h)x&&typeof x=="object"&&c.push(x);continue}for(const[x,m]of Object.entries(h)){const v=x.toLowerCase();if(i.some(d=>v.includes(d)))if(typeof m=="string"){const d=m.trim();if(d)return d}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const d=Se(m);if(d)return d}}m&&typeof m=="object"&&c.push(m)}}}},Ks=(e,s)=>{if(!e||typeof e!="object")return oo(e,300);const i=[],y=Re(e)??de(e,["name","label","description"]);y&&i.push(`name:${y}`);const c=de(e,["category","ifcclass","ifc type","type"]);c&&i.push(`category:${c}`);const h=de(e,["globalid","global id","guid"]);h&&i.push(`globalId:${h}`);const x=de(e,["expressid","express id"]);if(x&&x!==h&&i.push(`expressId:${x}`),s>0)try{const{rows:v}=Pt(e);if(v.length){const j=v.slice(0,s).map(S=>`${S.label}=${S.value}`).join(" | ");j&&i.push(`props:${j}`),v.length>s&&i.push(`propsTruncated:${v.length-s}`)}}catch(v){console.warn("Failed to build detailed property data for AI summary",v)}const m=i.filter(Boolean).join(" | ");return m?m.length>1200?`${m.slice(0,1200)}…`:m:oo(e,300)},Er={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},Xs=new Set(["modelIdMap"]),ft=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),He=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",kt=["HasProperties","hasProperties","Properties","properties"],Mo=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],jr=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Qt=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSET"?!0:kt.some(i=>Array.isArray(e[i]))},Mr=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in e||"nominalValue"in e},Js=e=>{if(!e||typeof e!="object")return Ce(e);const s=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const i of s){if(!(i in e))continue;const y=e[i];if(y==null)continue;if(Array.isArray(y)){const h=y.map(x=>Se(x)).filter(Boolean).join(", ");if(h)return h;continue}const c=Se(y);if(c)return c}for(const[i,y]of Object.entries(e))if((typeof y=="string"||typeof y=="number"||typeof y=="boolean")&&i.toLowerCase().includes("value")){const c=Ce(y);if(c)return c}return""},Zs=(e,s,i)=>{const y=kt.map(m=>Array.isArray(e[m])?e[m]:null).filter(m=>!!m);if(!y.length)return[];const c=Le(s)||s,h=[],x=new Map;return y.flat().forEach((m,v)=>{if(!m||typeof m!="object"||!Mr(m))return;const d=Re(m)??(typeof m.Name=="string"?m.Name:void 0)??(typeof m.PropertyName=="string"?m.PropertyName:void 0),j=`Property ${v+1}`,S=d&&d.trim().length?d.trim():j,N=Le(S)||S,R=Js(m),I=ft(S)||"property",$=(x.get(I)??0)+1;x.set(I,$);const T=`${I}-${$}`,E=`Property Sets / ${c} / ${N}`,z=[E.toLowerCase()];R&&z.push(R.toLowerCase()),h.push({label:E,value:R||"",path:`property-sets/${i}/${T}`,searchText:z.join(" ").trim(),rawPsetName:s,rawPropertyName:S,rawValue:m.__rawValue??m})}),h},vt=e=>{if(!e||typeof e!="object")return[];const s=[],i=new WeakSet,y=new Map,c=R=>{let I;if(typeof R=="string"){const z=R.trim();z.length&&(I=z)}!I&&R&&typeof R=="object"&&(I=Re(R)??(typeof R.Name=="string"?R.Name:void 0)??(typeof R.id=="string"?R.id:void 0)),(!I||!I.length)&&(I="Property Set");const $=Le(I)||I,T=ft(I)||"property-set",E=(y.get(T)??0)+1;return y.set(T,E),{rawName:I,friendlyName:$,uniqueKey:`${T}-${E}`}},h=(R,I,$)=>{const T=`Property ${$+1}`,E=R?.trim?.()?R.trim():T;if(Mr(I)){const z={...I};return z.Name==null&&z.PropertyName==null&&(z.Name=E),z.PropertyName==null&&(z.PropertyName=z.Name??E),z.__rawValue==null&&(z.__rawValue=I),z}if(I&&typeof I=="object"){const z={...I};return z.Name==null&&z.PropertyName==null&&(z.Name=E),z.PropertyName==null&&(z.PropertyName=z.Name??E),z.type==null&&z.Type==null&&(z.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in z)&&!("nominalValue"in z)&&!("Value"in z)&&!("value"in z)&&(z.NominalValue=I),z.__rawValue=I,z}return{type:"IFCPROPERTYSINGLEVALUE",Name:E,PropertyName:E,NominalValue:I,__rawValue:I}},x=(R,I)=>{const $=[],T=(E,z)=>{const U=`Property ${$.length+1}`,ue=(typeof E=="string"&&E.trim().length?E.trim():void 0)??Re(E)??(typeof E?.Name=="string"?E.Name:void 0)??(typeof E?.PropertyName=="string"?E.PropertyName:void 0)??U;$.push(h(ue,z,$.length))};if(I&&typeof I=="object")for(const E of kt){const z=I[E];Array.isArray(z)&&z.length&&z.forEach(U=>T(U,U))}if(!$.length)if(Array.isArray(I))I.forEach(E=>T(E,E));else if(I&&typeof I=="object")for(const[E,z]of Object.entries(I))z!=null&&(jr.has(E)||kt.includes(E)||Mo.includes(E)||T(E,z));else I!=null&&T(void 0,I);return{type:"IFCPROPERTYSET",Name:R,HasProperties:$}},m=(R,I)=>{const T=Zs(I&&typeof I=="object"?I:{},R.rawName,R.uniqueKey);T.length&&s.push(...T)},v=R=>{if(!(!R||typeof R!="object")&&!i.has(R)){if(i.add(R),Array.isArray(R)){R.forEach(I=>{if(!I||typeof I!="object")return;const $=c(I),T=Qt(I)?I:x($.rawName,I);m($,T),T&&typeof T=="object"&&i.add(T)});return}for(const[I,$]of Object.entries(R)){if($==null)continue;const T=c(I),E=Qt($)?$:x(T.rawName,$);m(T,E),$&&typeof $=="object"&&i.add($)}}},d=R=>{if(!R||typeof R!="object"||i.has(R))return;if(i.add(R),Array.isArray(R)){R.forEach(d);return}let I=!1;for(const $ of Mo)Object.prototype.hasOwnProperty.call(R,$)&&(v(R[$]),I=!0);if(Qt(R)){const $=c(R);m($,R)}!I&&!Qt(R)&&Object.entries(R).forEach(([$,T])=>{Mo.includes($)||jr.has($)||kt.includes($)||T&&typeof T=="object"&&d(T)})};d(e);const j=new Map,S=new Set;for(const R of s){const I=`${R.label}::${R.value}`;if(S.has(I))continue;const $=`${R.rawPsetName||"unknown"}::${R.rawPropertyName||"unknown"}::${R.value}`;j.has($)||(S.add(I),j.set($,R))}const N=Array.from(j.values());return s.length,N.length,N},Ie={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},vr=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],Qs=(e,s)=>{const i=typeof e=="string"?e.trim().toLowerCase():"";if(i&&vr.some(y=>i.startsWith(y)))return!0;if(s&&typeof s=="object"){const y=Se(s._category??s.category??s.Category??null),c=typeof y=="string"?y.trim().toLowerCase():"";if(c&&vr.some(x=>c.startsWith(x))||(s.NominalValue!=null||s.nominalValue!=null)&&(s.Name!=null||s.PropertyName!=null)&&i.includes("property"))return!0}return!1},Pr="fragmentsViewer.favoritePropertyPaths",el=1e4,tl=500,Re=e=>{if(!e||typeof e!="object")return;let s,i;typeof e.Name=="string"?s=e.Name:e.Name&&typeof e.Name=="object"&&(s=Se(e.Name)||void 0),typeof e.name=="string"?i=e.name:e.name&&typeof e.name=="object"&&(i=Se(e.name)||void 0);const y=s??i;if(!y)return;const c=y.trim();return c.length?c:void 0},Pt=e=>{if(!e||typeof e!="object")return{rows:[],tree:[]};const s=[],i=new WeakSet,y=(x,m,v)=>{if(x==null)return null;const d=m.map(E=>{const z=E?.trim?.()??E;return typeof z=="string"&&z.length?Le(z)||z:typeof E=="string"?E:String(E??"")}),j=d.filter(Boolean).join(" / "),S=v.length?v.join("/"):ft(j||"value"),N=d[d.length-1]??"Value",R=E=>{const z=j.toLowerCase(),U=[z];E&&U.push(E.toLowerCase());const ue=U.join(" ").trim()||z,J={label:j,value:E??"",path:S,searchText:ue};return s.push(J),ue};if(typeof x!="object"||x instanceof Date){const E=Ce(x),z=R(E);return{id:S,label:N,fullLabel:j,value:E||void 0,children:[],searchText:z}}if(i.has(x)){const E="[Circular reference]",z=R(E);return{id:S,label:N,fullLabel:j,value:E,children:[],searchText:z}}i.add(x);let I;const $=[];if(Array.isArray(x))x.forEach((E,z)=>{const U=Re(E),ue=`${N} ${z+1}`,J=U&&U.trim().length?U.trim():ue,Y=Le(J)||J,Q=U&&U.trim().length?ft(U):String(z),q=y(E,[...m,Y],[...v,Q]);q&&$.push(q)}),$.length===0&&(I=Ce(x));else{if("NominalValue"in x||"nominalValue"in x){const E=x.NominalValue??x.nominalValue,z=Se(E);z&&(I=z)}!I&&"value"in x&&typeof x.value!="object"&&(I=Ce(x.value)),!I&&"Value"in x&&typeof x.Value!="object"&&(I=Ce(x.Value));for(const[E,z]of Object.entries(x)){if(z==null||E==="Name"||E==="name"||E==="IsDefinedBy"||E==="isDefinedBy"||E==="psets"||E==="Psets"||E==="propertySets"||E==="PropertySets"||E==="property_sets"||E==="Property_Sets")continue;if(E==="NominalValue"||E==="nominalValue"){const Ee=Le("Nominal Value")||"Nominal Value",me=y(z,[...m,Ee],[...v,"nominal-value"]);me&&$.push(me);continue}const U=Er[E]??E,ue=Le(U)||U,J=Re(z)?.trim(),Y=J&&J.length?Le(J)||J:ue,Q=J&&J.length?ft(J):ft(U),q=[...m,Y],G=y(z,q,[...v,Q]);G&&$.push(G)}!I&&$.length===0&&(I=Ce(x))}const T=R(I);return{id:S,label:N,fullLabel:j,value:I,children:$,searchText:T}},c=[];for(const[x,m]of Object.entries(e)){if(m==null||Xs.has(x))continue;const v=Er[x]??x,d=y(m,[v],[x]);d&&c.push(d)}if(s.length){const x=s.filter(m=>{const v=m.label.toLowerCase();return v.startsWith("property sets /")?!(v.includes("/ has properties")||v.includes("/ nominal value")):!0});x.length!==s.length&&s.splice(0,s.length,...x)}const h=vt(e);if(h.length){const x=[],m=new Set;for(const d of h)m.has(d.path)||(m.add(d.path),x.push(d));const v=[];for(const d of s)m.has(d.path)||v.push(d);s.splice(0,s.length,...x,...v)}return{rows:s,tree:c}},ol=()=>{const e=g.useRef(null),s=g.useRef(null),i=g.useRef(null),y=g.useRef(null),c=g.useRef(null),h=g.useRef(!1),x=g.useRef(null),m=g.useRef(null),v=g.useRef(null),[d,j]=g.useState(!1),[S,N]=g.useState([]),[R,I]=g.useState(!1),[$,T]=g.useState(50);g.useCallback(async(t,o)=>{{console.warn("dumpModelRawData is dev-only.");return}},[S]),g.useCallback(async(t,o=50,r=128)=>{},[]);const[E,z]=g.useState([]),[U,ue]=g.useState(null),[J,Y]=g.useState(!0),[Q,q]=g.useState(!1),[G,Ee]=g.useState(!1),[me,Oe]=g.useState(null),[gt,ze]=g.useState(!1),[fe,Fe]=g.useState(!1),ht=g.useRef(null),Ve=g.useRef(!1),je=g.useRef(null),ve=g.useRef(null),$t=g.useRef(0),De=g.useRef(null),Mt=g.useRef(null),_e=g.useRef(null),[Rt,Rr]=g.useState({width:360,height:520}),ro=g.useRef(null),zt=g.useRef(!1),no=g.useRef(null),zo=g.useRef(!1),Fo=g.useRef(null),Xe=g.useRef(null),so=g.useRef(null),Ft=g.useRef(null),lo=g.useRef(null),yt=g.useRef(null),Do=g.useRef(null),To=g.useRef(null),Be=g.useRef(null),Te=g.useRef([]),Pe=g.useRef(null),bt=g.useRef(null),st=g.useRef(null),[Dt,be]=g.useState(null),[oe,zr]=g.useState([]),[No,Fr]=g.useState(""),[lt,Dr]=g.useState(""),[ge,Lo]=g.useState([]),[Je,Oo]=g.useState("favorites"),[Tt,Tr]=g.useState(!1),[Ze,Nr]=g.useState(!1),[Qe,Lr]=g.useState(!1),[xt,io]=g.useState(!1),[Or,Vo]=g.useState(0),[it,Nt]=g.useState(!1),[Vr,ao]=g.useState(0),[at,co]=g.useState(!1),[_o,_r]=g.useState({}),[uo,Bo]=g.useState(null),[wt,Go]=g.useState([]),[Br,fo]=g.useState(!1),[Ge,Wo]=g.useState("selected"),[We,Lt]=g.useState(""),[et,Uo]=g.useState(!1),[Ho,Ot]=g.useState(null),[Gr,qo]=g.useState(!1),[ee,Vt]=g.useState({x:!1,y:!1,z:!1}),[ke,Yo]=g.useState({x:0,y:0,z:0}),[It,Ko]=g.useState(!1),[Ct,Wr]=g.useState(!1),_t=g.useRef(!1),po=g.useRef([]),mo=g.useRef(new Map),Bt=g.useRef(null),[Xo,Jo]=g.useState(null),tt=g.useCallback(()=>i.current?.camera??null,[]),Zo=g.useCallback(()=>tt()?.three??null,[tt]);g.useEffect(()=>{try{const t=window.localStorage.getItem(Pr);if(!t)return;const o=JSON.parse(t);if(!Array.isArray(o))return;const r=o.filter(l=>typeof l=="string"&&l.trim().length>0);r.length&&Lo(r)}catch(t){console.warn("Failed to restore favourites from storage",t)}},[]),g.useEffect(()=>{try{window.localStorage.setItem(Pr,JSON.stringify(ge))}catch(t){console.warn("Failed to persist favourites to storage",t)}},[ge]);const Gt=No.trim(),Ur=Gt.length>0,Qo=g.useMemo(()=>{const t=Gt.toLowerCase();return t?oe.filter(o=>o.searchText.includes(t)).slice(0,tl):[]},[Gt,oe]),Wt=g.useMemo(()=>{const t=new Map;return oe.forEach(o=>t.set(o.path,o)),t},[oe]),go=g.useMemo(()=>oe.slice(0,el),[oe]),er=Math.max(oe.length-go.length,0),tr=g.useMemo(()=>new Set(ge),[ge]),ho=g.useMemo(()=>ge.length?ge.map(t=>Wt.get(t)).filter(t=>!!t):[],[ge,Wt]),yo=g.useMemo(()=>{if(!ge.length)return 0;let t=0;for(const o of ge)Wt.has(o)||(t+=1);return t},[ge,Wt]),or=g.useCallback(t=>{Lo(o=>o.includes(t)?o.filter(r=>r!==t):[...o,t])},[]),Ut=g.useMemo(()=>S.map(t=>`${t.id}:${t.label}`).join("|"),[S]),bo=g.useCallback(t=>{const o=tr.has(t.path);return n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[n.jsx(X,{variant:"body2",sx:{fontWeight:600},children:t.label}),n.jsx(ie,{title:o?"Remove from favourites":"Add to favourites",children:n.jsx("span",{children:n.jsx(ne,{size:"small",onClick:()=>or(t.path),color:o?"primary":"default",children:o?n.jsx(En,{fontSize:"small"}):n.jsx(jn,{fontSize:"small"})})})})]}),n.jsx(X,{variant:"body2",color:"text.secondary",children:t.value?Ys(t.value,360):"—"})]},t.path)},[tr,or]);g.useEffect(()=>{if(!S.length){Lt("");return}Lt(t=>t&&S.some(o=>o.id===t)?t:S[0].id)},[S]);const rr=g.useCallback(async t=>{const o=c.current;if(!o)return[];const r=o.list.get(t);if(!r)return[];let l=[];try{const u=await r.getLocalIds();Array.isArray(u)?l=u:u&&typeof u[Symbol.iterator]=="function"&&(l=Array.from(u))}catch(u){return console.warn(`Failed to retrieve local IDs for model ${t}`,u),[]}if(!l.length)return[];const a=32,p=[];for(let u=0;u<l.length;u+=a){const C=l.slice(u,u+a);let b=[];try{b=await r.getItemsData(C,Ie)}catch(f){console.warn(`Failed to fetch items data for model ${t} chunk starting at ${C[0]}`,f);continue}b.forEach((f,w)=>{const P=C[w];if(f)try{const{rows:F}=Pt(f);F.forEach(M=>{p.push({path:`localId:${P} / ${M.label}`,value:M.value})})}catch(F){console.warn(`Failed to process properties for model ${t} localId ${P}`,F)}})}return p},[]),nr=g.useCallback(t=>{const o=[];return o.push("Path,Value"),t.forEach(({path:r,value:l})=>{const a=r.replace(/"/g,'""'),p=(l??"").replace(/"/g,'""');o.push(`"${a}","${p}"`)}),o.join(`\r
`)},[]),Hr=g.useCallback(()=>{Ot(null),Wo(oe.length?"selected":"model"),S.length&&!S.some(t=>t.id===We)&&Lt(S[0].id),fo(!0)},[oe.length,S,We]),qr=g.useCallback(async()=>{if(!U){alert("No element selected");return}try{const t=new WeakSet,o=JSON.stringify(U,(r,l)=>{if(typeof l=="object"&&l!==null){if(t.has(l))return"[Circular Reference]";t.add(l)}return l instanceof Map?`[Map with ${l.size} entries]`:l instanceof Set?`[Set with ${l.size} items]`:l instanceof WeakMap||l instanceof WeakSet?"[WeakMap/WeakSet]":typeof l=="function"?"[Function]":typeof l=="symbol"?"[Symbol]":l},2);await navigator.clipboard.writeText(o),alert("Raw element data copied to clipboard!")}catch(t){console.error("Failed to copy raw data:",t),alert("Failed to copy data to clipboard. See console for details.")}},[U]),sr=g.useCallback(()=>{et||(fo(!1),Ot(null))},[et]),Yr=g.useCallback(async()=>{if(!et){Uo(!0),Ot(null);try{let t=[];if(Ge==="selected"){if(!oe.length)throw new Error("No properties available for the current selection.");t=oe.map(C=>({path:C.label,value:C.value}))}else{if(!We)throw new Error("Select a model to export.");if(t=await rr(We),!t.length)throw new Error("No properties were found for the chosen model.")}const o=nr(t),r=new Blob([o],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(r),a=document.createElement("a"),p=Ge==="selected"?"selection":`model-${We}`,u=new Date().toISOString().replace(/[:.]/g,"-");a.href=l,a.download=`fragment-properties-${p}-${u}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l),fo(!1)}catch(t){console.warn("Failed to export properties",t),Ot(t.message??"Failed to export properties.")}finally{Uo(!1)}}},[nr,We,Ge,rr,et,oe]),Ae=g.useCallback(t=>{const o=t??null;ue(o);const{rows:r}=Pt(o);if(zr(r),Oo(ge.length?"favorites":"all"),r.length){Go(r.map(p=>({path:p.label,value:p.value})));const l="Path	Value",a=r.map(p=>`${p.label}	${p.value??""}`);Bo([l,...a].join(`\r
`))}else Go([]),Bo(null)},[ge.length]),Kr=g.useCallback(()=>{co(t=>!t)},[]),Xr=g.useCallback(()=>{io(!0),Vo(t=>t+1)},[]),Jr=g.useCallback(()=>{io(!1)},[]),Zr=g.useCallback(()=>{io(t=>{const o=!t;return o&&Vo(r=>r+1),o})},[]),St=g.useCallback(t=>{if(!t||typeof t!="object")return"IfcProduct";if(t.constructor&&typeof t.constructor.name=="string"&&t.constructor.name.toUpperCase().startsWith("IFC")){const a=t.constructor.name.trim();if(a!=="Object"&&a!=="Array")return a}const o=Se(t._category??t.category??t.Category??null);if(o&&o.trim().length&&o.toUpperCase().startsWith("IFC"))return o.trim();const r=[t.expressID!==void 0?null:t.type,t.ifcClass,t.IfcClass,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.ifcType,t.IfcType,t?.attributes?.ifcClass,t?.Attributes?.IfcClass];for(const a of r)if(typeof a=="string"&&a.trim().length){const p=a.trim();if(p.toUpperCase().startsWith("IFC")&&!p.toUpperCase().includes("IDENTIFIER")&&!p.toUpperCase().includes("LABEL")&&!p.toUpperCase().includes("TEXT"))return p}const l=de(t,["ifcclass","ifc type","express type"]);return l&&l.toUpperCase().startsWith("IFC")?l:"IfcProduct"},[]),xo=g.useCallback((t,o,r)=>{const l={},a={},p={};vt(t).forEach(w=>{const P=w.label.split("/").map(V=>V.trim()),F=w.rawPsetName??P[1]??"",M=w.rawPropertyName??P[P.length-1]??"",k=He(F),A=He(M);if(!k||!A)return;a[k]||(a[k]={}),A in a[k]||(a[k][A]=w.value);const _=`${k}.${A}`;_ in l||(l[_]=w.value)}),l.GlobalId=o,l.ifcClass=r,p.ifcClass=r,p.GlobalId=o,l["Attributes.GlobalId"]=o,l["Attributes.IfcClass"]=r,l["Attributes.ifcClass"]=r;const C=Re(t);C&&(p.Name=C,l["Attributes.Name"]=C);const b=de(t,["category","ifccategory"]);b&&(p.Category=b,l["Attributes.Category"]=b);const f=de(t,["type","typename"]);f&&(p.Type=f,l["Attributes.Type"]=f);for(const[w,P]of Object.entries(t??{})){if(P==null||typeof P!="object"||Array.isArray(P))continue;const F=Se(P);if(!F)continue;const M=String(w).replace(/^_+/,""),k=`Attributes.${Le(M)}`;if(k in l||(l[k]=F),M in p||(p[M]=F),/guid|globalid|_guid/i.test(w)){const A=String(F).trim();A&&!l.GlobalId&&(l.GlobalId=A,p.GlobalId=A)}}return{flattened:l,psets:a,attributes:p}},[]),wo=g.useCallback(()=>{const t=c.current;return t?`${Array.from(t.list.keys()).sort().join("|")}|${S.length}`:"empty"},[S]),Qr=g.useCallback(async()=>{console.log("🔑 [computeModelSignature] START");const t=c.current;if(!t||t.list.size===0)return console.log("⚠️ [computeModelSignature] No fragments available"),{signature:"empty",elementCount:0,modelFiles:[]};console.log(`📊 [computeModelSignature] Found ${t.list.size} models in fragments`);const o=Array.from(t.list.keys()).sort();console.log("🔑 [computeModelSignature] Model IDs:",o);const r=S.map(C=>({id:C.id,name:C.label}));console.log("📁 [computeModelSignature] Model files:",r),console.log("🔢 [computeModelSignature] Counting elements across all models...");let l=0;for(const[C,b]of t.list){console.log(`🔍 [computeModelSignature] Getting local IDs for model ${C}...`);try{const f=await b.getLocalIds();console.log(`✅ [computeModelSignature] Got local IDs for model ${C}, type:`,typeof f);const w=Array.isArray(f)?f:f&&typeof f[Symbol.iterator]=="function"?Array.from(f):[];console.log(`📊 [computeModelSignature] Model ${C} has ${w.length} elements`),l+=w.length}catch(f){console.error(`❌ [computeModelSignature] Failed to count elements in model ${C}`,f)}}console.log(`📊 [computeModelSignature] Total elements across all models: ${l}`);const p=[...o,...S.map(C=>`${C.id}:${C.label}`),`count:${l}`].join("|");console.log("🔑 [computeModelSignature] Generated signature (first 100 chars):",p.substring(0,100));const u={signature:p,elementCount:l,modelFiles:r};return console.log("✅ [computeModelSignature] COMPLETE:",u),u},[S]),Ht=g.useCallback(async()=>{const t=c.current;if(!t||t.list.size===0){const l={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Pe.current=l,l}const o=wo();if(Pe.current&&Pe.current.signature===o)return Pe.current;if(bt.current)return bt.current;const r=(async()=>{const l=new Map,a=[],p=new Map;for(const[C,b]of t.list){let f=[];try{const P=await b.getLocalIds();Array.isArray(P)?f=P:P&&typeof P[Symbol.iterator]=="function"&&(f=Array.from(P))}catch(P){console.warn(`IDS cache: failed to read local IDs for model ${C}`,P);continue}if(p.set(C,f.slice()),!f.length)continue;const w=48;for(let P=0;P<f.length;P+=w){const F=f.slice(P,P+w);let M=[];try{M=await b.getItemsData(F,Ie)}catch(k){console.warn(`IDS cache: failed to fetch items data for model ${C}`,k);continue}M.forEach((k,A)=>{if(!k)return;const _=F[A],V=St(k),B=typeof k.GlobalId=="string"&&k.GlobalId.trim()||typeof k.GlobalID=="string"&&k.GlobalID.trim()||de(k,["globalid","global id","guid"]);if(!B){if(Qs(V,k))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:C,localId:_,itemData:k});return}const D=B.trim();if(!D.length||l.has(D))return;const{flattened:O,psets:L,attributes:H}=xo(k,D,V),Z={GlobalId:D,ifcClass:V,properties:O},re=k;(typeof re.GlobalId!="string"||!re.GlobalId.trim())&&(re.GlobalId=D),l.set(D,{element:Z,modelId:C,localId:_,psets:L,attributes:H,raw:re}),a.push(Z)})}}const u={signature:o,records:l,elements:a,modelLocalIds:p};return Pe.current=u,u})().finally(()=>{bt.current=null});return bt.current=r,r},[wo,xo,St]),ct=g.useCallback(async t=>{const o=new Map;console.log(`🔍 [groupLocalIdsByModel] Grouping ${t.length} GlobalIds using ThatOpen API...`);const r=c.current;if(!r)return console.error("🔍 [groupLocalIdsByModel] Fragments not available"),{grouped:o,cache:Pe.current};for(const[l,a]of r.list)try{const p=await a.getLocalIdsByGuids(t),u=[];for(let C=0;C<p.length;C++){const b=p[C];b!==null&&u.push(b)}u.length>0&&o.set(l,u)}catch(p){console.warn(`🔍 [groupLocalIdsByModel] Failed for model ${l}:`,p)}return console.log(`🔍 [groupLocalIdsByModel] Grouped ${t.length} GlobalIds into ${o.size} models (${Array.from(o.values()).reduce((l,a)=>l+a.length,0)} total local IDs)`),{grouped:o,cache:Pe.current}},[]),Io=mt.useMemo(()=>({listGlobalIds:async()=>(await Ht()).elements.map(o=>o.GlobalId),getSelectedGlobalIds:async()=>{console.log("📍 getSelectedGlobalIds called, selectedRef.current:",Te.current);const t=Te.current;if(!t||t.length===0)return console.log("📍 No selection found"),[];const o=c.current;if(!o)return console.warn("📍 Fragments not available"),[];console.log("📍 Processing selection:",t);const r=[];for(const l of t){const a=o.list.get(l.modelId);if(!a){console.warn("📍 Model not found for item:",l);continue}try{const[p]=await a.getItemsData([l.localId],{attributesDefault:!1});if(p){const u=de(p,["globalid","global id","guid"]);u&&typeof u=="string"?(r.push(u),console.log("📍 Found GlobalId for item:",l,"→",u)):console.warn("📍 No GlobalId found in data for item:",l)}}catch(p){console.error("📍 Error fetching data for item:",l,p)}}return console.log("📍 Final selectedGlobalIds:",r),r},getVisibleGlobalIds:async()=>{console.log("👁️ getVisibleGlobalIds called");const t=c.current;if(!t)return console.warn("👁️ Fragments not available"),[];const o=[];for(const[r,l]of t.list)try{console.log(`👁️ Getting visible elements from model: ${r}`);const a=await l.getItemsByVisibility(!0);if(console.log(`👁️ Model ${r}: ${a.length} visible elements`),a.length===0)continue;const p=100;for(let u=0;u<a.length;u+=p){const C=a.slice(u,Math.min(u+p,a.length));try{const b=await l.getItemsData(C,{attributesDefault:!1,attributes:["GlobalId"]});for(const f of b){const w=de(f,["globalid","global id","guid"]);w&&typeof w=="string"&&o.push(w)}}catch(b){console.error(`👁️ Error fetching GlobalIds for batch in model ${r}:`,b)}}}catch(a){console.error(`👁️ Error getting visible elements from model ${r}:`,a)}return console.log(`👁️ Total visible GlobalIds: ${o.length}`),o},getElementProps:async t=>{console.log("🔍 [getElementProps] START for",t);const o=c.current;if(!o)throw new Error("Fragments not available");console.log("🔍 [getElementProps] Searching across",o.list.size,"models");for(const[r,l]of o.list)try{const p=(await l.getLocalIdsByGuids([t]))[0];if(p!=null){console.log(`🔍 [getElementProps] Found in model ${r}, localId: ${p}`);const[u]=await l.getItemsData([p],Ie);if(!u){console.warn(`🔍 [getElementProps] No data returned for localId ${p}`);continue}console.log("🔍 [getElementProps] Got data, extracting properties...");const C=St(u);console.log("🔍 [getElementProps] ifcClass:",C);const b={},f={},w=vt(u);console.log("🔍 [getElementProps] Got",w.length,"property rows"),w.forEach(k=>{const A=k.label.split("/").map(O=>O.trim()),_=k.rawPsetName??A[1]??"",V=k.rawPropertyName??A[A.length-1]??"",B=He(_),D=He(V);!B||!D||(b[B]||(b[B]={}),D in b[B]||(b[B][D]=k.value))}),f.ifcClass=C,f.GlobalId=t;const P=Re(u);P&&(f.Name=P);const F=de(u,["category","ifccategory"]);F&&(f.Category=F);const M=de(u,["type","typename"]);return M&&(f.Type=M),console.log(`🔍 [getElementProps] SUCCESS: ${Object.keys(b).length} psets, ${Object.keys(f).length} attributes`),{ifcClass:C,psets:b,attributes:f}}}catch(a){console.warn(`🔍 [getElementProps] Error in model ${r}:`,a);continue}throw console.error(`🔍 [getElementProps] Element with GlobalId ${t} not found in any model`),new Error(`Element with GlobalId ${t} is not available.`)},getElementPropsFast:async t=>{console.log("🔍 [getElementPropsFast] START for",t);const o=Te.current,r=c.current;if(console.log("🔍 [getElementPropsFast] Selection:",o),console.log("🔍 [getElementPropsFast] Fragments available:",!!r),!r)throw console.error("🔍 [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");console.log("🔍 [getElementPropsFast] Searching in",o.length,"selected items");for(let l=0;l<o.length;l++){const a=o[l];console.log(`🔍 [getElementPropsFast] Checking item ${l+1}/${o.length}:`,a);const p=r.list.get(a.modelId);if(!p){console.log(`🔍 [getElementPropsFast] Model not found for ${a.modelId}`);continue}try{console.log(`🔍 [getElementPropsFast] Calling getItemsData for localId ${a.localId}...`);const[u]=await p.getItemsData([a.localId],Ie);if(console.log("🔍 [getElementPropsFast] Got data:",!!u),u){console.log("🔍 [getElementPropsFast] Data keys:",Object.keys(u)),console.log("🔍 [getElementPropsFast] data._category:",u._category),console.log("🔍 [getElementPropsFast] data.ifcClass:",u.ifcClass),console.log("🔍 [getElementPropsFast] data.type:",u.type),console.log("🔍 [getElementPropsFast] data.constructor.name:",u.constructor?.name);const C=de(u,["globalid","global id","guid"]);if(console.log(`🔍 [getElementPropsFast] Element GlobalId: ${C}, looking for: ${t}`),C===t){console.log("🔍 [getElementPropsFast] MATCH! Extracting properties...");const b=St(u);console.log("🔍 [getElementPropsFast] ifcClass extracted:",b);const f={},w={};console.log("🔍 [getElementPropsFast] Calling collectIfcPropertySetRows...");const P=vt(u);console.log("🔍 [getElementPropsFast] Got",P.length,"property rows"),P.forEach(A=>{const _=A.label.split("/").map(L=>L.trim()),V=A.rawPsetName??_[1]??"",B=A.rawPropertyName??_[_.length-1]??"",D=He(V),O=He(B);!D||!O||(f[D]||(f[D]={}),O in f[D]||(f[D][O]=A.value))}),console.log("🔍 [getElementPropsFast] Extracted",Object.keys(f).length,"psets"),w.ifcClass=b,w.GlobalId=t;const F=Re(u);F&&(w.Name=F);const M=de(u,["category","ifccategory"]);M&&(w.Category=M);const k=de(u,["type","typename"]);return k&&(w.Type=k),console.log(`📌 Fast props for ${t}:`,{ifcClass:b,psetCount:Object.keys(f).length}),console.log("🔍 [getElementPropsFast] SUCCESS - returning properties"),{ifcClass:b,psets:f,attributes:w}}}}catch(u){console.error("🔍 [getElementPropsFast] Error for item:",a,u)}}return console.log(`📌 ${t} not in selection, falling back to cache`),console.log("🔍 [getElementPropsFast] FALLBACK to getElementProps"),st.current.getElementProps(t)},countElements:async()=>(await Ht()).elements.length,iterElements:t=>{const o=Math.max(1,Math.floor(t?.batchSize??500));return console.log("🔄 [viewerApi.iterElements] START",{batchSize:o}),{async*[Symbol.asyncIterator](){const r=c.current;if(!r||r.list.size===0){console.warn("⚠️ [viewerApi.iterElements] No fragments available");return}console.log(`🔄 [viewerApi.iterElements] Processing ${r.list.size} models with batch size ${o}`);let l=[],a=0;for(const[p,u]of r.list){let C=[];try{const f=await u.getLocalIds();C=Array.isArray(f)?f:f&&typeof f[Symbol.iterator]=="function"?Array.from(f):[],console.log(`✅ [viewerApi.iterElements] Model ${p}: ${C.length} elements`)}catch(f){console.error(`❌ [viewerApi.iterElements] Failed to get local IDs for model ${p}`,f);continue}const b=Math.min(500,Math.max(100,o));for(let f=0;f<C.length;f+=b){const w=C.slice(f,f+b);try{const P=await u.getItemsData(w,Ie);for(let F=0;F<P.length;F++){const M=P[F];M&&l.push({modelId:p,localId:w[F],data:M})}for(;l.length>=o;){const F=l.splice(0,o);a+=F.length,(a%5e3===0||a===o)&&console.log(`📤 [viewerApi.iterElements] Yielded ${a} elements...`),yield F}}catch(P){console.error(`❌ [viewerApi.iterElements] Failed to fetch chunk at ${f}`,P)}}}l.length>0&&(a+=l.length,yield l),console.log(`✅ [viewerApi.iterElements] Complete: ${a} elements`)}}},_iterElementsLegacy:t=>{const o=Math.max(1,Math.floor(t?.batchSize??100));return{async*[Symbol.asyncIterator](){const r=await Ht(),l=Array.from(r.records.values());for(let a=0;a<l.length;a+=o){const p=l.slice(a,a+o).map(u=>({modelId:u.modelId,localId:u.localId,data:{...u.raw,GlobalId:u.element.GlobalId}}));p.length&&(yield p)}}}},buildIdsCache:async()=>{try{return(await Ht()).elements.length}catch(t){throw console.error("viewerApi.buildIdsCache failed",t),t}},getModelSignature:async()=>await Qr(),addToCache:async t=>{console.log(`📦 [addToCache] Adding ${t.length} elements to cache`);const o=c.current;if(!o){console.warn("📦 [addToCache] Fragments not available");return}let r=Pe.current;r||(r={signature:wo(),records:new Map,elements:[],modelLocalIds:new Map},Pe.current=r);const l=Te.current;console.log(`📦 [addToCache] Selection has ${l.length} items`);for(const a of t){if(r.records.has(a)){console.log(`📦 [addToCache] ${a} already in cache, skipping`);continue}console.log(`📦 [addToCache] Searching for ${a} in ${l.length} selected items...`);let p=!1;for(const u of l){console.log(`📦 [addToCache] Checking item: modelId=${u.modelId}, localId=${u.localId}`);const C=o.list.get(u.modelId);if(!C){console.log(`📦 [addToCache] Model not found: ${u.modelId}`);continue}try{const[b]=await C.getItemsData([u.localId],Ie);if(b){let f=b._guid||b.GlobalId;if(f&&typeof f=="object"&&(f=f.value||f),console.log(`📦 [addToCache] Item GlobalId: ${f}, looking for: ${a}, match: ${f===a}`),f===a){const w=St(b),P={};vt(b).forEach(O=>{const L=O.label.split("/").map(we=>we.trim()),H=O.rawPsetName??L[1]??"",Z=O.rawPropertyName??L[L.length-1]??"",re=He(H),xe=He(Z);!re||!xe||(P[re]||(P[re]={}),xe in P[re]||(P[re][xe]=O.value))});const M={ifcClass:w,GlobalId:a},k=Re(b);k&&(M.Name=k);const A=de(b,["category","ifccategory"]);A&&(M.Category=A);const _=de(b,["type","typename"]);_&&(M.Type=_);const V={GlobalId:a,ifcClass:w,properties:xo(b,a,w)},B={element:V,modelId:u.modelId,localId:u.localId,psets:P,attributes:M,raw:b};r.records.set(a,B),r.elements.push(V);const D=r.modelLocalIds.get(u.modelId)||[];D.push(u.localId),r.modelLocalIds.set(u.modelId,D),console.log(`📦 [addToCache] Added ${a} to cache (model: ${u.modelId}, localId: ${u.localId})`),p=!0;break}}}catch(b){console.debug("📦 [addToCache] Error checking selection item:",b)}}p||console.warn(`📦 [addToCache] Could not find ${a} in selection`)}console.log(`📦 [addToCache] Cache now has ${r.records.size} elements`)},color:async(t,o)=>{if(!t.length)return;const r=De.current,l=c.current,a=i.current;if(!r||!h.current||!l||!a)return;console.log(`🎨 [color] Called with ${t.length} GlobalIds, rgba:`,o);let p,u;try{console.log("🎨 [color] Calling groupLocalIdsByModel...");const f=await ct(t);p=f.grouped,u=f.cache,console.log(`🎨 [color] groupLocalIdsByModel returned ${p.size} models`)}catch(f){console.error("🎨 [color] groupLocalIdsByModel failed:",f);return}const C=new Me(o.r,o.g,o.b),b=C.getHex();console.log(`🎨 [color] Grouped into ${p.size} models, colorHex: ${b.toString(16)}`),Mt.current||(Mt.current=new Map);for(const[f,w]of p){const P=l.list.get(f);if(!(!P||!w.length)){console.log(`🎨 [color] Processing model ${f} with ${w.length} localIds`);try{const F=Array.from(w);if(typeof r.add=="function")try{if(console.log(`🎨 [color] Trying highlighter.add with colorHex: ${b.toString(16)}`),r.add(P,F,b),console.log(`✅ Successfully colored ${F.length} elements in model ${f} using add method`),a&&typeof a.update=="function")try{a.update(),console.log("🎨 [color] Forced world update")}catch(M){console.debug("World update failed:",M)}continue}catch(M){console.debug("add failed:",M)}if(typeof r.highlightById=="function")try{console.log("🎨 [color] Trying highlightById..."),await r.highlightById(P,F,b),console.log(`✅ Successfully colored ${F.length} elements in model ${f} using highlightById`);continue}catch(M){console.debug("highlightById failed:",M)}if(typeof r.highlightByID=="function")try{console.log("🎨 [color] Trying highlightByID..."),await r.highlightByID(P,F,b),console.log(`✅ Successfully colored ${F.length} elements in model ${f} using highlightByID`);continue}catch(M){console.debug("highlightByID failed:",M)}if(r.styles&&typeof r.styles.set=="function")try{if(!F||F.length===0){console.debug(`Skipping highlight for model ${f} - no IDs`);continue}const M=`ids-color-${b.toString(16).padStart(6,"0")}`;if(r.styles.set(M,{color:C,fillOpacity:1}),typeof r.create=="function")try{(!r.list||!r.list.has(M))&&r.create(M)}catch(k){console.debug("highlighter.create failed:",k)}if(typeof r.select=="function")try{r.select(P,F,M)}catch(k){throw console.debug("highlighter.select failed:",k),k}console.log(`✅ Successfully colored ${F.length} elements in model ${f} using styles.set`);continue}catch(M){console.debug("styles.set failed:",M)}console.warn(`❌ Could not color model ${f} - all highlighter methods failed`)}catch(F){console.error(`Failed to color model ${f}:`,F)}}}},clearColors:async()=>{const t=De.current,o=c.current;if(h.current){if(o&&_e.current&&_e.current.size>0)try{for(const[r,l]of _e.current){const{color:a,transparent:p,opacity:u}=l;r.transparent=p,r.opacity=u,a!==void 0&&("color"in r?r.color.setHex(a):"lodColor"in r&&r.lodColor.setHex(a)),r.needsUpdate=!0}_e.current.clear(),console.log("Restored original material properties")}catch(r){console.warn("Failed to restore original materials",r)}try{if(t){if(t.styles&&typeof t.styles.delete=="function")try{t.styles.delete("ghost"),console.log("Cleared ghost styles")}catch(r){console.warn("Failed to clear ghost styles",r)}typeof t.clear=="function"&&(await Promise.resolve(t.clear()),console.log("Cleared highlighter colors using clear()")),t.styles&&typeof t.styles.clear=="function"&&(t.styles.clear(),console.log("Cleared highlighter styles"))}}catch(r){console.warn("Failed to clear IDS highlights",r)}Mt.current&&Mt.current.clear();try{const r=ve.current;if(r&&r.mesh&&r.mesh.instanceColor){const l=new Me(1,1,1);r.mesh.setColorAt(r.index,l),r.mesh.instanceColor.needsUpdate=!0}}catch(r){console.warn("Failed to reset instanced mesh highlight",r)}ve.current=null}},isolate:async t=>{const o=Be.current,r=c.current;if(!o||!r||!h.current||(await Promise.resolve(o.set(!0)),!t.length||!h.current))return;const{grouped:l}=await ct(t);if(l.size===0){console.warn("isolate: No elements found in cache for isolation");return}const a=new Map;l.forEach((u,C)=>{a.set(C,new Set(u))});const p={};for(const[u,C]of a.entries()){const b=r.list.get(u);if(b)try{let f=[];const w=await b.getLocalIds();Array.isArray(w)?f=w:w&&typeof w[Symbol.iterator]=="function"&&(f=Array.from(w));const P=f.filter(F=>!C.has(F));P.length>0&&(p[u]=new Set(P))}catch(f){console.error("isolate: Failed to get local IDs for model",u,f)}}Object.keys(p).length>0&&await Promise.resolve(o.set(!1,p))},clearIsolation:async()=>{const t=Be.current;t&&await Promise.resolve(t.set(!0))},ghost:async t=>{console.log(`[ghost] Applying ghost mode by coloring ${t.length} matching elements`);const o=c.current,r=i.current;if(!o||!h.current||!r){console.warn("[ghost] Fragments or world not ready");return}const{grouped:l}=await ct(t);if(l.size===0){console.warn("[ghost] No elements found");return}const a=[...o.core.models.materials.list.values()];console.log(`[ghost] Found ${a.length} materials to ghost`),_e.current||(_e.current=new Map);for(const f of a)if(!f.userData?.customId){if(!_e.current.has(f)){let w;"color"in f?w=f.color.getHex():"lodColor"in f&&(w=f.lodColor.getHex()),_e.current.set(f,{color:w,transparent:f.transparent,opacity:f.opacity})}f.transparent=!0,f.opacity=.15,f.needsUpdate=!0}console.log(`[ghost] Ghosted ${a.length} materials`);const p=De.current;if(!p){console.warn("[ghost] Highlighter not available"),r.update();return}const C=new Me(0,1,1).getHex();let b=0;for(const[f,w]of l.entries()){const P=o.list.get(f);if(P)try{typeof p.add=="function"&&(p.add(P,Array.from(w),C),b+=w.length,console.log(`[ghost] Colored ${w.length} elements in model ${f}`))}catch(F){console.error(`[ghost] Failed to color elements in model ${f}:`,F)}}r.update(),console.log(`[ghost] Complete: ghosted ${a.length} materials, colored ${b} matching elements in cyan`)},getItemsData:async(t,o)=>{console.log("🔍 [getItemsData] START",{globalIds:t.length,config:o});const r=c.current;if(!r)return console.error("🔍 [getItemsData] Fragments not available"),[];const{grouped:l}=await ct(t),a=[];for(const[p,u]of l.entries()){const C=r.list.get(p);if(C)try{const b=await C.getItemsData(Array.from(u),o);a.push(...b)}catch(b){console.error(`🔍 [getItemsData] Failed for model ${p}`,b)}}return console.log("✅ [getItemsData] Complete:",a.length,"items"),a},getItemsByCategory:async t=>{console.log("🔍 [getItemsByCategory] START",{categories:t.length});const o=c.current;if(!o)return console.error("🔍 [getItemsByCategory] Fragments not available"),{};const r={};for(const[l,a]of o.list)try{const p=await a.getItemsOfCategories(t);if(p&&Object.keys(p).length>0){const u=Object.values(p).flat();u.length>0&&(r[l]=u)}}catch(p){console.error(`🔍 [getItemsByCategory] Failed for model ${l}`,p)}return console.log("✅ [getItemsByCategory] Complete:",Object.keys(r).length,"models"),r},getItemsDataByModel:async(t,o,r)=>{console.log("🔍 [getItemsDataByModel] START",{modelId:t,localIds:o.length,config:r});const l=c.current;if(!l)return console.error("🔍 [getItemsDataByModel] Fragments not available"),[];const a=l.list.get(t);if(!a)return console.error(`🔍 [getItemsDataByModel] Model ${t} not found`),[];try{const p=await a.getItemsData(o,r);return console.log("✅ [getItemsDataByModel] Complete:",p.length,"items"),p}catch(p){return console.error(`🔍 [getItemsDataByModel] Failed for model ${t}`,p),[]}},fitViewTo:async t=>{if(!t.length)return;const o=i.current,r=c.current;if(!o||!r||!h.current)return;const l=o.camera??null,a=l?.controls??null,p=l?.three??null,{grouped:u}=await ct(t),C=new qe;let b=!1;for(const[M,k]of u.entries()){const A=r.list.get(M);if(!A||!A.object)continue;const _=new qe().setFromObject(A.object);_.isEmpty()||(b?C.union(_):(C.copy(_),b=!0))}if(!b)return;const f=new K,w=new K;C.getCenter(f),C.getSize(w);const F=(Math.max(w.x,w.y,w.z)||10)*1.5;a?a.setLookAt(f.x+F,f.y+F,f.z+F,f.x,f.y,f.z,!0):p&&(p.position.set(f.x+F,f.y+F,f.z+F),p.lookAt(f))}}),[ct]);st.current=Io;const lr=g.useCallback(()=>{Nt(!0),ao(t=>t+1)},[]),en=g.useCallback(()=>{Nt(!1);const t=st.current;t&&(Promise.resolve(t.clearColors()).catch(()=>{}),t.clearIsolation&&Promise.resolve(t.clearIsolation()).catch(()=>{}))},[]),tn=g.useCallback(()=>{Nt(t=>{const o=!t;return o&&ao(r=>r+1),o})},[]),on=g.useCallback(async t=>{try{const{setIdsXmlText:o,runCheck:r}=await pt(()=>Promise.resolve().then(()=>Os),void 0).then(l=>l.idsStore);o(t),Nt(!0),ao(l=>l+1),setTimeout(async()=>{st.current&&await r(st.current)},100)}catch(o){console.error("Failed to validate from IDS Creator:",o),alert("Error: Could not run validation. See console for details.")}},[]);g.useEffect(()=>{Te.current=E},[E]),g.useEffect(()=>{Pe.current=null,bt.current=null;try{$r.invalidateCaches()}catch(t){console.warn("Failed to invalidate IDS caches",t)}},[S]),g.useEffect(()=>{const t=e.current;if(!t)return;let o=!1;zo.current||(Zn.init(),Qn.init(),zo.current=!0);try{t.replaceChildren()}catch{}const r=new es;y.current=r;const a=r.get(ts).create();a.name="main",a.scene=new os(r),a.scene.setup(),a.renderer=new rs(r,t);const p=a.renderer.three;p.shadowMap.enabled=!1,p.sortObjects=!1,a.camera=new ns(r),a.camera.controls?.setLookAt(10,10,10,0,0,0),a.camera.three.near=.1,a.camera.three.far=1e9,a.camera.three.updateProjectionMatrix();const u=a.camera.controls;u&&("mouseButtons"in u&&(u.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in u&&(u.dollySpeed=1));const C=new ds(16777215,1);a.scene.three.add(C),i.current=a;const b=new vn;b.showPanel(2),b.dom.style.position="absolute",b.dom.style.left="8px",b.dom.style.top="8px",b.dom.style.zIndex="1000",t.appendChild(b.dom),a.renderer.onBeforeUpdate.add(()=>b.begin()),a.renderer.onAfterUpdate.add(()=>b.end());let f=null;const w=async M=>{if(!h.current)return;const k=[];for(const[O,L]of Object.entries(M))L.forEach(H=>{Number.isInteger(H)&&k.push({modelId:O,localId:H})});const A=Te.current;if(!!Sr(k,A))return;z(k),dt();const V=c.current;if(!V||!k.length){Ae(null);return}const B=k[0],D=V.list.get(B.modelId);if(!D){Ae(null);return}try{const[O]=await D.getItemsData([B.localId],Ie);Ae(O||null)}catch(O){console.warn("Failed to fetch properties for selection",O)}},P=()=>{z([]),Ae(null)};return(async()=>{try{await Promise.resolve(r.init())}catch(D){console.error("Failed to initialize viewer components",D);return}if(o)return;try{r.get(ss).create(a)}catch(D){console.warn("Failed to create grid component",D)}const k=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),A=URL.createObjectURL(new File([k],"worker.mjs",{type:"text/javascript"}));v.current=A;const _=r.get(ls);await _.init(A),c.current=_,h.current=!0;const V=r.get(is);V.setup({world:a}),V.zoomToSelection=!0;try{typeof V.create=="function"&&V.create("select")}catch{}De.current=V;const B=r.get(as);Be.current=B;try{const D=r.get(cs);if(D.world=a,D.color=new Me("#ff0000"),"snapDistance"in D&&(D.snapDistance=.5),"preview"in D){const O=D.preview;O&&(O.enabled=!0,O.color&&(O.color=new Me("#00ff00")))}if("workingPlane"in D){const O=D.workingPlane;O&&typeof O=="object"&&(O.visible=!0)}D.list?.onItemAdded&&D.list.onItemAdded.add(O=>{const L=O.value||O.distance?.()||0;console.log(`✅ Measurement created: ${L.toFixed(3)} units`),Jo(L.toFixed(3)),O.dimensionLabel&&(O.dimensionLabel.visible=!0)}),D.enabled=!1,Bt.current=D,console.log("✅ Measurement tool initialized:",D),console.log("Measurement tool properties:",Object.keys(D))}catch(D){console.error("Failed to initialize measurement tool:",D)}V.events.select.onHighlight.add(w),V.events.select.onClear.add(P),f=()=>{V.events.select.onHighlight.remove?.(w),V.events.select.onClear.remove?.(P)},tt()?.controls?.addEventListener("rest",()=>_.core.update(!0));try{const O=(await pt(()=>import("./thatopen-vendor-NKp5mY5i.js").then(Z=>Z.i),__vite__mapDeps([3,4,1]))).IfcImporter,L=new O,H="/Fragments-AI-viewer/";L.wasm={path:`${H}web-ifc/`,absolute:!0},x.current=L}catch(D){console.warn("Failed to lazy-load FRAGS.IfcImporter:",D)}o||Fe(!0)})().catch(M=>{console.error("Failed to initialize viewer fragments",M)}),()=>{o=!0,(async()=>{const M=h.current;h.current=!1,f?.(),f=null;try{M&&await Be.current?.set?.(!0)}catch{}if(c.current){const k=[...c.current.list.keys()];await Promise.all(k.map(A=>c.current.core.disposeModel(A)))}try{M&&De.current?.clear?.()}catch{}v.current&&URL.revokeObjectURL(v.current);try{r.dispose()}catch{}try{t.replaceChildren()}catch{}De.current=null,Be.current=null})()}},[]),g.useEffect(()=>{if(!fe)return;const t=y.current,o=c.current;if(!t||!o)return;const r=Ut,l=(a,p,u)=>{if(!a)return;let C=p.current;C||(C=u(),p.current=C),C&&C.parentElement!==a&&a.replaceChildren(C)};l(Fo.current,Xe,()=>{const[a,p]=yr.modelsList({components:t});return so.current=p,a}),Xe.current&&((!Xe.current.dataset.initialized||r!==To.current)&&so.current?.({components:t}),Xe.current.dataset.initialized||(Xe.current.dataset.initialized="true",Xe.current.style.width="100%")),Ft.current!==Do.current&&(lo.current=null,yt.current=null,Do.current=Ft.current),l(Ft.current,lo,()=>{const[a,p]=yr.spatialTree({components:t,models:Array.from(o.list.values())});yt.current=p,a.style.width="100%",a.style.height="100%",a.style.overflow="auto";const u=a;return u.queryString=lt.trim()?lt.trim():null,a}),yt.current&&yt.current({components:t,models:Array.from(o.list.values())}),To.current=r},[fe,J,lt,Ut]),g.useEffect(()=>{if(!fe)return;const t=y.current,o=c.current,r=yt.current;!t||!o||!r||r({components:t,models:Array.from(o.list.values())})},[fe,Ut]),g.useEffect(()=>{const t=lo.current;if(!t)return;const o=lt.trim();t.queryString=o||null},[lt]);const rn=async()=>{const t=s.current,o=t?.files?.[0];if(!o)return;const r=o.name.split(".").pop()?.toLowerCase(),l=c.current,a=x.current,p=i.current;if(!l||!p){alert("Viewer is still initializing. Please try again in a moment."),t&&(t.value="");return}const u=tt(),C=u?.three??null,b=u?.controls??null;let f=!1;try{const w=`${o.name}-${Date.now()}`;let P;if(r==="ifc"){if(!a)throw new Error("IFC importer is not ready.");Oe(0),f=!0,Ve.current=!1,ze(!1);const A=new AbortController;ht.current=A;const _=new Uint8Array(await o.arrayBuffer()),V=await a.process({bytes:_,progressCallback:(D,O)=>{if(Ve.current)return;const L=typeof D=="number"?D:0,H=L<=1?L*100:L,Z=Math.max(0,Math.min(100,H));Oe(Number(Z.toFixed(1))),console.log(`IFC conversion progress: ${Z.toFixed(1)}%`,O)},signal:A.signal});if(Ve.current)throw{__cancelled:!0};let B;if(V instanceof ArrayBuffer){const D=new Uint8Array(V),O=new Uint8Array(D.byteLength);O.set(D),B=O.buffer}else if(V instanceof Uint8Array){const D=new Uint8Array(V.byteLength);D.set(V),B=D.buffer}else{const D=V,O=new Uint8Array(D),L=new Uint8Array(O.byteLength);L.set(O),B=L.buffer}P=await l.core.load(B,{modelId:w})}else if(r==="frag"){const A=await o.arrayBuffer();P=await l.core.load(A,{modelId:w})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}m.current=w,C?P.useCamera(C):console.warn("World camera not ready; skipping model camera binding."),p.scene.three.add(P.object),await l.core.update(!0),await new Promise(A=>requestAnimationFrame(()=>A()));const F=new qe().setFromObject(P.object),M=new K;F.getCenter(M),(Math.abs(M.x)>1e6||Math.abs(M.y)>1e6||Math.abs(M.z)>1e6)&&P.object.position.sub(M);try{b&&await b.fitToBox(P.object,!0)}catch{const A=new K;F.getSize(A);const V=(Math.max(A.x,A.y,A.z)||10)*2.5;b?b.setLookAt(M.x+V,M.y+V,M.z+V,M.x,M.y,M.z,!0):C&&(C.position.set(M.x+V,M.y+V,M.z+V),C.lookAt(M))}_r(A=>({...A,[w]:Hs(w,o.name,P.object)})),j(!0),N(A=>[...A,{id:w,label:o.name}]),dt();const k=y.current;k&&so.current?.({components:k}),f&&Oe(100)}catch(w){w&&(w.__cancelled||w?.name==="AbortError")?console.info("IFC conversion cancelled by user."):(console.error(w),alert("Failed to load model. See console for more details.")),j(!1)}finally{t&&(t.value=""),f&&setTimeout(()=>Oe(null),200),ht.current=null,ze(!1)}},nn=g.useCallback(()=>{if(me!==null){Ve.current=!0,ze(!0);try{ht.current?.abort()}catch{}Oe(null)}},[me]),dt=g.useCallback(()=>{Y(!0),q(!1)},[]),sn=g.useCallback(()=>{Y(t=>{const o=!t;return o&&q(!1),o})},[]),ln=g.useCallback(()=>{Y(!1)},[]),an=g.useCallback(()=>{q(t=>!t)},[]),qt=g.useMemo(()=>Math.min(360,Math.max(180,Rt.height*.45)),[Rt.height]),cn=+!Ze+ +!Qe,$e=!Tt&&cn===0;g.useEffect(()=>{const t=Xe.current;t&&(t.style.width="100%",t.style.maxHeight=$e?"100%":`${qt}px`,t.style.height=$e?"100%":"auto")},[$e,qt,Ut]);const dn=g.useCallback(async t=>{const o=k=>{const A=[],_=new Set;if(!k||typeof k!="object")return{terms:A,modelIds:_};for(const[V,B]of Object.entries(k)){if(B==null)continue;const D=V.trim().toLowerCase(),O=Array.isArray(B)?B:[B];if(O.length){if(D==="modelid"||D==="modelids"||D==="model"){for(const L of O){const H=typeof L=="string"?L.trim():String(L??"").trim();H&&_.add(H)}continue}if(["text","query","keyword","search"].includes(D)){for(const L of O){if(L==null)continue;const H=typeof L=="string"?L.trim().toLowerCase():String(L??"").trim().toLowerCase();H&&A.push({type:"text",value:H})}continue}for(const L of O){if(L==null)continue;let H=null;typeof L=="string"?H=L.trim():(typeof L=="number"||typeof L=="boolean")&&(H=String(L)),H&&A.push({type:"field",key:D,value:H.toLowerCase()})}}}return{terms:A,modelIds:_}},r=c.current;if(!r){console.warn("AI selection requested but fragments are unavailable.");return}if(!h.current){console.warn("AI selection requested before fragments were fully initialized.");return}const l=De.current,a=Be.current,{terms:p,modelIds:u}=o(t.filter),C=t.mode?.toLowerCase?.(),b=C==="isolate"||C==="focus";if(t.action==="clear"){try{l?.clear?.()}catch{}if(a)try{await a.set(!0)}catch(k){console.warn("Failed to reset visibility while clearing AI selection",k)}try{const k=ve.current;if(k&&k.mesh&&k.mesh.instanceColor){const A=new Me(1,1,1);k.mesh.setColorAt(k.index,A),k.mesh.instanceColor.needsUpdate=!0}}catch{}ve.current=null,je.current&&(je.current.visible=!1),z([]),Ae(null);return}if(p.length===0){console.warn("AI selection command did not include usable filters",t);return}const f=++$t.current,w=[],P=60;for(const k of r.list.values()){const A=typeof k?.modelId=="string"?k.modelId:"";if(u.size&&!u.has(A))continue;let _=[];try{const B=await k.getLocalIds();Array.isArray(B)?_=B.slice():B&&typeof B[Symbol.iterator]=="function"&&(_=Array.from(B))}catch(B){console.warn("Failed to fetch local IDs for model",A,B)}const V={model:k,modelId:A,allIds:_,matched:new Set};if(w.push(V),!!_.length)for(let B=0;B<_.length;B+=P){if(f!==$t.current)return;const D=_.slice(B,B+P);let O=[];try{O=await k.getItemsData(D,Ie)}catch(L){console.warn("Failed to retrieve property batch for AI selection",L);continue}D.forEach((L,H)=>{const Z=O?.[H];if(!Z)return;let re=[];try{re=Pt(Z).rows}catch(pe){console.warn("Failed to build property rows for AI selection",pe)}const xe=re.map(pe=>pe.searchText),we=oo(Z,6e3).toLowerCase();p.every(pe=>{if(pe.type==="text")return xe.some(Ue=>Ue.includes(pe.value))||we.includes(pe.value);const jt=Ws[pe.key]??[pe.key];return xe.some(Ue=>jt.some(In=>Ue.includes(In))&&Ue.includes(pe.value))?!0:jt.some(Ue=>we.includes(Ue)&&we.includes(pe.value))})&&V.matched.add(L)})}}if(f!==$t.current)return;const F=w.filter(k=>k.matched.size>0);if(!F.length){console.info("AI selection produced no matches for command",t);return}try{const k=ve.current;if(k&&k.mesh&&k.mesh.instanceColor){const A=new Me(1,1,1);k.mesh.setColorAt(k.index,A),k.mesh.instanceColor.needsUpdate=!0}}catch{}if(ve.current=null,je.current&&(je.current.visible=!1),a)try{await a.set(!0)}catch(k){console.warn("Failed to reset hidden state before AI selection",k)}if(l){try{l.clear?.()}catch{}const k=b?16754240:6737151;for(const A of F){const _=Array.from(A.matched);if(_.length)try{typeof l.highlightById=="function"?await l.highlightById(A.model,_,k):typeof l.highlightByID=="function"?await l.highlightByID(A.model,_,k):typeof l.add=="function"&&l.add(A.model,_,k)}catch(V){console.warn("Failed to apply AI highlight for model",A.modelId,V)}}}if(b&&a){const k={};for(const A of w){if(!A.allIds.length||A.matched.size===A.allIds.length)continue;const _=A.allIds.filter(V=>!A.matched.has(V));_.length&&(k[A.modelId]=new Set(_))}if(Object.keys(k).length)try{await a.set(!1,k)}catch(A){console.warn("Failed to isolate AI-selected elements",A)}}const M=F.flatMap(k=>Array.from(k.matched).map(A=>({modelId:k.modelId,localId:A})));z(M),dt();try{const k=F[0],A=Array.from(k.matched)[0];if(A!==void 0){const[_]=await k.model.getItemsData([A],Ie);f===$t.current&&Ae(_||null)}}catch(k){console.warn("Failed to fetch properties for AI selection result",k)}},[dt,z,Ae]),Yt=g.useCallback(t=>{if(!zt.current)return;const o=ro.current;if(!o)return;const r=t.clientX-o.startX,l=t.clientY-o.startY,a=280,p=260;Rr(u=>{const C=o.width,b=o.height,f=Math.max(a,C+r),w=Math.max(p,b+l);return f===u.width&&w===u.height?u:{width:Math.round(f),height:Math.round(w)}})},[]),Et=g.useCallback(()=>{zt.current&&(zt.current=!1,ro.current=null,window.removeEventListener("pointermove",Yt),window.removeEventListener("pointerup",Et))},[Yt]),un=g.useCallback(t=>{t.preventDefault(),t.stopPropagation();const o=no.current;o&&(zt.current=!0,ro.current={startX:t.clientX,startY:t.clientY,width:o.offsetWidth,height:o.offsetHeight},window.addEventListener("pointermove",Yt),window.addEventListener("pointerup",Et))},[Yt,Et]);g.useEffect(()=>()=>{Et()},[Et]);const fn=g.useCallback(async()=>{const t=c.current,o=[];if(!t||t.list.size===0||S.length===0)o.push("No models are currently loaded in the viewer.");else{o.push(`Loaded models (${S.length}): ${S.map(l=>`${l.label} [${l.id}]`).join(", ")}`),o.push(`Fragments models in memory: ${t.list.size}`);try{const l=new qe;for(const p of t.list.values())l.expandByObject(p.object);const a=new K;l.getSize(a),o.push(`Scene bounds approx size => x:${a.x.toFixed(2)} y:${a.y.toFixed(2)} z:${a.z.toFixed(2)}`)}catch(l){console.warn("Failed to compute bounds for AI context",l)}const r=S.map(l=>_o[l.id]).filter(l=>!!l);if(r.length){let l=0;const a=new Map;o.push("Model geometry snapshots:");for(const u of r){l+=u.elementCount;for(const{category:b,count:f}of u.categoryCounts)a.set(b,(a.get(b)??0)+f);const C=u.categoryCounts.slice(0,5).map(({category:b,count:f})=>`${b}: ${f}`);o.push(`- ${u.label} [${u.modelId}] → elements≈${u.elementCount}, instanced≈${u.instancedCount}, meshes≈${u.meshCount}`),C.length&&o.push(`  top categories: ${C.join(" | ")}`),o.push(`  bbox size (approx): x:${u.bboxSize.x.toFixed(2)} y:${u.bboxSize.y.toFixed(2)} z:${u.bboxSize.z.toFixed(2)}`)}const p=Array.from(a.entries()).sort((u,C)=>C[1]-u[1]).slice(0,10).map(([u,C])=>`${u}: ${C}`);o.push(`Global approx element total: ${l}`),p.length&&o.push(`Global top categories: ${p.join(" | ")}`)}else o.push("Geometry summaries are initializing — load a model or wait a moment after loading.")}if(E.length){o.push(`Active selection count: ${E.length}`);for(let r=0;r<E.length;r+=1){const l=E[r];o.push(`Selection #${r+1} → modelId:${l.modelId}, localId:${l.localId}`);let a=null;if(r===0&&U&&Object.keys(U).length)a=U;else if(t){const p=t.list.get(l.modelId);if(p)try{const[u]=await p.getItemsData([l.localId],Ie);a=u||null}catch(u){console.warn("Failed to fetch properties for AI context (multi)",u)}}if(a){o.push("  Property snapshot (compact JSON):"),o.push(`  ${oo(a,4e3)}`);const p=Pt(a).rows;if(p.length){o.push(`  Flattened properties (${p.length} entries):`);for(const u of p.slice(0,120))o.push(`  - ${u.label}: ${u.value}`);p.length>120&&o.push(`  (Truncated ${p.length-120} additional properties)`)}}else o.push("  Properties for this selection are not available yet.")}}else if(o.push("No active selection — exporting properties for every loaded element."),t&&t.list.size)for(const r of S){const l=t.list.get(r.id);if(!l){o.push(`Model ${r.label} [${r.id}] could not be found in the fragments registry.`);continue}try{const a=await l.getLocalIds(),p=Array.isArray(a)?a:a?Array.from(a):[];if(!p||p.length===0){o.push(`Model ${r.label} [${r.id}] has no retrievable local IDs.`);continue}o.push(`Model ${r.label} [${r.id}] — enumerating ${p.length} items:`);const u=p.length<=40?12:p.length<=120?6:3,C=50;for(let b=0;b<p.length;b+=C){const f=p.slice(b,b+C);let w=[];try{w=await l.getItemsData(f,Ie)}catch(P){const F=f[0],M=f[f.length-1];o.push(`  Failed to retrieve properties for items ${F}–${M}: ${P?.message??P}`);continue}f.forEach((P,F)=>{const M=w?.[F];if(!M){o.push(`- localId:${P} (no data available)`);return}const k=Ks(M,u).replace(/\s+/g," ").trim();o.push(`- localId:${P} | ${k}`)})}}catch(a){o.push(`Failed to enumerate items for model ${r.label} [${r.id}]: ${a?.message??a}`)}}else o.push("Fragments data is not available to enumerate model items.");if(wt.length){o.push("ItemsData extracted name/value pairs (last selection):");const r=150,l=wt.slice(0,r);for(const a of l)o.push(`- ${a.path}: ${a.value}`);wt.length>r&&o.push(`(Truncated ${wt.length-r} additional rows)`)}return uo&&(o.push("ItemsData table snapshot for last selection (tab-separated):"),o.push(uo)),o.length===0&&o.push("Viewer is idle: no models or selections to describe."),o.join(`
`)},[S,E,U,oe,_o,uo,wt]),pn=g.useCallback(async()=>{const t=i.current,o=c.current,r=m.current;if(!t||!o||!r||!h.current)return;const l=o.list.get(r);if(!l)return;await o.core.update(!0),await new Promise(u=>requestAnimationFrame(()=>u()));const a=l.object,p=new qe().setFromObject(a);if(!p.isEmpty()){const u=tt(),C=u?.controls??null,b=u?.three??null;try{C&&await C.fitToBox(a,!0)}catch{const w=new K,P=new K;p.getCenter(w),p.getSize(P);const M=(Math.max(P.x,P.y,P.z)||10)*2.5;C?C.setLookAt(w.x+M,w.y+M,w.z+M,w.x,w.y,w.z,!0):b&&(b.position.set(w.x+M,w.y+M,w.z+M),b.lookAt(w))}}},[]),mn=g.useCallback(async()=>{const t=Te.current,o=Be.current;if(!t||t.length===0||!o||!h.current){be(null);return}const r={};for(const l of t)r[l.modelId]||(r[l.modelId]=new Set),r[l.modelId].add(l.localId);try{await o.set(!1,r);try{De.current?.clear?.()}catch{}z([]),Ae(null)}catch(l){console.warn("Failed to hide selected element",l)}finally{be(null)}},[be,z,Ae]),gn=g.useCallback(async()=>{const t=Be.current;if(!t||!h.current){be(null);return}try{await t.set(!0)}catch(o){console.warn("Failed to reset hidden items",o)}finally{be(null)}},[be]),hn=g.useCallback(()=>{be(null)},[be]);g.useEffect(()=>{const t=e.current,o=i.current;if(!t||!o)return;const r=o.renderer?.three.domElement;if(!r)return;const l=new us,a=async(w,P)=>{const F=c.current;if(!F)return;const M=Zo();if(!M){console.warn("Picking skipped: viewer camera not ready.");return}const k=r.getBoundingClientRect();l.x=(w-k.left)/k.width*2-1,l.y=-((P-k.top)/k.height)*2+1;let A=null;const _=new fs;_.setFromCamera(l,M);for(const O of F.list.values()){const L=await O.raycast({camera:M,mouse:l,dom:o.renderer.three.domElement});if(L&&typeof L.distance=="number"){const H=L.point instanceof K?L.point.clone():_.ray.at(L.distance,new K);(!A||L.distance<A.dist)&&(A={dist:L.distance,model:O,localId:L.localId,point:H,object:L.object,instanceId:L.instanceId})}}if(!A)return;const V=De.current;if(V)try{typeof V.clear=="function"&&V.clear();const O=6737151;typeof V.highlightByID=="function"?await V.highlightByID(A.model.uuid,[A.localId],O):typeof V.add=="function"?V.add(A.model.uuid,[A.localId]):typeof V.highlight=="function"&&await V.highlight(A.model,[A.localId],O)}catch(O){console.warn("Highlighter failed, using fallback:",O);try{const L=A.object,H=A.instanceId;if(L&&L.isInstancedMesh&&Number.isInteger(H)){const Z=ve.current;if(Z&&Z.mesh&&Z.mesh.instanceColor){const we=new Me(1,1,1);try{Z.mesh.setColorAt(Z.index,we),Z.mesh.instanceColor.needsUpdate=!0}catch{}}const re=L,xe=new Me(6737151);try{re.setColorAt(H,xe),re.instanceColor.needsUpdate=!0}catch{}ve.current={mesh:re,index:H}}}catch{}}try{const O=A.point??new K;let L=je.current;if(!L){L=new ps;const re=new qe,xe=c.current;if(xe&&xe.list.size)for(const Ue of xe.list.values())re.expandByObject(Ue.object);const we=new ms;re.getBoundingSphere(we);const ir=isFinite(we.radius)&&we.radius>0?we.radius*.01:.3,pe=Math.max(.05,Math.min(2,ir)),jt=new br(new gs(pe*.5,16,16),new xr({color:16763904,depthTest:!1})),Kt=new br(new hs(pe*.8,pe,32),new xr({color:16772744,side:ys,depthTest:!1,transparent:!0,opacity:.9}));Kt.rotation.x=Math.PI/2,jt.renderOrder=999,Kt.renderOrder=999,L.add(jt),L.add(Kt),o.scene.three.add(L),je.current=L}L.position.copy(O);const H=L.children[1],Z=Zo();Z&&H.lookAt(Z.position),L.visible=!0}catch{}const B=Te.current,D=[{modelId:A.model.modelId,localId:A.localId}];if(!Sr(D,B)){z(D),dt();try{const[O]=await A.model.getItemsData([A.localId],Ie);Ae(O||null)}catch{}}},p=async w=>{be(null),w.button===0&&await a(w.clientX,w.clientY)},u=async w=>{be(null),_t.current||await a(w.clientX,w.clientY)},C=()=>{if(_t.current){const w=Bt.current;w&&typeof w.create=="function"&&(console.log("📏 Creating measurement point"),w.create())}},b=w=>{w.preventDefault();const P=Te.current;if(!P||P.length===0){be(null);return}be({mouseX:w.clientX+2,mouseY:w.clientY-6})},f=w=>{if(_t.current&&(w.code==="Delete"||w.code==="Backspace")){const P=Bt.current;P&&typeof P.delete=="function"&&(console.log("Deleting measurement under cursor"),P.delete())}};return r.addEventListener("pointerdown",p,{capture:!0}),r.addEventListener("click",u),r.addEventListener("dblclick",C),r.addEventListener("contextmenu",b),window.addEventListener("keydown",f),()=>{r.removeEventListener("pointerdown",p,{capture:!0}),r.removeEventListener("click",u),r.removeEventListener("dblclick",C),r.removeEventListener("contextmenu",b),window.removeEventListener("keydown",f);try{const w=je.current;w&&(o.scene.three.remove(w),w.traverse(P=>{if(P.geometry&&P.geometry.dispose?.(),P.material){const F=Array.isArray(P.material)?P.material:[P.material];for(const M of F)M?.dispose?.()}}),je.current=null)}catch{}try{const w=ve.current;if(w&&w.mesh&&w.mesh.instanceColor){const P=new Me(1,1,1);w.mesh.setColorAt(w.index,P),w.mesh.instanceColor.needsUpdate=!0}ve.current=null}catch{}}},[]);const yn=g.useCallback(()=>{i.current;const t=tt(),o=t?.controls??null,r=t?.three??null;o?o.reset(!0):r&&(r.position.set(10,10,10),r.lookAt(0,0,0))},[]),Co=g.useCallback(t=>{Vt(o=>{const r={...o,[t]:!o[t]},l=i.current;if(!l)return r;const a=l.renderer?.three,p=l.scene?.three;if(!a||!p)return r;const u=[],C=mo.current;if(!r[t]){const b=C.get(t);b&&(p.remove(b),b.dispose(),C.delete(t))}if(r.x){const b=new ut(new K(1,0,0),ke.x);if(u.push(b),!C.has("x")){const f=new Ao(b,10,16711680);p.add(f),C.set("x",f)}}if(r.y){const b=new ut(new K(0,1,0),ke.y);if(u.push(b),!C.has("y")){const f=new Ao(b,10,65280);p.add(f),C.set("y",f)}}if(r.z){const b=new ut(new K(0,0,1),ke.z);if(u.push(b),!C.has("z")){const f=new Ao(b,10,255);p.add(f),C.set("z",f)}}return a.clippingPlanes=u,a.localClippingEnabled=u.length>0,po.current=u,r})},[ke]),So=g.useCallback((t,o)=>{Yo(r=>{const l={...r,[t]:o};return requestAnimationFrame(()=>{const p=i.current;if(!p)return;const u=p.renderer?.three;if(!u)return;const C=[],b=mo.current;if(ee.x){const f=new ut(new K(1,0,0),l.x);C.push(f);const w=b.get("x");w&&(w.plane.constant=l.x)}if(ee.y){const f=new ut(new K(0,1,0),l.y);C.push(f);const w=b.get("y");w&&(w.plane.constant=l.y)}if(ee.z){const f=new ut(new K(0,0,1),l.z);C.push(f);const w=b.get("z");w&&(w.plane.constant=l.z)}u.clippingPlanes=C,po.current=C}),l})},[ee]),bn=g.useCallback(()=>{Ko(t=>{const o=!t;return Vt(o?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),o})},[]),xn=g.useCallback(()=>{console.log("🎯 toggleMeasurement called"),Wr(t=>{const o=!t;_t.current=o;const r=Bt.current;if(console.log("Measurement tool:",r),console.log("New state:",o),r)if(r.enabled=o,console.log("Measurement tool enabled set to:",o),console.log("Measurement tool world:",r.world),console.log("Measurement tool properties:",{enabled:r.enabled,world:!!r.world,list:r.list?.size||0}),o)console.log("📏 Measurement mode activated - DOUBLE-CLICK two points on the model to measure distance");else try{r.list&&typeof r.list.clear=="function"&&(r.list.clear(),console.log("All measurements cleared")),Jo(null)}catch(l){console.warn("Failed to clear measurements:",l)}else console.warn("⚠️ Measurement tool not initialized!");return o})},[]),wn=g.useCallback(()=>{Vt({x:!1,y:!1,z:!1}),Yo({x:0,y:0,z:0}),Ko(!1);const t=i.current;if(t){const o=t.renderer?.three,r=t.scene?.three;if(o&&(o.clippingPlanes=[],o.localClippingEnabled=!1),r){const l=mo.current;l.forEach(a=>{r.remove(a),a.dispose()}),l.clear()}}po.current=[]},[]),ot=g.useCallback(t=>{console.log("setCameraView called with view:",t);const o=i.current,r=c.current,l=m.current,a=tt(),p=a?.three;if(console.log("Debug:",{hasWorld:!!o,hasFragments:!!r,id:l,hasCamera:!!a,hasThreeCamera:!!p}),!p||!o||!r||!l){console.log("Early return: missing dependencies");return}const u=r.list.get(l);if(console.log("Model record:",u),!u){console.log("Early return: no record found for id:",l);return}const C=new qe().setFromObject(u.object);if(console.log("Bounding box:",C,"isEmpty:",C.isEmpty()),C.isEmpty()){console.log("Early return: bounding box is empty");return}const b=new K,f=new K;C.getCenter(b),C.getSize(f);const P=Math.max(f.x,f.y,f.z)*2||20;let F;switch(t){case"top":F=new K(b.x,b.y+P,b.z);break;case"bottom":F=new K(b.x,b.y-P,b.z);break;case"front":F=new K(b.x,b.y,b.z+P);break;case"back":F=new K(b.x,b.y,b.z-P);break;case"left":F=new K(b.x-P,b.y,b.z);break;case"right":F=new K(b.x+P,b.y,b.z);break;case"iso":F=new K(b.x+P*.7,b.y+P*.7,b.z+P*.7);break;default:return}const M=a?.controls;M&&typeof M.setLookAt=="function"?(M.setLookAt(F.x,F.y,F.z,b.x,b.y,b.z,!0),console.log("Camera moved to:",t,"position:",F,"looking at:",b)):(p.position.copy(F),p.lookAt(b),p.updateProjectionMatrix(),console.log("Camera moved (fallback) to:",t))},[]);return n.jsxs("div",{style:{width:"100%",height:"100%"},children:[n.jsx(Pn,{position:"static",children:n.jsxs(kn,{children:[n.jsx(X,{variant:"h6",component:"div",sx:{flexGrow:1},children:"Fragments AI Viewer"}),n.jsx(ce,{color:"inherit",onClick:sn,startIcon:n.jsx(ar,{}),"aria-pressed":J,sx:{mr:1,borderRadius:1.5,backgroundColor:J?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:J?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:J?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),n.jsx(ce,{color:"inherit",onClick:Zr,startIcon:n.jsx(An,{}),"aria-pressed":xt,sx:{mr:1,borderRadius:1.5,backgroundColor:xt?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:xt?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:xt?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),n.jsx(ce,{color:"inherit",onClick:tn,startIcon:n.jsx(cr,{}),"aria-pressed":it,sx:{mr:1,borderRadius:1.5,backgroundColor:it?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:it?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:it?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),n.jsx(ce,{color:"inherit",onClick:Kr,startIcon:n.jsx(dr,{}),"aria-pressed":at,sx:{mr:1,borderRadius:1.5,backgroundColor:at?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:at?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:at?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),n.jsx("div",{ref:e,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:me!==null&&n.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:n.jsxs(he,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[n.jsx(X,{variant:"subtitle1",sx:{mb:1},children:"Converting IFC…"}),n.jsx($n,{variant:"determinate",value:Math.max(0,Math.min(100,me)),sx:{height:10,borderRadius:1}}),n.jsxs(X,{variant:"caption",sx:{mt:1,display:"block"},children:[me.toFixed(1),"%"]}),n.jsx("div",{style:{marginTop:12},children:n.jsx(ce,{size:"small",variant:"outlined",color:"inherit",onClick:nn,disabled:gt,children:gt?"Cancelling…":"Cancel"})})]})})}),J?n.jsx(ur,{nodeRef:no,handle:".explorer-header",bounds:"parent",children:n.jsxs(he,{ref:no,elevation:8,sx:{position:"fixed",top:120,right:30,width:Rt.width,height:Q?"auto":Rt.height,minWidth:280,minHeight:Q?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[n.jsxs(W,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[n.jsx(X,{variant:"subtitle1",children:"Model Explorer"}),n.jsxs(W,{children:[n.jsx(ne,{size:"small",color:"inherit",onClick:an,title:Q?"Expand panel":"Minimize panel",children:Q?n.jsx(Mn,{}):n.jsx(Rn,{})}),n.jsx(ne,{size:"small",color:"inherit",onClick:ln,title:"Close Model Explorer",children:n.jsx(fr,{})})]})]}),!Q&&n.jsxs(W,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2,px:2,py:1,minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[n.jsx(ce,{variant:"contained",size:"small",onClick:()=>s.current?.click(),disabled:!fe,children:"Open IFC / FRAG"}),n.jsx(ie,{title:"Open parametric filter",children:n.jsx("span",{children:n.jsx(ce,{variant:"outlined",size:"small",onClick:()=>Ee(!0),disabled:!fe,startIcon:n.jsx(zn,{}),children:"Filter"})})}),!1,n.jsx(X,{variant:"caption",color:"text.secondary"}),n.jsx("input",{ref:s,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:rn})]}),n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1,overflow:"hidden",flexGrow:$e?1:0,flexShrink:$e?1:0,flexBasis:$e?0:"auto",minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[n.jsx(X,{variant:"subtitle2",children:"Loaded Models"}),n.jsx(ne,{size:"small",onClick:()=>Tr(t=>!t),title:Tt?"Expand Loaded Models":"Collapse Loaded Models",children:Tt?n.jsx(Eo,{fontSize:"small"}):n.jsx(jo,{fontSize:"small"})})]}),n.jsx(Xt,{in:!Tt,timeout:"auto",sx:{display:"flex",flexDirection:"column",flex:$e?"1 1 0":"0 0 auto",maxHeight:$e?"100%":`${qt}px`,minHeight:0},children:n.jsx(W,{ref:Fo,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:$e?"1 1 0":"0 0 auto",maxHeight:$e?"100%":`${qt}px`,minHeight:0},children:!fe&&n.jsx(X,{variant:"body2",color:"text.secondary",children:"Initializing components…"})})})]}),n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,overflow:"hidden",borderRadius:1.5,border:"1px solid",borderColor:"rgba(229, 57, 53, 0.45)",bgcolor:"rgba(229, 57, 53, 0.08)",p:1.5,flexGrow:Ze?0:1,flexShrink:Ze?0:1,flexBasis:"auto",minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[n.jsx(X,{variant:"subtitle2",children:"Selection Properties"}),n.jsx(ne,{size:"small",onClick:()=>Nr(t=>!t),title:Ze?"Expand Selection Properties":"Collapse Selection Properties",children:Ze?n.jsx(Eo,{fontSize:"small"}):n.jsx(jo,{fontSize:"small"})})]}),n.jsx(Xt,{in:!Ze,timeout:"auto",sx:{flex:Ze?"0 0 auto":"1 1 0",display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[n.jsxs(Fn,{value:Je,onChange:(t,o)=>Oo(o),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[n.jsx(pr,{value:"favorites",label:`Favourites (${ho.length})`}),n.jsx(pr,{value:"all",label:`All (${oe.length})`})]}),n.jsxs(W,{role:"tabpanel",hidden:Je!=="favorites",sx:{display:Je==="favorites"?"flex":"none",flexDirection:"column",flex:Je==="favorites"?1:0,minHeight:0},children:[ho.length?n.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:n.jsx(he,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:ho.map(bo)})}):n.jsx(he,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:n.jsx(X,{variant:"body2",color:"text.secondary",children:ge.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),yo>0&&ge.length>0&&n.jsx(Jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:yo===1?"1 favourite property is not available for this selection.":`${yo} favourite properties are not available for this selection.`})]}),n.jsxs(W,{role:"tabpanel",hidden:Je!=="all",sx:{display:Je==="all"?"flex":"none",flexDirection:"column",flex:Je==="all"?1:0,minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[n.jsx(vo,{size:"small",fullWidth:!0,value:No,onChange:t=>Fr(t.target.value),placeholder:"Search properties…",disabled:!oe.length}),n.jsx(ie,{title:"Copy raw element JSON",children:n.jsx("span",{children:n.jsx(ne,{size:"small",onClick:qr,disabled:!U,color:"primary",children:n.jsx(Dn,{fontSize:"small"})})})}),n.jsx(ie,{title:"Export properties",children:n.jsx("span",{children:n.jsx(ce,{variant:"outlined",size:"small",startIcon:n.jsx(Tn,{}),onClick:Hr,disabled:!oe.length&&!S.length,children:"Export"})})})]}),oe.length?Ur?Qo.length?n.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:n.jsx(he,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Qo.map(bo)})}):n.jsx(he,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:n.jsx(X,{variant:"body2",color:"text.secondary",children:`No properties matched "${Gt}".`})}):n.jsxs(W,{sx:{position:"relative",flex:1,minHeight:200},children:[n.jsx(he,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:go.map(bo)}),er>0&&n.jsx(Jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${go.length} properties. ${er} more not shown.`})]}):n.jsx(he,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:n.jsx(X,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / … breakdown."})})]})]})})]}),n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,overflow:"hidden",borderRadius:1.5,border:"1px solid",borderColor:"rgba(255, 179, 0, 0.5)",bgcolor:"rgba(255, 213, 79, 0.12)",p:1.5,flexGrow:Qe?0:1,flexShrink:Qe?0:1,flexBasis:"auto",minHeight:0},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[n.jsx(X,{variant:"subtitle2",children:"Model Tree"}),n.jsx(ne,{size:"small",onClick:()=>Lr(t=>!t),title:Qe?"Expand Model Tree":"Collapse Model Tree",children:Qe?n.jsx(Eo,{fontSize:"small"}):n.jsx(jo,{fontSize:"small"})})]}),n.jsx(Xt,{in:!Qe,timeout:"auto",sx:{flex:Qe?"0 0 auto":"1 1 0",display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:n.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[n.jsx(vo,{size:"small",fullWidth:!0,value:lt,onChange:t=>Dr(t.target.value),placeholder:"Search the model tree…",disabled:!S.length,sx:{flexShrink:0}}),n.jsxs(W,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[n.jsx(W,{ref:Ft,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!fe||!S.length)&&n.jsx(W,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:n.jsx(X,{variant:"body2",color:"text.secondary",children:fe?"Load a model to populate the full model tree.":"Viewer is initializing the model tree…"})})]})]})})]})]})]}),n.jsx(W,{onPointerDown:un,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}):n.jsx(he,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%"},children:n.jsx(ne,{onClick:dt,title:"Open Model Explorer",children:n.jsx(ar,{})})}),!it&&n.jsx(he,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%"},children:n.jsx(ne,{onClick:lr,title:"Open IDS Checker",children:n.jsx(cr,{})})}),!at&&n.jsx(he,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%"},children:n.jsx(ne,{onClick:()=>co(!0),title:"Open IDS Creator",children:n.jsx(dr,{})})}),Gr?n.jsx(ur,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:n.jsxs(he,{elevation:8,sx:{position:"absolute",bottom:90,padding:1.5,display:"flex",flexDirection:"column",gap:1,zIndex:1600,backgroundColor:"rgba(245, 245, 245, 0.98)",backdropFilter:"blur(10px)",borderRadius:2,cursor:"move",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[n.jsxs(W,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:.5,cursor:"grab","&:active":{cursor:"grabbing"}},children:[n.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.5},children:[n.jsx(Nn,{fontSize:"small",sx:{color:"text.secondary"}}),n.jsx(X,{variant:"caption",sx:{fontWeight:600,color:"primary.main"},children:"View Controls"})]}),n.jsx(ne,{size:"small",onClick:()=>qo(!1),title:"Close toolbar",sx:{ml:1},children:n.jsx(fr,{fontSize:"small"})})]}),n.jsxs(W,{sx:{display:"flex",gap:.5},children:[n.jsx(ie,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:pn,disabled:!d,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:n.jsx(mr,{fontSize:"small"})})}),n.jsx(ie,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:yn,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:n.jsx(Ln,{fontSize:"small"})})})]}),n.jsxs(W,{sx:{mt:.5},children:[n.jsx(X,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),n.jsxs(W,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[n.jsx(ie,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),n.jsx(ie,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),n.jsx(ie,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),n.jsx(ie,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),n.jsx(ie,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),n.jsx(ie,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ce,{size:"small",onClick:()=>ot("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),n.jsx(ie,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:n.jsxs(ce,{size:"small",onClick:()=>ot("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[n.jsx(On,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),n.jsxs(W,{sx:{mt:.5},children:[n.jsx(X,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),n.jsxs(W,{sx:{display:"flex",gap:.5},children:[n.jsx(ie,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:()=>Co("x"),sx:{border:"2px solid",borderColor:ee.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ee.x?"error.main":"white",color:ee.x?"white":"error.main","&:hover":{backgroundColor:ee.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:n.jsx(X,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),n.jsx(ie,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:()=>Co("y"),sx:{border:"2px solid",borderColor:ee.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ee.y?"success.main":"white",color:ee.y?"white":"success.main","&:hover":{backgroundColor:ee.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:n.jsx(X,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),n.jsx(ie,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:()=>Co("z"),sx:{border:"2px solid",borderColor:ee.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ee.z?"primary.main":"white",color:ee.z?"white":"primary.main","&:hover":{backgroundColor:ee.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:n.jsx(X,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ee.x&&n.jsxs(W,{sx:{mt:1},children:[n.jsxs(X,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",ke.x.toFixed(1)]}),n.jsx(Po,{value:ke.x,onChange:(t,o)=>So("x",o),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ee.y&&n.jsxs(W,{sx:{mt:1},children:[n.jsxs(X,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",ke.y.toFixed(1)]}),n.jsx(Po,{value:ke.y,onChange:(t,o)=>So("y",o),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ee.z&&n.jsxs(W,{sx:{mt:1},children:[n.jsxs(X,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",ke.z.toFixed(1)]}),n.jsx(Po,{value:ke.z,onChange:(t,o)=>So("z",o),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),n.jsxs(W,{sx:{display:"flex",gap:.5},children:[n.jsx(ie,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:bn,sx:{border:"2px solid",borderColor:It?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:It?"warning.main":"white",color:It?"white":"warning.dark","&:hover":{backgroundColor:It?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:n.jsx(Vn,{fontSize:"small"})})}),n.jsx(ie,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:wn,disabled:!ee.x&&!ee.y&&!ee.z&&!It,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:n.jsx(_n,{fontSize:"small"})})})]}),n.jsxs(W,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[n.jsx(ie,{title:Ct?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:n.jsx(ne,{size:"small",onClick:xn,sx:{border:"2px solid",borderColor:Ct?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ct?"success.main":"white",color:Ct?"white":"success.dark","&:hover":{backgroundColor:Ct?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:n.jsx(Bn,{fontSize:"small"})})}),Xo&&n.jsxs(X,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Xo," units"]})]})]})}):n.jsx(he,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%"},children:n.jsx(ne,{onClick:()=>qo(!0),title:"Open View Controls",children:n.jsx(mr,{})})}),n.jsx(g.Suspense,{fallback:null,children:G&&n.jsx(Gs,{open:G,onClose:()=>Ee(!1),viewerApi:st.current??null})}),n.jsxs(Gn,{open:Br,onClose:sr,fullWidth:!0,maxWidth:"sm",children:[n.jsx(Wn,{children:"Export properties"}),n.jsxs(Un,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[n.jsxs(Hn,{component:"fieldset",variant:"standard",children:[n.jsx(qn,{component:"legend",children:"Scope"}),n.jsxs(Yn,{value:Ge,onChange:t=>Wo(t.target.value),children:[n.jsx(gr,{value:"selected",control:n.jsx(hr,{}),label:"Selected items",disabled:!oe.length}),n.jsx(gr,{value:"model",control:n.jsx(hr,{}),label:"Specific model",disabled:!S.length})]})]}),n.jsx(Xt,{in:Ge==="model",unmountOnExit:!0,children:n.jsx(vo,{select:!0,fullWidth:!0,label:"Model",value:We,onChange:t=>Lt(t.target.value),disabled:!S.length,children:S.map(t=>n.jsx(ko,{value:t.id,children:t.label},t.id))})}),Ge==="selected"&&!oe.length&&n.jsx(Jt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Ho&&n.jsx(Jt,{severity:"error",variant:"outlined",children:Ho})]}),n.jsxs(Kn,{children:[n.jsx(ce,{onClick:sr,disabled:et,children:"Cancel"}),n.jsx(ce,{variant:"contained",onClick:Yr,disabled:et||Ge==="selected"&&!oe.length||Ge==="model"&&!We,children:et?"Exporting…":"Export CSV"})]})]}),n.jsxs(g.Suspense,{fallback:null,children:[n.jsx(_s,{isOpen:it,onOpen:lr,onClose:en,viewerApi:Io,hasModel:S.length>0,expandSignal:Vr}),n.jsx(Bs,{isOpen:at,onClose:()=>co(!1),viewerApi:Io,selectedItemData:U,onValidate:on}),n.jsx(Vs,{getModelDataForAI:fn,isOpen:xt,onOpen:Xr,onClose:Jr,expandSignal:Or,onRequestSelection:dn})]}),n.jsxs(Xn,{open:!!Dt,onClose:hn,anchorReference:"anchorPosition",anchorPosition:Dt?{top:Dt.mouseY,left:Dt.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[n.jsx(ko,{onClick:mn,disabled:E.length===0,children:"Hide selected element"}),n.jsx(ko,{onClick:gn,children:"Reset hidden elements"})]})]})};function oo(e,s=2e3){try{if(e==null)return"null";const i=typeof e=="string"?e:JSON.stringify(e,null,2);return i?i.length<=s?i:`${i.slice(0,s)}
... [truncated ${i.length-s} chars]`:""}catch{return String(e)}}Jn.createRoot(document.getElementById("root")).render(n.jsx(mt.StrictMode,{children:n.jsx(ol,{})}));export{Ts as a,il as g,$o as i,ll as p,Ls as u};
