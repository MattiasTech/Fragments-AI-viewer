(function(){"use strict";const $=":A-Za-z_\\u00C0-\\u00D6\\u00D8-\\u00F6\\u00F8-\\u02FF\\u0370-\\u037D\\u037F-\\u1FFF\\u200C-\\u200D\\u2070-\\u218F\\u2C00-\\u2FEF\\u3001-\\uD7FF\\uF900-\\uFDCF\\uFDF0-\\uFFFD",z=$+"\\-.\\d\\u00B7\\u0300-\\u036F\\u203F-\\u2040",x="["+$+"]["+z+"]*",K=new RegExp("^"+x+"$");function L(e,s){const t=[];let r=s.exec(e);for(;r;){const i=[];i.startIndex=s.lastIndex-r[0].length;const n=r.length;for(let o=0;o<n;o++)i.push(r[o]);t.push(i),r=s.exec(e)}return t}const S=function(e){const s=K.exec(e);return!(s===null||typeof s>"u")};function J(e){return typeof e<"u"}const Q={allowBooleanAttributes:!1,unpairedTags:[]};function W(e,s){s=Object.assign({},Q,s);const t=[];let r=!1,i=!1;e[0]==="\uFEFF"&&(e=e.substr(1));for(let n=0;n<e.length;n++)if(e[n]==="<"&&e[n+1]==="?"){if(n+=2,n=q(e,n),n.err)return n}else if(e[n]==="<"){let o=n;if(n++,e[n]==="!"){n=B(e,n);continue}else{let f=!1;e[n]==="/"&&(f=!0,n++);let a="";for(;n<e.length&&e[n]!==">"&&e[n]!==" "&&e[n]!=="	"&&e[n]!==`
`&&e[n]!=="\r";n++)a+=e[n];if(a=a.trim(),a[a.length-1]==="/"&&(a=a.substring(0,a.length-1),n--),!ie(a)){let c;return a.trim().length===0?c="Invalid space after '<'.":c="Tag '"+a+"' is an invalid name.",p("InvalidTag",c,g(e,n))}const l=ee(e,n);if(l===!1)return p("InvalidAttr","Attributes for '"+a+"' have open quote.",g(e,n));let d=l.value;if(n=l.index,d[d.length-1]==="/"){const c=n-d.length;d=d.substring(0,d.length-1);const u=U(d,s);if(u===!0)r=!0;else return p(u.err.code,u.err.msg,g(e,c+u.err.line))}else if(f)if(l.tagClosed){if(d.trim().length>0)return p("InvalidTag","Closing tag '"+a+"' can't have attributes or invalid starting.",g(e,o));if(t.length===0)return p("InvalidTag","Closing tag '"+a+"' has not been opened.",g(e,o));{const c=t.pop();if(a!==c.tagName){let u=g(e,c.tagStartPos);return p("InvalidTag","Expected closing tag '"+c.tagName+"' (opened in line "+u.line+", col "+u.col+") instead of closing tag '"+a+"'.",g(e,o))}t.length==0&&(i=!0)}}else return p("InvalidTag","Closing tag '"+a+"' doesn't have proper closing.",g(e,n));else{const c=U(d,s);if(c!==!0)return p(c.err.code,c.err.msg,g(e,n-d.length+c.err.line));if(i===!0)return p("InvalidXml","Multiple possible root nodes found.",g(e,n));s.unpairedTags.indexOf(a)!==-1||t.push({tagName:a,tagStartPos:o}),r=!0}for(n++;n<e.length;n++)if(e[n]==="<")if(e[n+1]==="!"){n++,n=B(e,n);continue}else if(e[n+1]==="?"){if(n=q(e,++n),n.err)return n}else break;else if(e[n]==="&"){const c=ne(e,n);if(c==-1)return p("InvalidChar","char '&' is not expected.",g(e,n));n=c}else if(i===!0&&!j(e[n]))return p("InvalidXml","Extra text at the end",g(e,n));e[n]==="<"&&n--}}else{if(j(e[n]))continue;return p("InvalidChar","char '"+e[n]+"' is not expected.",g(e,n))}if(r){if(t.length==1)return p("InvalidTag","Unclosed tag '"+t[0].tagName+"'.",g(e,t[0].tagStartPos));if(t.length>0)return p("InvalidXml","Invalid '"+JSON.stringify(t.map(n=>n.tagName),null,4).replace(/\r?\n/g,"")+"' found.",{line:1,col:1})}else return p("InvalidXml","Start tag expected.",1);return!0}function j(e){return e===" "||e==="	"||e===`
`||e==="\r"}function q(e,s){const t=s;for(;s<e.length;s++)if(e[s]=="?"||e[s]==" "){const r=e.substr(t,s-t);if(s>5&&r==="xml")return p("InvalidXml","XML declaration allowed only at the start of the document.",g(e,s));if(e[s]=="?"&&e[s+1]==">"){s++;break}else continue}return s}function B(e,s){if(e.length>s+5&&e[s+1]==="-"&&e[s+2]==="-"){for(s+=3;s<e.length;s++)if(e[s]==="-"&&e[s+1]==="-"&&e[s+2]===">"){s+=2;break}}else if(e.length>s+8&&e[s+1]==="D"&&e[s+2]==="O"&&e[s+3]==="C"&&e[s+4]==="T"&&e[s+5]==="Y"&&e[s+6]==="P"&&e[s+7]==="E"){let t=1;for(s+=8;s<e.length;s++)if(e[s]==="<")t++;else if(e[s]===">"&&(t--,t===0))break}else if(e.length>s+9&&e[s+1]==="["&&e[s+2]==="C"&&e[s+3]==="D"&&e[s+4]==="A"&&e[s+5]==="T"&&e[s+6]==="A"&&e[s+7]==="["){for(s+=8;s<e.length;s++)if(e[s]==="]"&&e[s+1]==="]"&&e[s+2]===">"){s+=2;break}}return s}const H='"',D="'";function ee(e,s){let t="",r="",i=!1;for(;s<e.length;s++){if(e[s]===H||e[s]===D)r===""?r=e[s]:r!==e[s]||(r="");else if(e[s]===">"&&r===""){i=!0;break}t+=e[s]}return r!==""?!1:{value:t,index:s,tagClosed:i}}const te=new RegExp(`(\\s*)([^\\s=]+)(\\s*=)?(\\s*(['"])(([\\s\\S])*?)\\5)?`,"g");function U(e,s){const t=L(e,te),r={};for(let i=0;i<t.length;i++){if(t[i][1].length===0)return p("InvalidAttr","Attribute '"+t[i][2]+"' has no space in starting.",v(t[i]));if(t[i][3]!==void 0&&t[i][4]===void 0)return p("InvalidAttr","Attribute '"+t[i][2]+"' is without value.",v(t[i]));if(t[i][3]===void 0&&!s.allowBooleanAttributes)return p("InvalidAttr","boolean attribute '"+t[i][2]+"' is not allowed.",v(t[i]));const n=t[i][2];if(!re(n))return p("InvalidAttr","Attribute '"+n+"' is an invalid name.",v(t[i]));if(!r.hasOwnProperty(n))r[n]=1;else return p("InvalidAttr","Attribute '"+n+"' is repeated.",v(t[i]))}return!0}function se(e,s){let t=/\d/;for(e[s]==="x"&&(s++,t=/[\da-fA-F]/);s<e.length;s++){if(e[s]===";")return s;if(!e[s].match(t))break}return-1}function ne(e,s){if(s++,e[s]===";")return-1;if(e[s]==="#")return s++,se(e,s);let t=0;for(;s<e.length;s++,t++)if(!(e[s].match(/\w/)&&t<20)){if(e[s]===";")break;return-1}return s}function p(e,s,t){return{err:{code:e,msg:s,line:t.line||t,col:t.col}}}function re(e){return S(e)}function ie(e){return S(e)}function g(e,s){const t=e.substring(0,s).split(/\r?\n/);return{line:t.length,col:t[t.length-1].length+1}}function v(e){return e.startIndex+e[1].length}const oe={preserveOrder:!1,attributeNamePrefix:"@_",attributesGroupName:!1,textNodeName:"#text",ignoreAttributes:!0,removeNSPrefix:!1,allowBooleanAttributes:!1,parseTagValue:!0,parseAttributeValue:!1,trimValues:!0,cdataPropName:!1,numberParseOptions:{hex:!0,leadingZeros:!0,eNotation:!0},tagValueProcessor:function(e,s){return s},attributeValueProcessor:function(e,s){return s},stopNodes:[],alwaysCreateTextNode:!1,isArray:()=>!1,commentPropName:!1,unpairedTags:[],processEntities:!0,htmlEntities:!1,ignoreDeclaration:!1,ignorePiTags:!1,transformTagName:!1,transformAttributeName:!1,updateTag:function(e,s,t){return e},captureMetaData:!1},ae=function(e){return Object.assign({},oe,e)};let O;typeof Symbol!="function"?O="@@xmlMetadata":O=Symbol("XML Node Metadata");class T{constructor(s){this.tagname=s,this.child=[],this[":@"]={}}add(s,t){s==="__proto__"&&(s="#__proto__"),this.child.push({[s]:t})}addChild(s,t){s.tagname==="__proto__"&&(s.tagname="#__proto__"),s[":@"]&&Object.keys(s[":@"]).length>0?this.child.push({[s.tagname]:s.child,":@":s[":@"]}):this.child.push({[s.tagname]:s.child}),t!==void 0&&(this.child[this.child.length-1][O]={startIndex:t})}static getMetaDataSymbol(){return O}}class le{constructor(s){this.suppressValidationErr=!s}readDocType(s,t){const r={};if(s[t+3]==="O"&&s[t+4]==="C"&&s[t+5]==="T"&&s[t+6]==="Y"&&s[t+7]==="P"&&s[t+8]==="E"){t=t+9;let i=1,n=!1,o=!1,f="";for(;t<s.length;t++)if(s[t]==="<"&&!o){if(n&&m(s,"!ENTITY",t)){t+=7;let a,l;[a,l,t]=this.readEntityExp(s,t+1,this.suppressValidationErr),l.indexOf("&")===-1&&(r[a]={regx:RegExp(`&${a};`,"g"),val:l})}else if(n&&m(s,"!ELEMENT",t)){t+=8;const{index:a}=this.readElementExp(s,t+1);t=a}else if(n&&m(s,"!ATTLIST",t))t+=8;else if(n&&m(s,"!NOTATION",t)){t+=9;const{index:a}=this.readNotationExp(s,t+1,this.suppressValidationErr);t=a}else if(m(s,"!--",t))o=!0;else throw new Error("Invalid DOCTYPE");i++,f=""}else if(s[t]===">"){if(o?s[t-1]==="-"&&s[t-2]==="-"&&(o=!1,i--):i--,i===0)break}else s[t]==="["?n=!0:f+=s[t];if(i!==0)throw new Error("Unclosed DOCTYPE")}else throw new Error("Invalid Tag instead of DOCTYPE");return{entities:r,i:t}}readEntityExp(s,t){t=w(s,t);let r="";for(;t<s.length&&!/\s/.test(s[t])&&s[t]!=='"'&&s[t]!=="'";)r+=s[t],t++;if(C(r),t=w(s,t),!this.suppressValidationErr){if(s.substring(t,t+6).toUpperCase()==="SYSTEM")throw new Error("External entities are not supported");if(s[t]==="%")throw new Error("Parameter entities are not supported")}let i="";return[t,i]=this.readIdentifierVal(s,t,"entity"),t--,[r,i,t]}readNotationExp(s,t){t=w(s,t);let r="";for(;t<s.length&&!/\s/.test(s[t]);)r+=s[t],t++;!this.suppressValidationErr&&C(r),t=w(s,t);const i=s.substring(t,t+6).toUpperCase();if(!this.suppressValidationErr&&i!=="SYSTEM"&&i!=="PUBLIC")throw new Error(`Expected SYSTEM or PUBLIC, found "${i}"`);t+=i.length,t=w(s,t);let n=null,o=null;if(i==="PUBLIC")[t,n]=this.readIdentifierVal(s,t,"publicIdentifier"),t=w(s,t),(s[t]==='"'||s[t]==="'")&&([t,o]=this.readIdentifierVal(s,t,"systemIdentifier"));else if(i==="SYSTEM"&&([t,o]=this.readIdentifierVal(s,t,"systemIdentifier"),!this.suppressValidationErr&&!o))throw new Error("Missing mandatory system identifier for SYSTEM notation");return{notationName:r,publicIdentifier:n,systemIdentifier:o,index:--t}}readIdentifierVal(s,t,r){let i="";const n=s[t];if(n!=='"'&&n!=="'")throw new Error(`Expected quoted string, found "${n}"`);for(t++;t<s.length&&s[t]!==n;)i+=s[t],t++;if(s[t]!==n)throw new Error(`Unterminated ${r} value`);return t++,[t,i]}readElementExp(s,t){t=w(s,t);let r="";for(;t<s.length&&!/\s/.test(s[t]);)r+=s[t],t++;if(!this.suppressValidationErr&&!S(r))throw new Error(`Invalid element name: "${r}"`);t=w(s,t);let i="";if(s[t]==="E"&&m(s,"MPTY",t))t+=4;else if(s[t]==="A"&&m(s,"NY",t))t+=2;else if(s[t]==="("){for(t++;t<s.length&&s[t]!==")";)i+=s[t],t++;if(s[t]!==")")throw new Error("Unterminated content model")}else if(!this.suppressValidationErr)throw new Error(`Invalid Element Expression, found "${s[t]}"`);return{elementName:r,contentModel:i.trim(),index:t}}readAttlistExp(s,t){t=w(s,t);let r="";for(;t<s.length&&!/\s/.test(s[t]);)r+=s[t],t++;C(r),t=w(s,t);let i="";for(;t<s.length&&!/\s/.test(s[t]);)i+=s[t],t++;if(!C(i))throw new Error(`Invalid attribute name: "${i}"`);t=w(s,t);let n="";if(s.substring(t,t+8).toUpperCase()==="NOTATION"){if(n="NOTATION",t+=8,t=w(s,t),s[t]!=="(")throw new Error(`Expected '(', found "${s[t]}"`);t++;let f=[];for(;t<s.length&&s[t]!==")";){let a="";for(;t<s.length&&s[t]!=="|"&&s[t]!==")";)a+=s[t],t++;if(a=a.trim(),!C(a))throw new Error(`Invalid notation name: "${a}"`);f.push(a),s[t]==="|"&&(t++,t=w(s,t))}if(s[t]!==")")throw new Error("Unterminated list of notations");t++,n+=" ("+f.join("|")+")"}else{for(;t<s.length&&!/\s/.test(s[t]);)n+=s[t],t++;const f=["CDATA","ID","IDREF","IDREFS","ENTITY","ENTITIES","NMTOKEN","NMTOKENS"];if(!this.suppressValidationErr&&!f.includes(n.toUpperCase()))throw new Error(`Invalid attribute type: "${n}"`)}t=w(s,t);let o="";return s.substring(t,t+8).toUpperCase()==="#REQUIRED"?(o="#REQUIRED",t+=8):s.substring(t,t+7).toUpperCase()==="#IMPLIED"?(o="#IMPLIED",t+=7):[t,o]=this.readIdentifierVal(s,t,"ATTLIST"),{elementName:r,attributeName:i,attributeType:n,defaultValue:o,index:t}}}const w=(e,s)=>{for(;s<e.length&&/\s/.test(e[s]);)s++;return s};function m(e,s,t){for(let r=0;r<s.length;r++)if(s[r]!==e[t+r+1])return!1;return!0}function C(e){if(S(e))return e;throw new Error(`Invalid entity name ${e}`)}const fe=/^[-+]?0x[a-fA-F0-9]+$/,ue=/^([\-\+])?(0*)([0-9]*(\.[0-9]*)?)$/,ce={hex:!0,leadingZeros:!0,decimalPoint:".",eNotation:!0};function de(e,s={}){if(s=Object.assign({},ce,s),!e||typeof e!="string")return e;let t=e.trim();if(s.skipLike!==void 0&&s.skipLike.test(t))return e;if(e==="0")return 0;if(s.hex&&fe.test(t))return Ee(t,16);if(t.search(/.+[eE].+/)!==-1)return pe(e,t,s);{const r=ue.exec(t);if(r){const i=r[1]||"",n=r[2];let o=ge(r[3]);const f=i?e[n.length+1]===".":e[n.length]===".";if(!s.leadingZeros&&(n.length>1||n.length===1&&!f))return e;{const a=Number(t),l=String(a);if(a===0)return a;if(l.search(/[eE]/)!==-1)return s.eNotation?a:e;if(t.indexOf(".")!==-1)return l==="0"||l===o||l===`${i}${o}`?a:e;let d=n?o:t;return n?d===l||i+d===l?a:e:d===l||d===i+l?a:e}}else return e}}const he=/^([-+])?(0*)(\d*(\.\d*)?[eE][-\+]?\d+)$/;function pe(e,s,t){if(!t.eNotation)return e;const r=s.match(he);if(r){let i=r[1]||"";const n=r[3].indexOf("e")===-1?"E":"e",o=r[2],f=i?e[o.length+1]===n:e[o.length]===n;return o.length>1&&f?e:o.length===1&&(r[3].startsWith(`.${n}`)||r[3][0]===n)?Number(s):t.leadingZeros&&!f?(s=(r[1]||"")+r[3],Number(s)):e}else return e}function ge(e){return e&&e.indexOf(".")!==-1&&(e=e.replace(/0+$/,""),e==="."?e="0":e[0]==="."?e="0"+e:e[e.length-1]==="."&&(e=e.substring(0,e.length-1))),e}function Ee(e,s){if(parseInt)return parseInt(e,s);if(Number.parseInt)return Number.parseInt(e,s);if(window&&window.parseInt)return window.parseInt(e,s);throw new Error("parseInt, Number.parseInt, window.parseInt are not supported")}function be(e){return typeof e=="function"?e:Array.isArray(e)?s=>{for(const t of e)if(typeof t=="string"&&s===t||t instanceof RegExp&&t.test(s))return!0}:()=>!1}class we{constructor(s){this.options=s,this.currentNode=null,this.tagsNodeStack=[],this.docTypeEntities={},this.lastEntities={apos:{regex:/&(apos|#39|#x27);/g,val:"'"},gt:{regex:/&(gt|#62|#x3E);/g,val:">"},lt:{regex:/&(lt|#60|#x3C);/g,val:"<"},quot:{regex:/&(quot|#34|#x22);/g,val:'"'}},this.ampEntity={regex:/&(amp|#38|#x26);/g,val:"&"},this.htmlEntities={space:{regex:/&(nbsp|#160);/g,val:" "},cent:{regex:/&(cent|#162);/g,val:"¢"},pound:{regex:/&(pound|#163);/g,val:"£"},yen:{regex:/&(yen|#165);/g,val:"¥"},euro:{regex:/&(euro|#8364);/g,val:"€"},copyright:{regex:/&(copy|#169);/g,val:"©"},reg:{regex:/&(reg|#174);/g,val:"®"},inr:{regex:/&(inr|#8377);/g,val:"₹"},num_dec:{regex:/&#([0-9]{1,7});/g,val:(t,r)=>String.fromCodePoint(Number.parseInt(r,10))},num_hex:{regex:/&#x([0-9a-fA-F]{1,6});/g,val:(t,r)=>String.fromCodePoint(Number.parseInt(r,16))}},this.addExternalEntities=ye,this.parseXml=Ae,this.parseTextData=Ne,this.resolveNameSpace=Ie,this.buildAttributesMap=me,this.isItStopNode=Se,this.replaceEntitiesValue=Ce,this.readStopNodeData=Ve,this.saveTextToParentTag=Pe,this.addChild=ve,this.ignoreAttributesFn=be(this.options.ignoreAttributes)}}function ye(e){const s=Object.keys(e);for(let t=0;t<s.length;t++){const r=s[t];this.lastEntities[r]={regex:new RegExp("&"+r+";","g"),val:e[r]}}}function Ne(e,s,t,r,i,n,o){if(e!==void 0&&(this.options.trimValues&&!r&&(e=e.trim()),e.length>0)){o||(e=this.replaceEntitiesValue(e));const f=this.options.tagValueProcessor(s,e,t,i,n);return f==null?e:typeof f!=typeof e||f!==e?f:this.options.trimValues?_(e,this.options.parseTagValue,this.options.numberParseOptions):e.trim()===e?_(e,this.options.parseTagValue,this.options.numberParseOptions):e}}function Ie(e){if(this.options.removeNSPrefix){const s=e.split(":"),t=e.charAt(0)==="/"?"/":"";if(s[0]==="xmlns")return"";s.length===2&&(e=t+s[1])}return e}const Te=new RegExp(`([^\\s=]+)\\s*(=\\s*(['"])([\\s\\S]*?)\\3)?`,"gm");function me(e,s,t){if(this.options.ignoreAttributes!==!0&&typeof e=="string"){const r=L(e,Te),i=r.length,n={};for(let o=0;o<i;o++){const f=this.resolveNameSpace(r[o][1]);if(this.ignoreAttributesFn(f,s))continue;let a=r[o][4],l=this.options.attributeNamePrefix+f;if(f.length)if(this.options.transformAttributeName&&(l=this.options.transformAttributeName(l)),l==="__proto__"&&(l="#__proto__"),a!==void 0){this.options.trimValues&&(a=a.trim()),a=this.replaceEntitiesValue(a);const d=this.options.attributeValueProcessor(f,a,s);d==null?n[l]=a:typeof d!=typeof a||d!==a?n[l]=d:n[l]=_(a,this.options.parseAttributeValue,this.options.numberParseOptions)}else this.options.allowBooleanAttributes&&(n[l]=!0)}if(!Object.keys(n).length)return;if(this.options.attributesGroupName){const o={};return o[this.options.attributesGroupName]=n,o}return n}}const Ae=function(e){e=e.replace(/\r\n?/g,`
`);const s=new T("!xml");let t=s,r="",i="";const n=new le(this.options.processEntities);for(let o=0;o<e.length;o++)if(e[o]==="<")if(e[o+1]==="/"){const a=A(e,">",o,"Closing Tag is not closed.");let l=e.substring(o+2,a).trim();if(this.options.removeNSPrefix){const u=l.indexOf(":");u!==-1&&(l=l.substr(u+1))}this.options.transformTagName&&(l=this.options.transformTagName(l)),t&&(r=this.saveTextToParentTag(r,t,i));const d=i.substring(i.lastIndexOf(".")+1);if(l&&this.options.unpairedTags.indexOf(l)!==-1)throw new Error(`Unpaired tag can not be used as closing tag: </${l}>`);let c=0;d&&this.options.unpairedTags.indexOf(d)!==-1?(c=i.lastIndexOf(".",i.lastIndexOf(".")-1),this.tagsNodeStack.pop()):c=i.lastIndexOf("."),i=i.substring(0,c),t=this.tagsNodeStack.pop(),r="",o=a}else if(e[o+1]==="?"){let a=M(e,o,!1,"?>");if(!a)throw new Error("Pi Tag is not closed.");if(r=this.saveTextToParentTag(r,t,i),!(this.options.ignoreDeclaration&&a.tagName==="?xml"||this.options.ignorePiTags)){const l=new T(a.tagName);l.add(this.options.textNodeName,""),a.tagName!==a.tagExp&&a.attrExpPresent&&(l[":@"]=this.buildAttributesMap(a.tagExp,i,a.tagName)),this.addChild(t,l,i,o)}o=a.closeIndex+1}else if(e.substr(o+1,3)==="!--"){const a=A(e,"-->",o+4,"Comment is not closed.");if(this.options.commentPropName){const l=e.substring(o+4,a-2);r=this.saveTextToParentTag(r,t,i),t.add(this.options.commentPropName,[{[this.options.textNodeName]:l}])}o=a}else if(e.substr(o+1,2)==="!D"){const a=n.readDocType(e,o);this.docTypeEntities=a.entities,o=a.i}else if(e.substr(o+1,2)==="!["){const a=A(e,"]]>",o,"CDATA is not closed.")-2,l=e.substring(o+9,a);r=this.saveTextToParentTag(r,t,i);let d=this.parseTextData(l,t.tagname,i,!0,!1,!0,!0);d==null&&(d=""),this.options.cdataPropName?t.add(this.options.cdataPropName,[{[this.options.textNodeName]:l}]):t.add(this.options.textNodeName,d),o=a+2}else{let a=M(e,o,this.options.removeNSPrefix),l=a.tagName;const d=a.rawTagName;let c=a.tagExp,u=a.attrExpPresent,I=a.closeIndex;this.options.transformTagName&&(l=this.options.transformTagName(l)),t&&r&&t.tagname!=="!xml"&&(r=this.saveTextToParentTag(r,t,i,!1));const h=t;h&&this.options.unpairedTags.indexOf(h.tagname)!==-1&&(t=this.tagsNodeStack.pop(),i=i.substring(0,i.lastIndexOf("."))),l!==s.tagname&&(i+=i?"."+l:l);const E=o;if(this.isItStopNode(this.options.stopNodes,i,l)){let b="";if(c.length>0&&c.lastIndexOf("/")===c.length-1)l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),c=l):c=c.substr(0,c.length-1),o=a.closeIndex;else if(this.options.unpairedTags.indexOf(l)!==-1)o=a.closeIndex;else{const R=this.readStopNodeData(e,d,I+1);if(!R)throw new Error(`Unexpected end of ${d}`);o=R.i,b=R.tagContent}const k=new T(l);l!==c&&u&&(k[":@"]=this.buildAttributesMap(c,i,l)),b&&(b=this.parseTextData(b,l,i,!0,u,!0,!0)),i=i.substr(0,i.lastIndexOf(".")),k.add(this.options.textNodeName,b),this.addChild(t,k,i,E)}else{if(c.length>0&&c.lastIndexOf("/")===c.length-1){l[l.length-1]==="/"?(l=l.substr(0,l.length-1),i=i.substr(0,i.length-1),c=l):c=c.substr(0,c.length-1),this.options.transformTagName&&(l=this.options.transformTagName(l));const b=new T(l);l!==c&&u&&(b[":@"]=this.buildAttributesMap(c,i,l)),this.addChild(t,b,i,E),i=i.substr(0,i.lastIndexOf("."))}else{const b=new T(l);this.tagsNodeStack.push(t),l!==c&&u&&(b[":@"]=this.buildAttributesMap(c,i,l)),this.addChild(t,b,i,E),t=b}r="",o=I}}else r+=e[o];return s.child};function ve(e,s,t,r){this.options.captureMetaData||(r=void 0);const i=this.options.updateTag(s.tagname,t,s[":@"]);i===!1||(typeof i=="string"&&(s.tagname=i),e.addChild(s,r))}const Ce=function(e){if(this.options.processEntities){for(let s in this.docTypeEntities){const t=this.docTypeEntities[s];e=e.replace(t.regx,t.val)}for(let s in this.lastEntities){const t=this.lastEntities[s];e=e.replace(t.regex,t.val)}if(this.options.htmlEntities)for(let s in this.htmlEntities){const t=this.htmlEntities[s];e=e.replace(t.regex,t.val)}e=e.replace(this.ampEntity.regex,this.ampEntity.val)}return e};function Pe(e,s,t,r){return e&&(r===void 0&&(r=s.child.length===0),e=this.parseTextData(e,s.tagname,t,!1,s[":@"]?Object.keys(s[":@"]).length!==0:!1,r),e!==void 0&&e!==""&&s.add(this.options.textNodeName,e),e=""),e}function Se(e,s,t){const r="*."+t;for(const i in e){const n=e[i];if(r===n||s===n)return!0}return!1}function Oe(e,s,t=">"){let r,i="";for(let n=s;n<e.length;n++){let o=e[n];if(r)o===r&&(r="");else if(o==='"'||o==="'")r=o;else if(o===t[0])if(t[1]){if(e[n+1]===t[1])return{data:i,index:n}}else return{data:i,index:n};else o==="	"&&(o=" ");i+=o}}function A(e,s,t,r){const i=e.indexOf(s,t);if(i===-1)throw new Error(r);return i+s.length-1}function M(e,s,t,r=">"){const i=Oe(e,s+1,r);if(!i)return;let n=i.data;const o=i.index,f=n.search(/\s/);let a=n,l=!0;f!==-1&&(a=n.substring(0,f),n=n.substring(f+1).trimStart());const d=a;if(t){const c=a.indexOf(":");c!==-1&&(a=a.substr(c+1),l=a!==i.data.substr(c+1))}return{tagName:a,tagExp:n,closeIndex:o,attrExpPresent:l,rawTagName:d}}function Ve(e,s,t){const r=t;let i=1;for(;t<e.length;t++)if(e[t]==="<")if(e[t+1]==="/"){const n=A(e,">",t,`${s} is not closed`);if(e.substring(t+2,n).trim()===s&&(i--,i===0))return{tagContent:e.substring(r,t),i:n};t=n}else if(e[t+1]==="?")t=A(e,"?>",t+1,"StopNode is not closed.");else if(e.substr(t+1,3)==="!--")t=A(e,"-->",t+3,"StopNode is not closed.");else if(e.substr(t+1,2)==="![")t=A(e,"]]>",t,"StopNode is not closed.")-2;else{const n=M(e,t,">");n&&((n&&n.tagName)===s&&n.tagExp[n.tagExp.length-1]!=="/"&&i++,t=n.closeIndex)}}function _(e,s,t){if(s&&typeof e=="string"){const r=e.trim();return r==="true"?!0:r==="false"?!1:de(e,t)}else return J(e)?e:""}const F=T.getMetaDataSymbol();function Me(e,s){return X(e,s)}function X(e,s,t){let r;const i={};for(let n=0;n<e.length;n++){const o=e[n],f=_e(o);let a="";if(t===void 0?a=f:a=t+"."+f,f===s.textNodeName)r===void 0?r=o[f]:r+=""+o[f];else{if(f===void 0)continue;if(o[f]){let l=X(o[f],s,a);const d=ke(l,s);o[F]!==void 0&&(l[F]=o[F]),o[":@"]?Fe(l,o[":@"],a,s):Object.keys(l).length===1&&l[s.textNodeName]!==void 0&&!s.alwaysCreateTextNode?l=l[s.textNodeName]:Object.keys(l).length===0&&(s.alwaysCreateTextNode?l[s.textNodeName]="":l=""),i[f]!==void 0&&i.hasOwnProperty(f)?(Array.isArray(i[f])||(i[f]=[i[f]]),i[f].push(l)):s.isArray(f,a,d)?i[f]=[l]:i[f]=l}}}return typeof r=="string"?r.length>0&&(i[s.textNodeName]=r):r!==void 0&&(i[s.textNodeName]=r),i}function _e(e){const s=Object.keys(e);for(let t=0;t<s.length;t++){const r=s[t];if(r!==":@")return r}}function Fe(e,s,t,r){if(s){const i=Object.keys(s),n=i.length;for(let o=0;o<n;o++){const f=i[o];r.isArray(f,t+"."+f,!0,!0)?e[f]=[s[f]]:e[f]=s[f]}}}function ke(e,s){const{textNodeName:t}=s,r=Object.keys(e).length;return!!(r===0||r===1&&(e[t]||typeof e[t]=="boolean"||e[t]===0))}class Y{constructor(s){this.externalEntities={},this.options=ae(s)}parse(s,t){if(typeof s!="string"&&s.toString)s=s.toString();else if(typeof s!="string")throw new Error("XML data is accepted in String or Bytes[] form.");if(t){t===!0&&(t={});const n=W(s,t);if(n!==!0)throw Error(`${n.err.msg}:${n.err.line}:${n.err.col}`)}const r=new we(this.options);r.addExternalEntities(this.externalEntities);const i=r.parseXml(s);return this.options.preserveOrder||i===void 0?i:Me(i,this.options)}addEntity(s,t){if(t.indexOf("&")!==-1)throw new Error("Entity value can't have '&'");if(s.indexOf("&")!==-1||s.indexOf(";")!==-1)throw new Error("An entity must be set without '&' and ';'. Eg. use '#xD' for '&#xD;'");if(t==="&")throw new Error("An entity with value '&' is not permitted");this.externalEntities[s]=t}static getMetaDataSymbol(){return T.getMetaDataSymbol()}}const Re=new Y({ignoreAttributes:!1,allowBooleanAttributes:!0,attributeNamePrefix:"@_",removeNSPrefix:!0,trimValues:!0}),$e=/[^a-zA-Z0-9_.:-]+/g,Z=e=>e?e.trim().replace(/\s+/g,"_").replace($e,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Le=e=>e?e.trim():"",P=e=>Array.isArray(e)?e:e==null?[]:[e],y=e=>{if(e!=null){if(typeof e=="string")return e.trim();if(typeof e=="number"||typeof e=="boolean")return String(e);if(typeof e=="object"){const s=[e["@_value"],e.value,e.Value,e["#text"],e.simpleValue,e.SimpleValue,e["ids:simpleValue"],e["ids:SimpleValue"],e.text,e.Text];for(const t of s)if(typeof t=="string"){const r=t.trim();if(r.length)return r}for(const t of s)if(t&&typeof t=="object"){const r=y(t);if(r)return r}for(const t of Object.values(e)){if(typeof t=="string"){const r=t.trim();if(r.length)return r}if(t&&typeof t=="object"){const r=y(t);if(r)return r}}}}},G=e=>{if(!e)return;switch(e.trim().toLowerCase()){case"required":return{min:1};case"optional":return{min:0};case"prohibited":case"forbidden":case"excluded":return{min:0,max:0};default:return}},je=(e,s)=>{const t=G(s);if(t)return t;const r=y(e)??s;if(!r)return;const i=r.split(":");if(i.length===1){const l=G(i[0]);if(l)return l}const[n,o]=i,f=Number(n),a=o===void 0||o==="*"?void 0:Number(o);if(Number.isFinite(f)&&!(a!==void 0&&!Number.isFinite(a)))return{min:f,max:a}},qe=e=>{const s=e.trim();if(!s)return[];const t=s.match(/<ids:ids[\s\S]*?<\/ids:ids>/gi);return t&&t.length?t:[s]},Be=e=>{if(!e)return[];const s=e.ids??e.IDS??e;if(!s)return[];const t=s.specification??s.Specification??[];return P(t)},Ue=e=>{const s=new Set,t=i=>{if(i==null)return;(Array.isArray(i)?i:[i]).forEach(o=>{const f=y(o);f?s.add(f):o&&typeof o=="object"&&Object.values(o).forEach(a=>{const l=y(a);l&&s.add(l)})})},r=e.allowedValues??e.AllowedValues??e["ids:allowedValues"];return r&&(t(r),[r.values,r.Values,r["ids:values"]].forEach(n=>{if(!n)return;(Array.isArray(n)?n:[n]).forEach(f=>{t(f),t(f.value??f.Value??f["ids:value"])})})),t(e.value??e.Value??e["ids:value"]),t(e.accept??e.Accept??e["ids:accept"]),Array.from(s.values()).filter(i=>i.length)},Xe=e=>{if(!e||typeof e!="object")return null;const s=y(e.propertySet??e.PropertySet??e["ids:propertySet"]??e["ids:PropertySet"]),r=y(e.baseName??e.BaseName??e["ids:baseName"]??e["ids:BaseName"])??y(e.name??e.Name??e["ids:name"]??e["ids:Name"]);if(!s||!r)return null;const i=`${Z(s)}.${Z(r)}`,n=je(e.cardinality??e.Cardinality??e["ids:cardinality"],e["@_cardinality"]??e["@_Cardinality"]),o=Ue(e),f=y(e.description??e.Description??e["ids:description"]);return{path:i,expected:o.length?o:void 0,cardinality:n,description:f}},Ye=(e,s)=>{const t=y(e["@_id"]??e["@_identifier"])??`spec-${s+1}`,r=y(e["@_name"]??e.name??e.Name)??t,i=e.applicability??e.Applicability??e["ids:applicability"]??e["ids:Applicability"],o=P(i?.entity??i?.Entity??i?.["ids:entity"]??i?.["ids:Entity"]).map(u=>{const I=y(u["@_name"]??u.name??u.Name??u["ids:name"]??u["ids:Name"]);return Le(I??y(u))}).filter(u=>u.length),a=[e.requirement,e.Requirement,e["ids:requirement"],e.requirements,e.Requirements,e["ids:requirements"]].flatMap(u=>P(u).filter(Boolean)),l=[],d=u=>{if(!u||typeof u!="object")return[];const h=[u.property,u.Property,u["ids:property"],u.properties,u.Properties,u["ids:properties"]].flatMap(E=>P(E).filter(Boolean));return h.length?h:u.propertySet||u.PropertySet||u["ids:propertySet"]?[u]:[]},c=u=>{if(!u||typeof u!="object")return;d(u).forEach(h=>{const E=Xe(h);E&&l.push(E)}),P(u.requirement??u.Requirement??u["ids:requirement"]??u.requirements??u.Requirements??u["ids:requirements"]).forEach(h=>c(h))};return a.length?a.forEach(u=>{c(u)}):c(e),l.length?{id:t,title:r,applicability:{ifcClasses:o},properties:l}:null},Ze=e=>{const s=qe(e),t=[];return s.forEach(r=>{try{const i=Re.parse(r);Be(i).forEach((o,f)=>{const a=Ye(o,f+t.length);a&&t.push(a)})}catch(i){console.warn("Failed to parse IDS specification",i)}}),t},Ge=(e,s)=>{if(s in e){const r=e[s];return typeof r=="string"?r:r?.toString()}const t=s.toLowerCase();for(const[r,i]of Object.entries(e))if(r.toLowerCase()===t)return typeof i=="string"?i:i?.toString()},ze=(e,s)=>{const t=Ge(e.properties,s.path);if(t==null||t===""){if(s.cardinality&&s.cardinality.min>0)return{status:"FAILED",reason:"Property missing",actual:t??""};if(!s.cardinality)return{status:"FAILED",reason:"Property missing",actual:t??""}}if(s.expected&&s.expected.length){const r=t?.trim?.()??"";if(!s.expected.some(n=>n===r))return{status:"FAILED",reason:`Value does not match expected list (${s.expected.join(", ")})`,actual:r}}return{status:"PASSED",actual:t??""}},xe=(e,s)=>{const t=e.map(n=>({id:n.id,title:n.title,passed:[],failed:[],na:[]})),r=[],i=new Map;return e.forEach((n,o)=>{t[o],n.applicability.ifcClasses.length&&i.set(n.id,new Set(n.applicability.ifcClasses.map(f=>f.toLowerCase())))}),s.forEach(n=>{e.forEach((o,f)=>{const a=t[f],l=i.get(o.id),d=n.ifcClass?.toLowerCase?.()??"";if(l&&l.size&&!l.has(d)){a.na.push(n.GlobalId),r.push({ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,status:"NA",reason:"Entity not applicable"});return}if(!o.properties.length){a.na.push(n.GlobalId);return}const c=[],u=[];let I=!1;if(o.properties.forEach(h=>{const E=ze(n,h),b={ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,propertyPath:h.path,expected:h.expected?.join(", "),actual:E.actual};E.status==="FAILED"?(I=!0,c.push({...b,reason:E.reason??h.description,status:"FAILED"})):u.push({...b,status:"PASSED"})}),I){a.failed.push(n.GlobalId),r.push(...c);return}u.length?(a.passed.push(n.GlobalId),r.push(...u)):(a.na.push(n.GlobalId),r.push({ruleId:o.id,ruleTitle:o.title,globalId:n.GlobalId,ifcClass:n.ifcClass,status:"NA",reason:"No property checks produced a result"}))})}),{rules:t,rows:r}},N=self,Ke=new Y({ignoreAttributes:!1,removeNSPrefix:!1,attributeNamePrefix:"@_",trimValues:!0});let V=!1;const Je=(e,s)=>{const t=(r,i)=>{const n=new Set(r);i.forEach(o=>{n.has(o)||(n.add(o),r.push(o))})};t(e.passed,s.passed),t(e.failed,s.failed),t(e.na,s.na)},Qe=async e=>{const s=e.idsXml?.trim?.()??"";if(!s){N.postMessage({type:"error",message:"Empty IDS payload received."});return}N.postMessage({type:"phase",label:"compiling"});try{Ke.parse(s)}catch{N.postMessage({type:"error",message:"Failed to parse IDS XML. Please verify the file contents."});return}const t=Ze(s);if(!t.length){N.postMessage({type:"error",message:"No valid IDS specifications were found in the provided documents."});return}const r=Array.isArray(e.elements)?e.elements:[],i=r.length,n=e.chunk&&e.chunk>0?e.chunk:200;N.postMessage({type:"phase",label:"validating"}),N.postMessage({type:"progress",done:0,total:i});const o=new Map,f=[];for(let d=0;d<r.length;d+=n){if(V){N.postMessage({type:"error",message:"Validation cancelled"}),V=!1;return}const c=r.slice(d,d+n),u=xe(t,c);u.rules.forEach(h=>{const E=o.get(h.id);E?Je(E,h):o.set(h.id,{id:h.id,title:h.title,passed:[...h.passed],failed:[...h.failed],na:[...h.na]})}),u.rows.forEach(h=>{f.push(h)});const I=Math.min(d+c.length,i);N.postMessage({type:"progress",done:I,total:i})}N.postMessage({type:"phase",label:"finalizing"});const l={type:"done",rules:Array.from(o.values()),rows:f};N.postMessage(l),N.postMessage({type:"phase",label:"idle"})};N.onmessage=e=>{const s=e.data;if(s){if(s.type==="cancel"){V=!0;return}s.type==="validate"&&(V=!1,Qe(s).catch(t=>{const r={type:"error",message:t instanceof Error?t.message:"Unknown IDS worker error"};N.postMessage(r)}))}}})();
