import{cm as n,co as e,cH as U,cF as O,cp as y,cq as S,cs as P,dj as X,dk as J,dl as Q,dm as _,cO as V,cA as W,dn as Z,cP as ee}from"./vendor-CG379c7K.js";import{l as Y,s as te,a as se}from"./index-fo5gKbIB.js";import"./thatopen-vendor-BXeQhCq_.js";import"./three-vendor-kQcUiZz9.js";const ie=`You can control the BIM viewer selection with a structured command.
When the user explicitly asks you to select, highlight, filter, show, hide, isolate, or focus objects, append a single line at the end of your reply in this exact format:
SELECTION: {"action":"select","filter":{...},"mode":"highlight"}
Use "action":"clear" when the user wants to clear selections.
Choose keys inside filter that match the model data (e.g. category, type, system, name, globalId, guid).
Only emit the SELECTION line when a selection action is required. Otherwise omit it entirely.`,H="SELECTION:",ne=s=>{const o=s.indexOf("{");if(o===-1)return null;let w=0,f=!1,p="";for(let d=o;d<s.length;d+=1){const c=s[d];if(f)c==='"'&&p!=="\\"&&(f=!1);else if(c==='"')f=!0;else if(c==="{")w+=1;else if(c==="}"&&(w-=1,w===0))return s.slice(o,d+1);p=c}return null},oe=s=>{if(!s)return{cleaned:s,command:null};const o=s.toUpperCase().lastIndexOf(H);if(o===-1)return{cleaned:s,command:null};const f=s.slice(o+H.length).trim().replace(/^```(?:json)?/i,"").replace(/```$/i,"").trim(),p=ne(f);if(!p)return{cleaned:s,command:null};try{const d=JSON.parse(p);return!d||typeof d.action!="string"?{cleaned:s,command:null}:{cleaned:s.slice(0,o).trimEnd()||s,command:d}}catch{return{cleaned:s,command:null}}},ce=({getModelDataForAI:s,isOpen:o,onOpen:w,onClose:f,expandSignal:p,onRequestSelection:d,onOpenSettings:c,configVersion:N})=>{const[g,v]=n.useState(!1),[T,j]=n.useState([{role:"system",text:"Hello! I am your BIM assistant. Ask me anything about the loaded models."}]),[L,R]=n.useState(""),[A,$]=n.useState(!1),[i,q]=n.useState(Y()),k=n.useRef(null),[B,D]=n.useState({width:400,height:500}),M=n.useRef(null),C=n.useRef(!1),E=n.useCallback(t=>{if(!C.current)return;const r=M.current;if(!r)return;const z=t.clientX-r.startX,h=t.clientY-r.startY,u=320,a=260;D(x=>{const m=Math.max(u,r.width+z),l=Math.max(a,r.height+h);return m===x.width&&l===x.height?x:{width:Math.round(m),height:Math.round(l)}})},[]),b=n.useCallback(()=>{C.current&&(C.current=!1,M.current=null,window.removeEventListener("pointermove",E),window.removeEventListener("pointerup",b))},[E]),G=n.useCallback(t=>{t.preventDefault(),t.stopPropagation();const r=k.current;r&&(C.current=!0,M.current={startX:t.clientX,startY:t.clientY,width:r.offsetWidth,height:r.offsetHeight},window.addEventListener("pointermove",E),window.addEventListener("pointerup",b))},[E,b]);n.useEffect(()=>()=>{b()},[b]),n.useEffect(()=>{o&&v(!1)},[p,o]),n.useEffect(()=>{o||v(!1)},[o]),n.useEffect(()=>{q(Y())},[o,N]);const F=async()=>{const t=L.trim();if(!t)return;if(!i||i.provider==="disabled"||!i.apiKey){j(h=>[...h,{role:"system",text:"AI is not configured. Please open Settings to configure your API key."}]);return}const r={role:"user",text:t},z=[...T,r];j(z),R(""),$(!0);try{const h=await s(t),u=`You are a helpful BIM assistant who can describe models and help users explore geometry.
Follow these instructions carefully:
- Always provide clear, concise answers grounded in the supplied model data.
- ${ie}
Based on the following model data, please answer the user's question.
---
MODEL DATA:
${h}
---
USER QUESTION:
${t}`;let a;if(i.provider==="gemini")a=await te(i.apiKey,u,i.model);else if(i.provider==="openai")a=await se(i.apiKey,u,i.model);else throw new Error("Unsupported AI provider");const{cleaned:x,command:m}=oe(a),l={role:"model",text:x};if(j(I=>[...I,l]),m&&typeof d=="function")try{d(m)}catch(I){console.error("Failed to handle AI selection command",I)}}catch(h){console.error("Error calling AI API:",h);const u=i?.provider==="gemini"?"Google Gemini":"OpenAI";let a=`Sorry, I encountered an error while talking to ${u}.`;const m=h?.message??(h instanceof Error?h.message:""),l=typeof m=="string"?m.toLowerCase():"";l.includes("401")||l.includes("unauthorized")?a=`${u} rejected the API key (401). Please check your API key in Settings.`:l.includes("403")||l.includes("forbidden")?a=`${u} returned 403. Ensure your API key has the necessary permissions and billing is enabled.`:l.includes("404")?a=`${u} returned 404. The requested model may not be available. Try a different model in Settings.`:l.includes("429")||l.includes("rate limit")||l.includes("quota")?a=`${u} rate limit exceeded (429). The model "${i.model}" might be overloaded or your free tier quota is exhausted. Try switching to a different model (e.g. gemini-2.0-flash) in Settings or wait a minute.`:m&&(a=`${u} error: ${m}`);const I={role:"system",text:a};j(K=>[...K,I])}finally{$(!1)}};return o?e.jsx(U,{nodeRef:k,handle:".chat-header",bounds:"parent",children:e.jsxs(O,{ref:k,elevation:8,sx:{position:"fixed",bottom:40,right:40,width:B.width,height:g?"auto":B.height,minWidth:320,maxWidth:"90vw",minHeight:g?"auto":260,maxHeight:"85vh",zIndex:2e3,display:"flex",flexDirection:"column",boxSizing:"border-box",overflow:"hidden"},children:[e.jsxs(y,{className:"chat-header",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"4px 8px",backgroundColor:"primary.main",color:"white",cursor:"move"},children:[e.jsxs(S,{variant:"subtitle1",children:["BIM AI Assistant",i&&i.provider!=="disabled"&&e.jsxs(S,{component:"span",variant:"caption",sx:{ml:1,opacity:.8},children:["(",i.provider==="gemini"?"Gemini":"ChatGPT",")"]})]}),e.jsxs(y,{sx:{display:"flex",alignItems:"center",gap:.5},children:[c&&e.jsx(P,{size:"small",onClick:c,color:"inherit",title:"Open Settings",children:e.jsx(X,{fontSize:"small"})}),e.jsx(P,{size:"small",onClick:()=>v(!g),color:"inherit",title:g?"Expand panel":"Minimize panel",children:g?e.jsx(J,{}):e.jsx(Q,{})}),e.jsx(P,{size:"small",onClick:()=>{v(!1),f()},color:"inherit",title:"Close BIM AI Assistant",children:e.jsx(_,{})})]})]}),!g&&e.jsxs(e.Fragment,{children:[(!i||i.provider==="disabled"||!i.apiKey)&&e.jsx(V,{severity:"warning",sx:{m:1},children:e.jsxs(S,{variant:"body2",children:["AI is not configured. ",c&&e.jsxs(e.Fragment,{children:["Please ",e.jsx(W,{size:"small",onClick:c,sx:{textTransform:"none",p:0,minWidth:"auto",verticalAlign:"baseline"},children:"open Settings"})," to configure your API key."]})]})}),e.jsxs(y,{sx:{flex:1,overflowY:"auto",padding:2,minHeight:0},children:[T.map((t,r)=>e.jsx(y,{sx:{marginBottom:1,textAlign:t.role==="user"?"right":"left"},children:e.jsx(O,{elevation:1,sx:{padding:1,display:"inline-block",backgroundColor:t.role==="user"?"primary.light":t.role==="system"?"grey.200":"white"},children:e.jsxs(S,{variant:"body2",children:[e.jsxs("strong",{children:[t.role==="model"?"AI":t.role==="system"?"System":"You",":"]})," ",t.text]})})},r)),A&&e.jsx(Z,{size:24,sx:{display:"block",margin:"10px auto"}})]}),e.jsxs(y,{sx:{padding:1,borderTop:"1px solid #ddd",display:"flex"},children:[e.jsx(ee,{fullWidth:!0,variant:"outlined",size:"small",placeholder:"Ask about the model...",value:L,onChange:t=>R(t.target.value),onKeyPress:t=>t.key==="Enter"&&!A&&F(),disabled:A}),e.jsx(W,{variant:"contained",onClick:F,disabled:A,sx:{marginLeft:1},children:"Send"})]}),e.jsx(y,{onPointerDown:G,sx:{position:"absolute",bottom:6,right:6,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})]})}):null};export{ce as default};
