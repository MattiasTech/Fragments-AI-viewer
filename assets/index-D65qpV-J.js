const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-DIvWRSAX.js","assets/vendor-DY-rktTO.js","assets/thatopen-vendor-C9781ij5.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-DIKUUi8_.js","assets/IdsCreatorPanel-D2HOk21s.js","assets/ModelFilterPanel-zg9LegTn.js"])))=>i.map(i=>d[i]);
import{ck as Ys,cl as Xs,cm as d,cn as Ft,co as t,cp as G,cq as H,cr as Q,cs as X,ct as Js,cu as Zs,cv as Qs,cw as ei,cx as ti,cy as ri,cz as oi,cA as ie,cB as yn,cC as bn,cD as xn,cE as wn,cF as je,cG as ni,cH as In,cI as si,cJ as Cn,cK as Sn,cL as ii,cM as jn,cN as Xt,cO as Mt,cP as Jt,cQ as li,cR as ai,cS as vn,cT as ci,cU as di,cV as ao,cW as ui,cX as fi,cY as pi,cZ as hi,c_ as kn,c$ as Pn,d0 as En,d1 as mi,d2 as gi,d3 as co,d4 as yi,d5 as bi,d6 as Pr,d7 as uo,d8 as fo,d9 as po,da as An,db as Rn,dc as Zt,dd as Qt,de as ho,df as xi,dg as wi,dh as Ii,di as Ci}from"./vendor-DY-rktTO.js";import{l as Si,_ as ji,C as vi,W as ki,S as Pi,a as Ei,O as Ai,G as Ri,F as Mi,t as zi,H as Di,Y as $i,$ as Mn}from"./thatopen-vendor-C9781ij5.js";import{B as dt,V as ee,C as Oe,a3 as Fi,c as mo,P as zt,a6 as go,l as zn,G as Ni,S as Li,h as Dn,$ as Oi,y as $n,ab as Ti,D as Vi}from"./three-vendor-kQcUiZz9.js";(function(){const l=document.createElement("link").relList;if(l&&l.supports&&l.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))g(i);new MutationObserver(i=>{for(const b of i)if(b.type==="childList")for(const h of b.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&g(h)}).observe(document,{childList:!0,subtree:!0});function c(i){const b={};return i.integrity&&(b.integrity=i.integrity),i.referrerPolicy&&(b.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?b.credentials="include":i.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function g(i){if(i.ep)return;i.ep=!0;const b=c(i);fetch(i.href,b)}})();const _i="modulepreload",Bi=function(r){return"/Savora-Viewer/"+r},Fn={},$t=function(l,c,g){let i=Promise.resolve();if(c&&c.length>0){let v=function(y){return Promise.all(y.map(E=>Promise.resolve(E).then(P=>({status:"fulfilled",value:P}),P=>({status:"rejected",reason:P}))))};document.getElementsByTagName("link");const h=document.querySelector("meta[property=csp-nonce]"),p=h?.nonce||h?.getAttribute("nonce");i=v(c.map(y=>{if(y=Bi(y),y in Fn)return;Fn[y]=!0;const E=y.endsWith(".css"),P=E?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${y}"]${P}`))return;const V=document.createElement("link");if(V.rel=E?"stylesheet":_i,E||(V.as="script"),V.crossOrigin="",V.href=y,p&&V.setAttribute("nonce",p),document.head.appendChild(V),E)return new Promise((F,j)=>{V.addEventListener("load",F),V.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${y}`)))})}))}function b(h){const p=new Event("vite:preloadError",{cancelable:!0});if(p.payload=h,window.dispatchEvent(p),!p.defaultPrevented)throw h}return i.then(h=>{for(const p of h||[])p.status==="rejected"&&b(p.reason);return l().catch(b)})},Io="bim_viewer_api_config",Gi=r=>{try{return btoa(r)}catch{return r}},Wi=r=>{try{return atob(r)}catch{return r}},Hi=r=>{const l={...r,apiKey:Gi(r.apiKey)};localStorage.setItem(Io,JSON.stringify(l))},Ui=()=>{const r=localStorage.getItem(Io);if(!r)return null;try{const l=JSON.parse(r);return{...l,apiKey:Wi(l.apiKey)}}catch{return null}},qi=()=>{localStorage.removeItem(Io)},Ki=r=>{switch(r){case"gemini":return["gemini-3.0-pro","gemini-3.0-flash","gemini-2.5-flash","gemini-2.0-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5.2","gpt-5.1","gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},Er=r=>{switch(r){case"gemini":return"gemini-2.0-flash";case"openai":return"gpt-4o-mini";default:return""}},Yi=async(r,l,c="gemini-2.0-flash")=>{const g=`https://generativelanguage.googleapis.com/v1beta/models/${c}:generateContent?key=${r}`,i=3;let b=0;for(;b<i;)try{const h=await fetch(g,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:l}]}]})});if(h.status===429){b++;const v=Math.pow(2,b)*1e3;console.warn(`Gemini API rate limited (429). Retrying in ${v}ms... (Attempt ${b}/${i})`),await new Promise(y=>setTimeout(y,v));continue}if(!h.ok){const v=await h.json().catch(()=>({}));throw new Error(v.error?.message||`Gemini API error: ${h.status} ${h.statusText}`)}const p=await h.json();if(!p.candidates||p.candidates.length===0)throw new Error("No response from Gemini API");return p.candidates[0].content.parts[0].text}catch(h){throw b===i-1,h}throw new Error("Gemini API request failed after max retries")},Xi=async(r,l="gemini-2.0-flash-exp")=>{try{return await Yi(r,"Hello, respond with OK",l),!0}catch{return!1}},Ji=async(r,l,c="gpt-4o-mini")=>{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({model:c,messages:[{role:"user",content:l}]})});if(!i.ok){const h=await i.json().catch(()=>({}));throw new Error(h.error?.message||`OpenAI API error: ${i.status} ${i.statusText}`)}const b=await i.json();if(!b.choices||b.choices.length===0)throw new Error("No response from OpenAI API");return b.choices[0].message.content},Zi=async(r,l="gpt-4o-mini")=>{try{return await Ji(r,"Hello, respond with OK",l),!0}catch{return!1}},Qi="fragments-ids",se="elements-v5",de="cache-metadata-v1",el=6,ke=()=>new Promise((r,l)=>{const c=indexedDB.open(Qi,el);c.onerror=()=>l(c.error??new Error("IndexedDB open failed")),c.onupgradeneeded=()=>{const g=c.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(b=>{g.objectStoreNames.contains(b)&&g.deleteObjectStore(b)}),g.objectStoreNames.contains(se)||g.createObjectStore(se),g.objectStoreNames.contains(de)||g.createObjectStore(de)},c.onsuccess=()=>r(c.result)}),yo={async get(r){const l=await ke();return new Promise((c,g)=>{const h=l.transaction(se,"readonly").objectStore(se).get(r);h.onsuccess=()=>c(h.result??null),h.onerror=()=>g(h.error??new Error("IndexedDB get failed"))})},async set(r,l){const c=await ke();await new Promise((g,i)=>{const b=c.transaction([se,de],"readwrite"),h=b.objectStore(se),p=b.objectStore(de),v=h.put(l,r),y={modelKey:r,timestamp:Date.now(),elementCount:l.length,version:"1.0"};p.put(y,r),v.onsuccess=()=>g(),v.onerror=()=>i(v.error??new Error("IndexedDB set failed"))})},async append(r,l){if(!l||!l.length)return;const c=await ke();await new Promise((g,i)=>{const b=c.transaction([se,de],"readwrite"),h=b.objectStore(se),p=b.objectStore(de),v=h.get(r);v.onsuccess=()=>{const E=(v.result??[]).concat(l),P=h.put(E,r),V={modelKey:r,timestamp:Date.now(),elementCount:E.length,version:"1.0"};p.put(V,r),P.onsuccess=()=>g(),P.onerror=()=>i(P.error??new Error("IndexedDB append put failed"))},v.onerror=()=>i(v.error??new Error("IndexedDB append get failed"))})},async writePart(r,l,c){const g=`${r}::part::${String(l).padStart(6,"0")}`,i=`${r}::partindex::${String(l).padStart(6,"0")}`,b=await ke();await new Promise((h,p)=>{const v=b.transaction([se,de],"readwrite"),y=v.objectStore(se),E=v.objectStore(de),P=y.put(c,g);P.onsuccess=()=>{const V=E.get(r);V.onsuccess=()=>{const F=V.result??{modelKey:r,timestamp:Date.now(),elementCount:0,version:"1.0"};F.timestamp=Date.now(),F.elementCount=(F.elementCount||0)+c.length;const j=Array.isArray(F.partKeys)?F.partKeys.slice():[];j.includes(g)||j.push(g),F.partKeys=j,E.put(F,r);try{const z=c.map(k=>k.GlobalId).filter(Boolean),T=y.put(z,i);T.onsuccess=()=>{},T.onerror=()=>{}}catch{}h()},V.onerror=()=>h()},P.onerror=()=>p(P.error??new Error("IndexedDB writePart failed"))})},async getPersistedIds(r){const l=await this.getPartKeys(r);if(!l||!l.length)return new Set;const c=await ke(),g=new Set;return await new Promise(i=>{const h=c.transaction(se,"readonly").objectStore(se);let p=l.length;l.forEach(v=>{const y=v.replace("::part::","::partindex::"),E=h.get(y);E.onsuccess=()=>{const P=E.result??[];for(const V of P)typeof V=="string"&&V&&g.add(V);p-=1,p===0&&i()},E.onerror=()=>{p-=1,p===0&&i()}})}),g},async getPartKeys(r){const l=await this.getMetadata(r);return Array.isArray(l?.partKeys)?l.partKeys:[]},async listParts(r){return(await this.getPartKeys(r)).slice().sort()},async readAllParts(r){const l=await ke(),c=await this.getPartKeys(r);return c.length?new Promise((g,i)=>{const h=l.transaction(se,"readonly").objectStore(se),p=[];let v=c.length;c.forEach(y=>{const E=h.get(y);E.onsuccess=()=>{const P=E.result??[];p.push(...P),v-=1,v===0&&g(p)},E.onerror=()=>{v-=1,v===0&&g(p)}})}):[]},async removeParts(r){const l=await ke(),c=`${r}::part::`,i=(await this.keys()).filter(b=>b.startsWith(c));i.length&&await new Promise((b,h)=>{const p=l.transaction([se,de],"readwrite"),v=p.objectStore(se),y=p.objectStore(de);i.forEach(E=>v.delete(E)),y.delete(r),p.oncomplete=()=>b(),p.onerror=()=>h(p.error??new Error("IndexedDB removeParts failed"))})},async getMetadata(r){const l=await ke();return new Promise((c,g)=>{const h=l.transaction(de,"readonly").objectStore(de).get(r);h.onsuccess=()=>c(h.result??null),h.onerror=()=>g(h.error??new Error("IndexedDB metadata get failed"))})},async remove(r){const l=await ke();await new Promise((c,g)=>{const i=l.transaction([se,de],"readwrite"),b=i.objectStore(se),h=i.objectStore(de);b.delete(r),h.delete(r),i.oncomplete=()=>c(),i.onerror=()=>g(i.error??new Error("IndexedDB delete failed"))})},async keys(){const r=await ke();return new Promise((l,c)=>{const b=r.transaction(se,"readonly").objectStore(se).getAllKeys();b.onsuccess=()=>l(b.result??[]),b.onerror=()=>c(b.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const r=await ke();return new Promise((l,c)=>{const b=r.transaction(de,"readonly").objectStore(de).getAll();b.onsuccess=()=>l(b.result??[]),b.onerror=()=>c(b.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(r=720*60*60*1e3){const l=await ke(),c=await this.getAllMetadata(),g=Date.now(),i=c.filter(b=>g-b.timestamp>r).map(b=>b.modelKey);i.length>0&&await new Promise((b,h)=>{const p=l.transaction([se,de],"readwrite"),v=p.objectStore(se),y=p.objectStore(de);i.forEach(E=>{v.delete(E),y.delete(E)}),p.oncomplete=()=>{b()},p.onerror=()=>h(p.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(r,l){const c=await this.getMetadata(r);return!c||!c.modelSignature?!1:c.modelSignature===l},async updateSignature(r,l,c){const g=await ke();await new Promise((i,b)=>{const p=g.transaction(de,"readwrite").objectStore(de),v=p.get(r);v.onsuccess=()=>{const y=v.result??{modelKey:r,timestamp:Date.now(),elementCount:0,version:"1.0"};y.modelSignature=l,y.modelFiles=c,y.timestamp=Date.now();const E=p.put(y,r);E.onsuccess=()=>i(),E.onerror=()=>b(E.error??new Error("IndexedDB updateSignature failed"))},v.onerror=()=>b(v.error??new Error("IndexedDB updateSignature get failed"))})}},tl=async r=>{const l=new TextEncoder,c=`${r.modelUrl}|${r.extra??""}`,g=l.encode(c),i=await crypto.subtle.digest("SHA-256",g),b=new Uint8Array(i);return btoa(String.fromCharCode(...b)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},Gn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},tt=r=>r==null?[]:Array.isArray(r)?r:[r],Nn=r=>{if(r==null)return[];if(typeof r=="string")try{const l=JSON.parse(r);return Array.isArray(l)?l:[]}catch{return[]}if(typeof r=="object"){const l=r;if(typeof l.__cdata=="string")try{const c=JSON.parse(l.__cdata);return Array.isArray(c)?c:[]}catch{return[]}if(Array.isArray(l.item))return l.item;if(l.item!=null)return[l.item];if(Array.isArray(l.Rule))return l.Rule;if(l.Rule!=null)return[l.Rule]}return Array.isArray(r)?r:[]},_l=r=>{if(!r||typeof r!="string")return[];const l=new Xs(Gn);let c={};try{c=l.parse(r)}catch(y){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",y),[]}const g=c?.IdsCreator??c?.idsCreator??c?.IDS_CREATOR??c?.Ids??c,i=g?.Specification??g?.specification??g?.Specifications??g?.specifications??null;if(i){const y=tt(i);if(y.length)return y.map((E,P)=>{const V=E?.["@_id"]?.trim?.()||`spec-${P+1}`,F=(E?.Name??E?.name??"")?.toString?.()??"",j=(E?.Description??E?.description??"")?.toString?.()??"",z=Nn(E?.Applicability??E?.applicability),T=Nn(E?.Requirements??E?.requirements);return{id:V,name:F,description:j,applicability:z,requirements:T}})}const b=y=>{if(!y||typeof y!="object")return[];for(const[E,P]of Object.entries(y)){const V=String(E).toLowerCase();if(V.endsWith(":specification")||V==="specification"||V==="ids:specification")return tt(P)}for(const E of Object.values(y))if(E&&typeof E=="object"){const P=b(E);if(P&&P.length)return P}return[]},h=b(c);if(!h.length)return[];const p=y=>{if(!y)return null;if(typeof y=="string")return y;if(typeof y=="object")for(const E of Object.keys(y)){const P=E.toLowerCase();if(P.includes("simplevalue")||P==="#text"||P==="value"){const V=y[E];if(typeof V=="string")return V;if(typeof V=="object"&&(V?.value||V?.Value))return String(V.value??V.Value)}}return null};return h.map((y,E)=>{const P=y?.["@_id"]?.trim?.()||`spec-${E+1}`,V=y?.["@_name"]??y?.name??y?.Name??"",F=String(V??""),j="",z=[],T=[],k=y?.applicability??y?.Applicability??y?.["ids:applicability"]??null,$=tt(k);for(const J of $){let oe=null;const Y=[J];for(;Y.length&&!oe;){const U=Y.shift();if(!U)continue;const $e=p(U);if($e){oe=$e;break}if(typeof U=="object")for(const we of Object.values(U))we&&typeof we=="object"&&Y.push(we)}oe&&z.push({entity:oe})}const q=y?.requirements??y?.Requirements??y?.["ids:requirements"]??null,he=tt(q),te=J=>{const oe=[],Y=[];if(J?.property&&Y.push(...tt(J.property)),J?.Property&&Y.push(...tt(J.Property)),Array.isArray(J)&&Y.push(...J),!Y.length&&typeof J=="object")for(const U of Object.values(J))U&&typeof U=="object"&&Y.push(U);for(const U of Y){const $e=U?.propertySet??U?.PropertySet??U?.["ids:propertySet"]??U?.propertySet,we=U?.baseName??U?.BaseName??U?.["ids:baseName"]??U?.baseName,ot=p($e)||p(U?.propertySet?.simpleValue)||p(U?.propertySet?.["ids:simpleValue"]),Nt=p(we)||p(U?.baseName?.simpleValue)||p(U?.baseName?.["ids:simpleValue"]),Ke=[],ye=U?.allowedValues??U?.AllowedValues??U?.["ids:allowedValues"];if(ye){const Ye=ye?.values??ye?.Values??ye?.["ids:values"]??ye,Lt=tt(Ye?.value??Ye?.Value??Ye?.["ids:value"]??Ye??[]);for(const nt of Lt){const Fe=p(nt)||p(nt?.simpleValue)||p(nt?.["ids:simpleValue"]);Fe&&Ke.push(Fe)}}if(ot||Nt){const Ye={id:`rule-${E}-${oe.length}`,propertyPath:`${ot??"Pset"}.${Nt??"Property"}`,operator:"equals"};Ke.length&&(Ye.value=Ke.length===1?Ke[0]:JSON.stringify(Ke)),oe.push(Ye)}}return oe};for(const J of he){const oe=te(J);oe.length&&T.push(...oe)}return{id:P,name:String(F??""),description:String(j),applicability:z,requirements:T}})},Bl=r=>{const l=new Ys(Gn);if((r??[]).some(b=>Array.isArray(b.requirements)&&b.requirements.some(h=>h&&typeof h=="object"&&"propertyPath"in h))){const h={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(r??[]).map(v=>{const y=[],E=j=>{if(!j&&j!==0)return null;if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(j?.ifcClass&&typeof j.ifcClass=="string"&&j.ifcClass.trim())return j.ifcClass.trim();const z=j?.entity??j?.ifcType??j?.type;if(z&&typeof z=="string"&&z.trim())return z.trim();const T=j?.sample??j;if(T){if(T._category&&typeof T._category=="object"){const $=T._category.value??T._category.Value;if(typeof $=="string"&&$.trim())return $.trim()}const k=T?.ifcClass??T?.category?.value??T?.type??T?._type;if(k&&typeof k=="string"&&k.trim())return k.trim()}return null};for(const j of tt(v.applicability)){const z=E(j)??null,T=z&&String(z).trim()?String(z):"IFCELEMENT";y.push({"ids:name":{"ids:simpleValue":T}})}const P=[],V=j=>{if(j==null)return"";if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(typeof j=="object"){if(j["ids:simpleValue"])return String(j["ids:simpleValue"]);if(j.__cdata)return String(j.__cdata);if(j.Name)return String(j.Name);if(j.name)return String(j.name);for(const z of Object.keys(j)){const T=j[z];if(typeof T=="string"&&T.trim())return T;if(T&&typeof T=="object"){const k=T;if(typeof k["ids:simpleValue"]=="string")return k["ids:simpleValue"];if(typeof k.value=="string")return k.value}}return""}return""};for(const j of tt(v.requirements))if(j&&typeof j=="object"){const z=j;let T=null,k=null;if(typeof z.propertyPath=="string"){const[Y,U]=String(z.propertyPath).split(".");T=Y,k=U}else z.propertyPath&&typeof z.propertyPath=="object"?(T=z.propertyPath.pset??z.propertyPath.propertySet??z.propertySet??null,k=z.propertyPath.property??z.propertyPath.prop??z.property??z.propertyName??null):(T=z.propertySet??z.pset??null,k=z.baseName??z.property??z.prop??null);const $=V(T)||"Pset",q=V(k)||"Property",he=rr($)||$,te=rr(q)||q,J={};if(J["ids:propertySet"]={"ids:simpleValue":he},J["ids:baseName"]={"ids:simpleValue":te},(z.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(z.value!=null&&String(z.value).trim()){let Y=null;try{const U=typeof z.value=="string"?JSON.parse(z.value):z.value;Array.isArray(U)&&(Y=U.map($e=>String($e)))}catch{}Y||typeof z.value=="string"&&z.value.includes(",")&&(Y=z.value.split(",").map(U=>zr(U.trim())).filter(Boolean)),Y&&Y.length?J["ids:allowedValues"]={"ids:values":{"ids:value":Y.map(U=>({"ids:simpleValue":zr(String(U))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":zr(String(z.value))}}}}P.push({"ids:property":J})}const F={"@_ifcVersion":"IFC4","@_name":v.name??""};return y.length&&(F["ids:applicability"]={"ids:entity":y.map(j=>({"ids:name":j["ids:name"]?j["ids:name"]:j}))}),P.length&&(F["ids:requirements"]={"ids:property":P.map(j=>j["ids:property"])}),F})}},p=l.build(h);return p.startsWith("<?xml")?p:`<?xml version="1.0" encoding="UTF-8"?>
${p}`}const g={IdsCreator:{Specification:(r??[]).map(b=>({"@_id":b.id,Name:b.name,Description:b.description,Applicability:{__cdata:JSON.stringify(b.applicability??[])},Requirements:{__cdata:JSON.stringify(b.requirements??[])}}))}},i=l.build(g);return i.startsWith("<?xml")?i:`<?xml version="1.0" encoding="UTF-8"?>
${i}`},rr=r=>r?r.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",zr=r=>!r||typeof r!="string"?r:r.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),Wn=r=>{if(r==null)return"";if(typeof r=="string")return zr(r.trim());if(typeof r=="number"||typeof r=="boolean")return String(r);try{return JSON.stringify(r)}catch{return String(r)}},rl=r=>{if(!r)return{};const l={};for(const[c,g]of Object.entries(r)){if(!g||typeof g!="object")continue;const i=rr(c)||c;for(const[b,h]of Object.entries(g)){const p=rr(b)||b,v=`${i}.${p}`;v in l||(l[v]=Wn(h))}}return l};let It=null;const ol=()=>{It=null},nl=r=>r.slice().sort().join("|"),sl=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],il=(r,l)=>{if(!r||typeof r!="object")return;const c=l.map(b=>b.toLowerCase()),g=new WeakSet,i=[r];for(;i.length;){const b=i.pop();if(!(!b||typeof b!="object")&&!g.has(b)){if(g.add(b),Array.isArray(b)){for(const h of b)h&&typeof h=="object"&&i.push(h);continue}for(const[h,p]of Object.entries(b)){const v=h.toLowerCase();if(c.some(y=>v.includes(y)))if(typeof p=="string"){const y=p.trim();if(y)return y}else{if(typeof p=="number"&&Number.isFinite(p))return p.toString();if(typeof p=="boolean")return p?"true":"false";if(p&&typeof p=="object"){const y=p;if(typeof y.value=="string"){const E=y.value.trim();if(E)return E}if(typeof y.Value=="string"){const E=y.Value.trim();if(E)return E}y.value&&typeof y.value=="object"&&i.push(y.value),y.Value&&typeof y.Value=="object"&&i.push(y.Value)}}p&&typeof p=="object"&&i.push(p)}}}},ll=r=>{if(!r||typeof r!="object")return null;const l=r;for(const g of sl){const i=l[g];if(typeof i=="string"&&i.trim().length)return i.trim()}return il(r,["globalid","global id","guid","uniqueid"])?.trim()??null},Ar=async(r,l,c)=>{const g=[],i=Math.max(l.length,1);c?.onProgress?.({done:0,total:i});const b=r.getElementProps;for(let h=0;h<l.length;h++){const p=l[h];try{const{ifcClass:v,psets:y,attributes:E}=await b.call(r,p),P=rl(y);if("GlobalId"in P||(P.GlobalId=p),E)for(const[V,F]of Object.entries(E)){const z=`Attributes.${rr(V)||V}`;z in P||(P[z]=Wn(F))}P.ifcClass||(P.ifcClass=v),g.push({GlobalId:p,ifcClass:v,properties:P}),(h%50===0||h===l.length-1)&&c?.onProgress?.({done:g.length,total:i})}catch(v){console.warn(`IDS adapter (direct) failed to load element ${p}`,v)}}return c?.onProgress?.({done:g.length,total:i}),g},al=async(r,l,c)=>{if(typeof r.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const g=Math.max(1,(navigator.hardwareConcurrency||4)-1),i=[],b=[],h=[];for(let y=0;y<g;y++){const E=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});i.push(E);const P=new Promise((V,F)=>{const j=T=>{const k=T.data;if(k){if(k.type==="error"){F(new Error(k.message||`Worker ${y} failed.`));return}if(k.type==="progress"){const $=h.reduce((q,he)=>q+he.length,0)+k.done;c?.onProgress?.({done:$,total:Math.max(l,$)});return}k.type==="done"&&(h[y]=k.elements??[],V(k.elements??[]))}},z=T=>{F(T.error??new Error(T.message||`Worker ${y} error.`))};E.addEventListener("message",j),E.addEventListener("error",z)});b.push(P),E.postMessage({type:"build-props",reset:!0,total:l})}c?.onProgress?.({done:0,total:l});const p=new Set;let v=0;try{for await(const y of r.iterElements({batchSize:128})){if(!Array.isArray(y)||!y.length)continue;const E=[];y.forEach(P=>{if(!P||typeof P!="object")return;const V=P.data;if(!V)return;const F=ll(V);if(!F||p.has(F))return;p.add(F);const j=typeof V.ifcClass=="string"?V.ifcClass:void 0;E.push({globalId:F,ifcClass:j,data:V})}),E.length&&(i[v].postMessage({type:"build-props",elements:E}),v=(v+1)%g)}}catch(y){throw i.forEach(E=>{E.postMessage({type:"cancel"}),E.terminate()}),y}i.forEach(y=>{y.postMessage({type:"build-props",final:!0})});try{const E=(await Promise.all(b)).flat();return c?.onProgress?.({done:E.length,total:Math.max(l,E.length)}),E}finally{i.forEach(y=>y.terminate())}},cl=async(r,l)=>{try{const c=typeof l.countElements=="function"?await l.countElements():void 0;return await tl({modelUrl:r,extra:c!=null?String(c):void 0})}catch(c){return console.warn("IDS adapter: failed to compute model key for cache",c),null}},Hn=async(r,l)=>{if(!r)return[];let c;if(l?.filterGlobalIds&&l.filterGlobalIds.length>0?c=l.filterGlobalIds:c=await r.listGlobalIds(),!c.length)return It=null,[];const g=nl(c),i=Math.max(c.length,1);if(l?.onPhase?.("BUILDING_PROPERTIES"),l?.onProgress?.({done:0,total:i}),It&&It.token===g)return It.elements;const b=l?.filterGlobalIds&&l.filterGlobalIds.length>0;let h=null;if(!b&&(h=await cl(g,r),h))try{const v=await yo.get(h);if(v&&v.length){const y=await yo.getMetadata(h),E=y?Math.round((Date.now()-y.timestamp)/1e3/60):0;return l?.onProgress?.({done:v.length,total:i}),It={token:g,elements:v},v}}catch(v){console.warn("IDS adapter: failed to read cached elements from IndexedDB",v)}let p=[];if(b)p=await Ar(r,c,l);else{const v=typeof r.countElements=="function"?await r.countElements().catch(()=>c.length):c.length;if(typeof r.iterElements=="function")try{p=await al(r,v??c.length,l),p.length||(p=await Ar(r,c,l))}catch(y){console.warn("IDS adapter: property build worker failed, falling back to direct collection",y),p=await Ar(r,c,l)}else p=await Ar(r,c,l)}return h&&p.length&&yo.set(h,p).catch(v=>console.warn("IDS adapter: failed to persist elements cache",v)),It={token:g,elements:p},l?.onProgress?.({done:Math.min(p.length,i),total:i}),p};class ft{static instance;viewerApi=null;elements=[];indices={byCategory:new Map,byGlobalId:new Map,searchIndex:new Map};isIndexing=!1;isReady=!1;constructor(){}static getInstance(){return ft.instance||(ft.instance=new ft),ft.instance}setViewerApi(l){this.viewerApi=l}async indexModel(l=!1){if(!this.viewerApi){console.warn("AIQueryEngine: ViewerApi not set");return}if(!this.isIndexing)try{this.isIndexing=!0,console.log("AIQueryEngine: Starting indexing...");const c=await Hn(this.viewerApi);this.elements=c,this.buildIndices(c),this.isReady=!0,console.log(`AIQueryEngine: Indexed ${c.length} elements.`)}catch(c){console.error("AIQueryEngine: Indexing failed",c)}finally{this.isIndexing=!1}}buildIndices(l){this.indices.byCategory.clear(),this.indices.byGlobalId.clear(),this.indices.searchIndex.clear();for(const c of l){const g=c.ifcClass.toUpperCase();this.indices.byCategory.has(g)||this.indices.byCategory.set(g,[]),this.indices.byCategory.get(g).push(c),this.indices.byGlobalId.set(c.GlobalId,c);const i=new Set,b=h=>{if(!h)return;String(h).toLowerCase().split(/[^a-z0-9]+/g).forEach(v=>{v.length>2&&i.add(v)})};if(b(c.ifcClass),c.properties)for(const[h,p]of Object.entries(c.properties))b(p);for(const h of i)this.indices.searchIndex.has(h)||this.indices.searchIndex.set(h,new Set),this.indices.searchIndex.get(h).add(c.GlobalId)}}search(l){if(!l)return[];const c=l.toLowerCase().split(/[^a-z0-9]+/g).filter(i=>i.length>2);if(c.length===0)return[];let g=null;for(const i of c){const b=this.indices.searchIndex.get(i);if(b)if(g===null)g=new Set(b);else{const h=g;g=new Set([...h].filter(p=>b.has(p)))}else{let h=new Set;for(const[p,v]of this.indices.searchIndex.entries())if(p.includes(i))for(const y of v)h.add(y);if(h.size===0)return[];if(g===null)g=h;else{const p=g;g=new Set([...p].filter(v=>h.has(v)))}}}return!g||g.size===0?[]:Array.from(g).map(i=>this.indices.byGlobalId.get(i)).filter(Boolean)}async generateContext(l,c){!this.isReady&&!this.isIndexing&&await this.indexModel();const g=[],i=this.elements.length,b=Array.from(this.indices.byCategory.entries()).map(([p,v])=>`${p}: ${v.length}`).sort().join(", ");g.push(`Total Elements: ${i}`),g.push(`Categories: ${b}`),c&&c.length>0&&g.push(`
--- Active Selection (${c.length}) ---`);const h=this.search(l);if(h.length>0&&h.length<50){g.push(`
--- Relevant Elements based on your query (${h.length}) ---`);for(const p of h)g.push(`- ${p.ifcClass} [${p.GlobalId}]`),g.push(`  Properties: ${JSON.stringify(p.properties).slice(0,300)}...`)}else if(h.length>=50){g.push(`
--- Found ${h.length} elements matching your keywords ---`);const p=new Map;h.forEach(v=>p.set(v.ifcClass,(p.get(v.ifcClass)||0)+1)),g.push(`Matching categories: ${Array.from(p.entries()).map(v=>`${v[0]}: ${v[1]}`).join(", ")}`)}for(const[p,v]of this.indices.byCategory.entries())(l.toUpperCase().includes(p)||l.toUpperCase().includes(p.replace("IFC","")))&&(v.length>20?(g.push(`
--- ${p} Summary ---`),g.push(`${p} count: ${v.length}`),g.push(`Sample element: ${JSON.stringify(v[0].properties).slice(0,200)}...`)):(g.push(`
--- ${p} Details ---`),v.forEach(y=>{g.push(`${p} [${y.GlobalId}]: ${JSON.stringify(y.properties)}`)})));return g.join(`
`)}isReadyStatus(){return this.isReady}}const dl={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let Ct=dl;const wo=new Set;let wt=null;const ul=()=>{wo.forEach(r=>{try{r()}catch(l){console.error("IDS store listener error",l)}})},ce=r=>{Ct=r(Ct),ul()};let ut=null,Dr=null;const fl=()=>(ut||(ut=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),ut),pl=(r,l)=>{const c=fl(),g=new Promise((i,b)=>{const h=v=>{const y=v.data;if(y){if(y.type==="error"){c.removeEventListener("message",h),c.removeEventListener("error",p),b(new Error(y.message||"IDS worker failed"));return}if(y.type==="phase"){l?.onPhase?.(y.label);return}if(y.type==="progress"){l?.onProgress?.(y);return}if(y.type==="done"){c.removeEventListener("message",h),c.removeEventListener("error",p),i(y);return}}},p=v=>{c.removeEventListener("message",h),c.removeEventListener("error",p),b(v.error??new Error(v.message))};c.addEventListener("message",h),c.addEventListener("error",p),c.postMessage(r)});return Dr=g.finally(()=>{Dr=null}),g},Ln=()=>{ce(r=>({...r,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:r=>(wo.add(r),()=>wo.delete(r)),getState:()=>Ct,setIdsXmlText:(r,l)=>{const c=r.replace(/\uFEFF/g,"").trim(),g=l?.fileNames??[];ce(i=>({...i,idsXmlText:c,idsFileNames:g,error:null})),Ln()},appendDocuments:r=>{if(!r.length)return;const l=fe.getState(),c=[];l.idsXmlText.trim().length&&c.push(l.idsXmlText.trim()),c.push(...r.map(b=>b.content.trim()).filter(Boolean));const g=c.join(`

`),i=[...l.idsFileNames,...r.map(b=>b.name)];fe.setIdsXmlText(g,{fileNames:i})},clearResults:()=>{Ln()},setValidationMode:r=>{ce(l=>({...l,validationMode:r}))},filterRows:(r,l)=>{ce(c=>{if(!r)return{...c,filteredRows:c.rows,filterDescription:null};const g=c.rows.filter(i=>{try{return r(i)}catch(b){return console.warn("IDS filter predicate threw an error",b),!0}});return{...c,filteredRows:g,filterDescription:l??null}})},runCheck:async r=>{if(!r){ce(i=>({...i,error:"Viewer API is not available."}));return}if(Ct.isChecking){await Dr;return}const l=Ct.idsXmlText.trim();if(!l){ce(i=>({...i,error:"Load at least one IDS XML file before running the check."}));return}let c;if(Ct.validationMode==="selected")if(r.getSelectedGlobalIds){if(c=await r.getSelectedGlobalIds(),!c||c.length===0){console.error("âŒ No elements selected"),ce(i=>({...i,error:"No elements selected. Please select elements or switch to another mode."}));return}}else{console.warn("âš ï¸ getSelectedGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Selected elements validation is not supported by this viewer."}));return}else if(Ct.validationMode==="visible")if(r.getVisibleGlobalIds){if(c=await r.getVisibleGlobalIds(),!c||c.length===0){console.error("âŒ No visible elements found"),ce(i=>({...i,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}}else{console.warn("âš ï¸ getVisibleGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Visible elements validation is not supported by this viewer."}));return}ce(i=>({...i,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),wt=new AbortController;const g=wt.signal;try{if(g.aborted)throw new Error("Validation cancelled");const i=await Hn(r,{filterGlobalIds:c,onPhase:y=>{ce(E=>({...E,phase:y}))},onProgress:y=>{ce(E=>({...E,progress:y}))}});if(!i.length)throw new Error("No IFC elements were found in the current viewer.");if(g.aborted)throw new Error("Validation cancelled");ce(y=>({...y,phase:"CHECKING_IDS",progress:null}));const b={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},h=await pl({type:"validate",idsXml:l,elements:i},{onPhase:y=>{const E=b[y];E&&ce(P=>({...P,phase:E}))},onProgress:y=>{ce(E=>({...E,progress:{done:y.done,total:y.total}}))}}),p=h.rules??[],v=h.rows??[];if(c&&c.length>0&&typeof r.addToCache=="function")try{await r.addToCache(c)}catch(y){console.warn("ðŸ“¦ Failed to add elements to cache:",y)}ce(y=>({...y,isChecking:!1,rules:p,rows:v,filteredRows:v,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),wt=null}catch(i){const b=i instanceof Error?i.message:"Failed to run IDS validation.";console.error("IDS run failed",i),ce(h=>({...h,isChecking:!1,error:b,phase:"ERROR",progress:null})),wt=null}},invalidateCaches:()=>{ol(),ut&&(ut.terminate(),ut=null,Dr=null),ce(r=>({...r,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{wt&&(wt.abort(),wt=null),ut&&ut.postMessage({type:"cancel"}),ce(r=>({...r,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},hl=r=>d.useSyncExternalStore(fe.subscribe,()=>r({...fe.getState(),...fe}),()=>r({...fe.getState(),...fe})),ml=r=>d.useSyncExternalStore(fe.subscribe,()=>r(fe.getState()),()=>r(fe.getState())),gl=()=>{const r=d.useCallback(fe.setIdsXmlText,[]),l=d.useCallback(fe.appendDocuments,[]),c=d.useCallback(fe.clearResults,[]),g=d.useCallback(fe.filterRows,[]),i=d.useCallback(fe.runCheck,[]),b=d.useCallback(fe.setValidationMode,[]),h=d.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:r,appendDocuments:l,clearResults:c,filterRows:g,runCheck:i,setValidationMode:b,cancelValidation:h,invalidateCaches:fe.invalidateCaches}},Un=fe,yl=Object.freeze(Object.defineProperty({__proto__:null,idsStore:Un,useIdsActions:gl,useIdsStore:hl,useIdsStoreSelector:ml},Symbol.toStringTag,{value:"Module"})),bl=Ft.lazy(()=>$t(()=>import("./ChatWindow-DIvWRSAX.js"),__vite__mapDeps([0,1,2,3]))),xl=Ft.lazy(()=>$t(()=>import("./IdsPanel-DIKUUi8_.js"),__vite__mapDeps([4,1,2,3]))),wl=Ft.lazy(()=>$t(()=>import("./IdsCreatorPanel-D2HOk21s.js"),__vite__mapDeps([5,1,2,3]))),Il=Ft.lazy(()=>$t(()=>import("./ModelFilterPanel-zg9LegTn.js"),__vite__mapDeps([6,1]))),bo=(r,l)=>{if(r.length!==l.length)return!1;for(let c=0;c<r.length;c+=1){const g=r[c],i=l[c];if(!i||g.modelId!==i.modelId||g.localId!==i.localId)return!1}return!0},Cl={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Sl=(r,l)=>{if(!r)return l;const c=[r.ifcCategory,r.Category,r.category,r.ifcClass,r.class,r.type,r.Type,r.system,r.System];for(const g of c)if(typeof g=="string"&&g.trim())return g.trim();if(Array.isArray(r.categories)&&r.categories.length){const g=r.categories.find(i=>typeof i=="string"&&i.trim());if(g)return g.trim()}return typeof r.name=="string"&&r.name.trim()?r.name.trim():typeof r.Name=="string"&&r.Name.trim()?r.Name.trim():typeof r.label=="string"&&r.label.trim()?r.label.trim():l},jl=(r,l,c)=>{const g=new Map;let i=0,b=0,h=0;c.traverse(P=>{const V=!!P?.isInstancedMesh,F=!!P?.isMesh;if(!V&&!F)return;let j=0;if(V){let k=0;typeof P.count=="number"?k=P.count:typeof P.instanceCount=="number"?k=P.instanceCount:Array.isArray(P.instanceIdMap)?k=P.instanceIdMap.length:Array.isArray(P.userData?.ids)?k=P.userData.ids.length:typeof P.userData?.size=="number"&&(k=P.userData.size),Number.isFinite(k)&&k>0&&(j=k,b+=k)}else j=1,h+=1;j<=0&&(j=1),i+=j;const z=Sl(P?.userData??{},P?.type??"Mesh"),T=g.get(z)??0;g.set(z,T+j)});const p=Array.from(g.entries()).map(([P,V])=>({category:P,count:V})).sort((P,V)=>V.count-P.count),v=new dt().setFromObject(c),y=new ee,E=new ee;return v.getSize(y),v.getCenter(E),{modelId:r,label:l,elementCount:i,instancedCount:b,meshCount:h,categoryCounts:p,bboxSize:{x:y.x,y:y.y,z:y.z},bboxCenter:{x:E.x,y:E.y,z:E.z},collectedAt:Date.now()}},vl=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),rt=r=>{if(!r)return"";let l=r.replace(/[_\-]+/g," ");return l=l.replace(/([a-z\d])([A-Z])/g,"$1 $2"),l=l.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),l=l.replace(/\s+/g," ").trim(),l?l.split(" ").map(g=>{const i=g.toUpperCase();return vl.has(i)||i.length<=3&&/^[A-Z]+$/.test(i)?i:/^\d+(\.\d+)?$/.test(g)||!g.length?g:g.charAt(0).toUpperCase()+g.slice(1)}).join(" "):""},kl=(r,l=200)=>r?r.length<=l?r:`${r.slice(0,l)}â€¦`:"",De=r=>{if(r==null)return"";if(typeof r=="number")return Number.isFinite(r)?r.toString():"";if(typeof r=="boolean")return r?"true":"false";if(r instanceof Date)return r.toISOString();if(typeof r=="string")return r.trim();try{const l=JSON.stringify(r);return l?l.length>500?`${l.slice(0,500)}â€¦`:l:""}catch{return String(r)}},Ee=r=>r==null?"":typeof r!="object"?De(r):"value"in r?Ee(r.value):"Value"in r?Ee(r.Value):Array.isArray(r)?r.map(l=>Ee(l)).filter(Boolean).join(", "):typeof r.x=="number"&&typeof r.y=="number"&&typeof r.z=="number"?`${De(r.x)}, ${De(r.y)}, ${De(r.z)}`:De(r),ge=(r,l)=>{if(!r||typeof r!="object")return;const c=l.map(b=>b.toLowerCase()),g=new WeakSet,i=[r];for(;i.length;){const b=i.pop();if(!(!b||typeof b!="object")&&!g.has(b)){if(g.add(b),Array.isArray(b)){for(const h of b)h&&typeof h=="object"&&i.push(h);continue}for(const[h,p]of Object.entries(b)){const v=h.toLowerCase();if(c.some(y=>v.includes(y)))if(typeof p=="string"){const y=p.trim();if(y)return y}else{if(typeof p=="number"&&Number.isFinite(p))return p.toString();if(typeof p=="boolean")return p?"true":"false";if(p&&typeof p=="object"){const y=Ee(p);if(y)return y}}p&&typeof p=="object"&&i.push(p)}}}},On={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},Pl=new Set(["modelIdMap"]),Dt=r=>r.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),ct=r=>r?r.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",tr=["HasProperties","hasProperties","Properties","properties"],xo=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],Tn=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Rr=r=>{if(!r||typeof r!="object")return!1;const l=typeof r.type=="string"?r.type:typeof r.Type=="string"?r.Type:void 0;return l&&l.toUpperCase()==="IFCPROPERTYSET"?!0:tr.some(c=>Array.isArray(r[c]))},qn=r=>{if(!r||typeof r!="object")return!1;const l=typeof r.type=="string"?r.type:typeof r.Type=="string"?r.Type:void 0;return l&&l.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in r||"nominalValue"in r},El=r=>{if(!r||typeof r!="object")return De(r);const l=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const c of l){if(!(c in r))continue;const g=r[c];if(g==null)continue;if(Array.isArray(g)){const b=g.map(h=>Ee(h)).filter(Boolean).join(", ");if(b)return b;continue}const i=Ee(g);if(i)return i}for(const[c,g]of Object.entries(r))if((typeof g=="string"||typeof g=="number"||typeof g=="boolean")&&c.toLowerCase().includes("value")){const i=De(g);if(i)return i}return""},Al=(r,l,c)=>{const g=tr.map(p=>Array.isArray(r[p])?r[p]:null).filter(p=>!!p);if(!g.length)return[];const i=rt(l)||l,b=[],h=new Map;return g.flat().forEach((p,v)=>{if(!p||typeof p!="object"||!qn(p))return;const y=qe(p)??(typeof p.Name=="string"?p.Name:void 0)??(typeof p.PropertyName=="string"?p.PropertyName:void 0),E=`Property ${v+1}`,P=y&&y.trim().length?y.trim():E,V=rt(P)||P,F=El(p),j=Dt(P)||"property",z=(h.get(j)??0)+1;h.set(j,z);const T=`${j}-${z}`,k=`Property Sets / ${i} / ${V}`,$=[k.toLowerCase()];F&&$.push(F.toLowerCase()),b.push({label:k,value:F||"",path:`property-sets/${c}/${T}`,searchText:$.join(" ").trim(),rawPsetName:l,rawPropertyName:P,rawValue:p.__rawValue??p})}),b},er=r=>{if(!r||typeof r!="object")return[];const l=[],c=new WeakSet,g=new Map,i=F=>{let j;if(typeof F=="string"){const $=F.trim();$.length&&(j=$)}!j&&F&&typeof F=="object"&&(j=qe(F)??(typeof F.Name=="string"?F.Name:void 0)??(typeof F.id=="string"?F.id:void 0)),(!j||!j.length)&&(j="Property Set");const z=rt(j)||j,T=Dt(j)||"property-set",k=(g.get(T)??0)+1;return g.set(T,k),{rawName:j,friendlyName:z,uniqueKey:`${T}-${k}`}},b=(F,j,z)=>{const T=`Property ${z+1}`,k=F?.trim?.()?F.trim():T;if(qn(j)){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.__rawValue==null&&($.__rawValue=j),$}if(j&&typeof j=="object"){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.type==null&&$.Type==null&&($.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in $)&&!("nominalValue"in $)&&!("Value"in $)&&!("value"in $)&&($.NominalValue=j),$.__rawValue=j,$}return{type:"IFCPROPERTYSINGLEVALUE",Name:k,PropertyName:k,NominalValue:j,__rawValue:j}},h=(F,j)=>{const z=[],T=(k,$)=>{const q=`Property ${z.length+1}`,he=(typeof k=="string"&&k.trim().length?k.trim():void 0)??qe(k)??(typeof k?.Name=="string"?k.Name:void 0)??(typeof k?.PropertyName=="string"?k.PropertyName:void 0)??q;z.push(b(he,$,z.length))};if(j&&typeof j=="object")for(const k of tr){const $=j[k];Array.isArray($)&&$.length&&$.forEach(q=>T(q,q))}if(!z.length)if(Array.isArray(j))j.forEach(k=>T(k,k));else if(j&&typeof j=="object")for(const[k,$]of Object.entries(j))$!=null&&(Tn.has(k)||tr.includes(k)||xo.includes(k)||T(k,$));else j!=null&&T(void 0,j);return{type:"IFCPROPERTYSET",Name:F,HasProperties:z}},p=(F,j)=>{const T=Al(j&&typeof j=="object"?j:{},F.rawName,F.uniqueKey);T.length&&l.push(...T)},v=F=>{if(!(!F||typeof F!="object")&&!c.has(F)){if(c.add(F),Array.isArray(F)){F.forEach(j=>{if(!j||typeof j!="object")return;const z=i(j),T=Rr(j)?j:h(z.rawName,j);p(z,T),T&&typeof T=="object"&&c.add(T)});return}for(const[j,z]of Object.entries(F)){if(z==null)continue;const T=i(j),k=Rr(z)?z:h(T.rawName,z);p(T,k),z&&typeof z=="object"&&c.add(z)}}},y=F=>{if(!F||typeof F!="object"||c.has(F))return;if(c.add(F),Array.isArray(F)){F.forEach(y);return}let j=!1;for(const z of xo)Object.prototype.hasOwnProperty.call(F,z)&&(v(F[z]),j=!0);if(Rr(F)){const z=i(F);p(z,F)}!j&&!Rr(F)&&Object.entries(F).forEach(([z,T])=>{xo.includes(z)||Tn.has(z)||tr.includes(z)||T&&typeof T=="object"&&y(T)})};y(r);const E=new Map,P=new Set;for(const F of l){const j=`${F.label}::${F.value}`;if(P.has(j))continue;const z=`${F.rawPsetName||"unknown"}::${F.rawPropertyName||"unknown"}::${F.value}`;E.has(z)||(P.add(j),E.set(z,F))}const V=Array.from(E.values());return l.length,V.length,V},Pe={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Vn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],Rl=(r,l)=>{const c=typeof r=="string"?r.trim().toLowerCase():"";if(c&&Vn.some(g=>c.startsWith(g)))return!0;if(l&&typeof l=="object"){const g=Ee(l._category??l.category??l.Category??null),i=typeof g=="string"?g.trim().toLowerCase():"";if(i&&Vn.some(h=>i.startsWith(h))||(l.NominalValue!=null||l.nominalValue!=null)&&(l.Name!=null||l.PropertyName!=null)&&c.includes("property"))return!0}return!1},_n="fragmentsViewer.favoritePropertyPaths",Ml=1e4,zl=500,qe=r=>{if(!r||typeof r!="object")return;let l,c;typeof r.Name=="string"?l=r.Name:r.Name&&typeof r.Name=="object"&&(l=Ee(r.Name)||void 0),typeof r.name=="string"?c=r.name:r.name&&typeof r.name=="object"&&(c=Ee(r.name)||void 0);const g=l??c;if(!g)return;const i=g.trim();return i.length?i:void 0},Mr=r=>{if(!r||typeof r!="object")return{rows:[],tree:[]};const l=[],c=new WeakSet,g=(h,p,v)=>{if(h==null)return null;const y=p.map(k=>{const $=k?.trim?.()??k;return typeof $=="string"&&$.length?rt($)||$:typeof k=="string"?k:String(k??"")}),E=y.filter(Boolean).join(" / "),P=v.length?v.join("/"):Dt(E||"value"),V=y[y.length-1]??"Value",F=k=>{const $=E.toLowerCase(),q=[$];k&&q.push(k.toLowerCase());const he=q.join(" ").trim()||$,te={label:E,value:k??"",path:P,searchText:he};return l.push(te),he};if(typeof h!="object"||h instanceof Date){const k=De(h),$=F(k);return{id:P,label:V,fullLabel:E,value:k||void 0,children:[],searchText:$}}if(c.has(h)){const k="[Circular reference]",$=F(k);return{id:P,label:V,fullLabel:E,value:k,children:[],searchText:$}}c.add(h);let j;const z=[];if(Array.isArray(h))h.forEach((k,$)=>{const q=qe(k),he=`${V} ${$+1}`,te=q&&q.trim().length?q.trim():he,J=rt(te)||te,oe=q&&q.trim().length?Dt(q):String($),Y=g(k,[...p,J],[...v,oe]);Y&&z.push(Y)}),z.length===0&&(j=De(h));else{if("NominalValue"in h||"nominalValue"in h){const k=h.NominalValue??h.nominalValue,$=Ee(k);$&&(j=$)}!j&&"value"in h&&typeof h.value!="object"&&(j=De(h.value)),!j&&"Value"in h&&typeof h.Value!="object"&&(j=De(h.Value));for(const[k,$]of Object.entries(h)){if($==null||k==="Name"||k==="name"||k==="IsDefinedBy"||k==="isDefinedBy"||k==="psets"||k==="Psets"||k==="propertySets"||k==="PropertySets"||k==="property_sets"||k==="Property_Sets")continue;if(k==="NominalValue"||k==="nominalValue"){const $e=rt("Nominal Value")||"Nominal Value",we=g($,[...p,$e],[...v,"nominal-value"]);we&&z.push(we);continue}const q=On[k]??k,he=rt(q)||q,te=qe($)?.trim(),J=te&&te.length?rt(te)||te:he,oe=te&&te.length?Dt(te):Dt(q),Y=[...p,J],U=g($,Y,[...v,oe]);U&&z.push(U)}!j&&z.length===0&&(j=De(h))}const T=F(j);return{id:P,label:V,fullLabel:E,value:j,children:z,searchText:T}},i=[];for(const[h,p]of Object.entries(r)){if(p==null||Pl.has(h))continue;const v=On[h]??h,y=g(p,[v],[h]);y&&i.push(y)}if(l.length){const h=l.filter(p=>{const v=p.label.toLowerCase();return v.startsWith("property sets /")?!(v.includes("/ has properties")||v.includes("/ nominal value")):!0});h.length!==l.length&&l.splice(0,l.length,...h)}const b=er(r);if(b.length){const h=[],p=new Set;for(const y of b)p.has(y.path)||(p.add(y.path),h.push(y));const v=[];for(const y of l)p.has(y.path)||v.push(y);l.splice(0,l.length,...h,...v)}return{rows:l,tree:i}},Dl=()=>{const r=d.useRef(null),l=d.useRef(null),c=d.useRef(null),g=d.useRef(null),i=d.useRef(null),b=d.useRef(!1),h=d.useRef(null),p=d.useRef(null),v=d.useRef(null),[y,E]=d.useState(!1),[P,V]=d.useState([]),[F,j]=d.useState(!1),[z,T]=d.useState(50);d.useCallback(async(e,s)=>{{console.warn("dumpModelRawData is dev-only.");return}},[P]),d.useCallback(async(e,s=50,n=128)=>{},[]);const[k,$]=d.useState([]),[q,he]=d.useState(null),[te,J]=d.useState(!0),[oe,Y]=d.useState(!1),[U,$e]=d.useState(!1),[we,ot]=d.useState(null),[Nt,Ke]=d.useState(!1),[ye,Ye]=d.useState(!1),Lt=d.useRef(null),nt=d.useRef(!1),Fe=d.useRef(null),Xe=d.useRef(null),or=d.useRef(0),be=d.useRef(null),nr=d.useRef(null),$r=d.useRef(new Set);d.useRef(null);const Te=d.useRef(null),sr=d.useRef(!1),St=d.useRef(null),Fr=d.useRef("click"),[ir,Kn]=d.useState({width:360,height:520}),Nr=d.useRef(null),lr=d.useRef(!1),Lr=d.useRef(null),Co=d.useRef(!1),So=d.useRef(null),pt=d.useRef(null),Or=d.useRef(null),ar=d.useRef(null),Tr=d.useRef(null),Ot=d.useRef(null),jo=d.useRef(null),vo=d.useRef(null),Ae=d.useRef(null),Je=d.useRef([]),Ve=d.useRef(null),Tt=d.useRef(null),Vt=d.useRef(null),[cr,Re]=d.useState(null),[le,Yn]=d.useState([]),[ko,Xn]=d.useState(""),[jt,Jn]=d.useState(""),[Ie,Po]=d.useState([]),[ht,Eo]=d.useState("favorites"),[Zn,$l]=d.useState(!1),[Qn,Fl]=d.useState(!1),[es,Nl]=d.useState(!1),[mt,ts]=d.useState("models"),[_e,dr]=d.useState(!1),[rs,Ao]=d.useState(0),[Be,_t]=d.useState(!1),[os,Ro]=d.useState(!1),[ns,Mo]=d.useState(!1),[ss,is]=d.useState(0),[me,Vr]=d.useState("disabled"),[Ze,_r]=d.useState(""),[Bt,ur]=d.useState(""),[Br,zo]=d.useState(!1),[Do,$o]=d.useState(!1),[Fo,vt]=d.useState(null),[xe,No]=d.useState("click"),[kt,Lo]=d.useState(!1),[Pt,ls]=d.useState(!1),fr=d.useRef(!1),as=d.useRef(new Map),Oo=d.useRef(null),Qe=d.useRef(!1),To=d.useRef(new Map),Et=d.useRef(null),[cs,Gr]=d.useState(0),[st,Vo]=d.useState(!1),[_o,ds]=d.useState({}),[Wr,Bo]=d.useState(null),[Gt,Go]=d.useState([]),[us,Hr]=d.useState(!1),[it,Wo]=d.useState("selected"),[lt,pr]=d.useState(""),[gt,Ho]=d.useState(!1),[Uo,hr]=d.useState(null),[At,Ur]=d.useState(!1),[yt,fs]=d.useState(!0),[qr,ps]=d.useState(0),[mr,hs]=d.useState([]),[qo,Ko]=d.useState(""),et=d.useRef(null),[ne,gr]=d.useState({x:!1,y:!1,z:!1}),[Ge,Yo]=d.useState({x:0,y:0,z:0}),[Wt,Xo]=d.useState(!1),[Ht,ms]=d.useState(!1),Ut=d.useRef(!1),Kr=d.useRef([]),Yr=d.useRef(new Map),yr=d.useRef(null),[Jo,Zo]=d.useState(null),Qo=d.useRef(null),bt=d.useCallback(()=>c.current?.camera??null,[]),Xr=d.useCallback(()=>bt()?.three??null,[bt]);d.useEffect(()=>{Fr.current=xe},[xe]),d.useEffect(()=>{const e=Qo.current;!e||!("mouseButtons"in e)||(xe==="rectangle"?e.mouseButtons={left:0,middle:2,right:0,wheel:16}:e.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),d.useEffect(()=>{try{const e=window.localStorage.getItem(_n);if(!e)return;const s=JSON.parse(e);if(!Array.isArray(s))return;const n=s.filter(o=>typeof o=="string"&&o.trim().length>0);n.length&&Po(n)}catch(e){console.warn("Failed to restore favourites from storage",e)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(_n,JSON.stringify(Ie))}catch(e){console.warn("Failed to persist favourites to storage",e)}},[Ie]);const br=ko.trim(),gs=br.length>0,en=d.useMemo(()=>{const e=br.toLowerCase();return e?le.filter(s=>s.searchText.includes(e)).slice(0,zl):[]},[br,le]),xr=d.useMemo(()=>{const e=new Map;return le.forEach(s=>e.set(s.path,s)),e},[le]),Jr=d.useMemo(()=>le.slice(0,Ml),[le]),tn=Math.max(le.length-Jr.length,0),rn=d.useMemo(()=>new Set(Ie),[Ie]),Zr=d.useMemo(()=>Ie.length?Ie.map(e=>xr.get(e)).filter(e=>!!e):[],[Ie,xr]),Qr=d.useMemo(()=>{if(!Ie.length)return 0;let e=0;for(const s of Ie)xr.has(s)||(e+=1);return e},[Ie,xr]),on=d.useCallback(e=>{Po(s=>s.includes(e)?s.filter(n=>n!==e):[...s,e])},[]),wr=d.useMemo(()=>P.map(e=>`${e.id}:${e.label}`).join("|"),[P]),eo=d.useCallback(e=>{const s=rn.has(e.path);return t.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[t.jsxs(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[t.jsx(H,{variant:"body2",sx:{fontWeight:600},children:e.label}),t.jsx(Q,{title:s?"Remove from favourites":"Add to favourites",children:t.jsx("span",{children:t.jsx(X,{size:"small",onClick:()=>on(e.path),color:s?"primary":"default",children:s?t.jsx(Js,{fontSize:"small"}):t.jsx(Zs,{fontSize:"small"})})})})]}),t.jsx(H,{variant:"body2",color:"text.secondary",children:e.value?kl(e.value,360):"â€”"})]},e.path)},[rn,on]);d.useEffect(()=>{if(!P.length){pr("");return}pr(e=>e&&P.some(s=>s.id===e)?e:P[0].id)},[P]);const nn=d.useCallback(async e=>{const s=i.current;if(!s)return[];const n=s.list.get(e);if(!n)return[];let o=[];try{const w=await n.getLocalIds();Array.isArray(w)?o=w:w&&typeof w[Symbol.iterator]=="function"&&(o=Array.from(w))}catch(w){return console.warn(`Failed to retrieve local IDs for model ${e}`,w),[]}if(!o.length)return[];const a=32,f=[];for(let w=0;w<o.length;w+=a){const m=o.slice(w,w+a);let u=[];try{u=await n.getItemsData(m,Pe)}catch(I){console.warn(`Failed to fetch items data for model ${e} chunk starting at ${m[0]}`,I);continue}u.forEach((I,C)=>{const A=m[C];if(I)try{const{rows:R}=Mr(I);R.forEach(S=>{f.push({path:`localId:${A} / ${S.label}`,value:S.value})})}catch(R){console.warn(`Failed to process properties for model ${e} localId ${A}`,R)}})}return f},[]),sn=d.useCallback(e=>{const s=[];return s.push("Path,Value"),e.forEach(({path:n,value:o})=>{const a=n.replace(/"/g,'""'),f=(o??"").replace(/"/g,'""');s.push(`"${a}","${f}"`)}),s.join(`\r
`)},[]),Ce=d.useCallback(e=>{const s=e??null;he(s);const{rows:n}=Mr(s);if(Yn(n),Eo(Ie.length?"favorites":"all"),n.length){Go(n.map(f=>({path:f.label,value:f.value})));const o="Path	Value",a=n.map(f=>`${f.label}	${f.value??""}`);Bo([o,...a].join(`\r
`))}else Go([]),Bo(null)},[Ie.length]),Se=d.useCallback(async()=>{if(be.current){const e=be.current;e.enabled=!0;try{typeof e.clear=="function"&&await e.clear(),typeof e.create=="function"&&(await new Promise(n=>setTimeout(n,0)),e.list?.has("select")||e.selection?.select||(console.debug('Re-creating missing "select" style in resetViewerTools'),e.create("select")))}catch(s){console.warn("Failed to clear/reset highlighter:",s)}}if(Ae.current)try{await Ae.current.set(!0)}catch(e){console.warn("Failed to reset isolation:",e)}if(fr.current=!1,Lo(!1),Qe.current=!1,Et.current=null,i.current)try{i.current.resetHighlight(),i.current.core.update(!0)}catch(e){console.warn("Failed to reset fragments highlight:",e)}$([]),Ce(null)},[Ce]),ys=d.useCallback(()=>{hr(null),Wo(le.length?"selected":"model"),P.length&&!P.some(e=>e.id===lt)&&pr(P[0].id),Hr(!0)},[le.length,P,lt]),bs=d.useCallback(async()=>{if(!q){alert("No element selected");return}try{const e=new WeakSet,s=JSON.stringify(q,(n,o)=>{if(typeof o=="object"&&o!==null){if(e.has(o))return"[Circular Reference]";e.add(o)}return o instanceof Map?`[Map with ${o.size} entries]`:o instanceof Set?`[Set with ${o.size} items]`:o instanceof WeakMap||o instanceof WeakSet?"[WeakMap/WeakSet]":typeof o=="function"?"[Function]":typeof o=="symbol"?"[Symbol]":o},2);await navigator.clipboard.writeText(s),alert("Raw element data copied to clipboard!")}catch(e){console.error("Failed to copy raw data:",e),alert("Failed to copy data to clipboard. See console for details.")}},[q]),ln=d.useCallback(()=>{gt||(Hr(!1),hr(null),Se())},[gt,Se]),xs=d.useCallback(async()=>{if(!gt){Ho(!0),hr(null);try{let e=[];if(it==="selected"){if(!le.length)throw new Error("No properties available for the current selection.");e=le.map(m=>({path:m.label,value:m.value}))}else{if(!lt)throw new Error("Select a model to export.");if(e=await nn(lt),!e.length)throw new Error("No properties were found for the chosen model.")}const s=sn(e),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),o=URL.createObjectURL(n),a=document.createElement("a"),f=it==="selected"?"selection":`model-${lt}`,w=new Date().toISOString().replace(/[:.]/g,"-");a.href=o,a.download=`fragment-properties-${f}-${w}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(o),Hr(!1)}catch(e){console.warn("Failed to export properties",e),hr(e.message??"Failed to export properties.")}finally{Ho(!1)}}},[sn,lt,it,nn,gt,le]),an=d.useCallback(()=>{Vo(e=>!e)},[]),ws=d.useCallback(()=>{dr(!0),Ao(e=>e+1)},[]),Is=d.useCallback(()=>{dr(!1),Se()},[Se]),cn=d.useCallback(()=>{_e?(dr(!1),Se()):(dr(!0),Ao(e=>e+1))},[_e,Se]),Cs=d.useCallback(()=>{Ro(!0)},[]),dn=d.useCallback(()=>{Ro(!1),Se()},[Se]),un=d.useCallback(()=>{const e=Ui();e?(Vr(e.provider),_r(e.apiKey),ur(e.model||Er(e.provider))):(Vr("disabled"),_r(""),ur("")),vt(null),Mo(!0)},[]),Ir=d.useCallback(()=>{Mo(!1),zo(!1),vt(null),Se()},[Se]),Ss=d.useCallback(()=>{if(me==="disabled")qi();else{const e={provider:me,apiKey:Ze,model:Bt||Er(me)};Hi(e)}is(e=>e+1),Ir()},[me,Ze,Bt,Ir]),js=d.useCallback(e=>{Vr(e),ur(Er(e)),vt(null)},[]),vs=d.useCallback(async()=>{if(!(!Ze||me==="disabled")){$o(!0),vt(null);try{let e=!1;const s=Bt||Er(me);me==="gemini"?e=await Xi(Ze,s):me==="openai"&&(e=await Zi(Ze,s)),vt(e?"success":"error")}catch{vt("error")}finally{$o(!1)}}},[me,Ze,Bt]),qt=d.useCallback(e=>{if(!e||typeof e!="object")return"IfcProduct";if(e.constructor&&typeof e.constructor.name=="string"&&e.constructor.name.toUpperCase().startsWith("IFC")){const a=e.constructor.name.trim();if(a!=="Object"&&a!=="Array")return a}const s=Ee(e._category??e.category??e.Category??null);if(s&&s.trim().length&&s.toUpperCase().startsWith("IFC"))return s.trim();const n=[e.expressID!==void 0?null:e.type,e.ifcClass,e.IfcClass,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.ifcType,e.IfcType,e?.attributes?.ifcClass,e?.Attributes?.IfcClass];for(const a of n)if(typeof a=="string"&&a.trim().length){const f=a.trim();if(f.toUpperCase().startsWith("IFC")&&!f.toUpperCase().includes("IDENTIFIER")&&!f.toUpperCase().includes("LABEL")&&!f.toUpperCase().includes("TEXT"))return f}const o=ge(e,["ifcclass","ifc type","express type"]);return o&&o.toUpperCase().startsWith("IFC")?o:"IfcProduct"},[]),to=d.useCallback((e,s,n)=>{const o={},a={},f={};er(e).forEach(C=>{const A=C.label.split("/").map(_=>_.trim()),R=C.rawPsetName??A[1]??"",S=C.rawPropertyName??A[A.length-1]??"",x=ct(R),M=ct(S);if(!x||!M)return;a[x]||(a[x]={}),M in a[x]||(a[x][M]=C.value);const D=`${x}.${M}`;D in o||(o[D]=C.value)}),o.GlobalId=s,o.ifcClass=n,f.ifcClass=n,f.GlobalId=s,o["Attributes.GlobalId"]=s,o["Attributes.IfcClass"]=n,o["Attributes.ifcClass"]=n;const m=qe(e);m&&(f.Name=m,o["Attributes.Name"]=m);const u=ge(e,["category","ifccategory"]);u&&(f.Category=u,o["Attributes.Category"]=u);const I=ge(e,["type","typename"]);I&&(f.Type=I,o["Attributes.Type"]=I);for(const[C,A]of Object.entries(e??{})){if(A==null||typeof A!="object"||Array.isArray(A))continue;const R=Ee(A);if(!R)continue;const S=String(C).replace(/^_+/,""),x=`Attributes.${rt(S)}`;if(x in o||(o[x]=R),S in f||(f[S]=R),/guid|globalid|_guid/i.test(C)){const M=String(R).trim();M&&!o.GlobalId&&(o.GlobalId=M,f.GlobalId=M)}}return{flattened:o,psets:a,attributes:f}},[]),ro=d.useCallback(()=>{const e=i.current;return e?`${Array.from(e.list.keys()).sort().join("|")}|${P.length}`:"empty"},[P]),ks=d.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0)return{signature:"empty",elementCount:0,modelFiles:[]};const s=Array.from(e.list.keys()).sort(),n=P.map(m=>({id:m.id,name:m.label}));let o=0;for(const[m,u]of e.list)try{const I=await u.getLocalIds(),C=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[];o+=C.length}catch(I){console.error(`âŒ [computeModelSignature] Failed to count elements in model ${m}`,I)}return{signature:[...s,...P.map(m=>`${m.id}:${m.label}`),`count:${o}`].join("|"),elementCount:o,modelFiles:n}},[P]),Cr=d.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0){const o={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Ve.current=o,o}const s=ro();if(Ve.current&&Ve.current.signature===s)return Ve.current;if(Tt.current)return Tt.current;const n=(async()=>{const o=new Map,a=[],f=new Map;for(const[m,u]of e.list){let I=[];try{const A=await u.getLocalIds();Array.isArray(A)?I=A:A&&typeof A[Symbol.iterator]=="function"&&(I=Array.from(A))}catch(A){console.warn(`IDS cache: failed to read local IDs for model ${m}`,A);continue}if(f.set(m,I.slice()),!I.length)continue;const C=48;for(let A=0;A<I.length;A+=C){const R=I.slice(A,A+C);let S=[];try{S=await u.getItemsData(R,Pe)}catch(x){console.warn(`IDS cache: failed to fetch items data for model ${m}`,x);continue}S.forEach((x,M)=>{if(!x)return;const D=R[M],_=qt(x),O=typeof x.GlobalId=="string"&&x.GlobalId.trim()||typeof x.GlobalID=="string"&&x.GlobalID.trim()||ge(x,["globalid","global id","guid"]);if(!O){if(Rl(_,x))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:m,localId:D,itemData:x});return}const N=O.trim();if(!N.length||o.has(N))return;const{flattened:L,psets:B,attributes:K}=to(x,N,_),Z={GlobalId:N,ifcClass:_,properties:L},W=x;(typeof W.GlobalId!="string"||!W.GlobalId.trim())&&(W.GlobalId=N),o.set(N,{element:Z,modelId:m,localId:D,psets:B,attributes:K,raw:W}),a.push(Z)})}}const w={signature:s,records:o,elements:a,modelLocalIds:f};return Ve.current=w,w})().finally(()=>{Tt.current=null});return Tt.current=n,n},[ro,to,qt]),Rt=d.useCallback(async e=>{const s=new Map,n=i.current;if(!n)return console.error("ðŸ” [groupLocalIdsByModel] Fragments not available"),{grouped:s,cache:Ve.current};for(const[o,a]of n.list)try{const f=await a.getLocalIdsByGuids(e),w=[];for(let m=0;m<f.length;m++){const u=f[m];u!==null&&w.push(u)}w.length>0&&s.set(o,w)}catch(f){console.warn(`ðŸ” [groupLocalIdsByModel] Failed for model ${o}:`,f)}return{grouped:s,cache:Ve.current}},[]),Ne=Ft.useMemo(()=>({listGlobalIds:async()=>(await Cr()).elements.map(s=>s.GlobalId),getSelectedGlobalIds:async()=>{const e=Je.current;if(!e||e.length===0)return[];const s=i.current;if(!s)return console.warn("ðŸ“ Fragments not available"),[];const n=[];for(const o of e){const a=s.list.get(o.modelId);if(!a){console.warn("ðŸ“ Model not found for item:",o);continue}try{const[f]=await a.getItemsData([o.localId],{attributesDefault:!1});if(f){const w=ge(f,["globalid","global id","guid"]);w&&typeof w=="string"?n.push(w):console.warn("ðŸ“ No GlobalId found in data for item:",o)}}catch(f){console.error("ðŸ“ Error fetching data for item:",o,f)}}return n},getVisibleGlobalIds:async()=>{const e=i.current;if(!e)return console.warn("ðŸ‘ï¸ Fragments not available"),[];const s=[];let n=0,o=0;for(const[a,f]of e.list)try{let w=[];try{const C=await f.getLocalIds();w=Array.isArray(C)?C:C&&typeof C[Symbol.iterator]=="function"?Array.from(C):[],n+=w.length}catch(C){console.error(`ðŸ‘ï¸ Failed to get local IDs for model ${a}:`,C);continue}const m=await f.getItemsByVisibility(!0);o+=m.length;const u=m.length>0?m:w;if(u.length===0)continue;const I=100;for(let C=0;C<u.length;C+=I){const A=u.slice(C,Math.min(C+I,u.length));try{const R=await f.getItemsData(A,{attributesDefault:!1,attributes:["GlobalId"]});for(const S of R){const x=ge(S,["globalid","global id","guid"]);x&&typeof x=="string"&&s.push(x)}}catch(R){console.error(`ðŸ‘ï¸ Error fetching GlobalIds for batch in model ${a}:`,R)}}}catch(w){console.error(`ðŸ‘ï¸ Error getting visible elements from model ${a}:`,w)}return console.log(`ðŸ‘ï¸ getVisibleGlobalIds: Found ${s.length} visible elements (${o} reported visible out of ${n} total)`),s},getElementProps:async e=>{const s=i.current;if(!s)throw new Error("Fragments not available");for(const[n,o]of s.list)try{const f=(await o.getLocalIdsByGuids([e]))[0];if(f!=null){const[w]=await o.getItemsData([f],Pe);if(!w){console.warn(`ðŸ” [getElementProps] No data returned for localId ${f}`);continue}const m=qt(w),u={},I={};er(w).forEach(x=>{const M=x.label.split("/").map(L=>L.trim()),D=x.rawPsetName??M[1]??"",_=x.rawPropertyName??M[M.length-1]??"",O=ct(D),N=ct(_);!O||!N||(u[O]||(u[O]={}),N in u[O]||(u[O][N]=x.value))}),I.ifcClass=m,I.GlobalId=e;const A=qe(w);A&&(I.Name=A);const R=ge(w,["category","ifccategory"]);R&&(I.Category=R);const S=ge(w,["type","typename"]);return S&&(I.Type=S),{ifcClass:m,psets:u,attributes:I}}}catch(a){console.warn(`ðŸ” [getElementProps] Error in model ${n}:`,a);continue}throw console.error(`ðŸ” [getElementProps] Element with GlobalId ${e} not found in any model`),new Error(`Element with GlobalId ${e} is not available.`)},getElementPropsFast:async e=>{const s=Je.current,n=i.current;if(!n)throw console.error("ðŸ” [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");for(let o=0;o<s.length;o++){const a=s[o],f=n.list.get(a.modelId);if(f)try{const[w]=await f.getItemsData([a.localId],Pe);if(w&&ge(w,["globalid","global id","guid"])===e){const u=qt(w),I={},C={};er(w).forEach(M=>{const D=M.label.split("/").map(B=>B.trim()),_=M.rawPsetName??D[1]??"",O=M.rawPropertyName??D[D.length-1]??"",N=ct(_),L=ct(O);!N||!L||(I[N]||(I[N]={}),L in I[N]||(I[N][L]=M.value))}),C.ifcClass=u,C.GlobalId=e;const R=qe(w);R&&(C.Name=R);const S=ge(w,["category","ifccategory"]);S&&(C.Category=S);const x=ge(w,["type","typename"]);return x&&(C.Type=x),{ifcClass:u,psets:I,attributes:C}}}catch(w){console.error("ðŸ” [getElementPropsFast] Error for item:",a,w)}}return Vt.current.getElementProps(e)},countElements:async()=>(await Cr()).elements.length,iterElements:e=>{const s=Math.max(1,Math.floor(e?.batchSize??500));return{async*[Symbol.asyncIterator](){const n=i.current;if(!n||n.list.size===0){console.warn("âš ï¸ [viewerApi.iterElements] No fragments available");return}let o=[],a=0;for(const[f,w]of n.list){let m=[];try{const I=await w.getLocalIds();m=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[]}catch(I){console.error(`âŒ [viewerApi.iterElements] Failed to get local IDs for model ${f}`,I);continue}const u=Math.min(500,Math.max(100,s));for(let I=0;I<m.length;I+=u){const C=m.slice(I,I+u);try{const A=await w.getItemsData(C,Pe);for(let R=0;R<A.length;R++){const S=A[R];S&&o.push({modelId:f,localId:C[R],data:S})}for(;o.length>=s;){const R=o.splice(0,s);a+=R.length,a%5e3,yield R}}catch(A){console.error(`âŒ [viewerApi.iterElements] Failed to fetch chunk at ${I}`,A)}}}o.length>0&&(a+=o.length,yield o)}}},_iterElementsLegacy:e=>{const s=Math.max(1,Math.floor(e?.batchSize??100));return{async*[Symbol.asyncIterator](){const n=await Cr(),o=Array.from(n.records.values());for(let a=0;a<o.length;a+=s){const f=o.slice(a,a+s).map(w=>({modelId:w.modelId,localId:w.localId,data:{...w.raw,GlobalId:w.element.GlobalId}}));f.length&&(yield f)}}}},buildIdsCache:async()=>{try{return(await Cr()).elements.length}catch(e){throw console.error("viewerApi.buildIdsCache failed",e),e}},getModelSignature:async()=>await ks(),addToCache:async e=>{const s=i.current;if(!s){console.warn("ðŸ“¦ [addToCache] Fragments not available");return}let n=Ve.current;n||(n={signature:ro(),records:new Map,elements:[],modelLocalIds:new Map},Ve.current=n);const o=Je.current;for(const a of e){if(n.records.has(a))continue;let f=!1;for(const w of o){const m=s.list.get(w.modelId);if(m)try{const[u]=await m.getItemsData([w.localId],Pe);if(u){let I=u._guid||u.GlobalId;if(I&&typeof I=="object"&&(I=I.value||I),I===a){const C=qt(u),A={};er(u).forEach(L=>{const B=L.label.split("/").map(ue=>ue.trim()),K=L.rawPsetName??B[1]??"",Z=L.rawPropertyName??B[B.length-1]??"",W=ct(K),pe=ct(Z);!W||!pe||(A[W]||(A[W]={}),pe in A[W]||(A[W][pe]=L.value))});const S={ifcClass:C,GlobalId:a},x=qe(u);x&&(S.Name=x);const M=ge(u,["category","ifccategory"]);M&&(S.Category=M);const D=ge(u,["type","typename"]);D&&(S.Type=D);const _={GlobalId:a,ifcClass:C,properties:to(u,a,C)},O={element:_,modelId:w.modelId,localId:w.localId,psets:A,attributes:S,raw:u};n.records.set(a,O),n.elements.push(_);const N=n.modelLocalIds.get(w.modelId)||[];N.push(w.localId),n.modelLocalIds.set(w.modelId,N),f=!0;break}}}catch(u){console.debug("ðŸ“¦ [addToCache] Error checking selection item:",u)}}f||console.warn(`ðŸ“¦ [addToCache] Could not find ${a} in selection`)}},color:async(e,s)=>{if(!e.length)return;const n=be.current,o=i.current,a=c.current;if(!n||!b.current||!o||!a)return;let f,w;try{const I=await Rt(e);f=I.grouped,w=I.cache}catch(I){console.error("ðŸŽ¨ [color] groupLocalIdsByModel failed:",I);return}const m=new Oe(s.r,s.g,s.b),u=m.getHex();nr.current||(nr.current=new Map);for(const[I,C]of f){const A=o.list.get(I);if(!(!A||!C.length))try{const R=Array.from(C);if(n.styles&&typeof n.styles.set=="function")try{if(!R||R.length===0){console.debug(`Skipping highlight for model ${I} - no IDs`);continue}const S=`ids-color-${u.toString(16).padStart(6,"0")}`;if($r.current.add(S),n.styles.set(S,{color:m,fillOpacity:1}),typeof n.create=="function")try{(!n.list||!n.list.has(S))&&n.create(S)}catch(x){console.debug("highlighter.create failed:",x)}if(typeof n.select=="function")try{n.select(A,R,S)}catch(x){throw console.debug("highlighter.select failed:",x),x}continue}catch(S){console.debug("styles.set failed:",S)}if(typeof n.add=="function")try{if(n.add(A,R,u),a&&typeof a.update=="function")try{a.update()}catch(S){console.debug("World update failed:",S)}continue}catch(S){console.debug("add failed:",S)}if(typeof n.highlightById=="function")try{await n.highlightById(A,R,u);continue}catch(S){console.debug("highlightById failed:",S)}if(typeof n.highlightByID=="function")try{await n.highlightByID(A,R,u);continue}catch(S){console.debug("highlightByID failed:",S)}console.warn(`âŒ Could not color model ${I} - all highlighter methods failed`)}catch(R){console.error(`Failed to color model ${I}:`,R)}}},clearColors:async()=>{const e=be.current,s=i.current;if(!b.current||!s)return;const n=To.current;if(n.size>0){for(const[o,a]of n){const{color:f,transparent:w,opacity:m}=a;o.transparent=w,o.opacity=m,"color"in o?o.color.setHex(f):o.lodColor.setHex(f),o.needsUpdate=!0}n.clear()}e&&Qe.current&&(e.enabled=!0,Qe.current=!1,Et.current=null),Et.current=null,s&&(s.resetHighlight(),s.core.update(!0));try{if(e){if(e.styles&&typeof e.styles.delete=="function")try{e.styles.delete("ghost")}catch(o){console.warn("Failed to clear ghost styles",o)}if(typeof e.clear=="function"&&await Promise.resolve(e.clear()),e.styles&&typeof e.styles.delete=="function")$r.current.forEach(o=>{try{e.styles.delete(o)}catch{}}),$r.current.clear();else if(e.styles&&typeof e.styles.clear=="function"&&(e.styles.clear(),typeof e.create=="function"))try{e.create("select")}catch{}}}catch(o){console.warn("Failed to clear IDS highlights",o)}nr.current&&nr.current.clear();try{const o=Xe.current;if(o&&o.mesh&&o.mesh.instanceColor){const a=new Oe(1,1,1);o.mesh.setColorAt(o.index,a),o.mesh.instanceColor.needsUpdate=!0}}catch{}},isolate:async e=>{const s=Ae.current,n=i.current;if(!s||!n||!b.current||(await Promise.resolve(s.set(!0)),!e.length||!b.current))return;const{grouped:o}=await Rt(e);if(o.size===0){console.warn("isolate: No elements found in cache for isolation");return}const a=new Map;o.forEach((w,m)=>{a.set(m,new Set(w))});const f={};for(const[w,m]of a.entries()){const u=n.list.get(w);if(u)try{let I=[];const C=await u.getLocalIds();Array.isArray(C)?I=C:C&&typeof C[Symbol.iterator]=="function"&&(I=Array.from(C));const A=I.filter(R=>!m.has(R));A.length>0&&(f[w]=new Set(A))}catch(I){console.error("isolate: Failed to get local IDs for model",w,I)}}Object.keys(f).length>0&&await Promise.resolve(s.set(!1,f))},clearIsolation:async()=>{const e=Ae.current;e&&await Promise.resolve(e.set(!0))},ghost:async e=>{const s=i.current,n=be.current;if(console.log(`ðŸŽ­ ghost() called with ${e.length} global IDs`),!s||!b.current||!n){console.warn("ðŸŽ­ ghost() aborted: fragments or highlighter not ready");return}const{grouped:o}=await Rt(e);if(o.size===0){console.warn("ðŸŽ­ ghost() aborted: no grouped IDs");return}const a={};let f=0;for(const[u,I]of o.entries())a[u]=new Set(I),f+=I.length;console.log(`ðŸŽ­ ghost() applying to ${f} objects across ${o.size} models`),Et.current=a,n.enabled=!1,Qe.current=!0;const w=[...s.core.models.materials.list.values()],m=To.current;for(const u of w){if(u.userData.customId)continue;let I;"color"in u?I=u.color.getHex():I=u.lodColor.getHex(),m.set(u,{color:I,transparent:u.transparent,opacity:u.opacity}),u.transparent=!0,u.opacity=.05,u.needsUpdate=!0,"color"in u?u.color.setColorName("white"):u.lodColor.setColorName("white")}if(Object.keys(a).length>0)try{s.highlight({customId:"filter-ghost",color:new Oe(16750592),renderedFaces:1,opacity:1,transparent:!1},a)}catch{}s.core.update(!0)},getItemsData:async(e,s)=>{const n=i.current;if(!n)return console.error("ðŸ” [getItemsData] Fragments not available"),[];const{grouped:o}=await Rt(e),a=[];for(const[f,w]of o.entries()){const m=n.list.get(f);if(m)try{const u=await m.getItemsData(Array.from(w),s);a.push(...u)}catch(u){console.error(`ðŸ” [getItemsData] Failed for model ${f}`,u)}}return a},getLoadedCategories:async()=>{const e=i.current;if(!e)return[];const s=["IfcWall","IfcWallStandardCase","IfcSlab","IfcRoof","IfcWindow","IfcDoor","IfcColumn","IfcBeam","IfcStair","IfcStairFlight","IfcRailing","IfcCurtainWall","IfcPlate","IfcMember","IfcBuildingElementProxy","IfcFurnishingElement","IfcFlowTerminal","IfcSpace","IfcDuctSegment","IfcPipeSegment","IfcFlowFitting","IfcFlowController","IfcDiscreteAccessory","IfcSite","IfcBuilding","IfcBuildingStorey","IfcGroup","IfcZone","IfcSystem","IfcDistributionSystem","IfcProject","IfcOpeningElement","IfcAnnotation","IfcGrid","IfcCovering","IfcFooting","IfcPile","IfcRamp","IfcRampFlight","IfcFlowSegment","IfcFlowStorageDevice","IfcFlowMovingDevice","IfcFlowTreatmentDevice","IfcEnergyConversionDevice","IfcCivilElement","IfcGeographicElement","IfcVirtualElement"],n=[];for(const a of s)n.push((async()=>{const f=new RegExp(`^${a}$`,"i");for(const[w,m]of e.list)try{const u=await m.getItemsOfCategories([f]);if(u&&Object.keys(u).length>0&&Object.values(u).some(C=>C&&C.length>0))return a}catch{}return null})());return(await Promise.all(n)).filter(a=>a!==null).sort()},getItemsByCategory:async e=>{const s=i.current;if(!s)return console.error("ðŸ” [getItemsByCategory] Fragments not available"),{};const n={};for(const[o,a]of s.list)try{const f=await a.getItemsOfCategories(e);if(f&&Object.keys(f).length>0){const w=Object.values(f).flat();w.length>0&&(n[o]=w)}}catch(f){console.error(`ðŸ” [getItemsByCategory] Failed for model ${o}`,f)}return n},getItemsDataByModel:async(e,s,n)=>{const o=i.current;if(!o)return console.error("ðŸ” [getItemsDataByModel] Fragments not available"),[];const a=o.list.get(e);if(!a)return console.error(`ðŸ” [getItemsDataByModel] Model ${e} not found`),[];try{return await a.getItemsData(s,n)}catch(f){return console.error(`ðŸ” [getItemsDataByModel] Failed for model ${e}`,f),[]}},fitViewTo:async e=>{if(!e.length)return;const s=c.current,n=i.current;if(!s||!n||!b.current)return;const o=s.camera??null,a=o?.controls??null,f=o?.three??null,{grouped:w}=await Rt(e),m=new dt;let u=!1;for(const[S,x]of w.entries()){const M=n.list.get(S);if(!M||!M.object)continue;const D=new dt().setFromObject(M.object);D.isEmpty()||(u?m.union(D):(m.copy(D),u=!0))}if(!u)return;const I=new ee,C=new ee;m.getCenter(I),m.getSize(C);const R=(Math.max(C.x,C.y,C.z)||10)*1.5;a?a.setLookAt(I.x+R,I.y+R,I.z+R,I.x,I.y,I.z,!0):f&&(f.position.set(I.x+R,I.y+R,I.z+R),f.lookAt(I))}}),[Rt]);Vt.current=Ne;const fn=d.useCallback(async()=>{if(y)try{if(!Ne.getItemsByCategory||!Ne.getItemsDataByModel){console.warn("viewerApi missing required methods for level extraction");return}const e=await Ne.getItemsByCategory([/IfcBuildingStorey/i]),s=[];for(const[o,a]of Object.entries(e)){if(a.length===0)continue;const f=await Ne.getItemsDataByModel(o,a,Pe);for(let w=0;w<f.length;w++){const m=f[w];let u=ge(m,["name","label","longname"]);u||(u=qe(m)),u||(u=`Level ${w+1}`);let I=ge(m,["elevation","z"]);!I&&m.Elevation&&(I=Ee(m.Elevation));const C=ge(m,["globalid","guid","_guid"]);if(C){const A=I?parseFloat(I):0;s.push({name:u,elevation:isNaN(A)?0:A,globalId:C})}}}s.sort((o,a)=>o.elevation-a.elevation);const n=[];if(s.length>0){const o=s[0].elevation;s.forEach(a=>{n.push({name:a.name,elevation:a.elevation-o,originalElevation:a.elevation,globalId:a.globalId})})}if(hs(n),n.length>0&&(Ko(n[0].globalId),et.current&&i.current))try{let o=0;for(const[m,u]of i.current.list)if(typeof u.getCoordinates=="function")try{const I=await u.getCoordinates();if(Array.isArray(I)&&I.length>=2){o=I[1];break}}catch{}const f=n[0].originalElevation+o,w=et.current.three;w&&w.position&&(w.position.y=f)}catch{}}catch(e){console.error("Failed to extract levels",e)}},[y,Ne]);d.useEffect(()=>{y&&fn()},[y,fn]);const Ps=d.useCallback(()=>{_t(!0),Gr(e=>e+1)},[]),Es=d.useCallback(()=>{_t(!1),Se()},[Se]),pn=d.useCallback(()=>{Be?(_t(!1),Se()):(_t(!0),Gr(e=>e+1))},[Be,Se]),As=d.useCallback(async e=>{try{const{setIdsXmlText:s,runCheck:n}=await $t(()=>Promise.resolve().then(()=>yl),void 0).then(o=>o.idsStore);s(e),_t(!0),Gr(o=>o+1),setTimeout(async()=>{Vt.current&&await n(Vt.current)},100)}catch(s){console.error("Failed to validate from IDS Creator:",s),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Je.current=k},[k]),d.useEffect(()=>{Ve.current=null,Tt.current=null;try{Un.invalidateCaches()}catch(e){console.warn("Failed to invalidate IDS caches",e)}},[P]),d.useEffect(()=>{const e=r.current;if(!e)return;let s=!1;Co.current||(Si.init(),ji.init(),Co.current=!0);try{e.replaceChildren()}catch{}const n=new vi;g.current=n;const a=n.get(ki).create();a.name="main",a.scene=new Pi(n),a.scene.setup(),a.renderer=new Ei(n,e);const f=a.renderer.three;f.shadowMap.enabled=!1,f.sortObjects=!1,a.camera=new Ai(n),a.camera.controls?.setLookAt(10,10,10,0,0,0),a.camera.three.near=.1,a.camera.three.far=1e9,a.camera.three.updateProjectionMatrix();const w=a.camera.controls;w&&(Qo.current=w,"mouseButtons"in w&&(w.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in w&&(w.dollySpeed=1));const m=new Fi(16777215,1);a.scene.three.add(m),c.current=a;const u=new Qs;u.showPanel(2),u.dom.style.position="absolute",u.dom.style.left="8px",u.dom.style.top="8px",u.dom.style.zIndex="1000",e.appendChild(u.dom),a.renderer.onBeforeUpdate.add(()=>u.begin()),a.renderer.onAfterUpdate.add(()=>u.end());let I=null;const C=async S=>{if(!b.current)return;const x=[];for(const[L,B]of Object.entries(S))B.forEach(K=>{Number.isInteger(K)&&x.push({modelId:L,localId:K})});const M=Je.current;if(!!bo(x,M))return;$(x),at();const _=i.current;if(!_||!x.length){Ce(null);return}const O=x[0],N=_.list.get(O.modelId);if(!N){Ce(null);return}try{const[L]=await N.getItemsData([O.localId],Pe);Ce(L||null)}catch(L){console.warn("Failed to fetch properties for selection",L)}},A=()=>{fr.current||Qe.current||($([]),Ce(null))};return(async()=>{try{await Promise.resolve(n.init())}catch(N){console.error("Failed to initialize viewer components",N);return}if(s)return;try{const L=n.get(Ri).create(a);et.current=L,L&&(L.visible=!0)}catch(N){console.warn("Failed to create grid component",N)}const x=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),M=URL.createObjectURL(new File([x],"worker.mjs",{type:"text/javascript"}));v.current=M;const D=n.get(Mi);await D.init(M),i.current=D,b.current=!0;const _=n.get(zi);_.setup({world:a}),_.zoomToSelection=!1;try{typeof _.create=="function"&&_.create("select");let N=0;const L=10;for(;N<L&&(!_.selection||!_.selection.select);)await new Promise(B=>setTimeout(B,20)),N++;(!_.selection||!_.selection.select)&&console.warn("Highlighter selection system still initializing (non-blocking)")}catch(N){console.warn("Error during highlighter initialization:",N)}be.current=_;const O=n.get(Di);Ae.current=O;try{const N=n.get($i);if(N.world=a,N.color=new Oe("#ff0000"),"snapDistance"in N&&(N.snapDistance=.5),"preview"in N){const L=N.preview;L&&(L.enabled=!0,L.color&&(L.color=new Oe("#00ff00")))}if("workingPlane"in N){const L=N.workingPlane;L&&typeof L=="object"&&(L.visible=!0)}N.list?.onItemAdded&&N.list.onItemAdded.add(L=>{const B=L.value||L.distance?.()||0;Zo(B.toFixed(3)),L.dimensionLabel&&(L.dimensionLabel.visible=!0)}),N.enabled=!1,yr.current=N}catch(N){console.error("Failed to initialize measurement tool:",N)}_.events.select.onHighlight.add(C),_.events.select.onClear.add(A),I=()=>{_.events.select.onHighlight.remove?.(C),_.events.select.onClear.remove?.(A)},bt()?.controls?.addEventListener("rest",()=>D.core.update(!0));try{const L=(await $t(()=>import("./thatopen-vendor-C9781ij5.js").then(Z=>Z.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new L,K="/Savora-Viewer/";B.wasm={path:`${K}web-ifc/`,absolute:!0},h.current=B}catch(N){console.warn("Failed to lazy-load FRAGS.IfcImporter:",N)}s||Ye(!0)})().catch(S=>{console.error("Failed to initialize viewer fragments",S)}),()=>{s=!0,(async()=>{const S=b.current;b.current=!1,I?.(),I=null;try{S&&await Ae.current?.set?.(!0)}catch{}if(i.current){const x=[...i.current.list.keys()];await Promise.all(x.map(M=>i.current.core.disposeModel(M)))}try{S&&be.current?.clear?.()}catch{}v.current&&URL.revokeObjectURL(v.current);try{n.dispose()}catch{}try{e.replaceChildren()}catch{}be.current=null,Ae.current=null})()}},[]),d.useEffect(()=>{if(!ye)return;const e=g.current,s=i.current;if(!e||!s)return;const n=wr,o=(a,f,w)=>{if(!a)return;let m=f.current;m||(m=w(),f.current=m),m&&m.parentElement!==a&&a.replaceChildren(m)};o(So.current,pt,()=>{const[a,f]=Mn.modelsList({components:e});return Or.current=f,a}),pt.current&&((!pt.current.dataset.initialized||n!==vo.current)&&Or.current?.({components:e}),pt.current.dataset.initialized||(pt.current.dataset.initialized="true",pt.current.style.width="100%")),ar.current!==jo.current&&(Tr.current=null,Ot.current=null,jo.current=ar.current),o(ar.current,Tr,()=>{const[a,f]=Mn.spatialTree({components:e,models:Array.from(s.list.values())});Ot.current=f,a.style.width="100%",a.style.height="100%",a.style.overflow="auto";const w=a;return w.queryString=jt.trim()?jt.trim():null,a}),Ot.current&&Ot.current({components:e,models:Array.from(s.list.values())}),vo.current=n},[ye,te,jt,wr]),d.useEffect(()=>{if(!ye)return;const e=g.current,s=i.current,n=Ot.current;!e||!s||!n||n({components:e,models:Array.from(s.list.values())})},[ye,wr]),d.useEffect(()=>{const e=Tr.current;if(!e)return;const s=jt.trim();e.queryString=s||null},[jt]);const Rs=async()=>{const e=l.current,s=e?.files?.[0];if(!s)return;const n=s.name.split(".").pop()?.toLowerCase(),o=i.current,a=h.current,f=c.current;if(!o||!f){alert("Viewer is still initializing. Please try again in a moment."),e&&(e.value="");return}const w=bt(),m=w?.three??null,u=w?.controls??null;let I=!1;try{const C=`${s.name}-${Date.now()}`;let A;if(n==="ifc"){if(!a)throw new Error("IFC importer is not ready.");console.log("ðŸ”§ Starting IFC conversion:",s.name),ot(0),I=!0,nt.current=!1,Ke(!1);const D=new AbortController;Lt.current=D;const _=new Uint8Array(await s.arrayBuffer());console.log("ðŸ”§ IFC file size:",_.byteLength,"bytes");const O=await a.process({bytes:_,progressCallback:(L,B)=>{if(nt.current)return;const K=typeof L=="number"?L:0,Z=K<=1?K*100:K,W=Math.max(0,Math.min(100,Z));ot(Number(W.toFixed(1)))},signal:D.signal});if(console.log("ðŸ”§ IFC conversion complete"),nt.current)throw{__cancelled:!0};let N;if(O instanceof ArrayBuffer){const L=new Uint8Array(O),B=new Uint8Array(L.byteLength);B.set(L),N=B.buffer}else if(O instanceof Uint8Array){const L=new Uint8Array(O.byteLength);L.set(O),N=L.buffer}else{const L=O,B=new Uint8Array(L),K=new Uint8Array(B.byteLength);K.set(B),N=K.buffer}A=await o.core.load(N,{modelId:C})}else if(n==="frag"){const D=await s.arrayBuffer();A=await o.core.load(D,{modelId:C})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}p.current=C,m?A.useCamera(m):console.warn("World camera not ready; skipping model camera binding."),f.scene.three.add(A.object),await o.core.update(!0);const R=be.current;if(R)try{R.enabled=!0,typeof R.update=="function"&&R.update(),typeof R.create=="function"&&(R.list?.has("select")||R.create("select"))}catch(D){console.warn("Failed to update highlighter after load:",D)}await new Promise(D=>requestAnimationFrame(()=>D()));const S=new dt().setFromObject(A.object),x=new ee;S.getCenter(x),(Math.abs(x.x)>1e6||Math.abs(x.y)>1e6||Math.abs(x.z)>1e6)&&(console.log("âš ï¸  Model is georeferenced (far from origin), recentering..."),A.object.position.sub(x),console.log("  - New position:",A.object.position.x.toFixed(3),A.object.position.y.toFixed(3),A.object.position.z.toFixed(3)));try{u&&await u.fitToBox(A.object,!0)}catch{const D=new ee;S.getSize(D);const O=(Math.max(D.x,D.y,D.z)||10)*2.5;u?u.setLookAt(x.x+O,x.y+O,x.z+O,x.x,x.y,x.z,!0):m&&(m.position.set(x.x+O,x.y+O,x.z+O),m.lookAt(x))}ds(D=>({...D,[C]:jl(C,s.name,A.object)})),E(!0),V(D=>[...D,{id:C,label:s.name}]),at();const M=g.current;M&&Or.current?.({components:M}),I&&ot(100)}catch(C){C&&(C.__cancelled||C?.name==="AbortError")||(console.error(C),alert("Failed to load model. See console for more details.")),E(!1)}finally{e&&(e.value=""),I&&setTimeout(()=>ot(null),200),Lt.current=null,Ke(!1)}},Ms=d.useCallback(()=>{if(we!==null){nt.current=!0,Ke(!0);try{Lt.current?.abort()}catch{}ot(null)}},[we]),at=d.useCallback(()=>{J(!0),Y(!1)},[]),hn=d.useCallback(()=>{J(e=>{const s=!e;return s&&Y(!1),s})},[]),zs=d.useCallback(()=>{J(!1)},[]),Ds=d.useCallback(()=>{Y(e=>!e)},[]),mn=d.useMemo(()=>Math.min(360,Math.max(180,ir.height*.45)),[ir.height]),$s=+!Qn+ +!es,oo=!Zn&&$s===0;d.useEffect(()=>{const e=pt.current;e&&(e.style.width="100%",e.style.maxHeight=oo?"100%":`${mn}px`,e.style.height=oo?"100%":"auto")},[oo,mn,wr]);const Fs=d.useCallback(async e=>{const s=x=>{const M=[],D=new Set;if(!x||typeof x!="object")return{terms:M,modelIds:D};for(const[_,O]of Object.entries(x)){if(O==null)continue;const N=_.trim().toLowerCase(),L=Array.isArray(O)?O:[O];if(L.length){if(N==="modelid"||N==="modelids"||N==="model"){for(const B of L){const K=typeof B=="string"?B.trim():String(B??"").trim();K&&D.add(K)}continue}if(["text","query","keyword","search"].includes(N)){for(const B of L){if(B==null)continue;const K=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();K&&M.push({type:"text",value:K})}continue}for(const B of L){if(B==null)continue;let K=null;typeof B=="string"?K=B.trim():(typeof B=="number"||typeof B=="boolean")&&(K=String(B)),K&&M.push({type:"field",key:N,value:K.toLowerCase()})}}}return{terms:M,modelIds:D}},n=i.current;if(!n){console.warn("AI selection requested but fragments are unavailable.");return}if(!b.current){console.warn("AI selection requested before fragments were fully initialized.");return}const o=be.current,a=Ae.current,{terms:f,modelIds:w}=s(e.filter),m=e.mode?.toLowerCase?.(),u=m==="isolate"||m==="focus";if(e.action==="clear"){try{o?.clear?.()}catch{}if(a)try{await a.set(!0)}catch(x){console.warn("Failed to reset visibility while clearing AI selection",x)}try{const x=Xe.current;if(x&&x.mesh&&x.mesh.instanceColor){const M=new Oe(1,1,1);x.mesh.setColorAt(x.index,M),x.mesh.instanceColor.needsUpdate=!0}}catch{}Xe.current=null,Fe.current&&(Fe.current.visible=!1),$([]),Ce(null);return}if(f.length===0){console.warn("AI selection command did not include usable filters",e);return}const I=++or.current,C=[],A=60;for(const x of n.list.values()){const M=typeof x?.modelId=="string"?x.modelId:"";if(w.size&&!w.has(M))continue;let D=[];try{const O=await x.getLocalIds();Array.isArray(O)?D=O.slice():O&&typeof O[Symbol.iterator]=="function"&&(D=Array.from(O))}catch(O){console.warn("Failed to fetch local IDs for model",M,O)}const _={model:x,modelId:M,allIds:D,matched:new Set};if(C.push(_),!!D.length)for(let O=0;O<D.length;O+=A){if(I!==or.current)return;const N=D.slice(O,O+A);let L=[];try{L=await x.getItemsData(N,Pe)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}N.forEach((B,K)=>{const Z=L?.[K];if(!Z)return;let W=[];try{W=Mr(Z).rows}catch(ae){console.warn("Failed to build property rows for AI selection",ae)}const pe=W.map(ae=>ae.searchText),ue=Bn(Z,6e3).toLowerCase();f.every(ae=>{if(ae.type==="text")return pe.some(ve=>ve.includes(ae.value))||ue.includes(ae.value);const Me=Cl[ae.key]??[ae.key];return pe.some(ve=>Me.some(He=>ve.includes(He))&&ve.includes(ae.value))?!0:Me.some(ve=>ue.includes(ve)&&ue.includes(ae.value))})&&_.matched.add(B)})}}if(I!==or.current)return;const R=C.filter(x=>x.matched.size>0);if(!R.length)return;try{const x=Xe.current;if(x&&x.mesh&&x.mesh.instanceColor){const M=new Oe(1,1,1);x.mesh.setColorAt(x.index,M),x.mesh.instanceColor.needsUpdate=!0}}catch{}if(Xe.current=null,Fe.current&&(Fe.current.visible=!1),a)try{await a.set(!0)}catch(x){console.warn("Failed to reset hidden state before AI selection",x)}if(o){try{o.clear?.()}catch{}const x=u?16754240:6737151;for(const M of R){const D=Array.from(M.matched);if(D.length)try{typeof o.highlightById=="function"?await o.highlightById(M.model,D,x):typeof o.highlightByID=="function"?await o.highlightByID(M.model,D,x):typeof o.add=="function"&&o.add(M.model,D,x)}catch(_){console.warn("Failed to apply AI highlight for model",M.modelId,_)}}}if(u&&a){const x={};for(const M of C){if(!M.allIds.length||M.matched.size===M.allIds.length)continue;const D=M.allIds.filter(_=>!M.matched.has(_));D.length&&(x[M.modelId]=new Set(D))}if(Object.keys(x).length)try{await a.set(!1,x)}catch(M){console.warn("Failed to isolate AI-selected elements",M)}}const S=R.flatMap(x=>Array.from(x.matched).map(M=>({modelId:x.modelId,localId:M})));$(S),at();try{const x=R[0],M=Array.from(x.matched)[0];if(M!==void 0){const[D]=await x.model.getItemsData([M],Pe);I===or.current&&Ce(D||null)}}catch(x){console.warn("Failed to fetch properties for AI selection result",x)}},[at,$,Ce]),Sr=d.useCallback(e=>{if(!lr.current)return;const s=Nr.current;if(!s)return;const n=e.clientX-s.startX,o=e.clientY-s.startY,a=280,f=260;Kn(w=>{const m=s.width,u=s.height,I=Math.max(a,m+n),C=Math.max(f,u+o);return I===w.width&&C===w.height?w:{width:Math.round(I),height:Math.round(C)}})},[]),Kt=d.useCallback(()=>{lr.current&&(lr.current=!1,Nr.current=null,window.removeEventListener("pointermove",Sr),window.removeEventListener("pointerup",Kt))},[Sr]),Ns=d.useCallback(e=>{e.preventDefault(),e.stopPropagation();const s=Lr.current;s&&(lr.current=!0,Nr.current={startX:e.clientX,startY:e.clientY,width:s.offsetWidth,height:s.offsetHeight},window.addEventListener("pointermove",Sr),window.addEventListener("pointerup",Kt))},[Sr,Kt]);d.useEffect(()=>()=>{Kt()},[Kt]),d.useEffect(()=>{Ne&&(ft.getInstance().setViewerApi(Ne),ft.getInstance().indexModel())},[Ne]);const Ls=d.useCallback(async e=>{const s=i.current,n=[];if(!s||s.list.size===0||P.length===0)n.push("No models are currently loaded in the viewer.");else{try{const a=await ft.getInstance().generateContext(e||"");n.push(a),n.push("---")}catch(a){console.warn("AI Engine not ready",a)}n.push(`Loaded models (${P.length}): ${P.map(a=>`${a.label} [${a.id}]`).join(", ")}`),n.push(`Fragments models in memory: ${s.list.size}`);try{const a=new dt;for(const w of s.list.values())a.expandByObject(w.object);const f=new ee;a.getSize(f),n.push(`Scene bounds approx size => x:${f.x.toFixed(2)} y:${f.y.toFixed(2)} z:${f.z.toFixed(2)}`)}catch(a){console.warn("Failed to compute bounds for AI context",a)}const o=P.map(a=>_o[a.id]).filter(a=>!!a);if(o.length){let a=0;const f=new Map;n.push("Model geometry snapshots:");for(const m of o){a+=m.elementCount;for(const{category:I,count:C}of m.categoryCounts)f.set(I,(f.get(I)??0)+C);const u=m.categoryCounts.slice(0,5).map(({category:I,count:C})=>`${I}: ${C}`);n.push(`- ${m.label} [${m.modelId}] â†’ elementsâ‰ˆ${m.elementCount}, instancedâ‰ˆ${m.instancedCount}, meshesâ‰ˆ${m.meshCount}`),u.length&&n.push(`  top categories: ${u.join(" | ")}`),n.push(`  bbox size (approx): x:${m.bboxSize.x.toFixed(2)} y:${m.bboxSize.y.toFixed(2)} z:${m.bboxSize.z.toFixed(2)}`)}const w=Array.from(f.entries()).sort((m,u)=>u[1]-m[1]).slice(0,10).map(([m,u])=>`${m}: ${u}`);n.push(`Global approx element total: ${a}`),w.length&&n.push(`Global top categories: ${w.join(" | ")}`)}else n.push("Geometry summaries are initializing â€” load a model or wait a moment after loading.")}if(k.length){n.push(`Active selection count: ${k.length}`);for(let o=0;o<k.length;o+=1){const a=k[o];n.push(`Selection #${o+1} â†’ modelId:${a.modelId}, localId:${a.localId}`);let f=null;if(o===0&&q&&Object.keys(q).length)f=q;else if(s){const w=s.list.get(a.modelId);if(w)try{const[m]=await w.getItemsData([a.localId],Pe);f=m||null}catch(m){console.warn("Failed to fetch properties for AI context (multi)",m)}}if(f){n.push("  Property snapshot (compact JSON):"),n.push(`  ${Bn(f,4e3)}`);const w=Mr(f).rows;if(w.length){n.push(`  Flattened properties (${w.length} entries):`);for(const m of w.slice(0,120))n.push(`  - ${m.label}: ${m.value}`);w.length>120&&n.push(`  (Truncated ${w.length-120} additional properties)`)}}else n.push("  Properties for this selection are not available yet.")}}if(Gt.length){n.push("ItemsData extracted name/value pairs (last selection):");const o=150,a=Gt.slice(0,o);for(const f of a)n.push(`- ${f.path}: ${f.value}`);Gt.length>o&&n.push(`(Truncated ${Gt.length-o} additional rows)`)}return Wr&&(n.push("ItemsData table snapshot for last selection (tab-separated):"),n.push(Wr)),n.length===0&&n.push("Viewer is idle: no models or selections to describe."),n.join(`
`)},[P,k,q,le,_o,Wr,Gt]),Os=d.useCallback(async()=>{const e=c.current,s=i.current,n=p.current;if(!e||!s||!n||!b.current)return;const o=s.list.get(n);if(!o)return;await s.core.update(!0),await new Promise(w=>requestAnimationFrame(()=>w()));const a=o.object,f=new dt().setFromObject(a);if(!f.isEmpty()){const w=bt(),m=w?.controls??null,u=w?.three??null;try{m&&await m.fitToBox(a,!0)}catch{const C=new ee,A=new ee;f.getCenter(C),f.getSize(A);const S=(Math.max(A.x,A.y,A.z)||10)*2.5;m?m.setLookAt(C.x+S,C.y+S,C.z+S,C.x,C.y,C.z,!0):u&&(u.position.set(C.x+S,C.y+S,C.z+S),u.lookAt(C))}}},[]),Ts=d.useCallback(async()=>{const e=Je.current,s=Ae.current;if(!e||e.length===0||!s||!b.current){Re(null);return}const n={};for(const o of e)n[o.modelId]||(n[o.modelId]=new Set),n[o.modelId].add(o.localId);try{await s.set(!1,n);try{be.current?.clear?.()}catch{}$([]),Ce(null)}catch(o){console.warn("Failed to hide selected element",o)}finally{Re(null)}},[Re,$,Ce]),Vs=d.useCallback(async()=>{const e=Ae.current;if(!e||!b.current){Re(null);return}try{await e.set(!0)}catch(s){console.warn("Failed to reset hidden items",s)}finally{Re(null)}},[Re]),_s=d.useCallback(()=>{Re(null)},[Re]);d.useEffect(()=>{const e=r.current,s=c.current;if(!e||!s)return;const n=s.renderer?.three.domElement;if(!n)return;const o=new mo,a=async(S,x,M,D)=>{const _=i.current;if(!_){console.warn("âŒ No fragments manager");return}const O=Xr();if(!O){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const N=n.getBoundingClientRect();new zn;const L=new Map,B=10,K=M-S,Z=D-x;console.log(`Rectangle selection: ${Math.round(K)}x${Math.round(Z)} pixels, models: ${_.list.size}`),console.log(`Filter ghost mode active: ${Qe.current}`);let W=0;for(const ze of _.list.values())try{const re=await ze.getLocalIds(),Ue=Array.isArray(re)?re.length:re&&typeof re[Symbol.iterator]=="function"?Array.from(re).length:0;W+=Ue}catch(re){console.debug("Failed to get object count for model:",re)}if(console.log(`Total objects in models: ${W}`),K<3||Z<3){await f((S+M)/2,(x+D)/2);return}let pe=0,ue=0,We=0;const ae=(S+M)/2,Me=(x+D)/2,Yt=(ae-N.left)/N.width*2-1,ve=-((Me-N.top)/N.height)*2+1;console.log(`Testing center point: screen=(${Math.round(ae)}, ${Math.round(Me)}), NDC=(${Yt.toFixed(3)}, ${ve.toFixed(3)})`);for(const ze of _.list.values())try{const re=await ze.raycast({camera:O,mouse:new mo(Yt,ve),dom:n});re&&typeof re.distance=="number"?console.log(`âœ“ Center point HIT! distance=${re.distance.toFixed(2)}, localId=${re.localId}`):console.log(`âœ— Center point MISS (hit=${!!re})`)}catch(re){console.log("âœ— Center point ERROR:",re)}let He=!0;for(let ze=S;ze<=M;ze+=B)for(let re=x;re<=D;re+=B){pe++;const Ue=(ze-N.left)/N.width*2-1,gn=-((re-N.top)/N.height)*2+1;o.set(Ue,gn);for(const jr of _.list.values())try{const vr=new mo(Ue,gn),lo=await jr.raycast({camera:O,mouse:vr,dom:n});if(lo&&typeof lo.distance=="number"){ue++;const kr=lo.localId;kr!=null&&Number.isInteger(kr)&&(L.has(jr.modelId)||L.set(jr.modelId,new Set),L.get(jr.modelId).add(kr))}}catch(vr){We++,He&&console.warn("âŒ Raycast error on first sample:",vr),console.debug("Skipping model due to raycast error:",vr)}He&&(He=!1)}const Le=[];for(const[ze,re]of L.entries())for(const Ue of re)Le.push({modelId:ze,localId:Ue});if(Le.length===0){console.warn(`âš ï¸ No objects found in rectangle (sampled ${pe} points, ${ue} hits, ${We} errors)`),console.log(`Rectangle bounds: left=${Math.round(S)}, top=${Math.round(x)}, right=${Math.round(M)}, bottom=${Math.round(D)}`),console.log(`Canvas rect: ${Math.round(N.left)}, ${Math.round(N.top)}, ${Math.round(N.width)}x${Math.round(N.height)}`),$([]),Ce(null);return}console.log(`âœ“ Rectangle selection found ${Le.length} objects from ${ue} hits`);const io=Je.current;if(!bo(Le,io)&&($(Le),at(),Le.length>0)){const ze=Le[0],re=_.list.get(ze.modelId);if(re)try{const[Ue]=await re.getItemsData([ze.localId],Pe);Ce(Ue||null)}catch(Ue){console.warn("Failed to fetch properties for rectangle selection",Ue)}}},f=async(S,x)=>{const M=i.current;if(!M)return;const D=Xr();if(!D){console.warn("Picking skipped: viewer camera not ready.");return}const _=n.getBoundingClientRect();o.x=(S-_.left)/_.width*2-1,o.y=-((x-_.top)/_.height)*2+1;let O=null;const N=new zn;N.setFromCamera(o,D);for(const Z of M.list.values())try{const W=await Z.raycast({camera:D,mouse:o,dom:s.renderer.three.domElement});if(W&&typeof W.distance=="number"){const pe=W.point instanceof ee?W.point.clone():N.ray.at(W.distance,new ee);(!O||W.distance<O.dist)&&(O={dist:W.distance,model:Z,localId:W.localId,point:pe,object:W.object,instanceId:W.instanceId})}}catch{}if(!O)return;const L=be.current;if(L&&L.enabled!==!1)try{typeof L.clear=="function"&&!fr.current&&!Qe.current&&L.clear();const Z=6737151,W=L.selection&&L.selection.select;if(!L.onBeforeHighlight||!W)return;typeof L.highlightByID=="function"?await L.highlightByID(O.model.uuid,[O.localId],Z):typeof L.add=="function"?L.add(O.model.uuid,[O.localId]):typeof L.highlight=="function"&&await L.highlight(O.model,[O.localId],Z)}catch(Z){console.warn("Highlighter failed, using fallback:",Z);try{const W=O.object,pe=O.instanceId;if(W&&W.isInstancedMesh&&Number.isInteger(pe)){const ue=Xe.current;if(ue&&ue.mesh&&ue.mesh.instanceColor){const Me=new Oe(1,1,1);try{ue.mesh.setColorAt(ue.index,Me),ue.mesh.instanceColor.needsUpdate=!0}catch{}}const We=W,ae=new Oe(6737151);try{We.setColorAt(pe,ae),We.instanceColor.needsUpdate=!0}catch{}Xe.current={mesh:We,index:pe}}}catch{}}try{const Z=O.point??new ee;let W=Fe.current;if(!W){W=new Ni;const We=new dt,ae=i.current;if(ae&&ae.list.size)for(const io of ae.list.values())We.expandByObject(io.object);const Me=new Li;We.getBoundingSphere(Me);const Yt=isFinite(Me.radius)&&Me.radius>0?Me.radius*.01:.3,ve=Math.max(.05,Math.min(2,Yt)),He=new Dn(new Oi(ve*.5,16,16),new $n({color:16763904,depthTest:!1})),Le=new Dn(new Ti(ve*.8,ve,32),new $n({color:16772744,side:Vi,depthTest:!1,transparent:!0,opacity:.9}));Le.rotation.x=Math.PI/2,He.renderOrder=999,Le.renderOrder=999,W.add(He),W.add(Le),s.scene.three.add(W),Fe.current=W}W.position.copy(Z);const pe=W.children[1],ue=Xr();ue&&pe.lookAt(ue.position),W.visible=!0}catch{}const B=Je.current,K=[{modelId:O.model.modelId,localId:O.localId}];if(!bo(K,B)){$(K),at();try{const[Z]=await O.model.getItemsData([O.localId],Pe);Ce(Z||null)}catch{}}},w=async S=>{if(Re(null),S.button===0)if(Fr.current==="rectangle"&&!Ut.current){if(sr.current=!0,St.current={x:S.clientX,y:S.clientY},!Te.current){const M=document.createElement("div");M.style.position="fixed",M.style.border="2px solid #1976d2",M.style.backgroundColor="rgba(25, 118, 210, 0.1)",M.style.pointerEvents="none",M.style.zIndex="10000",document.body.appendChild(M),Te.current=M}const x=Te.current;x.style.left=`${S.clientX}px`,x.style.top=`${S.clientY}px`,x.style.width="0px",x.style.height="0px",x.style.display="block"}else await f(S.clientX,S.clientY)},m=S=>{if(!sr.current||!St.current||!Te.current)return;const x=St.current,M=Te.current,D=Math.min(S.clientX,x.x),_=Math.min(S.clientY,x.y),O=Math.abs(S.clientX-x.x),N=Math.abs(S.clientY-x.y);M.style.left=`${D}px`,M.style.top=`${_}px`,M.style.width=`${O}px`,M.style.height=`${N}px`},u=async S=>{if(sr.current&&St.current&&Te.current){const x=St.current,M=Te.current;M.style.display="none",sr.current=!1;const D=Math.min(S.clientX,x.x),_=Math.min(S.clientY,x.y),O=Math.max(S.clientX,x.x),N=Math.max(S.clientY,x.y);await a(D,_,O,N),St.current=null}},I=async S=>{Re(null),!Ut.current&&Fr.current==="click"&&await f(S.clientX,S.clientY)},C=()=>{if(Ut.current){const S=yr.current;S&&typeof S.create=="function"&&S.create()}},A=S=>{S.preventDefault();const x=Je.current;if(!x||x.length===0){Re(null);return}Re({mouseX:S.clientX+2,mouseY:S.clientY-6})},R=S=>{if(Ut.current&&(S.code==="Delete"||S.code==="Backspace")){const x=yr.current;x&&typeof x.delete=="function"&&x.delete()}};return n.addEventListener("pointerdown",w,{capture:!0}),n.addEventListener("pointermove",m),n.addEventListener("pointerup",u),n.addEventListener("click",I),n.addEventListener("dblclick",C),n.addEventListener("contextmenu",A),window.addEventListener("keydown",R),()=>{n.removeEventListener("pointerdown",w,{capture:!0}),n.removeEventListener("pointermove",m),n.removeEventListener("pointerup",u),n.removeEventListener("click",I),n.removeEventListener("dblclick",C),n.removeEventListener("contextmenu",A),window.removeEventListener("keydown",R),Te.current&&(Te.current.remove(),Te.current=null);try{const S=Fe.current;S&&(s.scene.three.remove(S),S.traverse(x=>{if(x.geometry&&x.geometry.dispose?.(),x.material){const M=Array.isArray(x.material)?x.material:[x.material];for(const D of M)D?.dispose?.()}}),Fe.current=null)}catch{}try{const S=Xe.current;if(S&&S.mesh&&S.mesh.instanceColor){const x=new Oe(1,1,1);S.mesh.setColorAt(S.index,x),S.mesh.instanceColor.needsUpdate=!0}Xe.current=null}catch{}}},[]);const Bs=d.useCallback(()=>{c.current;const e=bt(),s=e?.controls??null,n=e?.three??null;s?s.reset(!0):n&&(n.position.set(10,10,10),n.lookAt(0,0,0))},[]),no=d.useCallback(e=>{gr(s=>{const n={...s,[e]:!s[e]},o=c.current;if(!o)return n;const a=o.renderer?.three,f=o.scene?.three;if(!a||!f)return n;const w=[],m=Yr.current;if(!n[e]){const u=m.get(e);u&&(f.remove(u),u.dispose(),m.delete(e))}if(n.x){const u=new zt(new ee(1,0,0),Ge.x);if(w.push(u),!m.has("x")){const I=new go(u,10,16711680);f.add(I),m.set("x",I)}}if(n.y){const u=new zt(new ee(0,1,0),Ge.y);if(w.push(u),!m.has("y")){const I=new go(u,10,65280);f.add(I),m.set("y",I)}}if(n.z){const u=new zt(new ee(0,0,1),Ge.z);if(w.push(u),!m.has("z")){const I=new go(u,10,255);f.add(I),m.set("z",I)}}return a.clippingPlanes=w,a.localClippingEnabled=w.length>0,Kr.current=w,n})},[Ge]),so=d.useCallback((e,s)=>{Yo(n=>{const o={...n,[e]:s};return requestAnimationFrame(()=>{const f=c.current;if(!f)return;const w=f.renderer?.three;if(!w)return;const m=[],u=Yr.current;if(ne.x){const I=new zt(new ee(1,0,0),o.x);m.push(I);const C=u.get("x");C&&(C.plane.constant=o.x)}if(ne.y){const I=new zt(new ee(0,1,0),o.y);m.push(I);const C=u.get("y");C&&(C.plane.constant=o.y)}if(ne.z){const I=new zt(new ee(0,0,1),o.z);m.push(I);const C=u.get("z");C&&(C.plane.constant=o.z)}w.clippingPlanes=m,Kr.current=m}),o})},[ne]),Gs=d.useCallback(()=>{Xo(e=>{const s=!e;return gr(s?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),s})},[]),Ws=d.useCallback(()=>{ms(e=>{const s=!e;Ut.current=s;const n=yr.current;if(n){if(n.enabled=s,!s)try{n.list&&typeof n.list.clear=="function"&&n.list.clear(),Zo(null)}catch(o){console.warn("Failed to clear measurements:",o)}}else console.warn("âš ï¸ Measurement tool not initialized!");return s})},[]),Hs=d.useCallback(()=>{Lo(e=>{const s=!e;fr.current=s;const n=i.current,o=be.current,a=as.current;if(!n)return e;try{if(s){if(!o)return e;const f=o.selection?.select||{};Oo.current=f,o.enabled=!1;const w=[...n.core.models.materials.list.values()];for(const m of w){if(m.userData.customId)continue;let u;"color"in m?u=m.color.getHex():u=m.lodColor.getHex(),a.set(m,{color:u,transparent:m.transparent,opacity:m.opacity}),m.transparent=!0,m.opacity=.05,m.needsUpdate=!0,"color"in m?m.color.setColorName("white"):m.lodColor.setColorName("white")}if(Object.keys(f).length>0)try{n.highlight({customId:"ghost-selected",color:new Oe(16750592),renderedFaces:1,opacity:1,transparent:!1},f)}catch(m){console.warn("Failed to apply ghost highlight:",m)}n.core.update(!0)}else{for(const[f,w]of a){const{color:m,transparent:u,opacity:I}=w;f.transparent=u,f.opacity=I,"color"in f?f.color.setHex(m):f.lodColor.setHex(m),f.needsUpdate=!0}a.clear(),o&&(o.enabled=!0),Oo.current=null,n.resetHighlight(),n.core.update(!0)}}catch(f){return console.warn("Failed to toggle ghost mode:",f),e}return s})},[]),Us=d.useCallback(()=>{ls(e=>{const s=!e,n=Ae.current,o=be.current;if(!n)return console.warn("âš ï¸ Hider not available for isolate mode"),e;try{if(s){const a=o?.selection?.select||{},f={};for(const[w,m]of Object.entries(a))m&&typeof m.size=="number"&&m.size>0&&(f[w]=m);if(Object.keys(f).length>0)n.isolate(f);else return console.warn("âš ï¸ No selection to isolate"),e}else n.set(!0)}catch(a){return console.warn("Failed to toggle isolate mode:",a),e}return s})},[]),qs=d.useCallback(async()=>{const e=i.current,s=be.current,n=Ae.current;if(!e||!b.current){console.warn("Fragments not ready");return}if(!s){console.warn("Highlighter not available");return}try{let o={},a=0;const f=Qe.current,w=Et.current!==null;if(console.log(`Filter state: ghostMode=${f}, hasSelection=${w}`),f&&w){if(o=Et.current,a=Object.values(o).reduce((C,A)=>C+A.size,0),a===0){console.warn("No filtered objects found. Try using the Model Filter first.");return}console.log(`Selecting ${a} filtered objects (ghost mode)`)}else if(n&&n.list&&n.list.size>0){console.log(`Checking for hidden objects in ${e.list.size} models`);for(const[C,A]of e.list)try{let R=[];const S=await A.getLocalIds();if(Array.isArray(S)?R=S:S&&typeof S[Symbol.iterator]=="function"&&(R=Array.from(S)),R.length===0)continue;const x=n.list?.get?.(C),M=x&&x.size>0?x:new Set,D=R.filter(_=>!M.has(_));D.length>0&&(o[C]=new Set(D),a+=D.length),console.log(`Model ${C}: ${D.length} visible of ${R.length} total (${M.size} hidden)`)}catch(R){console.error("Failed to get IDs for model",C,R)}if(a===0){console.warn("No visible objects found (all are hidden)");return}console.log(`Selecting ${a} visible objects (isolate/hide mode)`)}else{for(const[C,A]of e.list)try{let R=[];const S=await A.getLocalIds();if(Array.isArray(S)?R=S:S&&typeof S[Symbol.iterator]=="function"&&(R=Array.from(S)),R.length===0)continue;let x=new Set;if(n)try{const D=n.list?.get?.(C);D&&D.size>0&&(x=D)}catch(D){console.debug("Could not get hidden IDs for model",C,D)}const M=R.filter(D=>!x.has(D));M.length>0&&(o[C]=new Set(M),a+=M.length)}catch(R){console.error("Failed to get IDs for model",C,R)}if(a===0){console.warn("No visible objects found");return}console.log(`Selecting ${a} visible objects`)}if(!Qe.current&&typeof s.clear=="function")try{s.clear()}catch(C){console.debug("Failed to clear highlighter:",C)}let m=0,u=0;for(const[C,A]of Object.entries(o))try{if(s.selection&&s.selection.select){s.selection.select[C]||(s.selection.select[C]=new Set);const R=s.selection.select[C];A.forEach(S=>R.add(S)),m++}else u++}catch(R){console.debug("Failed to add objects to selection for model",C,R),u++}if(s.events&&s.events.select)try{const C=s.events.select;if(C.onHighlight&&typeof C.onHighlight.trigger=="function"){const A={};for(const[R,S]of Object.entries(o))A[R]=S;C.onHighlight.trigger(A)}}catch(C){console.debug("Failed to trigger highlight event:",C)}const I=[];for(const[C,A]of Object.entries(o))A.forEach(R=>{I.push({modelId:C,localId:R})});$(I),at(),u>0?console.log(`âœ“ Selected ${a} visible objects (${m} models highlighted, ${u} failed)`):console.log(`âœ“ Selected ${a} visible objects from ${m} models`)}catch(o){console.error("Failed to select visible objects:",o)}},[$,at]),Ks=d.useCallback(()=>{gr({x:!1,y:!1,z:!1}),Yo({x:0,y:0,z:0}),Xo(!1);const e=c.current;if(e){const s=e.renderer?.three,n=e.scene?.three;if(s&&(s.clippingPlanes=[],s.localClippingEnabled=!1),n){const o=Yr.current;o.forEach(a=>{n.remove(a),a.dispose()}),o.clear()}}Kr.current=[]},[]),xt=d.useCallback(e=>{const s=c.current,n=i.current,o=p.current,a=bt(),f=a?.three;if(!f||!s||!n||!o)return;const w=n.list.get(o);if(!w)return;const m=new dt().setFromObject(w.object);if(m.isEmpty())return;const u=new ee,I=new ee;m.getCenter(u),m.getSize(I);const A=Math.max(I.x,I.y,I.z)*2||20;let R;switch(e){case"top":R=new ee(u.x,u.y,u.z+A);break;case"bottom":R=new ee(u.x,u.y,u.z-A);break;case"front":R=new ee(u.x,u.y+A,u.z);break;case"back":R=new ee(u.x,u.y-A,u.z);break;case"left":R=new ee(u.x-A,u.y,u.z);break;case"right":R=new ee(u.x+A,u.y,u.z);break;case"iso":R=new ee(u.x+A*.7,u.y+A*.7,u.z+A*.7);break;default:return}const S=a?.controls;S&&typeof S.setLookAt=="function"?S.setLookAt(R.x,R.y,R.z,u.x,u.y,u.z,!0):(f.position.copy(R),f.lookAt(u),f.updateProjectionMatrix())},[]);return t.jsxs("div",{style:{width:"100%",height:"100%"},children:[t.jsx(ei,{position:"static",children:t.jsxs(ti,{children:[t.jsx(G,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:t.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(G,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:t.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),t.jsx(H,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),t.jsx(Q,{title:"Settings",children:t.jsx(X,{color:"inherit",onClick:un,sx:{mr:1},children:t.jsx(ri,{})})}),t.jsx(Q,{title:"About",children:t.jsx(X,{color:"inherit",onClick:Cs,sx:{mr:1},children:t.jsx(oi,{})})}),t.jsx(ie,{color:"inherit",onClick:hn,startIcon:t.jsx(yn,{}),"aria-pressed":te,sx:{mr:1,borderRadius:1.5,backgroundColor:te?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:te?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:te?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),t.jsx(ie,{color:"inherit",onClick:cn,startIcon:t.jsx(bn,{}),"aria-pressed":_e,sx:{mr:1,borderRadius:1.5,backgroundColor:_e?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:_e?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:_e?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),t.jsx(ie,{color:"inherit",onClick:pn,startIcon:t.jsx(xn,{}),"aria-pressed":Be,sx:{mr:1,borderRadius:1.5,backgroundColor:Be?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Be?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Be?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),t.jsx(ie,{color:"inherit",onClick:an,startIcon:t.jsx(wn,{}),"aria-pressed":st,sx:{mr:1,borderRadius:1.5,backgroundColor:st?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:st?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:st?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),t.jsx("div",{ref:r,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:we!==null&&t.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:t.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[t.jsx(H,{variant:"subtitle1",sx:{mb:1},children:"Converting IFCâ€¦"}),t.jsx(ni,{variant:"determinate",value:Math.max(0,Math.min(100,we)),sx:{height:10,borderRadius:1}}),t.jsxs(H,{variant:"caption",sx:{mt:1,display:"block"},children:[we.toFixed(1),"%"]}),t.jsx("div",{style:{marginTop:12},children:t.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:Ms,disabled:Nt,children:Nt?"Cancellingâ€¦":"Cancel"})})]})})}),te&&t.jsx(In,{nodeRef:Lr,handle:".explorer-header",bounds:"parent",children:t.jsxs(je,{ref:Lr,elevation:8,sx:{position:"fixed",top:120,right:30,width:ir.width,height:oe?"auto":ir.height,minWidth:280,minHeight:oe?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[t.jsxs(G,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[t.jsx(H,{variant:"subtitle1",children:"Model Explorer"}),t.jsxs(G,{children:[t.jsx(X,{size:"small",color:"inherit",onClick:Ds,title:oe?"Expand panel":"Minimize panel",children:oe?t.jsx(si,{}):t.jsx(Cn,{})}),t.jsx(X,{size:"small",color:"inherit",onClick:zs,title:"Close Model Explorer",children:t.jsx(Sn,{})})]})]}),!oe&&t.jsxs(G,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[t.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[t.jsx(ie,{variant:"contained",size:"small",onClick:()=>l.current?.click(),disabled:!ye,children:"Open IFC / FRAG"}),t.jsx(Q,{title:"Open parametric filter",children:t.jsx("span",{children:t.jsx(ie,{variant:"outlined",size:"small",onClick:()=>$e(!0),disabled:!ye,startIcon:t.jsx(ii,{}),children:"Filter"})})}),!1,t.jsx(H,{variant:"caption",color:"text.secondary"}),t.jsx("input",{ref:l,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:Rs})]}),t.jsxs(jn,{value:mt,onChange:(e,s)=>ts(s),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[t.jsx(Xt,{value:"models",label:"Models"}),t.jsx(Xt,{value:"properties",label:"Properties"}),t.jsx(Xt,{value:"tree",label:"Model Tree"})]}),t.jsx(G,{role:"tabpanel",hidden:mt!=="models",sx:{display:mt==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:t.jsx(G,{ref:So,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!ye&&t.jsx(H,{variant:"body2",color:"text.secondary",children:"Initializing componentsâ€¦"})})}),t.jsx(G,{role:"tabpanel",hidden:mt!=="properties",sx:{display:mt==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:t.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[t.jsxs(jn,{value:ht,onChange:(e,s)=>Eo(s),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[t.jsx(Xt,{value:"favorites",label:`Favourites (${Zr.length})`}),t.jsx(Xt,{value:"all",label:`All (${le.length})`})]}),t.jsxs(G,{role:"tabpanel",hidden:ht!=="favorites",sx:{display:ht==="favorites"?"flex":"none",flexDirection:"column",flex:ht==="favorites"?1:0,minHeight:0},children:[Zr.length?t.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:t.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Zr.map(eo)})}):t.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:t.jsx(H,{variant:"body2",color:"text.secondary",children:Ie.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Qr>0&&Ie.length>0&&t.jsx(Mt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Qr===1?"1 favourite property is not available for this selection.":`${Qr} favourite properties are not available for this selection.`})]}),t.jsxs(G,{role:"tabpanel",hidden:ht!=="all",sx:{display:ht==="all"?"flex":"none",flexDirection:"column",flex:ht==="all"?1:0,minHeight:0},children:[t.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[t.jsx(Jt,{size:"small",fullWidth:!0,value:ko,onChange:e=>Xn(e.target.value),placeholder:"Search propertiesâ€¦",disabled:!le.length}),t.jsx(Q,{title:"Copy raw element JSON",children:t.jsx("span",{children:t.jsx(X,{size:"small",onClick:bs,disabled:!q,color:"primary",children:t.jsx(li,{fontSize:"small"})})})}),t.jsx(Q,{title:"Export properties",children:t.jsx("span",{children:t.jsx(ie,{variant:"outlined",size:"small",startIcon:t.jsx(ai,{}),onClick:ys,disabled:!le.length&&!P.length,children:"Export"})})})]}),le.length?gs?en.length?t.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:t.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:en.map(eo)})}):t.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:t.jsx(H,{variant:"body2",color:"text.secondary",children:`No properties matched "${br}".`})}):t.jsxs(G,{sx:{position:"relative",flex:1,minHeight:200},children:[t.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Jr.map(eo)}),tn>0&&t.jsx(Mt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${Jr.length} properties. ${tn} more not shown.`})]}):t.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:t.jsx(H,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Setsâ€¦ breakdown."})})]})]})}),t.jsx(G,{role:"tabpanel",hidden:mt!=="tree",sx:{display:mt==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:t.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[t.jsx(Jt,{size:"small",fullWidth:!0,value:jt,onChange:e=>Jn(e.target.value),placeholder:"Search the model treeâ€¦",disabled:!P.length,sx:{flexShrink:0}}),t.jsxs(G,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[t.jsx(G,{ref:ar,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!ye||!P.length)&&t.jsx(G,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:t.jsx(H,{variant:"body2",color:"text.secondary",children:ye?"Load a model to populate the full model tree.":"Viewer is initializing the model treeâ€¦"})})]})]})})]}),t.jsx(G,{onPointerDown:Ns,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),t.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:te?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:t.jsx(X,{onClick:hn,title:te?"Close Model Explorer":"Open Model Explorer",sx:{color:te?"white":"inherit"},children:t.jsx(yn,{})})}),t.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:_e?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:t.jsx(X,{onClick:cn,title:_e?"Close AI Assistant":"Open AI Assistant",sx:{color:_e?"white":"inherit"},children:t.jsx(bn,{})})}),t.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Be?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:t.jsx(X,{onClick:pn,title:Be?"Close IDS Checker":"Open IDS Checker",sx:{color:Be?"white":"inherit"},children:t.jsx(xn,{})})}),t.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:st?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:t.jsx(X,{onClick:an,title:st?"Close IDS Creator":"Open IDS Creator",sx:{color:st?"white":"inherit"},children:t.jsx(wn,{})})}),At?t.jsx(In,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:t.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[t.jsxs(G,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[t.jsx(H,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),t.jsxs(G,{sx:{display:"flex",gap:.5},children:[t.jsx(X,{size:"small",onClick:()=>Ur(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:t.jsx(Cn,{fontSize:"small"})}),t.jsx(X,{size:"small",onClick:()=>Ur(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:t.jsx(Sn,{fontSize:"small"})})]})]}),t.jsxs(G,{sx:{p:1.5},children:[t.jsxs(G,{sx:{display:"flex",gap:.5},children:[t.jsx(Q,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Os,disabled:!y,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:t.jsx(vn,{fontSize:"small"})})}),t.jsx(Q,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Bs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:t.jsx(ci,{fontSize:"small"})})})]}),t.jsxs(G,{sx:{mt:.5},children:[t.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),t.jsxs(G,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[t.jsx(Q,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),t.jsx(Q,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),t.jsx(Q,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),t.jsx(Q,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),t.jsx(Q,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),t.jsx(Q,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:t.jsx(ie,{size:"small",onClick:()=>xt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),t.jsx(Q,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:t.jsxs(ie,{size:"small",onClick:()=>xt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[t.jsx(di,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),t.jsxs(G,{sx:{mt:.5},children:[t.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),t.jsxs(G,{sx:{display:"flex",gap:.5},children:[t.jsx(Q,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:()=>no("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:t.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),t.jsx(Q,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:()=>no("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:t.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),t.jsx(Q,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:()=>no("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:t.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&t.jsxs(G,{sx:{mt:1},children:[t.jsxs(H,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Ge.x.toFixed(1)]}),t.jsx(ao,{value:Ge.x,onChange:(e,s)=>so("x",s),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&t.jsxs(G,{sx:{mt:1},children:[t.jsxs(H,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Ge.y.toFixed(1)]}),t.jsx(ao,{value:Ge.y,onChange:(e,s)=>so("y",s),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&t.jsxs(G,{sx:{mt:1},children:[t.jsxs(H,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Ge.z.toFixed(1)]}),t.jsx(ao,{value:Ge.z,onChange:(e,s)=>so("z",s),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),t.jsxs(G,{sx:{display:"flex",gap:.5},children:[t.jsx(Q,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Gs,sx:{border:"2px solid",borderColor:Wt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Wt?"warning.main":"white",color:Wt?"white":"warning.dark","&:hover":{backgroundColor:Wt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:t.jsx(ui,{fontSize:"small"})})}),t.jsx(Q,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Ks,disabled:!ne.x&&!ne.y&&!ne.z&&!Wt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:t.jsx(fi,{fontSize:"small"})})})]}),t.jsxs(G,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[t.jsx(Q,{title:Ht?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Ws,sx:{border:"2px solid",borderColor:Ht?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ht?"success.main":"white",color:Ht?"white":"success.dark","&:hover":{backgroundColor:Ht?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:t.jsx(pi,{fontSize:"small"})})}),Jo&&t.jsxs(H,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Jo," units"]})]}),t.jsxs(G,{sx:{mt:.5},children:[t.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),t.jsxs(G,{sx:{display:"flex",gap:.5},children:[t.jsx(Q,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:()=>No("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:t.jsx(hi,{fontSize:"small"})})}),t.jsx(Q,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:()=>No("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:t.jsx(kn,{fontSize:"small"})})}),t.jsx(Q,{title:kt?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Hs,sx:{border:"2px solid",borderColor:kt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:kt?"warning.main":"white",color:kt?"white":"warning.dark","&:hover":{backgroundColor:kt?"warning.dark":"warning.light",borderColor:"warning.main",color:kt?"white":"warning.dark"}},children:t.jsx(Pn,{fontSize:"small"})})}),t.jsx(Q,{title:Pt?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:Us,sx:{border:"2px solid",borderColor:Pt?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Pt?"info.main":"white",color:Pt?"white":"info.dark","&:hover":{backgroundColor:Pt?"info.dark":"info.light",borderColor:"info.main",color:Pt?"white":"info.dark"}},children:t.jsx(En,{fontSize:"small"})})}),t.jsx(Q,{title:"Select all visible objects",PopperProps:{sx:{zIndex:9999}},children:t.jsx(X,{size:"small",onClick:qs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white",color:"success.main","&:hover":{backgroundColor:"success.light",borderColor:"success.main",color:"success.dark"}},children:t.jsx(kn,{fontSize:"small"})})})]}),xe==="rectangle"&&t.jsx(Mt,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]}),t.jsxs(G,{sx:{mt:.5},children:[t.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Grid Settings"}),t.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1},children:[t.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:t.jsx(Q,{title:yt?"Hide Grid":"Show Grid",children:t.jsx(X,{size:"small",onClick:()=>{const e=!yt;fs(e),et.current&&(et.current.visible=e)},sx:{border:"1px solid",borderColor:yt?"primary.main":"rgba(0,0,0,0.23)",bgcolor:yt?"primary.main":"white",color:yt?"white":"primary.main","&:hover":{bgcolor:yt?"primary.dark":"rgba(0,0,0,0.04)"}},children:yt?t.jsx(mi,{fontSize:"small"}):t.jsx(gi,{fontSize:"small"})})})}),t.jsxs(G,{sx:{px:1},children:[t.jsxs(H,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.7rem"},children:["Offset: ",qr.toFixed(2),"m"]}),t.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:t.jsx("input",{type:"range",min:"-5",max:"5",step:"0.1",value:qr,onChange:async e=>{const s=parseFloat(e.target.value);ps(s);const n=mr.find(o=>o.globalId===qo);if(n&&et.current&&i.current){let o=0;for(const[w,m]of i.current.list)if(typeof m.getCoordinates=="function")try{const u=await m.getCoordinates();if(Array.isArray(u)&&u.length>=2){o=u[1];break}}catch{}const a=n.originalElevation+o+s,f=et.current.three;f&&f.position&&(f.position.y=a)}},style:{width:"100%",cursor:"pointer"}})})]}),mr.length>0&&t.jsxs(co,{size:"small",fullWidth:!0,children:[t.jsx(yi,{id:"grid-level-select-label",sx:{fontSize:"0.75rem"},children:"Align to Level"}),t.jsx(bi,{labelId:"grid-level-select-label",value:qo,label:"Align to Level",onChange:async e=>{const s=e.target.value;Ko(s);const n=mr.find(o=>o.globalId===s);if(n&&et.current&&i.current){let o=0;for(const[w,m]of i.current.list)if(typeof m.getCoordinates=="function")try{const u=await m.getCoordinates();if(Array.isArray(u)&&u.length>=2){o=u[1];break}}catch{}const a=n.originalElevation+o+qr,f=et.current.three;f&&f.position&&(f.position.y=a)}},sx:{fontSize:"0.75rem",height:"32px",".MuiSelect-select":{py:.5}},children:mr.map(e=>t.jsxs(Pr,{value:e.globalId,sx:{fontSize:"0.75rem"},children:[e.name," (",e.elevation.toFixed(2),"m)"]},e.globalId))})]})]})]})]})," "]})}):null,t.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:At?"primary.main":"background.paper","&:hover":{bgcolor:At?"primary.dark":"action.hover"}},children:t.jsx(X,{onClick:()=>Ur(!At),title:At?"Close View Controls":"Open View Controls",sx:{color:At?"white":"action.active"},children:t.jsx(vn,{})})}),t.jsx(d.Suspense,{fallback:null,children:U&&t.jsx(Il,{open:U,onClose:()=>$e(!1),viewerApi:Vt.current??null})}),t.jsxs(uo,{open:ns,onClose:Ir,fullWidth:!0,maxWidth:"sm",children:[t.jsx(fo,{children:"Settings"}),t.jsx(po,{dividers:!0,children:t.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[t.jsxs(co,{component:"fieldset",children:[t.jsx(An,{component:"legend",sx:{mb:1},children:"AI Provider"}),t.jsxs(Rn,{value:me,onChange:e=>js(e.target.value),children:[t.jsx(Zt,{value:"gemini",control:t.jsx(Qt,{}),label:"Google Gemini"}),t.jsx(Zt,{value:"openai",control:t.jsx(Qt,{}),label:"OpenAI (ChatGPT)"}),t.jsx(Zt,{value:"disabled",control:t.jsx(Qt,{}),label:"Disabled (No AI)"})]})]}),me!=="disabled"&&t.jsxs(t.Fragment,{children:[t.jsx(Jt,{label:"API Key",type:Br?"text":"password",value:Ze,onChange:e=>_r(e.target.value),fullWidth:!0,placeholder:`Enter your ${me==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:t.jsx(X,{onClick:()=>zo(!Br),edge:"end",size:"small",children:Br?t.jsx(Pn,{}):t.jsx(En,{})})},helperText:me==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),t.jsx(Jt,{select:!0,label:"Model",value:Bt,onChange:e=>ur(e.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:Ki(me).map(e=>t.jsx("option",{value:e,children:e},e))}),t.jsxs(G,{sx:{display:"flex",gap:1,alignItems:"center"},children:[t.jsx(ie,{variant:"outlined",onClick:vs,disabled:!Ze||Do,size:"small",children:Do?"Testing...":"Test Connection"}),Fo==="success"&&t.jsx(H,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ“ Connection successful"}),Fo==="error"&&t.jsx(H,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ— Connection failed"})]}),t.jsx(Mt,{severity:"info",variant:"outlined",children:t.jsxs(H,{variant:"body2",children:[t.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",me==="gemini"?"Google":"OpenAI","."]})})]})]})}),t.jsxs(ho,{children:[t.jsx(ie,{onClick:Ir,children:"Cancel"}),t.jsx(ie,{onClick:Ss,variant:"contained",color:"primary",disabled:me!=="disabled"&&!Ze,children:"Save"})]})]}),t.jsxs(uo,{open:os,onClose:dn,fullWidth:!0,maxWidth:"md",children:[t.jsx(fo,{children:"About Savora Viewer"}),t.jsxs(po,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[t.jsx(H,{variant:"h6",gutterBottom:!0,children:"Version 0.2.3 Preview"}),t.jsxs(H,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",t.jsx("br",{}),"For bug reporting and more information, visit our ",t.jsx(xi,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",t.jsx("br",{}),t.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),t.jsx(H,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Multiple format support (IFC, Fragments)",t.jsx("br",{}),"â€¢ Pan, zoom, rotate navigation",t.jsx("br",{}),"â€¢ Selection via point-and-click or rectangular region",t.jsx("br",{}),"â€¢ Orthogonal projection for accurate measurements",t.jsx("br",{}),"â€¢ View management (zoom to fit, home, cube orientation)",t.jsx("br",{}),"â€¢ Toggle performance stats",t.jsx("br",{}),"â€¢ Object measurement tools",t.jsx("br",{}),"â€¢ Clipping planes for sectional views"]}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Spatial and classification hierarchy navigation",t.jsx("br",{}),"â€¢ Tree-based model structure view",t.jsx("br",{}),"â€¢ Properties panel with expand/collapse",t.jsx("br",{}),"â€¢ Search and filter functionality",t.jsx("br",{}),"â€¢ Property export (CSV, JSON)",t.jsx("br",{}),"â€¢ Favorites system for quick access",t.jsx("br",{}),"â€¢ Parametric filtering with Ghost/Isolate modes"]}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Validate models against Information Delivery Specification (IDS)",t.jsx("br",{}),"â€¢ Load IDS files from local storage",t.jsx("br",{}),"â€¢ Visual feedback: green (pass) and red (fail) indicators",t.jsx("br",{}),"â€¢ Filter models by validation results",t.jsx("br",{}),"â€¢ Export validation reports"]}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Visual authoring tool for IDS specifications",t.jsx("br",{}),"â€¢ Capture and define validation rules",t.jsx("br",{}),"â€¢ Property picker for easy specification setup",t.jsx("br",{}),"â€¢ Save and load IDS files",t.jsx("br",{}),"â€¢ Integration with IDS Checker for immediate validation"]}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Natural language queries about model contents",t.jsx("br",{}),"â€¢ Intelligent model analysis and insights",t.jsx("br",{}),"â€¢ Context-aware responses based on selected elements",t.jsx("br",{}),"â€¢ Interactive chat interface",t.jsx("br",{}),"â€¢ Selection and filtering via conversation"]}),t.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),t.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Floating toolbar for model operations",t.jsx("br",{}),"â€¢ Tooltips and keyboard shortcuts",t.jsx("br",{}),"â€¢ Collapsible side panels",t.jsx("br",{}),"â€¢ Responsive layout",t.jsx("br",{}),"â€¢ Dark theme optimized for long viewing sessions"]})]}),t.jsx(ho,{children:t.jsx(ie,{onClick:dn,color:"primary",children:"Close"})})]}),t.jsxs(uo,{open:us,onClose:ln,fullWidth:!0,maxWidth:"sm",children:[t.jsx(fo,{children:"Export properties"}),t.jsxs(po,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[t.jsxs(co,{component:"fieldset",variant:"standard",children:[t.jsx(An,{component:"legend",children:"Scope"}),t.jsxs(Rn,{value:it,onChange:e=>Wo(e.target.value),children:[t.jsx(Zt,{value:"selected",control:t.jsx(Qt,{}),label:"Selected items",disabled:!le.length}),t.jsx(Zt,{value:"model",control:t.jsx(Qt,{}),label:"Specific model",disabled:!P.length})]})]}),t.jsx(wi,{in:it==="model",unmountOnExit:!0,children:t.jsx(Jt,{select:!0,fullWidth:!0,label:"Model",value:lt,onChange:e=>pr(e.target.value),disabled:!P.length,children:P.map(e=>t.jsx(Pr,{value:e.id,children:e.label},e.id))})}),it==="selected"&&!le.length&&t.jsx(Mt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Uo&&t.jsx(Mt,{severity:"error",variant:"outlined",children:Uo})]}),t.jsxs(ho,{children:[t.jsx(ie,{onClick:ln,disabled:gt,children:"Cancel"}),t.jsx(ie,{variant:"contained",onClick:xs,disabled:gt||it==="selected"&&!le.length||it==="model"&&!lt,children:gt?"Exportingâ€¦":"Export CSV"})]})]}),t.jsxs(d.Suspense,{fallback:null,children:[t.jsx(xl,{isOpen:Be,onOpen:Ps,onClose:Es,viewerApi:Ne,hasModel:P.length>0,expandSignal:cs}),t.jsx(wl,{isOpen:st,onClose:()=>Vo(!1),viewerApi:Ne,selectedItemData:q,onValidate:As}),t.jsx(bl,{getModelDataForAI:Ls,isOpen:_e,onOpen:ws,onClose:Is,expandSignal:rs,onRequestSelection:Fs,onOpenSettings:un,configVersion:ss})]}),t.jsxs(Ii,{open:!!cr,onClose:_s,anchorReference:"anchorPosition",anchorPosition:cr?{top:cr.mouseY,left:cr.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[t.jsx(Pr,{onClick:Ts,disabled:k.length===0,children:"Hide selected element"}),t.jsx(Pr,{onClick:Vs,children:"Reset hidden elements"})]})]})};function Bn(r,l=2e3){try{if(r==null)return"null";const c=typeof r=="string"?r:JSON.stringify(r,null,2);return c?c.length<=l?c:`${c.slice(0,l)}
... [truncated ${c.length-l} chars]`:""}catch{return String(r)}}Ci.createRoot(document.getElementById("root")).render(t.jsx(Ft.StrictMode,{children:t.jsx(Dl,{})}));export{Ji as a,hl as b,Bl as g,yo as i,Ui as l,_l as p,Yi as s,gl as u};
