const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-BU-loAn8.js","assets/vendor-DcICA_3z.js","assets/IdsPanel-CFM8MsI4.js","assets/thatopen-vendor-CcC7XCOM.js","assets/three-vendor-BFJjymLZ.js","assets/IdsCreatorPanel-BaxKyMhE.js"])))=>i.map(i=>d[i]);
import{ck as kn,cl as vn,cm as d,cn as Pt,co as r,cp as U,cq as te,cr as ce,cs as ie,ct as Pn,cu as An,cv as Rn,cw as zn,cx as Fn,cy as he,cz as dr,cA as Mn,cB as ur,cC as fr,cD as xe,cE as $n,cF as pr,cG as Dn,cH as Nn,cI as mr,cJ as ko,cK as vo,cL as Yt,cM as Ln,cN as hr,cO as Kt,cP as Po,cQ as Tn,cR as On,cS as _n,cT as gr,cU as Vn,cV as Bn,cW as Ao,cX as Gn,cY as Wn,cZ as Un,c_ as Hn,c$ as qn,d0 as Xn,d1 as Yn,d2 as Kn,d3 as Jn,d4 as yr,d5 as br,d6 as Ro,d7 as Zn,d8 as Qn,d9 as es}from"./vendor-DcICA_3z.js";import{l as ts,_ as os,C as rs,W as ns,S as ss,a as ls,O as is,G as as,F as cs,t as ds,H as us,Y as fs,$ as xr}from"./thatopen-vendor-CcC7XCOM.js";import{B as Te,V as Z,C as Le,a3 as ps,a1 as ms,k as hs,a4 as gs,X as ys,h as zo,ab as bs,a2 as xs,l as wr,c as Ir,P as dt,a6 as Fo,S as Cr,G as ws,$ as Is,y as Sr,ac as Cs,D as Ss}from"./three-vendor-BFJjymLZ.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))u(c);new MutationObserver(c=>{for(const h of c)if(h.type==="childList")for(const b of h.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&u(b)}).observe(document,{childList:!0,subtree:!0});function i(c){const h={};return c.integrity&&(h.integrity=c.integrity),c.referrerPolicy&&(h.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?h.credentials="include":c.crossOrigin==="anonymous"?h.credentials="omit":h.credentials="same-origin",h}function u(c){if(c.ep)return;c.ep=!0;const h=i(c);fetch(c.href,h)}})();const js="modulepreload",Es=function(e){return"/Fragments-AI-viewer/"+e},jr={},kt=function(s,i,u){let c=Promise.resolve();if(i&&i.length>0){let j=function(f){return Promise.all(f.map(R=>Promise.resolve(R).then(E=>({status:"fulfilled",value:E}),E=>({status:"rejected",reason:E}))))};document.getElementsByTagName("link");const b=document.querySelector("meta[property=csp-nonce]"),m=b?.nonce||b?.getAttribute("nonce");c=j(i.map(f=>{if(f=Es(f),f in jr)return;jr[f]=!0;const R=f.endsWith(".css"),E=R?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${E}`))return;const L=document.createElement("link");if(L.rel=R?"stylesheet":js,R||(L.as="script"),L.crossOrigin="",L.href=f,m&&L.setAttribute("nonce",m),document.head.appendChild(L),R)return new Promise((F,g)=>{L.addEventListener("load",F),L.addEventListener("error",()=>g(new Error(`Unable to preload CSS for ${f}`)))})}))}function h(b){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=b,window.dispatchEvent(m),!m.defaultPrevented)throw b}return c.then(b=>{for(const m of b||[])m.status==="rejected"&&h(m.reason);return s().catch(h)})},ks="fragments-ids",Ce="elements-v5",Se="cache-metadata-v1",vs=6,rt=()=>new Promise((e,s)=>{const i=indexedDB.open(ks,vs);i.onerror=()=>s(i.error??new Error("IndexedDB open failed")),i.onupgradeneeded=()=>{const u=i.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(h=>{u.objectStoreNames.contains(h)&&u.deleteObjectStore(h)}),u.objectStoreNames.contains(Ce)||u.createObjectStore(Ce),u.objectStoreNames.contains(Se)||u.createObjectStore(Se)},i.onsuccess=()=>e(i.result)}),Mo={async get(e){const s=await rt();return new Promise((i,u)=>{const b=s.transaction(Ce,"readonly").objectStore(Ce).get(e);b.onsuccess=()=>i(b.result??null),b.onerror=()=>u(b.error??new Error("IndexedDB get failed"))})},async set(e,s){const i=await rt();await new Promise((u,c)=>{const h=i.transaction([Ce,Se],"readwrite"),b=h.objectStore(Ce),m=h.objectStore(Se),j=b.put(s,e),f={modelKey:e,timestamp:Date.now(),elementCount:s.length,version:"1.0"};m.put(f,e),j.onsuccess=()=>u(),j.onerror=()=>c(j.error??new Error("IndexedDB set failed"))}),console.log(`💾 Cached ${s.length} elements to IndexedDB for key: ${e.substring(0,16)}...`)},async getMetadata(e){const s=await rt();return new Promise((i,u)=>{const b=s.transaction(Se,"readonly").objectStore(Se).get(e);b.onsuccess=()=>i(b.result??null),b.onerror=()=>u(b.error??new Error("IndexedDB metadata get failed"))})},async remove(e){const s=await rt();await new Promise((i,u)=>{const c=s.transaction([Ce,Se],"readwrite"),h=c.objectStore(Ce),b=c.objectStore(Se);h.delete(e),b.delete(e),c.oncomplete=()=>i(),c.onerror=()=>u(c.error??new Error("IndexedDB delete failed"))})},async keys(){const e=await rt();return new Promise((s,i)=>{const h=e.transaction(Ce,"readonly").objectStore(Ce).getAllKeys();h.onsuccess=()=>s(h.result??[]),h.onerror=()=>i(h.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const e=await rt();return new Promise((s,i)=>{const h=e.transaction(Se,"readonly").objectStore(Se).getAll();h.onsuccess=()=>s(h.result??[]),h.onerror=()=>i(h.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(e=720*60*60*1e3){const s=await rt(),i=await this.getAllMetadata(),u=Date.now(),c=i.filter(h=>u-h.timestamp>e).map(h=>h.modelKey);c.length>0&&await new Promise((h,b)=>{const m=s.transaction([Ce,Se],"readwrite"),j=m.objectStore(Ce),f=m.objectStore(Se);c.forEach(R=>{j.delete(R),f.delete(R)}),m.oncomplete=()=>{console.log(`🧹 Cleaned up ${c.length} old cache entries from IndexedDB`),h()},m.onerror=()=>b(m.error??new Error("IndexedDB cleanup failed"))})}},Ps=async e=>{const s=new TextEncoder,i=`${e.modelUrl}|${e.extra??""}`,u=s.encode(i),c=await crypto.subtle.digest("SHA-256",u),h=new Uint8Array(c);return btoa(String.fromCharCode(...h)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},Fr={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},Oe=e=>e==null?[]:Array.isArray(e)?e:[e],Er=e=>{if(e==null)return[];if(typeof e=="string")try{const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}if(typeof e=="object"){const s=e;if(typeof s.__cdata=="string")try{const i=JSON.parse(s.__cdata);return Array.isArray(i)?i:[]}catch{return[]}if(Array.isArray(s.item))return s.item;if(s.item!=null)return[s.item];if(Array.isArray(s.Rule))return s.Rule;if(s.Rule!=null)return[s.Rule]}return Array.isArray(e)?e:[]},ul=e=>{if(!e||typeof e!="string")return[];const s=new vn(Fr);let i={};try{i=s.parse(e)}catch(f){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",f),[]}const u=i?.IdsCreator??i?.idsCreator??i?.IDS_CREATOR??i?.Ids??i,c=u?.Specification??u?.specification??u?.Specifications??u?.specifications??null;if(c){const f=Oe(c);if(f.length)return f.map((R,E)=>{const L=R?.["@_id"]?.trim?.()||`spec-${E+1}`,F=(R?.Name??R?.name??"")?.toString?.()??"",g=(R?.Description??R?.description??"")?.toString?.()??"",v=Er(R?.Applicability??R?.applicability),N=Er(R?.Requirements??R?.requirements);return{id:L,name:F,description:g,applicability:v,requirements:N}})}const h=f=>{if(!f||typeof f!="object")return[];for(const[R,E]of Object.entries(f)){const L=String(R).toLowerCase();if(L.endsWith(":specification")||L==="specification"||L==="ids:specification")return Oe(E)}for(const R of Object.values(f))if(R&&typeof R=="object"){const E=h(R);if(E&&E.length)return E}return[]},b=h(i);if(!b.length)return[];const m=f=>{if(!f)return null;if(typeof f=="string")return f;if(typeof f=="object")for(const R of Object.keys(f)){const E=R.toLowerCase();if(E.includes("simplevalue")||E==="#text"||E==="value"){const L=f[R];if(typeof L=="string")return L;if(typeof L=="object"&&(L?.value||L?.Value))return String(L.value??L.Value)}}return null};return b.map((f,R)=>{const E=f?.["@_id"]?.trim?.()||`spec-${R+1}`,L=f?.["@_name"]??f?.name??f?.Name??"",F=String(L??""),g="",v=[],N=[],w=f?.applicability??f?.Applicability??f?.["ids:applicability"]??null,z=Oe(w);for(const Q of z){let re=null;const K=[Q];for(;K.length&&!re;){const V=K.shift();if(!V)continue;const ge=m(V);if(ge){re=ge;break}if(typeof V=="object")for(const ke of Object.values(V))ke&&typeof ke=="object"&&K.push(ke)}re&&v.push({entity:re})}const H=f?.requirements??f?.Requirements??f?.["ids:requirements"]??null,me=Oe(H),oe=Q=>{const re=[],K=[];if(Q?.property&&K.push(...Oe(Q.property)),Q?.Property&&K.push(...Oe(Q.Property)),Array.isArray(Q)&&K.push(...Q),!K.length&&typeof Q=="object")for(const V of Object.values(Q))V&&typeof V=="object"&&K.push(V);for(const V of K){const ge=V?.propertySet??V?.PropertySet??V?.["ids:propertySet"]??V?.propertySet,ke=V?.baseName??V?.BaseName??V?.["ids:baseName"]??V?.baseName,nt=m(ge)||m(V?.propertySet?.simpleValue)||m(V?.propertySet?.["ids:simpleValue"]),ve=m(ke)||m(V?.baseName?.simpleValue)||m(V?.baseName?.["ids:simpleValue"]),Xe=[],De=V?.allowedValues??V?.AllowedValues??V?.["ids:allowedValues"];if(De){const we=De?.values??De?.Values??De?.["ids:values"]??De,ro=Oe(we?.value??we?.Value??we?.["ids:value"]??we??[]);for(const Ye of ro){const Pe=m(Ye)||m(Ye?.simpleValue)||m(Ye?.["ids:simpleValue"]);Pe&&Xe.push(Pe)}}if(nt||ve){const we={id:`rule-${R}-${re.length}`,propertyPath:`${nt??"Pset"}.${ve??"Property"}`,operator:"equals"};Xe.length&&(we.value=Xe.length===1?Xe[0]:JSON.stringify(Xe)),re.push(we)}}return re};for(const Q of me){const re=oe(Q);re.length&&N.push(...re)}return{id:E,name:String(F??""),description:String(g),applicability:v,requirements:N}})},fl=e=>{const s=new kn(Fr);if((e??[]).some(h=>Array.isArray(h.requirements)&&h.requirements.some(b=>b&&typeof b=="object"&&"propertyPath"in b))){const b={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(e??[]).map(j=>{const f=[],R=g=>{if(!g&&g!==0)return null;if(typeof g=="string")return g;if(typeof g=="number")return String(g);if(g?.ifcClass&&typeof g.ifcClass=="string"&&g.ifcClass.trim())return g.ifcClass.trim();const v=g?.entity??g?.ifcType??g?.type;if(v&&typeof v=="string"&&v.trim())return v.trim();const N=g?.sample??g;if(N){if(N._category&&typeof N._category=="object"){const z=N._category.value??N._category.Value;if(typeof z=="string"&&z.trim())return z.trim()}const w=N?.ifcClass??N?.category?.value??N?.type??N?._type;if(w&&typeof w=="string"&&w.trim())return w.trim()}return null};for(const g of Oe(j.applicability)){const v=R(g)??null,N=v&&String(v).trim()?String(v):"IFCELEMENT";f.push({"ids:name":{"ids:simpleValue":N}})}const E=[],L=g=>{if(g==null)return"";if(typeof g=="string")return g;if(typeof g=="number")return String(g);if(typeof g=="object"){if(g["ids:simpleValue"])return String(g["ids:simpleValue"]);if(g.__cdata)return String(g.__cdata);if(g.Name)return String(g.Name);if(g.name)return String(g.name);for(const v of Object.keys(g)){const N=g[v];if(typeof N=="string"&&N.trim())return N;if(N&&typeof N=="object"){const w=N;if(typeof w["ids:simpleValue"]=="string")return w["ids:simpleValue"];if(typeof w.value=="string")return w.value}}return""}return""};for(const g of Oe(j.requirements))if(g&&typeof g=="object"){const v=g;let N=null,w=null;if(typeof v.propertyPath=="string"){const[K,V]=String(v.propertyPath).split(".");N=K,w=V}else v.propertyPath&&typeof v.propertyPath=="object"?(N=v.propertyPath.pset??v.propertyPath.propertySet??v.propertySet??null,w=v.propertyPath.property??v.propertyPath.prop??v.property??v.propertyName??null):(N=v.propertySet??v.pset??null,w=v.baseName??v.property??v.prop??null);const z=L(N)||"Pset",H=L(w)||"Property",me=vt(z)||z,oe=vt(H)||H,Q={};if(Q["ids:propertySet"]={"ids:simpleValue":me},Q["ids:baseName"]={"ids:simpleValue":oe},(v.operator??"equals")==="exists")Q["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(v.value!=null&&String(v.value).trim()){let K=null;try{const V=typeof v.value=="string"?JSON.parse(v.value):v.value;Array.isArray(V)&&(K=V.map(ge=>String(ge)))}catch{}K||typeof v.value=="string"&&v.value.includes(",")&&(K=v.value.split(",").map(V=>Qt(V.trim())).filter(Boolean)),K&&K.length?Q["ids:allowedValues"]={"ids:values":{"ids:value":K.map(V=>({"ids:simpleValue":Qt(String(V))}))}}:Q["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":Qt(String(v.value))}}}}E.push({"ids:property":Q})}const F={"@_ifcVersion":"IFC4","@_name":j.name??""};return f.length&&(F["ids:applicability"]={"ids:entity":f.map(g=>({"ids:name":g["ids:name"]?g["ids:name"]:g}))}),E.length&&(F["ids:requirements"]={"ids:property":E.map(g=>g["ids:property"])}),F})}},m=s.build(b);return m.startsWith("<?xml")?m:`<?xml version="1.0" encoding="UTF-8"?>
${m}`}const u={IdsCreator:{Specification:(e??[]).map(h=>({"@_id":h.id,Name:h.name,Description:h.description,Applicability:{__cdata:JSON.stringify(h.applicability??[])},Requirements:{__cdata:JSON.stringify(h.requirements??[])}}))}},c=s.build(u);return c.startsWith("<?xml")?c:`<?xml version="1.0" encoding="UTF-8"?>
${c}`},vt=e=>e?e.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Qt=e=>!e||typeof e!="string"?e:e.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),Mr=e=>{if(e==null)return"";if(typeof e=="string")return Qt(e.trim());if(typeof e=="number"||typeof e=="boolean")return String(e);try{return JSON.stringify(e)}catch{return String(e)}},As=e=>{if(!e)return{};const s={};for(const[i,u]of Object.entries(e)){if(!u||typeof u!="object")continue;const c=vt(i)||i;for(const[h,b]of Object.entries(u)){const m=vt(h)||h,j=`${c}.${m}`;j in s||(s[j]=Mr(b))}}return s};let qe=null;const Rs=()=>{qe=null},zs=e=>e.slice().sort().join("|"),Fs=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],Ms=(e,s)=>{if(!e||typeof e!="object")return;const i=s.map(h=>h.toLowerCase()),u=new WeakSet,c=[e];for(;c.length;){const h=c.pop();if(!(!h||typeof h!="object")&&!u.has(h)){if(u.add(h),Array.isArray(h)){for(const b of h)b&&typeof b=="object"&&c.push(b);continue}for(const[b,m]of Object.entries(h)){const j=b.toLowerCase();if(i.some(f=>j.includes(f)))if(typeof m=="string"){const f=m.trim();if(f)return f}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const f=m;if(typeof f.value=="string"){const R=f.value.trim();if(R)return R}if(typeof f.Value=="string"){const R=f.Value.trim();if(R)return R}f.value&&typeof f.value=="object"&&c.push(f.value),f.Value&&typeof f.Value=="object"&&c.push(f.Value)}}m&&typeof m=="object"&&c.push(m)}}}},$s=e=>{if(!e||typeof e!="object")return null;const s=e;for(const u of Fs){const c=s[u];if(typeof c=="string"&&c.trim().length)return c.trim()}return Ms(e,["globalid","global id","guid","uniqueid"])?.trim()??null},Jt=async(e,s,i)=>{console.log("🔍 [collectElementsDirect] START with",s.length,"globalIds"),console.log("🔍 [collectElementsDirect] Has getElementPropsFast?",!!e.getElementPropsFast);const u=[],c=Math.max(s.length,1);i?.onProgress?.({done:0,total:c});const h=e.getElementPropsFast||e.getElementProps,b=e.getElementPropsFast?"getElementPropsFast":"getElementProps";console.log("🔍 [collectElementsDirect] Using method:",b);for(let m=0;m<s.length;m++){const j=s[m];console.log(`🔍 [collectElementsDirect] Processing ${m+1}/${s.length}: ${j}`);try{console.log(`🔍 [collectElementsDirect] Calling ${b} for ${j}...`);const{ifcClass:R,psets:E,attributes:L}=await h.call(e,j);console.log(`🔍 [collectElementsDirect] Got props for ${j}:`,{ifcClass:R,psetCount:Object.keys(E).length,attrCount:Object.keys(L||{}).length});const F=As(E);if("GlobalId"in F||(F.GlobalId=j),L)for(const[g,v]of Object.entries(L)){const w=`Attributes.${vt(g)||g}`;w in F||(F[w]=Mr(v))}F.ifcClass||(F.ifcClass=R),u.push({GlobalId:j,ifcClass:R,properties:F}),console.log(`🔍 [collectElementsDirect] Added element ${m+1}, total now: ${u.length}`)}catch(R){console.warn(`IDS adapter (direct) failed to load element ${j}`,R)}const f=u.length;i?.onProgress?.({done:f,total:c})}return i?.onProgress?.({done:u.length,total:c}),console.log("🔍 [collectElementsDirect] COMPLETE - returning",u.length,"elements"),u},Ds=async(e,s,i)=>{if(typeof e.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const u=Math.max(1,(navigator.hardwareConcurrency||4)-1);console.log(`🚀 Starting parallel property extraction with ${u} workers`);const c=[],h=[],b=[];for(let f=0;f<u;f++){const R=new Worker(new URL("/Fragments-AI-viewer/assets/buildProps.worker-rQtm8XA_.js",import.meta.url),{type:"module"});c.push(R);const E=new Promise((L,F)=>{const g=N=>{const w=N.data;if(w){if(w.type==="error"){F(new Error(w.message||`Worker ${f} failed.`));return}if(w.type==="progress"){const z=b.reduce((H,me)=>H+me.length,0)+w.done;i?.onProgress?.({done:z,total:Math.max(s,z)});return}w.type==="done"&&(b[f]=w.elements??[],L(w.elements??[]))}},v=N=>{F(N.error??new Error(N.message||`Worker ${f} error.`))};R.addEventListener("message",g),R.addEventListener("error",v)});h.push(E),R.postMessage({type:"build-props",reset:!0,total:s})}i?.onProgress?.({done:0,total:s});const m=new Set;let j=0;try{for await(const f of e.iterElements({batchSize:128})){if(!Array.isArray(f)||!f.length)continue;const R=[];f.forEach(E=>{if(!E||typeof E!="object")return;const L=E.data;if(!L)return;const F=$s(L);if(!F||m.has(F))return;m.add(F);const g=typeof L.ifcClass=="string"?L.ifcClass:void 0;R.push({globalId:F,ifcClass:g,data:L})}),R.length&&(c[j].postMessage({type:"build-props",elements:R}),j=(j+1)%u)}}catch(f){throw c.forEach(R=>{R.postMessage({type:"cancel"}),R.terminate()}),f}c.forEach(f=>{f.postMessage({type:"build-props",final:!0})});try{const R=(await Promise.all(h)).flat();return console.log(`✅ Parallel processing complete: ${R.length} elements processed by ${u} workers`),i?.onProgress?.({done:R.length,total:Math.max(s,R.length)}),R}finally{c.forEach(f=>f.terminate())}},Ns=async(e,s)=>{try{const i=typeof s.countElements=="function"?await s.countElements():void 0;return await Ps({modelUrl:e,extra:i!=null?String(i):void 0})}catch(i){return console.warn("IDS adapter: failed to compute model key for cache",i),null}},Ls=async(e,s)=>{if(console.log("🔍 [collectElementsForIds] START",{hasFilterGlobalIds:!!s?.filterGlobalIds,filterCount:s?.filterGlobalIds?.length}),!e)return console.log("🔍 [collectElementsForIds] No viewerApi"),[];let i;if(s?.filterGlobalIds&&s.filterGlobalIds.length>0)console.log("🔍 [collectElementsForIds] Using provided filterGlobalIds directly (skipping listGlobalIds)"),i=s.filterGlobalIds;else{console.log("🔍 [collectElementsForIds] Calling listGlobalIds...");const j=await e.listGlobalIds();console.log("🔍 [collectElementsForIds] Got all GlobalIds:",j.length),i=j}if(console.log("🔍 [collectElementsForIds] GlobalIds to validate:",i.length),!i.length)return console.log("🔍 [collectElementsForIds] No GlobalIds to process"),qe=null,[];console.log("🔍 [collectElementsForIds] Building cache token...");const u=zs(i);console.log("🔍 [collectElementsForIds] Token built:",u.substring(0,20)+"...");const c=Math.max(i.length,1);if(s?.onPhase?.("BUILDING_PROPERTIES"),s?.onProgress?.({done:0,total:c}),console.log("🔍 [collectElementsForIds] Checking memory cache..."),qe&&qe.token===u)return console.log("🔍 [collectElementsForIds] Memory cache HIT! Returning",qe.elements.length,"elements"),qe.elements;console.log("🔍 [collectElementsForIds] Memory cache MISS");const h=s?.filterGlobalIds&&s.filterGlobalIds.length>0;let b=null;if(h)console.log("🔍 [collectElementsForIds] Skipping persistent cache (filtering mode)");else if(console.log("🔍 [collectElementsForIds] Resolving persistent key..."),b=await Ns(u,e),console.log("🔍 [collectElementsForIds] Persistent key:",b),b){console.log("🔍 [collectElementsForIds] Checking IndexedDB cache...");try{const j=await Mo.get(b);if(console.log("🔍 [collectElementsForIds] IndexedDB returned:",j?.length||0,"elements"),j&&j.length){const f=await Mo.getMetadata(b),R=f?Math.round((Date.now()-f.timestamp)/1e3/60):0;return console.log(`⚡ Using cached elements from IndexedDB: ${j.length} elements (cached ${R} minutes ago)`),s?.onProgress?.({done:j.length,total:c}),qe={token:u,elements:j},j}console.log("🔍 [collectElementsForIds] IndexedDB cache MISS or empty")}catch(j){console.warn("IDS adapter: failed to read cached elements from IndexedDB",j)}}let m=[];if(console.log("🔍 [collectElementsForIds] Decision point:",{isFiltering:h,willUseDirect:h,globalIdsCount:i.length}),h)console.log(`📌 Filtering mode: collecting ${i.length} specific elements directly`),console.log("🔍 [collectElementsForIds] Calling collectElementsDirect..."),m=await Jt(e,i,s),console.log("🔍 [collectElementsForIds] collectElementsDirect returned:",m.length,"elements");else{console.log("🔍 [collectElementsForIds] Full model mode - using workers");const j=typeof e.countElements=="function"?await e.countElements().catch(()=>i.length):i.length;if(console.log("🔍 [collectElementsForIds] Total elements:",j),typeof e.iterElements=="function")try{console.log("🔍 [collectElementsForIds] Calling buildWithWorker..."),m=await Ds(e,j??i.length,s),console.log("🔍 [collectElementsForIds] buildWithWorker returned:",m.length,"elements"),m.length||(console.log("🔍 [collectElementsForIds] No elements from worker, falling back to direct"),m=await Jt(e,i,s))}catch(f){console.warn("IDS adapter: property build worker failed, falling back to direct collection",f),m=await Jt(e,i,s)}else console.log("🔍 [collectElementsForIds] iterElements not available, using direct"),m=await Jt(e,i,s)}return b&&m.length&&Mo.set(b,m).catch(j=>console.warn("IDS adapter: failed to persist elements cache",j)),qe={token:u,elements:m},s?.onProgress?.({done:Math.min(m.length,c),total:c}),m},Ts={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validateSelectedOnly:!1};let ft=Ts;const Do=new Set,Os=()=>{Do.forEach(e=>{try{e()}catch(s){console.error("IDS store listener error",s)}})},pe=e=>{ft=e(ft),Os()};let mt=null,to=null;const _s=()=>(mt||(mt=new Worker(new URL("/Fragments-AI-viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),mt),Vs=(e,s)=>{const i=_s(),u=new Promise((c,h)=>{const b=j=>{const f=j.data;if(f){if(f.type==="error"){i.removeEventListener("message",b),i.removeEventListener("error",m),h(new Error(f.message||"IDS worker failed"));return}if(f.type==="phase"){s?.onPhase?.(f.label);return}if(f.type==="progress"){s?.onProgress?.(f);return}if(f.type==="done"){i.removeEventListener("message",b),i.removeEventListener("error",m),c(f);return}}},m=j=>{i.removeEventListener("message",b),i.removeEventListener("error",m),h(j.error??new Error(j.message))};i.addEventListener("message",b),i.addEventListener("error",m),i.postMessage(e)});return to=u.finally(()=>{to=null}),u},kr=()=>{pe(e=>({...e,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},de={subscribe:e=>(Do.add(e),()=>Do.delete(e)),getState:()=>ft,setIdsXmlText:(e,s)=>{const i=e.replace(/\uFEFF/g,"").trim(),u=s?.fileNames??[];pe(c=>({...c,idsXmlText:i,idsFileNames:u,error:null})),kr()},appendDocuments:e=>{if(!e.length)return;const s=de.getState(),i=[];s.idsXmlText.trim().length&&i.push(s.idsXmlText.trim()),i.push(...e.map(h=>h.content.trim()).filter(Boolean));const u=i.join(`

`),c=[...s.idsFileNames,...e.map(h=>h.name)];de.setIdsXmlText(u,{fileNames:c})},clearResults:()=>{kr()},setValidateSelectedOnly:e=>{pe(s=>({...s,validateSelectedOnly:e}))},filterRows:(e,s)=>{pe(i=>{if(!e)return{...i,filteredRows:i.rows,filterDescription:null};const u=i.rows.filter(c=>{try{return e(c)}catch(h){return console.warn("IDS filter predicate threw an error",h),!0}});return{...i,filteredRows:u,filterDescription:s??null}})},runCheck:async e=>{if(!e){pe(u=>({...u,error:"Viewer API is not available."}));return}if(ft.isChecking){await to;return}const s=ft.idsXmlText.trim();if(!s){pe(u=>({...u,error:"Load at least one IDS XML file before running the check."}));return}let i;if(ft.validateSelectedOnly)if(console.log("🎯 Selected Only mode is active"),e.getSelectedGlobalIds){if(console.log("🎯 Getting selected GlobalIds..."),i=await e.getSelectedGlobalIds(),console.log("🎯 Selected GlobalIds:",i),!i||i.length===0){console.error("❌ No elements selected"),pe(u=>({...u,error:'No elements selected. Please select elements or switch to "All Elements" mode.'}));return}console.log(`🎯 Validating ${i.length} selected elements`)}else{console.warn("⚠️ getSelectedGlobalIds not available on viewerApi"),pe(u=>({...u,error:"Selected elements validation is not supported by this viewer."}));return}pe(u=>({...u,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null}));try{const u=await Ls(e,{filterGlobalIds:i,onPhase:j=>{pe(f=>({...f,phase:j}))},onProgress:j=>{pe(f=>({...f,progress:j}))}});if(!u.length)throw new Error("No IFC elements were found in the current viewer.");pe(j=>({...j,phase:"CHECKING_IDS",progress:null}));const c={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},h=await Vs({type:"validate",idsXml:s,elements:u},{onPhase:j=>{const f=c[j];f&&pe(R=>({...R,phase:f}))},onProgress:j=>{pe(f=>({...f,progress:{done:j.done,total:j.total}}))}}),b=h.rules??[],m=h.rows??[];if(i&&i.length>0&&typeof e.addToCache=="function"){console.log(`📦 Adding ${i.length} validated elements to cache...`);try{await e.addToCache(i),console.log("📦 Successfully updated cache with validated elements")}catch(j){console.warn("📦 Failed to add elements to cache:",j)}}pe(j=>({...j,isChecking:!1,rules:b,rows:m,filteredRows:m,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null}))}catch(u){const c=u instanceof Error?u.message:"Failed to run IDS validation.";console.error("IDS run failed",u),pe(h=>({...h,isChecking:!1,error:c,phase:"ERROR",progress:null}))}},invalidateCaches:()=>{Rs(),mt&&(mt.terminate(),mt=null,to=null),pe(e=>({...e,isChecking:!1,phase:"IDLE",progress:null}))}},Bs=e=>d.useSyncExternalStore(de.subscribe,()=>e({...de.getState(),...de}),()=>e({...de.getState(),...de})),Gs=e=>d.useSyncExternalStore(de.subscribe,()=>e(de.getState()),()=>e(de.getState())),Ws=()=>{const e=d.useCallback(de.setIdsXmlText,[]),s=d.useCallback(de.appendDocuments,[]),i=d.useCallback(de.clearResults,[]),u=d.useCallback(de.filterRows,[]),c=d.useCallback(de.runCheck,[]),h=d.useCallback(de.setValidateSelectedOnly,[]);return{setIdsXmlText:e,appendDocuments:s,clearResults:i,filterRows:u,runCheck:c,setValidateSelectedOnly:h,invalidateCaches:de.invalidateCaches}},$r=de,Us=Object.freeze(Object.defineProperty({__proto__:null,idsStore:$r,useIdsActions:Ws,useIdsStore:Bs,useIdsStoreSelector:Gs},Symbol.toStringTag,{value:"Module"})),Hs=Pt.lazy(()=>kt(()=>import("./ChatWindow-BU-loAn8.js"),__vite__mapDeps([0,1]))),qs=Pt.lazy(()=>kt(()=>import("./IdsPanel-CFM8MsI4.js"),__vite__mapDeps([2,1,3,4]))),Xs=Pt.lazy(()=>kt(()=>import("./IdsCreatorPanel-BaxKyMhE.js"),__vite__mapDeps([5,1,3,4]))),vr=(e,s)=>{if(e.length!==s.length)return!1;for(let i=0;i<e.length;i+=1){const u=e[i],c=s[i];if(!c||u.modelId!==c.modelId||u.localId!==c.localId)return!1}return!0},Ys={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Ks=(e,s)=>{if(!e)return s;const i=[e.ifcCategory,e.Category,e.category,e.ifcClass,e.class,e.type,e.Type,e.system,e.System];for(const u of i)if(typeof u=="string"&&u.trim())return u.trim();if(Array.isArray(e.categories)&&e.categories.length){const u=e.categories.find(c=>typeof c=="string"&&c.trim());if(u)return u.trim()}return typeof e.name=="string"&&e.name.trim()?e.name.trim():typeof e.Name=="string"&&e.Name.trim()?e.Name.trim():typeof e.label=="string"&&e.label.trim()?e.label.trim():s},Js=(e,s,i)=>{const u=new Map;let c=0,h=0,b=0;i.traverse(E=>{const L=!!E?.isInstancedMesh,F=!!E?.isMesh;if(!L&&!F)return;let g=0;if(L){let w=0;typeof E.count=="number"?w=E.count:typeof E.instanceCount=="number"?w=E.instanceCount:Array.isArray(E.instanceIdMap)?w=E.instanceIdMap.length:Array.isArray(E.userData?.ids)?w=E.userData.ids.length:typeof E.userData?.size=="number"&&(w=E.userData.size),Number.isFinite(w)&&w>0&&(g=w,h+=w)}else g=1,b+=1;g<=0&&(g=1),c+=g;const v=Ks(E?.userData??{},E?.type??"Mesh"),N=u.get(v)??0;u.set(v,N+g)});const m=Array.from(u.entries()).map(([E,L])=>({category:E,count:L})).sort((E,L)=>L.count-E.count),j=new Te().setFromObject(i),f=new Z,R=new Z;return j.getSize(f),j.getCenter(R),{modelId:e,label:s,elementCount:c,instancedCount:h,meshCount:b,categoryCounts:m,bboxSize:{x:f.x,y:f.y,z:f.z},bboxCenter:{x:R.x,y:R.y,z:R.z},collectedAt:Date.now()}},Zs=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),_e=e=>{if(!e)return"";let s=e.replace(/[_\-]+/g," ");return s=s.replace(/([a-z\d])([A-Z])/g,"$1 $2"),s=s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),s=s.replace(/\s+/g," ").trim(),s?s.split(" ").map(u=>{const c=u.toUpperCase();return Zs.has(c)||c.length<=3&&/^[A-Z]+$/.test(c)?c:/^\d+(\.\d+)?$/.test(u)||!u.length?u:u.charAt(0).toUpperCase()+u.slice(1)}).join(" "):""},Qs=(e,s=200)=>e?e.length<=s?e:`${e.slice(0,s)}…`:"",je=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const s=JSON.stringify(e);return s?s.length>500?`${s.slice(0,500)}…`:s:""}catch{return String(e)}},Ee=e=>e==null?"":typeof e!="object"?je(e):"value"in e?Ee(e.value):"Value"in e?Ee(e.Value):Array.isArray(e)?e.map(s=>Ee(s)).filter(Boolean).join(", "):typeof e.x=="number"&&typeof e.y=="number"&&typeof e.z=="number"?`${je(e.x)}, ${je(e.y)}, ${je(e.z)}`:je(e),be=(e,s)=>{if(!e||typeof e!="object")return;const i=s.map(h=>h.toLowerCase()),u=new WeakSet,c=[e];for(;c.length;){const h=c.pop();if(!(!h||typeof h!="object")&&!u.has(h)){if(u.add(h),Array.isArray(h)){for(const b of h)b&&typeof b=="object"&&c.push(b);continue}for(const[b,m]of Object.entries(h)){const j=b.toLowerCase();if(i.some(f=>j.includes(f)))if(typeof m=="string"){const f=m.trim();if(f)return f}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const f=Ee(m);if(f)return f}}m&&typeof m=="object"&&c.push(m)}}}},el=(e,s)=>{if(!e||typeof e!="object")return oo(e,300);const i=[],u=Ve(e)??be(e,["name","label","description"]);u&&i.push(`name:${u}`);const c=be(e,["category","ifcclass","ifc type","type"]);c&&i.push(`category:${c}`);const h=be(e,["globalid","global id","guid"]);h&&i.push(`globalId:${h}`);const b=be(e,["expressid","express id"]);if(b&&b!==h&&i.push(`expressId:${b}`),s>0)try{const{rows:j}=jt(e);if(j.length){const R=j.slice(0,s).map(E=>`${E.label}=${E.value}`).join(" | ");R&&i.push(`props:${R}`),j.length>s&&i.push(`propsTruncated:${j.length-s}`)}}catch(j){console.warn("Failed to build detailed property data for AI summary",j)}const m=i.filter(Boolean).join(" | ");return m?m.length>1200?`${m.slice(0,1200)}…`:m:oo(e,300)},Pr={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},tl=new Set(["modelIdMap"]),pt=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),ut=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Et=["HasProperties","hasProperties","Properties","properties"],$o=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],Ar=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Zt=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSET"?!0:Et.some(i=>Array.isArray(e[i]))},Dr=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in e||"nominalValue"in e},ol=e=>{if(!e||typeof e!="object")return je(e);const s=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const i of s){if(!(i in e))continue;const u=e[i];if(u==null)continue;if(Array.isArray(u)){const h=u.map(b=>Ee(b)).filter(Boolean).join(", ");if(h)return h;continue}const c=Ee(u);if(c)return c}for(const[i,u]of Object.entries(e))if((typeof u=="string"||typeof u=="number"||typeof u=="boolean")&&i.toLowerCase().includes("value")){const c=je(u);if(c)return c}return""},rl=(e,s,i)=>{const u=Et.map(m=>Array.isArray(e[m])?e[m]:null).filter(m=>!!m);if(!u.length)return[];const c=_e(s)||s,h=[],b=new Map;return u.flat().forEach((m,j)=>{if(!m||typeof m!="object"||!Dr(m))return;const f=Ve(m)??(typeof m.Name=="string"?m.Name:void 0)??(typeof m.PropertyName=="string"?m.PropertyName:void 0),R=`Property ${j+1}`,E=f&&f.trim().length?f.trim():R,L=_e(E)||E,F=ol(m),g=pt(E)||"property",v=(b.get(g)??0)+1;b.set(g,v);const N=`${g}-${v}`,w=`Property Sets / ${c} / ${L}`,z=[w.toLowerCase()];F&&z.push(F.toLowerCase()),h.push({label:w,value:F||"",path:`property-sets/${i}/${N}`,searchText:z.join(" ").trim(),rawPsetName:s,rawPropertyName:E,rawValue:m.__rawValue??m})}),h},eo=e=>{if(!e||typeof e!="object")return[];const s=[],i=new WeakSet,u=new Map,c=F=>{let g;if(typeof F=="string"){const z=F.trim();z.length&&(g=z)}!g&&F&&typeof F=="object"&&(g=Ve(F)??(typeof F.Name=="string"?F.Name:void 0)??(typeof F.id=="string"?F.id:void 0)),(!g||!g.length)&&(g="Property Set");const v=_e(g)||g,N=pt(g)||"property-set",w=(u.get(N)??0)+1;return u.set(N,w),{rawName:g,friendlyName:v,uniqueKey:`${N}-${w}`}},h=(F,g,v)=>{const N=`Property ${v+1}`,w=F?.trim?.()?F.trim():N;if(Dr(g)){const z={...g};return z.Name==null&&z.PropertyName==null&&(z.Name=w),z.PropertyName==null&&(z.PropertyName=z.Name??w),z.__rawValue==null&&(z.__rawValue=g),z}if(g&&typeof g=="object"){const z={...g};return z.Name==null&&z.PropertyName==null&&(z.Name=w),z.PropertyName==null&&(z.PropertyName=z.Name??w),z.type==null&&z.Type==null&&(z.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in z)&&!("nominalValue"in z)&&!("Value"in z)&&!("value"in z)&&(z.NominalValue=g),z.__rawValue=g,z}return{type:"IFCPROPERTYSINGLEVALUE",Name:w,PropertyName:w,NominalValue:g,__rawValue:g}},b=(F,g)=>{const v=[],N=(w,z)=>{const H=`Property ${v.length+1}`,me=(typeof w=="string"&&w.trim().length?w.trim():void 0)??Ve(w)??(typeof w?.Name=="string"?w.Name:void 0)??(typeof w?.PropertyName=="string"?w.PropertyName:void 0)??H;v.push(h(me,z,v.length))};if(g&&typeof g=="object")for(const w of Et){const z=g[w];Array.isArray(z)&&z.length&&z.forEach(H=>N(H,H))}if(!v.length)if(Array.isArray(g))g.forEach(w=>N(w,w));else if(g&&typeof g=="object")for(const[w,z]of Object.entries(g))z!=null&&(Ar.has(w)||Et.includes(w)||$o.includes(w)||N(w,z));else g!=null&&N(void 0,g);return{type:"IFCPROPERTYSET",Name:F,HasProperties:v}},m=(F,g)=>{const N=rl(g&&typeof g=="object"?g:{},F.rawName,F.uniqueKey);N.length&&s.push(...N)},j=F=>{if(!(!F||typeof F!="object")&&!i.has(F)){if(i.add(F),Array.isArray(F)){F.forEach(g=>{if(!g||typeof g!="object")return;const v=c(g),N=Zt(g)?g:b(v.rawName,g);m(v,N),N&&typeof N=="object"&&i.add(N)});return}for(const[g,v]of Object.entries(F)){if(v==null)continue;const N=c(g),w=Zt(v)?v:b(N.rawName,v);m(N,w),v&&typeof v=="object"&&i.add(v)}}},f=F=>{if(!F||typeof F!="object"||i.has(F))return;if(i.add(F),Array.isArray(F)){F.forEach(f);return}let g=!1;for(const v of $o)Object.prototype.hasOwnProperty.call(F,v)&&(j(F[v]),g=!0);if(Zt(F)){const v=c(F);m(v,F)}!g&&!Zt(F)&&Object.entries(F).forEach(([v,N])=>{$o.includes(v)||Ar.has(v)||Et.includes(v)||N&&typeof N=="object"&&f(N)})};f(e);const R=new Map,E=new Set;for(const F of s){const g=`${F.label}::${F.value}`;if(E.has(g))continue;const v=`${F.rawPsetName||"unknown"}::${F.rawPropertyName||"unknown"}::${F.value}`;R.has(v)||(E.add(g),R.set(v,F))}const L=Array.from(R.values());return s.length,L.length,L},$e={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Rr=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],nl=(e,s)=>{const i=typeof e=="string"?e.trim().toLowerCase():"";if(i&&Rr.some(u=>i.startsWith(u)))return!0;if(s&&typeof s=="object"){const u=Ee(s._category??s.category??s.Category??null),c=typeof u=="string"?u.trim().toLowerCase():"";if(c&&Rr.some(b=>c.startsWith(b))||(s.NominalValue!=null||s.nominalValue!=null)&&(s.Name!=null||s.PropertyName!=null)&&i.includes("property"))return!0}return!1},zr="fragmentsViewer.favoritePropertyPaths",sl=1e4,ll=500,Ve=e=>{if(!e||typeof e!="object")return;let s,i;typeof e.Name=="string"?s=e.Name:e.Name&&typeof e.Name=="object"&&(s=Ee(e.Name)||void 0),typeof e.name=="string"?i=e.name:e.name&&typeof e.name=="object"&&(i=Ee(e.name)||void 0);const u=s??i;if(!u)return;const c=u.trim();return c.length?c:void 0},jt=e=>{if(!e||typeof e!="object")return{rows:[],tree:[]};const s=[],i=new WeakSet,u=(b,m,j)=>{if(b==null)return null;const f=m.map(w=>{const z=w?.trim?.()??w;return typeof z=="string"&&z.length?_e(z)||z:typeof w=="string"?w:String(w??"")}),R=f.filter(Boolean).join(" / "),E=j.length?j.join("/"):pt(R||"value"),L=f[f.length-1]??"Value",F=w=>{const z=R.toLowerCase(),H=[z];w&&H.push(w.toLowerCase());const me=H.join(" ").trim()||z,oe={label:R,value:w??"",path:E,searchText:me};return s.push(oe),me};if(typeof b!="object"||b instanceof Date){const w=je(b),z=F(w);return{id:E,label:L,fullLabel:R,value:w||void 0,children:[],searchText:z}}if(i.has(b)){const w="[Circular reference]",z=F(w);return{id:E,label:L,fullLabel:R,value:w,children:[],searchText:z}}i.add(b);let g;const v=[];if(Array.isArray(b))b.forEach((w,z)=>{const H=Ve(w),me=`${L} ${z+1}`,oe=H&&H.trim().length?H.trim():me,Q=_e(oe)||oe,re=H&&H.trim().length?pt(H):String(z),K=u(w,[...m,Q],[...j,re]);K&&v.push(K)}),v.length===0&&(g=je(b));else{if("NominalValue"in b||"nominalValue"in b){const w=b.NominalValue??b.nominalValue,z=Ee(w);z&&(g=z)}!g&&"value"in b&&typeof b.value!="object"&&(g=je(b.value)),!g&&"Value"in b&&typeof b.Value!="object"&&(g=je(b.Value));for(const[w,z]of Object.entries(b)){if(z==null||w==="Name"||w==="name"||w==="IsDefinedBy"||w==="isDefinedBy"||w==="psets"||w==="Psets"||w==="propertySets"||w==="PropertySets"||w==="property_sets"||w==="Property_Sets")continue;if(w==="NominalValue"||w==="nominalValue"){const ge=_e("Nominal Value")||"Nominal Value",ke=u(z,[...m,ge],[...j,"nominal-value"]);ke&&v.push(ke);continue}const H=Pr[w]??w,me=_e(H)||H,oe=Ve(z)?.trim(),Q=oe&&oe.length?_e(oe)||oe:me,re=oe&&oe.length?pt(oe):pt(H),K=[...m,Q],V=u(z,K,[...j,re]);V&&v.push(V)}!g&&v.length===0&&(g=je(b))}const N=F(g);return{id:E,label:L,fullLabel:R,value:g,children:v,searchText:N}},c=[];for(const[b,m]of Object.entries(e)){if(m==null||tl.has(b))continue;const j=Pr[b]??b,f=u(m,[j],[b]);f&&c.push(f)}if(s.length){const b=s.filter(m=>{const j=m.label.toLowerCase();return j.startsWith("property sets /")?!(j.includes("/ has properties")||j.includes("/ nominal value")):!0});b.length!==s.length&&s.splice(0,s.length,...b)}const h=eo(e);if(h.length){const b=[],m=new Set;for(const f of h)m.has(f.path)||(m.add(f.path),b.push(f));const j=[];for(const f of s)m.has(f.path)||j.push(f);s.splice(0,s.length,...b,...j)}return{rows:s,tree:c}},il=()=>{const e=d.useRef(null),s=d.useRef(null),i=d.useRef(null),u=d.useRef(null),c=d.useRef(null),h=d.useRef(!1),b=d.useRef(null),m=d.useRef(null),j=d.useRef(null),[f,R]=d.useState(!1),[E,L]=d.useState([]),[F,g]=d.useState(!1),[v,N]=d.useState(50);d.useCallback(async(t,o)=>{{console.warn("dumpModelRawData is dev-only.");return}},[E]),d.useCallback(async(t,o=50,n=128)=>{},[]);const[w,z]=d.useState([]),[H,me]=d.useState(null),[oe,Q]=d.useState(!0),[re,K]=d.useState(!1),[V,ge]=d.useState(null),[ke,nt]=d.useState(!1),[ve,Xe]=d.useState(!1),De=d.useRef(null),we=d.useRef(!1),ro=d.useRef(null),Ye=d.useRef(null),Pe=d.useRef(null),Ae=d.useRef(null),At=d.useRef(0),Be=d.useRef(null),Rt=d.useRef(null),[zt,Nr]=d.useState({width:360,height:520}),no=d.useRef(null),Ft=d.useRef(!1),so=d.useRef(null),No=d.useRef(!1),Lo=d.useRef(null),Ke=d.useRef(null),lo=d.useRef(null),Mt=d.useRef(null),io=d.useRef(null),ht=d.useRef(null),To=d.useRef(null),Oo=d.useRef(null),Ge=d.useRef(null),Ne=d.useRef([]),Re=d.useRef(null),gt=d.useRef(null),yt=d.useRef(null),[$t,Ie]=d.useState(null),[le,Lr]=d.useState([]),[_o,Tr]=d.useState(""),[st,Or]=d.useState(""),[ye,Vo]=d.useState([]),[Je,Bo]=d.useState("favorites"),[Dt,_r]=d.useState(!1),[Ze,Vr]=d.useState(!1),[Qe,Br]=d.useState(!1),[bt,ao]=d.useState(!1),[Gr,Go]=d.useState(0),[lt,Nt]=d.useState(!1),[Wr,co]=d.useState(0),[it,uo]=d.useState(!1),[Wo,Ur]=d.useState({}),[fo,Uo]=d.useState(null),[xt,Ho]=d.useState([]),[Hr,po]=d.useState(!1),[We,qo]=d.useState("selected"),[Ue,Lt]=d.useState(""),[et,Xo]=d.useState(!1),[Yo,Tt]=d.useState(null),[qr,Ko]=d.useState(!1),[ne,Ot]=d.useState({x:!1,y:!1,z:!1}),[ze,Jo]=d.useState({x:0,y:0,z:0}),[wt,Zo]=d.useState(!1),[It,Xr]=d.useState(!1),_t=d.useRef(!1),mo=d.useRef([]),ho=d.useRef(new Map),Vt=d.useRef(null),[Qo,er]=d.useState(null),He=d.useCallback(()=>i.current?.camera??null,[]),go=d.useCallback(()=>He()?.three??null,[He]);d.useEffect(()=>{try{const t=window.localStorage.getItem(zr);if(!t)return;const o=JSON.parse(t);if(!Array.isArray(o))return;const n=o.filter(l=>typeof l=="string"&&l.trim().length>0);n.length&&Vo(n)}catch(t){console.warn("Failed to restore favourites from storage",t)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(zr,JSON.stringify(ye))}catch(t){console.warn("Failed to persist favourites to storage",t)}},[ye]);const Bt=_o.trim(),Yr=Bt.length>0,tr=d.useMemo(()=>{const t=Bt.toLowerCase();return t?le.filter(o=>o.searchText.includes(t)).slice(0,ll):[]},[Bt,le]),Gt=d.useMemo(()=>{const t=new Map;return le.forEach(o=>t.set(o.path,o)),t},[le]),yo=d.useMemo(()=>le.slice(0,sl),[le]),or=Math.max(le.length-yo.length,0),rr=d.useMemo(()=>new Set(ye),[ye]),bo=d.useMemo(()=>ye.length?ye.map(t=>Gt.get(t)).filter(t=>!!t):[],[ye,Gt]),xo=d.useMemo(()=>{if(!ye.length)return 0;let t=0;for(const o of ye)Gt.has(o)||(t+=1);return t},[ye,Gt]),nr=d.useCallback(t=>{Vo(o=>o.includes(t)?o.filter(n=>n!==t):[...o,t])},[]),Wt=d.useMemo(()=>E.map(t=>`${t.id}:${t.label}`).join("|"),[E]),wo=d.useCallback(t=>{const o=rr.has(t.path);return r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(te,{variant:"body2",sx:{fontWeight:600},children:t.label}),r.jsx(ce,{title:o?"Remove from favourites":"Add to favourites",children:r.jsx("span",{children:r.jsx(ie,{size:"small",onClick:()=>nr(t.path),color:o?"primary":"default",children:o?r.jsx(Pn,{fontSize:"small"}):r.jsx(An,{fontSize:"small"})})})})]}),r.jsx(te,{variant:"body2",color:"text.secondary",children:t.value?Qs(t.value,360):"—"})]},t.path)},[rr,nr]);d.useEffect(()=>{if(!E.length){Lt("");return}Lt(t=>t&&E.some(o=>o.id===t)?t:E[0].id)},[E]);const sr=d.useCallback(async t=>{const o=c.current;if(!o)return[];const n=o.list.get(t);if(!n)return[];let l=[];try{const p=await n.getLocalIds();Array.isArray(p)?l=p:p&&typeof p[Symbol.iterator]=="function"&&(l=Array.from(p))}catch(p){return console.warn(`Failed to retrieve local IDs for model ${t}`,p),[]}if(!l.length)return[];const a=32,y=[];for(let p=0;p<l.length;p+=a){const A=l.slice(p,p+a);let x=[];try{x=await n.getItemsData(A,$e)}catch(I){console.warn(`Failed to fetch items data for model ${t} chunk starting at ${A[0]}`,I);continue}x.forEach((I,C)=>{const S=A[C];if(I)try{const{rows:D}=jt(I);D.forEach($=>{y.push({path:`localId:${S} / ${$.label}`,value:$.value})})}catch(D){console.warn(`Failed to process properties for model ${t} localId ${S}`,D)}})}return y},[]),lr=d.useCallback(t=>{const o=[];return o.push("Path,Value"),t.forEach(({path:n,value:l})=>{const a=n.replace(/"/g,'""'),y=(l??"").replace(/"/g,'""');o.push(`"${a}","${y}"`)}),o.join(`\r
`)},[]),Kr=d.useCallback(()=>{Tt(null),qo(le.length?"selected":"model"),E.length&&!E.some(t=>t.id===Ue)&&Lt(E[0].id),po(!0)},[le.length,E,Ue]),Jr=d.useCallback(async()=>{if(!H){alert("No element selected");return}try{const t=new WeakSet,o=JSON.stringify(H,(n,l)=>{if(typeof l=="object"&&l!==null){if(t.has(l))return"[Circular Reference]";t.add(l)}return l instanceof Map?`[Map with ${l.size} entries]`:l instanceof Set?`[Set with ${l.size} items]`:l instanceof WeakMap||l instanceof WeakSet?"[WeakMap/WeakSet]":typeof l=="function"?"[Function]":typeof l=="symbol"?"[Symbol]":l},2);await navigator.clipboard.writeText(o),alert("Raw element data copied to clipboard!")}catch(t){console.error("Failed to copy raw data:",t),alert("Failed to copy data to clipboard. See console for details.")}},[H]),ir=d.useCallback(()=>{et||(po(!1),Tt(null))},[et]),Zr=d.useCallback(async()=>{if(!et){Xo(!0),Tt(null);try{let t=[];if(We==="selected"){if(!le.length)throw new Error("No properties available for the current selection.");t=le.map(A=>({path:A.label,value:A.value}))}else{if(!Ue)throw new Error("Select a model to export.");if(t=await sr(Ue),!t.length)throw new Error("No properties were found for the chosen model.")}const o=lr(t),n=new Blob([o],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(n),a=document.createElement("a"),y=We==="selected"?"selection":`model-${Ue}`,p=new Date().toISOString().replace(/[:.]/g,"-");a.href=l,a.download=`fragment-properties-${y}-${p}.csv`,document.body.appendChild(a),a.click(),document.body.removeChild(a),URL.revokeObjectURL(l),po(!1)}catch(t){console.warn("Failed to export properties",t),Tt(t.message??"Failed to export properties.")}finally{Xo(!1)}}},[lr,Ue,We,sr,et,le]),Fe=d.useCallback(t=>{const o=t??null;me(o);const{rows:n}=jt(o);if(Lr(n),Bo(ye.length?"favorites":"all"),n.length){Ho(n.map(y=>({path:y.label,value:y.value})));const l="Path	Value",a=n.map(y=>`${y.label}	${y.value??""}`);Uo([l,...a].join(`\r
`))}else Ho([]),Uo(null)},[ye.length]),Qr=d.useCallback(()=>{uo(t=>!t)},[]),en=d.useCallback(()=>{ao(!0),Go(t=>t+1)},[]),tn=d.useCallback(()=>{ao(!1)},[]),on=d.useCallback(()=>{ao(t=>{const o=!t;return o&&Go(n=>n+1),o})},[]),Ut=d.useCallback(t=>{if(!t||typeof t!="object")return"IfcProduct";if(t.constructor&&typeof t.constructor.name=="string"&&t.constructor.name.toUpperCase().startsWith("IFC")){const a=t.constructor.name.trim();if(a!=="Object"&&a!=="Array")return a}const o=Ee(t._category??t.category??t.Category??null);if(o&&o.trim().length&&o.toUpperCase().startsWith("IFC"))return o.trim();const n=[t.expressID!==void 0?null:t.type,t.ifcClass,t.IfcClass,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.ifcType,t.IfcType,t?.attributes?.ifcClass,t?.Attributes?.IfcClass];for(const a of n)if(typeof a=="string"&&a.trim().length){const y=a.trim();if(y.toUpperCase().startsWith("IFC")&&!y.toUpperCase().includes("IDENTIFIER")&&!y.toUpperCase().includes("LABEL")&&!y.toUpperCase().includes("TEXT"))return y}const l=be(t,["ifcclass","ifc type","express type"]);return l&&l.toUpperCase().startsWith("IFC")?l:"IfcProduct"},[]),Io=d.useCallback((t,o,n)=>{const l={},a={},y={};eo(t).forEach(C=>{const S=C.label.split("/").map(B=>B.trim()),D=C.rawPsetName??S[1]??"",$=C.rawPropertyName??S[S.length-1]??"",k=ut(D),P=ut($);if(!k||!P)return;a[k]||(a[k]={}),P in a[k]||(a[k][P]=C.value);const _=`${k}.${P}`;_ in l||(l[_]=C.value)}),l.GlobalId=o,l.ifcClass=n,y.ifcClass=n,y.GlobalId=o,l["Attributes.GlobalId"]=o,l["Attributes.IfcClass"]=n,l["Attributes.ifcClass"]=n;const A=Ve(t);A&&(y.Name=A,l["Attributes.Name"]=A);const x=be(t,["category","ifccategory"]);x&&(y.Category=x,l["Attributes.Category"]=x);const I=be(t,["type","typename"]);I&&(y.Type=I,l["Attributes.Type"]=I);for(const[C,S]of Object.entries(t??{})){if(S==null||typeof S!="object"||Array.isArray(S))continue;const D=Ee(S);if(!D)continue;const $=String(C).replace(/^_+/,""),k=`Attributes.${_e($)}`;if(k in l||(l[k]=D),$ in y||(y[$]=D),/guid|globalid|_guid/i.test(C)){const P=String(D).trim();P&&!l.GlobalId&&(l.GlobalId=P,y.GlobalId=P)}}return{flattened:l,psets:a,attributes:y}},[]),Co=d.useCallback(()=>{const t=c.current;return t?`${Array.from(t.list.keys()).sort().join("|")}|${E.length}`:"empty"},[E]),tt=d.useCallback(async()=>{const t=c.current;if(!t||t.list.size===0){const l={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Re.current=l,l}const o=Co();if(Re.current&&Re.current.signature===o)return Re.current;if(gt.current)return gt.current;const n=(async()=>{const l=new Map,a=[],y=new Map;for(const[A,x]of t.list){let I=[];try{const S=await x.getLocalIds();Array.isArray(S)?I=S:S&&typeof S[Symbol.iterator]=="function"&&(I=Array.from(S))}catch(S){console.warn(`IDS cache: failed to read local IDs for model ${A}`,S);continue}if(y.set(A,I.slice()),!I.length)continue;const C=48;for(let S=0;S<I.length;S+=C){const D=I.slice(S,S+C);let $=[];try{$=await x.getItemsData(D,$e)}catch(k){console.warn(`IDS cache: failed to fetch items data for model ${A}`,k);continue}$.forEach((k,P)=>{if(!k)return;const _=D[P],B=Ut(k),q=typeof k.GlobalId=="string"&&k.GlobalId.trim()||typeof k.GlobalID=="string"&&k.GlobalID.trim()||be(k,["globalid","global id","guid"]);if(!q){if(nl(B,k))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:A,localId:_,itemData:k});return}const G=q.trim();if(!G.length||l.has(G))return;const{flattened:T,psets:M,attributes:O}=Io(k,G,B),Y={GlobalId:G,ifcClass:B,properties:T},ee=k;(typeof ee.GlobalId!="string"||!ee.GlobalId.trim())&&(ee.GlobalId=G),l.set(G,{element:Y,modelId:A,localId:_,psets:M,attributes:O,raw:ee}),a.push(Y)})}}const p={signature:o,records:l,elements:a,modelLocalIds:y};return Re.current=p,p})().finally(()=>{gt.current=null});return gt.current=n,n},[Co,Io,Ut]),Ht=d.useCallback(async t=>{const o=new Map;console.log(`🔍 [groupLocalIdsByModel] Grouping ${t.length} GlobalIds...`);const n=Re.current;if(!n||n.records.size===0){console.warn("🔍 [groupLocalIdsByModel] Cache is empty, building full cache...");const l=await tt();return t.forEach(a=>{const y=l.records.get(a);if(!y){console.warn(`🔍 [groupLocalIdsByModel] GlobalId not found in cache: ${a}`);return}const p=o.get(y.modelId);p?p.push(y.localId):o.set(y.modelId,[y.localId])}),console.log(`🔍 [groupLocalIdsByModel] Grouped ${t.length} GlobalIds into ${o.size} models`),{grouped:o,cache:l}}return console.log(`🔍 [groupLocalIdsByModel] Using existing cache with ${n.records.size} elements`),t.forEach(l=>{const a=n.records.get(l);if(!a){console.warn(`🔍 [groupLocalIdsByModel] GlobalId not found in cache: ${l}`);return}const y=o.get(a.modelId);y?y.push(a.localId):o.set(a.modelId,[a.localId])}),console.log(`🔍 [groupLocalIdsByModel] Grouped ${t.length} GlobalIds into ${o.size} models`),{grouped:o,cache:n}},[tt]),So=Pt.useMemo(()=>({listGlobalIds:async()=>(await tt()).elements.map(o=>o.GlobalId),getSelectedGlobalIds:async()=>{console.log("📍 getSelectedGlobalIds called, selectedRef.current:",Ne.current);const t=Ne.current;if(!t||t.length===0)return console.log("📍 No selection found"),[];const o=c.current;if(!o)return console.warn("📍 Fragments not available"),[];console.log("📍 Processing selection:",t);const n=[];for(const l of t){const a=o.list.get(l.modelId);if(!a){console.warn("📍 Model not found for item:",l);continue}try{const[y]=await a.getItemsData([l.localId],{attributesDefault:!1});if(y){const p=be(y,["globalid","global id","guid"]);p&&typeof p=="string"?(n.push(p),console.log("📍 Found GlobalId for item:",l,"→",p)):console.warn("📍 No GlobalId found in data for item:",l)}}catch(y){console.error("📍 Error fetching data for item:",l,y)}}return console.log("📍 Final selectedGlobalIds:",n),n},getElementProps:async t=>{const o=Re.current;if(o){const a=o.records.get(t);if(a)return{ifcClass:a.element.ifcClass,psets:a.psets,attributes:a.attributes}}const l=(await tt()).records.get(t);if(!l)throw new Error(`Element with GlobalId ${t} is not available.`);return{ifcClass:l.element.ifcClass,psets:l.psets,attributes:l.attributes}},getElementPropsFast:async t=>{console.log("🔍 [getElementPropsFast] START for",t);const o=Ne.current,n=c.current;if(console.log("🔍 [getElementPropsFast] Selection:",o),console.log("🔍 [getElementPropsFast] Fragments available:",!!n),!n)throw console.error("🔍 [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");console.log("🔍 [getElementPropsFast] Searching in",o.length,"selected items");for(let l=0;l<o.length;l++){const a=o[l];console.log(`🔍 [getElementPropsFast] Checking item ${l+1}/${o.length}:`,a);const y=n.list.get(a.modelId);if(!y){console.log(`🔍 [getElementPropsFast] Model not found for ${a.modelId}`);continue}try{console.log(`🔍 [getElementPropsFast] Calling getItemsData for localId ${a.localId}...`);const[p]=await y.getItemsData([a.localId],$e);if(console.log("🔍 [getElementPropsFast] Got data:",!!p),p){console.log("🔍 [getElementPropsFast] Data keys:",Object.keys(p)),console.log("🔍 [getElementPropsFast] data._category:",p._category),console.log("🔍 [getElementPropsFast] data.ifcClass:",p.ifcClass),console.log("🔍 [getElementPropsFast] data.type:",p.type),console.log("🔍 [getElementPropsFast] data.constructor.name:",p.constructor?.name);const A=be(p,["globalid","global id","guid"]);if(console.log(`🔍 [getElementPropsFast] Element GlobalId: ${A}, looking for: ${t}`),A===t){console.log("🔍 [getElementPropsFast] MATCH! Extracting properties...");const x=Ut(p);console.log("🔍 [getElementPropsFast] ifcClass extracted:",x);const I={},C={};console.log("🔍 [getElementPropsFast] Calling collectIfcPropertySetRows...");const S=eo(p);console.log("🔍 [getElementPropsFast] Got",S.length,"property rows"),S.forEach(P=>{const _=P.label.split("/").map(M=>M.trim()),B=P.rawPsetName??_[1]??"",q=P.rawPropertyName??_[_.length-1]??"",G=ut(B),T=ut(q);!G||!T||(I[G]||(I[G]={}),T in I[G]||(I[G][T]=P.value))}),console.log("🔍 [getElementPropsFast] Extracted",Object.keys(I).length,"psets"),C.ifcClass=x,C.GlobalId=t;const D=Ve(p);D&&(C.Name=D);const $=be(p,["category","ifccategory"]);$&&(C.Category=$);const k=be(p,["type","typename"]);return k&&(C.Type=k),console.log(`📌 Fast props for ${t}:`,{ifcClass:x,psetCount:Object.keys(I).length}),console.log("🔍 [getElementPropsFast] SUCCESS - returning properties"),{ifcClass:x,psets:I,attributes:C}}}}catch(p){console.error("🔍 [getElementPropsFast] Error for item:",a,p)}}return console.log(`📌 ${t} not in selection, falling back to cache`),console.log("🔍 [getElementPropsFast] FALLBACK to getElementProps"),yt.current.getElementProps(t)},countElements:async()=>(await tt()).elements.length,iterElements:t=>{const o=Math.max(1,Math.floor(t?.batchSize??100));return{async*[Symbol.asyncIterator](){const n=await tt(),l=Array.from(n.records.values());for(let a=0;a<l.length;a+=o){const y=l.slice(a,a+o).map(p=>({modelId:p.modelId,localId:p.localId,data:{...p.raw,GlobalId:p.element.GlobalId}}));y.length&&(yield y)}}}},addToCache:async t=>{console.log(`📦 [addToCache] Adding ${t.length} elements to cache`);const o=c.current;if(!o){console.warn("📦 [addToCache] Fragments not available");return}let n=Re.current;n||(n={signature:Co(),records:new Map,elements:[],modelLocalIds:new Map},Re.current=n);const l=Ne.current;console.log(`📦 [addToCache] Selection has ${l.length} items`);for(const a of t){if(n.records.has(a)){console.log(`📦 [addToCache] ${a} already in cache, skipping`);continue}console.log(`📦 [addToCache] Searching for ${a} in ${l.length} selected items...`);let y=!1;for(const p of l){console.log(`📦 [addToCache] Checking item: modelId=${p.modelId}, localId=${p.localId}`);const A=o.list.get(p.modelId);if(!A){console.log(`📦 [addToCache] Model not found: ${p.modelId}`);continue}try{const[x]=await A.getItemsData([p.localId],$e);if(x){let I=x._guid||x.GlobalId;if(I&&typeof I=="object"&&(I=I.value||I),console.log(`📦 [addToCache] Item GlobalId: ${I}, looking for: ${a}, match: ${I===a}`),I===a){const C=Ut(x),S={};eo(x).forEach(T=>{const M=T.label.split("/").map(se=>se.trim()),O=T.rawPsetName??M[1]??"",Y=T.rawPropertyName??M[M.length-1]??"",ee=ut(O),J=ut(Y);!ee||!J||(S[ee]||(S[ee]={}),J in S[ee]||(S[ee][J]=T.value))});const $={ifcClass:C,GlobalId:a},k=Ve(x);k&&($.Name=k);const P=be(x,["category","ifccategory"]);P&&($.Category=P);const _=be(x,["type","typename"]);_&&($.Type=_);const B={GlobalId:a,ifcClass:C,properties:Io(x,a,C)},q={element:B,modelId:p.modelId,localId:p.localId,psets:S,attributes:$,raw:x};n.records.set(a,q),n.elements.push(B);const G=n.modelLocalIds.get(p.modelId)||[];G.push(p.localId),n.modelLocalIds.set(p.modelId,G),console.log(`📦 [addToCache] Added ${a} to cache (model: ${p.modelId}, localId: ${p.localId})`),y=!0;break}}}catch(x){console.debug("📦 [addToCache] Error checking selection item:",x)}}y||console.warn(`📦 [addToCache] Could not find ${a} in selection`)}console.log(`📦 [addToCache] Cache now has ${n.records.size} elements`)},color:async(t,o)=>{if(!t.length)return;const n=Be.current,l=c.current,a=i.current;if(!n||!h.current||!l||!a)return;console.log(`🎨 [color] Called with ${t.length} GlobalIds, rgba:`,o);let y,p;try{console.log("🎨 [color] Calling groupLocalIdsByModel...");const I=await Ht(t);y=I.grouped,p=I.cache,console.log(`🎨 [color] groupLocalIdsByModel returned ${y.size} models`)}catch(I){console.error("🎨 [color] groupLocalIdsByModel failed:",I);return}const A=new Le(o.r,o.g,o.b),x=A.getHex();console.log(`🎨 [color] Grouped into ${y.size} models, colorHex: ${x.toString(16)}`),Rt.current||(Rt.current=new Map);for(const[I,C]of y){const S=l.list.get(I);if(!(!S||!C.length)){console.log(`🎨 [color] Processing model ${I} with ${C.length} localIds`);try{const D=Array.from(C);if(typeof n.add=="function")try{if(console.log(`🎨 [color] Trying highlighter.add with colorHex: ${x.toString(16)}`),n.add(S,D,x),console.log(`✅ Successfully colored ${D.length} elements in model ${I} using add method`),a&&typeof a.update=="function")try{a.update(),console.log("🎨 [color] Forced world update")}catch($){console.debug("World update failed:",$)}continue}catch($){console.debug("add failed:",$)}if(typeof n.highlightById=="function")try{console.log("🎨 [color] Trying highlightById..."),await n.highlightById(S,D,x),console.log(`✅ Successfully colored ${D.length} elements in model ${I} using highlightById`);continue}catch($){console.debug("highlightById failed:",$)}if(typeof n.highlightByID=="function")try{console.log("🎨 [color] Trying highlightByID..."),await n.highlightByID(S,D,x),console.log(`✅ Successfully colored ${D.length} elements in model ${I} using highlightByID`);continue}catch($){console.debug("highlightByID failed:",$)}if(n.styles&&typeof n.styles.set=="function")try{if(!D||D.length===0){console.debug(`Skipping highlight for model ${I} - no IDs`);continue}const $=`ids-color-${x.toString(16).padStart(6,"0")}`;if(n.styles.set($,{color:A,fillOpacity:1}),typeof n.create=="function")try{(!n.list||!n.list.has($))&&n.create($)}catch(k){console.debug("highlighter.create failed:",k)}if(typeof n.select=="function")try{n.select(S,D,$)}catch(k){throw console.debug("highlighter.select failed:",k),k}console.log(`✅ Successfully colored ${D.length} elements in model ${I} using styles.set`);continue}catch($){console.debug("styles.set failed:",$)}console.warn(`❌ Could not color model ${I} - all highlighter methods failed`)}catch(D){console.error(`Failed to color model ${I}:`,D)}}}},clearColors:async()=>{const t=Be.current;if(h.current){try{t&&(typeof t.clear=="function"&&(await Promise.resolve(t.clear()),console.log("Cleared highlighter colors using clear()")),t.styles&&typeof t.styles.clear=="function"&&(t.styles.clear(),console.log("Cleared highlighter styles")))}catch(o){console.warn("Failed to clear IDS highlights",o)}Rt.current&&Rt.current.clear();try{const o=Ae.current;if(o&&o.mesh&&o.mesh.instanceColor){const n=new Le(1,1,1);o.mesh.setColorAt(o.index,n),o.mesh.instanceColor.needsUpdate=!0}}catch(o){console.warn("Failed to reset instanced mesh highlight",o)}Ae.current=null}},isolate:async t=>{const o=Ge.current,n=c.current;if(!o||!n||!h.current||(await Promise.resolve(o.set(!0)),!t.length||!h.current))return;const{grouped:l}=await Ht(t);if(l.size===0){console.warn("isolate: No elements found in cache for isolation");return}const a=new Map;l.forEach((p,A)=>{a.set(A,new Set(p))});const y={};for(const[p,A]of a.entries()){const x=n.list.get(p);if(x)try{let I=[];const C=await x.getLocalIds();Array.isArray(C)?I=C:C&&typeof C[Symbol.iterator]=="function"&&(I=Array.from(C));const S=I.filter(D=>!A.has(D));S.length>0&&(y[p]=new Set(S))}catch(I){console.error("isolate: Failed to get local IDs for model",p,I)}}Object.keys(y).length>0&&await Promise.resolve(o.set(!1,y))},clearIsolation:async()=>{const t=Ge.current;t&&await Promise.resolve(t.set(!0))},fitViewTo:async t=>{if(!t.length)return;const o=i.current,n=c.current;if(!o||!n||!h.current)return;const l=o.camera??null,a=l?.controls??null,y=l?.three??null,{grouped:p}=await Ht(t),A=new Te;let x=!1;for(const[$,k]of p.entries()){const P=n.list.get($);if(!P||!P.object)continue;const _=new Te().setFromObject(P.object);_.isEmpty()||(x?A.union(_):(A.copy(_),x=!0))}if(!x)return;const I=new Z,C=new Z;A.getCenter(I),A.getSize(C);const D=(Math.max(C.x,C.y,C.z)||10)*1.5;a?a.setLookAt(I.x+D,I.y+D,I.z+D,I.x,I.y,I.z,!0):y&&(y.position.set(I.x+D,I.y+D,I.z+D),y.lookAt(I))}}),[tt,Ht]);yt.current=So;const ar=d.useCallback(()=>{Nt(!0),co(t=>t+1)},[]),rn=d.useCallback(()=>{Nt(!1);const t=yt.current;t&&(Promise.resolve(t.clearColors()).catch(()=>{}),t.clearIsolation&&Promise.resolve(t.clearIsolation()).catch(()=>{}))},[]),nn=d.useCallback(()=>{Nt(t=>{const o=!t;return o&&co(n=>n+1),o})},[]),sn=d.useCallback(async t=>{try{const{setIdsXmlText:o,runCheck:n}=await kt(()=>Promise.resolve().then(()=>Us),void 0).then(l=>l.idsStore);o(t),Nt(!0),co(l=>l+1),setTimeout(async()=>{yt.current&&await n(yt.current)},100)}catch(o){console.error("Failed to validate from IDS Creator:",o),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Ne.current=w},[w]),d.useEffect(()=>{Re.current=null,gt.current=null;try{$r.invalidateCaches()}catch(t){console.warn("Failed to invalidate IDS caches",t)}},[E]),d.useEffect(()=>{const t=e.current;if(!t)return;let o=!1;No.current||(ts.init(),os.init(),No.current=!0);try{t.replaceChildren()}catch{}const n=new rs;u.current=n;const a=n.get(ns).create();a.name="main",a.scene=new ss(n),a.scene.setup(),a.renderer=new ls(n,t),a.camera=new is(n),a.camera.controls?.setLookAt(10,10,10,0,0,0),a.camera.three.near=.1,a.camera.three.far=1e9,a.camera.three.updateProjectionMatrix();const y=new ps(16777215,1);a.scene.three.add(y),i.current=a;const p=new Rn;p.showPanel(2),p.dom.style.position="absolute",p.dom.style.left="8px",p.dom.style.top="8px",p.dom.style.zIndex="1000",t.appendChild(p.dom),a.renderer.onBeforeUpdate.add(()=>p.begin()),a.renderer.onAfterUpdate.add(()=>p.end());let A=null;const x=async M=>{if(!h.current)return;const O=[];for(const[W,ae]of Object.entries(M))ae.forEach(ue=>{Number.isInteger(ue)&&O.push({modelId:W,localId:ue})});const Y=Ne.current;if(!!vr(O,Y))return;z(O),at();const J=c.current;if(!J||!O.length){Fe(null);return}const se=O[0],X=J.list.get(se.modelId);if(!X){Fe(null);return}try{const[W]=await X.getItemsData([se.localId],$e);Fe(W||null)}catch(W){console.warn("Failed to fetch properties for selection",W)}},I=()=>{z([]),Fe(null)};(async()=>{try{await Promise.resolve(n.init())}catch(X){console.error("Failed to initialize viewer components",X);return}if(o)return;try{n.get(as).create(a)}catch(X){console.warn("Failed to create grid component",X)}const O=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),Y=URL.createObjectURL(new File([O],"worker.mjs",{type:"text/javascript"}));j.current=Y;const ee=n.get(cs);await ee.init(Y),c.current=ee,h.current=!0;const J=n.get(ds);J.setup({world:a}),J.zoomToSelection=!0;try{typeof J.create=="function"&&J.create("select")}catch{}Be.current=J;const se=n.get(us);Ge.current=se;try{const X=n.get(fs);if(X.world=a,X.color=new Le("#ff0000"),"snapDistance"in X&&(X.snapDistance=.5),"preview"in X){const W=X.preview;W&&(W.enabled=!0,W.color&&(W.color=new Le("#00ff00")))}if("workingPlane"in X){const W=X.workingPlane;W&&typeof W=="object"&&(W.visible=!0)}X.list?.onItemAdded&&X.list.onItemAdded.add(W=>{const ae=W.value||W.distance?.()||0;console.log(`✅ Measurement created: ${ae.toFixed(3)} units`),er(ae.toFixed(3)),W.dimensionLabel&&(W.dimensionLabel.visible=!0)}),X.enabled=!1,Vt.current=X,console.log("✅ Measurement tool initialized:",X),console.log("Measurement tool properties:",Object.keys(X))}catch(X){console.error("Failed to initialize measurement tool:",X)}J.events.select.onHighlight.add(x),J.events.select.onClear.add(I),A=()=>{J.events.select.onHighlight.remove?.(x),J.events.select.onClear.remove?.(I)},He()?.controls?.addEventListener("rest",()=>ee.core.update(!0));try{const W=(await kt(()=>import("./thatopen-vendor-CcC7XCOM.js").then(fe=>fe.i),__vite__mapDeps([3,4,1]))).IfcImporter,ae=new W,ue="/Fragments-AI-viewer/";ae.wasm={path:`${ue}web-ifc/`,absolute:!0},b.current=ae}catch(X){console.warn("Failed to lazy-load FRAGS.IfcImporter:",X)}o||Xe(!0)})().catch(M=>{console.error("Failed to initialize viewer fragments",M)});const S=document.createElement("canvas");S.width=110,S.height=110,S.className="nav-cube",t.appendChild(S),ro.current=S;const D=new ms,$=new hs(35,1,.1,100);$.position.set(0,0,5);const k=new gs({canvas:S,alpha:!0,antialias:!0});k.setPixelRatio(window.devicePixelRatio),k.setSize(110,110);const P=new ys(1.4,1.4,1.4),_=new zo(P,new bs({flatShading:!0}));D.add(_);const B=new xs(16777215,.8);B.position.set(5,10,7),D.add(B),Ye.current={scene:D,camera:$,renderer:k,cube:_},a.renderer.onAfterUpdate.add(()=>{const M=Ye.current;if(!M)return;const O=go();O&&(M.cube.quaternion.copy(O.quaternion),M.renderer.render(M.scene,M.camera))});const q=new wr,G=new Ir,T=async M=>{const O=Ye.current;if(!O)return;const Y=S.getBoundingClientRect();G.x=(M.clientX-Y.left)/Y.width*2-1,G.y=-((M.clientY-Y.top)/Y.height)*2+1,q.setFromCamera(G,O.camera);const ee=q.intersectObject(O.cube,!0)[0];if(!ee||!ee.face)return;const J=ee.face.normal.clone().transformDirection(O.cube.matrixWorld),se=new Z,X=c.current,W=He(),ae=W?.controls??null,ue=W?.three??null;if(!ae&&!ue){console.warn("Navigation cube interaction skipped: viewer camera not ready.");return}if(X&&X.list.size){const St=new Te;for(const En of X.list.values())St.expandByObject(En.object);St.getCenter(se);const cr=new Cr;St.getBoundingSphere(cr);const jn=Math.max(3,cr.radius*3),ct=se.clone().add(J.multiplyScalar(jn));ae?await ae.setLookAt(ct.x,ct.y,ct.z,se.x,se.y,se.z,!0):ue&&(ue.position.set(ct.x,ct.y,ct.z),ue.lookAt(se));return}const fe=J.clone().multiplyScalar(10);ae?await ae.setLookAt(fe.x,fe.y,fe.z,0,0,0,!0):ue&&(ue.position.set(fe.x,fe.y,fe.z),ue.lookAt(0,0,0))};return S.addEventListener("click",T),()=>{o=!0,(async()=>{const M=h.current;h.current=!1,A?.(),A=null;try{M&&await Ge.current?.set?.(!0)}catch{}if(c.current){const O=[...c.current.list.keys()];await Promise.all(O.map(Y=>c.current.core.disposeModel(Y)))}try{M&&Be.current?.clear?.()}catch{}j.current&&URL.revokeObjectURL(j.current);try{n.dispose()}catch{}try{t.replaceChildren()}catch{}Be.current=null,Ge.current=null})()}},[]),d.useEffect(()=>{if(!ve)return;const t=u.current,o=c.current;if(!t||!o)return;const n=Wt,l=(a,y,p)=>{if(!a)return;let A=y.current;A||(A=p(),y.current=A),A&&A.parentElement!==a&&a.replaceChildren(A)};l(Lo.current,Ke,()=>{const[a,y]=xr.modelsList({components:t});return lo.current=y,a}),Ke.current&&((!Ke.current.dataset.initialized||n!==Oo.current)&&lo.current?.({components:t}),Ke.current.dataset.initialized||(Ke.current.dataset.initialized="true",Ke.current.style.width="100%")),Mt.current!==To.current&&(io.current=null,ht.current=null,To.current=Mt.current),l(Mt.current,io,()=>{const[a,y]=xr.spatialTree({components:t,models:Array.from(o.list.values())});ht.current=y,a.style.width="100%",a.style.height="100%",a.style.overflow="auto";const p=a;return p.queryString=st.trim()?st.trim():null,a}),ht.current&&ht.current({components:t,models:Array.from(o.list.values())}),Oo.current=n},[ve,oe,st,Wt]),d.useEffect(()=>{if(!ve)return;const t=u.current,o=c.current,n=ht.current;!t||!o||!n||n({components:t,models:Array.from(o.list.values())})},[ve,Wt]),d.useEffect(()=>{const t=io.current;if(!t)return;const o=st.trim();t.queryString=o||null},[st]);const ln=async()=>{const t=s.current,o=t?.files?.[0];if(!o)return;const n=o.name.split(".").pop()?.toLowerCase(),l=c.current,a=b.current,y=i.current;if(!l||!y){alert("Viewer is still initializing. Please try again in a moment."),t&&(t.value="");return}const p=He(),A=p?.three??null,x=p?.controls??null;let I=!1;try{const C=`${o.name}-${Date.now()}`;let S;if(n==="ifc"){if(!a)throw new Error("IFC importer is not ready.");ge(0),I=!0,we.current=!1,nt(!1);const P=new AbortController;De.current=P;const _=new Uint8Array(await o.arrayBuffer()),B=await a.process({bytes:_,progressCallback:(G,T)=>{if(we.current)return;const M=typeof G=="number"?G:0,O=M<=1?M*100:M,Y=Math.max(0,Math.min(100,O));ge(Number(Y.toFixed(1))),console.log(`IFC conversion progress: ${Y.toFixed(1)}%`,T)},signal:P.signal});if(we.current)throw{__cancelled:!0};let q;if(B instanceof ArrayBuffer){const G=new Uint8Array(B),T=new Uint8Array(G.byteLength);T.set(G),q=T.buffer}else if(B instanceof Uint8Array){const G=new Uint8Array(B.byteLength);G.set(B),q=G.buffer}else{const G=B,T=new Uint8Array(G),M=new Uint8Array(T.byteLength);M.set(T),q=M.buffer}S=await l.core.load(q,{modelId:C})}else if(n==="frag"){const P=await o.arrayBuffer();S=await l.core.load(P,{modelId:C})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}m.current=C,A?S.useCamera(A):console.warn("World camera not ready; skipping model camera binding."),y.scene.three.add(S.object),await l.core.update(!0),await new Promise(P=>requestAnimationFrame(()=>P()));const D=new Te().setFromObject(S.object),$=new Z;D.getCenter($),(Math.abs($.x)>1e6||Math.abs($.y)>1e6||Math.abs($.z)>1e6)&&S.object.position.sub($);try{x&&await x.fitToBox(S.object,!0)}catch{const P=new Z;D.getSize(P);const B=(Math.max(P.x,P.y,P.z)||10)*2.5;x?x.setLookAt($.x+B,$.y+B,$.z+B,$.x,$.y,$.z,!0):A&&(A.position.set($.x+B,$.y+B,$.z+B),A.lookAt($))}Ur(P=>({...P,[C]:Js(C,o.name,S.object)})),R(!0),L(P=>[...P,{id:C,label:o.name}]),at();const k=u.current;k&&lo.current?.({components:k}),I&&ge(100)}catch(C){C&&(C.__cancelled||C?.name==="AbortError")?console.info("IFC conversion cancelled by user."):(console.error(C),alert("Failed to load model. See console for more details.")),R(!1)}finally{t&&(t.value=""),I&&setTimeout(()=>ge(null),200),De.current=null,nt(!1)}},an=d.useCallback(()=>{if(V!==null){we.current=!0,nt(!0);try{De.current?.abort()}catch{}ge(null)}},[V]),at=d.useCallback(()=>{Q(!0),K(!1)},[]),cn=d.useCallback(()=>{Q(t=>{const o=!t;return o&&K(!1),o})},[]),dn=d.useCallback(()=>{Q(!1)},[]),un=d.useCallback(()=>{K(t=>!t)},[]),qt=d.useMemo(()=>Math.min(360,Math.max(180,zt.height*.45)),[zt.height]),fn=+!Ze+ +!Qe,Me=!Dt&&fn===0;d.useEffect(()=>{const t=Ke.current;t&&(t.style.width="100%",t.style.maxHeight=Me?"100%":`${qt}px`,t.style.height=Me?"100%":"auto")},[Me,qt,Wt]);const pn=d.useCallback(async t=>{const o=k=>{const P=[],_=new Set;if(!k||typeof k!="object")return{terms:P,modelIds:_};for(const[B,q]of Object.entries(k)){if(q==null)continue;const G=B.trim().toLowerCase(),T=Array.isArray(q)?q:[q];if(T.length){if(G==="modelid"||G==="modelids"||G==="model"){for(const M of T){const O=typeof M=="string"?M.trim():String(M??"").trim();O&&_.add(O)}continue}if(["text","query","keyword","search"].includes(G)){for(const M of T){if(M==null)continue;const O=typeof M=="string"?M.trim().toLowerCase():String(M??"").trim().toLowerCase();O&&P.push({type:"text",value:O})}continue}for(const M of T){if(M==null)continue;let O=null;typeof M=="string"?O=M.trim():(typeof M=="number"||typeof M=="boolean")&&(O=String(M)),O&&P.push({type:"field",key:G,value:O.toLowerCase()})}}}return{terms:P,modelIds:_}},n=c.current;if(!n){console.warn("AI selection requested but fragments are unavailable.");return}if(!h.current){console.warn("AI selection requested before fragments were fully initialized.");return}const l=Be.current,a=Ge.current,{terms:y,modelIds:p}=o(t.filter),A=t.mode?.toLowerCase?.(),x=A==="isolate"||A==="focus";if(t.action==="clear"){try{l?.clear?.()}catch{}if(a)try{await a.set(!0)}catch(k){console.warn("Failed to reset visibility while clearing AI selection",k)}try{const k=Ae.current;if(k&&k.mesh&&k.mesh.instanceColor){const P=new Le(1,1,1);k.mesh.setColorAt(k.index,P),k.mesh.instanceColor.needsUpdate=!0}}catch{}Ae.current=null,Pe.current&&(Pe.current.visible=!1),z([]),Fe(null);return}if(y.length===0){console.warn("AI selection command did not include usable filters",t);return}const I=++At.current,C=[],S=60;for(const k of n.list.values()){const P=typeof k?.modelId=="string"?k.modelId:"";if(p.size&&!p.has(P))continue;let _=[];try{const q=await k.getLocalIds();Array.isArray(q)?_=q.slice():q&&typeof q[Symbol.iterator]=="function"&&(_=Array.from(q))}catch(q){console.warn("Failed to fetch local IDs for model",P,q)}const B={model:k,modelId:P,allIds:_,matched:new Set};if(C.push(B),!!_.length)for(let q=0;q<_.length;q+=S){if(I!==At.current)return;const G=_.slice(q,q+S);let T=[];try{T=await k.getItemsData(G,$e)}catch(M){console.warn("Failed to retrieve property batch for AI selection",M);continue}G.forEach((M,O)=>{const Y=T?.[O];if(!Y)return;let ee=[];try{ee=jt(Y).rows}catch(W){console.warn("Failed to build property rows for AI selection",W)}const J=ee.map(W=>W.searchText),se=oo(Y,6e3).toLowerCase();y.every(W=>{if(W.type==="text")return J.some(fe=>fe.includes(W.value))||se.includes(W.value);const ae=Ys[W.key]??[W.key];return J.some(fe=>ae.some(St=>fe.includes(St))&&fe.includes(W.value))?!0:ae.some(fe=>se.includes(fe)&&se.includes(W.value))})&&B.matched.add(M)})}}if(I!==At.current)return;const D=C.filter(k=>k.matched.size>0);if(!D.length){console.info("AI selection produced no matches for command",t);return}try{const k=Ae.current;if(k&&k.mesh&&k.mesh.instanceColor){const P=new Le(1,1,1);k.mesh.setColorAt(k.index,P),k.mesh.instanceColor.needsUpdate=!0}}catch{}if(Ae.current=null,Pe.current&&(Pe.current.visible=!1),a)try{await a.set(!0)}catch(k){console.warn("Failed to reset hidden state before AI selection",k)}if(l){try{l.clear?.()}catch{}const k=x?16754240:6737151;for(const P of D){const _=Array.from(P.matched);if(_.length)try{typeof l.highlightById=="function"?await l.highlightById(P.model,_,k):typeof l.highlightByID=="function"?await l.highlightByID(P.model,_,k):typeof l.add=="function"&&l.add(P.model,_,k)}catch(B){console.warn("Failed to apply AI highlight for model",P.modelId,B)}}}if(x&&a){const k={};for(const P of C){if(!P.allIds.length||P.matched.size===P.allIds.length)continue;const _=P.allIds.filter(B=>!P.matched.has(B));_.length&&(k[P.modelId]=new Set(_))}if(Object.keys(k).length)try{await a.set(!1,k)}catch(P){console.warn("Failed to isolate AI-selected elements",P)}}const $=D.flatMap(k=>Array.from(k.matched).map(P=>({modelId:k.modelId,localId:P})));z($),at();try{const k=D[0],P=Array.from(k.matched)[0];if(P!==void 0){const[_]=await k.model.getItemsData([P],$e);I===At.current&&Fe(_||null)}}catch(k){console.warn("Failed to fetch properties for AI selection result",k)}},[at,z,Fe]),Xt=d.useCallback(t=>{if(!Ft.current)return;const o=no.current;if(!o)return;const n=t.clientX-o.startX,l=t.clientY-o.startY,a=280,y=260;Nr(p=>{const A=o.width,x=o.height,I=Math.max(a,A+n),C=Math.max(y,x+l);return I===p.width&&C===p.height?p:{width:Math.round(I),height:Math.round(C)}})},[]),Ct=d.useCallback(()=>{Ft.current&&(Ft.current=!1,no.current=null,window.removeEventListener("pointermove",Xt),window.removeEventListener("pointerup",Ct))},[Xt]),mn=d.useCallback(t=>{t.preventDefault(),t.stopPropagation();const o=so.current;o&&(Ft.current=!0,no.current={startX:t.clientX,startY:t.clientY,width:o.offsetWidth,height:o.offsetHeight},window.addEventListener("pointermove",Xt),window.addEventListener("pointerup",Ct))},[Xt,Ct]);d.useEffect(()=>()=>{Ct()},[Ct]);const hn=d.useCallback(async()=>{const t=c.current,o=[];if(!t||t.list.size===0||E.length===0)o.push("No models are currently loaded in the viewer.");else{o.push(`Loaded models (${E.length}): ${E.map(l=>`${l.label} [${l.id}]`).join(", ")}`),o.push(`Fragments models in memory: ${t.list.size}`);try{const l=new Te;for(const y of t.list.values())l.expandByObject(y.object);const a=new Z;l.getSize(a),o.push(`Scene bounds approx size => x:${a.x.toFixed(2)} y:${a.y.toFixed(2)} z:${a.z.toFixed(2)}`)}catch(l){console.warn("Failed to compute bounds for AI context",l)}const n=E.map(l=>Wo[l.id]).filter(l=>!!l);if(n.length){let l=0;const a=new Map;o.push("Model geometry snapshots:");for(const p of n){l+=p.elementCount;for(const{category:x,count:I}of p.categoryCounts)a.set(x,(a.get(x)??0)+I);const A=p.categoryCounts.slice(0,5).map(({category:x,count:I})=>`${x}: ${I}`);o.push(`- ${p.label} [${p.modelId}] → elements≈${p.elementCount}, instanced≈${p.instancedCount}, meshes≈${p.meshCount}`),A.length&&o.push(`  top categories: ${A.join(" | ")}`),o.push(`  bbox size (approx): x:${p.bboxSize.x.toFixed(2)} y:${p.bboxSize.y.toFixed(2)} z:${p.bboxSize.z.toFixed(2)}`)}const y=Array.from(a.entries()).sort((p,A)=>A[1]-p[1]).slice(0,10).map(([p,A])=>`${p}: ${A}`);o.push(`Global approx element total: ${l}`),y.length&&o.push(`Global top categories: ${y.join(" | ")}`)}else o.push("Geometry summaries are initializing — load a model or wait a moment after loading.")}if(w.length){o.push(`Active selection count: ${w.length}`);for(let n=0;n<w.length;n+=1){const l=w[n];o.push(`Selection #${n+1} → modelId:${l.modelId}, localId:${l.localId}`);let a=null;if(n===0&&H&&Object.keys(H).length)a=H;else if(t){const y=t.list.get(l.modelId);if(y)try{const[p]=await y.getItemsData([l.localId],$e);a=p||null}catch(p){console.warn("Failed to fetch properties for AI context (multi)",p)}}if(a){o.push("  Property snapshot (compact JSON):"),o.push(`  ${oo(a,4e3)}`);const y=jt(a).rows;if(y.length){o.push(`  Flattened properties (${y.length} entries):`);for(const p of y.slice(0,120))o.push(`  - ${p.label}: ${p.value}`);y.length>120&&o.push(`  (Truncated ${y.length-120} additional properties)`)}}else o.push("  Properties for this selection are not available yet.")}}else if(o.push("No active selection — exporting properties for every loaded element."),t&&t.list.size)for(const n of E){const l=t.list.get(n.id);if(!l){o.push(`Model ${n.label} [${n.id}] could not be found in the fragments registry.`);continue}try{const a=await l.getLocalIds(),y=Array.isArray(a)?a:a?Array.from(a):[];if(!y||y.length===0){o.push(`Model ${n.label} [${n.id}] has no retrievable local IDs.`);continue}o.push(`Model ${n.label} [${n.id}] — enumerating ${y.length} items:`);const p=y.length<=40?12:y.length<=120?6:3,A=50;for(let x=0;x<y.length;x+=A){const I=y.slice(x,x+A);let C=[];try{C=await l.getItemsData(I,$e)}catch(S){const D=I[0],$=I[I.length-1];o.push(`  Failed to retrieve properties for items ${D}–${$}: ${S?.message??S}`);continue}I.forEach((S,D)=>{const $=C?.[D];if(!$){o.push(`- localId:${S} (no data available)`);return}const k=el($,p).replace(/\s+/g," ").trim();o.push(`- localId:${S} | ${k}`)})}}catch(a){o.push(`Failed to enumerate items for model ${n.label} [${n.id}]: ${a?.message??a}`)}}else o.push("Fragments data is not available to enumerate model items.");if(xt.length){o.push("ItemsData extracted name/value pairs (last selection):");const n=150,l=xt.slice(0,n);for(const a of l)o.push(`- ${a.path}: ${a.value}`);xt.length>n&&o.push(`(Truncated ${xt.length-n} additional rows)`)}return fo&&(o.push("ItemsData table snapshot for last selection (tab-separated):"),o.push(fo)),o.length===0&&o.push("Viewer is idle: no models or selections to describe."),o.join(`
`)},[E,w,H,le,Wo,fo,xt]),gn=d.useCallback(async()=>{const t=i.current,o=c.current,n=m.current;if(!t||!o||!n||!h.current)return;const l=o.list.get(n);if(!l)return;await o.core.update(!0),await new Promise(p=>requestAnimationFrame(()=>p()));const a=l.object,y=new Te().setFromObject(a);if(!y.isEmpty()){const p=He(),A=p?.controls??null,x=p?.three??null;try{A&&await A.fitToBox(a,!0)}catch{const C=new Z,S=new Z;y.getCenter(C),y.getSize(S);const $=(Math.max(S.x,S.y,S.z)||10)*2.5;A?A.setLookAt(C.x+$,C.y+$,C.z+$,C.x,C.y,C.z,!0):x&&(x.position.set(C.x+$,C.y+$,C.z+$),x.lookAt(C))}}},[]),yn=d.useCallback(async()=>{const t=Ne.current,o=Ge.current;if(!t||t.length===0||!o||!h.current){Ie(null);return}const n={};for(const l of t)n[l.modelId]||(n[l.modelId]=new Set),n[l.modelId].add(l.localId);try{await o.set(!1,n);try{Be.current?.clear?.()}catch{}z([]),Fe(null)}catch(l){console.warn("Failed to hide selected element",l)}finally{Ie(null)}},[Ie,z,Fe]),bn=d.useCallback(async()=>{const t=Ge.current;if(!t||!h.current){Ie(null);return}try{await t.set(!0)}catch(o){console.warn("Failed to reset hidden items",o)}finally{Ie(null)}},[Ie]),xn=d.useCallback(()=>{Ie(null)},[Ie]);d.useEffect(()=>{const t=e.current,o=i.current;if(!t||!o)return;const n=o.renderer?.three.domElement;if(!n)return;const l=new Ir,a=async(C,S)=>{const D=c.current;if(!D)return;const $=go();if(!$){console.warn("Picking skipped: viewer camera not ready.");return}const k=n.getBoundingClientRect();l.x=(C-k.left)/k.width*2-1,l.y=-((S-k.top)/k.height)*2+1;let P=null;const _=new wr;_.setFromCamera(l,$);for(const T of D.list.values()){const M=await T.raycast({camera:$,mouse:l,dom:o.renderer.three.domElement});if(M&&typeof M.distance=="number"){const O=M.point instanceof Z?M.point.clone():_.ray.at(M.distance,new Z);(!P||M.distance<P.dist)&&(P={dist:M.distance,model:T,localId:M.localId,point:O,object:M.object,instanceId:M.instanceId})}}if(!P)return;let B=!1;try{const T=Be.current;if(T){try{T.clear?.()}catch{}const M=6737151;typeof T.highlightById=="function"?(await T.highlightById(P.model,[P.localId],M),B=!0):typeof T.highlightByID=="function"?(await T.highlightByID(P.model,[P.localId],M),B=!0):typeof T.add=="function"?(T.add(P.model,[P.localId],M),B=!0):typeof T.select=="function"&&P.object&&(T.select(P.object,P.instanceId),B=!0)}}catch{}if(!B)try{const T=P.object,M=P.instanceId;if(T&&T.isInstancedMesh&&Number.isInteger(M)){const O=Ae.current;if(O&&O.mesh&&O.mesh.instanceColor){const J=new Le(1,1,1);try{O.mesh.setColorAt(O.index,J),O.mesh.instanceColor.needsUpdate=!0}catch{}}const Y=T,ee=new Le(6737151);try{Y.setColorAt(M,ee),Y.instanceColor.needsUpdate=!0}catch{}Ae.current={mesh:Y,index:M}}}catch{}try{const T=P.point??new Z;let M=Pe.current;if(!M){M=new ws;const ee=new Te,J=c.current;if(J&&J.list.size)for(const fe of J.list.values())ee.expandByObject(fe.object);const se=new Cr;ee.getBoundingSphere(se);const X=isFinite(se.radius)&&se.radius>0?se.radius*.01:.3,W=Math.max(.05,Math.min(2,X)),ae=new zo(new Is(W*.5,16,16),new Sr({color:16763904,depthTest:!1})),ue=new zo(new Cs(W*.8,W,32),new Sr({color:16772744,side:Ss,depthTest:!1,transparent:!0,opacity:.9}));ue.rotation.x=Math.PI/2,ae.renderOrder=999,ue.renderOrder=999,M.add(ae),M.add(ue),o.scene.three.add(M),Pe.current=M}M.position.copy(T);const O=M.children[1],Y=go();Y&&O.lookAt(Y.position),M.visible=!0}catch{}const q=Ne.current,G=[{modelId:P.model.modelId,localId:P.localId}];if(!vr(G,q)){z(G),at();try{const[T]=await P.model.getItemsData([P.localId],$e);Fe(T||null)}catch{}}},y=async C=>{Ie(null),C.button===0&&await a(C.clientX,C.clientY)},p=async C=>{Ie(null),_t.current||await a(C.clientX,C.clientY)},A=()=>{if(_t.current){const C=Vt.current;C&&typeof C.create=="function"&&(console.log("📏 Creating measurement point"),C.create())}},x=C=>{C.preventDefault();const S=Ne.current;if(!S||S.length===0){Ie(null);return}Ie({mouseX:C.clientX+2,mouseY:C.clientY-6})},I=C=>{if(_t.current&&(C.code==="Delete"||C.code==="Backspace")){const S=Vt.current;S&&typeof S.delete=="function"&&(console.log("Deleting measurement under cursor"),S.delete())}};return n.addEventListener("pointerdown",y,{capture:!0}),n.addEventListener("click",p),n.addEventListener("dblclick",A),n.addEventListener("contextmenu",x),window.addEventListener("keydown",I),()=>{n.removeEventListener("pointerdown",y,{capture:!0}),n.removeEventListener("click",p),n.removeEventListener("dblclick",A),n.removeEventListener("contextmenu",x),window.removeEventListener("keydown",I);try{const C=Pe.current;C&&(o.scene.three.remove(C),C.traverse(S=>{if(S.geometry&&S.geometry.dispose?.(),S.material){const D=Array.isArray(S.material)?S.material:[S.material];for(const $ of D)$?.dispose?.()}}),Pe.current=null)}catch{}try{const C=Ae.current;if(C&&C.mesh&&C.mesh.instanceColor){const S=new Le(1,1,1);C.mesh.setColorAt(C.index,S),C.mesh.instanceColor.needsUpdate=!0}Ae.current=null}catch{}}},[]);const wn=d.useCallback(()=>{i.current;const t=He(),o=t?.controls??null,n=t?.three??null;o?o.reset(!0):n&&(n.position.set(10,10,10),n.lookAt(0,0,0))},[]),jo=d.useCallback(t=>{Ot(o=>{const n={...o,[t]:!o[t]},l=i.current;if(!l)return n;const a=l.renderer?.three,y=l.scene?.three;if(!a||!y)return n;const p=[],A=ho.current;if(!n[t]){const x=A.get(t);x&&(y.remove(x),x.dispose(),A.delete(t))}if(n.x){const x=new dt(new Z(1,0,0),ze.x);if(p.push(x),!A.has("x")){const I=new Fo(x,10,16711680);y.add(I),A.set("x",I)}}if(n.y){const x=new dt(new Z(0,1,0),ze.y);if(p.push(x),!A.has("y")){const I=new Fo(x,10,65280);y.add(I),A.set("y",I)}}if(n.z){const x=new dt(new Z(0,0,1),ze.z);if(p.push(x),!A.has("z")){const I=new Fo(x,10,255);y.add(I),A.set("z",I)}}return a.clippingPlanes=p,a.localClippingEnabled=p.length>0,mo.current=p,n})},[ze]),Eo=d.useCallback((t,o)=>{Jo(n=>{const l={...n,[t]:o},a=i.current;if(!a)return l;const y=a.renderer?.three;if(!y)return l;const p=[],A=ho.current;if(ne.x){const x=new dt(new Z(1,0,0),l.x);p.push(x);const I=A.get("x");I&&(I.plane.constant=l.x)}if(ne.y){const x=new dt(new Z(0,1,0),l.y);p.push(x);const I=A.get("y");I&&(I.plane.constant=l.y)}if(ne.z){const x=new dt(new Z(0,0,1),l.z);p.push(x);const I=A.get("z");I&&(I.plane.constant=l.z)}return y.clippingPlanes=p,mo.current=p,l})},[ne]),In=d.useCallback(()=>{Zo(t=>{const o=!t;return Ot(o?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),o})},[]),Cn=d.useCallback(()=>{console.log("🎯 toggleMeasurement called"),Xr(t=>{const o=!t;_t.current=o;const n=Vt.current;if(console.log("Measurement tool:",n),console.log("New state:",o),n)if(n.enabled=o,console.log("Measurement tool enabled set to:",o),console.log("Measurement tool world:",n.world),console.log("Measurement tool properties:",{enabled:n.enabled,world:!!n.world,list:n.list?.size||0}),o)console.log("📏 Measurement mode activated - DOUBLE-CLICK two points on the model to measure distance");else try{n.list&&typeof n.list.clear=="function"&&(n.list.clear(),console.log("All measurements cleared")),er(null)}catch(l){console.warn("Failed to clear measurements:",l)}else console.warn("⚠️ Measurement tool not initialized!");return o})},[]),Sn=d.useCallback(()=>{Ot({x:!1,y:!1,z:!1}),Jo({x:0,y:0,z:0}),Zo(!1);const t=i.current;if(t){const o=t.renderer?.three,n=t.scene?.three;if(o&&(o.clippingPlanes=[],o.localClippingEnabled=!1),n){const l=ho.current;l.forEach(a=>{n.remove(a),a.dispose()}),l.clear()}}mo.current=[]},[]),ot=d.useCallback(t=>{console.log("setCameraView called with view:",t);const o=i.current,n=c.current,l=m.current,a=He(),y=a?.three;if(console.log("Debug:",{hasWorld:!!o,hasFragments:!!n,id:l,hasCamera:!!a,hasThreeCamera:!!y}),!y||!o||!n||!l){console.log("Early return: missing dependencies");return}const p=n.list.get(l);if(console.log("Model record:",p),!p){console.log("Early return: no record found for id:",l);return}const A=new Te().setFromObject(p.object);if(console.log("Bounding box:",A,"isEmpty:",A.isEmpty()),A.isEmpty()){console.log("Early return: bounding box is empty");return}const x=new Z,I=new Z;A.getCenter(x),A.getSize(I);const S=Math.max(I.x,I.y,I.z)*2||20;let D;switch(t){case"top":D=new Z(x.x,x.y+S,x.z);break;case"bottom":D=new Z(x.x,x.y-S,x.z);break;case"front":D=new Z(x.x,x.y,x.z+S);break;case"back":D=new Z(x.x,x.y,x.z-S);break;case"left":D=new Z(x.x-S,x.y,x.z);break;case"right":D=new Z(x.x+S,x.y,x.z);break;case"iso":D=new Z(x.x+S*.7,x.y+S*.7,x.z+S*.7);break;default:return}const $=a?.controls;$&&typeof $.setLookAt=="function"?($.setLookAt(D.x,D.y,D.z,x.x,x.y,x.z,!0),console.log("Camera moved to:",t,"position:",D,"looking at:",x)):(y.position.copy(D),y.lookAt(x),y.updateProjectionMatrix(),console.log("Camera moved (fallback) to:",t))},[]);return r.jsxs("div",{style:{width:"100%",height:"100%"},children:[r.jsx(zn,{position:"static",children:r.jsxs(Fn,{children:[r.jsx(te,{variant:"h6",component:"div",sx:{flexGrow:1},children:"Fragments AI Viewer"}),r.jsx(he,{color:"inherit",onClick:cn,startIcon:r.jsx(dr,{}),"aria-pressed":oe,sx:{mr:1,borderRadius:1.5,backgroundColor:oe?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:oe?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:oe?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),r.jsx(he,{color:"inherit",onClick:on,startIcon:r.jsx(Mn,{}),"aria-pressed":bt,sx:{mr:1,borderRadius:1.5,backgroundColor:bt?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:bt?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:bt?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),r.jsx(he,{color:"inherit",onClick:nn,startIcon:r.jsx(ur,{}),"aria-pressed":lt,sx:{mr:1,borderRadius:1.5,backgroundColor:lt?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:lt?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:lt?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),r.jsx(he,{color:"inherit",onClick:Qr,startIcon:r.jsx(fr,{}),"aria-pressed":it,sx:{mr:1,borderRadius:1.5,backgroundColor:it?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:it?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:it?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),r.jsx("div",{ref:e,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:V!==null&&r.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:r.jsxs(xe,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[r.jsx(te,{variant:"subtitle1",sx:{mb:1},children:"Converting IFC…"}),r.jsx($n,{variant:"determinate",value:Math.max(0,Math.min(100,V)),sx:{height:10,borderRadius:1}}),r.jsxs(te,{variant:"caption",sx:{mt:1,display:"block"},children:[V.toFixed(1),"%"]}),r.jsx("div",{style:{marginTop:12},children:r.jsx(he,{size:"small",variant:"outlined",color:"inherit",onClick:an,disabled:ke,children:ke?"Cancelling…":"Cancel"})})]})})}),oe?r.jsx(pr,{nodeRef:so,handle:".explorer-header",bounds:"parent",children:r.jsxs(xe,{ref:so,elevation:8,sx:{position:"fixed",top:120,right:30,width:zt.width,height:re?"auto":zt.height,minWidth:280,minHeight:re?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[r.jsxs(U,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[r.jsx(te,{variant:"subtitle1",children:"Model Explorer"}),r.jsxs(U,{children:[r.jsx(ie,{size:"small",color:"inherit",onClick:un,title:re?"Expand panel":"Minimize panel",children:re?r.jsx(Dn,{}):r.jsx(Nn,{})}),r.jsx(ie,{size:"small",color:"inherit",onClick:dn,title:"Close Model Explorer",children:r.jsx(mr,{})})]})]}),!re&&r.jsxs(U,{sx:{flex:1,display:"flex",flexDirection:"column",gap:2,px:2,py:1,minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(he,{variant:"contained",size:"small",onClick:()=>s.current?.click(),disabled:!ve,children:"Open IFC / FRAG"}),!1,r.jsx(te,{variant:"caption",color:"text.secondary"}),r.jsx("input",{ref:s,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:ln})]}),r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:1,overflow:"hidden",flexGrow:Me?1:0,flexShrink:Me?1:0,flexBasis:Me?0:"auto",minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between"},children:[r.jsx(te,{variant:"subtitle2",children:"Loaded Models"}),r.jsx(ie,{size:"small",onClick:()=>_r(t=>!t),title:Dt?"Expand Loaded Models":"Collapse Loaded Models",children:Dt?r.jsx(ko,{fontSize:"small"}):r.jsx(vo,{fontSize:"small"})})]}),r.jsx(Yt,{in:!Dt,timeout:"auto",sx:{display:"flex",flexDirection:"column",flex:Me?"1 1 0":"0 0 auto",maxHeight:Me?"100%":`${qt}px`,minHeight:0},children:r.jsx(U,{ref:Lo,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:Me?"1 1 0":"0 0 auto",maxHeight:Me?"100%":`${qt}px`,minHeight:0},children:!ve&&r.jsx(te,{variant:"body2",color:"text.secondary",children:"Initializing components…"})})})]}),r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:2,flex:1,minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:1.25,overflow:"hidden",borderRadius:1.5,border:"1px solid",borderColor:"rgba(229, 57, 53, 0.45)",bgcolor:"rgba(229, 57, 53, 0.08)",p:1.5,flexGrow:Ze?0:1,flexShrink:Ze?0:1,flexBasis:"auto",minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(te,{variant:"subtitle2",children:"Selection Properties"}),r.jsx(ie,{size:"small",onClick:()=>Vr(t=>!t),title:Ze?"Expand Selection Properties":"Collapse Selection Properties",children:Ze?r.jsx(ko,{fontSize:"small"}):r.jsx(vo,{fontSize:"small"})})]}),r.jsx(Yt,{in:!Ze,timeout:"auto",sx:{flex:Ze?"0 0 auto":"1 1 0",display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsxs(Ln,{value:Je,onChange:(t,o)=>Bo(o),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[r.jsx(hr,{value:"favorites",label:`Favourites (${bo.length})`}),r.jsx(hr,{value:"all",label:`All (${le.length})`})]}),r.jsxs(U,{role:"tabpanel",hidden:Je!=="favorites",sx:{display:Je==="favorites"?"flex":"none",flexDirection:"column",flex:Je==="favorites"?1:0,minHeight:0},children:[bo.length?r.jsx(U,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(xe,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:bo.map(wo)})}):r.jsx(xe,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(te,{variant:"body2",color:"text.secondary",children:ye.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),xo>0&&ye.length>0&&r.jsx(Kt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:xo===1?"1 favourite property is not available for this selection.":`${xo} favourite properties are not available for this selection.`})]}),r.jsxs(U,{role:"tabpanel",hidden:Je!=="all",sx:{display:Je==="all"?"flex":"none",flexDirection:"column",flex:Je==="all"?1:0,minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[r.jsx(Po,{size:"small",fullWidth:!0,value:_o,onChange:t=>Tr(t.target.value),placeholder:"Search properties…",disabled:!le.length}),r.jsx(ce,{title:"Copy raw element JSON",children:r.jsx("span",{children:r.jsx(ie,{size:"small",onClick:Jr,disabled:!H,color:"primary",children:r.jsx(Tn,{fontSize:"small"})})})}),r.jsx(ce,{title:"Export properties",children:r.jsx("span",{children:r.jsx(he,{variant:"outlined",size:"small",startIcon:r.jsx(On,{}),onClick:Kr,disabled:!le.length&&!E.length,children:"Export"})})})]}),le.length?Yr?tr.length?r.jsx(U,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(xe,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:tr.map(wo)})}):r.jsx(xe,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(te,{variant:"body2",color:"text.secondary",children:`No properties matched "${Bt}".`})}):r.jsxs(U,{sx:{position:"relative",flex:1,minHeight:200},children:[r.jsx(xe,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:yo.map(wo)}),or>0&&r.jsx(Kt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${yo.length} properties. ${or} more not shown.`})]}):r.jsx(xe,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(te,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / … breakdown."})})]})]})})]}),r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:1.25,overflow:"hidden",borderRadius:1.5,border:"1px solid",borderColor:"rgba(255, 179, 0, 0.5)",bgcolor:"rgba(255, 213, 79, 0.12)",p:1.5,flexGrow:Qe?0:1,flexShrink:Qe?0:1,flexBasis:"auto",minHeight:0},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(te,{variant:"subtitle2",children:"Model Tree"}),r.jsx(ie,{size:"small",onClick:()=>Br(t=>!t),title:Qe?"Expand Model Tree":"Collapse Model Tree",children:Qe?r.jsx(ko,{fontSize:"small"}):r.jsx(vo,{fontSize:"small"})})]}),r.jsx(Yt,{in:!Qe,timeout:"auto",sx:{flex:Qe?"0 0 auto":"1 1 0",display:"flex",flexDirection:"column",minHeight:0,overflow:"hidden"},children:r.jsxs(U,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsx(Po,{size:"small",fullWidth:!0,value:st,onChange:t=>Or(t.target.value),placeholder:"Search the model tree…",disabled:!E.length,sx:{flexShrink:0}}),r.jsxs(U,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[r.jsx(U,{ref:Mt,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!ve||!E.length)&&r.jsx(U,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:r.jsx(te,{variant:"body2",color:"text.secondary",children:ve?"Load a model to populate the full model tree.":"Viewer is initializing the model tree…"})})]})]})})]})]})]}),r.jsx(U,{onPointerDown:mn,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}):r.jsx(xe,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%"},children:r.jsx(ie,{onClick:at,title:"Open Model Explorer",children:r.jsx(dr,{})})}),!lt&&r.jsx(xe,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%"},children:r.jsx(ie,{onClick:ar,title:"Open IDS Checker",children:r.jsx(ur,{})})}),!it&&r.jsx(xe,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%"},children:r.jsx(ie,{onClick:()=>uo(!0),title:"Open IDS Creator",children:r.jsx(fr,{})})}),qr?r.jsx(pr,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:r.jsxs(xe,{elevation:8,sx:{position:"absolute",bottom:90,padding:1.5,display:"flex",flexDirection:"column",gap:1,zIndex:1600,backgroundColor:"rgba(245, 245, 245, 0.98)",backdropFilter:"blur(10px)",borderRadius:2,cursor:"move",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[r.jsxs(U,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:.5,cursor:"grab","&:active":{cursor:"grabbing"}},children:[r.jsxs(U,{sx:{display:"flex",alignItems:"center",gap:.5},children:[r.jsx(_n,{fontSize:"small",sx:{color:"text.secondary"}}),r.jsx(te,{variant:"caption",sx:{fontWeight:600,color:"primary.main"},children:"View Controls"})]}),r.jsx(ie,{size:"small",onClick:()=>Ko(!1),title:"Close toolbar",sx:{ml:1},children:r.jsx(mr,{fontSize:"small"})})]}),r.jsxs(U,{sx:{display:"flex",gap:.5},children:[r.jsx(ce,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:gn,disabled:!f,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(gr,{fontSize:"small"})})}),r.jsx(ce,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:wn,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:r.jsx(Vn,{fontSize:"small"})})})]}),r.jsxs(U,{sx:{mt:.5},children:[r.jsx(te,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),r.jsxs(U,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[r.jsx(ce,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),r.jsx(ce,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),r.jsx(ce,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),r.jsx(ce,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),r.jsx(ce,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),r.jsx(ce,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(he,{size:"small",onClick:()=>ot("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),r.jsx(ce,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:r.jsxs(he,{size:"small",onClick:()=>ot("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[r.jsx(Bn,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),r.jsxs(U,{sx:{mt:.5},children:[r.jsx(te,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),r.jsxs(U,{sx:{display:"flex",gap:.5},children:[r.jsx(ce,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>jo("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:r.jsx(te,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),r.jsx(ce,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>jo("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(te,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),r.jsx(ce,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>jo("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:r.jsx(te,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&r.jsxs(U,{sx:{mt:1},children:[r.jsxs(te,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",ze.x.toFixed(1)]}),r.jsx(Ao,{value:ze.x,onChange:(t,o)=>Eo("x",o),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&r.jsxs(U,{sx:{mt:1},children:[r.jsxs(te,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",ze.y.toFixed(1)]}),r.jsx(Ao,{value:ze.y,onChange:(t,o)=>Eo("y",o),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&r.jsxs(U,{sx:{mt:1},children:[r.jsxs(te,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",ze.z.toFixed(1)]}),r.jsx(Ao,{value:ze.z,onChange:(t,o)=>Eo("z",o),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),r.jsxs(U,{sx:{display:"flex",gap:.5},children:[r.jsx(ce,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:In,sx:{border:"2px solid",borderColor:wt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:wt?"warning.main":"white",color:wt?"white":"warning.dark","&:hover":{backgroundColor:wt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:r.jsx(Gn,{fontSize:"small"})})}),r.jsx(ce,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:Sn,disabled:!ne.x&&!ne.y&&!ne.z&&!wt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(Wn,{fontSize:"small"})})})]}),r.jsxs(U,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[r.jsx(ce,{title:It?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:Cn,sx:{border:"2px solid",borderColor:It?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:It?"success.main":"white",color:It?"white":"success.dark","&:hover":{backgroundColor:It?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(Un,{fontSize:"small"})})}),Qo&&r.jsxs(te,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Qo," units"]})]})]})}):r.jsx(xe,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%"},children:r.jsx(ie,{onClick:()=>Ko(!0),title:"Open View Controls",children:r.jsx(gr,{})})}),r.jsxs(Hn,{open:Hr,onClose:ir,fullWidth:!0,maxWidth:"sm",children:[r.jsx(qn,{children:"Export properties"}),r.jsxs(Xn,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(Yn,{component:"fieldset",variant:"standard",children:[r.jsx(Kn,{component:"legend",children:"Scope"}),r.jsxs(Jn,{value:We,onChange:t=>qo(t.target.value),children:[r.jsx(yr,{value:"selected",control:r.jsx(br,{}),label:"Selected items",disabled:!le.length}),r.jsx(yr,{value:"model",control:r.jsx(br,{}),label:"Specific model",disabled:!E.length})]})]}),r.jsx(Yt,{in:We==="model",unmountOnExit:!0,children:r.jsx(Po,{select:!0,fullWidth:!0,label:"Model",value:Ue,onChange:t=>Lt(t.target.value),disabled:!E.length,children:E.map(t=>r.jsx(Ro,{value:t.id,children:t.label},t.id))})}),We==="selected"&&!le.length&&r.jsx(Kt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Yo&&r.jsx(Kt,{severity:"error",variant:"outlined",children:Yo})]}),r.jsxs(Zn,{children:[r.jsx(he,{onClick:ir,disabled:et,children:"Cancel"}),r.jsx(he,{variant:"contained",onClick:Zr,disabled:et||We==="selected"&&!le.length||We==="model"&&!Ue,children:et?"Exporting…":"Export CSV"})]})]}),r.jsxs(d.Suspense,{fallback:null,children:[r.jsx(qs,{isOpen:lt,onOpen:ar,onClose:rn,viewerApi:So,hasModel:E.length>0,expandSignal:Wr}),r.jsx(Xs,{isOpen:it,onClose:()=>uo(!1),viewerApi:So,selectedItemData:H,onValidate:sn}),r.jsx(Hs,{getModelDataForAI:hn,isOpen:bt,onOpen:en,onClose:tn,expandSignal:Gr,onRequestSelection:pn})]}),r.jsxs(Qn,{open:!!$t,onClose:xn,anchorReference:"anchorPosition",anchorPosition:$t?{top:$t.mouseY,left:$t.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[r.jsx(Ro,{onClick:yn,disabled:w.length===0,children:"Hide selected element"}),r.jsx(Ro,{onClick:bn,children:"Reset hidden elements"})]})]})};function oo(e,s=2e3){try{if(e==null)return"null";const i=typeof e=="string"?e:JSON.stringify(e,null,2);return i?i.length<=s?i:`${i.slice(0,s)}
... [truncated ${i.length-s} chars]`:""}catch{return String(e)}}es.createRoot(document.getElementById("root")).render(r.jsx(Pt.StrictMode,{children:r.jsx(il,{})}));export{Bs as a,fl as g,Mo as i,ul as p,Ws as u};
