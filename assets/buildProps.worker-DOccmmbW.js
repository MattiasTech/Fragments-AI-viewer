(function(){"use strict";const h=self,L=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),_=e=>{if(!e)return"";let t=e.replace(/[_\-]+/g," ");return t=t.replace(/([a-z\d])([A-Z])/g,"$1 $2"),t=t.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),t=t.replace(/\s+/g," ").trim(),t?t.split(" ").map(n=>{const c=n.toUpperCase();return L.has(c)||c.length<=3&&/^[A-Z]+$/.test(c)?c:/^\d+(\.\d+)?$/.test(n)||!n.length?n:n.charAt(0).toUpperCase()+n.slice(1)}).join(" "):""},P=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const t=JSON.stringify(e);return t?t.length>500?`${t.slice(0,500)}â€¦`:t:""}catch{return String(e)}},b=e=>{if(e==null)return"";if(typeof e!="object")return P(e);if(e&&typeof e=="object"){const t=e;if("value"in t)return b(t.value);if("Value"in t)return b(t.Value)}return Array.isArray(e)?e.map(t=>b(t)).filter(Boolean).join(", "):typeof e?.x=="number"&&typeof e?.y=="number"&&typeof e?.z=="number"?`${P(e.x)}, ${P(e.y)}, ${P(e.z)}`:P(e)},j=(e,t)=>{if(!e||typeof e!="object")return;const f=t.map(p=>p.toLowerCase()),n=new WeakSet,c=[e];for(;c.length;){const p=c.pop();if(!(!p||typeof p!="object")&&!n.has(p)){if(n.add(p),Array.isArray(p)){for(const g of p)g&&typeof g=="object"&&c.push(g);continue}for(const[g,u]of Object.entries(p)){const N=g.toLowerCase();if(f.some(d=>N.includes(d)))if(typeof u=="string"){const d=u.trim();if(d)return d}else{if(typeof u=="number"&&Number.isFinite(u))return u.toString();if(typeof u=="boolean")return u?"true":"false"}u&&typeof u=="object"&&c.push(u)}}}},x=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),w=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",C=["HasProperties","hasProperties","Properties","properties"],k=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],G=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),T=e=>{if(!e||typeof e!="object")return!1;const t=e,f=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return f&&f.toUpperCase()==="IFCPROPERTYSET"?!0:C.some(n=>Array.isArray(t[n]))},D=e=>{if(!e||typeof e!="object")return!1;const t=e,f=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return f&&f.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},F=e=>{if(!e||typeof e!="object")return P(e);const t=e,f=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const n of f){if(!(n in t))continue;const c=t[n];if(c!=null)return b(c)}return"NominalValue"in t?b(t.NominalValue):"nominalValue"in t?b(t.nominalValue):"Value"in t?b(t.Value):"value"in t?b(t.value):P(e)},M=e=>{if(!e||typeof e!="object")return[];const t=[],f=new WeakSet,n=new Map,c=o=>{let r;if(typeof o=="string"){const l=o.trim();l.length&&(r=l)}if(!r&&o&&typeof o=="object"){const l=o,s=R(o)??(typeof l.Name=="string"?l.Name:void 0),m=typeof l.id=="string"?l.id:void 0;r=s??m}(!r||!r.length)&&(r="Property Set");const a=_(r)||r,y=x(r)||"property-set",i=(n.get(y)??0)+1;return n.set(y,i),{rawName:r,friendlyName:a,uniqueKey:`${y}-${i}`}},p=(o,r,a)=>{const y=`Property ${a+1}`,i=o&&o.trim().length?o.trim():y;if(D(r)){const s={...r};return s.Name==null&&s.PropertyName==null&&(s.Name=i),s.PropertyName==null&&(s.PropertyName=s.Name??i),s.__rawValue==null&&(s.__rawValue=r),s}if(r&&typeof r=="object"){const s={...r};return s.Name==null&&s.PropertyName==null&&(s.Name=i),s.PropertyName==null&&(s.PropertyName=s.Name??i),s.type==null&&s.Type==null&&(s.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in s)&&!("nominalValue"in s)&&!("Value"in s)&&!("value"in s)&&(s.NominalValue=r),s.__rawValue==null&&(s.__rawValue=r),s}return{type:"IFCPROPERTYSINGLEVALUE",Name:i,PropertyName:i,NominalValue:r,__rawValue:r}},g=(o,r)=>{const a=[],y=(i,l)=>{const s=`Property ${a.length+1}`,m=i,V=(typeof i=="string"&&i.trim().length?i.trim():void 0)??R(i)??(typeof m?.Name=="string"?m.Name:void 0)??(typeof m?.PropertyName=="string"?m.PropertyName:void 0)??s;a.push(p(V,l,a.length))};if(r&&typeof r=="object"){const i=r;for(const l of C){const s=i[l];Array.isArray(s)&&s.length&&s.forEach(m=>y(m,m))}}if(!a.length)if(Array.isArray(r))r.forEach(i=>y(i,i));else if(r&&typeof r=="object")for(const[i,l]of Object.entries(r))l!=null&&(G.has(i)||C.includes(i)||k.includes(i)||y(i,l));else r!=null&&y(void 0,r);return{type:"IFCPROPERTYSET",Name:o,HasProperties:a}},u=(o,r)=>{if(!r||typeof r!="object")return;const a=g(o.rawName,r),y=Array.isArray(a.HasProperties)?a.HasProperties:[];if(!y.length)return;const i=o.friendlyName;y.forEach((l,s)=>{const m=l,V=(typeof m.Name=="string"?m.Name:void 0)??(typeof m.PropertyName=="string"?m.PropertyName:void 0)??`Property ${s+1}`,B=_(V)||V,K=F(l);t.push({label:`Property Sets / ${i} / ${B}`,value:K||"",rawPsetName:o.rawName,rawPropertyName:V})})},N=o=>{if(!(!o||typeof o!="object")&&!f.has(o)){if(f.add(o),Array.isArray(o)){o.forEach(r=>{if(!r||typeof r!="object")return;const a=c(r),y=T(r)?r:g(a.rawName,r);u(a,y),f.add(r)});return}for(const[r,a]of Object.entries(o)){if(a==null)continue;const y=c(r),i=T(a)?a:g(y.rawName,a);u(y,i),a&&typeof a=="object"&&f.add(a)}}},d=o=>{if(!(!o||typeof o!="object")&&!f.has(o)){if(f.add(o),Array.isArray(o)){o.forEach(d);return}for(const r of k)if(Object.prototype.hasOwnProperty.call(o,r)){const a=o[r];N(a)}if(T(o)){const r=c(o);u(r,o)}Object.values(o).forEach(r=>{r&&typeof r=="object"&&d(r)})}};return d(e),t},R=e=>{if(!e||typeof e!="object")return;const t=e,f=typeof t.Name=="string"?t.Name:void 0,n=typeof t.name=="string"?t.name:void 0,c=f??n;if(!c)return;const p=c.trim();return p.length?p:void 0},U=e=>{if(!e||typeof e!="object")return"IfcProduct";const t=e,f=[t.ifcClass,t.IfcClass,t.type,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.attributes?.ifcClass,t.Attributes?.IfcClass];for(const c of f)if(typeof c=="string"&&c.trim().length)return c.trim();const n=j(e,["ifcclass","ifc type","type"]);return n||"IfcProduct"},Y=(e,t,f)=>{const n={},c={},p={};M(e).forEach(o=>{const r=o.label.split("/").map(m=>m.trim()),a=o.rawPsetName??r[1]??"",y=o.rawPropertyName??r[r.length-1]??"",i=w(a),l=w(y);if(!i||!l)return;c[i]||(c[i]={}),l in c[i]||(c[i][l]=o.value);const s=`${i}.${l}`;s in n||(n[s]=o.value)}),n.GlobalId=t,n.ifcClass=f,p.ifcClass=f,p.GlobalId=t,n["Attributes.GlobalId"]=t,n["Attributes.IfcClass"]=f,n["Attributes.ifcClass"]=f;const u=R(e);u&&(p.Name=u,n["Attributes.Name"]=u);const N=j(e,["category","ifccategory"]);N&&(p.Category=N,n["Attributes.Category"]=N);const d=j(e,["type","typename"]);if(d&&(p.Type=d,n["Attributes.Type"]=d),e&&typeof e=="object"&&!Array.isArray(e))for(const[o,r]of Object.entries(e)){if(r==null||typeof r!="object"||Array.isArray(r))continue;const a=b(r);if(!a)continue;const y=String(o).replace(/^_+/,""),i=`Attributes.${_(y)}`;if(i in n||(n[i]=a),y in p||(p[y]=a),/guid|globalid|_guid/i.test(o)){const l=a.trim();l&&!n.GlobalId&&(n.GlobalId=l,p.GlobalId=l,n["Attributes.GlobalId"]=l)}}return{flattened:n,psets:c,attributes:p}};let A=[],O=new Set,S=0,E=0,I=!1;const $=()=>{A=[],O=new Set,S=0,E=0,I=!1},z=e=>{if(e.reset&&$(),typeof e.total=="number"&&!Number.isNaN(e.total)&&(S=e.total),!I){if(Array.isArray(e.elements)&&e.elements.length){for(const f of e.elements){if(I)break;const n=f.globalId?.trim();if(!n||O.has(n))continue;const c=f.data;if(!c||typeof c!="object")continue;const p=f.ifcClass&&f.ifcClass.trim().length?f.ifcClass.trim():U(c),{flattened:g}=Y(c,n,p),u={GlobalId:n,ifcClass:p,properties:g};O.add(n),A.push(u)}E=Math.min(A.length,S||A.length);const t={type:"progress",done:E,total:S||Math.max(A.length,E)};h.postMessage(t)}if(e.final){if(I){const t={type:"error",message:"Build cancelled"};h.postMessage(t)}else{const t={type:"done",elements:A};h.postMessage(t)}$()}}};h.onmessage=e=>{const t=e.data;if(t)switch(t.type){case"build-props":z(t);break;case"cancel":I=!0,h.postMessage({type:"error",message:"Build cancelled"}),$();break;default:h.postMessage({type:"error",message:"Unknown message type"})}}})();
