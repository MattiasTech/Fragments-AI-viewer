import{cm as o,co as t,cH as ge,cF as xe,cp as d,dM as q,cq as b,cs as H,cI as me,cJ as pe,cK as ye,cO as Ie,d3 as w,d4 as U,d5 as Y,d6 as A,dN as be,dw as je,ds as Ce,dA as J,dO as Pe,cP as K,dn as Q,dP as Fe,dQ as X,cG as Se,cA as Z,dD as Be}from"./vendor-CbOrIqGz.js";const M="GlobalId",ve=["equals","contains","matches","greater-than","less-than","not-equals"],Te=["IfcWall","IfcColumn","IfcBeam","IfcSlab","IfcDoor","IfcWindow","IfcStair","IfcRoof","IfcSpace"];function Me({open:F,onClose:ee,viewerApi:s}){const z=o.useRef(null),[x,te]=o.useState(!1),[f,se]=o.useState([]),[m,N]=o.useState(M),[S,ae]=o.useState("equals"),[j,le]=o.useState(""),[P,re]=o.useState("ghost"),[ne]=o.useState(Te),[oe,_]=o.useState([]),[E,O]=o.useState(!1),[p,B]=o.useState(!1),[C,v]=o.useState(null),[k,G]=o.useState(!1),[h,V]=o.useState(null),[W,R]=o.useState(""),ie=e=>e.GlobalId&&typeof e.GlobalId=="object"&&"value"in e.GlobalId?e.GlobalId.value:e._guid&&typeof e._guid=="object"&&"value"in e._guid?e._guid.value:null,ce=(e,a)=>{const n=l=>l&&typeof l=="object"&&"value"in l?l.value:l,r=a.split(".");if(r.length===1)return n(e[r[0]]);const[i,c]=r,u=e.IsDefinedBy;if(Array.isArray(u))for(const l of u){if(n(l.Name)!==i)continue;const I=l.HasProperties;if(Array.isArray(I)){for(const y of I)if(n(y.Name)===c)return n(y.NominalValue)}}},ue=(e,a,n)=>{if(e==null)return!1;const r=String(e),i=String(n);switch(a){case"equals":return r===i;case"not-equals":return r!==i;case"contains":return r.toLowerCase().includes(i.toLowerCase());case"matches":try{return new RegExp(i).test(r)}catch{return!1}case"greater-than":return parseFloat(r)>parseFloat(i);case"less-than":return parseFloat(r)<parseFloat(i);default:return!1}},T=(e,a="",n=3,r=0)=>{if(r>=n)return[];const i=[];for(const c in e){if(!e.hasOwnProperty(c)||c.startsWith("_"))continue;const u=a?`${a}.${c}`:c,l=e[c];Array.isArray(l)&&l.length>0&&typeof l[0]=="object"?i.push(...T(l[0],u,n,r+1)):l&&typeof l=="object"&&!Array.isArray(l)?i.push(...T(l,u,n,r+1)):l!=null&&typeof l!="function"&&i.push(u)}return i},$=o.useCallback(async()=>{if(!(!s||!s.getItemsByCategory||!s.getItemsDataByModel)){O(!0);try{const e=f.length>0?f.map(g=>new RegExp(`^${g}$`,"i")):[/.*/],a=await s.getItemsByCategory(e),[n,r]=Object.entries(a)[0]||[null,[]];if(!n||r.length===0){_([]);return}const i=Math.min(10,r.length),c=r.slice(0,i),u={attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasAssignments:{attributes:!0,relations:!1}}},l=await s.getItemsDataByModel(n,c,u),I=new Set;for(const g of l)T(g).forEach(D=>{const he=D.startsWith("IsDefinedBy.")?D.substring(12):D;I.add(he)});const y=Array.from(I).filter(g=>!g.startsWith("_")).sort();_(y)}catch(e){console.error("Property discovery failed:",e)}finally{O(!1)}}},[s,f]);o.useEffect(()=>{F&&!x&&$()},[F,f,$,x]);const de=o.useCallback(async()=>{if(!s||!s.getItemsByCategory||!s.getItemsDataByModel){alert("❌ Viewer API not ready");return}if(!m||!j){alert("⚠️ Please select a property and enter a value");return}B(!0),v({current:0,total:1});const e=[];try{let a;if(f.length>0){const c=f.map(u=>new RegExp(`^${u}$`,"i"));a=await s.getItemsByCategory(c)}else a=await s.getItemsByCategory([/.*/]);const n=Object.values(a).reduce((c,u)=>c+u.length,0);if(n===0){alert("⚠️ No elements found matching the category filter"),B(!1);return}let r=0;const i=m.includes("Pset_")||m.includes(".")?{attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}}:{attributesDefault:!1,attributes:["Name","GlobalId"]};for(const[c,u]of Object.entries(a)){if(u.length===0)continue;if(!s.getItemsDataByModel){console.error("getItemsDataByModel not available");continue}const l=await s.getItemsDataByModel(c,u,i);let I=0;for(const y of l){const g=ie(y);if(!g)continue;const L=ce(y,m);ue(L,S,j)&&e.push(g),r++,r%100===0&&v({current:r,total:n})}}V(e),R(`${e.length} of ${n} elements`),e.length===0?alert("ℹ️ No elements matched the filter criteria"):e.length===n&&alert(`✅ All ${n} elements matched the filter!

Tip: Try a different value or use "not equals" operator to see some elements filtered out.`)}catch(a){console.error("Filter failed:",a),alert(`❌ Filter failed: ${a.message}`)}finally{B(!1),v(null)}},[s,m,S,j,f]);o.useEffect(()=>{let e=!0;const a=async()=>{if(!(!s||!h||h.length===0||p))try{s.clearColors&&await s.clearColors(),s.clearIsolation&&await s.clearIsolation(),P==="ghost"?typeof s.ghost=="function"?await s.ghost(h):console.warn("Ghost mode not supported by viewer API"):await s.isolate(h),typeof s.fitViewTo=="function"&&await s.fitViewTo(h),e&&G(!0)}catch(n){console.error("[Filter] Failed to apply filter to view:",n)}};return h&&h.length>0&&!p&&a(),()=>{e=!1}},[h,s,P,p,f]);const fe=o.useCallback(async()=>{if(s)try{s.clearIsolation&&await s.clearIsolation(),s.clearColors&&await s.clearColors(),G(!1),V([]),R("")}catch(e){console.error("❌ [Filter] Failed to clear filter:",e)}},[s]);return F?t.jsx(ge,{nodeRef:z,handle:".filter-header",bounds:"parent",children:t.jsxs(xe,{ref:z,elevation:8,sx:{position:"fixed",top:120,left:30,width:420,maxHeight:x?"auto":"80vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[t.jsxs(d,{className:"filter-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[t.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(q,{}),t.jsx(b,{variant:"subtitle1",children:"Parametric Filter"})]}),t.jsxs(d,{children:[t.jsx(H,{size:"small",color:"inherit",onClick:()=>te(!x),title:x?"Expand panel":"Minimize panel",children:x?t.jsx(me,{}):t.jsx(pe,{})}),t.jsx(H,{size:"small",color:"inherit",onClick:ee,title:"Close",children:t.jsx(ye,{})})]})]}),!x&&t.jsxs(d,{sx:{p:2,overflowY:"auto",flex:1},children:[k&&W&&t.jsxs(Ie,{severity:"success",sx:{mb:2},children:[t.jsx("strong",{children:"Active Filter:"})," ",W," match"]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"1. Category Filter (Optional)"}),t.jsxs(w,{size:"small",fullWidth:!0,children:[t.jsx(U,{children:"IFC Types"}),t.jsx(Y,{multiple:!0,value:f,onChange:e=>se(typeof e.target.value=="string"?[]:e.target.value),renderValue:e=>t.jsx(d,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.length===0?t.jsx("em",{children:"All types"}):e.map(a=>t.jsx(Ce,{label:a,size:"small"},a))}),MenuProps:{style:{zIndex:1900}},children:ne.map(e=>t.jsxs(A,{value:e,children:[t.jsx(be,{checked:f.indexOf(e)>-1}),t.jsx(je,{primary:e})]},e))})]})]}),t.jsx(J,{sx:{my:2}}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"2. Define Filter"}),t.jsx(Pe,{fullWidth:!0,size:"small",value:m,onChange:(e,a)=>N(a||M),onInputChange:(e,a)=>N(a||M),options:oe,freeSolo:!0,loading:E,componentsProps:{popper:{style:{zIndex:1900}}},renderInput:e=>t.jsx(K,{...e,label:"Property Path",helperText:"e.g., NV_PSteel.NV_STATUS or Pset_WallCommon.FireRating",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[E?t.jsx(Q,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),sx:{mb:2}}),t.jsxs(d,{sx:{display:"flex",gap:1,mb:2},children:[t.jsxs(w,{size:"small",sx:{minWidth:150},children:[t.jsx(U,{children:"Operator"}),t.jsx(Y,{value:S,onChange:e=>ae(e.target.value),label:"Operator",MenuProps:{style:{zIndex:1900}},children:ve.map(e=>t.jsx(A,{value:e,children:e},e))})]}),t.jsx(K,{size:"small",fullWidth:!0,label:"Value",value:j,onChange:e=>le(e.target.value),placeholder:"Enter value..."})]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(b,{variant:"caption",color:"text.secondary",gutterBottom:!0,sx:{display:"block"},children:"Filter Mode:"}),t.jsxs(Fe,{value:P,exclusive:!0,onChange:(e,a)=>{a!==null&&re(a)},size:"small",fullWidth:!0,children:[t.jsx(X,{value:"ghost",children:"Ghost (Transparent)"}),t.jsx(X,{value:"isolate",children:"Isolate (Hide)"})]}),t.jsx(b,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:P==="ghost"?"Makes non-matching elements transparent":"Hides non-matching elements completely"})]})]}),t.jsx(J,{sx:{my:2}}),p&&C&&t.jsxs(d,{sx:{mb:2},children:[t.jsxs(b,{variant:"caption",color:"text.secondary",children:["Filtering: ",C.current," / ",C.total]}),t.jsx(Se,{variant:"determinate",value:C.current/C.total*100})]}),t.jsxs(d,{sx:{display:"flex",gap:1},children:[t.jsx(Z,{variant:"contained",onClick:de,disabled:p||!m||!j,startIcon:p?t.jsx(Q,{size:20}):t.jsx(q,{}),fullWidth:!0,children:p?"Filtering...":"Apply Filter"}),k&&t.jsx(Z,{variant:"outlined",onClick:fe,startIcon:t.jsx(Be,{}),children:"Clear"})]})]})]})}):null}export{Me as default};
