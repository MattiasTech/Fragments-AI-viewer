import{cm as n,co as t,cH as he,cF as me,cp as d,dK as w,cq as j,cs as H,cI as pe,cJ as ye,cK as xe,cO as Ie,d4 as A,dz as U,dA as K,dc as Y,dL as be,ds as je,dn as Fe,dw as J,dM as Pe,cP as Q,dj as X,dN as Ce,dO as Z,cG as Se,cA as ee,dB as ve}from"./vendor-NpE_gqg9.js";const z="GlobalId",Be=["equals","contains","matches","greater-than","less-than","not-equals"],De=["IfcWall","IfcColumn","IfcBeam","IfcSlab","IfcDoor","IfcWindow","IfcStair","IfcRoof","IfcSpace"];function $e({open:v,onClose:te,viewerApi:s}){const M=n.useRef(null),[x,se]=n.useState(!1),[f,le]=n.useState([]),[m,N]=n.useState(z),[F,ae]=n.useState("equals"),[I,oe]=n.useState(""),[P,re]=n.useState("ghost"),[ne]=n.useState(De),[ie,_]=n.useState([]),[k,E]=n.useState(!1),[b,B]=n.useState(!1),[C,D]=n.useState(null),[G,O]=n.useState(!1),[p,V]=n.useState(null),[R,W]=n.useState(""),ce=e=>e.GlobalId&&typeof e.GlobalId=="object"&&"value"in e.GlobalId?e.GlobalId.value:e._guid&&typeof e._guid=="object"&&"value"in e._guid?e._guid.value:null,ue=(e,l)=>{const o=a=>a&&typeof a=="object"&&"value"in a?a.value:a,r=l.split(".");if(r.length===1)return o(e[r[0]]);const[i,c]=r,u=e.IsDefinedBy;if(Array.isArray(u))for(const a of u){if(o(a.Name)!==i)continue;const g=a.HasProperties;if(Array.isArray(g)){for(const y of g)if(o(y.Name)===c)return o(y.NominalValue)}}},L=(e,l,o)=>{if(e==null)return!1;const r=String(e),i=String(o);switch(l){case"equals":return r===i;case"not-equals":return r!==i;case"contains":return r.toLowerCase().includes(i.toLowerCase());case"matches":try{return new RegExp(i).test(r)}catch{return!1}case"greater-than":return parseFloat(r)>parseFloat(i);case"less-than":return parseFloat(r)<parseFloat(i);default:return!1}},T=(e,l="",o=3,r=0)=>{if(r>=o)return[];const i=[];for(const c in e){if(!e.hasOwnProperty(c)||c.startsWith("_"))continue;const u=l?`${l}.${c}`:c,a=e[c];Array.isArray(a)&&a.length>0&&typeof a[0]=="object"?i.push(...T(a[0],u,o,r+1)):a&&typeof a=="object"&&!Array.isArray(a)?i.push(...T(a,u,o,r+1)):a!=null&&typeof a!="function"&&i.push(u)}return i},q=n.useCallback(async()=>{if(!(!s||!s.getItemsByCategory||!s.getItemsDataByModel)){E(!0),console.log("üîç [Property Discovery] START");try{const e=f.length>0?f.map(h=>new RegExp(`^${h}$`,"i")):[/.*/],l=await s.getItemsByCategory(e),[o,r]=Object.entries(l)[0]||[null,[]];if(!o||r.length===0){console.log("üîç [Property Discovery] No elements found"),_([]);return}const i=Math.min(10,r.length),c=r.slice(0,i);console.log(`üîç [Property Discovery] Sampling ${i} elements from model ${o}`);const u={attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1},HasAssignments:{attributes:!0,relations:!1}}},a=await s.getItemsDataByModel(o,c,u);console.log(`‚úÖ [Property Discovery] Loaded ${a.length} samples`);const g=new Set;for(const h of a)T(h).forEach($=>{const ge=$.startsWith("IsDefinedBy.")?$.substring(12):$;g.add(ge)});const y=Array.from(g).filter(h=>!h.startsWith("_")).sort();console.log(`‚úÖ [Property Discovery] Found ${y.length} unique properties`),_(y)}catch(e){console.error("Property discovery failed:",e)}finally{E(!1)}}},[s,f]);n.useEffect(()=>{v&&!x&&q()},[v,f,q,x]);const de=n.useCallback(async()=>{if(!s||!s.getItemsByCategory||!s.getItemsDataByModel){alert("‚ùå Viewer API not ready");return}if(!m||!I){alert("‚ö†Ô∏è Please select a property and enter a value");return}B(!0),D({current:0,total:1});const e=[];try{console.log("üîç [Filter] Step 1: Getting items by category...");let l;if(f.length>0){const c=f.map(u=>new RegExp(`^${u}$`,"i"));l=await s.getItemsByCategory(c)}else l=await s.getItemsByCategory([/.*/]);const o=Object.values(l).reduce((c,u)=>c+u.length,0);if(console.log(`üîç [Filter] Found ${o} items to check`),o===0){alert("‚ö†Ô∏è No elements found matching the category filter"),B(!1);return}console.log("üîç [Filter] Step 2: Loading properties for",o,"filtered elements...");let r=0;const i=m.includes("Pset_")||m.includes(".")?{attributesDefault:!1,attributes:["Name","NominalValue","GlobalId"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}}:{attributesDefault:!1,attributes:["Name","GlobalId"]};for(const[c,u]of Object.entries(l)){if(u.length===0)continue;if(console.log(`üîç [Filter] Processing model ${c}: ${u.length} elements`),!s.getItemsDataByModel){console.error("getItemsDataByModel not available");continue}const a=await s.getItemsDataByModel(c,u,i);console.log(`‚úÖ [Filter] Loaded ${a.length} items from model ${c}`);let g=0;for(const y of a){const h=ce(y);if(!h)continue;const S=ue(y,m);g<5&&(console.log(`üîç [Filter Debug] Item ${g+1}:`,{globalId:h,field:m,actualValue:S,operator:F,expectedValue:I,matches:L(S,F,I)}),g++),L(S,F,I)&&e.push(h),r++,r%100===0&&D({current:r,total:o})}}console.log(`‚úÖ [Filter] Complete: ${e.length} matches out of ${o} elements`),V(e),W(`${e.length} of ${o} elements`),e.length===0?alert("‚ÑπÔ∏è No elements matched the filter criteria"):e.length===o&&alert(`‚úÖ All ${o} elements matched the filter!

Tip: Try a different value or use "not equals" operator to see some elements filtered out.`)}catch(l){console.error("Filter failed:",l),alert(`‚ùå Filter failed: ${l.message}`)}finally{B(!1),D(null)}},[s,m,F,I,f]);n.useEffect(()=>{let e=!0;const l=async()=>{if(!(!s||!p||p.length===0||b))try{console.log(`[Filter] Applying ${P} mode...`),s.clearColors&&await s.clearColors(),s.clearIsolation&&await s.clearIsolation(),P==="ghost"?s.ghost?(await s.ghost(p),console.log("[Filter] Applied ghost mode")):console.warn("Ghost mode not supported by viewer API"):(await s.isolate(p),console.log("[Filter] Applied isolate mode")),typeof s.fitViewTo=="function"&&(await s.fitViewTo(p),console.log("[Filter] Fitted view to filtered elements")),e&&O(!0)}catch(o){console.error("[Filter] Failed to apply filter to view:",o)}};return p&&p.length>0&&!b&&l(),()=>{e=!1}},[p,s,P,b,f]);const fe=n.useCallback(async()=>{if(s)try{s.clearIsolation&&(await s.clearIsolation(),console.log("üîÑ [Filter] Cleared isolation")),s.clearColors&&(await s.clearColors(),console.log("üîÑ [Filter] Cleared colors")),O(!1),V([]),W(""),console.log("‚úÖ [Filter] Filter cleared")}catch(e){console.error("‚ùå [Filter] Failed to clear filter:",e)}},[s]);return v?t.jsx(he,{nodeRef:M,handle:".filter-header",bounds:"parent",children:t.jsxs(me,{ref:M,elevation:8,sx:{position:"fixed",top:120,left:30,width:420,maxHeight:x?"auto":"80vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[t.jsxs(d,{className:"filter-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[t.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1},children:[t.jsx(w,{}),t.jsx(j,{variant:"subtitle1",children:"Parametric Filter"})]}),t.jsxs(d,{children:[t.jsx(H,{size:"small",color:"inherit",onClick:()=>se(!x),title:x?"Expand panel":"Minimize panel",children:x?t.jsx(pe,{}):t.jsx(ye,{})}),t.jsx(H,{size:"small",color:"inherit",onClick:te,title:"Close",children:t.jsx(xe,{})})]})]}),!x&&t.jsxs(d,{sx:{p:2,overflowY:"auto",flex:1},children:[G&&R&&t.jsxs(Ie,{severity:"success",sx:{mb:2},children:[t.jsx("strong",{children:"Active Filter:"})," ",R," match"]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"subtitle2",gutterBottom:!0,children:"1. Category Filter (Optional)"}),t.jsxs(A,{size:"small",fullWidth:!0,children:[t.jsx(U,{children:"IFC Types"}),t.jsx(K,{multiple:!0,value:f,onChange:e=>le(typeof e.target.value=="string"?[]:e.target.value),renderValue:e=>t.jsx(d,{sx:{display:"flex",flexWrap:"wrap",gap:.5},children:e.length===0?t.jsx("em",{children:"All types"}):e.map(l=>t.jsx(Fe,{label:l,size:"small"},l))}),MenuProps:{style:{zIndex:1900}},children:ne.map(e=>t.jsxs(Y,{value:e,children:[t.jsx(be,{checked:f.indexOf(e)>-1}),t.jsx(je,{primary:e})]},e))})]})]}),t.jsx(J,{sx:{my:2}}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"subtitle2",gutterBottom:!0,children:"2. Define Filter"}),t.jsx(Pe,{fullWidth:!0,size:"small",value:m,onChange:(e,l)=>N(l||z),onInputChange:(e,l)=>N(l||z),options:ie,freeSolo:!0,loading:k,componentsProps:{popper:{style:{zIndex:1900}}},renderInput:e=>t.jsx(Q,{...e,label:"Property Path",helperText:"e.g., NV_PSteel.NV_STATUS or Pset_WallCommon.FireRating",InputProps:{...e.InputProps,endAdornment:t.jsxs(t.Fragment,{children:[k?t.jsx(X,{color:"inherit",size:20}):null,e.InputProps.endAdornment]})}}),sx:{mb:2}}),t.jsxs(d,{sx:{display:"flex",gap:1,mb:2},children:[t.jsxs(A,{size:"small",sx:{minWidth:150},children:[t.jsx(U,{children:"Operator"}),t.jsx(K,{value:F,onChange:e=>ae(e.target.value),label:"Operator",MenuProps:{style:{zIndex:1900}},children:Be.map(e=>t.jsx(Y,{value:e,children:e},e))})]}),t.jsx(Q,{size:"small",fullWidth:!0,label:"Value",value:I,onChange:e=>oe(e.target.value),placeholder:"Enter value..."})]}),t.jsxs(d,{sx:{mb:2},children:[t.jsx(j,{variant:"caption",color:"text.secondary",gutterBottom:!0,sx:{display:"block"},children:"Filter Mode:"}),t.jsxs(Ce,{value:P,exclusive:!0,onChange:(e,l)=>{l!==null&&re(l)},size:"small",fullWidth:!0,children:[t.jsx(Z,{value:"ghost",children:"Ghost (Transparent)"}),t.jsx(Z,{value:"isolate",children:"Isolate (Hide)"})]}),t.jsx(j,{variant:"caption",color:"text.secondary",sx:{display:"block",mt:.5},children:P==="ghost"?"Makes non-matching elements transparent":"Hides non-matching elements completely"})]})]}),t.jsx(J,{sx:{my:2}}),b&&C&&t.jsxs(d,{sx:{mb:2},children:[t.jsxs(j,{variant:"caption",color:"text.secondary",children:["Filtering: ",C.current," / ",C.total]}),t.jsx(Se,{variant:"determinate",value:C.current/C.total*100})]}),t.jsxs(d,{sx:{display:"flex",gap:1},children:[t.jsx(ee,{variant:"contained",onClick:de,disabled:b||!m||!I,startIcon:b?t.jsx(X,{size:20}):t.jsx(w,{}),fullWidth:!0,children:b?"Filtering...":"Apply Filter"}),G&&t.jsx(ee,{variant:"outlined",onClick:fe,startIcon:t.jsx(ve,{}),children:"Clear"})]})]})]})}):null}export{$e as default};
