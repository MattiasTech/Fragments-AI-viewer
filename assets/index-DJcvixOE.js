const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-BBNG4D7z.js","assets/vendor-D2VCm1tP.js","assets/thatopen-vendor-BZwVVjX8.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-D2zp8LjB.js","assets/IdsCreatorPanel-DaK4iNXA.js","assets/ModelFilterPanel-F1ZSOG4c.js"])))=>i.map(i=>d[i]);
import{ck as fs,cl as ps,cm as d,cn as Pt,co as o,cp as W,cq as U,cr as te,cs as oe,ct as ms,cu as gs,cv as hs,cw as ys,cx as bs,cy as xs,cz as ws,cA as ie,cB as Hr,cC as qr,cD as Yr,cE as Kr,cF as je,cG as Is,cH as Xr,cI as Cs,cJ as Ss,cK as Jr,cL as js,cM as Zr,cN as Bt,cO as jt,cP as Gt,cQ as vs,cR as ks,cS as Es,cT as Qr,cU as Ps,cV as As,cW as Ho,cX as Ms,cY as Rs,cZ as $s,c_ as zs,c$ as Ds,d0 as qo,d1 as Yo,d2 as Ko,d3 as en,d4 as tn,d5 as on,d6 as Wt,d7 as Ut,d8 as Fs,d9 as Ts,da as Xo,db as Ns,dc as Ls,dd as Jo,de as Os,df as Vs}from"./vendor-D2VCm1tP.js";import{l as _s,_ as Bs,C as Gs,W as Ws,S as Us,a as Hs,O as qs,G as Ys,F as Ks,t as Xs,H as Js,Y as Zs,$ as rn}from"./thatopen-vendor-BZwVVjX8.js";import{B as lt,V as Z,C as Oe,a3 as Qs,c as nn,P as vt,a6 as Zo,l as sn,G as el,S as tl,h as ln,$ as ol,y as an,ab as rl,D as nl}from"./three-vendor-kQcUiZz9.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))y(i);new MutationObserver(i=>{for(const g of i)if(g.type==="childList")for(const b of g.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&y(b)}).observe(document,{childList:!0,subtree:!0});function a(i){const g={};return i.integrity&&(g.integrity=i.integrity),i.referrerPolicy&&(g.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?g.credentials="include":i.crossOrigin==="anonymous"?g.credentials="omit":g.credentials="same-origin",g}function y(i){if(i.ep)return;i.ep=!0;const g=a(i);fetch(i.href,g)}})();const sl="modulepreload",ll=function(e){return"/savora-viewer/"+e},cn={},Et=function(s,a,y){let i=Promise.resolve();if(a&&a.length>0){let P=function(f){return Promise.all(f.map(k=>Promise.resolve(k).then(j=>({status:"fulfilled",value:j}),j=>({status:"rejected",reason:j}))))};document.getElementsByTagName("link");const b=document.querySelector("meta[property=csp-nonce]"),h=b?.nonce||b?.getAttribute("nonce");i=P(a.map(f=>{if(f=ll(f),f in cn)return;cn[f]=!0;const k=f.endsWith(".css"),j=k?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${j}`))return;const N=document.createElement("link");if(N.rel=k?"stylesheet":sl,k||(N.as="script"),N.crossOrigin="",N.href=f,h&&N.setAttribute("nonce",h),document.head.appendChild(N),k)return new Promise((D,C)=>{N.addEventListener("load",D),N.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${f}`)))})}))}function g(b){const h=new Event("vite:preloadError",{cancelable:!0});if(h.payload=b,window.dispatchEvent(h),!h.defaultPrevented)throw b}return i.then(b=>{for(const h of b||[])h.status==="rejected"&&g(h.reason);return s().catch(g)})},rr="bim_viewer_api_config",il=e=>{try{return btoa(e)}catch{return e}},al=e=>{try{return atob(e)}catch{return e}},cl=e=>{const s={...e,apiKey:il(e.apiKey)};localStorage.setItem(rr,JSON.stringify(s))},dl=()=>{const e=localStorage.getItem(rr);if(!e)return null;try{const s=JSON.parse(e);return{...s,apiKey:al(s.apiKey)}}catch{return null}},ul=()=>{localStorage.removeItem(rr)},fl=e=>{switch(e){case"gemini":return["gemini-2.5-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},ho=e=>{switch(e){case"gemini":return"gemini-2.5-flash";case"openai":return"gpt-4o-mini";default:return""}},pl=async(e,s,a="gemini-2.5-flash")=>{const y=`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${e}`,i=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s}]}]})});if(!i.ok){const b=await i.json().catch(()=>({}));throw new Error(b.error?.message||`Gemini API error: ${i.status} ${i.statusText}`)}const g=await i.json();if(!g.candidates||g.candidates.length===0)throw new Error("No response from Gemini API");return g.candidates[0].content.parts[0].text},ml=async(e,s="gemini-2.0-flash-exp")=>{try{return await pl(e,"Hello, respond with OK",s),!0}catch{return!1}},gl=async(e,s,a="gpt-4o-mini")=>{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:a,messages:[{role:"user",content:s}]})});if(!i.ok){const b=await i.json().catch(()=>({}));throw new Error(b.error?.message||`OpenAI API error: ${i.status} ${i.statusText}`)}const g=await i.json();if(!g.choices||g.choices.length===0)throw new Error("No response from OpenAI API");return g.choices[0].message.content},hl=async(e,s="gpt-4o-mini")=>{try{return await gl(e,"Hello, respond with OK",s),!0}catch{return!1}},yl="fragments-ids",le="elements-v5",de="cache-metadata-v1",bl=6,ve=()=>new Promise((e,s)=>{const a=indexedDB.open(yl,bl);a.onerror=()=>s(a.error??new Error("IndexedDB open failed")),a.onupgradeneeded=()=>{const y=a.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(g=>{y.objectStoreNames.contains(g)&&y.deleteObjectStore(g)}),y.objectStoreNames.contains(le)||y.createObjectStore(le),y.objectStoreNames.contains(de)||y.createObjectStore(de)},a.onsuccess=()=>e(a.result)}),Qo={async get(e){const s=await ve();return new Promise((a,y)=>{const b=s.transaction(le,"readonly").objectStore(le).get(e);b.onsuccess=()=>a(b.result??null),b.onerror=()=>y(b.error??new Error("IndexedDB get failed"))})},async set(e,s){const a=await ve();await new Promise((y,i)=>{const g=a.transaction([le,de],"readwrite"),b=g.objectStore(le),h=g.objectStore(de),P=b.put(s,e),f={modelKey:e,timestamp:Date.now(),elementCount:s.length,version:"1.0"};h.put(f,e),P.onsuccess=()=>y(),P.onerror=()=>i(P.error??new Error("IndexedDB set failed"))}),console.log(`üíæ Cached ${s.length} elements to IndexedDB for key: ${e.substring(0,16)}...`)},async append(e,s){if(!s||!s.length)return;const a=await ve();await new Promise((y,i)=>{const g=a.transaction([le,de],"readwrite"),b=g.objectStore(le),h=g.objectStore(de),P=b.get(e);P.onsuccess=()=>{const k=(P.result??[]).concat(s),j=b.put(k,e),N={modelKey:e,timestamp:Date.now(),elementCount:k.length,version:"1.0"};h.put(N,e),j.onsuccess=()=>y(),j.onerror=()=>i(j.error??new Error("IndexedDB append put failed"))},P.onerror=()=>i(P.error??new Error("IndexedDB append get failed"))}),console.log(`üíæ Appended ${s.length} elements to IndexedDB for key: ${e.substring(0,16)}...`)},async writePart(e,s,a){const y=`${e}::part::${String(s).padStart(6,"0")}`,i=`${e}::partindex::${String(s).padStart(6,"0")}`,g=await ve();await new Promise((b,h)=>{const P=g.transaction([le,de],"readwrite"),f=P.objectStore(le),k=P.objectStore(de),j=f.put(a,y);j.onsuccess=()=>{const N=k.get(e);N.onsuccess=()=>{const D=N.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};D.timestamp=Date.now(),D.elementCount=(D.elementCount||0)+a.length;const C=Array.isArray(D.partKeys)?D.partKeys.slice():[];C.includes(y)||C.push(y),D.partKeys=C,k.put(D,e);try{const M=a.map(v=>v.GlobalId).filter(Boolean),T=f.put(M,i);T.onsuccess=()=>{},T.onerror=()=>{}}catch{}b()},N.onerror=()=>b()},j.onerror=()=>h(j.error??new Error("IndexedDB writePart failed"))}),console.log(`üíæ Wrote part ${s} (${a.length} items) for ${e.substring(0,16)}...`)},async getPersistedIds(e){const s=await this.getPartKeys(e);if(!s||!s.length)return new Set;const a=await ve(),y=new Set;return await new Promise(i=>{const b=a.transaction(le,"readonly").objectStore(le);let h=s.length;s.forEach(P=>{const f=P.replace("::part::","::partindex::"),k=b.get(f);k.onsuccess=()=>{const j=k.result??[];for(const N of j)typeof N=="string"&&N&&y.add(N);h-=1,h===0&&i()},k.onerror=()=>{h-=1,h===0&&i()}})}),y},async getPartKeys(e){const s=await this.getMetadata(e);return Array.isArray(s?.partKeys)?s.partKeys:[]},async listParts(e){return(await this.getPartKeys(e)).slice().sort()},async readAllParts(e){const s=await ve(),a=await this.getPartKeys(e);return a.length?new Promise((y,i)=>{const b=s.transaction(le,"readonly").objectStore(le),h=[];let P=a.length;a.forEach(f=>{const k=b.get(f);k.onsuccess=()=>{const j=k.result??[];h.push(...j),P-=1,P===0&&y(h)},k.onerror=()=>{P-=1,P===0&&y(h)}})}):[]},async removeParts(e){const s=await ve(),a=`${e}::part::`,i=(await this.keys()).filter(g=>g.startsWith(a));i.length&&(await new Promise((g,b)=>{const h=s.transaction([le,de],"readwrite"),P=h.objectStore(le),f=h.objectStore(de);i.forEach(k=>P.delete(k)),f.delete(e),h.oncomplete=()=>g(),h.onerror=()=>b(h.error??new Error("IndexedDB removeParts failed"))}),console.log(`üßπ Removed ${i.length} parts for ${e.substring(0,16)}...`))},async getMetadata(e){const s=await ve();return new Promise((a,y)=>{const b=s.transaction(de,"readonly").objectStore(de).get(e);b.onsuccess=()=>a(b.result??null),b.onerror=()=>y(b.error??new Error("IndexedDB metadata get failed"))})},async remove(e){const s=await ve();await new Promise((a,y)=>{const i=s.transaction([le,de],"readwrite"),g=i.objectStore(le),b=i.objectStore(de);g.delete(e),b.delete(e),i.oncomplete=()=>a(),i.onerror=()=>y(i.error??new Error("IndexedDB delete failed"))})},async keys(){const e=await ve();return new Promise((s,a)=>{const g=e.transaction(le,"readonly").objectStore(le).getAllKeys();g.onsuccess=()=>s(g.result??[]),g.onerror=()=>a(g.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const e=await ve();return new Promise((s,a)=>{const g=e.transaction(de,"readonly").objectStore(de).getAll();g.onsuccess=()=>s(g.result??[]),g.onerror=()=>a(g.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(e=720*60*60*1e3){const s=await ve(),a=await this.getAllMetadata(),y=Date.now(),i=a.filter(g=>y-g.timestamp>e).map(g=>g.modelKey);i.length>0&&await new Promise((g,b)=>{const h=s.transaction([le,de],"readwrite"),P=h.objectStore(le),f=h.objectStore(de);i.forEach(k=>{P.delete(k),f.delete(k)}),h.oncomplete=()=>{console.log(`üßπ Cleaned up ${i.length} old cache entries from IndexedDB`),g()},h.onerror=()=>b(h.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(e,s){const a=await this.getMetadata(e);return!a||!a.modelSignature?!1:a.modelSignature===s},async updateSignature(e,s,a){const y=await ve();await new Promise((i,g)=>{const h=y.transaction(de,"readwrite").objectStore(de),P=h.get(e);P.onsuccess=()=>{const f=P.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};f.modelSignature=s,f.modelFiles=a,f.timestamp=Date.now();const k=h.put(f,e);k.onsuccess=()=>i(),k.onerror=()=>g(k.error??new Error("IndexedDB updateSignature failed"))},P.onerror=()=>g(P.error??new Error("IndexedDB updateSignature get failed"))})}},xl=async e=>{const s=new TextEncoder,a=`${e.modelUrl}|${e.extra??""}`,y=s.encode(a),i=await crypto.subtle.digest("SHA-256",y),g=new Uint8Array(i);return btoa(String.fromCharCode(...g)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},hn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},Ue=e=>e==null?[]:Array.isArray(e)?e:[e],dn=e=>{if(e==null)return[];if(typeof e=="string")try{const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}if(typeof e=="object"){const s=e;if(typeof s.__cdata=="string")try{const a=JSON.parse(s.__cdata);return Array.isArray(a)?a:[]}catch{return[]}if(Array.isArray(s.item))return s.item;if(s.item!=null)return[s.item];if(Array.isArray(s.Rule))return s.Rule;if(s.Rule!=null)return[s.Rule]}return Array.isArray(e)?e:[]},li=e=>{if(!e||typeof e!="string")return[];const s=new ps(hn);let a={};try{a=s.parse(e)}catch(f){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",f),[]}const y=a?.IdsCreator??a?.idsCreator??a?.IDS_CREATOR??a?.Ids??a,i=y?.Specification??y?.specification??y?.Specifications??y?.specifications??null;if(i){const f=Ue(i);if(f.length)return f.map((k,j)=>{const N=k?.["@_id"]?.trim?.()||`spec-${j+1}`,D=(k?.Name??k?.name??"")?.toString?.()??"",C=(k?.Description??k?.description??"")?.toString?.()??"",M=dn(k?.Applicability??k?.applicability),T=dn(k?.Requirements??k?.requirements);return{id:N,name:D,description:C,applicability:M,requirements:T}})}const g=f=>{if(!f||typeof f!="object")return[];for(const[k,j]of Object.entries(f)){const N=String(k).toLowerCase();if(N.endsWith(":specification")||N==="specification"||N==="ids:specification")return Ue(j)}for(const k of Object.values(f))if(k&&typeof k=="object"){const j=g(k);if(j&&j.length)return j}return[]},b=g(a);if(!b.length)return[];const h=f=>{if(!f)return null;if(typeof f=="string")return f;if(typeof f=="object")for(const k of Object.keys(f)){const j=k.toLowerCase();if(j.includes("simplevalue")||j==="#text"||j==="value"){const N=f[k];if(typeof N=="string")return N;if(typeof N=="object"&&(N?.value||N?.Value))return String(N.value??N.Value)}}return null};return b.map((f,k)=>{const j=f?.["@_id"]?.trim?.()||`spec-${k+1}`,N=f?.["@_name"]??f?.name??f?.Name??"",D=String(N??""),C="",M=[],T=[],v=f?.applicability??f?.Applicability??f?.["ids:applicability"]??null,$=Ue(v);for(const J of $){let re=null;const K=[J];for(;K.length&&!re;){const H=K.shift();if(!H)continue;const Re=h(H);if(Re){re=Re;break}if(typeof H=="object")for(const Ce of Object.values(H))Ce&&typeof Ce=="object"&&K.push(Ce)}re&&M.push({entity:re})}const q=f?.requirements??f?.Requirements??f?.["ids:requirements"]??null,ge=Ue(q),Q=J=>{const re=[],K=[];if(J?.property&&K.push(...Ue(J.property)),J?.Property&&K.push(...Ue(J.Property)),Array.isArray(J)&&K.push(...J),!K.length&&typeof J=="object")for(const H of Object.values(J))H&&typeof H=="object"&&K.push(H);for(const H of K){const Re=H?.propertySet??H?.PropertySet??H?.["ids:propertySet"]??H?.propertySet,Ce=H?.baseName??H?.BaseName??H?.["ids:baseName"]??H?.baseName,qe=h(Re)||h(H?.propertySet?.simpleValue)||h(H?.propertySet?.["ids:simpleValue"]),At=h(Ce)||h(H?.baseName?.simpleValue)||h(H?.baseName?.["ids:simpleValue"]),_e=[],be=H?.allowedValues??H?.AllowedValues??H?.["ids:allowedValues"];if(be){const Be=be?.values??be?.Values??be?.["ids:values"]??be,Mt=Ue(Be?.value??Be?.Value??Be?.["ids:value"]??Be??[]);for(const Ye of Mt){const $e=h(Ye)||h(Ye?.simpleValue)||h(Ye?.["ids:simpleValue"]);$e&&_e.push($e)}}if(qe||At){const Be={id:`rule-${k}-${re.length}`,propertyPath:`${qe??"Pset"}.${At??"Property"}`,operator:"equals"};_e.length&&(Be.value=_e.length===1?_e[0]:JSON.stringify(_e)),re.push(Be)}}return re};for(const J of ge){const re=Q(J);re.length&&T.push(...re)}return{id:j,name:String(D??""),description:String(C),applicability:M,requirements:T}})},ii=e=>{const s=new fs(hn);if((e??[]).some(g=>Array.isArray(g.requirements)&&g.requirements.some(b=>b&&typeof b=="object"&&"propertyPath"in b))){const b={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(e??[]).map(P=>{const f=[],k=C=>{if(!C&&C!==0)return null;if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(C?.ifcClass&&typeof C.ifcClass=="string"&&C.ifcClass.trim())return C.ifcClass.trim();const M=C?.entity??C?.ifcType??C?.type;if(M&&typeof M=="string"&&M.trim())return M.trim();const T=C?.sample??C;if(T){if(T._category&&typeof T._category=="object"){const $=T._category.value??T._category.Value;if(typeof $=="string"&&$.trim())return $.trim()}const v=T?.ifcClass??T?.category?.value??T?.type??T?._type;if(v&&typeof v=="string"&&v.trim())return v.trim()}return null};for(const C of Ue(P.applicability)){const M=k(C)??null,T=M&&String(M).trim()?String(M):"IFCELEMENT";f.push({"ids:name":{"ids:simpleValue":T}})}const j=[],N=C=>{if(C==null)return"";if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(typeof C=="object"){if(C["ids:simpleValue"])return String(C["ids:simpleValue"]);if(C.__cdata)return String(C.__cdata);if(C.Name)return String(C.Name);if(C.name)return String(C.name);for(const M of Object.keys(C)){const T=C[M];if(typeof T=="string"&&T.trim())return T;if(T&&typeof T=="object"){const v=T;if(typeof v["ids:simpleValue"]=="string")return v["ids:simpleValue"];if(typeof v.value=="string")return v.value}}return""}return""};for(const C of Ue(P.requirements))if(C&&typeof C=="object"){const M=C;let T=null,v=null;if(typeof M.propertyPath=="string"){const[K,H]=String(M.propertyPath).split(".");T=K,v=H}else M.propertyPath&&typeof M.propertyPath=="object"?(T=M.propertyPath.pset??M.propertyPath.propertySet??M.propertySet??null,v=M.propertyPath.property??M.propertyPath.prop??M.property??M.propertyName??null):(T=M.propertySet??M.pset??null,v=M.baseName??M.property??M.prop??null);const $=N(T)||"Pset",q=N(v)||"Property",ge=Kt($)||$,Q=Kt(q)||q,J={};if(J["ids:propertySet"]={"ids:simpleValue":ge},J["ids:baseName"]={"ids:simpleValue":Q},(M.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(M.value!=null&&String(M.value).trim()){let K=null;try{const H=typeof M.value=="string"?JSON.parse(M.value):M.value;Array.isArray(H)&&(K=H.map(Re=>String(Re)))}catch{}K||typeof M.value=="string"&&M.value.includes(",")&&(K=M.value.split(",").map(H=>xo(H.trim())).filter(Boolean)),K&&K.length?J["ids:allowedValues"]={"ids:values":{"ids:value":K.map(H=>({"ids:simpleValue":xo(String(H))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":xo(String(M.value))}}}}j.push({"ids:property":J})}const D={"@_ifcVersion":"IFC4","@_name":P.name??""};return f.length&&(D["ids:applicability"]={"ids:entity":f.map(C=>({"ids:name":C["ids:name"]?C["ids:name"]:C}))}),j.length&&(D["ids:requirements"]={"ids:property":j.map(C=>C["ids:property"])}),D})}},h=s.build(b);return h.startsWith("<?xml")?h:`<?xml version="1.0" encoding="UTF-8"?>
${h}`}const y={IdsCreator:{Specification:(e??[]).map(g=>({"@_id":g.id,Name:g.name,Description:g.description,Applicability:{__cdata:JSON.stringify(g.applicability??[])},Requirements:{__cdata:JSON.stringify(g.requirements??[])}}))}},i=s.build(y);return i.startsWith("<?xml")?i:`<?xml version="1.0" encoding="UTF-8"?>
${i}`},Kt=e=>e?e.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",xo=e=>!e||typeof e!="string"?e:e.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),yn=e=>{if(e==null)return"";if(typeof e=="string")return xo(e.trim());if(typeof e=="number"||typeof e=="boolean")return String(e);try{return JSON.stringify(e)}catch{return String(e)}},wl=e=>{if(!e)return{};const s={};for(const[a,y]of Object.entries(e)){if(!y||typeof y!="object")continue;const i=Kt(a)||a;for(const[g,b]of Object.entries(y)){const h=Kt(g)||g,P=`${i}.${h}`;P in s||(s[P]=yn(b))}}return s};let it=null;const Il=()=>{it=null},Cl=e=>e.slice().sort().join("|"),Sl=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],jl=(e,s)=>{if(!e||typeof e!="object")return;const a=s.map(g=>g.toLowerCase()),y=new WeakSet,i=[e];for(;i.length;){const g=i.pop();if(!(!g||typeof g!="object")&&!y.has(g)){if(y.add(g),Array.isArray(g)){for(const b of g)b&&typeof b=="object"&&i.push(b);continue}for(const[b,h]of Object.entries(g)){const P=b.toLowerCase();if(a.some(f=>P.includes(f)))if(typeof h=="string"){const f=h.trim();if(f)return f}else{if(typeof h=="number"&&Number.isFinite(h))return h.toString();if(typeof h=="boolean")return h?"true":"false";if(h&&typeof h=="object"){const f=h;if(typeof f.value=="string"){const k=f.value.trim();if(k)return k}if(typeof f.Value=="string"){const k=f.Value.trim();if(k)return k}f.value&&typeof f.value=="object"&&i.push(f.value),f.Value&&typeof f.Value=="object"&&i.push(f.Value)}}h&&typeof h=="object"&&i.push(h)}}}},vl=e=>{if(!e||typeof e!="object")return null;const s=e;for(const y of Sl){const i=s[y];if(typeof i=="string"&&i.trim().length)return i.trim()}return jl(e,["globalid","global id","guid","uniqueid"])?.trim()??null},yo=async(e,s,a)=>{console.log("üîç [collectElementsDirect] START with",s.length,"globalIds"),console.log("üîç [collectElementsDirect] Has getElementProps?",!!e.getElementProps);const y=[],i=Math.max(s.length,1);a?.onProgress?.({done:0,total:i});const g=e.getElementProps;console.log("üîç [collectElementsDirect] Using getElementProps method");for(let b=0;b<s.length;b++){const h=s[b];try{const{ifcClass:P,psets:f,attributes:k}=await g.call(e,h),j=wl(f);if("GlobalId"in j||(j.GlobalId=h),k)for(const[N,D]of Object.entries(k)){const M=`Attributes.${Kt(N)||N}`;M in j||(j[M]=yn(D))}j.ifcClass||(j.ifcClass=P),y.push({GlobalId:h,ifcClass:P,properties:j}),(b%50===0||b===s.length-1)&&a?.onProgress?.({done:y.length,total:i})}catch(P){console.warn(`IDS adapter (direct) failed to load element ${h}`,P)}}return a?.onProgress?.({done:y.length,total:i}),console.log("üîç [collectElementsDirect] COMPLETE - returning",y.length,"elements"),y},kl=async(e,s,a)=>{if(typeof e.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const y=Math.max(1,(navigator.hardwareConcurrency||4)-1);console.log(`üöÄ Starting parallel property extraction with ${y} workers`);const i=[],g=[],b=[];for(let f=0;f<y;f++){const k=new Worker(new URL("/savora-viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});i.push(k);const j=new Promise((N,D)=>{const C=T=>{const v=T.data;if(v){if(v.type==="error"){D(new Error(v.message||`Worker ${f} failed.`));return}if(v.type==="progress"){const $=b.reduce((q,ge)=>q+ge.length,0)+v.done;a?.onProgress?.({done:$,total:Math.max(s,$)});return}v.type==="done"&&(b[f]=v.elements??[],N(v.elements??[]))}},M=T=>{D(T.error??new Error(T.message||`Worker ${f} error.`))};k.addEventListener("message",C),k.addEventListener("error",M)});g.push(j),k.postMessage({type:"build-props",reset:!0,total:s})}a?.onProgress?.({done:0,total:s});const h=new Set;let P=0;try{for await(const f of e.iterElements({batchSize:128})){if(!Array.isArray(f)||!f.length)continue;const k=[];f.forEach(j=>{if(!j||typeof j!="object")return;const N=j.data;if(!N)return;const D=vl(N);if(!D||h.has(D))return;h.add(D);const C=typeof N.ifcClass=="string"?N.ifcClass:void 0;k.push({globalId:D,ifcClass:C,data:N})}),k.length&&(i[P].postMessage({type:"build-props",elements:k}),P=(P+1)%y)}}catch(f){throw i.forEach(k=>{k.postMessage({type:"cancel"}),k.terminate()}),f}i.forEach(f=>{f.postMessage({type:"build-props",final:!0})});try{const k=(await Promise.all(g)).flat();return console.log(`‚úÖ Parallel processing complete: ${k.length} elements processed by ${y} workers`),a?.onProgress?.({done:k.length,total:Math.max(s,k.length)}),k}finally{i.forEach(f=>f.terminate())}},El=async(e,s)=>{try{const a=typeof s.countElements=="function"?await s.countElements():void 0;return await xl({modelUrl:e,extra:a!=null?String(a):void 0})}catch(a){return console.warn("IDS adapter: failed to compute model key for cache",a),null}},Pl=async(e,s)=>{if(console.log("üîç [collectElementsForIds] START",{hasFilterGlobalIds:!!s?.filterGlobalIds,filterCount:s?.filterGlobalIds?.length}),!e)return console.log("üîç [collectElementsForIds] No viewerApi"),[];let a;if(s?.filterGlobalIds&&s.filterGlobalIds.length>0)console.log("üîç [collectElementsForIds] Using provided filterGlobalIds directly (skipping listGlobalIds)"),a=s.filterGlobalIds;else{console.log("üîç [collectElementsForIds] Calling listGlobalIds...");const P=await e.listGlobalIds();console.log("üîç [collectElementsForIds] Got all GlobalIds:",P.length),a=P}if(console.log("üîç [collectElementsForIds] GlobalIds to validate:",a.length),!a.length)return console.log("üîç [collectElementsForIds] No GlobalIds to process"),it=null,[];console.log("üîç [collectElementsForIds] Building cache token...");const y=Cl(a);console.log("üîç [collectElementsForIds] Token built:",y.substring(0,20)+"...");const i=Math.max(a.length,1);if(s?.onPhase?.("BUILDING_PROPERTIES"),s?.onProgress?.({done:0,total:i}),console.log("üîç [collectElementsForIds] Checking memory cache..."),it&&it.token===y)return console.log("üîç [collectElementsForIds] Memory cache HIT! Returning",it.elements.length,"elements"),it.elements;console.log("üîç [collectElementsForIds] Memory cache MISS");const g=s?.filterGlobalIds&&s.filterGlobalIds.length>0;let b=null;if(g)console.log("üîç [collectElementsForIds] Skipping persistent cache (filtering mode)");else if(console.log("üîç [collectElementsForIds] Resolving persistent key..."),b=await El(y,e),console.log("üîç [collectElementsForIds] Persistent key:",b),b){console.log("üîç [collectElementsForIds] Checking IndexedDB cache...");try{const P=await Qo.get(b);if(console.log("üîç [collectElementsForIds] IndexedDB returned:",P?.length||0,"elements"),P&&P.length){const f=await Qo.getMetadata(b),k=f?Math.round((Date.now()-f.timestamp)/1e3/60):0;return console.log(`‚ö° Using cached elements from IndexedDB: ${P.length} elements (cached ${k} minutes ago)`),s?.onProgress?.({done:P.length,total:i}),it={token:y,elements:P},P}console.log("üîç [collectElementsForIds] IndexedDB cache MISS or empty")}catch(P){console.warn("IDS adapter: failed to read cached elements from IndexedDB",P)}}let h=[];if(console.log("üîç [collectElementsForIds] Decision point:",{isFiltering:g,willUseDirect:g,globalIdsCount:a.length}),g)console.log(`üìå Filtering mode: collecting ${a.length} specific elements directly`),console.log("üîç [collectElementsForIds] Calling collectElementsDirect..."),h=await yo(e,a,s),console.log("üîç [collectElementsForIds] collectElementsDirect returned:",h.length,"elements");else{console.log("üîç [collectElementsForIds] Full model mode - using workers");const P=typeof e.countElements=="function"?await e.countElements().catch(()=>a.length):a.length;if(console.log("üîç [collectElementsForIds] Total elements:",P),typeof e.iterElements=="function")try{console.log("üîç [collectElementsForIds] Calling buildWithWorker..."),h=await kl(e,P??a.length,s),console.log("üîç [collectElementsForIds] buildWithWorker returned:",h.length,"elements"),h.length||(console.log("üîç [collectElementsForIds] No elements from worker, falling back to direct"),h=await yo(e,a,s))}catch(f){console.warn("IDS adapter: property build worker failed, falling back to direct collection",f),h=await yo(e,a,s)}else console.log("üîç [collectElementsForIds] iterElements not available, using direct"),h=await yo(e,a,s)}return b&&h.length&&Qo.set(b,h).catch(P=>console.warn("IDS adapter: failed to persist elements cache",P)),it={token:y,elements:h},s?.onProgress?.({done:Math.min(h.length,i),total:i}),h},Al={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let ht=Al;const or=new Set;let gt=null;const Ml=()=>{or.forEach(e=>{try{e()}catch(s){console.error("IDS store listener error",s)}})},ce=e=>{ht=e(ht),Ml()};let at=null,wo=null;const Rl=()=>(at||(at=new Worker(new URL("/savora-viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),at),$l=(e,s)=>{const a=Rl(),y=new Promise((i,g)=>{const b=P=>{const f=P.data;if(f){if(f.type==="error"){a.removeEventListener("message",b),a.removeEventListener("error",h),g(new Error(f.message||"IDS worker failed"));return}if(f.type==="phase"){s?.onPhase?.(f.label);return}if(f.type==="progress"){s?.onProgress?.(f);return}if(f.type==="done"){a.removeEventListener("message",b),a.removeEventListener("error",h),i(f);return}}},h=P=>{a.removeEventListener("message",b),a.removeEventListener("error",h),g(P.error??new Error(P.message))};a.addEventListener("message",b),a.addEventListener("error",h),a.postMessage(e)});return wo=y.finally(()=>{wo=null}),y},un=()=>{ce(e=>({...e,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:e=>(or.add(e),()=>or.delete(e)),getState:()=>ht,setIdsXmlText:(e,s)=>{const a=e.replace(/\uFEFF/g,"").trim(),y=s?.fileNames??[];ce(i=>({...i,idsXmlText:a,idsFileNames:y,error:null})),un()},appendDocuments:e=>{if(!e.length)return;const s=fe.getState(),a=[];s.idsXmlText.trim().length&&a.push(s.idsXmlText.trim()),a.push(...e.map(g=>g.content.trim()).filter(Boolean));const y=a.join(`

`),i=[...s.idsFileNames,...e.map(g=>g.name)];fe.setIdsXmlText(y,{fileNames:i})},clearResults:()=>{un()},setValidationMode:e=>{ce(s=>({...s,validationMode:e}))},filterRows:(e,s)=>{ce(a=>{if(!e)return{...a,filteredRows:a.rows,filterDescription:null};const y=a.rows.filter(i=>{try{return e(i)}catch(g){return console.warn("IDS filter predicate threw an error",g),!0}});return{...a,filteredRows:y,filterDescription:s??null}})},runCheck:async e=>{if(!e){ce(i=>({...i,error:"Viewer API is not available."}));return}if(ht.isChecking){await wo;return}const s=ht.idsXmlText.trim();if(!s){ce(i=>({...i,error:"Load at least one IDS XML file before running the check."}));return}let a;if(ht.validationMode==="selected")if(console.log("üéØ Selected Only mode is active"),e.getSelectedGlobalIds){if(console.log("üéØ Getting selected GlobalIds..."),a=await e.getSelectedGlobalIds(),console.log("üéØ Selected GlobalIds:",a),!a||a.length===0){console.error("‚ùå No elements selected"),ce(i=>({...i,error:"No elements selected. Please select elements or switch to another mode."}));return}console.log(`üéØ Validating ${a.length} selected elements`)}else{console.warn("‚ö†Ô∏è getSelectedGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Selected elements validation is not supported by this viewer."}));return}else if(ht.validationMode==="visible")if(console.log("üëÅÔ∏è Visible Only mode is active"),e.getVisibleGlobalIds){if(console.log("üëÅÔ∏è Getting visible GlobalIds..."),a=await e.getVisibleGlobalIds(),console.log("üëÅÔ∏è Visible GlobalIds:",a),!a||a.length===0){console.error("‚ùå No visible elements found"),ce(i=>({...i,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}console.log(`üëÅÔ∏è Validating ${a.length} visible elements`)}else{console.warn("‚ö†Ô∏è getVisibleGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Visible elements validation is not supported by this viewer."}));return}ce(i=>({...i,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),gt=new AbortController;const y=gt.signal;try{if(y.aborted)throw new Error("Validation cancelled");const i=await Pl(e,{filterGlobalIds:a,onPhase:f=>{ce(k=>({...k,phase:f}))},onProgress:f=>{ce(k=>({...k,progress:f}))}});if(!i.length)throw new Error("No IFC elements were found in the current viewer.");if(y.aborted)throw new Error("Validation cancelled");ce(f=>({...f,phase:"CHECKING_IDS",progress:null}));const g={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},b=await $l({type:"validate",idsXml:s,elements:i},{onPhase:f=>{const k=g[f];k&&ce(j=>({...j,phase:k}))},onProgress:f=>{ce(k=>({...k,progress:{done:f.done,total:f.total}}))}}),h=b.rules??[],P=b.rows??[];if(a&&a.length>0&&typeof e.addToCache=="function"){console.log(`üì¶ Adding ${a.length} validated elements to cache...`);try{await e.addToCache(a),console.log("üì¶ Successfully updated cache with validated elements")}catch(f){console.warn("üì¶ Failed to add elements to cache:",f)}}ce(f=>({...f,isChecking:!1,rules:h,rows:P,filteredRows:P,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),gt=null}catch(i){const g=i instanceof Error?i.message:"Failed to run IDS validation.";console.error("IDS run failed",i),ce(b=>({...b,isChecking:!1,error:g,phase:"ERROR",progress:null})),gt=null}},invalidateCaches:()=>{Il(),at&&(at.terminate(),at=null,wo=null),ce(e=>({...e,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{console.log("üõë Cancelling IDS validation..."),gt&&(gt.abort(),gt=null),at&&at.postMessage({type:"cancel"}),ce(e=>({...e,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},zl=e=>d.useSyncExternalStore(fe.subscribe,()=>e({...fe.getState(),...fe}),()=>e({...fe.getState(),...fe})),Dl=e=>d.useSyncExternalStore(fe.subscribe,()=>e(fe.getState()),()=>e(fe.getState())),Fl=()=>{const e=d.useCallback(fe.setIdsXmlText,[]),s=d.useCallback(fe.appendDocuments,[]),a=d.useCallback(fe.clearResults,[]),y=d.useCallback(fe.filterRows,[]),i=d.useCallback(fe.runCheck,[]),g=d.useCallback(fe.setValidationMode,[]),b=d.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:e,appendDocuments:s,clearResults:a,filterRows:y,runCheck:i,setValidationMode:g,cancelValidation:b,invalidateCaches:fe.invalidateCaches}},bn=fe,Tl=Object.freeze(Object.defineProperty({__proto__:null,idsStore:bn,useIdsActions:Fl,useIdsStore:zl,useIdsStoreSelector:Dl},Symbol.toStringTag,{value:"Module"})),Nl=Pt.lazy(()=>Et(()=>import("./ChatWindow-BBNG4D7z.js"),__vite__mapDeps([0,1,2,3]))),Ll=Pt.lazy(()=>Et(()=>import("./IdsPanel-D2zp8LjB.js"),__vite__mapDeps([4,1,2,3]))),Ol=Pt.lazy(()=>Et(()=>import("./IdsCreatorPanel-DaK4iNXA.js"),__vite__mapDeps([5,1,2,3]))),Vl=Pt.lazy(()=>Et(()=>import("./ModelFilterPanel-F1ZSOG4c.js"),__vite__mapDeps([6,1]))),er=(e,s)=>{if(e.length!==s.length)return!1;for(let a=0;a<e.length;a+=1){const y=e[a],i=s[a];if(!i||y.modelId!==i.modelId||y.localId!==i.localId)return!1}return!0},_l={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Bl=(e,s)=>{if(!e)return s;const a=[e.ifcCategory,e.Category,e.category,e.ifcClass,e.class,e.type,e.Type,e.system,e.System];for(const y of a)if(typeof y=="string"&&y.trim())return y.trim();if(Array.isArray(e.categories)&&e.categories.length){const y=e.categories.find(i=>typeof i=="string"&&i.trim());if(y)return y.trim()}return typeof e.name=="string"&&e.name.trim()?e.name.trim():typeof e.Name=="string"&&e.Name.trim()?e.Name.trim():typeof e.label=="string"&&e.label.trim()?e.label.trim():s},Gl=(e,s,a)=>{const y=new Map;let i=0,g=0,b=0;a.traverse(j=>{const N=!!j?.isInstancedMesh,D=!!j?.isMesh;if(!N&&!D)return;let C=0;if(N){let v=0;typeof j.count=="number"?v=j.count:typeof j.instanceCount=="number"?v=j.instanceCount:Array.isArray(j.instanceIdMap)?v=j.instanceIdMap.length:Array.isArray(j.userData?.ids)?v=j.userData.ids.length:typeof j.userData?.size=="number"&&(v=j.userData.size),Number.isFinite(v)&&v>0&&(C=v,g+=v)}else C=1,b+=1;C<=0&&(C=1),i+=C;const M=Bl(j?.userData??{},j?.type??"Mesh"),T=y.get(M)??0;y.set(M,T+C)});const h=Array.from(y.entries()).map(([j,N])=>({category:j,count:N})).sort((j,N)=>N.count-j.count),P=new lt().setFromObject(a),f=new Z,k=new Z;return P.getSize(f),P.getCenter(k),{modelId:e,label:s,elementCount:i,instancedCount:g,meshCount:b,categoryCounts:h,bboxSize:{x:f.x,y:f.y,z:f.z},bboxCenter:{x:k.x,y:k.y,z:k.z},collectedAt:Date.now()}},Wl=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),He=e=>{if(!e)return"";let s=e.replace(/[_\-]+/g," ");return s=s.replace(/([a-z\d])([A-Z])/g,"$1 $2"),s=s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),s=s.replace(/\s+/g," ").trim(),s?s.split(" ").map(y=>{const i=y.toUpperCase();return Wl.has(i)||i.length<=3&&/^[A-Z]+$/.test(i)?i:/^\d+(\.\d+)?$/.test(y)||!y.length?y:y.charAt(0).toUpperCase()+y.slice(1)}).join(" "):""},Ul=(e,s=200)=>e?e.length<=s?e:`${e.slice(0,s)}‚Ä¶`:"",Ae=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const s=JSON.stringify(e);return s?s.length>500?`${s.slice(0,500)}‚Ä¶`:s:""}catch{return String(e)}},Me=e=>e==null?"":typeof e!="object"?Ae(e):"value"in e?Me(e.value):"Value"in e?Me(e.Value):Array.isArray(e)?e.map(s=>Me(s)).filter(Boolean).join(", "):typeof e.x=="number"&&typeof e.y=="number"&&typeof e.z=="number"?`${Ae(e.x)}, ${Ae(e.y)}, ${Ae(e.z)}`:Ae(e),me=(e,s)=>{if(!e||typeof e!="object")return;const a=s.map(g=>g.toLowerCase()),y=new WeakSet,i=[e];for(;i.length;){const g=i.pop();if(!(!g||typeof g!="object")&&!y.has(g)){if(y.add(g),Array.isArray(g)){for(const b of g)b&&typeof b=="object"&&i.push(b);continue}for(const[b,h]of Object.entries(g)){const P=b.toLowerCase();if(a.some(f=>P.includes(f)))if(typeof h=="string"){const f=h.trim();if(f)return f}else{if(typeof h=="number"&&Number.isFinite(h))return h.toString();if(typeof h=="boolean")return h?"true":"false";if(h&&typeof h=="object"){const f=Me(h);if(f)return f}}h&&typeof h=="object"&&i.push(h)}}}},Hl=(e,s)=>{if(!e||typeof e!="object")return Io(e,300);const a=[],y=Ve(e)??me(e,["name","label","description"]);y&&a.push(`name:${y}`);const i=me(e,["category","ifcclass","ifc type","type"]);i&&a.push(`category:${i}`);const g=me(e,["globalid","global id","guid"]);g&&a.push(`globalId:${g}`);const b=me(e,["expressid","express id"]);if(b&&b!==g&&a.push(`expressId:${b}`),s>0)try{const{rows:P}=qt(e);if(P.length){const k=P.slice(0,s).map(j=>`${j.label}=${j.value}`).join(" | ");k&&a.push(`props:${k}`),P.length>s&&a.push(`propsTruncated:${P.length-s}`)}}catch(P){console.warn("Failed to build detailed property data for AI summary",P)}const h=a.filter(Boolean).join(" | ");return h?h.length>1200?`${h.slice(0,1200)}‚Ä¶`:h:Io(e,300)},fn={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},ql=new Set(["modelIdMap"]),kt=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),st=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Yt=["HasProperties","hasProperties","Properties","properties"],tr=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],pn=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),bo=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSET"?!0:Yt.some(a=>Array.isArray(e[a]))},xn=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in e||"nominalValue"in e},Yl=e=>{if(!e||typeof e!="object")return Ae(e);const s=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const a of s){if(!(a in e))continue;const y=e[a];if(y==null)continue;if(Array.isArray(y)){const g=y.map(b=>Me(b)).filter(Boolean).join(", ");if(g)return g;continue}const i=Me(y);if(i)return i}for(const[a,y]of Object.entries(e))if((typeof y=="string"||typeof y=="number"||typeof y=="boolean")&&a.toLowerCase().includes("value")){const i=Ae(y);if(i)return i}return""},Kl=(e,s,a)=>{const y=Yt.map(h=>Array.isArray(e[h])?e[h]:null).filter(h=>!!h);if(!y.length)return[];const i=He(s)||s,g=[],b=new Map;return y.flat().forEach((h,P)=>{if(!h||typeof h!="object"||!xn(h))return;const f=Ve(h)??(typeof h.Name=="string"?h.Name:void 0)??(typeof h.PropertyName=="string"?h.PropertyName:void 0),k=`Property ${P+1}`,j=f&&f.trim().length?f.trim():k,N=He(j)||j,D=Yl(h),C=kt(j)||"property",M=(b.get(C)??0)+1;b.set(C,M);const T=`${C}-${M}`,v=`Property Sets / ${i} / ${N}`,$=[v.toLowerCase()];D&&$.push(D.toLowerCase()),g.push({label:v,value:D||"",path:`property-sets/${a}/${T}`,searchText:$.join(" ").trim(),rawPsetName:s,rawPropertyName:j,rawValue:h.__rawValue??h})}),g},Ht=e=>{if(!e||typeof e!="object")return[];const s=[],a=new WeakSet,y=new Map,i=D=>{let C;if(typeof D=="string"){const $=D.trim();$.length&&(C=$)}!C&&D&&typeof D=="object"&&(C=Ve(D)??(typeof D.Name=="string"?D.Name:void 0)??(typeof D.id=="string"?D.id:void 0)),(!C||!C.length)&&(C="Property Set");const M=He(C)||C,T=kt(C)||"property-set",v=(y.get(T)??0)+1;return y.set(T,v),{rawName:C,friendlyName:M,uniqueKey:`${T}-${v}`}},g=(D,C,M)=>{const T=`Property ${M+1}`,v=D?.trim?.()?D.trim():T;if(xn(C)){const $={...C};return $.Name==null&&$.PropertyName==null&&($.Name=v),$.PropertyName==null&&($.PropertyName=$.Name??v),$.__rawValue==null&&($.__rawValue=C),$}if(C&&typeof C=="object"){const $={...C};return $.Name==null&&$.PropertyName==null&&($.Name=v),$.PropertyName==null&&($.PropertyName=$.Name??v),$.type==null&&$.Type==null&&($.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in $)&&!("nominalValue"in $)&&!("Value"in $)&&!("value"in $)&&($.NominalValue=C),$.__rawValue=C,$}return{type:"IFCPROPERTYSINGLEVALUE",Name:v,PropertyName:v,NominalValue:C,__rawValue:C}},b=(D,C)=>{const M=[],T=(v,$)=>{const q=`Property ${M.length+1}`,ge=(typeof v=="string"&&v.trim().length?v.trim():void 0)??Ve(v)??(typeof v?.Name=="string"?v.Name:void 0)??(typeof v?.PropertyName=="string"?v.PropertyName:void 0)??q;M.push(g(ge,$,M.length))};if(C&&typeof C=="object")for(const v of Yt){const $=C[v];Array.isArray($)&&$.length&&$.forEach(q=>T(q,q))}if(!M.length)if(Array.isArray(C))C.forEach(v=>T(v,v));else if(C&&typeof C=="object")for(const[v,$]of Object.entries(C))$!=null&&(pn.has(v)||Yt.includes(v)||tr.includes(v)||T(v,$));else C!=null&&T(void 0,C);return{type:"IFCPROPERTYSET",Name:D,HasProperties:M}},h=(D,C)=>{const T=Kl(C&&typeof C=="object"?C:{},D.rawName,D.uniqueKey);T.length&&s.push(...T)},P=D=>{if(!(!D||typeof D!="object")&&!a.has(D)){if(a.add(D),Array.isArray(D)){D.forEach(C=>{if(!C||typeof C!="object")return;const M=i(C),T=bo(C)?C:b(M.rawName,C);h(M,T),T&&typeof T=="object"&&a.add(T)});return}for(const[C,M]of Object.entries(D)){if(M==null)continue;const T=i(C),v=bo(M)?M:b(T.rawName,M);h(T,v),M&&typeof M=="object"&&a.add(M)}}},f=D=>{if(!D||typeof D!="object"||a.has(D))return;if(a.add(D),Array.isArray(D)){D.forEach(f);return}let C=!1;for(const M of tr)Object.prototype.hasOwnProperty.call(D,M)&&(P(D[M]),C=!0);if(bo(D)){const M=i(D);h(M,D)}!C&&!bo(D)&&Object.entries(D).forEach(([M,T])=>{tr.includes(M)||pn.has(M)||Yt.includes(M)||T&&typeof T=="object"&&f(T)})};f(e);const k=new Map,j=new Set;for(const D of s){const C=`${D.label}::${D.value}`;if(j.has(C))continue;const M=`${D.rawPsetName||"unknown"}::${D.rawPropertyName||"unknown"}::${D.value}`;k.has(M)||(j.add(C),k.set(M,D))}const N=Array.from(k.values());return s.length,N.length,N},ke={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},mn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],Xl=(e,s)=>{const a=typeof e=="string"?e.trim().toLowerCase():"";if(a&&mn.some(y=>a.startsWith(y)))return!0;if(s&&typeof s=="object"){const y=Me(s._category??s.category??s.Category??null),i=typeof y=="string"?y.trim().toLowerCase():"";if(i&&mn.some(b=>i.startsWith(b))||(s.NominalValue!=null||s.nominalValue!=null)&&(s.Name!=null||s.PropertyName!=null)&&a.includes("property"))return!0}return!1},gn="fragmentsViewer.favoritePropertyPaths",Jl=1e4,Zl=500,Ve=e=>{if(!e||typeof e!="object")return;let s,a;typeof e.Name=="string"?s=e.Name:e.Name&&typeof e.Name=="object"&&(s=Me(e.Name)||void 0),typeof e.name=="string"?a=e.name:e.name&&typeof e.name=="object"&&(a=Me(e.name)||void 0);const y=s??a;if(!y)return;const i=y.trim();return i.length?i:void 0},qt=e=>{if(!e||typeof e!="object")return{rows:[],tree:[]};const s=[],a=new WeakSet,y=(b,h,P)=>{if(b==null)return null;const f=h.map(v=>{const $=v?.trim?.()??v;return typeof $=="string"&&$.length?He($)||$:typeof v=="string"?v:String(v??"")}),k=f.filter(Boolean).join(" / "),j=P.length?P.join("/"):kt(k||"value"),N=f[f.length-1]??"Value",D=v=>{const $=k.toLowerCase(),q=[$];v&&q.push(v.toLowerCase());const ge=q.join(" ").trim()||$,Q={label:k,value:v??"",path:j,searchText:ge};return s.push(Q),ge};if(typeof b!="object"||b instanceof Date){const v=Ae(b),$=D(v);return{id:j,label:N,fullLabel:k,value:v||void 0,children:[],searchText:$}}if(a.has(b)){const v="[Circular reference]",$=D(v);return{id:j,label:N,fullLabel:k,value:v,children:[],searchText:$}}a.add(b);let C;const M=[];if(Array.isArray(b))b.forEach((v,$)=>{const q=Ve(v),ge=`${N} ${$+1}`,Q=q&&q.trim().length?q.trim():ge,J=He(Q)||Q,re=q&&q.trim().length?kt(q):String($),K=y(v,[...h,J],[...P,re]);K&&M.push(K)}),M.length===0&&(C=Ae(b));else{if("NominalValue"in b||"nominalValue"in b){const v=b.NominalValue??b.nominalValue,$=Me(v);$&&(C=$)}!C&&"value"in b&&typeof b.value!="object"&&(C=Ae(b.value)),!C&&"Value"in b&&typeof b.Value!="object"&&(C=Ae(b.Value));for(const[v,$]of Object.entries(b)){if($==null||v==="Name"||v==="name"||v==="IsDefinedBy"||v==="isDefinedBy"||v==="psets"||v==="Psets"||v==="propertySets"||v==="PropertySets"||v==="property_sets"||v==="Property_Sets")continue;if(v==="NominalValue"||v==="nominalValue"){const Re=He("Nominal Value")||"Nominal Value",Ce=y($,[...h,Re],[...P,"nominal-value"]);Ce&&M.push(Ce);continue}const q=fn[v]??v,ge=He(q)||q,Q=Ve($)?.trim(),J=Q&&Q.length?He(Q)||Q:ge,re=Q&&Q.length?kt(Q):kt(q),K=[...h,J],H=y($,K,[...P,re]);H&&M.push(H)}!C&&M.length===0&&(C=Ae(b))}const T=D(C);return{id:j,label:N,fullLabel:k,value:C,children:M,searchText:T}},i=[];for(const[b,h]of Object.entries(e)){if(h==null||ql.has(b))continue;const P=fn[b]??b,f=y(h,[P],[b]);f&&i.push(f)}if(s.length){const b=s.filter(h=>{const P=h.label.toLowerCase();return P.startsWith("property sets /")?!(P.includes("/ has properties")||P.includes("/ nominal value")):!0});b.length!==s.length&&s.splice(0,s.length,...b)}const g=Ht(e);if(g.length){const b=[],h=new Set;for(const f of g)h.has(f.path)||(h.add(f.path),b.push(f));const P=[];for(const f of s)h.has(f.path)||P.push(f);s.splice(0,s.length,...b,...P)}return{rows:s,tree:i}},Ql=()=>{const e=d.useRef(null),s=d.useRef(null),a=d.useRef(null),y=d.useRef(null),i=d.useRef(null),g=d.useRef(!1),b=d.useRef(null),h=d.useRef(null),P=d.useRef(null),[f,k]=d.useState(!1),[j,N]=d.useState([]),[D,C]=d.useState(!1),[M,T]=d.useState(50);d.useCallback(async(t,r)=>{{console.warn("dumpModelRawData is dev-only.");return}},[j]),d.useCallback(async(t,r=50,n=128)=>{},[]);const[v,$]=d.useState([]),[q,ge]=d.useState(null),[Q,J]=d.useState(!0),[re,K]=d.useState(!1),[H,Re]=d.useState(!1),[Ce,qe]=d.useState(null),[At,_e]=d.useState(!1),[be,Be]=d.useState(!1),Mt=d.useRef(null),Ye=d.useRef(!1),$e=d.useRef(null),ze=d.useRef(null),Xt=d.useRef(0),Ge=d.useRef(null),Jt=d.useRef(null),Ke=d.useRef(null),De=d.useRef(null),Rt=d.useRef(!1),yt=d.useRef(null),Zt=d.useRef("click"),[Qt,wn]=d.useState({width:360,height:520}),Co=d.useRef(null),eo=d.useRef(!1),So=d.useRef(null),nr=d.useRef(!1),sr=d.useRef(null),ct=d.useRef(null),jo=d.useRef(null),to=d.useRef(null),vo=d.useRef(null),$t=d.useRef(null),lr=d.useRef(null),ir=d.useRef(null),Xe=d.useRef(null),Fe=d.useRef([]),Te=d.useRef(null),zt=d.useRef(null),bt=d.useRef(null),[oo,Ee]=d.useState(null),[ae,In]=d.useState([]),[ar,Cn]=d.useState(""),[xt,Sn]=d.useState(""),[Se,cr]=d.useState([]),[dt,dr]=d.useState("favorites"),[jn,ei]=d.useState(!1),[vn,ti]=d.useState(!1),[kn,oi]=d.useState(!1),[ut,En]=d.useState("models"),[Je,ko]=d.useState(!1),[Pn,ur]=d.useState(0),[Ze,ro]=d.useState(!1),[An,fr]=d.useState(!1),[Mn,pr]=d.useState(!1),[he,Eo]=d.useState("disabled"),[We,Po]=d.useState(""),[Dt,no]=d.useState(""),[Ao,mr]=d.useState(!1),[gr,hr]=d.useState(!1),[yr,wt]=d.useState(null),[xe,br]=d.useState("click"),[Rn,Mo]=d.useState(0),[Qe,xr]=d.useState(!1),[wr,$n]=d.useState({}),[Ro,Ir]=d.useState(null),[Ft,Cr]=d.useState([]),[zn,$o]=d.useState(!1),[et,Sr]=d.useState("selected"),[tt,so]=d.useState(""),[ft,jr]=d.useState(!1),[vr,lo]=d.useState(null),[Dn,kr]=d.useState(!1),[ne,io]=d.useState({x:!1,y:!1,z:!1}),[Ne,Er]=d.useState({x:0,y:0,z:0}),[Tt,Pr]=d.useState(!1),[Nt,Fn]=d.useState(!1),It=d.useRef(!1),zo=d.useRef([]),Do=d.useRef(new Map),ao=d.useRef(null),[Ar,Mr]=d.useState(null),Rr=d.useRef(null),pt=d.useCallback(()=>a.current?.camera??null,[]),Fo=d.useCallback(()=>pt()?.three??null,[pt]);d.useEffect(()=>{Zt.current=xe},[xe]),d.useEffect(()=>{const t=Rr.current;!t||!("mouseButtons"in t)||(xe==="rectangle"?t.mouseButtons={left:0,middle:2,right:0,wheel:16}:t.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),d.useEffect(()=>{try{const t=window.localStorage.getItem(gn);if(!t)return;const r=JSON.parse(t);if(!Array.isArray(r))return;const n=r.filter(l=>typeof l=="string"&&l.trim().length>0);n.length&&cr(n)}catch(t){console.warn("Failed to restore favourites from storage",t)}},[]),d.useEffect(()=>{try{window.localStorage.setItem(gn,JSON.stringify(Se))}catch(t){console.warn("Failed to persist favourites to storage",t)}},[Se]);const co=ar.trim(),Tn=co.length>0,$r=d.useMemo(()=>{const t=co.toLowerCase();return t?ae.filter(r=>r.searchText.includes(t)).slice(0,Zl):[]},[co,ae]),uo=d.useMemo(()=>{const t=new Map;return ae.forEach(r=>t.set(r.path,r)),t},[ae]),To=d.useMemo(()=>ae.slice(0,Jl),[ae]),zr=Math.max(ae.length-To.length,0),Dr=d.useMemo(()=>new Set(Se),[Se]),No=d.useMemo(()=>Se.length?Se.map(t=>uo.get(t)).filter(t=>!!t):[],[Se,uo]),Lo=d.useMemo(()=>{if(!Se.length)return 0;let t=0;for(const r of Se)uo.has(r)||(t+=1);return t},[Se,uo]),Fr=d.useCallback(t=>{cr(r=>r.includes(t)?r.filter(n=>n!==t):[...r,t])},[]),fo=d.useMemo(()=>j.map(t=>`${t.id}:${t.label}`).join("|"),[j]),Oo=d.useCallback(t=>{const r=Dr.has(t.path);return o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[o.jsx(U,{variant:"body2",sx:{fontWeight:600},children:t.label}),o.jsx(te,{title:r?"Remove from favourites":"Add to favourites",children:o.jsx("span",{children:o.jsx(oe,{size:"small",onClick:()=>Fr(t.path),color:r?"primary":"default",children:r?o.jsx(ms,{fontSize:"small"}):o.jsx(gs,{fontSize:"small"})})})})]}),o.jsx(U,{variant:"body2",color:"text.secondary",children:t.value?Ul(t.value,360):"‚Äî"})]},t.path)},[Dr,Fr]);d.useEffect(()=>{if(!j.length){so("");return}so(t=>t&&j.some(r=>r.id===t)?t:j[0].id)},[j]);const Tr=d.useCallback(async t=>{const r=i.current;if(!r)return[];const n=r.list.get(t);if(!n)return[];let l=[];try{const u=await n.getLocalIds();Array.isArray(u)?l=u:u&&typeof u[Symbol.iterator]=="function"&&(l=Array.from(u))}catch(u){return console.warn(`Failed to retrieve local IDs for model ${t}`,u),[]}if(!l.length)return[];const c=32,m=[];for(let u=0;u<l.length;u+=c){const S=l.slice(u,u+c);let x=[];try{x=await n.getItemsData(S,ke)}catch(p){console.warn(`Failed to fetch items data for model ${t} chunk starting at ${S[0]}`,p);continue}x.forEach((p,E)=>{const R=S[E];if(p)try{const{rows:F}=qt(p);F.forEach(I=>{m.push({path:`localId:${R} / ${I.label}`,value:I.value})})}catch(F){console.warn(`Failed to process properties for model ${t} localId ${R}`,F)}})}return m},[]),Nr=d.useCallback(t=>{const r=[];return r.push("Path,Value"),t.forEach(({path:n,value:l})=>{const c=n.replace(/"/g,'""'),m=(l??"").replace(/"/g,'""');r.push(`"${c}","${m}"`)}),r.join(`\r
`)},[]),Nn=d.useCallback(()=>{lo(null),Sr(ae.length?"selected":"model"),j.length&&!j.some(t=>t.id===tt)&&so(j[0].id),$o(!0)},[ae.length,j,tt]),Ln=d.useCallback(async()=>{if(!q){alert("No element selected");return}try{const t=new WeakSet,r=JSON.stringify(q,(n,l)=>{if(typeof l=="object"&&l!==null){if(t.has(l))return"[Circular Reference]";t.add(l)}return l instanceof Map?`[Map with ${l.size} entries]`:l instanceof Set?`[Set with ${l.size} items]`:l instanceof WeakMap||l instanceof WeakSet?"[WeakMap/WeakSet]":typeof l=="function"?"[Function]":typeof l=="symbol"?"[Symbol]":l},2);await navigator.clipboard.writeText(r),alert("Raw element data copied to clipboard!")}catch(t){console.error("Failed to copy raw data:",t),alert("Failed to copy data to clipboard. See console for details.")}},[q]),Lr=d.useCallback(()=>{ft||($o(!1),lo(null))},[ft]),On=d.useCallback(async()=>{if(!ft){jr(!0),lo(null);try{let t=[];if(et==="selected"){if(!ae.length)throw new Error("No properties available for the current selection.");t=ae.map(S=>({path:S.label,value:S.value}))}else{if(!tt)throw new Error("Select a model to export.");if(t=await Tr(tt),!t.length)throw new Error("No properties were found for the chosen model.")}const r=Nr(t),n=new Blob([r],{type:"text/csv;charset=utf-8;"}),l=URL.createObjectURL(n),c=document.createElement("a"),m=et==="selected"?"selection":`model-${tt}`,u=new Date().toISOString().replace(/[:.]/g,"-");c.href=l,c.download=`fragment-properties-${m}-${u}.csv`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(l),$o(!1)}catch(t){console.warn("Failed to export properties",t),lo(t.message??"Failed to export properties.")}finally{jr(!1)}}},[Nr,tt,et,Tr,ft,ae]),Pe=d.useCallback(t=>{const r=t??null;ge(r);const{rows:n}=qt(r);if(In(n),dr(Se.length?"favorites":"all"),n.length){Cr(n.map(m=>({path:m.label,value:m.value})));const l="Path	Value",c=n.map(m=>`${m.label}	${m.value??""}`);Ir([l,...c].join(`\r
`))}else Cr([]),Ir(null)},[Se.length]),Or=d.useCallback(()=>{xr(t=>!t)},[]),Vn=d.useCallback(()=>{ko(!0),ur(t=>t+1)},[]),_n=d.useCallback(()=>{ko(!1)},[]),Vr=d.useCallback(()=>{ko(t=>{const r=!t;return r&&ur(n=>n+1),r})},[]),Bn=d.useCallback(()=>{fr(!0)},[]),_r=d.useCallback(()=>{fr(!1)},[]),Br=d.useCallback(()=>{const t=dl();t?(Eo(t.provider),Po(t.apiKey),no(t.model||ho(t.provider))):(Eo("disabled"),Po(""),no("")),wt(null),pr(!0)},[]),po=d.useCallback(()=>{pr(!1),mr(!1),wt(null)},[]),Gn=d.useCallback(()=>{if(he==="disabled")ul();else{const t={provider:he,apiKey:We,model:Dt||ho(he)};cl(t)}po()},[he,We,Dt,po]),Wn=d.useCallback(t=>{Eo(t),no(ho(t)),wt(null)},[]),Un=d.useCallback(async()=>{if(!(!We||he==="disabled")){hr(!0),wt(null);try{let t=!1;const r=Dt||ho(he);he==="gemini"?t=await ml(We,r):he==="openai"&&(t=await hl(We,r)),wt(t?"success":"error")}catch{wt("error")}finally{hr(!1)}}},[he,We,Dt]),Lt=d.useCallback(t=>{if(!t||typeof t!="object")return"IfcProduct";if(t.constructor&&typeof t.constructor.name=="string"&&t.constructor.name.toUpperCase().startsWith("IFC")){const c=t.constructor.name.trim();if(c!=="Object"&&c!=="Array")return c}const r=Me(t._category??t.category??t.Category??null);if(r&&r.trim().length&&r.toUpperCase().startsWith("IFC"))return r.trim();const n=[t.expressID!==void 0?null:t.type,t.ifcClass,t.IfcClass,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.ifcType,t.IfcType,t?.attributes?.ifcClass,t?.Attributes?.IfcClass];for(const c of n)if(typeof c=="string"&&c.trim().length){const m=c.trim();if(m.toUpperCase().startsWith("IFC")&&!m.toUpperCase().includes("IDENTIFIER")&&!m.toUpperCase().includes("LABEL")&&!m.toUpperCase().includes("TEXT"))return m}const l=me(t,["ifcclass","ifc type","express type"]);return l&&l.toUpperCase().startsWith("IFC")?l:"IfcProduct"},[]),Vo=d.useCallback((t,r,n)=>{const l={},c={},m={};Ht(t).forEach(E=>{const R=E.label.split("/").map(O=>O.trim()),F=E.rawPsetName??R[1]??"",I=E.rawPropertyName??R[R.length-1]??"",w=st(F),A=st(I);if(!w||!A)return;c[w]||(c[w]={}),A in c[w]||(c[w][A]=E.value);const _=`${w}.${A}`;_ in l||(l[_]=E.value)}),l.GlobalId=r,l.ifcClass=n,m.ifcClass=n,m.GlobalId=r,l["Attributes.GlobalId"]=r,l["Attributes.IfcClass"]=n,l["Attributes.ifcClass"]=n;const S=Ve(t);S&&(m.Name=S,l["Attributes.Name"]=S);const x=me(t,["category","ifccategory"]);x&&(m.Category=x,l["Attributes.Category"]=x);const p=me(t,["type","typename"]);p&&(m.Type=p,l["Attributes.Type"]=p);for(const[E,R]of Object.entries(t??{})){if(R==null||typeof R!="object"||Array.isArray(R))continue;const F=Me(R);if(!F)continue;const I=String(E).replace(/^_+/,""),w=`Attributes.${He(I)}`;if(w in l||(l[w]=F),I in m||(m[I]=F),/guid|globalid|_guid/i.test(E)){const A=String(F).trim();A&&!l.GlobalId&&(l.GlobalId=A,m.GlobalId=A)}}return{flattened:l,psets:c,attributes:m}},[]),_o=d.useCallback(()=>{const t=i.current;return t?`${Array.from(t.list.keys()).sort().join("|")}|${j.length}`:"empty"},[j]),Hn=d.useCallback(async()=>{console.log("üîë [computeModelSignature] START");const t=i.current;if(!t||t.list.size===0)return console.log("‚ö†Ô∏è [computeModelSignature] No fragments available"),{signature:"empty",elementCount:0,modelFiles:[]};console.log(`üìä [computeModelSignature] Found ${t.list.size} models in fragments`);const r=Array.from(t.list.keys()).sort();console.log("üîë [computeModelSignature] Model IDs:",r);const n=j.map(S=>({id:S.id,name:S.label}));console.log("üìÅ [computeModelSignature] Model files:",n),console.log("üî¢ [computeModelSignature] Counting elements across all models...");let l=0;for(const[S,x]of t.list){console.log(`üîç [computeModelSignature] Getting local IDs for model ${S}...`);try{const p=await x.getLocalIds();console.log(`‚úÖ [computeModelSignature] Got local IDs for model ${S}, type:`,typeof p);const E=Array.isArray(p)?p:p&&typeof p[Symbol.iterator]=="function"?Array.from(p):[];console.log(`üìä [computeModelSignature] Model ${S} has ${E.length} elements`),l+=E.length}catch(p){console.error(`‚ùå [computeModelSignature] Failed to count elements in model ${S}`,p)}}console.log(`üìä [computeModelSignature] Total elements across all models: ${l}`);const m=[...r,...j.map(S=>`${S.id}:${S.label}`),`count:${l}`].join("|");console.log("üîë [computeModelSignature] Generated signature (first 100 chars):",m.substring(0,100));const u={signature:m,elementCount:l,modelFiles:n};return console.log("‚úÖ [computeModelSignature] COMPLETE:",u),u},[j]),mo=d.useCallback(async()=>{const t=i.current;if(!t||t.list.size===0){const l={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Te.current=l,l}const r=_o();if(Te.current&&Te.current.signature===r)return Te.current;if(zt.current)return zt.current;const n=(async()=>{const l=new Map,c=[],m=new Map;for(const[S,x]of t.list){let p=[];try{const R=await x.getLocalIds();Array.isArray(R)?p=R:R&&typeof R[Symbol.iterator]=="function"&&(p=Array.from(R))}catch(R){console.warn(`IDS cache: failed to read local IDs for model ${S}`,R);continue}if(m.set(S,p.slice()),!p.length)continue;const E=48;for(let R=0;R<p.length;R+=E){const F=p.slice(R,R+E);let I=[];try{I=await x.getItemsData(F,ke)}catch(w){console.warn(`IDS cache: failed to fetch items data for model ${S}`,w);continue}I.forEach((w,A)=>{if(!w)return;const _=F[A],O=Lt(w),V=typeof w.GlobalId=="string"&&w.GlobalId.trim()||typeof w.GlobalID=="string"&&w.GlobalID.trim()||me(w,["globalid","global id","guid"]);if(!V){if(Xl(O,w))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:S,localId:_,itemData:w});return}const z=V.trim();if(!z.length||l.has(z))return;const{flattened:L,psets:B,attributes:Y}=Vo(w,z,O),X={GlobalId:z,ifcClass:O,properties:L},G=w;(typeof G.GlobalId!="string"||!G.GlobalId.trim())&&(G.GlobalId=z),l.set(z,{element:X,modelId:S,localId:_,psets:B,attributes:Y,raw:G}),c.push(X)})}}const u={signature:r,records:l,elements:c,modelLocalIds:m};return Te.current=u,u})().finally(()=>{zt.current=null});return zt.current=n,n},[_o,Vo,Lt]),Ct=d.useCallback(async t=>{const r=new Map;console.log(`üîç [groupLocalIdsByModel] Grouping ${t.length} GlobalIds using ThatOpen API...`);const n=i.current;if(!n)return console.error("üîç [groupLocalIdsByModel] Fragments not available"),{grouped:r,cache:Te.current};for(const[l,c]of n.list)try{const m=await c.getLocalIdsByGuids(t),u=[];for(let S=0;S<m.length;S++){const x=m[S];x!==null&&u.push(x)}u.length>0&&r.set(l,u)}catch(m){console.warn(`üîç [groupLocalIdsByModel] Failed for model ${l}:`,m)}return console.log(`üîç [groupLocalIdsByModel] Grouped ${t.length} GlobalIds into ${r.size} models (${Array.from(r.values()).reduce((l,c)=>l+c.length,0)} total local IDs)`),{grouped:r,cache:Te.current}},[]),Bo=Pt.useMemo(()=>({listGlobalIds:async()=>(await mo()).elements.map(r=>r.GlobalId),getSelectedGlobalIds:async()=>{console.log("üìç getSelectedGlobalIds called, selectedRef.current:",Fe.current);const t=Fe.current;if(!t||t.length===0)return console.log("üìç No selection found"),[];const r=i.current;if(!r)return console.warn("üìç Fragments not available"),[];console.log("üìç Processing selection:",t);const n=[];for(const l of t){const c=r.list.get(l.modelId);if(!c){console.warn("üìç Model not found for item:",l);continue}try{const[m]=await c.getItemsData([l.localId],{attributesDefault:!1});if(m){const u=me(m,["globalid","global id","guid"]);u&&typeof u=="string"?(n.push(u),console.log("üìç Found GlobalId for item:",l,"‚Üí",u)):console.warn("üìç No GlobalId found in data for item:",l)}}catch(m){console.error("üìç Error fetching data for item:",l,m)}}return console.log("üìç Final selectedGlobalIds:",n),n},getVisibleGlobalIds:async()=>{console.log("üëÅÔ∏è getVisibleGlobalIds called");const t=i.current;if(!t)return console.warn("üëÅÔ∏è Fragments not available"),[];const r=[];for(const[n,l]of t.list)try{console.log(`üëÅÔ∏è Getting visible elements from model: ${n}`);const c=await l.getItemsByVisibility(!0);if(console.log(`üëÅÔ∏è Model ${n}: ${c.length} visible elements`),c.length===0)continue;const m=100;for(let u=0;u<c.length;u+=m){const S=c.slice(u,Math.min(u+m,c.length));try{const x=await l.getItemsData(S,{attributesDefault:!1,attributes:["GlobalId"]});for(const p of x){const E=me(p,["globalid","global id","guid"]);E&&typeof E=="string"&&r.push(E)}}catch(x){console.error(`üëÅÔ∏è Error fetching GlobalIds for batch in model ${n}:`,x)}}}catch(c){console.error(`üëÅÔ∏è Error getting visible elements from model ${n}:`,c)}return console.log(`üëÅÔ∏è Total visible GlobalIds: ${r.length}`),r},getElementProps:async t=>{console.log("üîç [getElementProps] START for",t);const r=i.current;if(!r)throw new Error("Fragments not available");console.log("üîç [getElementProps] Searching across",r.list.size,"models");for(const[n,l]of r.list)try{const m=(await l.getLocalIdsByGuids([t]))[0];if(m!=null){console.log(`üîç [getElementProps] Found in model ${n}, localId: ${m}`);const[u]=await l.getItemsData([m],ke);if(!u){console.warn(`üîç [getElementProps] No data returned for localId ${m}`);continue}console.log("üîç [getElementProps] Got data, extracting properties...");const S=Lt(u);console.log("üîç [getElementProps] ifcClass:",S);const x={},p={},E=Ht(u);console.log("üîç [getElementProps] Got",E.length,"property rows"),E.forEach(w=>{const A=w.label.split("/").map(L=>L.trim()),_=w.rawPsetName??A[1]??"",O=w.rawPropertyName??A[A.length-1]??"",V=st(_),z=st(O);!V||!z||(x[V]||(x[V]={}),z in x[V]||(x[V][z]=w.value))}),p.ifcClass=S,p.GlobalId=t;const R=Ve(u);R&&(p.Name=R);const F=me(u,["category","ifccategory"]);F&&(p.Category=F);const I=me(u,["type","typename"]);return I&&(p.Type=I),console.log(`üîç [getElementProps] SUCCESS: ${Object.keys(x).length} psets, ${Object.keys(p).length} attributes`),{ifcClass:S,psets:x,attributes:p}}}catch(c){console.warn(`üîç [getElementProps] Error in model ${n}:`,c);continue}throw console.error(`üîç [getElementProps] Element with GlobalId ${t} not found in any model`),new Error(`Element with GlobalId ${t} is not available.`)},getElementPropsFast:async t=>{console.log("üîç [getElementPropsFast] START for",t);const r=Fe.current,n=i.current;if(console.log("üîç [getElementPropsFast] Selection:",r),console.log("üîç [getElementPropsFast] Fragments available:",!!n),!n)throw console.error("üîç [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");console.log("üîç [getElementPropsFast] Searching in",r.length,"selected items");for(let l=0;l<r.length;l++){const c=r[l];console.log(`üîç [getElementPropsFast] Checking item ${l+1}/${r.length}:`,c);const m=n.list.get(c.modelId);if(!m){console.log(`üîç [getElementPropsFast] Model not found for ${c.modelId}`);continue}try{console.log(`üîç [getElementPropsFast] Calling getItemsData for localId ${c.localId}...`);const[u]=await m.getItemsData([c.localId],ke);if(console.log("üîç [getElementPropsFast] Got data:",!!u),u){console.log("üîç [getElementPropsFast] Data keys:",Object.keys(u)),console.log("üîç [getElementPropsFast] data._category:",u._category),console.log("üîç [getElementPropsFast] data.ifcClass:",u.ifcClass),console.log("üîç [getElementPropsFast] data.type:",u.type),console.log("üîç [getElementPropsFast] data.constructor.name:",u.constructor?.name);const S=me(u,["globalid","global id","guid"]);if(console.log(`üîç [getElementPropsFast] Element GlobalId: ${S}, looking for: ${t}`),S===t){console.log("üîç [getElementPropsFast] MATCH! Extracting properties...");const x=Lt(u);console.log("üîç [getElementPropsFast] ifcClass extracted:",x);const p={},E={};console.log("üîç [getElementPropsFast] Calling collectIfcPropertySetRows...");const R=Ht(u);console.log("üîç [getElementPropsFast] Got",R.length,"property rows"),R.forEach(A=>{const _=A.label.split("/").map(B=>B.trim()),O=A.rawPsetName??_[1]??"",V=A.rawPropertyName??_[_.length-1]??"",z=st(O),L=st(V);!z||!L||(p[z]||(p[z]={}),L in p[z]||(p[z][L]=A.value))}),console.log("üîç [getElementPropsFast] Extracted",Object.keys(p).length,"psets"),E.ifcClass=x,E.GlobalId=t;const F=Ve(u);F&&(E.Name=F);const I=me(u,["category","ifccategory"]);I&&(E.Category=I);const w=me(u,["type","typename"]);return w&&(E.Type=w),console.log(`üìå Fast props for ${t}:`,{ifcClass:x,psetCount:Object.keys(p).length}),console.log("üîç [getElementPropsFast] SUCCESS - returning properties"),{ifcClass:x,psets:p,attributes:E}}}}catch(u){console.error("üîç [getElementPropsFast] Error for item:",c,u)}}return console.log(`üìå ${t} not in selection, falling back to cache`),console.log("üîç [getElementPropsFast] FALLBACK to getElementProps"),bt.current.getElementProps(t)},countElements:async()=>(await mo()).elements.length,iterElements:t=>{const r=Math.max(1,Math.floor(t?.batchSize??500));return console.log("üîÑ [viewerApi.iterElements] START",{batchSize:r}),{async*[Symbol.asyncIterator](){const n=i.current;if(!n||n.list.size===0){console.warn("‚ö†Ô∏è [viewerApi.iterElements] No fragments available");return}console.log(`üîÑ [viewerApi.iterElements] Processing ${n.list.size} models with batch size ${r}`);let l=[],c=0;for(const[m,u]of n.list){let S=[];try{const p=await u.getLocalIds();S=Array.isArray(p)?p:p&&typeof p[Symbol.iterator]=="function"?Array.from(p):[],console.log(`‚úÖ [viewerApi.iterElements] Model ${m}: ${S.length} elements`)}catch(p){console.error(`‚ùå [viewerApi.iterElements] Failed to get local IDs for model ${m}`,p);continue}const x=Math.min(500,Math.max(100,r));for(let p=0;p<S.length;p+=x){const E=S.slice(p,p+x);try{const R=await u.getItemsData(E,ke);for(let F=0;F<R.length;F++){const I=R[F];I&&l.push({modelId:m,localId:E[F],data:I})}for(;l.length>=r;){const F=l.splice(0,r);c+=F.length,(c%5e3===0||c===r)&&console.log(`üì§ [viewerApi.iterElements] Yielded ${c} elements...`),yield F}}catch(R){console.error(`‚ùå [viewerApi.iterElements] Failed to fetch chunk at ${p}`,R)}}}l.length>0&&(c+=l.length,yield l),console.log(`‚úÖ [viewerApi.iterElements] Complete: ${c} elements`)}}},_iterElementsLegacy:t=>{const r=Math.max(1,Math.floor(t?.batchSize??100));return{async*[Symbol.asyncIterator](){const n=await mo(),l=Array.from(n.records.values());for(let c=0;c<l.length;c+=r){const m=l.slice(c,c+r).map(u=>({modelId:u.modelId,localId:u.localId,data:{...u.raw,GlobalId:u.element.GlobalId}}));m.length&&(yield m)}}}},buildIdsCache:async()=>{try{return(await mo()).elements.length}catch(t){throw console.error("viewerApi.buildIdsCache failed",t),t}},getModelSignature:async()=>await Hn(),addToCache:async t=>{console.log(`üì¶ [addToCache] Adding ${t.length} elements to cache`);const r=i.current;if(!r){console.warn("üì¶ [addToCache] Fragments not available");return}let n=Te.current;n||(n={signature:_o(),records:new Map,elements:[],modelLocalIds:new Map},Te.current=n);const l=Fe.current;console.log(`üì¶ [addToCache] Selection has ${l.length} items`);for(const c of t){if(n.records.has(c)){console.log(`üì¶ [addToCache] ${c} already in cache, skipping`);continue}console.log(`üì¶ [addToCache] Searching for ${c} in ${l.length} selected items...`);let m=!1;for(const u of l){console.log(`üì¶ [addToCache] Checking item: modelId=${u.modelId}, localId=${u.localId}`);const S=r.list.get(u.modelId);if(!S){console.log(`üì¶ [addToCache] Model not found: ${u.modelId}`);continue}try{const[x]=await S.getItemsData([u.localId],ke);if(x){let p=x._guid||x.GlobalId;if(p&&typeof p=="object"&&(p=p.value||p),console.log(`üì¶ [addToCache] Item GlobalId: ${p}, looking for: ${c}, match: ${p===c}`),p===c){const E=Lt(x),R={};Ht(x).forEach(L=>{const B=L.label.split("/").map(se=>se.trim()),Y=L.rawPsetName??B[1]??"",X=L.rawPropertyName??B[B.length-1]??"",G=st(Y),pe=st(X);!G||!pe||(R[G]||(R[G]={}),pe in R[G]||(R[G][pe]=L.value))});const I={ifcClass:E,GlobalId:c},w=Ve(x);w&&(I.Name=w);const A=me(x,["category","ifccategory"]);A&&(I.Category=A);const _=me(x,["type","typename"]);_&&(I.Type=_);const O={GlobalId:c,ifcClass:E,properties:Vo(x,c,E)},V={element:O,modelId:u.modelId,localId:u.localId,psets:R,attributes:I,raw:x};n.records.set(c,V),n.elements.push(O);const z=n.modelLocalIds.get(u.modelId)||[];z.push(u.localId),n.modelLocalIds.set(u.modelId,z),console.log(`üì¶ [addToCache] Added ${c} to cache (model: ${u.modelId}, localId: ${u.localId})`),m=!0;break}}}catch(x){console.debug("üì¶ [addToCache] Error checking selection item:",x)}}m||console.warn(`üì¶ [addToCache] Could not find ${c} in selection`)}console.log(`üì¶ [addToCache] Cache now has ${n.records.size} elements`)},color:async(t,r)=>{if(!t.length)return;const n=Ge.current,l=i.current,c=a.current;if(!n||!g.current||!l||!c)return;console.log(`üé® [color] Called with ${t.length} GlobalIds, rgba:`,r);let m,u;try{console.log("üé® [color] Calling groupLocalIdsByModel...");const p=await Ct(t);m=p.grouped,u=p.cache,console.log(`üé® [color] groupLocalIdsByModel returned ${m.size} models`)}catch(p){console.error("üé® [color] groupLocalIdsByModel failed:",p);return}const S=new Oe(r.r,r.g,r.b),x=S.getHex();console.log(`üé® [color] Grouped into ${m.size} models, colorHex: ${x.toString(16)}`),Jt.current||(Jt.current=new Map);for(const[p,E]of m){const R=l.list.get(p);if(!(!R||!E.length)){console.log(`üé® [color] Processing model ${p} with ${E.length} localIds`);try{const F=Array.from(E);if(typeof n.add=="function")try{if(console.log(`üé® [color] Trying highlighter.add with colorHex: ${x.toString(16)}`),n.add(R,F,x),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using add method`),c&&typeof c.update=="function")try{c.update(),console.log("üé® [color] Forced world update")}catch(I){console.debug("World update failed:",I)}continue}catch(I){console.debug("add failed:",I)}if(typeof n.highlightById=="function")try{console.log("üé® [color] Trying highlightById..."),await n.highlightById(R,F,x),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using highlightById`);continue}catch(I){console.debug("highlightById failed:",I)}if(typeof n.highlightByID=="function")try{console.log("üé® [color] Trying highlightByID..."),await n.highlightByID(R,F,x),console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using highlightByID`);continue}catch(I){console.debug("highlightByID failed:",I)}if(n.styles&&typeof n.styles.set=="function")try{if(!F||F.length===0){console.debug(`Skipping highlight for model ${p} - no IDs`);continue}const I=`ids-color-${x.toString(16).padStart(6,"0")}`;if(n.styles.set(I,{color:S,fillOpacity:1}),typeof n.create=="function")try{(!n.list||!n.list.has(I))&&n.create(I)}catch(w){console.debug("highlighter.create failed:",w)}if(typeof n.select=="function")try{n.select(R,F,I)}catch(w){throw console.debug("highlighter.select failed:",w),w}console.log(`‚úÖ Successfully colored ${F.length} elements in model ${p} using styles.set`);continue}catch(I){console.debug("styles.set failed:",I)}console.warn(`‚ùå Could not color model ${p} - all highlighter methods failed`)}catch(F){console.error(`Failed to color model ${p}:`,F)}}}},clearColors:async()=>{const t=Ge.current,r=i.current;if(g.current){if(r&&Ke.current&&Ke.current.size>0)try{for(const[n,l]of Ke.current){const{color:c,transparent:m,opacity:u}=l;n.transparent=m,n.opacity=u,c!==void 0&&("color"in n?n.color.setHex(c):"lodColor"in n&&n.lodColor.setHex(c)),n.needsUpdate=!0}Ke.current.clear(),console.log("Restored original material properties")}catch(n){console.warn("Failed to restore original materials",n)}try{if(t){if(t.styles&&typeof t.styles.delete=="function")try{t.styles.delete("ghost"),console.log("Cleared ghost styles")}catch(n){console.warn("Failed to clear ghost styles",n)}typeof t.clear=="function"&&(await Promise.resolve(t.clear()),console.log("Cleared highlighter colors using clear()")),t.styles&&typeof t.styles.clear=="function"&&(t.styles.clear(),console.log("Cleared highlighter styles"))}}catch(n){console.warn("Failed to clear IDS highlights",n)}Jt.current&&Jt.current.clear();try{const n=ze.current;if(n&&n.mesh&&n.mesh.instanceColor){const l=new Oe(1,1,1);n.mesh.setColorAt(n.index,l),n.mesh.instanceColor.needsUpdate=!0}}catch(n){console.warn("Failed to reset instanced mesh highlight",n)}ze.current=null}},isolate:async t=>{const r=Xe.current,n=i.current;if(!r||!n||!g.current||(await Promise.resolve(r.set(!0)),!t.length||!g.current))return;const{grouped:l}=await Ct(t);if(l.size===0){console.warn("isolate: No elements found in cache for isolation");return}const c=new Map;l.forEach((u,S)=>{c.set(S,new Set(u))});const m={};for(const[u,S]of c.entries()){const x=n.list.get(u);if(x)try{let p=[];const E=await x.getLocalIds();Array.isArray(E)?p=E:E&&typeof E[Symbol.iterator]=="function"&&(p=Array.from(E));const R=p.filter(F=>!S.has(F));R.length>0&&(m[u]=new Set(R))}catch(p){console.error("isolate: Failed to get local IDs for model",u,p)}}Object.keys(m).length>0&&await Promise.resolve(r.set(!1,m))},clearIsolation:async()=>{const t=Xe.current;t&&await Promise.resolve(t.set(!0))},ghost:async t=>{console.log(`[ghost] Applying ghost mode by coloring ${t.length} matching elements`);const r=i.current,n=a.current;if(!r||!g.current||!n){console.warn("[ghost] Fragments or world not ready");return}const{grouped:l}=await Ct(t);if(l.size===0){console.warn("[ghost] No elements found");return}const c=[...r.core.models.materials.list.values()];console.log(`[ghost] Found ${c.length} materials to ghost`),Ke.current||(Ke.current=new Map);for(const p of c)if(!p.userData?.customId){if(!Ke.current.has(p)){let E;"color"in p?E=p.color.getHex():"lodColor"in p&&(E=p.lodColor.getHex()),Ke.current.set(p,{color:E,transparent:p.transparent,opacity:p.opacity})}p.transparent=!0,p.opacity=.15,p.needsUpdate=!0}console.log(`[ghost] Ghosted ${c.length} materials`);const m=Ge.current;if(!m){console.warn("[ghost] Highlighter not available"),n.update();return}const S=new Oe(0,1,1).getHex();let x=0;for(const[p,E]of l.entries()){const R=r.list.get(p);if(R)try{typeof m.add=="function"&&(m.add(R,Array.from(E),S),x+=E.length,console.log(`[ghost] Colored ${E.length} elements in model ${p}`))}catch(F){console.error(`[ghost] Failed to color elements in model ${p}:`,F)}}n.update(),console.log(`[ghost] Complete: ghosted ${c.length} materials, colored ${x} matching elements in cyan`)},getItemsData:async(t,r)=>{console.log("üîç [getItemsData] START",{globalIds:t.length,config:r});const n=i.current;if(!n)return console.error("üîç [getItemsData] Fragments not available"),[];const{grouped:l}=await Ct(t),c=[];for(const[m,u]of l.entries()){const S=n.list.get(m);if(S)try{const x=await S.getItemsData(Array.from(u),r);c.push(...x)}catch(x){console.error(`üîç [getItemsData] Failed for model ${m}`,x)}}return console.log("‚úÖ [getItemsData] Complete:",c.length,"items"),c},getItemsByCategory:async t=>{console.log("üîç [getItemsByCategory] START",{categories:t.length});const r=i.current;if(!r)return console.error("üîç [getItemsByCategory] Fragments not available"),{};const n={};for(const[l,c]of r.list)try{const m=await c.getItemsOfCategories(t);if(m&&Object.keys(m).length>0){const u=Object.values(m).flat();u.length>0&&(n[l]=u)}}catch(m){console.error(`üîç [getItemsByCategory] Failed for model ${l}`,m)}return console.log("‚úÖ [getItemsByCategory] Complete:",Object.keys(n).length,"models"),n},getItemsDataByModel:async(t,r,n)=>{console.log("üîç [getItemsDataByModel] START",{modelId:t,localIds:r.length,config:n});const l=i.current;if(!l)return console.error("üîç [getItemsDataByModel] Fragments not available"),[];const c=l.list.get(t);if(!c)return console.error(`üîç [getItemsDataByModel] Model ${t} not found`),[];try{const m=await c.getItemsData(r,n);return console.log("‚úÖ [getItemsDataByModel] Complete:",m.length,"items"),m}catch(m){return console.error(`üîç [getItemsDataByModel] Failed for model ${t}`,m),[]}},fitViewTo:async t=>{if(!t.length)return;const r=a.current,n=i.current;if(!r||!n||!g.current)return;const l=r.camera??null,c=l?.controls??null,m=l?.three??null,{grouped:u}=await Ct(t),S=new lt;let x=!1;for(const[I,w]of u.entries()){const A=n.list.get(I);if(!A||!A.object)continue;const _=new lt().setFromObject(A.object);_.isEmpty()||(x?S.union(_):(S.copy(_),x=!0))}if(!x)return;const p=new Z,E=new Z;S.getCenter(p),S.getSize(E);const F=(Math.max(E.x,E.y,E.z)||10)*1.5;c?c.setLookAt(p.x+F,p.y+F,p.z+F,p.x,p.y,p.z,!0):m&&(m.position.set(p.x+F,p.y+F,p.z+F),m.lookAt(p))}}),[Ct]);bt.current=Bo;const qn=d.useCallback(()=>{ro(!0),Mo(t=>t+1)},[]),Yn=d.useCallback(()=>{ro(!1);const t=bt.current;t&&(Promise.resolve(t.clearColors()).catch(()=>{}),t.clearIsolation&&Promise.resolve(t.clearIsolation()).catch(()=>{}))},[]),Gr=d.useCallback(()=>{ro(t=>{const r=!t;return r&&Mo(n=>n+1),r})},[]),Kn=d.useCallback(async t=>{try{const{setIdsXmlText:r,runCheck:n}=await Et(()=>Promise.resolve().then(()=>Tl),void 0).then(l=>l.idsStore);r(t),ro(!0),Mo(l=>l+1),setTimeout(async()=>{bt.current&&await n(bt.current)},100)}catch(r){console.error("Failed to validate from IDS Creator:",r),alert("Error: Could not run validation. See console for details.")}},[]);d.useEffect(()=>{Fe.current=v},[v]),d.useEffect(()=>{Te.current=null,zt.current=null;try{bn.invalidateCaches()}catch(t){console.warn("Failed to invalidate IDS caches",t)}},[j]),d.useEffect(()=>{const t=e.current;if(!t)return;let r=!1;nr.current||(_s.init(),Bs.init(),nr.current=!0);try{t.replaceChildren()}catch{}const n=new Gs;y.current=n;const c=n.get(Ws).create();c.name="main",c.scene=new Us(n),c.scene.setup(),c.renderer=new Hs(n,t);const m=c.renderer.three;m.shadowMap.enabled=!1,m.sortObjects=!1,c.camera=new qs(n),c.camera.controls?.setLookAt(10,10,10,0,0,0),c.camera.three.near=.1,c.camera.three.far=1e9,c.camera.three.updateProjectionMatrix();const u=c.camera.controls;u&&(Rr.current=u,"mouseButtons"in u&&(u.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in u&&(u.dollySpeed=1));const S=new Qs(16777215,1);c.scene.three.add(S),a.current=c;const x=new hs;x.showPanel(2),x.dom.style.position="absolute",x.dom.style.left="8px",x.dom.style.top="8px",x.dom.style.zIndex="1000",t.appendChild(x.dom),c.renderer.onBeforeUpdate.add(()=>x.begin()),c.renderer.onAfterUpdate.add(()=>x.end());let p=null;const E=async I=>{if(!g.current)return;const w=[];for(const[L,B]of Object.entries(I))B.forEach(Y=>{Number.isInteger(Y)&&w.push({modelId:L,localId:Y})});const A=Fe.current;if(!!er(w,A))return;$(w),St();const O=i.current;if(!O||!w.length){Pe(null);return}const V=w[0],z=O.list.get(V.modelId);if(!z){Pe(null);return}try{const[L]=await z.getItemsData([V.localId],ke);Pe(L||null)}catch(L){console.warn("Failed to fetch properties for selection",L)}},R=()=>{$([]),Pe(null)};return(async()=>{try{await Promise.resolve(n.init())}catch(z){console.error("Failed to initialize viewer components",z);return}if(r)return;try{n.get(Ys).create(c)}catch(z){console.warn("Failed to create grid component",z)}const w=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),A=URL.createObjectURL(new File([w],"worker.mjs",{type:"text/javascript"}));P.current=A;const _=n.get(Ks);await _.init(A),i.current=_,g.current=!0;const O=n.get(Xs);O.setup({world:c}),O.zoomToSelection=!0;try{typeof O.create=="function"&&O.create("select")}catch{}Ge.current=O;const V=n.get(Js);Xe.current=V;try{const z=n.get(Zs);if(z.world=c,z.color=new Oe("#ff0000"),"snapDistance"in z&&(z.snapDistance=.5),"preview"in z){const L=z.preview;L&&(L.enabled=!0,L.color&&(L.color=new Oe("#00ff00")))}if("workingPlane"in z){const L=z.workingPlane;L&&typeof L=="object"&&(L.visible=!0)}z.list?.onItemAdded&&z.list.onItemAdded.add(L=>{const B=L.value||L.distance?.()||0;console.log(`‚úÖ Measurement created: ${B.toFixed(3)} units`),Mr(B.toFixed(3)),L.dimensionLabel&&(L.dimensionLabel.visible=!0)}),z.enabled=!1,ao.current=z,console.log("‚úÖ Measurement tool initialized:",z),console.log("Measurement tool properties:",Object.keys(z))}catch(z){console.error("Failed to initialize measurement tool:",z)}O.events.select.onHighlight.add(E),O.events.select.onClear.add(R),p=()=>{O.events.select.onHighlight.remove?.(E),O.events.select.onClear.remove?.(R)},pt()?.controls?.addEventListener("rest",()=>_.core.update(!0));try{const L=(await Et(()=>import("./thatopen-vendor-BZwVVjX8.js").then(X=>X.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new L,Y="/savora-viewer/";B.wasm={path:`${Y}web-ifc/`,absolute:!0},b.current=B}catch(z){console.warn("Failed to lazy-load FRAGS.IfcImporter:",z)}r||Be(!0)})().catch(I=>{console.error("Failed to initialize viewer fragments",I)}),()=>{r=!0,(async()=>{const I=g.current;g.current=!1,p?.(),p=null;try{I&&await Xe.current?.set?.(!0)}catch{}if(i.current){const w=[...i.current.list.keys()];await Promise.all(w.map(A=>i.current.core.disposeModel(A)))}try{I&&Ge.current?.clear?.()}catch{}P.current&&URL.revokeObjectURL(P.current);try{n.dispose()}catch{}try{t.replaceChildren()}catch{}Ge.current=null,Xe.current=null})()}},[]),d.useEffect(()=>{if(!be)return;const t=y.current,r=i.current;if(!t||!r)return;const n=fo,l=(c,m,u)=>{if(!c)return;let S=m.current;S||(S=u(),m.current=S),S&&S.parentElement!==c&&c.replaceChildren(S)};l(sr.current,ct,()=>{const[c,m]=rn.modelsList({components:t});return jo.current=m,c}),ct.current&&((!ct.current.dataset.initialized||n!==ir.current)&&jo.current?.({components:t}),ct.current.dataset.initialized||(ct.current.dataset.initialized="true",ct.current.style.width="100%")),to.current!==lr.current&&(vo.current=null,$t.current=null,lr.current=to.current),l(to.current,vo,()=>{const[c,m]=rn.spatialTree({components:t,models:Array.from(r.list.values())});$t.current=m,c.style.width="100%",c.style.height="100%",c.style.overflow="auto";const u=c;return u.queryString=xt.trim()?xt.trim():null,c}),$t.current&&$t.current({components:t,models:Array.from(r.list.values())}),ir.current=n},[be,Q,xt,fo]),d.useEffect(()=>{if(!be)return;const t=y.current,r=i.current,n=$t.current;!t||!r||!n||n({components:t,models:Array.from(r.list.values())})},[be,fo]),d.useEffect(()=>{const t=vo.current;if(!t)return;const r=xt.trim();t.queryString=r||null},[xt]);const Xn=async()=>{const t=s.current,r=t?.files?.[0];if(!r)return;const n=r.name.split(".").pop()?.toLowerCase(),l=i.current,c=b.current,m=a.current;if(!l||!m){alert("Viewer is still initializing. Please try again in a moment."),t&&(t.value="");return}const u=pt(),S=u?.three??null,x=u?.controls??null;let p=!1;try{const E=`${r.name}-${Date.now()}`;let R;if(n==="ifc"){if(!c)throw new Error("IFC importer is not ready.");qe(0),p=!0,Ye.current=!1,_e(!1);const A=new AbortController;Mt.current=A;const _=new Uint8Array(await r.arrayBuffer()),O=await c.process({bytes:_,progressCallback:(z,L)=>{if(Ye.current)return;const B=typeof z=="number"?z:0,Y=B<=1?B*100:B,X=Math.max(0,Math.min(100,Y));qe(Number(X.toFixed(1))),console.log(`IFC conversion progress: ${X.toFixed(1)}%`,L)},signal:A.signal});if(Ye.current)throw{__cancelled:!0};let V;if(O instanceof ArrayBuffer){const z=new Uint8Array(O),L=new Uint8Array(z.byteLength);L.set(z),V=L.buffer}else if(O instanceof Uint8Array){const z=new Uint8Array(O.byteLength);z.set(O),V=z.buffer}else{const z=O,L=new Uint8Array(z),B=new Uint8Array(L.byteLength);B.set(L),V=B.buffer}R=await l.core.load(V,{modelId:E})}else if(n==="frag"){const A=await r.arrayBuffer();R=await l.core.load(A,{modelId:E})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}h.current=E,S?R.useCamera(S):console.warn("World camera not ready; skipping model camera binding."),m.scene.three.add(R.object),await l.core.update(!0),await new Promise(A=>requestAnimationFrame(()=>A()));const F=new lt().setFromObject(R.object),I=new Z;F.getCenter(I),(Math.abs(I.x)>1e6||Math.abs(I.y)>1e6||Math.abs(I.z)>1e6)&&R.object.position.sub(I);try{x&&await x.fitToBox(R.object,!0)}catch{const A=new Z;F.getSize(A);const O=(Math.max(A.x,A.y,A.z)||10)*2.5;x?x.setLookAt(I.x+O,I.y+O,I.z+O,I.x,I.y,I.z,!0):S&&(S.position.set(I.x+O,I.y+O,I.z+O),S.lookAt(I))}$n(A=>({...A,[E]:Gl(E,r.name,R.object)})),k(!0),N(A=>[...A,{id:E,label:r.name}]),St();const w=y.current;w&&jo.current?.({components:w}),p&&qe(100)}catch(E){E&&(E.__cancelled||E?.name==="AbortError")?console.info("IFC conversion cancelled by user."):(console.error(E),alert("Failed to load model. See console for more details.")),k(!1)}finally{t&&(t.value=""),p&&setTimeout(()=>qe(null),200),Mt.current=null,_e(!1)}},Jn=d.useCallback(()=>{if(Ce!==null){Ye.current=!0,_e(!0);try{Mt.current?.abort()}catch{}qe(null)}},[Ce]),St=d.useCallback(()=>{J(!0),K(!1)},[]),Wr=d.useCallback(()=>{J(t=>{const r=!t;return r&&K(!1),r})},[]),Zn=d.useCallback(()=>{J(!1)},[]),Qn=d.useCallback(()=>{K(t=>!t)},[]),Ur=d.useMemo(()=>Math.min(360,Math.max(180,Qt.height*.45)),[Qt.height]),es=+!vn+ +!kn,Go=!jn&&es===0;d.useEffect(()=>{const t=ct.current;t&&(t.style.width="100%",t.style.maxHeight=Go?"100%":`${Ur}px`,t.style.height=Go?"100%":"auto")},[Go,Ur,fo]);const ts=d.useCallback(async t=>{const r=w=>{const A=[],_=new Set;if(!w||typeof w!="object")return{terms:A,modelIds:_};for(const[O,V]of Object.entries(w)){if(V==null)continue;const z=O.trim().toLowerCase(),L=Array.isArray(V)?V:[V];if(L.length){if(z==="modelid"||z==="modelids"||z==="model"){for(const B of L){const Y=typeof B=="string"?B.trim():String(B??"").trim();Y&&_.add(Y)}continue}if(["text","query","keyword","search"].includes(z)){for(const B of L){if(B==null)continue;const Y=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();Y&&A.push({type:"text",value:Y})}continue}for(const B of L){if(B==null)continue;let Y=null;typeof B=="string"?Y=B.trim():(typeof B=="number"||typeof B=="boolean")&&(Y=String(B)),Y&&A.push({type:"field",key:z,value:Y.toLowerCase()})}}}return{terms:A,modelIds:_}},n=i.current;if(!n){console.warn("AI selection requested but fragments are unavailable.");return}if(!g.current){console.warn("AI selection requested before fragments were fully initialized.");return}const l=Ge.current,c=Xe.current,{terms:m,modelIds:u}=r(t.filter),S=t.mode?.toLowerCase?.(),x=S==="isolate"||S==="focus";if(t.action==="clear"){try{l?.clear?.()}catch{}if(c)try{await c.set(!0)}catch(w){console.warn("Failed to reset visibility while clearing AI selection",w)}try{const w=ze.current;if(w&&w.mesh&&w.mesh.instanceColor){const A=new Oe(1,1,1);w.mesh.setColorAt(w.index,A),w.mesh.instanceColor.needsUpdate=!0}}catch{}ze.current=null,$e.current&&($e.current.visible=!1),$([]),Pe(null);return}if(m.length===0){console.warn("AI selection command did not include usable filters",t);return}const p=++Xt.current,E=[],R=60;for(const w of n.list.values()){const A=typeof w?.modelId=="string"?w.modelId:"";if(u.size&&!u.has(A))continue;let _=[];try{const V=await w.getLocalIds();Array.isArray(V)?_=V.slice():V&&typeof V[Symbol.iterator]=="function"&&(_=Array.from(V))}catch(V){console.warn("Failed to fetch local IDs for model",A,V)}const O={model:w,modelId:A,allIds:_,matched:new Set};if(E.push(O),!!_.length)for(let V=0;V<_.length;V+=R){if(p!==Xt.current)return;const z=_.slice(V,V+R);let L=[];try{L=await w.getItemsData(z,ke)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}z.forEach((B,Y)=>{const X=L?.[Y];if(!X)return;let G=[];try{G=qt(X).rows}catch(ue){console.warn("Failed to build property rows for AI selection",ue)}const pe=G.map(ue=>ue.searchText),se=Io(X,6e3).toLowerCase();m.every(ue=>{if(ue.type==="text")return pe.some(ee=>ee.includes(ue.value))||se.includes(ue.value);const Le=_l[ue.key]??[ue.key];return pe.some(ee=>Le.some(Ie=>ee.includes(Ie))&&ee.includes(ue.value))?!0:Le.some(ee=>se.includes(ee)&&se.includes(ue.value))})&&O.matched.add(B)})}}if(p!==Xt.current)return;const F=E.filter(w=>w.matched.size>0);if(!F.length){console.info("AI selection produced no matches for command",t);return}try{const w=ze.current;if(w&&w.mesh&&w.mesh.instanceColor){const A=new Oe(1,1,1);w.mesh.setColorAt(w.index,A),w.mesh.instanceColor.needsUpdate=!0}}catch{}if(ze.current=null,$e.current&&($e.current.visible=!1),c)try{await c.set(!0)}catch(w){console.warn("Failed to reset hidden state before AI selection",w)}if(l){try{l.clear?.()}catch{}const w=x?16754240:6737151;for(const A of F){const _=Array.from(A.matched);if(_.length)try{typeof l.highlightById=="function"?await l.highlightById(A.model,_,w):typeof l.highlightByID=="function"?await l.highlightByID(A.model,_,w):typeof l.add=="function"&&l.add(A.model,_,w)}catch(O){console.warn("Failed to apply AI highlight for model",A.modelId,O)}}}if(x&&c){const w={};for(const A of E){if(!A.allIds.length||A.matched.size===A.allIds.length)continue;const _=A.allIds.filter(O=>!A.matched.has(O));_.length&&(w[A.modelId]=new Set(_))}if(Object.keys(w).length)try{await c.set(!1,w)}catch(A){console.warn("Failed to isolate AI-selected elements",A)}}const I=F.flatMap(w=>Array.from(w.matched).map(A=>({modelId:w.modelId,localId:A})));$(I),St();try{const w=F[0],A=Array.from(w.matched)[0];if(A!==void 0){const[_]=await w.model.getItemsData([A],ke);p===Xt.current&&Pe(_||null)}}catch(w){console.warn("Failed to fetch properties for AI selection result",w)}},[St,$,Pe]),go=d.useCallback(t=>{if(!eo.current)return;const r=Co.current;if(!r)return;const n=t.clientX-r.startX,l=t.clientY-r.startY,c=280,m=260;wn(u=>{const S=r.width,x=r.height,p=Math.max(c,S+n),E=Math.max(m,x+l);return p===u.width&&E===u.height?u:{width:Math.round(p),height:Math.round(E)}})},[]),Ot=d.useCallback(()=>{eo.current&&(eo.current=!1,Co.current=null,window.removeEventListener("pointermove",go),window.removeEventListener("pointerup",Ot))},[go]),os=d.useCallback(t=>{t.preventDefault(),t.stopPropagation();const r=So.current;r&&(eo.current=!0,Co.current={startX:t.clientX,startY:t.clientY,width:r.offsetWidth,height:r.offsetHeight},window.addEventListener("pointermove",go),window.addEventListener("pointerup",Ot))},[go,Ot]);d.useEffect(()=>()=>{Ot()},[Ot]);const rs=d.useCallback(async()=>{const t=i.current,r=[];if(!t||t.list.size===0||j.length===0)r.push("No models are currently loaded in the viewer.");else{r.push(`Loaded models (${j.length}): ${j.map(l=>`${l.label} [${l.id}]`).join(", ")}`),r.push(`Fragments models in memory: ${t.list.size}`);try{const l=new lt;for(const m of t.list.values())l.expandByObject(m.object);const c=new Z;l.getSize(c),r.push(`Scene bounds approx size => x:${c.x.toFixed(2)} y:${c.y.toFixed(2)} z:${c.z.toFixed(2)}`)}catch(l){console.warn("Failed to compute bounds for AI context",l)}const n=j.map(l=>wr[l.id]).filter(l=>!!l);if(n.length){let l=0;const c=new Map;r.push("Model geometry snapshots:");for(const u of n){l+=u.elementCount;for(const{category:x,count:p}of u.categoryCounts)c.set(x,(c.get(x)??0)+p);const S=u.categoryCounts.slice(0,5).map(({category:x,count:p})=>`${x}: ${p}`);r.push(`- ${u.label} [${u.modelId}] ‚Üí elements‚âà${u.elementCount}, instanced‚âà${u.instancedCount}, meshes‚âà${u.meshCount}`),S.length&&r.push(`  top categories: ${S.join(" | ")}`),r.push(`  bbox size (approx): x:${u.bboxSize.x.toFixed(2)} y:${u.bboxSize.y.toFixed(2)} z:${u.bboxSize.z.toFixed(2)}`)}const m=Array.from(c.entries()).sort((u,S)=>S[1]-u[1]).slice(0,10).map(([u,S])=>`${u}: ${S}`);r.push(`Global approx element total: ${l}`),m.length&&r.push(`Global top categories: ${m.join(" | ")}`)}else r.push("Geometry summaries are initializing ‚Äî load a model or wait a moment after loading.")}if(v.length){r.push(`Active selection count: ${v.length}`);for(let n=0;n<v.length;n+=1){const l=v[n];r.push(`Selection #${n+1} ‚Üí modelId:${l.modelId}, localId:${l.localId}`);let c=null;if(n===0&&q&&Object.keys(q).length)c=q;else if(t){const m=t.list.get(l.modelId);if(m)try{const[u]=await m.getItemsData([l.localId],ke);c=u||null}catch(u){console.warn("Failed to fetch properties for AI context (multi)",u)}}if(c){r.push("  Property snapshot (compact JSON):"),r.push(`  ${Io(c,4e3)}`);const m=qt(c).rows;if(m.length){r.push(`  Flattened properties (${m.length} entries):`);for(const u of m.slice(0,120))r.push(`  - ${u.label}: ${u.value}`);m.length>120&&r.push(`  (Truncated ${m.length-120} additional properties)`)}}else r.push("  Properties for this selection are not available yet.")}}else if(r.push("No active selection ‚Äî exporting properties for every loaded element."),t&&t.list.size)for(const n of j){const l=t.list.get(n.id);if(!l){r.push(`Model ${n.label} [${n.id}] could not be found in the fragments registry.`);continue}try{const c=await l.getLocalIds(),m=Array.isArray(c)?c:c?Array.from(c):[];if(!m||m.length===0){r.push(`Model ${n.label} [${n.id}] has no retrievable local IDs.`);continue}r.push(`Model ${n.label} [${n.id}] ‚Äî enumerating ${m.length} items:`);const u=m.length<=40?12:m.length<=120?6:3,S=50;for(let x=0;x<m.length;x+=S){const p=m.slice(x,x+S);let E=[];try{E=await l.getItemsData(p,ke)}catch(R){const F=p[0],I=p[p.length-1];r.push(`  Failed to retrieve properties for items ${F}‚Äì${I}: ${R?.message??R}`);continue}p.forEach((R,F)=>{const I=E?.[F];if(!I){r.push(`- localId:${R} (no data available)`);return}const w=Hl(I,u).replace(/\s+/g," ").trim();r.push(`- localId:${R} | ${w}`)})}}catch(c){r.push(`Failed to enumerate items for model ${n.label} [${n.id}]: ${c?.message??c}`)}}else r.push("Fragments data is not available to enumerate model items.");if(Ft.length){r.push("ItemsData extracted name/value pairs (last selection):");const n=150,l=Ft.slice(0,n);for(const c of l)r.push(`- ${c.path}: ${c.value}`);Ft.length>n&&r.push(`(Truncated ${Ft.length-n} additional rows)`)}return Ro&&(r.push("ItemsData table snapshot for last selection (tab-separated):"),r.push(Ro)),r.length===0&&r.push("Viewer is idle: no models or selections to describe."),r.join(`
`)},[j,v,q,ae,wr,Ro,Ft]),ns=d.useCallback(async()=>{const t=a.current,r=i.current,n=h.current;if(!t||!r||!n||!g.current)return;const l=r.list.get(n);if(!l)return;await r.core.update(!0),await new Promise(u=>requestAnimationFrame(()=>u()));const c=l.object,m=new lt().setFromObject(c);if(!m.isEmpty()){const u=pt(),S=u?.controls??null,x=u?.three??null;try{S&&await S.fitToBox(c,!0)}catch{const E=new Z,R=new Z;m.getCenter(E),m.getSize(R);const I=(Math.max(R.x,R.y,R.z)||10)*2.5;S?S.setLookAt(E.x+I,E.y+I,E.z+I,E.x,E.y,E.z,!0):x&&(x.position.set(E.x+I,E.y+I,E.z+I),x.lookAt(E))}}},[]),ss=d.useCallback(async()=>{const t=Fe.current,r=Xe.current;if(!t||t.length===0||!r||!g.current){Ee(null);return}const n={};for(const l of t)n[l.modelId]||(n[l.modelId]=new Set),n[l.modelId].add(l.localId);try{await r.set(!1,n);try{Ge.current?.clear?.()}catch{}$([]),Pe(null)}catch(l){console.warn("Failed to hide selected element",l)}finally{Ee(null)}},[Ee,$,Pe]),ls=d.useCallback(async()=>{const t=Xe.current;if(!t||!g.current){Ee(null);return}try{await t.set(!0)}catch(r){console.warn("Failed to reset hidden items",r)}finally{Ee(null)}},[Ee]),is=d.useCallback(()=>{Ee(null)},[Ee]);d.useEffect(()=>{const t=e.current,r=a.current;if(!t||!r)return;const n=r.renderer?.three.domElement;if(!n)return;const l=new nn,c=async(I,w,A,_)=>{console.log("üî∑ Rectangle Selection Started (viewport coords)",{left:I,top:w,right:A,bottom:_});const O=i.current;if(!O){console.warn("‚ùå No fragments manager");return}console.log("üì¶ Models available:",O.list.size);const V=Fo();if(!V){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const z=n.getBoundingClientRect();console.log("üìè Canvas bounds:",{rectLeft:z.left,rectTop:z.top,rectWidth:z.width,rectHeight:z.height}),new sn;const L=new Map,B=10,Y=A-I,X=_-w;if(console.log("üìê Rectangle size:",{width:Y,height:X,sampleSize:B}),Y<3||X<3){console.log("‚ö†Ô∏è Rectangle too small, using click selection"),await m((I+A)/2,(w+_)/2);return}let G=0,pe=0,se=!0;for(let we=I;we<=A;we+=B)for(let ee=w;ee<=_;ee+=B){G++;const Ie=(we-z.left)/z.width*2-1,ot=-((ee-z.top)/z.height)*2+1;l.set(Ie,ot),se&&console.log("üîç First sample point:",{screenCoords:{x:we,y:ee},rectBounds:{left:z.left,top:z.top,width:z.width,height:z.height},mouseNDC:{x:Ie,y:ot},mouseVector:l.clone()});for(const rt of O.list.values())try{const Vt=new nn(Ie,ot);se&&console.log("üî¨ Raycast params:",{mouseVec:Vt.clone(),cameraType:V.type,domElement:n?.tagName,modelId:rt.modelId});const nt=await rt.raycast({camera:V,mouse:Vt,dom:n});if(se&&console.log("üî¨ Raycast result:",{hit:nt,hasDistance:nt&&typeof nt.distance=="number",hitType:typeof nt}),nt&&typeof nt.distance=="number"){pe++;const _t=nt.localId;console.log("üéØ Hit found:",{point:{x:we,y:ee},mouseNDC:{x:Ie,y:ot},localId:_t,distance:nt.distance,modelId:rt.modelId}),_t!=null&&Number.isInteger(_t)&&(L.has(rt.modelId)||L.set(rt.modelId,new Set),L.get(rt.modelId).add(_t))}}catch(Vt){se&&console.warn("‚ùå Raycast error on first sample:",Vt),console.debug("Skipping model due to raycast error:",Vt)}se&&(se=!1)}console.log("üìä Sampling complete:",{samplePoints:G,hitCount:pe,uniqueObjects:L.size});const ye=[];for(const[we,ee]of L.entries())for(const Ie of ee)ye.push({modelId:we,localId:Ie});if(console.log("‚úÖ Rectangle Selection Result:",{totalSelected:ye.length,byModel:Array.from(L.entries()).map(([we,ee])=>({modelId:we,count:ee.size}))}),ye.length===0){console.warn("‚ö†Ô∏è No objects found in rectangle"),$([]),Pe(null);return}const ue=Fe.current;if(!!er(ye,ue)){console.log("‚ÑπÔ∏è Selection unchanged");return}if(console.log("üîÑ Updating selection with",ye.length,"objects"),$(ye),St(),ye.length>0){const we=ye[0],ee=O.list.get(we.modelId);if(ee)try{const[Ie]=await ee.getItemsData([we.localId],ke);Pe(Ie||null)}catch(Ie){console.warn("Failed to fetch properties for rectangle selection",Ie)}}},m=async(I,w)=>{const A=i.current;if(!A)return;const _=Fo();if(!_){console.warn("Picking skipped: viewer camera not ready.");return}const O=n.getBoundingClientRect();l.x=(I-O.left)/O.width*2-1,l.y=-((w-O.top)/O.height)*2+1,console.log("üñ±Ô∏è Click selection:",{viewport:{x:I,y:w},canvasBounds:{left:O.left,top:O.top,width:O.width,height:O.height},mouseNDC:{x:l.x,y:l.y}});let V=null;const z=new sn;z.setFromCamera(l,_);for(const X of A.list.values())try{const G=await X.raycast({camera:_,mouse:l,dom:r.renderer.three.domElement});if(G&&typeof G.distance=="number"){const pe=G.point instanceof Z?G.point.clone():z.ray.at(G.distance,new Z);(!V||G.distance<V.dist)&&(V={dist:G.distance,model:X,localId:G.localId,point:pe,object:G.object,instanceId:G.instanceId})}}catch(G){console.debug("Skipping model due to raycast error:",G)}if(!V)return;const L=Ge.current;if(L)try{typeof L.clear=="function"&&L.clear();const X=6737151;typeof L.highlightByID=="function"?await L.highlightByID(V.model.uuid,[V.localId],X):typeof L.add=="function"?L.add(V.model.uuid,[V.localId]):typeof L.highlight=="function"&&await L.highlight(V.model,[V.localId],X)}catch(X){console.warn("Highlighter failed, using fallback:",X);try{const G=V.object,pe=V.instanceId;if(G&&G.isInstancedMesh&&Number.isInteger(pe)){const se=ze.current;if(se&&se.mesh&&se.mesh.instanceColor){const Le=new Oe(1,1,1);try{se.mesh.setColorAt(se.index,Le),se.mesh.instanceColor.needsUpdate=!0}catch{}}const ye=G,ue=new Oe(6737151);try{ye.setColorAt(pe,ue),ye.instanceColor.needsUpdate=!0}catch{}ze.current={mesh:ye,index:pe}}}catch{}}try{const X=V.point??new Z;let G=$e.current;if(!G){G=new el;const ye=new lt,ue=i.current;if(ue&&ue.list.size)for(const rt of ue.list.values())ye.expandByObject(rt.object);const Le=new tl;ye.getBoundingSphere(Le);const we=isFinite(Le.radius)&&Le.radius>0?Le.radius*.01:.3,ee=Math.max(.05,Math.min(2,we)),Ie=new ln(new ol(ee*.5,16,16),new an({color:16763904,depthTest:!1})),ot=new ln(new rl(ee*.8,ee,32),new an({color:16772744,side:nl,depthTest:!1,transparent:!0,opacity:.9}));ot.rotation.x=Math.PI/2,Ie.renderOrder=999,ot.renderOrder=999,G.add(Ie),G.add(ot),r.scene.three.add(G),$e.current=G}G.position.copy(X);const pe=G.children[1],se=Fo();se&&pe.lookAt(se.position),G.visible=!0}catch{}const B=Fe.current,Y=[{modelId:V.model.modelId,localId:V.localId}];if(!er(Y,B)){$(Y),St();try{const[X]=await V.model.getItemsData([V.localId],ke);Pe(X||null)}catch{}}},u=async I=>{if(Ee(null),I.button===0)if(console.log("üëÜ PointerDown:",{mode:Zt.current,measuring:It.current,x:I.clientX,y:I.clientY}),Zt.current==="rectangle"&&!It.current){if(console.log("üü¶ Starting rectangle selection"),Rt.current=!0,yt.current={x:I.clientX,y:I.clientY},!De.current){const A=document.createElement("div");A.style.position="fixed",A.style.border="2px solid #1976d2",A.style.backgroundColor="rgba(25, 118, 210, 0.1)",A.style.pointerEvents="none",A.style.zIndex="10000",document.body.appendChild(A),De.current=A}const w=De.current;w.style.left=`${I.clientX}px`,w.style.top=`${I.clientY}px`,w.style.width="0px",w.style.height="0px",w.style.display="block"}else await m(I.clientX,I.clientY)},S=I=>{if(!Rt.current||!yt.current||!De.current)return;const w=yt.current,A=De.current,_=Math.min(I.clientX,w.x),O=Math.min(I.clientY,w.y),V=Math.abs(I.clientX-w.x),z=Math.abs(I.clientY-w.y);A.style.left=`${_}px`,A.style.top=`${O}px`,A.style.width=`${V}px`,A.style.height=`${z}px`},x=async I=>{if(console.log("üëÜ PointerUp:",{drawing:Rt.current,x:I.clientX,y:I.clientY}),Rt.current&&yt.current&&De.current){console.log("üü¶ Completing rectangle selection");const w=yt.current,A=De.current;A.style.display="none",Rt.current=!1;const _=Math.min(I.clientX,w.x),O=Math.min(I.clientY,w.y),V=Math.max(I.clientX,w.x),z=Math.max(I.clientY,w.y);await c(_,O,V,z),yt.current=null}},p=async I=>{Ee(null),!It.current&&Zt.current==="click"&&await m(I.clientX,I.clientY)},E=()=>{if(It.current){const I=ao.current;I&&typeof I.create=="function"&&(console.log("üìè Creating measurement point"),I.create())}},R=I=>{I.preventDefault();const w=Fe.current;if(!w||w.length===0){Ee(null);return}Ee({mouseX:I.clientX+2,mouseY:I.clientY-6})},F=I=>{if(It.current&&(I.code==="Delete"||I.code==="Backspace")){const w=ao.current;w&&typeof w.delete=="function"&&(console.log("Deleting measurement under cursor"),w.delete())}};return n.addEventListener("pointerdown",u,{capture:!0}),n.addEventListener("pointermove",S),n.addEventListener("pointerup",x),n.addEventListener("click",p),n.addEventListener("dblclick",E),n.addEventListener("contextmenu",R),window.addEventListener("keydown",F),()=>{n.removeEventListener("pointerdown",u,{capture:!0}),n.removeEventListener("pointermove",S),n.removeEventListener("pointerup",x),n.removeEventListener("click",p),n.removeEventListener("dblclick",E),n.removeEventListener("contextmenu",R),window.removeEventListener("keydown",F),De.current&&(De.current.remove(),De.current=null);try{const I=$e.current;I&&(r.scene.three.remove(I),I.traverse(w=>{if(w.geometry&&w.geometry.dispose?.(),w.material){const A=Array.isArray(w.material)?w.material:[w.material];for(const _ of A)_?.dispose?.()}}),$e.current=null)}catch{}try{const I=ze.current;if(I&&I.mesh&&I.mesh.instanceColor){const w=new Oe(1,1,1);I.mesh.setColorAt(I.index,w),I.mesh.instanceColor.needsUpdate=!0}ze.current=null}catch{}}},[]);const as=d.useCallback(()=>{a.current;const t=pt(),r=t?.controls??null,n=t?.three??null;r?r.reset(!0):n&&(n.position.set(10,10,10),n.lookAt(0,0,0))},[]),Wo=d.useCallback(t=>{io(r=>{const n={...r,[t]:!r[t]},l=a.current;if(!l)return n;const c=l.renderer?.three,m=l.scene?.three;if(!c||!m)return n;const u=[],S=Do.current;if(!n[t]){const x=S.get(t);x&&(m.remove(x),x.dispose(),S.delete(t))}if(n.x){const x=new vt(new Z(1,0,0),Ne.x);if(u.push(x),!S.has("x")){const p=new Zo(x,10,16711680);m.add(p),S.set("x",p)}}if(n.y){const x=new vt(new Z(0,1,0),Ne.y);if(u.push(x),!S.has("y")){const p=new Zo(x,10,65280);m.add(p),S.set("y",p)}}if(n.z){const x=new vt(new Z(0,0,1),Ne.z);if(u.push(x),!S.has("z")){const p=new Zo(x,10,255);m.add(p),S.set("z",p)}}return c.clippingPlanes=u,c.localClippingEnabled=u.length>0,zo.current=u,n})},[Ne]),Uo=d.useCallback((t,r)=>{Er(n=>{const l={...n,[t]:r};return requestAnimationFrame(()=>{const m=a.current;if(!m)return;const u=m.renderer?.three;if(!u)return;const S=[],x=Do.current;if(ne.x){const p=new vt(new Z(1,0,0),l.x);S.push(p);const E=x.get("x");E&&(E.plane.constant=l.x)}if(ne.y){const p=new vt(new Z(0,1,0),l.y);S.push(p);const E=x.get("y");E&&(E.plane.constant=l.y)}if(ne.z){const p=new vt(new Z(0,0,1),l.z);S.push(p);const E=x.get("z");E&&(E.plane.constant=l.z)}u.clippingPlanes=S,zo.current=S}),l})},[ne]),cs=d.useCallback(()=>{Pr(t=>{const r=!t;return io(r?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),r})},[]),ds=d.useCallback(()=>{console.log("üéØ toggleMeasurement called"),Fn(t=>{const r=!t;It.current=r;const n=ao.current;if(console.log("Measurement tool:",n),console.log("New state:",r),n)if(n.enabled=r,console.log("Measurement tool enabled set to:",r),console.log("Measurement tool world:",n.world),console.log("Measurement tool properties:",{enabled:n.enabled,world:!!n.world,list:n.list?.size||0}),r)console.log("üìè Measurement mode activated - DOUBLE-CLICK two points on the model to measure distance");else try{n.list&&typeof n.list.clear=="function"&&(n.list.clear(),console.log("All measurements cleared")),Mr(null)}catch(l){console.warn("Failed to clear measurements:",l)}else console.warn("‚ö†Ô∏è Measurement tool not initialized!");return r})},[]),us=d.useCallback(()=>{io({x:!1,y:!1,z:!1}),Er({x:0,y:0,z:0}),Pr(!1);const t=a.current;if(t){const r=t.renderer?.three,n=t.scene?.three;if(r&&(r.clippingPlanes=[],r.localClippingEnabled=!1),n){const l=Do.current;l.forEach(c=>{n.remove(c),c.dispose()}),l.clear()}}zo.current=[]},[]),mt=d.useCallback(t=>{console.log("setCameraView called with view:",t);const r=a.current,n=i.current,l=h.current,c=pt(),m=c?.three;if(console.log("Debug:",{hasWorld:!!r,hasFragments:!!n,id:l,hasCamera:!!c,hasThreeCamera:!!m}),!m||!r||!n||!l){console.log("Early return: missing dependencies");return}const u=n.list.get(l);if(console.log("Model record:",u),!u){console.log("Early return: no record found for id:",l);return}const S=new lt().setFromObject(u.object);if(console.log("Bounding box:",S,"isEmpty:",S.isEmpty()),S.isEmpty()){console.log("Early return: bounding box is empty");return}const x=new Z,p=new Z;S.getCenter(x),S.getSize(p);const R=Math.max(p.x,p.y,p.z)*2||20;let F;switch(t){case"top":F=new Z(x.x,x.y+R,x.z);break;case"bottom":F=new Z(x.x,x.y-R,x.z);break;case"front":F=new Z(x.x,x.y,x.z+R);break;case"back":F=new Z(x.x,x.y,x.z-R);break;case"left":F=new Z(x.x-R,x.y,x.z);break;case"right":F=new Z(x.x+R,x.y,x.z);break;case"iso":F=new Z(x.x+R*.7,x.y+R*.7,x.z+R*.7);break;default:return}const I=c?.controls;I&&typeof I.setLookAt=="function"?(I.setLookAt(F.x,F.y,F.z,x.x,x.y,x.z,!0),console.log("Camera moved to:",t,"position:",F,"looking at:",x)):(m.position.copy(F),m.lookAt(x),m.updateProjectionMatrix(),console.log("Camera moved (fallback) to:",t))},[]);return o.jsxs("div",{style:{width:"100%",height:"100%"},children:[o.jsx(ys,{position:"static",children:o.jsxs(bs,{children:[o.jsx(W,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[o.jsx(W,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:o.jsx("img",{src:"/savora-viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),o.jsx(U,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core Preview"})]})}),o.jsx(te,{title:"Settings",children:o.jsx(oe,{color:"inherit",onClick:Br,sx:{mr:1},children:o.jsx(xs,{})})}),o.jsx(te,{title:"About",children:o.jsx(oe,{color:"inherit",onClick:Bn,sx:{mr:1},children:o.jsx(ws,{})})}),o.jsx(ie,{color:"inherit",onClick:Wr,startIcon:o.jsx(Hr,{}),"aria-pressed":Q,sx:{mr:1,borderRadius:1.5,backgroundColor:Q?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Q?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Q?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),o.jsx(ie,{color:"inherit",onClick:Vr,startIcon:o.jsx(qr,{}),"aria-pressed":Je,sx:{mr:1,borderRadius:1.5,backgroundColor:Je?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Je?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Je?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),o.jsx(ie,{color:"inherit",onClick:Gr,startIcon:o.jsx(Yr,{}),"aria-pressed":Ze,sx:{mr:1,borderRadius:1.5,backgroundColor:Ze?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Ze?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Ze?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),o.jsx(ie,{color:"inherit",onClick:Or,startIcon:o.jsx(Kr,{}),"aria-pressed":Qe,sx:{mr:1,borderRadius:1.5,backgroundColor:Qe?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Qe?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Qe?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),o.jsx("div",{ref:e,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:Ce!==null&&o.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:o.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[o.jsx(U,{variant:"subtitle1",sx:{mb:1},children:"Converting IFC‚Ä¶"}),o.jsx(Is,{variant:"determinate",value:Math.max(0,Math.min(100,Ce)),sx:{height:10,borderRadius:1}}),o.jsxs(U,{variant:"caption",sx:{mt:1,display:"block"},children:[Ce.toFixed(1),"%"]}),o.jsx("div",{style:{marginTop:12},children:o.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:Jn,disabled:At,children:At?"Cancelling‚Ä¶":"Cancel"})})]})})}),Q&&o.jsx(Xr,{nodeRef:So,handle:".explorer-header",bounds:"parent",children:o.jsxs(je,{ref:So,elevation:8,sx:{position:"fixed",top:120,right:30,width:Qt.width,height:re?"auto":Qt.height,minWidth:280,minHeight:re?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[o.jsxs(W,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[o.jsx(U,{variant:"subtitle1",children:"Model Explorer"}),o.jsxs(W,{children:[o.jsx(oe,{size:"small",color:"inherit",onClick:Qn,title:re?"Expand panel":"Minimize panel",children:re?o.jsx(Cs,{}):o.jsx(Ss,{})}),o.jsx(oe,{size:"small",color:"inherit",onClick:Zn,title:"Close Model Explorer",children:o.jsx(Jr,{})})]})]}),!re&&o.jsxs(W,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[o.jsx(ie,{variant:"contained",size:"small",onClick:()=>s.current?.click(),disabled:!be,children:"Open IFC / FRAG"}),o.jsx(te,{title:"Open parametric filter",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",onClick:()=>Re(!0),disabled:!be,startIcon:o.jsx(js,{}),children:"Filter"})})}),!1,o.jsx(U,{variant:"caption",color:"text.secondary"}),o.jsx("input",{ref:s,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:Xn})]}),o.jsxs(Zr,{value:ut,onChange:(t,r)=>En(r),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[o.jsx(Bt,{value:"models",label:"Models"}),o.jsx(Bt,{value:"properties",label:"Properties"}),o.jsx(Bt,{value:"tree",label:"Model Tree"})]}),o.jsx(W,{role:"tabpanel",hidden:ut!=="models",sx:{display:ut==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:o.jsx(W,{ref:sr,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!be&&o.jsx(U,{variant:"body2",color:"text.secondary",children:"Initializing components‚Ä¶"})})}),o.jsx(W,{role:"tabpanel",hidden:ut!=="properties",sx:{display:ut==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsxs(Zr,{value:dt,onChange:(t,r)=>dr(r),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[o.jsx(Bt,{value:"favorites",label:`Favourites (${No.length})`}),o.jsx(Bt,{value:"all",label:`All (${ae.length})`})]}),o.jsxs(W,{role:"tabpanel",hidden:dt!=="favorites",sx:{display:dt==="favorites"?"flex":"none",flexDirection:"column",flex:dt==="favorites"?1:0,minHeight:0},children:[No.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:No.map(Oo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:Se.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Lo>0&&Se.length>0&&o.jsx(jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Lo===1?"1 favourite property is not available for this selection.":`${Lo} favourite properties are not available for this selection.`})]}),o.jsxs(W,{role:"tabpanel",hidden:dt!=="all",sx:{display:dt==="all"?"flex":"none",flexDirection:"column",flex:dt==="all"?1:0,minHeight:0},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[o.jsx(Gt,{size:"small",fullWidth:!0,value:ar,onChange:t=>Cn(t.target.value),placeholder:"Search properties‚Ä¶",disabled:!ae.length}),o.jsx(te,{title:"Copy raw element JSON",children:o.jsx("span",{children:o.jsx(oe,{size:"small",onClick:Ln,disabled:!q,color:"primary",children:o.jsx(vs,{fontSize:"small"})})})}),o.jsx(te,{title:"Export properties",children:o.jsx("span",{children:o.jsx(ie,{variant:"outlined",size:"small",startIcon:o.jsx(ks,{}),onClick:Nn,disabled:!ae.length&&!j.length,children:"Export"})})})]}),ae.length?Tn?$r.length?o.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:$r.map(Oo)})}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:`No properties matched "${co}".`})}):o.jsxs(W,{sx:{position:"relative",flex:1,minHeight:200},children:[o.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:To.map(Oo)}),zr>0&&o.jsx(jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${To.length} properties. ${zr} more not shown.`})]}):o.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / ‚Ä¶ breakdown."})})]})]})}),o.jsx(W,{role:"tabpanel",hidden:ut!=="tree",sx:{display:ut==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[o.jsx(Gt,{size:"small",fullWidth:!0,value:xt,onChange:t=>Sn(t.target.value),placeholder:"Search the model tree‚Ä¶",disabled:!j.length,sx:{flexShrink:0}}),o.jsxs(W,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[o.jsx(W,{ref:to,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!be||!j.length)&&o.jsx(W,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:o.jsx(U,{variant:"body2",color:"text.secondary",children:be?"Load a model to populate the full model tree.":"Viewer is initializing the model tree‚Ä¶"})})]})]})})]}),o.jsx(W,{onPointerDown:os,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:Q?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(oe,{onClick:Wr,title:Q?"Close Model Explorer":"Open Model Explorer",sx:{color:Q?"white":"inherit"},children:o.jsx(Hr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:Je?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(oe,{onClick:Vr,title:Je?"Close AI Assistant":"Open AI Assistant",sx:{color:Je?"white":"inherit"},children:o.jsx(qr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Ze?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(oe,{onClick:Gr,title:Ze?"Close IDS Checker":"Open IDS Checker",sx:{color:Ze?"white":"inherit"},children:o.jsx(Yr,{})})}),o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:Qe?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:o.jsx(oe,{onClick:Or,title:Qe?"Close IDS Creator":"Open IDS Creator",sx:{color:Qe?"white":"inherit"},children:o.jsx(Kr,{})})}),Dn?o.jsx(Xr,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:o.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:1.5,display:"flex",flexDirection:"column",gap:1,zIndex:1600,backgroundColor:"rgba(245, 245, 245, 0.98)",backdropFilter:"blur(10px)",borderRadius:2,cursor:"move",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[o.jsxs(W,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:.5,cursor:"grab","&:active":{cursor:"grabbing"}},children:[o.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:.5},children:[o.jsx(Es,{fontSize:"small",sx:{color:"text.secondary"}}),o.jsx(U,{variant:"caption",sx:{fontWeight:600,color:"primary.main"},children:"View Controls"})]}),o.jsx(oe,{size:"small",onClick:()=>kr(!1),title:"Close toolbar",sx:{ml:1},children:o.jsx(Jr,{fontSize:"small"})})]}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:ns,disabled:!f,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(Qr,{fontSize:"small"})})}),o.jsx(te,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:as,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:o.jsx(Ps,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),o.jsxs(W,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[o.jsx(te,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),o.jsx(te,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),o.jsx(te,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),o.jsx(te,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),o.jsx(te,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),o.jsx(te,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:o.jsx(ie,{size:"small",onClick:()=>mt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),o.jsx(te,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:o.jsxs(ie,{size:"small",onClick:()=>mt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[o.jsx(As,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:()=>Wo("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),o.jsx(te,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:()=>Wo("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),o.jsx(te,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:()=>Wo("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:o.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Ne.x.toFixed(1)]}),o.jsx(Ho,{value:Ne.x,onChange:(t,r)=>Uo("x",r),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Ne.y.toFixed(1)]}),o.jsx(Ho,{value:Ne.y,onChange:(t,r)=>Uo("y",r),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&o.jsxs(W,{sx:{mt:1},children:[o.jsxs(U,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Ne.z.toFixed(1)]}),o.jsx(Ho,{value:Ne.z,onChange:(t,r)=>Uo("z",r),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:cs,sx:{border:"2px solid",borderColor:Tt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Tt?"warning.main":"white",color:Tt?"white":"warning.dark","&:hover":{backgroundColor:Tt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:o.jsx(Ms,{fontSize:"small"})})}),o.jsx(te,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:us,disabled:!ne.x&&!ne.y&&!ne.z&&!Tt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:o.jsx(Rs,{fontSize:"small"})})})]}),o.jsxs(W,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[o.jsx(te,{title:Nt?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:ds,sx:{border:"2px solid",borderColor:Nt?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Nt?"success.main":"white",color:Nt?"white":"success.dark","&:hover":{backgroundColor:Nt?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:o.jsx($s,{fontSize:"small"})})}),Ar&&o.jsxs(U,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Ar," units"]})]}),o.jsxs(W,{sx:{mt:.5},children:[o.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),o.jsxs(W,{sx:{display:"flex",gap:.5},children:[o.jsx(te,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:()=>br("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:o.jsx(zs,{fontSize:"small"})})}),o.jsx(te,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:o.jsx(oe,{size:"small",onClick:()=>br("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:o.jsx(Ds,{fontSize:"small"})})})]}),xe==="rectangle"&&o.jsx(jt,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]})]})}):o.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%"},children:o.jsx(oe,{onClick:()=>kr(!0),title:"Open View Controls",children:o.jsx(Qr,{})})}),o.jsx(d.Suspense,{fallback:null,children:H&&o.jsx(Vl,{open:H,onClose:()=>Re(!1),viewerApi:bt.current??null})}),o.jsxs(qo,{open:Mn,onClose:po,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Yo,{children:"Settings"}),o.jsx(Ko,{dividers:!0,children:o.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[o.jsxs(en,{component:"fieldset",children:[o.jsx(tn,{component:"legend",sx:{mb:1},children:"AI Provider"}),o.jsxs(on,{value:he,onChange:t=>Wn(t.target.value),children:[o.jsx(Wt,{value:"gemini",control:o.jsx(Ut,{}),label:"Google Gemini"}),o.jsx(Wt,{value:"openai",control:o.jsx(Ut,{}),label:"OpenAI (ChatGPT)"}),o.jsx(Wt,{value:"disabled",control:o.jsx(Ut,{}),label:"Disabled (No AI)"})]})]}),he!=="disabled"&&o.jsxs(o.Fragment,{children:[o.jsx(Gt,{label:"API Key",type:Ao?"text":"password",value:We,onChange:t=>Po(t.target.value),fullWidth:!0,placeholder:`Enter your ${he==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:o.jsx(oe,{onClick:()=>mr(!Ao),edge:"end",size:"small",children:Ao?o.jsx(Fs,{}):o.jsx(Ts,{})})},helperText:he==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),o.jsx(Gt,{select:!0,label:"Model",value:Dt,onChange:t=>no(t.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:fl(he).map(t=>o.jsx("option",{value:t,children:t},t))}),o.jsxs(W,{sx:{display:"flex",gap:1,alignItems:"center"},children:[o.jsx(ie,{variant:"outlined",onClick:Un,disabled:!We||gr,size:"small",children:gr?"Testing...":"Test Connection"}),yr==="success"&&o.jsx(U,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úì Connection successful"}),yr==="error"&&o.jsx(U,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"‚úó Connection failed"})]}),o.jsx(jt,{severity:"info",variant:"outlined",children:o.jsxs(U,{variant:"body2",children:[o.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",he==="gemini"?"Google":"OpenAI","."]})})]})]})}),o.jsxs(Xo,{children:[o.jsx(ie,{onClick:po,children:"Cancel"}),o.jsx(ie,{onClick:Gn,variant:"contained",color:"primary",disabled:he!=="disabled"&&!We,children:"Save"})]})]}),o.jsxs(qo,{open:An,onClose:_r,fullWidth:!0,maxWidth:"md",children:[o.jsx(Yo,{children:"About Savora Viewer"}),o.jsxs(Ko,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[o.jsx(U,{variant:"h6",gutterBottom:!0,children:"Version 0.2.1 Preview"}),o.jsxs(U,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",o.jsx("br",{}),"For bug reporting and more information, visit our ",o.jsx(Ns,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",o.jsx("br",{}),o.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),o.jsx(U,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Multiple format support (IFC, Fragments)",o.jsx("br",{}),"‚Ä¢ Pan, zoom, rotate navigation",o.jsx("br",{}),"‚Ä¢ Selection via point-and-click or rectangular region",o.jsx("br",{}),"‚Ä¢ Orthogonal projection for accurate measurements",o.jsx("br",{}),"‚Ä¢ View management (zoom to fit, home, cube orientation)",o.jsx("br",{}),"‚Ä¢ Toggle performance stats",o.jsx("br",{}),"‚Ä¢ Object measurement tools",o.jsx("br",{}),"‚Ä¢ Clipping planes for sectional views"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Spatial and classification hierarchy navigation",o.jsx("br",{}),"‚Ä¢ Tree-based model structure view",o.jsx("br",{}),"‚Ä¢ Properties panel with expand/collapse",o.jsx("br",{}),"‚Ä¢ Search and filter functionality",o.jsx("br",{}),"‚Ä¢ Property export (CSV, JSON)",o.jsx("br",{}),"‚Ä¢ Favorites system for quick access",o.jsx("br",{}),"‚Ä¢ Parametric filtering with Ghost/Isolate modes"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Validate models against Information Delivery Specification (IDS)",o.jsx("br",{}),"‚Ä¢ Load IDS files from local storage",o.jsx("br",{}),"‚Ä¢ Visual feedback: green (pass) and red (fail) indicators",o.jsx("br",{}),"‚Ä¢ Filter models by validation results",o.jsx("br",{}),"‚Ä¢ Export validation reports"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Visual authoring tool for IDS specifications",o.jsx("br",{}),"‚Ä¢ Capture and define validation rules",o.jsx("br",{}),"‚Ä¢ Property picker for easy specification setup",o.jsx("br",{}),"‚Ä¢ Save and load IDS files",o.jsx("br",{}),"‚Ä¢ Integration with IDS Checker for immediate validation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Natural language queries about model contents",o.jsx("br",{}),"‚Ä¢ Intelligent model analysis and insights",o.jsx("br",{}),"‚Ä¢ Context-aware responses based on selected elements",o.jsx("br",{}),"‚Ä¢ Interactive chat interface",o.jsx("br",{}),"‚Ä¢ Selection and filtering via conversation"]}),o.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),o.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["‚Ä¢ Floating toolbar for model operations",o.jsx("br",{}),"‚Ä¢ Tooltips and keyboard shortcuts",o.jsx("br",{}),"‚Ä¢ Collapsible side panels",o.jsx("br",{}),"‚Ä¢ Responsive layout",o.jsx("br",{}),"‚Ä¢ Dark theme optimized for long viewing sessions"]})]}),o.jsx(Xo,{children:o.jsx(ie,{onClick:_r,color:"primary",children:"Close"})})]}),o.jsxs(qo,{open:zn,onClose:Lr,fullWidth:!0,maxWidth:"sm",children:[o.jsx(Yo,{children:"Export properties"}),o.jsxs(Ko,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[o.jsxs(en,{component:"fieldset",variant:"standard",children:[o.jsx(tn,{component:"legend",children:"Scope"}),o.jsxs(on,{value:et,onChange:t=>Sr(t.target.value),children:[o.jsx(Wt,{value:"selected",control:o.jsx(Ut,{}),label:"Selected items",disabled:!ae.length}),o.jsx(Wt,{value:"model",control:o.jsx(Ut,{}),label:"Specific model",disabled:!j.length})]})]}),o.jsx(Ls,{in:et==="model",unmountOnExit:!0,children:o.jsx(Gt,{select:!0,fullWidth:!0,label:"Model",value:tt,onChange:t=>so(t.target.value),disabled:!j.length,children:j.map(t=>o.jsx(Jo,{value:t.id,children:t.label},t.id))})}),et==="selected"&&!ae.length&&o.jsx(jt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),vr&&o.jsx(jt,{severity:"error",variant:"outlined",children:vr})]}),o.jsxs(Xo,{children:[o.jsx(ie,{onClick:Lr,disabled:ft,children:"Cancel"}),o.jsx(ie,{variant:"contained",onClick:On,disabled:ft||et==="selected"&&!ae.length||et==="model"&&!tt,children:ft?"Exporting‚Ä¶":"Export CSV"})]})]}),o.jsxs(d.Suspense,{fallback:null,children:[o.jsx(Ll,{isOpen:Ze,onOpen:qn,onClose:Yn,viewerApi:Bo,hasModel:j.length>0,expandSignal:Rn}),o.jsx(Ol,{isOpen:Qe,onClose:()=>xr(!1),viewerApi:Bo,selectedItemData:q,onValidate:Kn}),o.jsx(Nl,{getModelDataForAI:rs,isOpen:Je,onOpen:Vn,onClose:_n,expandSignal:Pn,onRequestSelection:ts,onOpenSettings:Br})]}),o.jsxs(Os,{open:!!oo,onClose:is,anchorReference:"anchorPosition",anchorPosition:oo?{top:oo.mouseY,left:oo.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[o.jsx(Jo,{onClick:ss,disabled:v.length===0,children:"Hide selected element"}),o.jsx(Jo,{onClick:ls,children:"Reset hidden elements"})]})]})};function Io(e,s=2e3){try{if(e==null)return"null";const a=typeof e=="string"?e:JSON.stringify(e,null,2);return a?a.length<=s?a:`${a.slice(0,s)}
... [truncated ${a.length-s} chars]`:""}catch{return String(e)}}Vs.createRoot(document.getElementById("root")).render(o.jsx(Pt.StrictMode,{children:o.jsx(Ql,{})}));export{gl as a,zl as b,ii as g,Qo as i,dl as l,li as p,pl as s,Fl as u};
