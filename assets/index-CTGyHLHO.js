const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-DDX7oFad.js","assets/vendor-DY-rktTO.js","assets/thatopen-vendor-C9781ij5.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-CYvAisez.js","assets/IdsCreatorPanel-Bug8S3K8.js","assets/ModelFilterPanel-zg9LegTn.js"])))=>i.map(i=>d[i]);
import{ck as Hs,cl as Us,cm as c,cn as $t,co as r,cp as G,cq as H,cr as Q,cs as X,ct as qs,cu as Ks,cv as Ys,cw as Xs,cx as Js,cy as Zs,cz as Qs,cA as ie,cB as yn,cC as bn,cD as xn,cE as wn,cF as je,cG as ei,cH as In,cI as ti,cJ as Cn,cK as Sn,cL as ri,cM as jn,cN as Yt,cO as Rt,cP as Xt,cQ as oi,cR as ni,cS as vn,cT as si,cU as ii,cV as ao,cW as li,cX as ai,cY as ci,cZ as di,c_ as kn,c$ as Pn,d0 as En,d1 as ui,d2 as fi,d3 as co,d4 as pi,d5 as hi,d6 as Pr,d7 as uo,d8 as fo,d9 as po,da as An,db as Rn,dc as Jt,dd as Zt,de as ho,df as mi,dg as gi,dh as yi,di as bi}from"./vendor-DY-rktTO.js";import{l as xi,_ as wi,C as Ii,W as Ci,S as Si,a as ji,O as vi,G as ki,F as Pi,t as Ei,H as Ai,Y as Ri,$ as Mn}from"./thatopen-vendor-C9781ij5.js";import{B as dt,V as ee,C as Le,a3 as Mi,c as mo,P as Mt,a6 as go,l as zn,G as zi,S as Di,h as Dn,$ as $i,y as $n,ab as Fi,D as Ni}from"./three-vendor-kQcUiZz9.js";(function(){const a=document.createElement("link").relList;if(a&&a.supports&&a.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))I(i);new MutationObserver(i=>{for(const b of i)if(b.type==="childList")for(const w of b.addedNodes)w.tagName==="LINK"&&w.rel==="modulepreload"&&I(w)}).observe(document,{childList:!0,subtree:!0});function d(i){const b={};return i.integrity&&(b.integrity=i.integrity),i.referrerPolicy&&(b.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?b.credentials="include":i.crossOrigin==="anonymous"?b.credentials="omit":b.credentials="same-origin",b}function I(i){if(i.ep)return;i.ep=!0;const b=d(i);fetch(i.href,b)}})();const Li="modulepreload",Oi=function(t){return"/Savora-Viewer/"+t},Fn={},Dt=function(a,d,I){let i=Promise.resolve();if(d&&d.length>0){let R=function(h){return Promise.all(h.map(P=>Promise.resolve(P).then(v=>({status:"fulfilled",value:v}),v=>({status:"rejected",reason:v}))))};document.getElementsByTagName("link");const w=document.querySelector("meta[property=csp-nonce]"),x=w?.nonce||w?.getAttribute("nonce");i=R(d.map(h=>{if(h=Oi(h),h in Fn)return;Fn[h]=!0;const P=h.endsWith(".css"),v=P?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${h}"]${v}`))return;const V=document.createElement("link");if(V.rel=P?"stylesheet":Li,P||(V.as="script"),V.crossOrigin="",V.href=h,x&&V.setAttribute("nonce",x),document.head.appendChild(V),P)return new Promise((F,j)=>{V.addEventListener("load",F),V.addEventListener("error",()=>j(new Error(`Unable to preload CSS for ${h}`)))})}))}function b(w){const x=new Event("vite:preloadError",{cancelable:!0});if(x.payload=w,window.dispatchEvent(x),!x.defaultPrevented)throw w}return i.then(w=>{for(const x of w||[])x.status==="rejected"&&b(x.reason);return a().catch(b)})},Io="bim_viewer_api_config",Ti=t=>{try{return btoa(t)}catch{return t}},Vi=t=>{try{return atob(t)}catch{return t}},_i=t=>{const a={...t,apiKey:Ti(t.apiKey)};localStorage.setItem(Io,JSON.stringify(a))},Bi=()=>{const t=localStorage.getItem(Io);if(!t)return null;try{const a=JSON.parse(t);return{...a,apiKey:Vi(a.apiKey)}}catch{return null}},Gi=()=>{localStorage.removeItem(Io)},Wi=t=>{switch(t){case"gemini":return["gemini-2.5-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},Er=t=>{switch(t){case"gemini":return"gemini-2.5-flash";case"openai":return"gpt-4o-mini";default:return""}},Hi=async(t,a,d="gemini-2.5-flash")=>{const I=`https://generativelanguage.googleapis.com/v1beta/models/${d}:generateContent?key=${t}`,i=await fetch(I,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:a}]}]})});if(!i.ok){const w=await i.json().catch(()=>({}));throw new Error(w.error?.message||`Gemini API error: ${i.status} ${i.statusText}`)}const b=await i.json();if(!b.candidates||b.candidates.length===0)throw new Error("No response from Gemini API");return b.candidates[0].content.parts[0].text},Ui=async(t,a="gemini-2.0-flash-exp")=>{try{return await Hi(t,"Hello, respond with OK",a),!0}catch{return!1}},qi=async(t,a,d="gpt-4o-mini")=>{const i=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({model:d,messages:[{role:"user",content:a}]})});if(!i.ok){const w=await i.json().catch(()=>({}));throw new Error(w.error?.message||`OpenAI API error: ${i.status} ${i.statusText}`)}const b=await i.json();if(!b.choices||b.choices.length===0)throw new Error("No response from OpenAI API");return b.choices[0].message.content},Ki=async(t,a="gpt-4o-mini")=>{try{return await qi(t,"Hello, respond with OK",a),!0}catch{return!1}},Yi="fragments-ids",se="elements-v5",de="cache-metadata-v1",Xi=6,Pe=()=>new Promise((t,a)=>{const d=indexedDB.open(Yi,Xi);d.onerror=()=>a(d.error??new Error("IndexedDB open failed")),d.onupgradeneeded=()=>{const I=d.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(b=>{I.objectStoreNames.contains(b)&&I.deleteObjectStore(b)}),I.objectStoreNames.contains(se)||I.createObjectStore(se),I.objectStoreNames.contains(de)||I.createObjectStore(de)},d.onsuccess=()=>t(d.result)}),yo={async get(t){const a=await Pe();return new Promise((d,I)=>{const w=a.transaction(se,"readonly").objectStore(se).get(t);w.onsuccess=()=>d(w.result??null),w.onerror=()=>I(w.error??new Error("IndexedDB get failed"))})},async set(t,a){const d=await Pe();await new Promise((I,i)=>{const b=d.transaction([se,de],"readwrite"),w=b.objectStore(se),x=b.objectStore(de),R=w.put(a,t),h={modelKey:t,timestamp:Date.now(),elementCount:a.length,version:"1.0"};x.put(h,t),R.onsuccess=()=>I(),R.onerror=()=>i(R.error??new Error("IndexedDB set failed"))})},async append(t,a){if(!a||!a.length)return;const d=await Pe();await new Promise((I,i)=>{const b=d.transaction([se,de],"readwrite"),w=b.objectStore(se),x=b.objectStore(de),R=w.get(t);R.onsuccess=()=>{const P=(R.result??[]).concat(a),v=w.put(P,t),V={modelKey:t,timestamp:Date.now(),elementCount:P.length,version:"1.0"};x.put(V,t),v.onsuccess=()=>I(),v.onerror=()=>i(v.error??new Error("IndexedDB append put failed"))},R.onerror=()=>i(R.error??new Error("IndexedDB append get failed"))})},async writePart(t,a,d){const I=`${t}::part::${String(a).padStart(6,"0")}`,i=`${t}::partindex::${String(a).padStart(6,"0")}`,b=await Pe();await new Promise((w,x)=>{const R=b.transaction([se,de],"readwrite"),h=R.objectStore(se),P=R.objectStore(de),v=h.put(d,I);v.onsuccess=()=>{const V=P.get(t);V.onsuccess=()=>{const F=V.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};F.timestamp=Date.now(),F.elementCount=(F.elementCount||0)+d.length;const j=Array.isArray(F.partKeys)?F.partKeys.slice():[];j.includes(I)||j.push(I),F.partKeys=j,P.put(F,t);try{const z=d.map(k=>k.GlobalId).filter(Boolean),T=h.put(z,i);T.onsuccess=()=>{},T.onerror=()=>{}}catch{}w()},V.onerror=()=>w()},v.onerror=()=>x(v.error??new Error("IndexedDB writePart failed"))})},async getPersistedIds(t){const a=await this.getPartKeys(t);if(!a||!a.length)return new Set;const d=await Pe(),I=new Set;return await new Promise(i=>{const w=d.transaction(se,"readonly").objectStore(se);let x=a.length;a.forEach(R=>{const h=R.replace("::part::","::partindex::"),P=w.get(h);P.onsuccess=()=>{const v=P.result??[];for(const V of v)typeof V=="string"&&V&&I.add(V);x-=1,x===0&&i()},P.onerror=()=>{x-=1,x===0&&i()}})}),I},async getPartKeys(t){const a=await this.getMetadata(t);return Array.isArray(a?.partKeys)?a.partKeys:[]},async listParts(t){return(await this.getPartKeys(t)).slice().sort()},async readAllParts(t){const a=await Pe(),d=await this.getPartKeys(t);return d.length?new Promise((I,i)=>{const w=a.transaction(se,"readonly").objectStore(se),x=[];let R=d.length;d.forEach(h=>{const P=w.get(h);P.onsuccess=()=>{const v=P.result??[];x.push(...v),R-=1,R===0&&I(x)},P.onerror=()=>{R-=1,R===0&&I(x)}})}):[]},async removeParts(t){const a=await Pe(),d=`${t}::part::`,i=(await this.keys()).filter(b=>b.startsWith(d));i.length&&await new Promise((b,w)=>{const x=a.transaction([se,de],"readwrite"),R=x.objectStore(se),h=x.objectStore(de);i.forEach(P=>R.delete(P)),h.delete(t),x.oncomplete=()=>b(),x.onerror=()=>w(x.error??new Error("IndexedDB removeParts failed"))})},async getMetadata(t){const a=await Pe();return new Promise((d,I)=>{const w=a.transaction(de,"readonly").objectStore(de).get(t);w.onsuccess=()=>d(w.result??null),w.onerror=()=>I(w.error??new Error("IndexedDB metadata get failed"))})},async remove(t){const a=await Pe();await new Promise((d,I)=>{const i=a.transaction([se,de],"readwrite"),b=i.objectStore(se),w=i.objectStore(de);b.delete(t),w.delete(t),i.oncomplete=()=>d(),i.onerror=()=>I(i.error??new Error("IndexedDB delete failed"))})},async keys(){const t=await Pe();return new Promise((a,d)=>{const b=t.transaction(se,"readonly").objectStore(se).getAllKeys();b.onsuccess=()=>a(b.result??[]),b.onerror=()=>d(b.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const t=await Pe();return new Promise((a,d)=>{const b=t.transaction(de,"readonly").objectStore(de).getAll();b.onsuccess=()=>a(b.result??[]),b.onerror=()=>d(b.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(t=720*60*60*1e3){const a=await Pe(),d=await this.getAllMetadata(),I=Date.now(),i=d.filter(b=>I-b.timestamp>t).map(b=>b.modelKey);i.length>0&&await new Promise((b,w)=>{const x=a.transaction([se,de],"readwrite"),R=x.objectStore(se),h=x.objectStore(de);i.forEach(P=>{R.delete(P),h.delete(P)}),x.oncomplete=()=>{b()},x.onerror=()=>w(x.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(t,a){const d=await this.getMetadata(t);return!d||!d.modelSignature?!1:d.modelSignature===a},async updateSignature(t,a,d){const I=await Pe();await new Promise((i,b)=>{const x=I.transaction(de,"readwrite").objectStore(de),R=x.get(t);R.onsuccess=()=>{const h=R.result??{modelKey:t,timestamp:Date.now(),elementCount:0,version:"1.0"};h.modelSignature=a,h.modelFiles=d,h.timestamp=Date.now();const P=x.put(h,t);P.onsuccess=()=>i(),P.onerror=()=>b(P.error??new Error("IndexedDB updateSignature failed"))},R.onerror=()=>b(R.error??new Error("IndexedDB updateSignature get failed"))})}},Ji=async t=>{const a=new TextEncoder,d=`${t.modelUrl}|${t.extra??""}`,I=a.encode(d),i=await crypto.subtle.digest("SHA-256",I),b=new Uint8Array(i);return btoa(String.fromCharCode(...b)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},Bn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},et=t=>t==null?[]:Array.isArray(t)?t:[t],Nn=t=>{if(t==null)return[];if(typeof t=="string")try{const a=JSON.parse(t);return Array.isArray(a)?a:[]}catch{return[]}if(typeof t=="object"){const a=t;if(typeof a.__cdata=="string")try{const d=JSON.parse(a.__cdata);return Array.isArray(d)?d:[]}catch{return[]}if(Array.isArray(a.item))return a.item;if(a.item!=null)return[a.item];if(Array.isArray(a.Rule))return a.Rule;if(a.Rule!=null)return[a.Rule]}return Array.isArray(t)?t:[]},Tl=t=>{if(!t||typeof t!="string")return[];const a=new Us(Bn);let d={};try{d=a.parse(t)}catch(h){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",h),[]}const I=d?.IdsCreator??d?.idsCreator??d?.IDS_CREATOR??d?.Ids??d,i=I?.Specification??I?.specification??I?.Specifications??I?.specifications??null;if(i){const h=et(i);if(h.length)return h.map((P,v)=>{const V=P?.["@_id"]?.trim?.()||`spec-${v+1}`,F=(P?.Name??P?.name??"")?.toString?.()??"",j=(P?.Description??P?.description??"")?.toString?.()??"",z=Nn(P?.Applicability??P?.applicability),T=Nn(P?.Requirements??P?.requirements);return{id:V,name:F,description:j,applicability:z,requirements:T}})}const b=h=>{if(!h||typeof h!="object")return[];for(const[P,v]of Object.entries(h)){const V=String(P).toLowerCase();if(V.endsWith(":specification")||V==="specification"||V==="ids:specification")return et(v)}for(const P of Object.values(h))if(P&&typeof P=="object"){const v=b(P);if(v&&v.length)return v}return[]},w=b(d);if(!w.length)return[];const x=h=>{if(!h)return null;if(typeof h=="string")return h;if(typeof h=="object")for(const P of Object.keys(h)){const v=P.toLowerCase();if(v.includes("simplevalue")||v==="#text"||v==="value"){const V=h[P];if(typeof V=="string")return V;if(typeof V=="object"&&(V?.value||V?.Value))return String(V.value??V.Value)}}return null};return w.map((h,P)=>{const v=h?.["@_id"]?.trim?.()||`spec-${P+1}`,V=h?.["@_name"]??h?.name??h?.Name??"",F=String(V??""),j="",z=[],T=[],k=h?.applicability??h?.Applicability??h?.["ids:applicability"]??null,$=et(k);for(const J of $){let oe=null;const Y=[J];for(;Y.length&&!oe;){const U=Y.shift();if(!U)continue;const $e=x(U);if($e){oe=$e;break}if(typeof U=="object")for(const we of Object.values(U))we&&typeof we=="object"&&Y.push(we)}oe&&z.push({entity:oe})}const q=h?.requirements??h?.Requirements??h?.["ids:requirements"]??null,me=et(q),te=J=>{const oe=[],Y=[];if(J?.property&&Y.push(...et(J.property)),J?.Property&&Y.push(...et(J.Property)),Array.isArray(J)&&Y.push(...J),!Y.length&&typeof J=="object")for(const U of Object.values(J))U&&typeof U=="object"&&Y.push(U);for(const U of Y){const $e=U?.propertySet??U?.PropertySet??U?.["ids:propertySet"]??U?.propertySet,we=U?.baseName??U?.BaseName??U?.["ids:baseName"]??U?.baseName,rt=x($e)||x(U?.propertySet?.simpleValue)||x(U?.propertySet?.["ids:simpleValue"]),Ft=x(we)||x(U?.baseName?.simpleValue)||x(U?.baseName?.["ids:simpleValue"]),qe=[],ye=U?.allowedValues??U?.AllowedValues??U?.["ids:allowedValues"];if(ye){const Ke=ye?.values??ye?.Values??ye?.["ids:values"]??ye,Nt=et(Ke?.value??Ke?.Value??Ke?.["ids:value"]??Ke??[]);for(const ot of Nt){const Fe=x(ot)||x(ot?.simpleValue)||x(ot?.["ids:simpleValue"]);Fe&&qe.push(Fe)}}if(rt||Ft){const Ke={id:`rule-${P}-${oe.length}`,propertyPath:`${rt??"Pset"}.${Ft??"Property"}`,operator:"equals"};qe.length&&(Ke.value=qe.length===1?qe[0]:JSON.stringify(qe)),oe.push(Ke)}}return oe};for(const J of me){const oe=te(J);oe.length&&T.push(...oe)}return{id:v,name:String(F??""),description:String(j),applicability:z,requirements:T}})},Vl=t=>{const a=new Hs(Bn);if((t??[]).some(b=>Array.isArray(b.requirements)&&b.requirements.some(w=>w&&typeof w=="object"&&"propertyPath"in w))){const w={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(t??[]).map(R=>{const h=[],P=j=>{if(!j&&j!==0)return null;if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(j?.ifcClass&&typeof j.ifcClass=="string"&&j.ifcClass.trim())return j.ifcClass.trim();const z=j?.entity??j?.ifcType??j?.type;if(z&&typeof z=="string"&&z.trim())return z.trim();const T=j?.sample??j;if(T){if(T._category&&typeof T._category=="object"){const $=T._category.value??T._category.Value;if(typeof $=="string"&&$.trim())return $.trim()}const k=T?.ifcClass??T?.category?.value??T?.type??T?._type;if(k&&typeof k=="string"&&k.trim())return k.trim()}return null};for(const j of et(R.applicability)){const z=P(j)??null,T=z&&String(z).trim()?String(z):"IFCELEMENT";h.push({"ids:name":{"ids:simpleValue":T}})}const v=[],V=j=>{if(j==null)return"";if(typeof j=="string")return j;if(typeof j=="number")return String(j);if(typeof j=="object"){if(j["ids:simpleValue"])return String(j["ids:simpleValue"]);if(j.__cdata)return String(j.__cdata);if(j.Name)return String(j.Name);if(j.name)return String(j.name);for(const z of Object.keys(j)){const T=j[z];if(typeof T=="string"&&T.trim())return T;if(T&&typeof T=="object"){const k=T;if(typeof k["ids:simpleValue"]=="string")return k["ids:simpleValue"];if(typeof k.value=="string")return k.value}}return""}return""};for(const j of et(R.requirements))if(j&&typeof j=="object"){const z=j;let T=null,k=null;if(typeof z.propertyPath=="string"){const[Y,U]=String(z.propertyPath).split(".");T=Y,k=U}else z.propertyPath&&typeof z.propertyPath=="object"?(T=z.propertyPath.pset??z.propertyPath.propertySet??z.propertySet??null,k=z.propertyPath.property??z.propertyPath.prop??z.property??z.propertyName??null):(T=z.propertySet??z.pset??null,k=z.baseName??z.property??z.prop??null);const $=V(T)||"Pset",q=V(k)||"Property",me=rr($)||$,te=rr(q)||q,J={};if(J["ids:propertySet"]={"ids:simpleValue":me},J["ids:baseName"]={"ids:simpleValue":te},(z.operator??"equals")==="exists")J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(z.value!=null&&String(z.value).trim()){let Y=null;try{const U=typeof z.value=="string"?JSON.parse(z.value):z.value;Array.isArray(U)&&(Y=U.map($e=>String($e)))}catch{}Y||typeof z.value=="string"&&z.value.includes(",")&&(Y=z.value.split(",").map(U=>Mr(U.trim())).filter(Boolean)),Y&&Y.length?J["ids:allowedValues"]={"ids:values":{"ids:value":Y.map(U=>({"ids:simpleValue":Mr(String(U))}))}}:J["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":Mr(String(z.value))}}}}v.push({"ids:property":J})}const F={"@_ifcVersion":"IFC4","@_name":R.name??""};return h.length&&(F["ids:applicability"]={"ids:entity":h.map(j=>({"ids:name":j["ids:name"]?j["ids:name"]:j}))}),v.length&&(F["ids:requirements"]={"ids:property":v.map(j=>j["ids:property"])}),F})}},x=a.build(w);return x.startsWith("<?xml")?x:`<?xml version="1.0" encoding="UTF-8"?>
${x}`}const I={IdsCreator:{Specification:(t??[]).map(b=>({"@_id":b.id,Name:b.name,Description:b.description,Applicability:{__cdata:JSON.stringify(b.applicability??[])},Requirements:{__cdata:JSON.stringify(b.requirements??[])}}))}},i=a.build(I);return i.startsWith("<?xml")?i:`<?xml version="1.0" encoding="UTF-8"?>
${i}`},rr=t=>t?t.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",Mr=t=>!t||typeof t!="string"?t:t.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),Gn=t=>{if(t==null)return"";if(typeof t=="string")return Mr(t.trim());if(typeof t=="number"||typeof t=="boolean")return String(t);try{return JSON.stringify(t)}catch{return String(t)}},Zi=t=>{if(!t)return{};const a={};for(const[d,I]of Object.entries(t)){if(!I||typeof I!="object")continue;const i=rr(d)||d;for(const[b,w]of Object.entries(I)){const x=rr(b)||b,R=`${i}.${x}`;R in a||(a[R]=Gn(w))}}return a};let wt=null;const Qi=()=>{wt=null},el=t=>t.slice().sort().join("|"),tl=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],rl=(t,a)=>{if(!t||typeof t!="object")return;const d=a.map(b=>b.toLowerCase()),I=new WeakSet,i=[t];for(;i.length;){const b=i.pop();if(!(!b||typeof b!="object")&&!I.has(b)){if(I.add(b),Array.isArray(b)){for(const w of b)w&&typeof w=="object"&&i.push(w);continue}for(const[w,x]of Object.entries(b)){const R=w.toLowerCase();if(d.some(h=>R.includes(h)))if(typeof x=="string"){const h=x.trim();if(h)return h}else{if(typeof x=="number"&&Number.isFinite(x))return x.toString();if(typeof x=="boolean")return x?"true":"false";if(x&&typeof x=="object"){const h=x;if(typeof h.value=="string"){const P=h.value.trim();if(P)return P}if(typeof h.Value=="string"){const P=h.Value.trim();if(P)return P}h.value&&typeof h.value=="object"&&i.push(h.value),h.Value&&typeof h.Value=="object"&&i.push(h.Value)}}x&&typeof x=="object"&&i.push(x)}}}},ol=t=>{if(!t||typeof t!="object")return null;const a=t;for(const I of tl){const i=a[I];if(typeof i=="string"&&i.trim().length)return i.trim()}return rl(t,["globalid","global id","guid","uniqueid"])?.trim()??null},Ar=async(t,a,d)=>{const I=[],i=Math.max(a.length,1);d?.onProgress?.({done:0,total:i});const b=t.getElementProps;for(let w=0;w<a.length;w++){const x=a[w];try{const{ifcClass:R,psets:h,attributes:P}=await b.call(t,x),v=Zi(h);if("GlobalId"in v||(v.GlobalId=x),P)for(const[V,F]of Object.entries(P)){const z=`Attributes.${rr(V)||V}`;z in v||(v[z]=Gn(F))}v.ifcClass||(v.ifcClass=R),I.push({GlobalId:x,ifcClass:R,properties:v}),(w%50===0||w===a.length-1)&&d?.onProgress?.({done:I.length,total:i})}catch(R){console.warn(`IDS adapter (direct) failed to load element ${x}`,R)}}return d?.onProgress?.({done:I.length,total:i}),I},nl=async(t,a,d)=>{if(typeof t.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const I=Math.max(1,(navigator.hardwareConcurrency||4)-1),i=[],b=[],w=[];for(let h=0;h<I;h++){const P=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});i.push(P);const v=new Promise((V,F)=>{const j=T=>{const k=T.data;if(k){if(k.type==="error"){F(new Error(k.message||`Worker ${h} failed.`));return}if(k.type==="progress"){const $=w.reduce((q,me)=>q+me.length,0)+k.done;d?.onProgress?.({done:$,total:Math.max(a,$)});return}k.type==="done"&&(w[h]=k.elements??[],V(k.elements??[]))}},z=T=>{F(T.error??new Error(T.message||`Worker ${h} error.`))};P.addEventListener("message",j),P.addEventListener("error",z)});b.push(v),P.postMessage({type:"build-props",reset:!0,total:a})}d?.onProgress?.({done:0,total:a});const x=new Set;let R=0;try{for await(const h of t.iterElements({batchSize:128})){if(!Array.isArray(h)||!h.length)continue;const P=[];h.forEach(v=>{if(!v||typeof v!="object")return;const V=v.data;if(!V)return;const F=ol(V);if(!F||x.has(F))return;x.add(F);const j=typeof V.ifcClass=="string"?V.ifcClass:void 0;P.push({globalId:F,ifcClass:j,data:V})}),P.length&&(i[R].postMessage({type:"build-props",elements:P}),R=(R+1)%I)}}catch(h){throw i.forEach(P=>{P.postMessage({type:"cancel"}),P.terminate()}),h}i.forEach(h=>{h.postMessage({type:"build-props",final:!0})});try{const P=(await Promise.all(b)).flat();return d?.onProgress?.({done:P.length,total:Math.max(a,P.length)}),P}finally{i.forEach(h=>h.terminate())}},sl=async(t,a)=>{try{const d=typeof a.countElements=="function"?await a.countElements():void 0;return await Ji({modelUrl:t,extra:d!=null?String(d):void 0})}catch(d){return console.warn("IDS adapter: failed to compute model key for cache",d),null}},il=async(t,a)=>{if(!t)return[];let d;if(a?.filterGlobalIds&&a.filterGlobalIds.length>0?d=a.filterGlobalIds:d=await t.listGlobalIds(),!d.length)return wt=null,[];const I=el(d),i=Math.max(d.length,1);if(a?.onPhase?.("BUILDING_PROPERTIES"),a?.onProgress?.({done:0,total:i}),wt&&wt.token===I)return wt.elements;const b=a?.filterGlobalIds&&a.filterGlobalIds.length>0;let w=null;if(!b&&(w=await sl(I,t),w))try{const R=await yo.get(w);if(R&&R.length){const h=await yo.getMetadata(w),P=h?Math.round((Date.now()-h.timestamp)/1e3/60):0;return a?.onProgress?.({done:R.length,total:i}),wt={token:I,elements:R},R}}catch(R){console.warn("IDS adapter: failed to read cached elements from IndexedDB",R)}let x=[];if(b)x=await Ar(t,d,a);else{const R=typeof t.countElements=="function"?await t.countElements().catch(()=>d.length):d.length;if(typeof t.iterElements=="function")try{x=await nl(t,R??d.length,a),x.length||(x=await Ar(t,d,a))}catch(h){console.warn("IDS adapter: property build worker failed, falling back to direct collection",h),x=await Ar(t,d,a)}else x=await Ar(t,d,a)}return w&&x.length&&yo.set(w,x).catch(R=>console.warn("IDS adapter: failed to persist elements cache",R)),wt={token:I,elements:x},a?.onProgress?.({done:Math.min(x.length,i),total:i}),x},ll={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let It=ll;const wo=new Set;let xt=null;const al=()=>{wo.forEach(t=>{try{t()}catch(a){console.error("IDS store listener error",a)}})},ce=t=>{It=t(It),al()};let ut=null,zr=null;const cl=()=>(ut||(ut=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),ut),dl=(t,a)=>{const d=cl(),I=new Promise((i,b)=>{const w=R=>{const h=R.data;if(h){if(h.type==="error"){d.removeEventListener("message",w),d.removeEventListener("error",x),b(new Error(h.message||"IDS worker failed"));return}if(h.type==="phase"){a?.onPhase?.(h.label);return}if(h.type==="progress"){a?.onProgress?.(h);return}if(h.type==="done"){d.removeEventListener("message",w),d.removeEventListener("error",x),i(h);return}}},x=R=>{d.removeEventListener("message",w),d.removeEventListener("error",x),b(R.error??new Error(R.message))};d.addEventListener("message",w),d.addEventListener("error",x),d.postMessage(t)});return zr=I.finally(()=>{zr=null}),I},Ln=()=>{ce(t=>({...t,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},pe={subscribe:t=>(wo.add(t),()=>wo.delete(t)),getState:()=>It,setIdsXmlText:(t,a)=>{const d=t.replace(/\uFEFF/g,"").trim(),I=a?.fileNames??[];ce(i=>({...i,idsXmlText:d,idsFileNames:I,error:null})),Ln()},appendDocuments:t=>{if(!t.length)return;const a=pe.getState(),d=[];a.idsXmlText.trim().length&&d.push(a.idsXmlText.trim()),d.push(...t.map(b=>b.content.trim()).filter(Boolean));const I=d.join(`

`),i=[...a.idsFileNames,...t.map(b=>b.name)];pe.setIdsXmlText(I,{fileNames:i})},clearResults:()=>{Ln()},setValidationMode:t=>{ce(a=>({...a,validationMode:t}))},filterRows:(t,a)=>{ce(d=>{if(!t)return{...d,filteredRows:d.rows,filterDescription:null};const I=d.rows.filter(i=>{try{return t(i)}catch(b){return console.warn("IDS filter predicate threw an error",b),!0}});return{...d,filteredRows:I,filterDescription:a??null}})},runCheck:async t=>{if(!t){ce(i=>({...i,error:"Viewer API is not available."}));return}if(It.isChecking){await zr;return}const a=It.idsXmlText.trim();if(!a){ce(i=>({...i,error:"Load at least one IDS XML file before running the check."}));return}let d;if(It.validationMode==="selected")if(t.getSelectedGlobalIds){if(d=await t.getSelectedGlobalIds(),!d||d.length===0){console.error("âŒ No elements selected"),ce(i=>({...i,error:"No elements selected. Please select elements or switch to another mode."}));return}}else{console.warn("âš ï¸ getSelectedGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Selected elements validation is not supported by this viewer."}));return}else if(It.validationMode==="visible")if(t.getVisibleGlobalIds){if(d=await t.getVisibleGlobalIds(),!d||d.length===0){console.error("âŒ No visible elements found"),ce(i=>({...i,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}}else{console.warn("âš ï¸ getVisibleGlobalIds not available on viewerApi"),ce(i=>({...i,error:"Visible elements validation is not supported by this viewer."}));return}ce(i=>({...i,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),xt=new AbortController;const I=xt.signal;try{if(I.aborted)throw new Error("Validation cancelled");const i=await il(t,{filterGlobalIds:d,onPhase:h=>{ce(P=>({...P,phase:h}))},onProgress:h=>{ce(P=>({...P,progress:h}))}});if(!i.length)throw new Error("No IFC elements were found in the current viewer.");if(I.aborted)throw new Error("Validation cancelled");ce(h=>({...h,phase:"CHECKING_IDS",progress:null}));const b={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},w=await dl({type:"validate",idsXml:a,elements:i},{onPhase:h=>{const P=b[h];P&&ce(v=>({...v,phase:P}))},onProgress:h=>{ce(P=>({...P,progress:{done:h.done,total:h.total}}))}}),x=w.rules??[],R=w.rows??[];if(d&&d.length>0&&typeof t.addToCache=="function")try{await t.addToCache(d)}catch(h){console.warn("ðŸ“¦ Failed to add elements to cache:",h)}ce(h=>({...h,isChecking:!1,rules:x,rows:R,filteredRows:R,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),xt=null}catch(i){const b=i instanceof Error?i.message:"Failed to run IDS validation.";console.error("IDS run failed",i),ce(w=>({...w,isChecking:!1,error:b,phase:"ERROR",progress:null})),xt=null}},invalidateCaches:()=>{Qi(),ut&&(ut.terminate(),ut=null,zr=null),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{xt&&(xt.abort(),xt=null),ut&&ut.postMessage({type:"cancel"}),ce(t=>({...t,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},ul=t=>c.useSyncExternalStore(pe.subscribe,()=>t({...pe.getState(),...pe}),()=>t({...pe.getState(),...pe})),fl=t=>c.useSyncExternalStore(pe.subscribe,()=>t(pe.getState()),()=>t(pe.getState())),pl=()=>{const t=c.useCallback(pe.setIdsXmlText,[]),a=c.useCallback(pe.appendDocuments,[]),d=c.useCallback(pe.clearResults,[]),I=c.useCallback(pe.filterRows,[]),i=c.useCallback(pe.runCheck,[]),b=c.useCallback(pe.setValidationMode,[]),w=c.useCallback(pe.cancelValidation,[]);return{setIdsXmlText:t,appendDocuments:a,clearResults:d,filterRows:I,runCheck:i,setValidationMode:b,cancelValidation:w,invalidateCaches:pe.invalidateCaches}},Wn=pe,hl=Object.freeze(Object.defineProperty({__proto__:null,idsStore:Wn,useIdsActions:pl,useIdsStore:ul,useIdsStoreSelector:fl},Symbol.toStringTag,{value:"Module"})),ml=$t.lazy(()=>Dt(()=>import("./ChatWindow-DDX7oFad.js"),__vite__mapDeps([0,1,2,3]))),gl=$t.lazy(()=>Dt(()=>import("./IdsPanel-CYvAisez.js"),__vite__mapDeps([4,1,2,3]))),yl=$t.lazy(()=>Dt(()=>import("./IdsCreatorPanel-Bug8S3K8.js"),__vite__mapDeps([5,1,2,3]))),bl=$t.lazy(()=>Dt(()=>import("./ModelFilterPanel-zg9LegTn.js"),__vite__mapDeps([6,1]))),bo=(t,a)=>{if(t.length!==a.length)return!1;for(let d=0;d<t.length;d+=1){const I=t[d],i=a[d];if(!i||I.modelId!==i.modelId||I.localId!==i.localId)return!1}return!0},xl={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},wl=(t,a)=>{if(!t)return a;const d=[t.ifcCategory,t.Category,t.category,t.ifcClass,t.class,t.type,t.Type,t.system,t.System];for(const I of d)if(typeof I=="string"&&I.trim())return I.trim();if(Array.isArray(t.categories)&&t.categories.length){const I=t.categories.find(i=>typeof i=="string"&&i.trim());if(I)return I.trim()}return typeof t.name=="string"&&t.name.trim()?t.name.trim():typeof t.Name=="string"&&t.Name.trim()?t.Name.trim():typeof t.label=="string"&&t.label.trim()?t.label.trim():a},Il=(t,a,d)=>{const I=new Map;let i=0,b=0,w=0;d.traverse(v=>{const V=!!v?.isInstancedMesh,F=!!v?.isMesh;if(!V&&!F)return;let j=0;if(V){let k=0;typeof v.count=="number"?k=v.count:typeof v.instanceCount=="number"?k=v.instanceCount:Array.isArray(v.instanceIdMap)?k=v.instanceIdMap.length:Array.isArray(v.userData?.ids)?k=v.userData.ids.length:typeof v.userData?.size=="number"&&(k=v.userData.size),Number.isFinite(k)&&k>0&&(j=k,b+=k)}else j=1,w+=1;j<=0&&(j=1),i+=j;const z=wl(v?.userData??{},v?.type??"Mesh"),T=I.get(z)??0;I.set(z,T+j)});const x=Array.from(I.entries()).map(([v,V])=>({category:v,count:V})).sort((v,V)=>V.count-v.count),R=new dt().setFromObject(d),h=new ee,P=new ee;return R.getSize(h),R.getCenter(P),{modelId:t,label:a,elementCount:i,instancedCount:b,meshCount:w,categoryCounts:x,bboxSize:{x:h.x,y:h.y,z:h.z},bboxCenter:{x:P.x,y:P.y,z:P.z},collectedAt:Date.now()}},Cl=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),tt=t=>{if(!t)return"";let a=t.replace(/[_\-]+/g," ");return a=a.replace(/([a-z\d])([A-Z])/g,"$1 $2"),a=a.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),a=a.replace(/\s+/g," ").trim(),a?a.split(" ").map(I=>{const i=I.toUpperCase();return Cl.has(i)||i.length<=3&&/^[A-Z]+$/.test(i)?i:/^\d+(\.\d+)?$/.test(I)||!I.length?I:I.charAt(0).toUpperCase()+I.slice(1)}).join(" "):""},Sl=(t,a=200)=>t?t.length<=a?t:`${t.slice(0,a)}â€¦`:"",De=t=>{if(t==null)return"";if(typeof t=="number")return Number.isFinite(t)?t.toString():"";if(typeof t=="boolean")return t?"true":"false";if(t instanceof Date)return t.toISOString();if(typeof t=="string")return t.trim();try{const a=JSON.stringify(t);return a?a.length>500?`${a.slice(0,500)}â€¦`:a:""}catch{return String(t)}},Ee=t=>t==null?"":typeof t!="object"?De(t):"value"in t?Ee(t.value):"Value"in t?Ee(t.Value):Array.isArray(t)?t.map(a=>Ee(a)).filter(Boolean).join(", "):typeof t.x=="number"&&typeof t.y=="number"&&typeof t.z=="number"?`${De(t.x)}, ${De(t.y)}, ${De(t.z)}`:De(t),ue=(t,a)=>{if(!t||typeof t!="object")return;const d=a.map(b=>b.toLowerCase()),I=new WeakSet,i=[t];for(;i.length;){const b=i.pop();if(!(!b||typeof b!="object")&&!I.has(b)){if(I.add(b),Array.isArray(b)){for(const w of b)w&&typeof w=="object"&&i.push(w);continue}for(const[w,x]of Object.entries(b)){const R=w.toLowerCase();if(d.some(h=>R.includes(h)))if(typeof x=="string"){const h=x.trim();if(h)return h}else{if(typeof x=="number"&&Number.isFinite(x))return x.toString();if(typeof x=="boolean")return x?"true":"false";if(x&&typeof x=="object"){const h=Ee(x);if(h)return h}}x&&typeof x=="object"&&i.push(x)}}}},jl=(t,a)=>{if(!t||typeof t!="object")return Dr(t,300);const d=[],I=Oe(t)??ue(t,["name","label","description"]);I&&d.push(`name:${I}`);const i=ue(t,["category","ifcclass","ifc type","type"]);i&&d.push(`category:${i}`);const b=ue(t,["globalid","global id","guid"]);b&&d.push(`globalId:${b}`);const w=ue(t,["expressid","express id"]);if(w&&w!==b&&d.push(`expressId:${w}`),a>0)try{const{rows:R}=er(t);if(R.length){const P=R.slice(0,a).map(v=>`${v.label}=${v.value}`).join(" | ");P&&d.push(`props:${P}`),R.length>a&&d.push(`propsTruncated:${R.length-a}`)}}catch(R){console.warn("Failed to build detailed property data for AI summary",R)}const x=d.filter(Boolean).join(" | ");return x?x.length>1200?`${x.slice(0,1200)}â€¦`:x:Dr(t,300)},On={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},vl=new Set(["modelIdMap"]),zt=t=>t.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),ct=t=>t?t.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",tr=["HasProperties","hasProperties","Properties","properties"],xo=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],Tn=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),Rr=t=>{if(!t||typeof t!="object")return!1;const a=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return a&&a.toUpperCase()==="IFCPROPERTYSET"?!0:tr.some(d=>Array.isArray(t[d]))},Hn=t=>{if(!t||typeof t!="object")return!1;const a=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return a&&a.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},kl=t=>{if(!t||typeof t!="object")return De(t);const a=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const d of a){if(!(d in t))continue;const I=t[d];if(I==null)continue;if(Array.isArray(I)){const b=I.map(w=>Ee(w)).filter(Boolean).join(", ");if(b)return b;continue}const i=Ee(I);if(i)return i}for(const[d,I]of Object.entries(t))if((typeof I=="string"||typeof I=="number"||typeof I=="boolean")&&d.toLowerCase().includes("value")){const i=De(I);if(i)return i}return""},Pl=(t,a,d)=>{const I=tr.map(x=>Array.isArray(t[x])?t[x]:null).filter(x=>!!x);if(!I.length)return[];const i=tt(a)||a,b=[],w=new Map;return I.flat().forEach((x,R)=>{if(!x||typeof x!="object"||!Hn(x))return;const h=Oe(x)??(typeof x.Name=="string"?x.Name:void 0)??(typeof x.PropertyName=="string"?x.PropertyName:void 0),P=`Property ${R+1}`,v=h&&h.trim().length?h.trim():P,V=tt(v)||v,F=kl(x),j=zt(v)||"property",z=(w.get(j)??0)+1;w.set(j,z);const T=`${j}-${z}`,k=`Property Sets / ${i} / ${V}`,$=[k.toLowerCase()];F&&$.push(F.toLowerCase()),b.push({label:k,value:F||"",path:`property-sets/${d}/${T}`,searchText:$.join(" ").trim(),rawPsetName:a,rawPropertyName:v,rawValue:x.__rawValue??x})}),b},Qt=t=>{if(!t||typeof t!="object")return[];const a=[],d=new WeakSet,I=new Map,i=F=>{let j;if(typeof F=="string"){const $=F.trim();$.length&&(j=$)}!j&&F&&typeof F=="object"&&(j=Oe(F)??(typeof F.Name=="string"?F.Name:void 0)??(typeof F.id=="string"?F.id:void 0)),(!j||!j.length)&&(j="Property Set");const z=tt(j)||j,T=zt(j)||"property-set",k=(I.get(T)??0)+1;return I.set(T,k),{rawName:j,friendlyName:z,uniqueKey:`${T}-${k}`}},b=(F,j,z)=>{const T=`Property ${z+1}`,k=F?.trim?.()?F.trim():T;if(Hn(j)){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.__rawValue==null&&($.__rawValue=j),$}if(j&&typeof j=="object"){const $={...j};return $.Name==null&&$.PropertyName==null&&($.Name=k),$.PropertyName==null&&($.PropertyName=$.Name??k),$.type==null&&$.Type==null&&($.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in $)&&!("nominalValue"in $)&&!("Value"in $)&&!("value"in $)&&($.NominalValue=j),$.__rawValue=j,$}return{type:"IFCPROPERTYSINGLEVALUE",Name:k,PropertyName:k,NominalValue:j,__rawValue:j}},w=(F,j)=>{const z=[],T=(k,$)=>{const q=`Property ${z.length+1}`,me=(typeof k=="string"&&k.trim().length?k.trim():void 0)??Oe(k)??(typeof k?.Name=="string"?k.Name:void 0)??(typeof k?.PropertyName=="string"?k.PropertyName:void 0)??q;z.push(b(me,$,z.length))};if(j&&typeof j=="object")for(const k of tr){const $=j[k];Array.isArray($)&&$.length&&$.forEach(q=>T(q,q))}if(!z.length)if(Array.isArray(j))j.forEach(k=>T(k,k));else if(j&&typeof j=="object")for(const[k,$]of Object.entries(j))$!=null&&(Tn.has(k)||tr.includes(k)||xo.includes(k)||T(k,$));else j!=null&&T(void 0,j);return{type:"IFCPROPERTYSET",Name:F,HasProperties:z}},x=(F,j)=>{const T=Pl(j&&typeof j=="object"?j:{},F.rawName,F.uniqueKey);T.length&&a.push(...T)},R=F=>{if(!(!F||typeof F!="object")&&!d.has(F)){if(d.add(F),Array.isArray(F)){F.forEach(j=>{if(!j||typeof j!="object")return;const z=i(j),T=Rr(j)?j:w(z.rawName,j);x(z,T),T&&typeof T=="object"&&d.add(T)});return}for(const[j,z]of Object.entries(F)){if(z==null)continue;const T=i(j),k=Rr(z)?z:w(T.rawName,z);x(T,k),z&&typeof z=="object"&&d.add(z)}}},h=F=>{if(!F||typeof F!="object"||d.has(F))return;if(d.add(F),Array.isArray(F)){F.forEach(h);return}let j=!1;for(const z of xo)Object.prototype.hasOwnProperty.call(F,z)&&(R(F[z]),j=!0);if(Rr(F)){const z=i(F);x(z,F)}!j&&!Rr(F)&&Object.entries(F).forEach(([z,T])=>{xo.includes(z)||Tn.has(z)||tr.includes(z)||T&&typeof T=="object"&&h(T)})};h(t);const P=new Map,v=new Set;for(const F of a){const j=`${F.label}::${F.value}`;if(v.has(j))continue;const z=`${F.rawPsetName||"unknown"}::${F.rawPropertyName||"unknown"}::${F.value}`;P.has(z)||(v.add(j),P.set(z,F))}const V=Array.from(P.values());return a.length,V.length,V},ve={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Vn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],El=(t,a)=>{const d=typeof t=="string"?t.trim().toLowerCase():"";if(d&&Vn.some(I=>d.startsWith(I)))return!0;if(a&&typeof a=="object"){const I=Ee(a._category??a.category??a.Category??null),i=typeof I=="string"?I.trim().toLowerCase():"";if(i&&Vn.some(w=>i.startsWith(w))||(a.NominalValue!=null||a.nominalValue!=null)&&(a.Name!=null||a.PropertyName!=null)&&d.includes("property"))return!0}return!1},_n="fragmentsViewer.favoritePropertyPaths",Al=1e4,Rl=500,Oe=t=>{if(!t||typeof t!="object")return;let a,d;typeof t.Name=="string"?a=t.Name:t.Name&&typeof t.Name=="object"&&(a=Ee(t.Name)||void 0),typeof t.name=="string"?d=t.name:t.name&&typeof t.name=="object"&&(d=Ee(t.name)||void 0);const I=a??d;if(!I)return;const i=I.trim();return i.length?i:void 0},er=t=>{if(!t||typeof t!="object")return{rows:[],tree:[]};const a=[],d=new WeakSet,I=(w,x,R)=>{if(w==null)return null;const h=x.map(k=>{const $=k?.trim?.()??k;return typeof $=="string"&&$.length?tt($)||$:typeof k=="string"?k:String(k??"")}),P=h.filter(Boolean).join(" / "),v=R.length?R.join("/"):zt(P||"value"),V=h[h.length-1]??"Value",F=k=>{const $=P.toLowerCase(),q=[$];k&&q.push(k.toLowerCase());const me=q.join(" ").trim()||$,te={label:P,value:k??"",path:v,searchText:me};return a.push(te),me};if(typeof w!="object"||w instanceof Date){const k=De(w),$=F(k);return{id:v,label:V,fullLabel:P,value:k||void 0,children:[],searchText:$}}if(d.has(w)){const k="[Circular reference]",$=F(k);return{id:v,label:V,fullLabel:P,value:k,children:[],searchText:$}}d.add(w);let j;const z=[];if(Array.isArray(w))w.forEach((k,$)=>{const q=Oe(k),me=`${V} ${$+1}`,te=q&&q.trim().length?q.trim():me,J=tt(te)||te,oe=q&&q.trim().length?zt(q):String($),Y=I(k,[...x,J],[...R,oe]);Y&&z.push(Y)}),z.length===0&&(j=De(w));else{if("NominalValue"in w||"nominalValue"in w){const k=w.NominalValue??w.nominalValue,$=Ee(k);$&&(j=$)}!j&&"value"in w&&typeof w.value!="object"&&(j=De(w.value)),!j&&"Value"in w&&typeof w.Value!="object"&&(j=De(w.Value));for(const[k,$]of Object.entries(w)){if($==null||k==="Name"||k==="name"||k==="IsDefinedBy"||k==="isDefinedBy"||k==="psets"||k==="Psets"||k==="propertySets"||k==="PropertySets"||k==="property_sets"||k==="Property_Sets")continue;if(k==="NominalValue"||k==="nominalValue"){const $e=tt("Nominal Value")||"Nominal Value",we=I($,[...x,$e],[...R,"nominal-value"]);we&&z.push(we);continue}const q=On[k]??k,me=tt(q)||q,te=Oe($)?.trim(),J=te&&te.length?tt(te)||te:me,oe=te&&te.length?zt(te):zt(q),Y=[...x,J],U=I($,Y,[...R,oe]);U&&z.push(U)}!j&&z.length===0&&(j=De(w))}const T=F(j);return{id:v,label:V,fullLabel:P,value:j,children:z,searchText:T}},i=[];for(const[w,x]of Object.entries(t)){if(x==null||vl.has(w))continue;const R=On[w]??w,h=I(x,[R],[w]);h&&i.push(h)}if(a.length){const w=a.filter(x=>{const R=x.label.toLowerCase();return R.startsWith("property sets /")?!(R.includes("/ has properties")||R.includes("/ nominal value")):!0});w.length!==a.length&&a.splice(0,a.length,...w)}const b=Qt(t);if(b.length){const w=[],x=new Set;for(const h of b)x.has(h.path)||(x.add(h.path),w.push(h));const R=[];for(const h of a)x.has(h.path)||R.push(h);a.splice(0,a.length,...w,...R)}return{rows:a,tree:i}},Ml=()=>{const t=c.useRef(null),a=c.useRef(null),d=c.useRef(null),I=c.useRef(null),i=c.useRef(null),b=c.useRef(!1),w=c.useRef(null),x=c.useRef(null),R=c.useRef(null),[h,P]=c.useState(!1),[v,V]=c.useState([]),[F,j]=c.useState(!1),[z,T]=c.useState(50);c.useCallback(async(e,o)=>{{console.warn("dumpModelRawData is dev-only.");return}},[v]),c.useCallback(async(e,o=50,s=128)=>{},[]);const[k,$]=c.useState([]),[q,me]=c.useState(null),[te,J]=c.useState(!0),[oe,Y]=c.useState(!1),[U,$e]=c.useState(!1),[we,rt]=c.useState(null),[Ft,qe]=c.useState(!1),[ye,Ke]=c.useState(!1),Nt=c.useRef(null),ot=c.useRef(!1),Fe=c.useRef(null),Ye=c.useRef(null),or=c.useRef(0),be=c.useRef(null),nr=c.useRef(null),$r=c.useRef(new Set);c.useRef(null);const Te=c.useRef(null),sr=c.useRef(!1),Ct=c.useRef(null),Fr=c.useRef("click"),[ir,Un]=c.useState({width:360,height:520}),Nr=c.useRef(null),lr=c.useRef(!1),Lr=c.useRef(null),Co=c.useRef(!1),So=c.useRef(null),ft=c.useRef(null),Or=c.useRef(null),ar=c.useRef(null),Tr=c.useRef(null),Lt=c.useRef(null),jo=c.useRef(null),vo=c.useRef(null),Ae=c.useRef(null),Xe=c.useRef([]),Ve=c.useRef(null),Ot=c.useRef(null),Tt=c.useRef(null),[cr,Re]=c.useState(null),[le,qn]=c.useState([]),[ko,Kn]=c.useState(""),[St,Yn]=c.useState(""),[Ie,Po]=c.useState([]),[pt,Eo]=c.useState("favorites"),[Xn,zl]=c.useState(!1),[Jn,Dl]=c.useState(!1),[Zn,$l]=c.useState(!1),[ht,Qn]=c.useState("models"),[_e,dr]=c.useState(!1),[es,Ao]=c.useState(0),[Be,Vt]=c.useState(!1),[ts,Ro]=c.useState(!1),[rs,Mo]=c.useState(!1),[ge,Vr]=c.useState("disabled"),[Je,_r]=c.useState(""),[_t,ur]=c.useState(""),[Br,zo]=c.useState(!1),[Do,$o]=c.useState(!1),[Fo,jt]=c.useState(null),[xe,No]=c.useState("click"),[vt,Lo]=c.useState(!1),[kt,os]=c.useState(!1),fr=c.useRef(!1),ns=c.useRef(new Map),Oo=c.useRef(null),Ze=c.useRef(!1),To=c.useRef(new Map),Pt=c.useRef(null),[ss,Gr]=c.useState(0),[nt,Vo]=c.useState(!1),[_o,is]=c.useState({}),[Wr,Bo]=c.useState(null),[Bt,Go]=c.useState([]),[ls,Hr]=c.useState(!1),[st,Wo]=c.useState("selected"),[it,pr]=c.useState(""),[mt,Ho]=c.useState(!1),[Uo,hr]=c.useState(null),[Et,Ur]=c.useState(!1),[gt,as]=c.useState(!0),[qr,cs]=c.useState(0),[mr,ds]=c.useState([]),[qo,Ko]=c.useState(""),Qe=c.useRef(null),[ne,gr]=c.useState({x:!1,y:!1,z:!1}),[Ge,Yo]=c.useState({x:0,y:0,z:0}),[Gt,Xo]=c.useState(!1),[Wt,us]=c.useState(!1),Ht=c.useRef(!1),Kr=c.useRef([]),Yr=c.useRef(new Map),yr=c.useRef(null),[Jo,Zo]=c.useState(null),Qo=c.useRef(null),yt=c.useCallback(()=>d.current?.camera??null,[]),Xr=c.useCallback(()=>yt()?.three??null,[yt]);c.useEffect(()=>{Fr.current=xe},[xe]),c.useEffect(()=>{const e=Qo.current;!e||!("mouseButtons"in e)||(xe==="rectangle"?e.mouseButtons={left:0,middle:2,right:0,wheel:16}:e.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),c.useEffect(()=>{try{const e=window.localStorage.getItem(_n);if(!e)return;const o=JSON.parse(e);if(!Array.isArray(o))return;const s=o.filter(n=>typeof n=="string"&&n.trim().length>0);s.length&&Po(s)}catch(e){console.warn("Failed to restore favourites from storage",e)}},[]),c.useEffect(()=>{try{window.localStorage.setItem(_n,JSON.stringify(Ie))}catch(e){console.warn("Failed to persist favourites to storage",e)}},[Ie]);const br=ko.trim(),fs=br.length>0,en=c.useMemo(()=>{const e=br.toLowerCase();return e?le.filter(o=>o.searchText.includes(e)).slice(0,Rl):[]},[br,le]),xr=c.useMemo(()=>{const e=new Map;return le.forEach(o=>e.set(o.path,o)),e},[le]),Jr=c.useMemo(()=>le.slice(0,Al),[le]),tn=Math.max(le.length-Jr.length,0),rn=c.useMemo(()=>new Set(Ie),[Ie]),Zr=c.useMemo(()=>Ie.length?Ie.map(e=>xr.get(e)).filter(e=>!!e):[],[Ie,xr]),Qr=c.useMemo(()=>{if(!Ie.length)return 0;let e=0;for(const o of Ie)xr.has(o)||(e+=1);return e},[Ie,xr]),on=c.useCallback(e=>{Po(o=>o.includes(e)?o.filter(s=>s!==e):[...o,e])},[]),wr=c.useMemo(()=>v.map(e=>`${e.id}:${e.label}`).join("|"),[v]),eo=c.useCallback(e=>{const o=rn.has(e.path);return r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(H,{variant:"body2",sx:{fontWeight:600},children:e.label}),r.jsx(Q,{title:o?"Remove from favourites":"Add to favourites",children:r.jsx("span",{children:r.jsx(X,{size:"small",onClick:()=>on(e.path),color:o?"primary":"default",children:o?r.jsx(qs,{fontSize:"small"}):r.jsx(Ks,{fontSize:"small"})})})})]}),r.jsx(H,{variant:"body2",color:"text.secondary",children:e.value?Sl(e.value,360):"â€”"})]},e.path)},[rn,on]);c.useEffect(()=>{if(!v.length){pr("");return}pr(e=>e&&v.some(o=>o.id===e)?e:v[0].id)},[v]);const nn=c.useCallback(async e=>{const o=i.current;if(!o)return[];const s=o.list.get(e);if(!s)return[];let n=[];try{const p=await s.getLocalIds();Array.isArray(p)?n=p:p&&typeof p[Symbol.iterator]=="function"&&(n=Array.from(p))}catch(p){return console.warn(`Failed to retrieve local IDs for model ${e}`,p),[]}if(!n.length)return[];const l=32,f=[];for(let p=0;p<n.length;p+=l){const g=n.slice(p,p+l);let u=[];try{u=await s.getItemsData(g,ve)}catch(y){console.warn(`Failed to fetch items data for model ${e} chunk starting at ${g[0]}`,y);continue}u.forEach((y,S)=>{const E=g[S];if(y)try{const{rows:A}=er(y);A.forEach(C=>{f.push({path:`localId:${E} / ${C.label}`,value:C.value})})}catch(A){console.warn(`Failed to process properties for model ${e} localId ${E}`,A)}})}return f},[]),sn=c.useCallback(e=>{const o=[];return o.push("Path,Value"),e.forEach(({path:s,value:n})=>{const l=s.replace(/"/g,'""'),f=(n??"").replace(/"/g,'""');o.push(`"${l}","${f}"`)}),o.join(`\r
`)},[]),Ce=c.useCallback(e=>{const o=e??null;me(o);const{rows:s}=er(o);if(qn(s),Eo(Ie.length?"favorites":"all"),s.length){Go(s.map(f=>({path:f.label,value:f.value})));const n="Path	Value",l=s.map(f=>`${f.label}	${f.value??""}`);Bo([n,...l].join(`\r
`))}else Go([]),Bo(null)},[Ie.length]),Se=c.useCallback(async()=>{if(be.current){const e=be.current;e.enabled=!0;try{typeof e.clear=="function"&&await e.clear(),typeof e.create=="function"&&(await new Promise(s=>setTimeout(s,0)),e.list?.has("select")||e.selection?.select||(console.debug('Re-creating missing "select" style in resetViewerTools'),e.create("select")))}catch(o){console.warn("Failed to clear/reset highlighter:",o)}}if(Ae.current)try{await Ae.current.set(!0)}catch(e){console.warn("Failed to reset isolation:",e)}if(fr.current=!1,Lo(!1),Ze.current=!1,Pt.current=null,i.current)try{i.current.resetHighlight(),i.current.core.update(!0)}catch(e){console.warn("Failed to reset fragments highlight:",e)}$([]),Ce(null)},[Ce]),ps=c.useCallback(()=>{hr(null),Wo(le.length?"selected":"model"),v.length&&!v.some(e=>e.id===it)&&pr(v[0].id),Hr(!0)},[le.length,v,it]),hs=c.useCallback(async()=>{if(!q){alert("No element selected");return}try{const e=new WeakSet,o=JSON.stringify(q,(s,n)=>{if(typeof n=="object"&&n!==null){if(e.has(n))return"[Circular Reference]";e.add(n)}return n instanceof Map?`[Map with ${n.size} entries]`:n instanceof Set?`[Set with ${n.size} items]`:n instanceof WeakMap||n instanceof WeakSet?"[WeakMap/WeakSet]":typeof n=="function"?"[Function]":typeof n=="symbol"?"[Symbol]":n},2);await navigator.clipboard.writeText(o),alert("Raw element data copied to clipboard!")}catch(e){console.error("Failed to copy raw data:",e),alert("Failed to copy data to clipboard. See console for details.")}},[q]),ln=c.useCallback(()=>{mt||(Hr(!1),hr(null),Se())},[mt,Se]),ms=c.useCallback(async()=>{if(!mt){Ho(!0),hr(null);try{let e=[];if(st==="selected"){if(!le.length)throw new Error("No properties available for the current selection.");e=le.map(g=>({path:g.label,value:g.value}))}else{if(!it)throw new Error("Select a model to export.");if(e=await nn(it),!e.length)throw new Error("No properties were found for the chosen model.")}const o=sn(e),s=new Blob([o],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),l=document.createElement("a"),f=st==="selected"?"selection":`model-${it}`,p=new Date().toISOString().replace(/[:.]/g,"-");l.href=n,l.download=`fragment-properties-${f}-${p}.csv`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n),Hr(!1)}catch(e){console.warn("Failed to export properties",e),hr(e.message??"Failed to export properties.")}finally{Ho(!1)}}},[sn,it,st,nn,mt,le]),an=c.useCallback(()=>{Vo(e=>!e)},[]),gs=c.useCallback(()=>{dr(!0),Ao(e=>e+1)},[]),ys=c.useCallback(()=>{dr(!1),Se()},[Se]),cn=c.useCallback(()=>{_e?(dr(!1),Se()):(dr(!0),Ao(e=>e+1))},[_e,Se]),bs=c.useCallback(()=>{Ro(!0)},[]),dn=c.useCallback(()=>{Ro(!1),Se()},[Se]),un=c.useCallback(()=>{const e=Bi();e?(Vr(e.provider),_r(e.apiKey),ur(e.model||Er(e.provider))):(Vr("disabled"),_r(""),ur("")),jt(null),Mo(!0)},[]),Ir=c.useCallback(()=>{Mo(!1),zo(!1),jt(null),Se()},[Se]),xs=c.useCallback(()=>{if(ge==="disabled")Gi();else{const e={provider:ge,apiKey:Je,model:_t||Er(ge)};_i(e)}Ir()},[ge,Je,_t,Ir]),ws=c.useCallback(e=>{Vr(e),ur(Er(e)),jt(null)},[]),Is=c.useCallback(async()=>{if(!(!Je||ge==="disabled")){$o(!0),jt(null);try{let e=!1;const o=_t||Er(ge);ge==="gemini"?e=await Ui(Je,o):ge==="openai"&&(e=await Ki(Je,o)),jt(e?"success":"error")}catch{jt("error")}finally{$o(!1)}}},[ge,Je,_t]),Ut=c.useCallback(e=>{if(!e||typeof e!="object")return"IfcProduct";if(e.constructor&&typeof e.constructor.name=="string"&&e.constructor.name.toUpperCase().startsWith("IFC")){const l=e.constructor.name.trim();if(l!=="Object"&&l!=="Array")return l}const o=Ee(e._category??e.category??e.Category??null);if(o&&o.trim().length&&o.toUpperCase().startsWith("IFC"))return o.trim();const s=[e.expressID!==void 0?null:e.type,e.ifcClass,e.IfcClass,e.Type,e.expressType,e.ExpressType,e.entity,e.Entity,e.ifcType,e.IfcType,e?.attributes?.ifcClass,e?.Attributes?.IfcClass];for(const l of s)if(typeof l=="string"&&l.trim().length){const f=l.trim();if(f.toUpperCase().startsWith("IFC")&&!f.toUpperCase().includes("IDENTIFIER")&&!f.toUpperCase().includes("LABEL")&&!f.toUpperCase().includes("TEXT"))return f}const n=ue(e,["ifcclass","ifc type","express type"]);return n&&n.toUpperCase().startsWith("IFC")?n:"IfcProduct"},[]),to=c.useCallback((e,o,s)=>{const n={},l={},f={};Qt(e).forEach(S=>{const E=S.label.split("/").map(_=>_.trim()),A=S.rawPsetName??E[1]??"",C=S.rawPropertyName??E[E.length-1]??"",m=ct(A),M=ct(C);if(!m||!M)return;l[m]||(l[m]={}),M in l[m]||(l[m][M]=S.value);const D=`${m}.${M}`;D in n||(n[D]=S.value)}),n.GlobalId=o,n.ifcClass=s,f.ifcClass=s,f.GlobalId=o,n["Attributes.GlobalId"]=o,n["Attributes.IfcClass"]=s,n["Attributes.ifcClass"]=s;const g=Oe(e);g&&(f.Name=g,n["Attributes.Name"]=g);const u=ue(e,["category","ifccategory"]);u&&(f.Category=u,n["Attributes.Category"]=u);const y=ue(e,["type","typename"]);y&&(f.Type=y,n["Attributes.Type"]=y);for(const[S,E]of Object.entries(e??{})){if(E==null||typeof E!="object"||Array.isArray(E))continue;const A=Ee(E);if(!A)continue;const C=String(S).replace(/^_+/,""),m=`Attributes.${tt(C)}`;if(m in n||(n[m]=A),C in f||(f[C]=A),/guid|globalid|_guid/i.test(S)){const M=String(A).trim();M&&!n.GlobalId&&(n.GlobalId=M,f.GlobalId=M)}}return{flattened:n,psets:l,attributes:f}},[]),ro=c.useCallback(()=>{const e=i.current;return e?`${Array.from(e.list.keys()).sort().join("|")}|${v.length}`:"empty"},[v]),Cs=c.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0)return{signature:"empty",elementCount:0,modelFiles:[]};const o=Array.from(e.list.keys()).sort(),s=v.map(g=>({id:g.id,name:g.label}));let n=0;for(const[g,u]of e.list)try{const y=await u.getLocalIds(),S=Array.isArray(y)?y:y&&typeof y[Symbol.iterator]=="function"?Array.from(y):[];n+=S.length}catch(y){console.error(`âŒ [computeModelSignature] Failed to count elements in model ${g}`,y)}return{signature:[...o,...v.map(g=>`${g.id}:${g.label}`),`count:${n}`].join("|"),elementCount:n,modelFiles:s}},[v]),Cr=c.useCallback(async()=>{const e=i.current;if(!e||e.list.size===0){const n={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Ve.current=n,n}const o=ro();if(Ve.current&&Ve.current.signature===o)return Ve.current;if(Ot.current)return Ot.current;const s=(async()=>{const n=new Map,l=[],f=new Map;for(const[g,u]of e.list){let y=[];try{const E=await u.getLocalIds();Array.isArray(E)?y=E:E&&typeof E[Symbol.iterator]=="function"&&(y=Array.from(E))}catch(E){console.warn(`IDS cache: failed to read local IDs for model ${g}`,E);continue}if(f.set(g,y.slice()),!y.length)continue;const S=48;for(let E=0;E<y.length;E+=S){const A=y.slice(E,E+S);let C=[];try{C=await u.getItemsData(A,ve)}catch(m){console.warn(`IDS cache: failed to fetch items data for model ${g}`,m);continue}C.forEach((m,M)=>{if(!m)return;const D=A[M],_=Ut(m),O=typeof m.GlobalId=="string"&&m.GlobalId.trim()||typeof m.GlobalID=="string"&&m.GlobalID.trim()||ue(m,["globalid","global id","guid"]);if(!O){if(El(_,m))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:g,localId:D,itemData:m});return}const N=O.trim();if(!N.length||n.has(N))return;const{flattened:L,psets:B,attributes:K}=to(m,N,_),Z={GlobalId:N,ifcClass:_,properties:L},W=m;(typeof W.GlobalId!="string"||!W.GlobalId.trim())&&(W.GlobalId=N),n.set(N,{element:Z,modelId:g,localId:D,psets:B,attributes:K,raw:W}),l.push(Z)})}}const p={signature:o,records:n,elements:l,modelLocalIds:f};return Ve.current=p,p})().finally(()=>{Ot.current=null});return Ot.current=s,s},[ro,to,Ut]),At=c.useCallback(async e=>{const o=new Map,s=i.current;if(!s)return console.error("ðŸ” [groupLocalIdsByModel] Fragments not available"),{grouped:o,cache:Ve.current};for(const[n,l]of s.list)try{const f=await l.getLocalIdsByGuids(e),p=[];for(let g=0;g<f.length;g++){const u=f[g];u!==null&&p.push(u)}p.length>0&&o.set(n,p)}catch(f){console.warn(`ðŸ” [groupLocalIdsByModel] Failed for model ${n}:`,f)}return{grouped:o,cache:Ve.current}},[]),lt=$t.useMemo(()=>({listGlobalIds:async()=>(await Cr()).elements.map(o=>o.GlobalId),getSelectedGlobalIds:async()=>{const e=Xe.current;if(!e||e.length===0)return[];const o=i.current;if(!o)return console.warn("ðŸ“ Fragments not available"),[];const s=[];for(const n of e){const l=o.list.get(n.modelId);if(!l){console.warn("ðŸ“ Model not found for item:",n);continue}try{const[f]=await l.getItemsData([n.localId],{attributesDefault:!1});if(f){const p=ue(f,["globalid","global id","guid"]);p&&typeof p=="string"?s.push(p):console.warn("ðŸ“ No GlobalId found in data for item:",n)}}catch(f){console.error("ðŸ“ Error fetching data for item:",n,f)}}return s},getVisibleGlobalIds:async()=>{const e=i.current;if(!e)return console.warn("ðŸ‘ï¸ Fragments not available"),[];const o=[];let s=0,n=0;for(const[l,f]of e.list)try{let p=[];try{const S=await f.getLocalIds();p=Array.isArray(S)?S:S&&typeof S[Symbol.iterator]=="function"?Array.from(S):[],s+=p.length}catch(S){console.error(`ðŸ‘ï¸ Failed to get local IDs for model ${l}:`,S);continue}const g=await f.getItemsByVisibility(!0);n+=g.length;const u=g.length>0?g:p;if(u.length===0)continue;const y=100;for(let S=0;S<u.length;S+=y){const E=u.slice(S,Math.min(S+y,u.length));try{const A=await f.getItemsData(E,{attributesDefault:!1,attributes:["GlobalId"]});for(const C of A){const m=ue(C,["globalid","global id","guid"]);m&&typeof m=="string"&&o.push(m)}}catch(A){console.error(`ðŸ‘ï¸ Error fetching GlobalIds for batch in model ${l}:`,A)}}}catch(p){console.error(`ðŸ‘ï¸ Error getting visible elements from model ${l}:`,p)}return console.log(`ðŸ‘ï¸ getVisibleGlobalIds: Found ${o.length} visible elements (${n} reported visible out of ${s} total)`),o},getElementProps:async e=>{const o=i.current;if(!o)throw new Error("Fragments not available");for(const[s,n]of o.list)try{const f=(await n.getLocalIdsByGuids([e]))[0];if(f!=null){const[p]=await n.getItemsData([f],ve);if(!p){console.warn(`ðŸ” [getElementProps] No data returned for localId ${f}`);continue}const g=Ut(p),u={},y={};Qt(p).forEach(m=>{const M=m.label.split("/").map(L=>L.trim()),D=m.rawPsetName??M[1]??"",_=m.rawPropertyName??M[M.length-1]??"",O=ct(D),N=ct(_);!O||!N||(u[O]||(u[O]={}),N in u[O]||(u[O][N]=m.value))}),y.ifcClass=g,y.GlobalId=e;const E=Oe(p);E&&(y.Name=E);const A=ue(p,["category","ifccategory"]);A&&(y.Category=A);const C=ue(p,["type","typename"]);return C&&(y.Type=C),{ifcClass:g,psets:u,attributes:y}}}catch(l){console.warn(`ðŸ” [getElementProps] Error in model ${s}:`,l);continue}throw console.error(`ðŸ” [getElementProps] Element with GlobalId ${e} not found in any model`),new Error(`Element with GlobalId ${e} is not available.`)},getElementPropsFast:async e=>{const o=Xe.current,s=i.current;if(!s)throw console.error("ðŸ” [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");for(let n=0;n<o.length;n++){const l=o[n],f=s.list.get(l.modelId);if(f)try{const[p]=await f.getItemsData([l.localId],ve);if(p&&ue(p,["globalid","global id","guid"])===e){const u=Ut(p),y={},S={};Qt(p).forEach(M=>{const D=M.label.split("/").map(B=>B.trim()),_=M.rawPsetName??D[1]??"",O=M.rawPropertyName??D[D.length-1]??"",N=ct(_),L=ct(O);!N||!L||(y[N]||(y[N]={}),L in y[N]||(y[N][L]=M.value))}),S.ifcClass=u,S.GlobalId=e;const A=Oe(p);A&&(S.Name=A);const C=ue(p,["category","ifccategory"]);C&&(S.Category=C);const m=ue(p,["type","typename"]);return m&&(S.Type=m),{ifcClass:u,psets:y,attributes:S}}}catch(p){console.error("ðŸ” [getElementPropsFast] Error for item:",l,p)}}return Tt.current.getElementProps(e)},countElements:async()=>(await Cr()).elements.length,iterElements:e=>{const o=Math.max(1,Math.floor(e?.batchSize??500));return{async*[Symbol.asyncIterator](){const s=i.current;if(!s||s.list.size===0){console.warn("âš ï¸ [viewerApi.iterElements] No fragments available");return}let n=[],l=0;for(const[f,p]of s.list){let g=[];try{const y=await p.getLocalIds();g=Array.isArray(y)?y:y&&typeof y[Symbol.iterator]=="function"?Array.from(y):[]}catch(y){console.error(`âŒ [viewerApi.iterElements] Failed to get local IDs for model ${f}`,y);continue}const u=Math.min(500,Math.max(100,o));for(let y=0;y<g.length;y+=u){const S=g.slice(y,y+u);try{const E=await p.getItemsData(S,ve);for(let A=0;A<E.length;A++){const C=E[A];C&&n.push({modelId:f,localId:S[A],data:C})}for(;n.length>=o;){const A=n.splice(0,o);l+=A.length,l%5e3,yield A}}catch(E){console.error(`âŒ [viewerApi.iterElements] Failed to fetch chunk at ${y}`,E)}}}n.length>0&&(l+=n.length,yield n)}}},_iterElementsLegacy:e=>{const o=Math.max(1,Math.floor(e?.batchSize??100));return{async*[Symbol.asyncIterator](){const s=await Cr(),n=Array.from(s.records.values());for(let l=0;l<n.length;l+=o){const f=n.slice(l,l+o).map(p=>({modelId:p.modelId,localId:p.localId,data:{...p.raw,GlobalId:p.element.GlobalId}}));f.length&&(yield f)}}}},buildIdsCache:async()=>{try{return(await Cr()).elements.length}catch(e){throw console.error("viewerApi.buildIdsCache failed",e),e}},getModelSignature:async()=>await Cs(),addToCache:async e=>{const o=i.current;if(!o){console.warn("ðŸ“¦ [addToCache] Fragments not available");return}let s=Ve.current;s||(s={signature:ro(),records:new Map,elements:[],modelLocalIds:new Map},Ve.current=s);const n=Xe.current;for(const l of e){if(s.records.has(l))continue;let f=!1;for(const p of n){const g=o.list.get(p.modelId);if(g)try{const[u]=await g.getItemsData([p.localId],ve);if(u){let y=u._guid||u.GlobalId;if(y&&typeof y=="object"&&(y=y.value||y),y===l){const S=Ut(u),E={};Qt(u).forEach(L=>{const B=L.label.split("/").map(fe=>fe.trim()),K=L.rawPsetName??B[1]??"",Z=L.rawPropertyName??B[B.length-1]??"",W=ct(K),he=ct(Z);!W||!he||(E[W]||(E[W]={}),he in E[W]||(E[W][he]=L.value))});const C={ifcClass:S,GlobalId:l},m=Oe(u);m&&(C.Name=m);const M=ue(u,["category","ifccategory"]);M&&(C.Category=M);const D=ue(u,["type","typename"]);D&&(C.Type=D);const _={GlobalId:l,ifcClass:S,properties:to(u,l,S)},O={element:_,modelId:p.modelId,localId:p.localId,psets:E,attributes:C,raw:u};s.records.set(l,O),s.elements.push(_);const N=s.modelLocalIds.get(p.modelId)||[];N.push(p.localId),s.modelLocalIds.set(p.modelId,N),f=!0;break}}}catch(u){console.debug("ðŸ“¦ [addToCache] Error checking selection item:",u)}}f||console.warn(`ðŸ“¦ [addToCache] Could not find ${l} in selection`)}},color:async(e,o)=>{if(!e.length)return;const s=be.current,n=i.current,l=d.current;if(!s||!b.current||!n||!l)return;let f,p;try{const y=await At(e);f=y.grouped,p=y.cache}catch(y){console.error("ðŸŽ¨ [color] groupLocalIdsByModel failed:",y);return}const g=new Le(o.r,o.g,o.b),u=g.getHex();nr.current||(nr.current=new Map);for(const[y,S]of f){const E=n.list.get(y);if(!(!E||!S.length))try{const A=Array.from(S);if(s.styles&&typeof s.styles.set=="function")try{if(!A||A.length===0){console.debug(`Skipping highlight for model ${y} - no IDs`);continue}const C=`ids-color-${u.toString(16).padStart(6,"0")}`;if($r.current.add(C),s.styles.set(C,{color:g,fillOpacity:1}),typeof s.create=="function")try{(!s.list||!s.list.has(C))&&s.create(C)}catch(m){console.debug("highlighter.create failed:",m)}if(typeof s.select=="function")try{s.select(E,A,C)}catch(m){throw console.debug("highlighter.select failed:",m),m}continue}catch(C){console.debug("styles.set failed:",C)}if(typeof s.add=="function")try{if(s.add(E,A,u),l&&typeof l.update=="function")try{l.update()}catch(C){console.debug("World update failed:",C)}continue}catch(C){console.debug("add failed:",C)}if(typeof s.highlightById=="function")try{await s.highlightById(E,A,u);continue}catch(C){console.debug("highlightById failed:",C)}if(typeof s.highlightByID=="function")try{await s.highlightByID(E,A,u);continue}catch(C){console.debug("highlightByID failed:",C)}console.warn(`âŒ Could not color model ${y} - all highlighter methods failed`)}catch(A){console.error(`Failed to color model ${y}:`,A)}}},clearColors:async()=>{const e=be.current,o=i.current;if(!b.current||!o)return;const s=To.current;if(s.size>0){for(const[n,l]of s){const{color:f,transparent:p,opacity:g}=l;n.transparent=p,n.opacity=g,"color"in n?n.color.setHex(f):n.lodColor.setHex(f),n.needsUpdate=!0}s.clear()}e&&Ze.current&&(e.enabled=!0,Ze.current=!1,Pt.current=null),Pt.current=null,o&&(o.resetHighlight(),o.core.update(!0));try{if(e){if(e.styles&&typeof e.styles.delete=="function")try{e.styles.delete("ghost")}catch(n){console.warn("Failed to clear ghost styles",n)}if(typeof e.clear=="function"&&await Promise.resolve(e.clear()),e.styles&&typeof e.styles.delete=="function")$r.current.forEach(n=>{try{e.styles.delete(n)}catch{}}),$r.current.clear();else if(e.styles&&typeof e.styles.clear=="function"&&(e.styles.clear(),typeof e.create=="function"))try{e.create("select")}catch{}}}catch(n){console.warn("Failed to clear IDS highlights",n)}nr.current&&nr.current.clear();try{const n=Ye.current;if(n&&n.mesh&&n.mesh.instanceColor){const l=new Le(1,1,1);n.mesh.setColorAt(n.index,l),n.mesh.instanceColor.needsUpdate=!0}}catch{}},isolate:async e=>{const o=Ae.current,s=i.current;if(!o||!s||!b.current||(await Promise.resolve(o.set(!0)),!e.length||!b.current))return;const{grouped:n}=await At(e);if(n.size===0){console.warn("isolate: No elements found in cache for isolation");return}const l=new Map;n.forEach((p,g)=>{l.set(g,new Set(p))});const f={};for(const[p,g]of l.entries()){const u=s.list.get(p);if(u)try{let y=[];const S=await u.getLocalIds();Array.isArray(S)?y=S:S&&typeof S[Symbol.iterator]=="function"&&(y=Array.from(S));const E=y.filter(A=>!g.has(A));E.length>0&&(f[p]=new Set(E))}catch(y){console.error("isolate: Failed to get local IDs for model",p,y)}}Object.keys(f).length>0&&await Promise.resolve(o.set(!1,f))},clearIsolation:async()=>{const e=Ae.current;e&&await Promise.resolve(e.set(!0))},ghost:async e=>{const o=i.current,s=be.current;if(console.log(`ðŸŽ­ ghost() called with ${e.length} global IDs`),!o||!b.current||!s){console.warn("ðŸŽ­ ghost() aborted: fragments or highlighter not ready");return}const{grouped:n}=await At(e);if(n.size===0){console.warn("ðŸŽ­ ghost() aborted: no grouped IDs");return}const l={};let f=0;for(const[u,y]of n.entries())l[u]=new Set(y),f+=y.length;console.log(`ðŸŽ­ ghost() applying to ${f} objects across ${n.size} models`),Pt.current=l,s.enabled=!1,Ze.current=!0;const p=[...o.core.models.materials.list.values()],g=To.current;for(const u of p){if(u.userData.customId)continue;let y;"color"in u?y=u.color.getHex():y=u.lodColor.getHex(),g.set(u,{color:y,transparent:u.transparent,opacity:u.opacity}),u.transparent=!0,u.opacity=.05,u.needsUpdate=!0,"color"in u?u.color.setColorName("white"):u.lodColor.setColorName("white")}if(Object.keys(l).length>0)try{o.highlight({customId:"filter-ghost",color:new Le(16750592),renderedFaces:1,opacity:1,transparent:!1},l)}catch{}o.core.update(!0)},getItemsData:async(e,o)=>{const s=i.current;if(!s)return console.error("ðŸ” [getItemsData] Fragments not available"),[];const{grouped:n}=await At(e),l=[];for(const[f,p]of n.entries()){const g=s.list.get(f);if(g)try{const u=await g.getItemsData(Array.from(p),o);l.push(...u)}catch(u){console.error(`ðŸ” [getItemsData] Failed for model ${f}`,u)}}return l},getLoadedCategories:async()=>{const e=i.current;if(!e)return[];const o=["IfcWall","IfcWallStandardCase","IfcSlab","IfcRoof","IfcWindow","IfcDoor","IfcColumn","IfcBeam","IfcStair","IfcStairFlight","IfcRailing","IfcCurtainWall","IfcPlate","IfcMember","IfcBuildingElementProxy","IfcFurnishingElement","IfcFlowTerminal","IfcSpace","IfcDuctSegment","IfcPipeSegment","IfcFlowFitting","IfcFlowController","IfcDiscreteAccessory","IfcSite","IfcBuilding","IfcBuildingStorey","IfcGroup","IfcZone","IfcSystem","IfcDistributionSystem","IfcProject","IfcOpeningElement","IfcAnnotation","IfcGrid","IfcCovering","IfcFooting","IfcPile","IfcRamp","IfcRampFlight","IfcFlowSegment","IfcFlowStorageDevice","IfcFlowMovingDevice","IfcFlowTreatmentDevice","IfcEnergyConversionDevice","IfcCivilElement","IfcGeographicElement","IfcVirtualElement"],s=[];for(const l of o)s.push((async()=>{const f=new RegExp(`^${l}$`,"i");for(const[p,g]of e.list)try{const u=await g.getItemsOfCategories([f]);if(u&&Object.keys(u).length>0&&Object.values(u).some(S=>S&&S.length>0))return l}catch{}return null})());return(await Promise.all(s)).filter(l=>l!==null).sort()},getItemsByCategory:async e=>{const o=i.current;if(!o)return console.error("ðŸ” [getItemsByCategory] Fragments not available"),{};const s={};for(const[n,l]of o.list)try{const f=await l.getItemsOfCategories(e);if(f&&Object.keys(f).length>0){const p=Object.values(f).flat();p.length>0&&(s[n]=p)}}catch(f){console.error(`ðŸ” [getItemsByCategory] Failed for model ${n}`,f)}return s},getItemsDataByModel:async(e,o,s)=>{const n=i.current;if(!n)return console.error("ðŸ” [getItemsDataByModel] Fragments not available"),[];const l=n.list.get(e);if(!l)return console.error(`ðŸ” [getItemsDataByModel] Model ${e} not found`),[];try{return await l.getItemsData(o,s)}catch(f){return console.error(`ðŸ” [getItemsDataByModel] Failed for model ${e}`,f),[]}},fitViewTo:async e=>{if(!e.length)return;const o=d.current,s=i.current;if(!o||!s||!b.current)return;const n=o.camera??null,l=n?.controls??null,f=n?.three??null,{grouped:p}=await At(e),g=new dt;let u=!1;for(const[C,m]of p.entries()){const M=s.list.get(C);if(!M||!M.object)continue;const D=new dt().setFromObject(M.object);D.isEmpty()||(u?g.union(D):(g.copy(D),u=!0))}if(!u)return;const y=new ee,S=new ee;g.getCenter(y),g.getSize(S);const A=(Math.max(S.x,S.y,S.z)||10)*1.5;l?l.setLookAt(y.x+A,y.y+A,y.z+A,y.x,y.y,y.z,!0):f&&(f.position.set(y.x+A,y.y+A,y.z+A),f.lookAt(y))}}),[At]);Tt.current=lt;const fn=c.useCallback(async()=>{if(h)try{if(!lt.getItemsByCategory||!lt.getItemsDataByModel){console.warn("viewerApi missing required methods for level extraction");return}const e=await lt.getItemsByCategory([/IfcBuildingStorey/i]),o=[];for(const[n,l]of Object.entries(e)){if(l.length===0)continue;const f=await lt.getItemsDataByModel(n,l,ve);for(let p=0;p<f.length;p++){const g=f[p];let u=ue(g,["name","label","longname"]);u||(u=Oe(g)),u||(u=`Level ${p+1}`);let y=ue(g,["elevation","z"]);!y&&g.Elevation&&(y=Ee(g.Elevation));const S=ue(g,["globalid","guid","_guid"]);if(S){const E=y?parseFloat(y):0;o.push({name:u,elevation:isNaN(E)?0:E,globalId:S})}}}o.sort((n,l)=>n.elevation-l.elevation);const s=[];if(o.length>0){const n=o[0].elevation;o.forEach(l=>{s.push({name:l.name,elevation:l.elevation-n,originalElevation:l.elevation,globalId:l.globalId})})}if(ds(s),s.length>0&&(Ko(s[0].globalId),Qe.current&&i.current))try{let n=0;for(const[g,u]of i.current.list)if(typeof u.getCoordinates=="function")try{const y=await u.getCoordinates();if(Array.isArray(y)&&y.length>=2){n=y[1];break}}catch{}const f=s[0].originalElevation+n,p=Qe.current.three;p&&p.position&&(p.position.y=f)}catch{}}catch(e){console.error("Failed to extract levels",e)}},[h,lt]);c.useEffect(()=>{h&&fn()},[h,fn]);const Ss=c.useCallback(()=>{Vt(!0),Gr(e=>e+1)},[]),js=c.useCallback(()=>{Vt(!1),Se()},[Se]),pn=c.useCallback(()=>{Be?(Vt(!1),Se()):(Vt(!0),Gr(e=>e+1))},[Be,Se]),vs=c.useCallback(async e=>{try{const{setIdsXmlText:o,runCheck:s}=await Dt(()=>Promise.resolve().then(()=>hl),void 0).then(n=>n.idsStore);o(e),Vt(!0),Gr(n=>n+1),setTimeout(async()=>{Tt.current&&await s(Tt.current)},100)}catch(o){console.error("Failed to validate from IDS Creator:",o),alert("Error: Could not run validation. See console for details.")}},[]);c.useEffect(()=>{Xe.current=k},[k]),c.useEffect(()=>{Ve.current=null,Ot.current=null;try{Wn.invalidateCaches()}catch(e){console.warn("Failed to invalidate IDS caches",e)}},[v]),c.useEffect(()=>{const e=t.current;if(!e)return;let o=!1;Co.current||(xi.init(),wi.init(),Co.current=!0);try{e.replaceChildren()}catch{}const s=new Ii;I.current=s;const l=s.get(Ci).create();l.name="main",l.scene=new Si(s),l.scene.setup(),l.renderer=new ji(s,e);const f=l.renderer.three;f.shadowMap.enabled=!1,f.sortObjects=!1,l.camera=new vi(s),l.camera.controls?.setLookAt(10,10,10,0,0,0),l.camera.three.near=.1,l.camera.three.far=1e9,l.camera.three.updateProjectionMatrix();const p=l.camera.controls;p&&(Qo.current=p,"mouseButtons"in p&&(p.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in p&&(p.dollySpeed=1));const g=new Mi(16777215,1);l.scene.three.add(g),d.current=l;const u=new Ys;u.showPanel(2),u.dom.style.position="absolute",u.dom.style.left="8px",u.dom.style.top="8px",u.dom.style.zIndex="1000",e.appendChild(u.dom),l.renderer.onBeforeUpdate.add(()=>u.begin()),l.renderer.onAfterUpdate.add(()=>u.end());let y=null;const S=async C=>{if(!b.current)return;const m=[];for(const[L,B]of Object.entries(C))B.forEach(K=>{Number.isInteger(K)&&m.push({modelId:L,localId:K})});const M=Xe.current;if(!!bo(m,M))return;$(m),at();const _=i.current;if(!_||!m.length){Ce(null);return}const O=m[0],N=_.list.get(O.modelId);if(!N){Ce(null);return}try{const[L]=await N.getItemsData([O.localId],ve);Ce(L||null)}catch(L){console.warn("Failed to fetch properties for selection",L)}},E=()=>{fr.current||Ze.current||($([]),Ce(null))};return(async()=>{try{await Promise.resolve(s.init())}catch(N){console.error("Failed to initialize viewer components",N);return}if(o)return;try{const L=s.get(ki).create(l);Qe.current=L,L&&(L.visible=!0)}catch(N){console.warn("Failed to create grid component",N)}const m=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),M=URL.createObjectURL(new File([m],"worker.mjs",{type:"text/javascript"}));R.current=M;const D=s.get(Pi);await D.init(M),i.current=D,b.current=!0;const _=s.get(Ei);_.setup({world:l}),_.zoomToSelection=!1;try{typeof _.create=="function"&&_.create("select");let N=0;const L=10;for(;N<L&&(!_.selection||!_.selection.select);)await new Promise(B=>setTimeout(B,20)),N++;(!_.selection||!_.selection.select)&&console.warn("Highlighter selection system still initializing (non-blocking)")}catch(N){console.warn("Error during highlighter initialization:",N)}be.current=_;const O=s.get(Ai);Ae.current=O;try{const N=s.get(Ri);if(N.world=l,N.color=new Le("#ff0000"),"snapDistance"in N&&(N.snapDistance=.5),"preview"in N){const L=N.preview;L&&(L.enabled=!0,L.color&&(L.color=new Le("#00ff00")))}if("workingPlane"in N){const L=N.workingPlane;L&&typeof L=="object"&&(L.visible=!0)}N.list?.onItemAdded&&N.list.onItemAdded.add(L=>{const B=L.value||L.distance?.()||0;Zo(B.toFixed(3)),L.dimensionLabel&&(L.dimensionLabel.visible=!0)}),N.enabled=!1,yr.current=N}catch(N){console.error("Failed to initialize measurement tool:",N)}_.events.select.onHighlight.add(S),_.events.select.onClear.add(E),y=()=>{_.events.select.onHighlight.remove?.(S),_.events.select.onClear.remove?.(E)},yt()?.controls?.addEventListener("rest",()=>D.core.update(!0));try{const L=(await Dt(()=>import("./thatopen-vendor-C9781ij5.js").then(Z=>Z.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new L,K="/Savora-Viewer/";B.wasm={path:`${K}web-ifc/`,absolute:!0},w.current=B}catch(N){console.warn("Failed to lazy-load FRAGS.IfcImporter:",N)}o||Ke(!0)})().catch(C=>{console.error("Failed to initialize viewer fragments",C)}),()=>{o=!0,(async()=>{const C=b.current;b.current=!1,y?.(),y=null;try{C&&await Ae.current?.set?.(!0)}catch{}if(i.current){const m=[...i.current.list.keys()];await Promise.all(m.map(M=>i.current.core.disposeModel(M)))}try{C&&be.current?.clear?.()}catch{}R.current&&URL.revokeObjectURL(R.current);try{s.dispose()}catch{}try{e.replaceChildren()}catch{}be.current=null,Ae.current=null})()}},[]),c.useEffect(()=>{if(!ye)return;const e=I.current,o=i.current;if(!e||!o)return;const s=wr,n=(l,f,p)=>{if(!l)return;let g=f.current;g||(g=p(),f.current=g),g&&g.parentElement!==l&&l.replaceChildren(g)};n(So.current,ft,()=>{const[l,f]=Mn.modelsList({components:e});return Or.current=f,l}),ft.current&&((!ft.current.dataset.initialized||s!==vo.current)&&Or.current?.({components:e}),ft.current.dataset.initialized||(ft.current.dataset.initialized="true",ft.current.style.width="100%")),ar.current!==jo.current&&(Tr.current=null,Lt.current=null,jo.current=ar.current),n(ar.current,Tr,()=>{const[l,f]=Mn.spatialTree({components:e,models:Array.from(o.list.values())});Lt.current=f,l.style.width="100%",l.style.height="100%",l.style.overflow="auto";const p=l;return p.queryString=St.trim()?St.trim():null,l}),Lt.current&&Lt.current({components:e,models:Array.from(o.list.values())}),vo.current=s},[ye,te,St,wr]),c.useEffect(()=>{if(!ye)return;const e=I.current,o=i.current,s=Lt.current;!e||!o||!s||s({components:e,models:Array.from(o.list.values())})},[ye,wr]),c.useEffect(()=>{const e=Tr.current;if(!e)return;const o=St.trim();e.queryString=o||null},[St]);const ks=async()=>{const e=a.current,o=e?.files?.[0];if(!o)return;const s=o.name.split(".").pop()?.toLowerCase(),n=i.current,l=w.current,f=d.current;if(!n||!f){alert("Viewer is still initializing. Please try again in a moment."),e&&(e.value="");return}const p=yt(),g=p?.three??null,u=p?.controls??null;let y=!1;try{const S=`${o.name}-${Date.now()}`;let E;if(s==="ifc"){if(!l)throw new Error("IFC importer is not ready.");console.log("ðŸ”§ Starting IFC conversion:",o.name),rt(0),y=!0,ot.current=!1,qe(!1);const D=new AbortController;Nt.current=D;const _=new Uint8Array(await o.arrayBuffer());console.log("ðŸ”§ IFC file size:",_.byteLength,"bytes");const O=await l.process({bytes:_,progressCallback:(L,B)=>{if(ot.current)return;const K=typeof L=="number"?L:0,Z=K<=1?K*100:K,W=Math.max(0,Math.min(100,Z));rt(Number(W.toFixed(1)))},signal:D.signal});if(console.log("ðŸ”§ IFC conversion complete"),ot.current)throw{__cancelled:!0};let N;if(O instanceof ArrayBuffer){const L=new Uint8Array(O),B=new Uint8Array(L.byteLength);B.set(L),N=B.buffer}else if(O instanceof Uint8Array){const L=new Uint8Array(O.byteLength);L.set(O),N=L.buffer}else{const L=O,B=new Uint8Array(L),K=new Uint8Array(B.byteLength);K.set(B),N=K.buffer}E=await n.core.load(N,{modelId:S})}else if(s==="frag"){const D=await o.arrayBuffer();E=await n.core.load(D,{modelId:S})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}x.current=S,g?E.useCamera(g):console.warn("World camera not ready; skipping model camera binding."),f.scene.three.add(E.object),await n.core.update(!0);const A=be.current;if(A)try{A.enabled=!0,typeof A.update=="function"&&A.update(),typeof A.create=="function"&&(A.list?.has("select")||A.create("select"))}catch(D){console.warn("Failed to update highlighter after load:",D)}await new Promise(D=>requestAnimationFrame(()=>D()));const C=new dt().setFromObject(E.object),m=new ee;C.getCenter(m),(Math.abs(m.x)>1e6||Math.abs(m.y)>1e6||Math.abs(m.z)>1e6)&&(console.log("âš ï¸  Model is georeferenced (far from origin), recentering..."),E.object.position.sub(m),console.log("  - New position:",E.object.position.x.toFixed(3),E.object.position.y.toFixed(3),E.object.position.z.toFixed(3)));try{u&&await u.fitToBox(E.object,!0)}catch{const D=new ee;C.getSize(D);const O=(Math.max(D.x,D.y,D.z)||10)*2.5;u?u.setLookAt(m.x+O,m.y+O,m.z+O,m.x,m.y,m.z,!0):g&&(g.position.set(m.x+O,m.y+O,m.z+O),g.lookAt(m))}is(D=>({...D,[S]:Il(S,o.name,E.object)})),P(!0),V(D=>[...D,{id:S,label:o.name}]),at();const M=I.current;M&&Or.current?.({components:M}),y&&rt(100)}catch(S){S&&(S.__cancelled||S?.name==="AbortError")||(console.error(S),alert("Failed to load model. See console for more details.")),P(!1)}finally{e&&(e.value=""),y&&setTimeout(()=>rt(null),200),Nt.current=null,qe(!1)}},Ps=c.useCallback(()=>{if(we!==null){ot.current=!0,qe(!0);try{Nt.current?.abort()}catch{}rt(null)}},[we]),at=c.useCallback(()=>{J(!0),Y(!1)},[]),hn=c.useCallback(()=>{J(e=>{const o=!e;return o&&Y(!1),o})},[]),Es=c.useCallback(()=>{J(!1)},[]),As=c.useCallback(()=>{Y(e=>!e)},[]),mn=c.useMemo(()=>Math.min(360,Math.max(180,ir.height*.45)),[ir.height]),Rs=+!Jn+ +!Zn,oo=!Xn&&Rs===0;c.useEffect(()=>{const e=ft.current;e&&(e.style.width="100%",e.style.maxHeight=oo?"100%":`${mn}px`,e.style.height=oo?"100%":"auto")},[oo,mn,wr]);const Ms=c.useCallback(async e=>{const o=m=>{const M=[],D=new Set;if(!m||typeof m!="object")return{terms:M,modelIds:D};for(const[_,O]of Object.entries(m)){if(O==null)continue;const N=_.trim().toLowerCase(),L=Array.isArray(O)?O:[O];if(L.length){if(N==="modelid"||N==="modelids"||N==="model"){for(const B of L){const K=typeof B=="string"?B.trim():String(B??"").trim();K&&D.add(K)}continue}if(["text","query","keyword","search"].includes(N)){for(const B of L){if(B==null)continue;const K=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();K&&M.push({type:"text",value:K})}continue}for(const B of L){if(B==null)continue;let K=null;typeof B=="string"?K=B.trim():(typeof B=="number"||typeof B=="boolean")&&(K=String(B)),K&&M.push({type:"field",key:N,value:K.toLowerCase()})}}}return{terms:M,modelIds:D}},s=i.current;if(!s){console.warn("AI selection requested but fragments are unavailable.");return}if(!b.current){console.warn("AI selection requested before fragments were fully initialized.");return}const n=be.current,l=Ae.current,{terms:f,modelIds:p}=o(e.filter),g=e.mode?.toLowerCase?.(),u=g==="isolate"||g==="focus";if(e.action==="clear"){try{n?.clear?.()}catch{}if(l)try{await l.set(!0)}catch(m){console.warn("Failed to reset visibility while clearing AI selection",m)}try{const m=Ye.current;if(m&&m.mesh&&m.mesh.instanceColor){const M=new Le(1,1,1);m.mesh.setColorAt(m.index,M),m.mesh.instanceColor.needsUpdate=!0}}catch{}Ye.current=null,Fe.current&&(Fe.current.visible=!1),$([]),Ce(null);return}if(f.length===0){console.warn("AI selection command did not include usable filters",e);return}const y=++or.current,S=[],E=60;for(const m of s.list.values()){const M=typeof m?.modelId=="string"?m.modelId:"";if(p.size&&!p.has(M))continue;let D=[];try{const O=await m.getLocalIds();Array.isArray(O)?D=O.slice():O&&typeof O[Symbol.iterator]=="function"&&(D=Array.from(O))}catch(O){console.warn("Failed to fetch local IDs for model",M,O)}const _={model:m,modelId:M,allIds:D,matched:new Set};if(S.push(_),!!D.length)for(let O=0;O<D.length;O+=E){if(y!==or.current)return;const N=D.slice(O,O+E);let L=[];try{L=await m.getItemsData(N,ve)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}N.forEach((B,K)=>{const Z=L?.[K];if(!Z)return;let W=[];try{W=er(Z).rows}catch(ae){console.warn("Failed to build property rows for AI selection",ae)}const he=W.map(ae=>ae.searchText),fe=Dr(Z,6e3).toLowerCase();f.every(ae=>{if(ae.type==="text")return he.some(ke=>ke.includes(ae.value))||fe.includes(ae.value);const Me=xl[ae.key]??[ae.key];return he.some(ke=>Me.some(He=>ke.includes(He))&&ke.includes(ae.value))?!0:Me.some(ke=>fe.includes(ke)&&fe.includes(ae.value))})&&_.matched.add(B)})}}if(y!==or.current)return;const A=S.filter(m=>m.matched.size>0);if(!A.length)return;try{const m=Ye.current;if(m&&m.mesh&&m.mesh.instanceColor){const M=new Le(1,1,1);m.mesh.setColorAt(m.index,M),m.mesh.instanceColor.needsUpdate=!0}}catch{}if(Ye.current=null,Fe.current&&(Fe.current.visible=!1),l)try{await l.set(!0)}catch(m){console.warn("Failed to reset hidden state before AI selection",m)}if(n){try{n.clear?.()}catch{}const m=u?16754240:6737151;for(const M of A){const D=Array.from(M.matched);if(D.length)try{typeof n.highlightById=="function"?await n.highlightById(M.model,D,m):typeof n.highlightByID=="function"?await n.highlightByID(M.model,D,m):typeof n.add=="function"&&n.add(M.model,D,m)}catch(_){console.warn("Failed to apply AI highlight for model",M.modelId,_)}}}if(u&&l){const m={};for(const M of S){if(!M.allIds.length||M.matched.size===M.allIds.length)continue;const D=M.allIds.filter(_=>!M.matched.has(_));D.length&&(m[M.modelId]=new Set(D))}if(Object.keys(m).length)try{await l.set(!1,m)}catch(M){console.warn("Failed to isolate AI-selected elements",M)}}const C=A.flatMap(m=>Array.from(m.matched).map(M=>({modelId:m.modelId,localId:M})));$(C),at();try{const m=A[0],M=Array.from(m.matched)[0];if(M!==void 0){const[D]=await m.model.getItemsData([M],ve);y===or.current&&Ce(D||null)}}catch(m){console.warn("Failed to fetch properties for AI selection result",m)}},[at,$,Ce]),Sr=c.useCallback(e=>{if(!lr.current)return;const o=Nr.current;if(!o)return;const s=e.clientX-o.startX,n=e.clientY-o.startY,l=280,f=260;Un(p=>{const g=o.width,u=o.height,y=Math.max(l,g+s),S=Math.max(f,u+n);return y===p.width&&S===p.height?p:{width:Math.round(y),height:Math.round(S)}})},[]),qt=c.useCallback(()=>{lr.current&&(lr.current=!1,Nr.current=null,window.removeEventListener("pointermove",Sr),window.removeEventListener("pointerup",qt))},[Sr]),zs=c.useCallback(e=>{e.preventDefault(),e.stopPropagation();const o=Lr.current;o&&(lr.current=!0,Nr.current={startX:e.clientX,startY:e.clientY,width:o.offsetWidth,height:o.offsetHeight},window.addEventListener("pointermove",Sr),window.addEventListener("pointerup",qt))},[Sr,qt]);c.useEffect(()=>()=>{qt()},[qt]);const Ds=c.useCallback(async()=>{const e=i.current,o=[];if(!e||e.list.size===0||v.length===0)o.push("No models are currently loaded in the viewer.");else{o.push(`Loaded models (${v.length}): ${v.map(n=>`${n.label} [${n.id}]`).join(", ")}`),o.push(`Fragments models in memory: ${e.list.size}`);try{const n=new dt;for(const f of e.list.values())n.expandByObject(f.object);const l=new ee;n.getSize(l),o.push(`Scene bounds approx size => x:${l.x.toFixed(2)} y:${l.y.toFixed(2)} z:${l.z.toFixed(2)}`)}catch(n){console.warn("Failed to compute bounds for AI context",n)}const s=v.map(n=>_o[n.id]).filter(n=>!!n);if(s.length){let n=0;const l=new Map;o.push("Model geometry snapshots:");for(const p of s){n+=p.elementCount;for(const{category:u,count:y}of p.categoryCounts)l.set(u,(l.get(u)??0)+y);const g=p.categoryCounts.slice(0,5).map(({category:u,count:y})=>`${u}: ${y}`);o.push(`- ${p.label} [${p.modelId}] â†’ elementsâ‰ˆ${p.elementCount}, instancedâ‰ˆ${p.instancedCount}, meshesâ‰ˆ${p.meshCount}`),g.length&&o.push(`  top categories: ${g.join(" | ")}`),o.push(`  bbox size (approx): x:${p.bboxSize.x.toFixed(2)} y:${p.bboxSize.y.toFixed(2)} z:${p.bboxSize.z.toFixed(2)}`)}const f=Array.from(l.entries()).sort((p,g)=>g[1]-p[1]).slice(0,10).map(([p,g])=>`${p}: ${g}`);o.push(`Global approx element total: ${n}`),f.length&&o.push(`Global top categories: ${f.join(" | ")}`)}else o.push("Geometry summaries are initializing â€” load a model or wait a moment after loading.")}if(k.length){o.push(`Active selection count: ${k.length}`);for(let s=0;s<k.length;s+=1){const n=k[s];o.push(`Selection #${s+1} â†’ modelId:${n.modelId}, localId:${n.localId}`);let l=null;if(s===0&&q&&Object.keys(q).length)l=q;else if(e){const f=e.list.get(n.modelId);if(f)try{const[p]=await f.getItemsData([n.localId],ve);l=p||null}catch(p){console.warn("Failed to fetch properties for AI context (multi)",p)}}if(l){o.push("  Property snapshot (compact JSON):"),o.push(`  ${Dr(l,4e3)}`);const f=er(l).rows;if(f.length){o.push(`  Flattened properties (${f.length} entries):`);for(const p of f.slice(0,120))o.push(`  - ${p.label}: ${p.value}`);f.length>120&&o.push(`  (Truncated ${f.length-120} additional properties)`)}}else o.push("  Properties for this selection are not available yet.")}}else if(o.push("No active selection â€” exporting properties for every loaded element."),e&&e.list.size)for(const s of v){const n=e.list.get(s.id);if(!n){o.push(`Model ${s.label} [${s.id}] could not be found in the fragments registry.`);continue}try{const l=await n.getLocalIds(),f=Array.isArray(l)?l:l?Array.from(l):[];if(!f||f.length===0){o.push(`Model ${s.label} [${s.id}] has no retrievable local IDs.`);continue}o.push(`Model ${s.label} [${s.id}] â€” enumerating ${f.length} items:`);const p=f.length<=40?12:f.length<=120?6:3,g=50;for(let u=0;u<f.length;u+=g){const y=f.slice(u,u+g);let S=[];try{S=await n.getItemsData(y,ve)}catch(E){const A=y[0],C=y[y.length-1];o.push(`  Failed to retrieve properties for items ${A}â€“${C}: ${E?.message??E}`);continue}y.forEach((E,A)=>{const C=S?.[A];if(!C){o.push(`- localId:${E} (no data available)`);return}const m=jl(C,p).replace(/\s+/g," ").trim();o.push(`- localId:${E} | ${m}`)})}}catch(l){o.push(`Failed to enumerate items for model ${s.label} [${s.id}]: ${l?.message??l}`)}}else o.push("Fragments data is not available to enumerate model items.");if(Bt.length){o.push("ItemsData extracted name/value pairs (last selection):");const s=150,n=Bt.slice(0,s);for(const l of n)o.push(`- ${l.path}: ${l.value}`);Bt.length>s&&o.push(`(Truncated ${Bt.length-s} additional rows)`)}return Wr&&(o.push("ItemsData table snapshot for last selection (tab-separated):"),o.push(Wr)),o.length===0&&o.push("Viewer is idle: no models or selections to describe."),o.join(`
`)},[v,k,q,le,_o,Wr,Bt]),$s=c.useCallback(async()=>{const e=d.current,o=i.current,s=x.current;if(!e||!o||!s||!b.current)return;const n=o.list.get(s);if(!n)return;await o.core.update(!0),await new Promise(p=>requestAnimationFrame(()=>p()));const l=n.object,f=new dt().setFromObject(l);if(!f.isEmpty()){const p=yt(),g=p?.controls??null,u=p?.three??null;try{g&&await g.fitToBox(l,!0)}catch{const S=new ee,E=new ee;f.getCenter(S),f.getSize(E);const C=(Math.max(E.x,E.y,E.z)||10)*2.5;g?g.setLookAt(S.x+C,S.y+C,S.z+C,S.x,S.y,S.z,!0):u&&(u.position.set(S.x+C,S.y+C,S.z+C),u.lookAt(S))}}},[]),Fs=c.useCallback(async()=>{const e=Xe.current,o=Ae.current;if(!e||e.length===0||!o||!b.current){Re(null);return}const s={};for(const n of e)s[n.modelId]||(s[n.modelId]=new Set),s[n.modelId].add(n.localId);try{await o.set(!1,s);try{be.current?.clear?.()}catch{}$([]),Ce(null)}catch(n){console.warn("Failed to hide selected element",n)}finally{Re(null)}},[Re,$,Ce]),Ns=c.useCallback(async()=>{const e=Ae.current;if(!e||!b.current){Re(null);return}try{await e.set(!0)}catch(o){console.warn("Failed to reset hidden items",o)}finally{Re(null)}},[Re]),Ls=c.useCallback(()=>{Re(null)},[Re]);c.useEffect(()=>{const e=t.current,o=d.current;if(!e||!o)return;const s=o.renderer?.three.domElement;if(!s)return;const n=new mo,l=async(C,m,M,D)=>{const _=i.current;if(!_){console.warn("âŒ No fragments manager");return}const O=Xr();if(!O){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const N=s.getBoundingClientRect();new zn;const L=new Map,B=10,K=M-C,Z=D-m;console.log(`Rectangle selection: ${Math.round(K)}x${Math.round(Z)} pixels, models: ${_.list.size}`),console.log(`Filter ghost mode active: ${Ze.current}`);let W=0;for(const ze of _.list.values())try{const re=await ze.getLocalIds(),Ue=Array.isArray(re)?re.length:re&&typeof re[Symbol.iterator]=="function"?Array.from(re).length:0;W+=Ue}catch(re){console.debug("Failed to get object count for model:",re)}if(console.log(`Total objects in models: ${W}`),K<3||Z<3){await f((C+M)/2,(m+D)/2);return}let he=0,fe=0,We=0;const ae=(C+M)/2,Me=(m+D)/2,Kt=(ae-N.left)/N.width*2-1,ke=-((Me-N.top)/N.height)*2+1;console.log(`Testing center point: screen=(${Math.round(ae)}, ${Math.round(Me)}), NDC=(${Kt.toFixed(3)}, ${ke.toFixed(3)})`);for(const ze of _.list.values())try{const re=await ze.raycast({camera:O,mouse:new mo(Kt,ke),dom:s});re&&typeof re.distance=="number"?console.log(`âœ“ Center point HIT! distance=${re.distance.toFixed(2)}, localId=${re.localId}`):console.log(`âœ— Center point MISS (hit=${!!re})`)}catch(re){console.log("âœ— Center point ERROR:",re)}let He=!0;for(let ze=C;ze<=M;ze+=B)for(let re=m;re<=D;re+=B){he++;const Ue=(ze-N.left)/N.width*2-1,gn=-((re-N.top)/N.height)*2+1;n.set(Ue,gn);for(const jr of _.list.values())try{const vr=new mo(Ue,gn),lo=await jr.raycast({camera:O,mouse:vr,dom:s});if(lo&&typeof lo.distance=="number"){fe++;const kr=lo.localId;kr!=null&&Number.isInteger(kr)&&(L.has(jr.modelId)||L.set(jr.modelId,new Set),L.get(jr.modelId).add(kr))}}catch(vr){We++,He&&console.warn("âŒ Raycast error on first sample:",vr),console.debug("Skipping model due to raycast error:",vr)}He&&(He=!1)}const Ne=[];for(const[ze,re]of L.entries())for(const Ue of re)Ne.push({modelId:ze,localId:Ue});if(Ne.length===0){console.warn(`âš ï¸ No objects found in rectangle (sampled ${he} points, ${fe} hits, ${We} errors)`),console.log(`Rectangle bounds: left=${Math.round(C)}, top=${Math.round(m)}, right=${Math.round(M)}, bottom=${Math.round(D)}`),console.log(`Canvas rect: ${Math.round(N.left)}, ${Math.round(N.top)}, ${Math.round(N.width)}x${Math.round(N.height)}`),$([]),Ce(null);return}console.log(`âœ“ Rectangle selection found ${Ne.length} objects from ${fe} hits`);const io=Xe.current;if(!bo(Ne,io)&&($(Ne),at(),Ne.length>0)){const ze=Ne[0],re=_.list.get(ze.modelId);if(re)try{const[Ue]=await re.getItemsData([ze.localId],ve);Ce(Ue||null)}catch(Ue){console.warn("Failed to fetch properties for rectangle selection",Ue)}}},f=async(C,m)=>{const M=i.current;if(!M)return;const D=Xr();if(!D){console.warn("Picking skipped: viewer camera not ready.");return}const _=s.getBoundingClientRect();n.x=(C-_.left)/_.width*2-1,n.y=-((m-_.top)/_.height)*2+1;let O=null;const N=new zn;N.setFromCamera(n,D);for(const Z of M.list.values())try{const W=await Z.raycast({camera:D,mouse:n,dom:o.renderer.three.domElement});if(W&&typeof W.distance=="number"){const he=W.point instanceof ee?W.point.clone():N.ray.at(W.distance,new ee);(!O||W.distance<O.dist)&&(O={dist:W.distance,model:Z,localId:W.localId,point:he,object:W.object,instanceId:W.instanceId})}}catch{}if(!O)return;const L=be.current;if(L&&L.enabled!==!1)try{typeof L.clear=="function"&&!fr.current&&!Ze.current&&L.clear();const Z=6737151,W=L.selection&&L.selection.select;if(!L.onBeforeHighlight||!W)return;typeof L.highlightByID=="function"?await L.highlightByID(O.model.uuid,[O.localId],Z):typeof L.add=="function"?L.add(O.model.uuid,[O.localId]):typeof L.highlight=="function"&&await L.highlight(O.model,[O.localId],Z)}catch(Z){console.warn("Highlighter failed, using fallback:",Z);try{const W=O.object,he=O.instanceId;if(W&&W.isInstancedMesh&&Number.isInteger(he)){const fe=Ye.current;if(fe&&fe.mesh&&fe.mesh.instanceColor){const Me=new Le(1,1,1);try{fe.mesh.setColorAt(fe.index,Me),fe.mesh.instanceColor.needsUpdate=!0}catch{}}const We=W,ae=new Le(6737151);try{We.setColorAt(he,ae),We.instanceColor.needsUpdate=!0}catch{}Ye.current={mesh:We,index:he}}}catch{}}try{const Z=O.point??new ee;let W=Fe.current;if(!W){W=new zi;const We=new dt,ae=i.current;if(ae&&ae.list.size)for(const io of ae.list.values())We.expandByObject(io.object);const Me=new Di;We.getBoundingSphere(Me);const Kt=isFinite(Me.radius)&&Me.radius>0?Me.radius*.01:.3,ke=Math.max(.05,Math.min(2,Kt)),He=new Dn(new $i(ke*.5,16,16),new $n({color:16763904,depthTest:!1})),Ne=new Dn(new Fi(ke*.8,ke,32),new $n({color:16772744,side:Ni,depthTest:!1,transparent:!0,opacity:.9}));Ne.rotation.x=Math.PI/2,He.renderOrder=999,Ne.renderOrder=999,W.add(He),W.add(Ne),o.scene.three.add(W),Fe.current=W}W.position.copy(Z);const he=W.children[1],fe=Xr();fe&&he.lookAt(fe.position),W.visible=!0}catch{}const B=Xe.current,K=[{modelId:O.model.modelId,localId:O.localId}];if(!bo(K,B)){$(K),at();try{const[Z]=await O.model.getItemsData([O.localId],ve);Ce(Z||null)}catch{}}},p=async C=>{if(Re(null),C.button===0)if(Fr.current==="rectangle"&&!Ht.current){if(sr.current=!0,Ct.current={x:C.clientX,y:C.clientY},!Te.current){const M=document.createElement("div");M.style.position="fixed",M.style.border="2px solid #1976d2",M.style.backgroundColor="rgba(25, 118, 210, 0.1)",M.style.pointerEvents="none",M.style.zIndex="10000",document.body.appendChild(M),Te.current=M}const m=Te.current;m.style.left=`${C.clientX}px`,m.style.top=`${C.clientY}px`,m.style.width="0px",m.style.height="0px",m.style.display="block"}else await f(C.clientX,C.clientY)},g=C=>{if(!sr.current||!Ct.current||!Te.current)return;const m=Ct.current,M=Te.current,D=Math.min(C.clientX,m.x),_=Math.min(C.clientY,m.y),O=Math.abs(C.clientX-m.x),N=Math.abs(C.clientY-m.y);M.style.left=`${D}px`,M.style.top=`${_}px`,M.style.width=`${O}px`,M.style.height=`${N}px`},u=async C=>{if(sr.current&&Ct.current&&Te.current){const m=Ct.current,M=Te.current;M.style.display="none",sr.current=!1;const D=Math.min(C.clientX,m.x),_=Math.min(C.clientY,m.y),O=Math.max(C.clientX,m.x),N=Math.max(C.clientY,m.y);await l(D,_,O,N),Ct.current=null}},y=async C=>{Re(null),!Ht.current&&Fr.current==="click"&&await f(C.clientX,C.clientY)},S=()=>{if(Ht.current){const C=yr.current;C&&typeof C.create=="function"&&C.create()}},E=C=>{C.preventDefault();const m=Xe.current;if(!m||m.length===0){Re(null);return}Re({mouseX:C.clientX+2,mouseY:C.clientY-6})},A=C=>{if(Ht.current&&(C.code==="Delete"||C.code==="Backspace")){const m=yr.current;m&&typeof m.delete=="function"&&m.delete()}};return s.addEventListener("pointerdown",p,{capture:!0}),s.addEventListener("pointermove",g),s.addEventListener("pointerup",u),s.addEventListener("click",y),s.addEventListener("dblclick",S),s.addEventListener("contextmenu",E),window.addEventListener("keydown",A),()=>{s.removeEventListener("pointerdown",p,{capture:!0}),s.removeEventListener("pointermove",g),s.removeEventListener("pointerup",u),s.removeEventListener("click",y),s.removeEventListener("dblclick",S),s.removeEventListener("contextmenu",E),window.removeEventListener("keydown",A),Te.current&&(Te.current.remove(),Te.current=null);try{const C=Fe.current;C&&(o.scene.three.remove(C),C.traverse(m=>{if(m.geometry&&m.geometry.dispose?.(),m.material){const M=Array.isArray(m.material)?m.material:[m.material];for(const D of M)D?.dispose?.()}}),Fe.current=null)}catch{}try{const C=Ye.current;if(C&&C.mesh&&C.mesh.instanceColor){const m=new Le(1,1,1);C.mesh.setColorAt(C.index,m),C.mesh.instanceColor.needsUpdate=!0}Ye.current=null}catch{}}},[]);const Os=c.useCallback(()=>{d.current;const e=yt(),o=e?.controls??null,s=e?.three??null;o?o.reset(!0):s&&(s.position.set(10,10,10),s.lookAt(0,0,0))},[]),no=c.useCallback(e=>{gr(o=>{const s={...o,[e]:!o[e]},n=d.current;if(!n)return s;const l=n.renderer?.three,f=n.scene?.three;if(!l||!f)return s;const p=[],g=Yr.current;if(!s[e]){const u=g.get(e);u&&(f.remove(u),u.dispose(),g.delete(e))}if(s.x){const u=new Mt(new ee(1,0,0),Ge.x);if(p.push(u),!g.has("x")){const y=new go(u,10,16711680);f.add(y),g.set("x",y)}}if(s.y){const u=new Mt(new ee(0,1,0),Ge.y);if(p.push(u),!g.has("y")){const y=new go(u,10,65280);f.add(y),g.set("y",y)}}if(s.z){const u=new Mt(new ee(0,0,1),Ge.z);if(p.push(u),!g.has("z")){const y=new go(u,10,255);f.add(y),g.set("z",y)}}return l.clippingPlanes=p,l.localClippingEnabled=p.length>0,Kr.current=p,s})},[Ge]),so=c.useCallback((e,o)=>{Yo(s=>{const n={...s,[e]:o};return requestAnimationFrame(()=>{const f=d.current;if(!f)return;const p=f.renderer?.three;if(!p)return;const g=[],u=Yr.current;if(ne.x){const y=new Mt(new ee(1,0,0),n.x);g.push(y);const S=u.get("x");S&&(S.plane.constant=n.x)}if(ne.y){const y=new Mt(new ee(0,1,0),n.y);g.push(y);const S=u.get("y");S&&(S.plane.constant=n.y)}if(ne.z){const y=new Mt(new ee(0,0,1),n.z);g.push(y);const S=u.get("z");S&&(S.plane.constant=n.z)}p.clippingPlanes=g,Kr.current=g}),n})},[ne]),Ts=c.useCallback(()=>{Xo(e=>{const o=!e;return gr(o?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),o})},[]),Vs=c.useCallback(()=>{us(e=>{const o=!e;Ht.current=o;const s=yr.current;if(s){if(s.enabled=o,!o)try{s.list&&typeof s.list.clear=="function"&&s.list.clear(),Zo(null)}catch(n){console.warn("Failed to clear measurements:",n)}}else console.warn("âš ï¸ Measurement tool not initialized!");return o})},[]),_s=c.useCallback(()=>{Lo(e=>{const o=!e;fr.current=o;const s=i.current,n=be.current,l=ns.current;if(!s)return e;try{if(o){if(!n)return e;const f=n.selection?.select||{};Oo.current=f,n.enabled=!1;const p=[...s.core.models.materials.list.values()];for(const g of p){if(g.userData.customId)continue;let u;"color"in g?u=g.color.getHex():u=g.lodColor.getHex(),l.set(g,{color:u,transparent:g.transparent,opacity:g.opacity}),g.transparent=!0,g.opacity=.05,g.needsUpdate=!0,"color"in g?g.color.setColorName("white"):g.lodColor.setColorName("white")}if(Object.keys(f).length>0)try{s.highlight({customId:"ghost-selected",color:new Le(16750592),renderedFaces:1,opacity:1,transparent:!1},f)}catch(g){console.warn("Failed to apply ghost highlight:",g)}s.core.update(!0)}else{for(const[f,p]of l){const{color:g,transparent:u,opacity:y}=p;f.transparent=u,f.opacity=y,"color"in f?f.color.setHex(g):f.lodColor.setHex(g),f.needsUpdate=!0}l.clear(),n&&(n.enabled=!0),Oo.current=null,s.resetHighlight(),s.core.update(!0)}}catch(f){return console.warn("Failed to toggle ghost mode:",f),e}return o})},[]),Bs=c.useCallback(()=>{os(e=>{const o=!e,s=Ae.current,n=be.current;if(!s)return console.warn("âš ï¸ Hider not available for isolate mode"),e;try{if(o){const l=n?.selection?.select||{},f={};for(const[p,g]of Object.entries(l))g&&typeof g.size=="number"&&g.size>0&&(f[p]=g);if(Object.keys(f).length>0)s.isolate(f);else return console.warn("âš ï¸ No selection to isolate"),e}else s.set(!0)}catch(l){return console.warn("Failed to toggle isolate mode:",l),e}return o})},[]),Gs=c.useCallback(async()=>{const e=i.current,o=be.current,s=Ae.current;if(!e||!b.current){console.warn("Fragments not ready");return}if(!o){console.warn("Highlighter not available");return}try{let n={},l=0;const f=Ze.current,p=Pt.current!==null;if(console.log(`Filter state: ghostMode=${f}, hasSelection=${p}`),f&&p){if(n=Pt.current,l=Object.values(n).reduce((S,E)=>S+E.size,0),l===0){console.warn("No filtered objects found. Try using the Model Filter first.");return}console.log(`Selecting ${l} filtered objects (ghost mode)`)}else if(s&&s.list&&s.list.size>0){console.log(`Checking for hidden objects in ${e.list.size} models`);for(const[S,E]of e.list)try{let A=[];const C=await E.getLocalIds();if(Array.isArray(C)?A=C:C&&typeof C[Symbol.iterator]=="function"&&(A=Array.from(C)),A.length===0)continue;const m=s.list?.get?.(S),M=m&&m.size>0?m:new Set,D=A.filter(_=>!M.has(_));D.length>0&&(n[S]=new Set(D),l+=D.length),console.log(`Model ${S}: ${D.length} visible of ${A.length} total (${M.size} hidden)`)}catch(A){console.error("Failed to get IDs for model",S,A)}if(l===0){console.warn("No visible objects found (all are hidden)");return}console.log(`Selecting ${l} visible objects (isolate/hide mode)`)}else{for(const[S,E]of e.list)try{let A=[];const C=await E.getLocalIds();if(Array.isArray(C)?A=C:C&&typeof C[Symbol.iterator]=="function"&&(A=Array.from(C)),A.length===0)continue;let m=new Set;if(s)try{const D=s.list?.get?.(S);D&&D.size>0&&(m=D)}catch(D){console.debug("Could not get hidden IDs for model",S,D)}const M=A.filter(D=>!m.has(D));M.length>0&&(n[S]=new Set(M),l+=M.length)}catch(A){console.error("Failed to get IDs for model",S,A)}if(l===0){console.warn("No visible objects found");return}console.log(`Selecting ${l} visible objects`)}if(!Ze.current&&typeof o.clear=="function")try{o.clear()}catch(S){console.debug("Failed to clear highlighter:",S)}let g=0,u=0;for(const[S,E]of Object.entries(n))try{if(o.selection&&o.selection.select){o.selection.select[S]||(o.selection.select[S]=new Set);const A=o.selection.select[S];E.forEach(C=>A.add(C)),g++}else u++}catch(A){console.debug("Failed to add objects to selection for model",S,A),u++}if(o.events&&o.events.select)try{const S=o.events.select;if(S.onHighlight&&typeof S.onHighlight.trigger=="function"){const E={};for(const[A,C]of Object.entries(n))E[A]=C;S.onHighlight.trigger(E)}}catch(S){console.debug("Failed to trigger highlight event:",S)}const y=[];for(const[S,E]of Object.entries(n))E.forEach(A=>{y.push({modelId:S,localId:A})});$(y),at(),u>0?console.log(`âœ“ Selected ${l} visible objects (${g} models highlighted, ${u} failed)`):console.log(`âœ“ Selected ${l} visible objects from ${g} models`)}catch(n){console.error("Failed to select visible objects:",n)}},[$,at]),Ws=c.useCallback(()=>{gr({x:!1,y:!1,z:!1}),Yo({x:0,y:0,z:0}),Xo(!1);const e=d.current;if(e){const o=e.renderer?.three,s=e.scene?.three;if(o&&(o.clippingPlanes=[],o.localClippingEnabled=!1),s){const n=Yr.current;n.forEach(l=>{s.remove(l),l.dispose()}),n.clear()}}Kr.current=[]},[]),bt=c.useCallback(e=>{const o=d.current,s=i.current,n=x.current,l=yt(),f=l?.three;if(!f||!o||!s||!n)return;const p=s.list.get(n);if(!p)return;const g=new dt().setFromObject(p.object);if(g.isEmpty())return;const u=new ee,y=new ee;g.getCenter(u),g.getSize(y);const E=Math.max(y.x,y.y,y.z)*2||20;let A;switch(e){case"top":A=new ee(u.x,u.y,u.z+E);break;case"bottom":A=new ee(u.x,u.y,u.z-E);break;case"front":A=new ee(u.x,u.y+E,u.z);break;case"back":A=new ee(u.x,u.y-E,u.z);break;case"left":A=new ee(u.x-E,u.y,u.z);break;case"right":A=new ee(u.x+E,u.y,u.z);break;case"iso":A=new ee(u.x+E*.7,u.y+E*.7,u.z+E*.7);break;default:return}const C=l?.controls;C&&typeof C.setLookAt=="function"?C.setLookAt(A.x,A.y,A.z,u.x,u.y,u.z,!0):(f.position.copy(A),f.lookAt(u),f.updateProjectionMatrix())},[]);return r.jsxs("div",{style:{width:"100%",height:"100%"},children:[r.jsx(Xs,{position:"static",children:r.jsxs(Js,{children:[r.jsx(G,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(G,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:r.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),r.jsx(H,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),r.jsx(Q,{title:"Settings",children:r.jsx(X,{color:"inherit",onClick:un,sx:{mr:1},children:r.jsx(Zs,{})})}),r.jsx(Q,{title:"About",children:r.jsx(X,{color:"inherit",onClick:bs,sx:{mr:1},children:r.jsx(Qs,{})})}),r.jsx(ie,{color:"inherit",onClick:hn,startIcon:r.jsx(yn,{}),"aria-pressed":te,sx:{mr:1,borderRadius:1.5,backgroundColor:te?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:te?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:te?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),r.jsx(ie,{color:"inherit",onClick:cn,startIcon:r.jsx(bn,{}),"aria-pressed":_e,sx:{mr:1,borderRadius:1.5,backgroundColor:_e?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:_e?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:_e?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),r.jsx(ie,{color:"inherit",onClick:pn,startIcon:r.jsx(xn,{}),"aria-pressed":Be,sx:{mr:1,borderRadius:1.5,backgroundColor:Be?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Be?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Be?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),r.jsx(ie,{color:"inherit",onClick:an,startIcon:r.jsx(wn,{}),"aria-pressed":nt,sx:{mr:1,borderRadius:1.5,backgroundColor:nt?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:nt?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:nt?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),r.jsx("div",{ref:t,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:we!==null&&r.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:r.jsxs(je,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[r.jsx(H,{variant:"subtitle1",sx:{mb:1},children:"Converting IFCâ€¦"}),r.jsx(ei,{variant:"determinate",value:Math.max(0,Math.min(100,we)),sx:{height:10,borderRadius:1}}),r.jsxs(H,{variant:"caption",sx:{mt:1,display:"block"},children:[we.toFixed(1),"%"]}),r.jsx("div",{style:{marginTop:12},children:r.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:Ps,disabled:Ft,children:Ft?"Cancellingâ€¦":"Cancel"})})]})})}),te&&r.jsx(In,{nodeRef:Lr,handle:".explorer-header",bounds:"parent",children:r.jsxs(je,{ref:Lr,elevation:8,sx:{position:"fixed",top:120,right:30,width:ir.width,height:oe?"auto":ir.height,minWidth:280,minHeight:oe?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[r.jsxs(G,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[r.jsx(H,{variant:"subtitle1",children:"Model Explorer"}),r.jsxs(G,{children:[r.jsx(X,{size:"small",color:"inherit",onClick:As,title:oe?"Expand panel":"Minimize panel",children:oe?r.jsx(ti,{}):r.jsx(Cn,{})}),r.jsx(X,{size:"small",color:"inherit",onClick:Es,title:"Close Model Explorer",children:r.jsx(Sn,{})})]})]}),!oe&&r.jsxs(G,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[r.jsx(ie,{variant:"contained",size:"small",onClick:()=>a.current?.click(),disabled:!ye,children:"Open IFC / FRAG"}),r.jsx(Q,{title:"Open parametric filter",children:r.jsx("span",{children:r.jsx(ie,{variant:"outlined",size:"small",onClick:()=>$e(!0),disabled:!ye,startIcon:r.jsx(ri,{}),children:"Filter"})})}),!1,r.jsx(H,{variant:"caption",color:"text.secondary"}),r.jsx("input",{ref:a,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:ks})]}),r.jsxs(jn,{value:ht,onChange:(e,o)=>Qn(o),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[r.jsx(Yt,{value:"models",label:"Models"}),r.jsx(Yt,{value:"properties",label:"Properties"}),r.jsx(Yt,{value:"tree",label:"Model Tree"})]}),r.jsx(G,{role:"tabpanel",hidden:ht!=="models",sx:{display:ht==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:r.jsx(G,{ref:So,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!ye&&r.jsx(H,{variant:"body2",color:"text.secondary",children:"Initializing componentsâ€¦"})})}),r.jsx(G,{role:"tabpanel",hidden:ht!=="properties",sx:{display:ht==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsxs(jn,{value:pt,onChange:(e,o)=>Eo(o),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[r.jsx(Yt,{value:"favorites",label:`Favourites (${Zr.length})`}),r.jsx(Yt,{value:"all",label:`All (${le.length})`})]}),r.jsxs(G,{role:"tabpanel",hidden:pt!=="favorites",sx:{display:pt==="favorites"?"flex":"none",flexDirection:"column",flex:pt==="favorites"?1:0,minHeight:0},children:[Zr.length?r.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Zr.map(eo)})}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(H,{variant:"body2",color:"text.secondary",children:Ie.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Qr>0&&Ie.length>0&&r.jsx(Rt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Qr===1?"1 favourite property is not available for this selection.":`${Qr} favourite properties are not available for this selection.`})]}),r.jsxs(G,{role:"tabpanel",hidden:pt!=="all",sx:{display:pt==="all"?"flex":"none",flexDirection:"column",flex:pt==="all"?1:0,minHeight:0},children:[r.jsxs(G,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[r.jsx(Xt,{size:"small",fullWidth:!0,value:ko,onChange:e=>Kn(e.target.value),placeholder:"Search propertiesâ€¦",disabled:!le.length}),r.jsx(Q,{title:"Copy raw element JSON",children:r.jsx("span",{children:r.jsx(X,{size:"small",onClick:hs,disabled:!q,color:"primary",children:r.jsx(oi,{fontSize:"small"})})})}),r.jsx(Q,{title:"Export properties",children:r.jsx("span",{children:r.jsx(ie,{variant:"outlined",size:"small",startIcon:r.jsx(ni,{}),onClick:ps,disabled:!le.length&&!v.length,children:"Export"})})})]}),le.length?fs?en.length?r.jsx(G,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:en.map(eo)})}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(H,{variant:"body2",color:"text.secondary",children:`No properties matched "${br}".`})}):r.jsxs(G,{sx:{position:"relative",flex:1,minHeight:200},children:[r.jsx(je,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Jr.map(eo)}),tn>0&&r.jsx(Rt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${Jr.length} properties. ${tn} more not shown.`})]}):r.jsx(je,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(H,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Setsâ€¦ breakdown."})})]})]})}),r.jsx(G,{role:"tabpanel",hidden:ht!=="tree",sx:{display:ht==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsx(Xt,{size:"small",fullWidth:!0,value:St,onChange:e=>Yn(e.target.value),placeholder:"Search the model treeâ€¦",disabled:!v.length,sx:{flexShrink:0}}),r.jsxs(G,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[r.jsx(G,{ref:ar,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!ye||!v.length)&&r.jsx(G,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:r.jsx(H,{variant:"body2",color:"text.secondary",children:ye?"Load a model to populate the full model tree.":"Viewer is initializing the model treeâ€¦"})})]})]})})]}),r.jsx(G,{onPointerDown:zs,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:te?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:hn,title:te?"Close Model Explorer":"Open Model Explorer",sx:{color:te?"white":"inherit"},children:r.jsx(yn,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:_e?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:cn,title:_e?"Close AI Assistant":"Open AI Assistant",sx:{color:_e?"white":"inherit"},children:r.jsx(bn,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Be?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:pn,title:Be?"Close IDS Checker":"Open IDS Checker",sx:{color:Be?"white":"inherit"},children:r.jsx(xn,{})})}),r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:nt?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(X,{onClick:an,title:nt?"Close IDS Creator":"Open IDS Creator",sx:{color:nt?"white":"inherit"},children:r.jsx(wn,{})})}),Et?r.jsx(In,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:r.jsxs(je,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[r.jsxs(G,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[r.jsx(H,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(X,{size:"small",onClick:()=>Ur(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(Cn,{fontSize:"small"})}),r.jsx(X,{size:"small",onClick:()=>Ur(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(Sn,{fontSize:"small"})})]})]}),r.jsxs(G,{sx:{p:1.5},children:[r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:$s,disabled:!h,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(vn,{fontSize:"small"})})}),r.jsx(Q,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Os,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:r.jsx(si,{fontSize:"small"})})})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),r.jsxs(G,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[r.jsx(Q,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),r.jsx(Q,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),r.jsx(Q,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),r.jsx(Q,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),r.jsx(Q,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),r.jsx(Q,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>bt("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),r.jsx(Q,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:r.jsxs(ie,{size:"small",onClick:()=>bt("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[r.jsx(ii,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>no("x"),sx:{border:"2px solid",borderColor:ne.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.x?"error.main":"white",color:ne.x?"white":"error.main","&:hover":{backgroundColor:ne.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:r.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),r.jsx(Q,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>no("y"),sx:{border:"2px solid",borderColor:ne.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.y?"success.main":"white",color:ne.y?"white":"success.main","&:hover":{backgroundColor:ne.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),r.jsx(Q,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>no("z"),sx:{border:"2px solid",borderColor:ne.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:ne.z?"primary.main":"white",color:ne.z?"white":"primary.main","&:hover":{backgroundColor:ne.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:r.jsx(H,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),ne.x&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(H,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",Ge.x.toFixed(1)]}),r.jsx(ao,{value:Ge.x,onChange:(e,o)=>so("x",o),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),ne.y&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(H,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",Ge.y.toFixed(1)]}),r.jsx(ao,{value:Ge.y,onChange:(e,o)=>so("y",o),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),ne.z&&r.jsxs(G,{sx:{mt:1},children:[r.jsxs(H,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",Ge.z.toFixed(1)]}),r.jsx(ao,{value:Ge.z,onChange:(e,o)=>so("z",o),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Ts,sx:{border:"2px solid",borderColor:Gt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Gt?"warning.main":"white",color:Gt?"white":"warning.dark","&:hover":{backgroundColor:Gt?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:r.jsx(li,{fontSize:"small"})})}),r.jsx(Q,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Ws,disabled:!ne.x&&!ne.y&&!ne.z&&!Gt,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(ai,{fontSize:"small"})})})]}),r.jsxs(G,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[r.jsx(Q,{title:Wt?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Vs,sx:{border:"2px solid",borderColor:Wt?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Wt?"success.main":"white",color:Wt?"white":"success.dark","&:hover":{backgroundColor:Wt?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(ci,{fontSize:"small"})})}),Jo&&r.jsxs(H,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[Jo," units"]})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),r.jsxs(G,{sx:{display:"flex",gap:.5},children:[r.jsx(Q,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>No("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:r.jsx(di,{fontSize:"small"})})}),r.jsx(Q,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:()=>No("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:r.jsx(kn,{fontSize:"small"})})}),r.jsx(Q,{title:vt?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:_s,sx:{border:"2px solid",borderColor:vt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:vt?"warning.main":"white",color:vt?"white":"warning.dark","&:hover":{backgroundColor:vt?"warning.dark":"warning.light",borderColor:"warning.main",color:vt?"white":"warning.dark"}},children:r.jsx(Pn,{fontSize:"small"})})}),r.jsx(Q,{title:kt?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Bs,sx:{border:"2px solid",borderColor:kt?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:kt?"info.main":"white",color:kt?"white":"info.dark","&:hover":{backgroundColor:kt?"info.dark":"info.light",borderColor:"info.main",color:kt?"white":"info.dark"}},children:r.jsx(En,{fontSize:"small"})})}),r.jsx(Q,{title:"Select all visible objects",PopperProps:{sx:{zIndex:9999}},children:r.jsx(X,{size:"small",onClick:Gs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white",color:"success.main","&:hover":{backgroundColor:"success.light",borderColor:"success.main",color:"success.dark"}},children:r.jsx(kn,{fontSize:"small"})})})]}),xe==="rectangle"&&r.jsx(Rt,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]}),r.jsxs(G,{sx:{mt:.5},children:[r.jsx(H,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Grid Settings"}),r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:1},children:[r.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:r.jsx(Q,{title:gt?"Hide Grid":"Show Grid",children:r.jsx(X,{size:"small",onClick:()=>{const e=!gt;as(e),Qe.current&&(Qe.current.visible=e)},sx:{border:"1px solid",borderColor:gt?"primary.main":"rgba(0,0,0,0.23)",bgcolor:gt?"primary.main":"white",color:gt?"white":"primary.main","&:hover":{bgcolor:gt?"primary.dark":"rgba(0,0,0,0.04)"}},children:gt?r.jsx(ui,{fontSize:"small"}):r.jsx(fi,{fontSize:"small"})})})}),r.jsxs(G,{sx:{px:1},children:[r.jsxs(H,{variant:"caption",sx:{color:"text.secondary",fontSize:"0.7rem"},children:["Offset: ",qr.toFixed(2),"m"]}),r.jsx(G,{sx:{display:"flex",alignItems:"center",gap:1},children:r.jsx("input",{type:"range",min:"-5",max:"5",step:"0.1",value:qr,onChange:async e=>{const o=parseFloat(e.target.value);cs(o);const s=mr.find(n=>n.globalId===qo);if(s&&Qe.current&&i.current){let n=0;for(const[p,g]of i.current.list)if(typeof g.getCoordinates=="function")try{const u=await g.getCoordinates();if(Array.isArray(u)&&u.length>=2){n=u[1];break}}catch{}const l=s.originalElevation+n+o,f=Qe.current.three;f&&f.position&&(f.position.y=l)}},style:{width:"100%",cursor:"pointer"}})})]}),mr.length>0&&r.jsxs(co,{size:"small",fullWidth:!0,children:[r.jsx(pi,{id:"grid-level-select-label",sx:{fontSize:"0.75rem"},children:"Align to Level"}),r.jsx(hi,{labelId:"grid-level-select-label",value:qo,label:"Align to Level",onChange:async e=>{const o=e.target.value;Ko(o);const s=mr.find(n=>n.globalId===o);if(s&&Qe.current&&i.current){let n=0;for(const[p,g]of i.current.list)if(typeof g.getCoordinates=="function")try{const u=await g.getCoordinates();if(Array.isArray(u)&&u.length>=2){n=u[1];break}}catch{}const l=s.originalElevation+n+qr,f=Qe.current.three;f&&f.position&&(f.position.y=l)}},sx:{fontSize:"0.75rem",height:"32px",".MuiSelect-select":{py:.5}},children:mr.map(e=>r.jsxs(Pr,{value:e.globalId,sx:{fontSize:"0.75rem"},children:[e.name," (",e.elevation.toFixed(2),"m)"]},e.globalId))})]})]})]})]})," "]})}):null,r.jsx(je,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:Et?"primary.main":"background.paper","&:hover":{bgcolor:Et?"primary.dark":"action.hover"}},children:r.jsx(X,{onClick:()=>Ur(!Et),title:Et?"Close View Controls":"Open View Controls",sx:{color:Et?"white":"action.active"},children:r.jsx(vn,{})})}),r.jsx(c.Suspense,{fallback:null,children:U&&r.jsx(bl,{open:U,onClose:()=>$e(!1),viewerApi:Tt.current??null})}),r.jsxs(uo,{open:rs,onClose:Ir,fullWidth:!0,maxWidth:"sm",children:[r.jsx(fo,{children:"Settings"}),r.jsx(po,{dividers:!0,children:r.jsxs(G,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[r.jsxs(co,{component:"fieldset",children:[r.jsx(An,{component:"legend",sx:{mb:1},children:"AI Provider"}),r.jsxs(Rn,{value:ge,onChange:e=>ws(e.target.value),children:[r.jsx(Jt,{value:"gemini",control:r.jsx(Zt,{}),label:"Google Gemini"}),r.jsx(Jt,{value:"openai",control:r.jsx(Zt,{}),label:"OpenAI (ChatGPT)"}),r.jsx(Jt,{value:"disabled",control:r.jsx(Zt,{}),label:"Disabled (No AI)"})]})]}),ge!=="disabled"&&r.jsxs(r.Fragment,{children:[r.jsx(Xt,{label:"API Key",type:Br?"text":"password",value:Je,onChange:e=>_r(e.target.value),fullWidth:!0,placeholder:`Enter your ${ge==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:r.jsx(X,{onClick:()=>zo(!Br),edge:"end",size:"small",children:Br?r.jsx(Pn,{}):r.jsx(En,{})})},helperText:ge==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),r.jsx(Xt,{select:!0,label:"Model",value:_t,onChange:e=>ur(e.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:Wi(ge).map(e=>r.jsx("option",{value:e,children:e},e))}),r.jsxs(G,{sx:{display:"flex",gap:1,alignItems:"center"},children:[r.jsx(ie,{variant:"outlined",onClick:Is,disabled:!Je||Do,size:"small",children:Do?"Testing...":"Test Connection"}),Fo==="success"&&r.jsx(H,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ“ Connection successful"}),Fo==="error"&&r.jsx(H,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ— Connection failed"})]}),r.jsx(Rt,{severity:"info",variant:"outlined",children:r.jsxs(H,{variant:"body2",children:[r.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",ge==="gemini"?"Google":"OpenAI","."]})})]})]})}),r.jsxs(ho,{children:[r.jsx(ie,{onClick:Ir,children:"Cancel"}),r.jsx(ie,{onClick:xs,variant:"contained",color:"primary",disabled:ge!=="disabled"&&!Je,children:"Save"})]})]}),r.jsxs(uo,{open:ts,onClose:dn,fullWidth:!0,maxWidth:"md",children:[r.jsx(fo,{children:"About Savora Viewer"}),r.jsxs(po,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[r.jsx(H,{variant:"h6",gutterBottom:!0,children:"Version 0.2.3 Preview"}),r.jsxs(H,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",r.jsx("br",{}),"For bug reporting and more information, visit our ",r.jsx(mi,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",r.jsx("br",{}),r.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),r.jsx(H,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Multiple format support (IFC, Fragments)",r.jsx("br",{}),"â€¢ Pan, zoom, rotate navigation",r.jsx("br",{}),"â€¢ Selection via point-and-click or rectangular region",r.jsx("br",{}),"â€¢ Orthogonal projection for accurate measurements",r.jsx("br",{}),"â€¢ View management (zoom to fit, home, cube orientation)",r.jsx("br",{}),"â€¢ Toggle performance stats",r.jsx("br",{}),"â€¢ Object measurement tools",r.jsx("br",{}),"â€¢ Clipping planes for sectional views"]}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Spatial and classification hierarchy navigation",r.jsx("br",{}),"â€¢ Tree-based model structure view",r.jsx("br",{}),"â€¢ Properties panel with expand/collapse",r.jsx("br",{}),"â€¢ Search and filter functionality",r.jsx("br",{}),"â€¢ Property export (CSV, JSON)",r.jsx("br",{}),"â€¢ Favorites system for quick access",r.jsx("br",{}),"â€¢ Parametric filtering with Ghost/Isolate modes"]}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Validate models against Information Delivery Specification (IDS)",r.jsx("br",{}),"â€¢ Load IDS files from local storage",r.jsx("br",{}),"â€¢ Visual feedback: green (pass) and red (fail) indicators",r.jsx("br",{}),"â€¢ Filter models by validation results",r.jsx("br",{}),"â€¢ Export validation reports"]}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Visual authoring tool for IDS specifications",r.jsx("br",{}),"â€¢ Capture and define validation rules",r.jsx("br",{}),"â€¢ Property picker for easy specification setup",r.jsx("br",{}),"â€¢ Save and load IDS files",r.jsx("br",{}),"â€¢ Integration with IDS Checker for immediate validation"]}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Natural language queries about model contents",r.jsx("br",{}),"â€¢ Intelligent model analysis and insights",r.jsx("br",{}),"â€¢ Context-aware responses based on selected elements",r.jsx("br",{}),"â€¢ Interactive chat interface",r.jsx("br",{}),"â€¢ Selection and filtering via conversation"]}),r.jsx(H,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),r.jsxs(H,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Floating toolbar for model operations",r.jsx("br",{}),"â€¢ Tooltips and keyboard shortcuts",r.jsx("br",{}),"â€¢ Collapsible side panels",r.jsx("br",{}),"â€¢ Responsive layout",r.jsx("br",{}),"â€¢ Dark theme optimized for long viewing sessions"]})]}),r.jsx(ho,{children:r.jsx(ie,{onClick:dn,color:"primary",children:"Close"})})]}),r.jsxs(uo,{open:ls,onClose:ln,fullWidth:!0,maxWidth:"sm",children:[r.jsx(fo,{children:"Export properties"}),r.jsxs(po,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(co,{component:"fieldset",variant:"standard",children:[r.jsx(An,{component:"legend",children:"Scope"}),r.jsxs(Rn,{value:st,onChange:e=>Wo(e.target.value),children:[r.jsx(Jt,{value:"selected",control:r.jsx(Zt,{}),label:"Selected items",disabled:!le.length}),r.jsx(Jt,{value:"model",control:r.jsx(Zt,{}),label:"Specific model",disabled:!v.length})]})]}),r.jsx(gi,{in:st==="model",unmountOnExit:!0,children:r.jsx(Xt,{select:!0,fullWidth:!0,label:"Model",value:it,onChange:e=>pr(e.target.value),disabled:!v.length,children:v.map(e=>r.jsx(Pr,{value:e.id,children:e.label},e.id))})}),st==="selected"&&!le.length&&r.jsx(Rt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),Uo&&r.jsx(Rt,{severity:"error",variant:"outlined",children:Uo})]}),r.jsxs(ho,{children:[r.jsx(ie,{onClick:ln,disabled:mt,children:"Cancel"}),r.jsx(ie,{variant:"contained",onClick:ms,disabled:mt||st==="selected"&&!le.length||st==="model"&&!it,children:mt?"Exportingâ€¦":"Export CSV"})]})]}),r.jsxs(c.Suspense,{fallback:null,children:[r.jsx(gl,{isOpen:Be,onOpen:Ss,onClose:js,viewerApi:lt,hasModel:v.length>0,expandSignal:ss}),r.jsx(yl,{isOpen:nt,onClose:()=>Vo(!1),viewerApi:lt,selectedItemData:q,onValidate:vs}),r.jsx(ml,{getModelDataForAI:Ds,isOpen:_e,onOpen:gs,onClose:ys,expandSignal:es,onRequestSelection:Ms,onOpenSettings:un})]}),r.jsxs(yi,{open:!!cr,onClose:Ls,anchorReference:"anchorPosition",anchorPosition:cr?{top:cr.mouseY,left:cr.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[r.jsx(Pr,{onClick:Fs,disabled:k.length===0,children:"Hide selected element"}),r.jsx(Pr,{onClick:Ns,children:"Reset hidden elements"})]})]})};function Dr(t,a=2e3){try{if(t==null)return"null";const d=typeof t=="string"?t:JSON.stringify(t,null,2);return d?d.length<=a?d:`${d.slice(0,a)}
... [truncated ${d.length-a} chars]`:""}catch{return String(t)}}bi.createRoot(document.getElementById("root")).render(r.jsx($t.StrictMode,{children:r.jsx(Ml,{})}));export{qi as a,ul as b,Vl as g,yo as i,Bi as l,Tl as p,Hi as s,pl as u};
