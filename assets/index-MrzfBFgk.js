const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ChatWindow-CX7HP66O.js","assets/vendor-NpE_gqg9.js","assets/thatopen-vendor-byvyd1e5.js","assets/three-vendor-kQcUiZz9.js","assets/IdsPanel-BcAMz20I.js","assets/IdsCreatorPanel-CnbUtyrw.js","assets/ModelFilterPanel-CLBWtdAD.js"])))=>i.map(i=>d[i]);
import{ck as js,cl as vs,cm as c,cn as Et,co as r,cp as W,cq as U,cr as te,cs as ee,ct as ks,cu as Ps,cv as Es,cw as As,cx as Rs,cy as zs,cz as Ms,cA as ie,cB as Jo,cC as Zo,cD as Qo,cE as en,cF as Ce,cG as Ds,cH as tn,cI as Ns,cJ as rn,cK as on,cL as Ts,cM as nn,cN as _t,cO as jt,cP as Bt,cQ as $s,cR as Fs,cS as sn,cT as Os,cU as Ls,cV as Yr,cW as Vs,cX as _s,cY as Bs,cZ as Gs,c_ as Ws,c$ as ln,d0 as an,d1 as Xr,d2 as Jr,d3 as Zr,d4 as cn,d5 as dn,d6 as un,d7 as Gt,d8 as Wt,d9 as Qr,da as Us,db as Hs,dc as eo,dd as qs,de as Ks}from"./vendor-NpE_gqg9.js";import{l as Ys,_ as Xs,C as Js,W as Zs,S as Qs,a as ei,O as ti,G as ri,F as oi,t as ni,H as si,Y as ii,$ as fn}from"./thatopen-vendor-byvyd1e5.js";import{B as rt,V as J,C as De,a3 as li,c as pn,P as vt,a6 as to,l as mn,G as ai,S as ci,h as hn,$ as di,y as gn,ab as ui,D as fi}from"./three-vendor-kQcUiZz9.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const l of document.querySelectorAll('link[rel="modulepreload"]'))x(l);new MutationObserver(l=>{for(const p of l)if(p.type==="childList")for(const b of p.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&x(b)}).observe(document,{childList:!0,subtree:!0});function a(l){const p={};return l.integrity&&(p.integrity=l.integrity),l.referrerPolicy&&(p.referrerPolicy=l.referrerPolicy),l.crossOrigin==="use-credentials"?p.credentials="include":l.crossOrigin==="anonymous"?p.credentials="omit":p.credentials="same-origin",p}function x(l){if(l.ep)return;l.ep=!0;const p=a(l);fetch(l.href,p)}})();const pi="modulepreload",mi=function(e){return"/Savora-Viewer/"+e},yn={},Pt=function(s,a,x){let l=Promise.resolve();if(a&&a.length>0){let E=function(f){return Promise.all(f.map(k=>Promise.resolve(k).then(j=>({status:"fulfilled",value:j}),j=>({status:"rejected",reason:j}))))};document.getElementsByTagName("link");const b=document.querySelector("meta[property=csp-nonce]"),m=b?.nonce||b?.getAttribute("nonce");l=E(a.map(f=>{if(f=mi(f),f in yn)return;yn[f]=!0;const k=f.endsWith(".css"),j=k?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${f}"]${j}`))return;const O=document.createElement("link");if(O.rel=k?"stylesheet":pi,k||(O.as="script"),O.crossOrigin="",O.href=f,m&&O.setAttribute("nonce",m),document.head.appendChild(O),k)return new Promise((D,C)=>{O.addEventListener("load",D),O.addEventListener("error",()=>C(new Error(`Unable to preload CSS for ${f}`)))})}))}function p(b){const m=new Event("vite:preloadError",{cancelable:!0});if(m.payload=b,window.dispatchEvent(m),!m.defaultPrevented)throw b}return l.then(b=>{for(const m of b||[])m.status==="rejected"&&p(m.reason);return s().catch(p)})},io="bim_viewer_api_config",hi=e=>{try{return btoa(e)}catch{return e}},gi=e=>{try{return atob(e)}catch{return e}},yi=e=>{const s={...e,apiKey:hi(e.apiKey)};localStorage.setItem(io,JSON.stringify(s))},bi=()=>{const e=localStorage.getItem(io);if(!e)return null;try{const s=JSON.parse(e);return{...s,apiKey:gi(s.apiKey)}}catch{return null}},xi=()=>{localStorage.removeItem(io)},wi=e=>{switch(e){case"gemini":return["gemini-2.5-flash","gemini-2.0-flash-exp","gemini-1.5-flash","gemini-1.5-pro","gemini-pro"];case"openai":return["gpt-5o-mini","gpt-4o","gpt-4o-mini","gpt-4-turbo","gpt-3.5-turbo"];default:return[]}},hr=e=>{switch(e){case"gemini":return"gemini-2.5-flash";case"openai":return"gpt-4o-mini";default:return""}},Ii=async(e,s,a="gemini-2.5-flash")=>{const x=`https://generativelanguage.googleapis.com/v1beta/models/${a}:generateContent?key=${e}`,l=await fetch(x,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:s}]}]})});if(!l.ok){const b=await l.json().catch(()=>({}));throw new Error(b.error?.message||`Gemini API error: ${l.status} ${l.statusText}`)}const p=await l.json();if(!p.candidates||p.candidates.length===0)throw new Error("No response from Gemini API");return p.candidates[0].content.parts[0].text},Ci=async(e,s="gemini-2.0-flash-exp")=>{try{return await Ii(e,"Hello, respond with OK",s),!0}catch{return!1}},Si=async(e,s,a="gpt-4o-mini")=>{const l=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({model:a,messages:[{role:"user",content:s}]})});if(!l.ok){const b=await l.json().catch(()=>({}));throw new Error(b.error?.message||`OpenAI API error: ${l.status} ${l.statusText}`)}const p=await l.json();if(!p.choices||p.choices.length===0)throw new Error("No response from OpenAI API");return p.choices[0].message.content},ji=async(e,s="gpt-4o-mini")=>{try{return await Si(e,"Hello, respond with OK",s),!0}catch{return!1}},vi="fragments-ids",se="elements-v5",de="cache-metadata-v1",ki=6,Se=()=>new Promise((e,s)=>{const a=indexedDB.open(vi,ki);a.onerror=()=>s(a.error??new Error("IndexedDB open failed")),a.onupgradeneeded=()=>{const x=a.result;["elements-v1","elements-v2","elements-v3","elements-v4"].forEach(p=>{x.objectStoreNames.contains(p)&&x.deleteObjectStore(p)}),x.objectStoreNames.contains(se)||x.createObjectStore(se),x.objectStoreNames.contains(de)||x.createObjectStore(de)},a.onsuccess=()=>e(a.result)}),ro={async get(e){const s=await Se();return new Promise((a,x)=>{const b=s.transaction(se,"readonly").objectStore(se).get(e);b.onsuccess=()=>a(b.result??null),b.onerror=()=>x(b.error??new Error("IndexedDB get failed"))})},async set(e,s){const a=await Se();await new Promise((x,l)=>{const p=a.transaction([se,de],"readwrite"),b=p.objectStore(se),m=p.objectStore(de),E=b.put(s,e),f={modelKey:e,timestamp:Date.now(),elementCount:s.length,version:"1.0"};m.put(f,e),E.onsuccess=()=>x(),E.onerror=()=>l(E.error??new Error("IndexedDB set failed"))})},async append(e,s){if(!s||!s.length)return;const a=await Se();await new Promise((x,l)=>{const p=a.transaction([se,de],"readwrite"),b=p.objectStore(se),m=p.objectStore(de),E=b.get(e);E.onsuccess=()=>{const k=(E.result??[]).concat(s),j=b.put(k,e),O={modelKey:e,timestamp:Date.now(),elementCount:k.length,version:"1.0"};m.put(O,e),j.onsuccess=()=>x(),j.onerror=()=>l(j.error??new Error("IndexedDB append put failed"))},E.onerror=()=>l(E.error??new Error("IndexedDB append get failed"))})},async writePart(e,s,a){const x=`${e}::part::${String(s).padStart(6,"0")}`,l=`${e}::partindex::${String(s).padStart(6,"0")}`,p=await Se();await new Promise((b,m)=>{const E=p.transaction([se,de],"readwrite"),f=E.objectStore(se),k=E.objectStore(de),j=f.put(a,x);j.onsuccess=()=>{const O=k.get(e);O.onsuccess=()=>{const D=O.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};D.timestamp=Date.now(),D.elementCount=(D.elementCount||0)+a.length;const C=Array.isArray(D.partKeys)?D.partKeys.slice():[];C.includes(x)||C.push(x),D.partKeys=C,k.put(D,e);try{const A=a.map(v=>v.GlobalId).filter(Boolean),F=f.put(A,l);F.onsuccess=()=>{},F.onerror=()=>{}}catch{}b()},O.onerror=()=>b()},j.onerror=()=>m(j.error??new Error("IndexedDB writePart failed"))})},async getPersistedIds(e){const s=await this.getPartKeys(e);if(!s||!s.length)return new Set;const a=await Se(),x=new Set;return await new Promise(l=>{const b=a.transaction(se,"readonly").objectStore(se);let m=s.length;s.forEach(E=>{const f=E.replace("::part::","::partindex::"),k=b.get(f);k.onsuccess=()=>{const j=k.result??[];for(const O of j)typeof O=="string"&&O&&x.add(O);m-=1,m===0&&l()},k.onerror=()=>{m-=1,m===0&&l()}})}),x},async getPartKeys(e){const s=await this.getMetadata(e);return Array.isArray(s?.partKeys)?s.partKeys:[]},async listParts(e){return(await this.getPartKeys(e)).slice().sort()},async readAllParts(e){const s=await Se(),a=await this.getPartKeys(e);return a.length?new Promise((x,l)=>{const b=s.transaction(se,"readonly").objectStore(se),m=[];let E=a.length;a.forEach(f=>{const k=b.get(f);k.onsuccess=()=>{const j=k.result??[];m.push(...j),E-=1,E===0&&x(m)},k.onerror=()=>{E-=1,E===0&&x(m)}})}):[]},async removeParts(e){const s=await Se(),a=`${e}::part::`,l=(await this.keys()).filter(p=>p.startsWith(a));l.length&&await new Promise((p,b)=>{const m=s.transaction([se,de],"readwrite"),E=m.objectStore(se),f=m.objectStore(de);l.forEach(k=>E.delete(k)),f.delete(e),m.oncomplete=()=>p(),m.onerror=()=>b(m.error??new Error("IndexedDB removeParts failed"))})},async getMetadata(e){const s=await Se();return new Promise((a,x)=>{const b=s.transaction(de,"readonly").objectStore(de).get(e);b.onsuccess=()=>a(b.result??null),b.onerror=()=>x(b.error??new Error("IndexedDB metadata get failed"))})},async remove(e){const s=await Se();await new Promise((a,x)=>{const l=s.transaction([se,de],"readwrite"),p=l.objectStore(se),b=l.objectStore(de);p.delete(e),b.delete(e),l.oncomplete=()=>a(),l.onerror=()=>x(l.error??new Error("IndexedDB delete failed"))})},async keys(){const e=await Se();return new Promise((s,a)=>{const p=e.transaction(se,"readonly").objectStore(se).getAllKeys();p.onsuccess=()=>s(p.result??[]),p.onerror=()=>a(p.error??new Error("IndexedDB keys failed"))})},async getAllMetadata(){const e=await Se();return new Promise((s,a)=>{const p=e.transaction(de,"readonly").objectStore(de).getAll();p.onsuccess=()=>s(p.result??[]),p.onerror=()=>a(p.error??new Error("IndexedDB getAllMetadata failed"))})},async clearOldCache(e=720*60*60*1e3){const s=await Se(),a=await this.getAllMetadata(),x=Date.now(),l=a.filter(p=>x-p.timestamp>e).map(p=>p.modelKey);l.length>0&&await new Promise((p,b)=>{const m=s.transaction([se,de],"readwrite"),E=m.objectStore(se),f=m.objectStore(de);l.forEach(k=>{E.delete(k),f.delete(k)}),m.oncomplete=()=>{p()},m.onerror=()=>b(m.error??new Error("IndexedDB cleanup failed"))})},async isSignatureValid(e,s){const a=await this.getMetadata(e);return!a||!a.modelSignature?!1:a.modelSignature===s},async updateSignature(e,s,a){const x=await Se();await new Promise((l,p)=>{const m=x.transaction(de,"readwrite").objectStore(de),E=m.get(e);E.onsuccess=()=>{const f=E.result??{modelKey:e,timestamp:Date.now(),elementCount:0,version:"1.0"};f.modelSignature=s,f.modelFiles=a,f.timestamp=Date.now();const k=m.put(f,e);k.onsuccess=()=>l(),k.onerror=()=>p(k.error??new Error("IndexedDB updateSignature failed"))},E.onerror=()=>p(E.error??new Error("IndexedDB updateSignature get failed"))})}},Pi=async e=>{const s=new TextEncoder,a=`${e.modelUrl}|${e.extra??""}`,x=s.encode(a),l=await crypto.subtle.digest("SHA-256",x),p=new Uint8Array(l);return btoa(String.fromCharCode(...p)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/u,"")},jn={ignoreAttributes:!1,attributeNamePrefix:"@_",cdataPropName:"__cdata",processEntities:!0,htmlEntities:!0,suppressEmptyNode:!0,preserveOrder:!1,format:!0},Ue=e=>e==null?[]:Array.isArray(e)?e:[e],bn=e=>{if(e==null)return[];if(typeof e=="string")try{const s=JSON.parse(e);return Array.isArray(s)?s:[]}catch{return[]}if(typeof e=="object"){const s=e;if(typeof s.__cdata=="string")try{const a=JSON.parse(s.__cdata);return Array.isArray(a)?a:[]}catch{return[]}if(Array.isArray(s.item))return s.item;if(s.item!=null)return[s.item];if(Array.isArray(s.Rule))return s.Rule;if(s.Rule!=null)return[s.Rule]}return Array.isArray(e)?e:[]},ml=e=>{if(!e||typeof e!="string")return[];const s=new vs(jn);let a={};try{a=s.parse(e)}catch(f){return console.warn("IDS adapter: failed to parse XML, returning empty specification list",f),[]}const x=a?.IdsCreator??a?.idsCreator??a?.IDS_CREATOR??a?.Ids??a,l=x?.Specification??x?.specification??x?.Specifications??x?.specifications??null;if(l){const f=Ue(l);if(f.length)return f.map((k,j)=>{const O=k?.["@_id"]?.trim?.()||`spec-${j+1}`,D=(k?.Name??k?.name??"")?.toString?.()??"",C=(k?.Description??k?.description??"")?.toString?.()??"",A=bn(k?.Applicability??k?.applicability),F=bn(k?.Requirements??k?.requirements);return{id:O,name:D,description:C,applicability:A,requirements:F}})}const p=f=>{if(!f||typeof f!="object")return[];for(const[k,j]of Object.entries(f)){const O=String(k).toLowerCase();if(O.endsWith(":specification")||O==="specification"||O==="ids:specification")return Ue(j)}for(const k of Object.values(f))if(k&&typeof k=="object"){const j=p(k);if(j&&j.length)return j}return[]},b=p(a);if(!b.length)return[];const m=f=>{if(!f)return null;if(typeof f=="string")return f;if(typeof f=="object")for(const k of Object.keys(f)){const j=k.toLowerCase();if(j.includes("simplevalue")||j==="#text"||j==="value"){const O=f[k];if(typeof O=="string")return O;if(typeof O=="object"&&(O?.value||O?.Value))return String(O.value??O.Value)}}return null};return b.map((f,k)=>{const j=f?.["@_id"]?.trim?.()||`spec-${k+1}`,O=f?.["@_name"]??f?.name??f?.Name??"",D=String(O??""),C="",A=[],F=[],v=f?.applicability??f?.Applicability??f?.["ids:applicability"]??null,M=Ue(v);for(const X of M){let re=null;const K=[X];for(;K.length&&!re;){const H=K.shift();if(!H)continue;const Ae=m(H);if(Ae){re=Ae;break}if(typeof H=="object")for(const we of Object.values(H))we&&typeof we=="object"&&K.push(we)}re&&A.push({entity:re})}const q=f?.requirements??f?.Requirements??f?.["ids:requirements"]??null,ge=Ue(q),Z=X=>{const re=[],K=[];if(X?.property&&K.push(...Ue(X.property)),X?.Property&&K.push(...Ue(X.Property)),Array.isArray(X)&&K.push(...X),!K.length&&typeof X=="object")for(const H of Object.values(X))H&&typeof H=="object"&&K.push(H);for(const H of K){const Ae=H?.propertySet??H?.PropertySet??H?.["ids:propertySet"]??H?.propertySet,we=H?.baseName??H?.BaseName??H?.["ids:baseName"]??H?.baseName,qe=m(Ae)||m(H?.propertySet?.simpleValue)||m(H?.propertySet?.["ids:simpleValue"]),At=m(we)||m(H?.baseName?.simpleValue)||m(H?.baseName?.["ids:simpleValue"]),Oe=[],be=H?.allowedValues??H?.AllowedValues??H?.["ids:allowedValues"];if(be){const Le=be?.values??be?.Values??be?.["ids:values"]??be,Rt=Ue(Le?.value??Le?.Value??Le?.["ids:value"]??Le??[]);for(const Ke of Rt){const Re=m(Ke)||m(Ke?.simpleValue)||m(Ke?.["ids:simpleValue"]);Re&&Oe.push(Re)}}if(qe||At){const Le={id:`rule-${k}-${re.length}`,propertyPath:`${qe??"Pset"}.${At??"Property"}`,operator:"equals"};Oe.length&&(Le.value=Oe.length===1?Oe[0]:JSON.stringify(Oe)),re.push(Le)}}return re};for(const X of ge){const re=Z(X);re.length&&F.push(...re)}return{id:j,name:String(D??""),description:String(C),applicability:A,requirements:F}})},hl=e=>{const s=new js(jn);if((e??[]).some(p=>Array.isArray(p.requirements)&&p.requirements.some(b=>b&&typeof b=="object"&&"propertyPath"in b))){const b={"ids:ids":{"@_xmlns:ids":"http://standards.buildingsmart.org/IDS","ids:specification":(e??[]).map(E=>{const f=[],k=C=>{if(!C&&C!==0)return null;if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(C?.ifcClass&&typeof C.ifcClass=="string"&&C.ifcClass.trim())return C.ifcClass.trim();const A=C?.entity??C?.ifcType??C?.type;if(A&&typeof A=="string"&&A.trim())return A.trim();const F=C?.sample??C;if(F){if(F._category&&typeof F._category=="object"){const M=F._category.value??F._category.Value;if(typeof M=="string"&&M.trim())return M.trim()}const v=F?.ifcClass??F?.category?.value??F?.type??F?._type;if(v&&typeof v=="string"&&v.trim())return v.trim()}return null};for(const C of Ue(E.applicability)){const A=k(C)??null,F=A&&String(A).trim()?String(A):"IFCELEMENT";f.push({"ids:name":{"ids:simpleValue":F}})}const j=[],O=C=>{if(C==null)return"";if(typeof C=="string")return C;if(typeof C=="number")return String(C);if(typeof C=="object"){if(C["ids:simpleValue"])return String(C["ids:simpleValue"]);if(C.__cdata)return String(C.__cdata);if(C.Name)return String(C.Name);if(C.name)return String(C.name);for(const A of Object.keys(C)){const F=C[A];if(typeof F=="string"&&F.trim())return F;if(F&&typeof F=="object"){const v=F;if(typeof v["ids:simpleValue"]=="string")return v["ids:simpleValue"];if(typeof v.value=="string")return v.value}}return""}return""};for(const C of Ue(E.requirements))if(C&&typeof C=="object"){const A=C;let F=null,v=null;if(typeof A.propertyPath=="string"){const[K,H]=String(A.propertyPath).split(".");F=K,v=H}else A.propertyPath&&typeof A.propertyPath=="object"?(F=A.propertyPath.pset??A.propertyPath.propertySet??A.propertySet??null,v=A.propertyPath.property??A.propertyPath.prop??A.property??A.propertyName??null):(F=A.propertySet??A.pset??null,v=A.baseName??A.property??A.prop??null);const M=O(F)||"Pset",q=O(v)||"Property",ge=Kt(M)||M,Z=Kt(q)||q,X={};if(X["ids:propertySet"]={"ids:simpleValue":ge},X["ids:baseName"]={"ids:simpleValue":Z},(A.operator??"equals")==="exists")X["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":""}}};else if(A.value!=null&&String(A.value).trim()){let K=null;try{const H=typeof A.value=="string"?JSON.parse(A.value):A.value;Array.isArray(H)&&(K=H.map(Ae=>String(Ae)))}catch{}K||typeof A.value=="string"&&A.value.includes(",")&&(K=A.value.split(",").map(H=>br(H.trim())).filter(Boolean)),K&&K.length?X["ids:allowedValues"]={"ids:values":{"ids:value":K.map(H=>({"ids:simpleValue":br(String(H))}))}}:X["ids:allowedValues"]={"ids:values":{"ids:value":{"ids:simpleValue":br(String(A.value))}}}}j.push({"ids:property":X})}const D={"@_ifcVersion":"IFC4","@_name":E.name??""};return f.length&&(D["ids:applicability"]={"ids:entity":f.map(C=>({"ids:name":C["ids:name"]?C["ids:name"]:C}))}),j.length&&(D["ids:requirements"]={"ids:property":j.map(C=>C["ids:property"])}),D})}},m=s.build(b);return m.startsWith("<?xml")?m:`<?xml version="1.0" encoding="UTF-8"?>
${m}`}const x={IdsCreator:{Specification:(e??[]).map(p=>({"@_id":p.id,Name:p.name,Description:p.description,Applicability:{__cdata:JSON.stringify(p.applicability??[])},Requirements:{__cdata:JSON.stringify(p.requirements??[])}}))}},l=s.build(x);return l.startsWith("<?xml")?l:`<?xml version="1.0" encoding="UTF-8"?>
${l}`},Kt=e=>e?e.trim().replace(/\s+/g,"_").replace(/["'`]/g,"").replace(/[^a-zA-Z0-9_.:\-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",br=e=>!e||typeof e!="string"?e:e.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),vn=e=>{if(e==null)return"";if(typeof e=="string")return br(e.trim());if(typeof e=="number"||typeof e=="boolean")return String(e);try{return JSON.stringify(e)}catch{return String(e)}},Ei=e=>{if(!e)return{};const s={};for(const[a,x]of Object.entries(e)){if(!x||typeof x!="object")continue;const l=Kt(a)||a;for(const[p,b]of Object.entries(x)){const m=Kt(p)||p,E=`${l}.${m}`;E in s||(s[E]=vn(b))}}return s};let ft=null;const Ai=()=>{ft=null},Ri=e=>e.slice().sort().join("|"),zi=["GlobalId","GlobalID","globalId","guid","Guid","GUID"],Mi=(e,s)=>{if(!e||typeof e!="object")return;const a=s.map(p=>p.toLowerCase()),x=new WeakSet,l=[e];for(;l.length;){const p=l.pop();if(!(!p||typeof p!="object")&&!x.has(p)){if(x.add(p),Array.isArray(p)){for(const b of p)b&&typeof b=="object"&&l.push(b);continue}for(const[b,m]of Object.entries(p)){const E=b.toLowerCase();if(a.some(f=>E.includes(f)))if(typeof m=="string"){const f=m.trim();if(f)return f}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const f=m;if(typeof f.value=="string"){const k=f.value.trim();if(k)return k}if(typeof f.Value=="string"){const k=f.Value.trim();if(k)return k}f.value&&typeof f.value=="object"&&l.push(f.value),f.Value&&typeof f.Value=="object"&&l.push(f.Value)}}m&&typeof m=="object"&&l.push(m)}}}},Di=e=>{if(!e||typeof e!="object")return null;const s=e;for(const x of zi){const l=s[x];if(typeof l=="string"&&l.trim().length)return l.trim()}return Mi(e,["globalid","global id","guid","uniqueid"])?.trim()??null},gr=async(e,s,a)=>{const x=[],l=Math.max(s.length,1);a?.onProgress?.({done:0,total:l});const p=e.getElementProps;for(let b=0;b<s.length;b++){const m=s[b];try{const{ifcClass:E,psets:f,attributes:k}=await p.call(e,m),j=Ei(f);if("GlobalId"in j||(j.GlobalId=m),k)for(const[O,D]of Object.entries(k)){const A=`Attributes.${Kt(O)||O}`;A in j||(j[A]=vn(D))}j.ifcClass||(j.ifcClass=E),x.push({GlobalId:m,ifcClass:E,properties:j}),(b%50===0||b===s.length-1)&&a?.onProgress?.({done:x.length,total:l})}catch(E){console.warn(`IDS adapter (direct) failed to load element ${m}`,E)}}return a?.onProgress?.({done:x.length,total:l}),x},Ni=async(e,s,a)=>{if(typeof e.iterElements!="function")throw new Error("Viewer API does not support iterating elements.");const x=Math.max(1,(navigator.hardwareConcurrency||4)-1),l=[],p=[],b=[];for(let f=0;f<x;f++){const k=new Worker(new URL("/Savora-Viewer/assets/buildProps.worker-IaqqWkGT.js",import.meta.url),{type:"module"});l.push(k);const j=new Promise((O,D)=>{const C=F=>{const v=F.data;if(v){if(v.type==="error"){D(new Error(v.message||`Worker ${f} failed.`));return}if(v.type==="progress"){const M=b.reduce((q,ge)=>q+ge.length,0)+v.done;a?.onProgress?.({done:M,total:Math.max(s,M)});return}v.type==="done"&&(b[f]=v.elements??[],O(v.elements??[]))}},A=F=>{D(F.error??new Error(F.message||`Worker ${f} error.`))};k.addEventListener("message",C),k.addEventListener("error",A)});p.push(j),k.postMessage({type:"build-props",reset:!0,total:s})}a?.onProgress?.({done:0,total:s});const m=new Set;let E=0;try{for await(const f of e.iterElements({batchSize:128})){if(!Array.isArray(f)||!f.length)continue;const k=[];f.forEach(j=>{if(!j||typeof j!="object")return;const O=j.data;if(!O)return;const D=Di(O);if(!D||m.has(D))return;m.add(D);const C=typeof O.ifcClass=="string"?O.ifcClass:void 0;k.push({globalId:D,ifcClass:C,data:O})}),k.length&&(l[E].postMessage({type:"build-props",elements:k}),E=(E+1)%x)}}catch(f){throw l.forEach(k=>{k.postMessage({type:"cancel"}),k.terminate()}),f}l.forEach(f=>{f.postMessage({type:"build-props",final:!0})});try{const k=(await Promise.all(p)).flat();return a?.onProgress?.({done:k.length,total:Math.max(s,k.length)}),k}finally{l.forEach(f=>f.terminate())}},Ti=async(e,s)=>{try{const a=typeof s.countElements=="function"?await s.countElements():void 0;return await Pi({modelUrl:e,extra:a!=null?String(a):void 0})}catch(a){return console.warn("IDS adapter: failed to compute model key for cache",a),null}},$i=async(e,s)=>{if(!e)return[];let a;if(s?.filterGlobalIds&&s.filterGlobalIds.length>0?a=s.filterGlobalIds:a=await e.listGlobalIds(),!a.length)return ft=null,[];const x=Ri(a),l=Math.max(a.length,1);if(s?.onPhase?.("BUILDING_PROPERTIES"),s?.onProgress?.({done:0,total:l}),ft&&ft.token===x)return ft.elements;const p=s?.filterGlobalIds&&s.filterGlobalIds.length>0;let b=null;if(!p&&(b=await Ti(x,e),b))try{const E=await ro.get(b);if(E&&E.length){const f=await ro.getMetadata(b),k=f?Math.round((Date.now()-f.timestamp)/1e3/60):0;return s?.onProgress?.({done:E.length,total:l}),ft={token:x,elements:E},E}}catch(E){console.warn("IDS adapter: failed to read cached elements from IndexedDB",E)}let m=[];if(p)m=await gr(e,a,s);else{const E=typeof e.countElements=="function"?await e.countElements().catch(()=>a.length):a.length;if(typeof e.iterElements=="function")try{m=await Ni(e,E??a.length,s),m.length||(m=await gr(e,a,s))}catch(f){console.warn("IDS adapter: property build worker failed, falling back to direct collection",f),m=await gr(e,a,s)}else m=await gr(e,a,s)}return b&&m.length&&ro.set(b,m).catch(E=>console.warn("IDS adapter: failed to persist elements cache",E)),ft={token:x,elements:m},s?.onProgress?.({done:Math.min(m.length,l),total:l}),m},Fi={idsXmlText:"",idsFileNames:[],isChecking:!1,phase:"IDLE",progress:null,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,validationMode:"all"};let pt=Fi;const so=new Set;let ut=null;const Oi=()=>{so.forEach(e=>{try{e()}catch(s){console.error("IDS store listener error",s)}})},ce=e=>{pt=e(pt),Oi()};let ot=null,xr=null;const Li=()=>(ot||(ot=new Worker(new URL("/Savora-Viewer/assets/ids.worker-BYI9LGdi.js",import.meta.url),{type:"module"})),ot),Vi=(e,s)=>{const a=Li(),x=new Promise((l,p)=>{const b=E=>{const f=E.data;if(f){if(f.type==="error"){a.removeEventListener("message",b),a.removeEventListener("error",m),p(new Error(f.message||"IDS worker failed"));return}if(f.type==="phase"){s?.onPhase?.(f.label);return}if(f.type==="progress"){s?.onProgress?.(f);return}if(f.type==="done"){a.removeEventListener("message",b),a.removeEventListener("error",m),l(f);return}}},m=E=>{a.removeEventListener("message",b),a.removeEventListener("error",m),p(E.error??new Error(E.message))};a.addEventListener("message",b),a.addEventListener("error",m),a.postMessage(e)});return xr=x.finally(()=>{xr=null}),x},xn=()=>{ce(e=>({...e,rules:[],rows:[],filteredRows:[],filterDescription:null,error:null,lastRunAt:null,phase:"IDLE",progress:null}))},fe={subscribe:e=>(so.add(e),()=>so.delete(e)),getState:()=>pt,setIdsXmlText:(e,s)=>{const a=e.replace(/\uFEFF/g,"").trim(),x=s?.fileNames??[];ce(l=>({...l,idsXmlText:a,idsFileNames:x,error:null})),xn()},appendDocuments:e=>{if(!e.length)return;const s=fe.getState(),a=[];s.idsXmlText.trim().length&&a.push(s.idsXmlText.trim()),a.push(...e.map(p=>p.content.trim()).filter(Boolean));const x=a.join(`

`),l=[...s.idsFileNames,...e.map(p=>p.name)];fe.setIdsXmlText(x,{fileNames:l})},clearResults:()=>{xn()},setValidationMode:e=>{ce(s=>({...s,validationMode:e}))},filterRows:(e,s)=>{ce(a=>{if(!e)return{...a,filteredRows:a.rows,filterDescription:null};const x=a.rows.filter(l=>{try{return e(l)}catch(p){return console.warn("IDS filter predicate threw an error",p),!0}});return{...a,filteredRows:x,filterDescription:s??null}})},runCheck:async e=>{if(!e){ce(l=>({...l,error:"Viewer API is not available."}));return}if(pt.isChecking){await xr;return}const s=pt.idsXmlText.trim();if(!s){ce(l=>({...l,error:"Load at least one IDS XML file before running the check."}));return}let a;if(pt.validationMode==="selected")if(e.getSelectedGlobalIds){if(a=await e.getSelectedGlobalIds(),!a||a.length===0){console.error("âŒ No elements selected"),ce(l=>({...l,error:"No elements selected. Please select elements or switch to another mode."}));return}}else{console.warn("âš ï¸ getSelectedGlobalIds not available on viewerApi"),ce(l=>({...l,error:"Selected elements validation is not supported by this viewer."}));return}else if(pt.validationMode==="visible")if(e.getVisibleGlobalIds){if(a=await e.getVisibleGlobalIds(),!a||a.length===0){console.error("âŒ No visible elements found"),ce(l=>({...l,error:"No visible elements found. Please make sure elements are visible or switch to another mode."}));return}}else{console.warn("âš ï¸ getVisibleGlobalIds not available on viewerApi"),ce(l=>({...l,error:"Visible elements validation is not supported by this viewer."}));return}ce(l=>({...l,isChecking:!0,error:null,phase:"BUILDING_PROPERTIES",progress:null})),ut=new AbortController;const x=ut.signal;try{if(x.aborted)throw new Error("Validation cancelled");const l=await $i(e,{filterGlobalIds:a,onPhase:f=>{ce(k=>({...k,phase:f}))},onProgress:f=>{ce(k=>({...k,progress:f}))}});if(!l.length)throw new Error("No IFC elements were found in the current viewer.");if(x.aborted)throw new Error("Validation cancelled");ce(f=>({...f,phase:"CHECKING_IDS",progress:null}));const p={compiling:"CHECKING_IDS",validating:"COMPARING_DATA",finalizing:"FINALIZING",idle:"FINALIZING"},b=await Vi({type:"validate",idsXml:s,elements:l},{onPhase:f=>{const k=p[f];k&&ce(j=>({...j,phase:k}))},onProgress:f=>{ce(k=>({...k,progress:{done:f.done,total:f.total}}))}}),m=b.rules??[],E=b.rows??[];if(a&&a.length>0&&typeof e.addToCache=="function")try{await e.addToCache(a)}catch(f){console.warn("ðŸ“¦ Failed to add elements to cache:",f)}ce(f=>({...f,isChecking:!1,rules:m,rows:E,filteredRows:E,filterDescription:null,error:null,lastRunAt:Date.now(),phase:"DONE",progress:null})),ut=null}catch(l){const p=l instanceof Error?l.message:"Failed to run IDS validation.";console.error("IDS run failed",l),ce(b=>({...b,isChecking:!1,error:p,phase:"ERROR",progress:null})),ut=null}},invalidateCaches:()=>{Ai(),ot&&(ot.terminate(),ot=null,xr=null),ce(e=>({...e,isChecking:!1,phase:"IDLE",progress:null}))},cancelValidation:()=>{ut&&(ut.abort(),ut=null),ot&&ot.postMessage({type:"cancel"}),ce(e=>({...e,isChecking:!1,phase:"IDLE",progress:null,error:"Validation cancelled by user"}))}},_i=e=>c.useSyncExternalStore(fe.subscribe,()=>e({...fe.getState(),...fe}),()=>e({...fe.getState(),...fe})),Bi=e=>c.useSyncExternalStore(fe.subscribe,()=>e(fe.getState()),()=>e(fe.getState())),Gi=()=>{const e=c.useCallback(fe.setIdsXmlText,[]),s=c.useCallback(fe.appendDocuments,[]),a=c.useCallback(fe.clearResults,[]),x=c.useCallback(fe.filterRows,[]),l=c.useCallback(fe.runCheck,[]),p=c.useCallback(fe.setValidationMode,[]),b=c.useCallback(fe.cancelValidation,[]);return{setIdsXmlText:e,appendDocuments:s,clearResults:a,filterRows:x,runCheck:l,setValidationMode:p,cancelValidation:b,invalidateCaches:fe.invalidateCaches}},kn=fe,Wi=Object.freeze(Object.defineProperty({__proto__:null,idsStore:kn,useIdsActions:Gi,useIdsStore:_i,useIdsStoreSelector:Bi},Symbol.toStringTag,{value:"Module"})),Ui=Et.lazy(()=>Pt(()=>import("./ChatWindow-CX7HP66O.js"),__vite__mapDeps([0,1,2,3]))),Hi=Et.lazy(()=>Pt(()=>import("./IdsPanel-BcAMz20I.js"),__vite__mapDeps([4,1,2,3]))),qi=Et.lazy(()=>Pt(()=>import("./IdsCreatorPanel-CnbUtyrw.js"),__vite__mapDeps([5,1,2,3]))),Ki=Et.lazy(()=>Pt(()=>import("./ModelFilterPanel-CLBWtdAD.js"),__vite__mapDeps([6,1]))),oo=(e,s)=>{if(e.length!==s.length)return!1;for(let a=0;a<e.length;a+=1){const x=e[a],l=s[a];if(!l||x.modelId!==l.modelId||x.localId!==l.localId)return!1}return!0},Yi={category:["category","ifccategory","ifcclass","class"],type:["type","ifctype","typemark","typename"],system:["system","systemtype"],name:["name","label","description"],material:["material","materialname"],guid:["guid","globalid","global id"],globalid:["globalid","guid","global id"],family:["family","familyname"],level:["level","storey","story","buildingstorey"],discipline:["discipline"],phase:["phase"]},Xi=(e,s)=>{if(!e)return s;const a=[e.ifcCategory,e.Category,e.category,e.ifcClass,e.class,e.type,e.Type,e.system,e.System];for(const x of a)if(typeof x=="string"&&x.trim())return x.trim();if(Array.isArray(e.categories)&&e.categories.length){const x=e.categories.find(l=>typeof l=="string"&&l.trim());if(x)return x.trim()}return typeof e.name=="string"&&e.name.trim()?e.name.trim():typeof e.Name=="string"&&e.Name.trim()?e.Name.trim():typeof e.label=="string"&&e.label.trim()?e.label.trim():s},Ji=(e,s,a)=>{const x=new Map;let l=0,p=0,b=0;a.traverse(j=>{const O=!!j?.isInstancedMesh,D=!!j?.isMesh;if(!O&&!D)return;let C=0;if(O){let v=0;typeof j.count=="number"?v=j.count:typeof j.instanceCount=="number"?v=j.instanceCount:Array.isArray(j.instanceIdMap)?v=j.instanceIdMap.length:Array.isArray(j.userData?.ids)?v=j.userData.ids.length:typeof j.userData?.size=="number"&&(v=j.userData.size),Number.isFinite(v)&&v>0&&(C=v,p+=v)}else C=1,b+=1;C<=0&&(C=1),l+=C;const A=Xi(j?.userData??{},j?.type??"Mesh"),F=x.get(A)??0;x.set(A,F+C)});const m=Array.from(x.entries()).map(([j,O])=>({category:j,count:O})).sort((j,O)=>O.count-j.count),E=new rt().setFromObject(a),f=new J,k=new J;return E.getSize(f),E.getCenter(k),{modelId:e,label:s,elementCount:l,instancedCount:p,meshCount:b,categoryCounts:m,bboxSize:{x:f.x,y:f.y,z:f.z},bboxCenter:{x:k.x,y:k.y,z:k.z},collectedAt:Date.now()}},Zi=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),He=e=>{if(!e)return"";let s=e.replace(/[_\-]+/g," ");return s=s.replace(/([a-z\d])([A-Z])/g,"$1 $2"),s=s.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),s=s.replace(/\s+/g," ").trim(),s?s.split(" ").map(x=>{const l=x.toUpperCase();return Zi.has(l)||l.length<=3&&/^[A-Z]+$/.test(l)?l:/^\d+(\.\d+)?$/.test(x)||!x.length?x:x.charAt(0).toUpperCase()+x.slice(1)}).join(" "):""},Qi=(e,s=200)=>e?e.length<=s?e:`${e.slice(0,s)}â€¦`:"",Pe=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const s=JSON.stringify(e);return s?s.length>500?`${s.slice(0,500)}â€¦`:s:""}catch{return String(e)}},Ee=e=>e==null?"":typeof e!="object"?Pe(e):"value"in e?Ee(e.value):"Value"in e?Ee(e.Value):Array.isArray(e)?e.map(s=>Ee(s)).filter(Boolean).join(", "):typeof e.x=="number"&&typeof e.y=="number"&&typeof e.z=="number"?`${Pe(e.x)}, ${Pe(e.y)}, ${Pe(e.z)}`:Pe(e),he=(e,s)=>{if(!e||typeof e!="object")return;const a=s.map(p=>p.toLowerCase()),x=new WeakSet,l=[e];for(;l.length;){const p=l.pop();if(!(!p||typeof p!="object")&&!x.has(p)){if(x.add(p),Array.isArray(p)){for(const b of p)b&&typeof b=="object"&&l.push(b);continue}for(const[b,m]of Object.entries(p)){const E=b.toLowerCase();if(a.some(f=>E.includes(f)))if(typeof m=="string"){const f=m.trim();if(f)return f}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false";if(m&&typeof m=="object"){const f=Ee(m);if(f)return f}}m&&typeof m=="object"&&l.push(m)}}}},el=(e,s)=>{if(!e||typeof e!="object")return wr(e,300);const a=[],x=Fe(e)??he(e,["name","label","description"]);x&&a.push(`name:${x}`);const l=he(e,["category","ifcclass","ifc type","type"]);l&&a.push(`category:${l}`);const p=he(e,["globalid","global id","guid"]);p&&a.push(`globalId:${p}`);const b=he(e,["expressid","express id"]);if(b&&b!==p&&a.push(`expressId:${b}`),s>0)try{const{rows:E}=Ht(e);if(E.length){const k=E.slice(0,s).map(j=>`${j.label}=${j.value}`).join(" | ");k&&a.push(`props:${k}`),E.length>s&&a.push(`propsTruncated:${E.length-s}`)}}catch(E){console.warn("Failed to build detailed property data for AI summary",E)}const m=a.filter(Boolean).join(" | ");return m?m.length>1200?`${m.slice(0,1200)}â€¦`:m:wr(e,300)},wn={attributes:"Attributes",psets:"Property Sets",qsets:"Quantity Sets",type:"Type",materials:"Materials",classification:"Classification",systems:"Systems",expressID:"Express ID",expressId:"Express ID",GlobalId:"Global Id",globalId:"Global Id"},tl=new Set(["modelIdMap"]),kt=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),tt=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",qt=["HasProperties","hasProperties","Properties","properties"],no=["psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],In=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),yr=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSET"?!0:qt.some(a=>Array.isArray(e[a]))},Pn=e=>{if(!e||typeof e!="object")return!1;const s=typeof e.type=="string"?e.type:typeof e.Type=="string"?e.Type:void 0;return s&&s.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in e||"nominalValue"in e},rl=e=>{if(!e||typeof e!="object")return Pe(e);const s=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const a of s){if(!(a in e))continue;const x=e[a];if(x==null)continue;if(Array.isArray(x)){const p=x.map(b=>Ee(b)).filter(Boolean).join(", ");if(p)return p;continue}const l=Ee(x);if(l)return l}for(const[a,x]of Object.entries(e))if((typeof x=="string"||typeof x=="number"||typeof x=="boolean")&&a.toLowerCase().includes("value")){const l=Pe(x);if(l)return l}return""},ol=(e,s,a)=>{const x=qt.map(m=>Array.isArray(e[m])?e[m]:null).filter(m=>!!m);if(!x.length)return[];const l=He(s)||s,p=[],b=new Map;return x.flat().forEach((m,E)=>{if(!m||typeof m!="object"||!Pn(m))return;const f=Fe(m)??(typeof m.Name=="string"?m.Name:void 0)??(typeof m.PropertyName=="string"?m.PropertyName:void 0),k=`Property ${E+1}`,j=f&&f.trim().length?f.trim():k,O=He(j)||j,D=rl(m),C=kt(j)||"property",A=(b.get(C)??0)+1;b.set(C,A);const F=`${C}-${A}`,v=`Property Sets / ${l} / ${O}`,M=[v.toLowerCase()];D&&M.push(D.toLowerCase()),p.push({label:v,value:D||"",path:`property-sets/${a}/${F}`,searchText:M.join(" ").trim(),rawPsetName:s,rawPropertyName:j,rawValue:m.__rawValue??m})}),p},Ut=e=>{if(!e||typeof e!="object")return[];const s=[],a=new WeakSet,x=new Map,l=D=>{let C;if(typeof D=="string"){const M=D.trim();M.length&&(C=M)}!C&&D&&typeof D=="object"&&(C=Fe(D)??(typeof D.Name=="string"?D.Name:void 0)??(typeof D.id=="string"?D.id:void 0)),(!C||!C.length)&&(C="Property Set");const A=He(C)||C,F=kt(C)||"property-set",v=(x.get(F)??0)+1;return x.set(F,v),{rawName:C,friendlyName:A,uniqueKey:`${F}-${v}`}},p=(D,C,A)=>{const F=`Property ${A+1}`,v=D?.trim?.()?D.trim():F;if(Pn(C)){const M={...C};return M.Name==null&&M.PropertyName==null&&(M.Name=v),M.PropertyName==null&&(M.PropertyName=M.Name??v),M.__rawValue==null&&(M.__rawValue=C),M}if(C&&typeof C=="object"){const M={...C};return M.Name==null&&M.PropertyName==null&&(M.Name=v),M.PropertyName==null&&(M.PropertyName=M.Name??v),M.type==null&&M.Type==null&&(M.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in M)&&!("nominalValue"in M)&&!("Value"in M)&&!("value"in M)&&(M.NominalValue=C),M.__rawValue=C,M}return{type:"IFCPROPERTYSINGLEVALUE",Name:v,PropertyName:v,NominalValue:C,__rawValue:C}},b=(D,C)=>{const A=[],F=(v,M)=>{const q=`Property ${A.length+1}`,ge=(typeof v=="string"&&v.trim().length?v.trim():void 0)??Fe(v)??(typeof v?.Name=="string"?v.Name:void 0)??(typeof v?.PropertyName=="string"?v.PropertyName:void 0)??q;A.push(p(ge,M,A.length))};if(C&&typeof C=="object")for(const v of qt){const M=C[v];Array.isArray(M)&&M.length&&M.forEach(q=>F(q,q))}if(!A.length)if(Array.isArray(C))C.forEach(v=>F(v,v));else if(C&&typeof C=="object")for(const[v,M]of Object.entries(C))M!=null&&(In.has(v)||qt.includes(v)||no.includes(v)||F(v,M));else C!=null&&F(void 0,C);return{type:"IFCPROPERTYSET",Name:D,HasProperties:A}},m=(D,C)=>{const F=ol(C&&typeof C=="object"?C:{},D.rawName,D.uniqueKey);F.length&&s.push(...F)},E=D=>{if(!(!D||typeof D!="object")&&!a.has(D)){if(a.add(D),Array.isArray(D)){D.forEach(C=>{if(!C||typeof C!="object")return;const A=l(C),F=yr(C)?C:b(A.rawName,C);m(A,F),F&&typeof F=="object"&&a.add(F)});return}for(const[C,A]of Object.entries(D)){if(A==null)continue;const F=l(C),v=yr(A)?A:b(F.rawName,A);m(F,v),A&&typeof A=="object"&&a.add(A)}}},f=D=>{if(!D||typeof D!="object"||a.has(D))return;if(a.add(D),Array.isArray(D)){D.forEach(f);return}let C=!1;for(const A of no)Object.prototype.hasOwnProperty.call(D,A)&&(E(D[A]),C=!0);if(yr(D)){const A=l(D);m(A,D)}!C&&!yr(D)&&Object.entries(D).forEach(([A,F])=>{no.includes(A)||In.has(A)||qt.includes(A)||F&&typeof F=="object"&&f(F)})};f(e);const k=new Map,j=new Set;for(const D of s){const C=`${D.label}::${D.value}`;if(j.has(C))continue;const A=`${D.rawPsetName||"unknown"}::${D.rawPropertyName||"unknown"}::${D.value}`;k.has(A)||(j.add(C),k.set(A,D))}const O=Array.from(k.values());return s.length,O.length,O},je={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},Cn=["ifcproperty","ifcquantity","ifcphysicalsimplequantity","ifcprofile","ifcmaterial","ifcreldefines","ifcstyleditem"],nl=(e,s)=>{const a=typeof e=="string"?e.trim().toLowerCase():"";if(a&&Cn.some(x=>a.startsWith(x)))return!0;if(s&&typeof s=="object"){const x=Ee(s._category??s.category??s.Category??null),l=typeof x=="string"?x.trim().toLowerCase():"";if(l&&Cn.some(b=>l.startsWith(b))||(s.NominalValue!=null||s.nominalValue!=null)&&(s.Name!=null||s.PropertyName!=null)&&a.includes("property"))return!0}return!1},Sn="fragmentsViewer.favoritePropertyPaths",sl=1e4,il=500,Fe=e=>{if(!e||typeof e!="object")return;let s,a;typeof e.Name=="string"?s=e.Name:e.Name&&typeof e.Name=="object"&&(s=Ee(e.Name)||void 0),typeof e.name=="string"?a=e.name:e.name&&typeof e.name=="object"&&(a=Ee(e.name)||void 0);const x=s??a;if(!x)return;const l=x.trim();return l.length?l:void 0},Ht=e=>{if(!e||typeof e!="object")return{rows:[],tree:[]};const s=[],a=new WeakSet,x=(b,m,E)=>{if(b==null)return null;const f=m.map(v=>{const M=v?.trim?.()??v;return typeof M=="string"&&M.length?He(M)||M:typeof v=="string"?v:String(v??"")}),k=f.filter(Boolean).join(" / "),j=E.length?E.join("/"):kt(k||"value"),O=f[f.length-1]??"Value",D=v=>{const M=k.toLowerCase(),q=[M];v&&q.push(v.toLowerCase());const ge=q.join(" ").trim()||M,Z={label:k,value:v??"",path:j,searchText:ge};return s.push(Z),ge};if(typeof b!="object"||b instanceof Date){const v=Pe(b),M=D(v);return{id:j,label:O,fullLabel:k,value:v||void 0,children:[],searchText:M}}if(a.has(b)){const v="[Circular reference]",M=D(v);return{id:j,label:O,fullLabel:k,value:v,children:[],searchText:M}}a.add(b);let C;const A=[];if(Array.isArray(b))b.forEach((v,M)=>{const q=Fe(v),ge=`${O} ${M+1}`,Z=q&&q.trim().length?q.trim():ge,X=He(Z)||Z,re=q&&q.trim().length?kt(q):String(M),K=x(v,[...m,X],[...E,re]);K&&A.push(K)}),A.length===0&&(C=Pe(b));else{if("NominalValue"in b||"nominalValue"in b){const v=b.NominalValue??b.nominalValue,M=Ee(v);M&&(C=M)}!C&&"value"in b&&typeof b.value!="object"&&(C=Pe(b.value)),!C&&"Value"in b&&typeof b.Value!="object"&&(C=Pe(b.Value));for(const[v,M]of Object.entries(b)){if(M==null||v==="Name"||v==="name"||v==="IsDefinedBy"||v==="isDefinedBy"||v==="psets"||v==="Psets"||v==="propertySets"||v==="PropertySets"||v==="property_sets"||v==="Property_Sets")continue;if(v==="NominalValue"||v==="nominalValue"){const Ae=He("Nominal Value")||"Nominal Value",we=x(M,[...m,Ae],[...E,"nominal-value"]);we&&A.push(we);continue}const q=wn[v]??v,ge=He(q)||q,Z=Fe(M)?.trim(),X=Z&&Z.length?He(Z)||Z:ge,re=Z&&Z.length?kt(Z):kt(q),K=[...m,X],H=x(M,K,[...E,re]);H&&A.push(H)}!C&&A.length===0&&(C=Pe(b))}const F=D(C);return{id:j,label:O,fullLabel:k,value:C,children:A,searchText:F}},l=[];for(const[b,m]of Object.entries(e)){if(m==null||tl.has(b))continue;const E=wn[b]??b,f=x(m,[E],[b]);f&&l.push(f)}if(s.length){const b=s.filter(m=>{const E=m.label.toLowerCase();return E.startsWith("property sets /")?!(E.includes("/ has properties")||E.includes("/ nominal value")):!0});b.length!==s.length&&s.splice(0,s.length,...b)}const p=Ut(e);if(p.length){const b=[],m=new Set;for(const f of p)m.has(f.path)||(m.add(f.path),b.push(f));const E=[];for(const f of s)m.has(f.path)||E.push(f);s.splice(0,s.length,...b,...E)}return{rows:s,tree:l}},ll=()=>{const e=c.useRef(null),s=c.useRef(null),a=c.useRef(null),x=c.useRef(null),l=c.useRef(null),p=c.useRef(!1),b=c.useRef(null),m=c.useRef(null),E=c.useRef(null),[f,k]=c.useState(!1),[j,O]=c.useState([]),[D,C]=c.useState(!1),[A,F]=c.useState(50);c.useCallback(async(t,o)=>{{console.warn("dumpModelRawData is dev-only.");return}},[j]),c.useCallback(async(t,o=50,i=128)=>{},[]);const[v,M]=c.useState([]),[q,ge]=c.useState(null),[Z,X]=c.useState(!0),[re,K]=c.useState(!1),[H,Ae]=c.useState(!1),[we,qe]=c.useState(null),[At,Oe]=c.useState(!1),[be,Le]=c.useState(!1),Rt=c.useRef(null),Ke=c.useRef(!1),Re=c.useRef(null),Ve=c.useRef(null),Yt=c.useRef(0),ze=c.useRef(null),Xt=c.useRef(null);c.useRef(null);const Ne=c.useRef(null),Jt=c.useRef(!1),mt=c.useRef(null),Ir=c.useRef("click"),[Zt,En]=c.useState({width:360,height:520}),Cr=c.useRef(null),Qt=c.useRef(!1),Sr=c.useRef(null),lo=c.useRef(!1),ao=c.useRef(null),nt=c.useRef(null),jr=c.useRef(null),er=c.useRef(null),vr=c.useRef(null),zt=c.useRef(null),co=c.useRef(null),uo=c.useRef(null),_e=c.useRef(null),Be=c.useRef([]),Te=c.useRef(null),Mt=c.useRef(null),ht=c.useRef(null),[tr,ve]=c.useState(null),[le,An]=c.useState([]),[fo,Rn]=c.useState(""),[gt,zn]=c.useState(""),[Ie,po]=c.useState([]),[st,mo]=c.useState("favorites"),[Mn,al]=c.useState(!1),[Dn,cl]=c.useState(!1),[Nn,dl]=c.useState(!1),[it,Tn]=c.useState("models"),[Ye,kr]=c.useState(!1),[$n,ho]=c.useState(0),[Xe,rr]=c.useState(!1),[Fn,go]=c.useState(!1),[On,yo]=c.useState(!1),[ye,Pr]=c.useState("disabled"),[Ge,Er]=c.useState(""),[Dt,or]=c.useState(""),[Ar,bo]=c.useState(!1),[xo,wo]=c.useState(!1),[Io,yt]=c.useState(null),[xe,Co]=c.useState("click"),[bt,Ln]=c.useState(!1),[xt,Vn]=c.useState(!1),Rr=c.useRef(!1),_n=c.useRef(new Map),So=c.useRef(null),Nt=c.useRef(!1),jo=c.useRef(new Map),[Bn,zr]=c.useState(0),[Je,vo]=c.useState(!1),[ko,Gn]=c.useState({}),[Mr,Po]=c.useState(null),[Tt,Eo]=c.useState([]),[Wn,Dr]=c.useState(!1),[Ze,Ao]=c.useState("selected"),[Qe,nr]=c.useState(""),[lt,Ro]=c.useState(!1),[zo,sr]=c.useState(null),[wt,Nr]=c.useState(!1),[oe,ir]=c.useState({x:!1,y:!1,z:!1}),[$e,Mo]=c.useState({x:0,y:0,z:0}),[$t,Do]=c.useState(!1),[Ft,Un]=c.useState(!1),Ot=c.useRef(!1),Tr=c.useRef([]),$r=c.useRef(new Map),lr=c.useRef(null),[No,To]=c.useState(null),$o=c.useRef(null),at=c.useCallback(()=>a.current?.camera??null,[]),Fr=c.useCallback(()=>at()?.three??null,[at]);c.useEffect(()=>{Ir.current=xe},[xe]),c.useEffect(()=>{const t=$o.current;!t||!("mouseButtons"in t)||(xe==="rectangle"?t.mouseButtons={left:0,middle:2,right:0,wheel:16}:t.mouseButtons={left:1,middle:2,right:0,wheel:16})},[xe]),c.useEffect(()=>{try{const t=window.localStorage.getItem(Sn);if(!t)return;const o=JSON.parse(t);if(!Array.isArray(o))return;const i=o.filter(n=>typeof n=="string"&&n.trim().length>0);i.length&&po(i)}catch(t){console.warn("Failed to restore favourites from storage",t)}},[]),c.useEffect(()=>{try{window.localStorage.setItem(Sn,JSON.stringify(Ie))}catch(t){console.warn("Failed to persist favourites to storage",t)}},[Ie]);const ar=fo.trim(),Hn=ar.length>0,Fo=c.useMemo(()=>{const t=ar.toLowerCase();return t?le.filter(o=>o.searchText.includes(t)).slice(0,il):[]},[ar,le]),cr=c.useMemo(()=>{const t=new Map;return le.forEach(o=>t.set(o.path,o)),t},[le]),Or=c.useMemo(()=>le.slice(0,sl),[le]),Oo=Math.max(le.length-Or.length,0),Lo=c.useMemo(()=>new Set(Ie),[Ie]),Lr=c.useMemo(()=>Ie.length?Ie.map(t=>cr.get(t)).filter(t=>!!t):[],[Ie,cr]),Vr=c.useMemo(()=>{if(!Ie.length)return 0;let t=0;for(const o of Ie)cr.has(o)||(t+=1);return t},[Ie,cr]),Vo=c.useCallback(t=>{po(o=>o.includes(t)?o.filter(i=>i!==t):[...o,t])},[]),dr=c.useMemo(()=>j.map(t=>`${t.id}:${t.label}`).join("|"),[j]),_r=c.useCallback(t=>{const o=Lo.has(t.path);return r.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[r.jsxs(W,{sx:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:1},children:[r.jsx(U,{variant:"body2",sx:{fontWeight:600},children:t.label}),r.jsx(te,{title:o?"Remove from favourites":"Add to favourites",children:r.jsx("span",{children:r.jsx(ee,{size:"small",onClick:()=>Vo(t.path),color:o?"primary":"default",children:o?r.jsx(ks,{fontSize:"small"}):r.jsx(Ps,{fontSize:"small"})})})})]}),r.jsx(U,{variant:"body2",color:"text.secondary",children:t.value?Qi(t.value,360):"â€”"})]},t.path)},[Lo,Vo]);c.useEffect(()=>{if(!j.length){nr("");return}nr(t=>t&&j.some(o=>o.id===t)?t:j[0].id)},[j]);const _o=c.useCallback(async t=>{const o=l.current;if(!o)return[];const i=o.list.get(t);if(!i)return[];let n=[];try{const h=await i.getLocalIds();Array.isArray(h)?n=h:h&&typeof h[Symbol.iterator]=="function"&&(n=Array.from(h))}catch(h){return console.warn(`Failed to retrieve local IDs for model ${t}`,h),[]}if(!n.length)return[];const d=32,u=[];for(let h=0;h<n.length;h+=d){const g=n.slice(h,h+d);let y=[];try{y=await i.getItemsData(g,je)}catch(I){console.warn(`Failed to fetch items data for model ${t} chunk starting at ${g[0]}`,I);continue}y.forEach((I,R)=>{const z=g[R];if(I)try{const{rows:T}=Ht(I);T.forEach(S=>{u.push({path:`localId:${z} / ${S.label}`,value:S.value})})}catch(T){console.warn(`Failed to process properties for model ${t} localId ${z}`,T)}})}return u},[]),Bo=c.useCallback(t=>{const o=[];return o.push("Path,Value"),t.forEach(({path:i,value:n})=>{const d=i.replace(/"/g,'""'),u=(n??"").replace(/"/g,'""');o.push(`"${d}","${u}"`)}),o.join(`\r
`)},[]),qn=c.useCallback(()=>{sr(null),Ao(le.length?"selected":"model"),j.length&&!j.some(t=>t.id===Qe)&&nr(j[0].id),Dr(!0)},[le.length,j,Qe]),Kn=c.useCallback(async()=>{if(!q){alert("No element selected");return}try{const t=new WeakSet,o=JSON.stringify(q,(i,n)=>{if(typeof n=="object"&&n!==null){if(t.has(n))return"[Circular Reference]";t.add(n)}return n instanceof Map?`[Map with ${n.size} entries]`:n instanceof Set?`[Set with ${n.size} items]`:n instanceof WeakMap||n instanceof WeakSet?"[WeakMap/WeakSet]":typeof n=="function"?"[Function]":typeof n=="symbol"?"[Symbol]":n},2);await navigator.clipboard.writeText(o),alert("Raw element data copied to clipboard!")}catch(t){console.error("Failed to copy raw data:",t),alert("Failed to copy data to clipboard. See console for details.")}},[q]),Go=c.useCallback(()=>{lt||(Dr(!1),sr(null))},[lt]),Yn=c.useCallback(async()=>{if(!lt){Ro(!0),sr(null);try{let t=[];if(Ze==="selected"){if(!le.length)throw new Error("No properties available for the current selection.");t=le.map(g=>({path:g.label,value:g.value}))}else{if(!Qe)throw new Error("Select a model to export.");if(t=await _o(Qe),!t.length)throw new Error("No properties were found for the chosen model.")}const o=Bo(t),i=new Blob([o],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(i),d=document.createElement("a"),u=Ze==="selected"?"selection":`model-${Qe}`,h=new Date().toISOString().replace(/[:.]/g,"-");d.href=n,d.download=`fragment-properties-${u}-${h}.csv`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(n),Dr(!1)}catch(t){console.warn("Failed to export properties",t),sr(t.message??"Failed to export properties.")}finally{Ro(!1)}}},[Bo,Qe,Ze,_o,lt,le]),ke=c.useCallback(t=>{const o=t??null;ge(o);const{rows:i}=Ht(o);if(An(i),mo(Ie.length?"favorites":"all"),i.length){Eo(i.map(u=>({path:u.label,value:u.value})));const n="Path	Value",d=i.map(u=>`${u.label}	${u.value??""}`);Po([n,...d].join(`\r
`))}else Eo([]),Po(null)},[Ie.length]),Wo=c.useCallback(()=>{vo(t=>!t)},[]),Xn=c.useCallback(()=>{kr(!0),ho(t=>t+1)},[]),Jn=c.useCallback(()=>{kr(!1)},[]),Uo=c.useCallback(()=>{kr(t=>{const o=!t;return o&&ho(i=>i+1),o})},[]),Zn=c.useCallback(()=>{go(!0)},[]),Ho=c.useCallback(()=>{go(!1)},[]),qo=c.useCallback(()=>{const t=bi();t?(Pr(t.provider),Er(t.apiKey),or(t.model||hr(t.provider))):(Pr("disabled"),Er(""),or("")),yt(null),yo(!0)},[]),ur=c.useCallback(()=>{yo(!1),bo(!1),yt(null)},[]),Qn=c.useCallback(()=>{if(ye==="disabled")xi();else{const t={provider:ye,apiKey:Ge,model:Dt||hr(ye)};yi(t)}ur()},[ye,Ge,Dt,ur]),es=c.useCallback(t=>{Pr(t),or(hr(t)),yt(null)},[]),ts=c.useCallback(async()=>{if(!(!Ge||ye==="disabled")){wo(!0),yt(null);try{let t=!1;const o=Dt||hr(ye);ye==="gemini"?t=await Ci(Ge,o):ye==="openai"&&(t=await ji(Ge,o)),yt(t?"success":"error")}catch{yt("error")}finally{wo(!1)}}},[ye,Ge,Dt]),Lt=c.useCallback(t=>{if(!t||typeof t!="object")return"IfcProduct";if(t.constructor&&typeof t.constructor.name=="string"&&t.constructor.name.toUpperCase().startsWith("IFC")){const d=t.constructor.name.trim();if(d!=="Object"&&d!=="Array")return d}const o=Ee(t._category??t.category??t.Category??null);if(o&&o.trim().length&&o.toUpperCase().startsWith("IFC"))return o.trim();const i=[t.expressID!==void 0?null:t.type,t.ifcClass,t.IfcClass,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.ifcType,t.IfcType,t?.attributes?.ifcClass,t?.Attributes?.IfcClass];for(const d of i)if(typeof d=="string"&&d.trim().length){const u=d.trim();if(u.toUpperCase().startsWith("IFC")&&!u.toUpperCase().includes("IDENTIFIER")&&!u.toUpperCase().includes("LABEL")&&!u.toUpperCase().includes("TEXT"))return u}const n=he(t,["ifcclass","ifc type","express type"]);return n&&n.toUpperCase().startsWith("IFC")?n:"IfcProduct"},[]),Br=c.useCallback((t,o,i)=>{const n={},d={},u={};Ut(t).forEach(R=>{const z=R.label.split("/").map(L=>L.trim()),T=R.rawPsetName??z[1]??"",S=R.rawPropertyName??z[z.length-1]??"",w=tt(T),P=tt(S);if(!w||!P)return;d[w]||(d[w]={}),P in d[w]||(d[w][P]=R.value);const _=`${w}.${P}`;_ in n||(n[_]=R.value)}),n.GlobalId=o,n.ifcClass=i,u.ifcClass=i,u.GlobalId=o,n["Attributes.GlobalId"]=o,n["Attributes.IfcClass"]=i,n["Attributes.ifcClass"]=i;const g=Fe(t);g&&(u.Name=g,n["Attributes.Name"]=g);const y=he(t,["category","ifccategory"]);y&&(u.Category=y,n["Attributes.Category"]=y);const I=he(t,["type","typename"]);I&&(u.Type=I,n["Attributes.Type"]=I);for(const[R,z]of Object.entries(t??{})){if(z==null||typeof z!="object"||Array.isArray(z))continue;const T=Ee(z);if(!T)continue;const S=String(R).replace(/^_+/,""),w=`Attributes.${He(S)}`;if(w in n||(n[w]=T),S in u||(u[S]=T),/guid|globalid|_guid/i.test(R)){const P=String(T).trim();P&&!n.GlobalId&&(n.GlobalId=P,u.GlobalId=P)}}return{flattened:n,psets:d,attributes:u}},[]),Gr=c.useCallback(()=>{const t=l.current;return t?`${Array.from(t.list.keys()).sort().join("|")}|${j.length}`:"empty"},[j]),rs=c.useCallback(async()=>{const t=l.current;if(!t||t.list.size===0)return{signature:"empty",elementCount:0,modelFiles:[]};const o=Array.from(t.list.keys()).sort(),i=j.map(g=>({id:g.id,name:g.label}));let n=0;for(const[g,y]of t.list)try{const I=await y.getLocalIds(),R=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[];n+=R.length}catch(I){console.error(`âŒ [computeModelSignature] Failed to count elements in model ${g}`,I)}return{signature:[...o,...j.map(g=>`${g.id}:${g.label}`),`count:${n}`].join("|"),elementCount:n,modelFiles:i}},[j]),fr=c.useCallback(async()=>{const t=l.current;if(!t||t.list.size===0){const n={signature:"empty",records:new Map,elements:[],modelLocalIds:new Map};return Te.current=n,n}const o=Gr();if(Te.current&&Te.current.signature===o)return Te.current;if(Mt.current)return Mt.current;const i=(async()=>{const n=new Map,d=[],u=new Map;for(const[g,y]of t.list){let I=[];try{const z=await y.getLocalIds();Array.isArray(z)?I=z:z&&typeof z[Symbol.iterator]=="function"&&(I=Array.from(z))}catch(z){console.warn(`IDS cache: failed to read local IDs for model ${g}`,z);continue}if(u.set(g,I.slice()),!I.length)continue;const R=48;for(let z=0;z<I.length;z+=R){const T=I.slice(z,z+R);let S=[];try{S=await y.getItemsData(T,je)}catch(w){console.warn(`IDS cache: failed to fetch items data for model ${g}`,w);continue}S.forEach((w,P)=>{if(!w)return;const _=T[P],L=Lt(w),V=typeof w.GlobalId=="string"&&w.GlobalId.trim()||typeof w.GlobalID=="string"&&w.GlobalID.trim()||he(w,["globalid","global id","guid"]);if(!V){if(nl(L,w))return;console.warn("IDS cache: missing GlobalId for localId",{modelId:g,localId:_,itemData:w});return}const N=V.trim();if(!N.length||n.has(N))return;const{flattened:$,psets:B,attributes:Y}=Br(w,N,L),Q={GlobalId:N,ifcClass:L,properties:$},G=w;(typeof G.GlobalId!="string"||!G.GlobalId.trim())&&(G.GlobalId=N),n.set(N,{element:Q,modelId:g,localId:_,psets:B,attributes:Y,raw:G}),d.push(Q)})}}const h={signature:o,records:n,elements:d,modelLocalIds:u};return Te.current=h,h})().finally(()=>{Mt.current=null});return Mt.current=i,i},[Gr,Br,Lt]),It=c.useCallback(async t=>{const o=new Map,i=l.current;if(!i)return console.error("ðŸ” [groupLocalIdsByModel] Fragments not available"),{grouped:o,cache:Te.current};for(const[n,d]of i.list)try{const u=await d.getLocalIdsByGuids(t),h=[];for(let g=0;g<u.length;g++){const y=u[g];y!==null&&h.push(y)}h.length>0&&o.set(n,h)}catch(u){console.warn(`ðŸ” [groupLocalIdsByModel] Failed for model ${n}:`,u)}return{grouped:o,cache:Te.current}},[]),Wr=Et.useMemo(()=>({listGlobalIds:async()=>(await fr()).elements.map(o=>o.GlobalId),getSelectedGlobalIds:async()=>{const t=Be.current;if(!t||t.length===0)return[];const o=l.current;if(!o)return console.warn("ðŸ“ Fragments not available"),[];const i=[];for(const n of t){const d=o.list.get(n.modelId);if(!d){console.warn("ðŸ“ Model not found for item:",n);continue}try{const[u]=await d.getItemsData([n.localId],{attributesDefault:!1});if(u){const h=he(u,["globalid","global id","guid"]);h&&typeof h=="string"?i.push(h):console.warn("ðŸ“ No GlobalId found in data for item:",n)}}catch(u){console.error("ðŸ“ Error fetching data for item:",n,u)}}return i},getVisibleGlobalIds:async()=>{const t=l.current;if(!t)return console.warn("ðŸ‘ï¸ Fragments not available"),[];const o=[];for(const[i,n]of t.list)try{const d=await n.getItemsByVisibility(!0);if(d.length===0)continue;const u=100;for(let h=0;h<d.length;h+=u){const g=d.slice(h,Math.min(h+u,d.length));try{const y=await n.getItemsData(g,{attributesDefault:!1,attributes:["GlobalId"]});for(const I of y){const R=he(I,["globalid","global id","guid"]);R&&typeof R=="string"&&o.push(R)}}catch(y){console.error(`ðŸ‘ï¸ Error fetching GlobalIds for batch in model ${i}:`,y)}}}catch(d){console.error(`ðŸ‘ï¸ Error getting visible elements from model ${i}:`,d)}return o},getElementProps:async t=>{const o=l.current;if(!o)throw new Error("Fragments not available");for(const[i,n]of o.list)try{const u=(await n.getLocalIdsByGuids([t]))[0];if(u!=null){const[h]=await n.getItemsData([u],je);if(!h){console.warn(`ðŸ” [getElementProps] No data returned for localId ${u}`);continue}const g=Lt(h),y={},I={};Ut(h).forEach(w=>{const P=w.label.split("/").map($=>$.trim()),_=w.rawPsetName??P[1]??"",L=w.rawPropertyName??P[P.length-1]??"",V=tt(_),N=tt(L);!V||!N||(y[V]||(y[V]={}),N in y[V]||(y[V][N]=w.value))}),I.ifcClass=g,I.GlobalId=t;const z=Fe(h);z&&(I.Name=z);const T=he(h,["category","ifccategory"]);T&&(I.Category=T);const S=he(h,["type","typename"]);return S&&(I.Type=S),{ifcClass:g,psets:y,attributes:I}}}catch(d){console.warn(`ðŸ” [getElementProps] Error in model ${i}:`,d);continue}throw console.error(`ðŸ” [getElementProps] Element with GlobalId ${t} not found in any model`),new Error(`Element with GlobalId ${t} is not available.`)},getElementPropsFast:async t=>{const o=Be.current,i=l.current;if(!i)throw console.error("ðŸ” [getElementPropsFast] Fragments not available!"),new Error("Fragments not available");for(let n=0;n<o.length;n++){const d=o[n],u=i.list.get(d.modelId);if(u)try{const[h]=await u.getItemsData([d.localId],je);if(h&&he(h,["globalid","global id","guid"])===t){const y=Lt(h),I={},R={};Ut(h).forEach(P=>{const _=P.label.split("/").map(B=>B.trim()),L=P.rawPsetName??_[1]??"",V=P.rawPropertyName??_[_.length-1]??"",N=tt(L),$=tt(V);!N||!$||(I[N]||(I[N]={}),$ in I[N]||(I[N][$]=P.value))}),R.ifcClass=y,R.GlobalId=t;const T=Fe(h);T&&(R.Name=T);const S=he(h,["category","ifccategory"]);S&&(R.Category=S);const w=he(h,["type","typename"]);return w&&(R.Type=w),{ifcClass:y,psets:I,attributes:R}}}catch(h){console.error("ðŸ” [getElementPropsFast] Error for item:",d,h)}}return ht.current.getElementProps(t)},countElements:async()=>(await fr()).elements.length,iterElements:t=>{const o=Math.max(1,Math.floor(t?.batchSize??500));return{async*[Symbol.asyncIterator](){const i=l.current;if(!i||i.list.size===0){console.warn("âš ï¸ [viewerApi.iterElements] No fragments available");return}let n=[],d=0;for(const[u,h]of i.list){let g=[];try{const I=await h.getLocalIds();g=Array.isArray(I)?I:I&&typeof I[Symbol.iterator]=="function"?Array.from(I):[]}catch(I){console.error(`âŒ [viewerApi.iterElements] Failed to get local IDs for model ${u}`,I);continue}const y=Math.min(500,Math.max(100,o));for(let I=0;I<g.length;I+=y){const R=g.slice(I,I+y);try{const z=await h.getItemsData(R,je);for(let T=0;T<z.length;T++){const S=z[T];S&&n.push({modelId:u,localId:R[T],data:S})}for(;n.length>=o;){const T=n.splice(0,o);d+=T.length,d%5e3,yield T}}catch(z){console.error(`âŒ [viewerApi.iterElements] Failed to fetch chunk at ${I}`,z)}}}n.length>0&&(d+=n.length,yield n)}}},_iterElementsLegacy:t=>{const o=Math.max(1,Math.floor(t?.batchSize??100));return{async*[Symbol.asyncIterator](){const i=await fr(),n=Array.from(i.records.values());for(let d=0;d<n.length;d+=o){const u=n.slice(d,d+o).map(h=>({modelId:h.modelId,localId:h.localId,data:{...h.raw,GlobalId:h.element.GlobalId}}));u.length&&(yield u)}}}},buildIdsCache:async()=>{try{return(await fr()).elements.length}catch(t){throw console.error("viewerApi.buildIdsCache failed",t),t}},getModelSignature:async()=>await rs(),addToCache:async t=>{const o=l.current;if(!o){console.warn("ðŸ“¦ [addToCache] Fragments not available");return}let i=Te.current;i||(i={signature:Gr(),records:new Map,elements:[],modelLocalIds:new Map},Te.current=i);const n=Be.current;for(const d of t){if(i.records.has(d))continue;let u=!1;for(const h of n){const g=o.list.get(h.modelId);if(g)try{const[y]=await g.getItemsData([h.localId],je);if(y){let I=y._guid||y.GlobalId;if(I&&typeof I=="object"&&(I=I.value||I),I===d){const R=Lt(y),z={};Ut(y).forEach($=>{const B=$.label.split("/").map(ne=>ne.trim()),Y=$.rawPsetName??B[1]??"",Q=$.rawPropertyName??B[B.length-1]??"",G=tt(Y),ae=tt(Q);!G||!ae||(z[G]||(z[G]={}),ae in z[G]||(z[G][ae]=$.value))});const S={ifcClass:R,GlobalId:d},w=Fe(y);w&&(S.Name=w);const P=he(y,["category","ifccategory"]);P&&(S.Category=P);const _=he(y,["type","typename"]);_&&(S.Type=_);const L={GlobalId:d,ifcClass:R,properties:Br(y,d,R)},V={element:L,modelId:h.modelId,localId:h.localId,psets:z,attributes:S,raw:y};i.records.set(d,V),i.elements.push(L);const N=i.modelLocalIds.get(h.modelId)||[];N.push(h.localId),i.modelLocalIds.set(h.modelId,N),u=!0;break}}}catch(y){console.debug("ðŸ“¦ [addToCache] Error checking selection item:",y)}}u||console.warn(`ðŸ“¦ [addToCache] Could not find ${d} in selection`)}},color:async(t,o)=>{if(!t.length)return;const i=ze.current,n=l.current,d=a.current;if(!i||!p.current||!n||!d)return;let u,h;try{const I=await It(t);u=I.grouped,h=I.cache}catch(I){console.error("ðŸŽ¨ [color] groupLocalIdsByModel failed:",I);return}const g=new De(o.r,o.g,o.b),y=g.getHex();Xt.current||(Xt.current=new Map);for(const[I,R]of u){const z=n.list.get(I);if(!(!z||!R.length))try{const T=Array.from(R);if(typeof i.add=="function")try{if(i.add(z,T,y),d&&typeof d.update=="function")try{d.update()}catch(S){console.debug("World update failed:",S)}continue}catch(S){console.debug("add failed:",S)}if(typeof i.highlightById=="function")try{await i.highlightById(z,T,y);continue}catch(S){console.debug("highlightById failed:",S)}if(typeof i.highlightByID=="function")try{await i.highlightByID(z,T,y);continue}catch(S){console.debug("highlightByID failed:",S)}if(i.styles&&typeof i.styles.set=="function")try{if(!T||T.length===0){console.debug(`Skipping highlight for model ${I} - no IDs`);continue}const S=`ids-color-${y.toString(16).padStart(6,"0")}`;if(i.styles.set(S,{color:g,fillOpacity:1}),typeof i.create=="function")try{(!i.list||!i.list.has(S))&&i.create(S)}catch(w){console.debug("highlighter.create failed:",w)}if(typeof i.select=="function")try{i.select(z,T,S)}catch(w){throw console.debug("highlighter.select failed:",w),w}continue}catch(S){console.debug("styles.set failed:",S)}console.warn(`âŒ Could not color model ${I} - all highlighter methods failed`)}catch(T){console.error(`Failed to color model ${I}:`,T)}}},clearColors:async()=>{const t=ze.current,o=l.current;if(!p.current||!o)return;const i=jo.current;if(i.size>0){for(const[n,d]of i){const{color:u,transparent:h,opacity:g}=d;n.transparent=h,n.opacity=g,"color"in n?n.color.setHex(u):n.lodColor.setHex(u),n.needsUpdate=!0}i.clear()}t&&Nt.current&&(t.enabled=!0,Nt.current=!1),o&&(o.resetHighlight(),o.core.update(!0));try{if(t){if(t.styles&&typeof t.styles.delete=="function")try{t.styles.delete("ghost")}catch(n){console.warn("Failed to clear ghost styles",n)}typeof t.clear=="function"&&await Promise.resolve(t.clear()),t.styles&&typeof t.styles.clear=="function"&&t.styles.clear()}}catch(n){console.warn("Failed to clear IDS highlights",n)}Xt.current&&Xt.current.clear();try{const n=Ve.current;if(n&&n.mesh&&n.mesh.instanceColor){const d=new De(1,1,1);n.mesh.setColorAt(n.index,d),n.mesh.instanceColor.needsUpdate=!0}}catch{}},isolate:async t=>{const o=_e.current,i=l.current;if(!o||!i||!p.current||(await Promise.resolve(o.set(!0)),!t.length||!p.current))return;const{grouped:n}=await It(t);if(n.size===0){console.warn("isolate: No elements found in cache for isolation");return}const d=new Map;n.forEach((h,g)=>{d.set(g,new Set(h))});const u={};for(const[h,g]of d.entries()){const y=i.list.get(h);if(y)try{let I=[];const R=await y.getLocalIds();Array.isArray(R)?I=R:R&&typeof R[Symbol.iterator]=="function"&&(I=Array.from(R));const z=I.filter(T=>!g.has(T));z.length>0&&(u[h]=new Set(z))}catch(I){console.error("isolate: Failed to get local IDs for model",h,I)}}Object.keys(u).length>0&&await Promise.resolve(o.set(!1,u))},clearIsolation:async()=>{const t=_e.current;t&&await Promise.resolve(t.set(!0))},ghost:async t=>{const o=l.current,i=ze.current;if(!o||!p.current||!i)return;const{grouped:n}=await It(t);if(n.size===0)return;const d={};for(const[g,y]of n.entries())d[g]=new Set(y);i.enabled=!1,Nt.current=!0;const u=[...o.core.models.materials.list.values()],h=jo.current;for(const g of u){if(g.userData.customId)continue;let y;"color"in g?y=g.color.getHex():y=g.lodColor.getHex(),h.set(g,{color:y,transparent:g.transparent,opacity:g.opacity}),g.transparent=!0,g.opacity=.05,g.needsUpdate=!0,"color"in g?g.color.setColorName("white"):g.lodColor.setColorName("white")}if(Object.keys(d).length>0)try{o.highlight({customId:"filter-ghost",color:new De(16750592),renderedFaces:1,opacity:1,transparent:!1},d)}catch{}o.core.update(!0)},getItemsData:async(t,o)=>{const i=l.current;if(!i)return console.error("ðŸ” [getItemsData] Fragments not available"),[];const{grouped:n}=await It(t),d=[];for(const[u,h]of n.entries()){const g=i.list.get(u);if(g)try{const y=await g.getItemsData(Array.from(h),o);d.push(...y)}catch(y){console.error(`ðŸ” [getItemsData] Failed for model ${u}`,y)}}return d},getItemsByCategory:async t=>{const o=l.current;if(!o)return console.error("ðŸ” [getItemsByCategory] Fragments not available"),{};const i={};for(const[n,d]of o.list)try{const u=await d.getItemsOfCategories(t);if(u&&Object.keys(u).length>0){const h=Object.values(u).flat();h.length>0&&(i[n]=h)}}catch(u){console.error(`ðŸ” [getItemsByCategory] Failed for model ${n}`,u)}return i},getItemsDataByModel:async(t,o,i)=>{const n=l.current;if(!n)return console.error("ðŸ” [getItemsDataByModel] Fragments not available"),[];const d=n.list.get(t);if(!d)return console.error(`ðŸ” [getItemsDataByModel] Model ${t} not found`),[];try{return await d.getItemsData(o,i)}catch(u){return console.error(`ðŸ” [getItemsDataByModel] Failed for model ${t}`,u),[]}},fitViewTo:async t=>{if(!t.length)return;const o=a.current,i=l.current;if(!o||!i||!p.current)return;const n=o.camera??null,d=n?.controls??null,u=n?.three??null,{grouped:h}=await It(t),g=new rt;let y=!1;for(const[S,w]of h.entries()){const P=i.list.get(S);if(!P||!P.object)continue;const _=new rt().setFromObject(P.object);_.isEmpty()||(y?g.union(_):(g.copy(_),y=!0))}if(!y)return;const I=new J,R=new J;g.getCenter(I),g.getSize(R);const T=(Math.max(R.x,R.y,R.z)||10)*1.5;d?d.setLookAt(I.x+T,I.y+T,I.z+T,I.x,I.y,I.z,!0):u&&(u.position.set(I.x+T,I.y+T,I.z+T),u.lookAt(I))}}),[It]);ht.current=Wr;const os=c.useCallback(()=>{rr(!0),zr(t=>t+1)},[]),ns=c.useCallback(()=>{rr(!1);const t=ht.current;t&&(Promise.resolve(t.clearColors()).catch(()=>{}),t.clearIsolation&&Promise.resolve(t.clearIsolation()).catch(()=>{}))},[]),Ko=c.useCallback(()=>{rr(t=>{const o=!t;return o&&zr(i=>i+1),o})},[]),ss=c.useCallback(async t=>{try{const{setIdsXmlText:o,runCheck:i}=await Pt(()=>Promise.resolve().then(()=>Wi),void 0).then(n=>n.idsStore);o(t),rr(!0),zr(n=>n+1),setTimeout(async()=>{ht.current&&await i(ht.current)},100)}catch(o){console.error("Failed to validate from IDS Creator:",o),alert("Error: Could not run validation. See console for details.")}},[]);c.useEffect(()=>{Be.current=v},[v]),c.useEffect(()=>{Te.current=null,Mt.current=null;try{kn.invalidateCaches()}catch(t){console.warn("Failed to invalidate IDS caches",t)}},[j]),c.useEffect(()=>{const t=e.current;if(!t)return;let o=!1;lo.current||(Ys.init(),Xs.init(),lo.current=!0);try{t.replaceChildren()}catch{}const i=new Js;x.current=i;const d=i.get(Zs).create();d.name="main",d.scene=new Qs(i),d.scene.setup(),d.renderer=new ei(i,t);const u=d.renderer.three;u.shadowMap.enabled=!1,u.sortObjects=!1,d.camera=new ti(i),d.camera.controls?.setLookAt(10,10,10,0,0,0),d.camera.three.near=.1,d.camera.three.far=1e9,d.camera.three.updateProjectionMatrix();const h=d.camera.controls;h&&($o.current=h,"mouseButtons"in h&&(h.mouseButtons={left:1,middle:2,right:0,wheel:16}),"dollySpeed"in h&&(h.dollySpeed=1));const g=new li(16777215,1);d.scene.three.add(g),a.current=d;const y=new Es;y.showPanel(2),y.dom.style.position="absolute",y.dom.style.left="8px",y.dom.style.top="8px",y.dom.style.zIndex="1000",t.appendChild(y.dom),d.renderer.onBeforeUpdate.add(()=>y.begin()),d.renderer.onAfterUpdate.add(()=>y.end());let I=null;const R=async S=>{if(!p.current)return;const w=[];for(const[$,B]of Object.entries(S))B.forEach(Y=>{Number.isInteger(Y)&&w.push({modelId:$,localId:Y})});const P=Be.current;if(!!oo(w,P))return;M(w),Ct();const L=l.current;if(!L||!w.length){ke(null);return}const V=w[0],N=L.list.get(V.modelId);if(!N){ke(null);return}try{const[$]=await N.getItemsData([V.localId],je);ke($||null)}catch($){console.warn("Failed to fetch properties for selection",$)}},z=()=>{Rr.current||Nt.current||(M([]),ke(null))};return(async()=>{try{await Promise.resolve(i.init())}catch(N){console.error("Failed to initialize viewer components",N);return}if(o)return;try{i.get(ri).create(d)}catch(N){console.warn("Failed to create grid component",N)}const w=await(await fetch("https://thatopen.github.io/engine_fragment/resources/worker.mjs")).blob(),P=URL.createObjectURL(new File([w],"worker.mjs",{type:"text/javascript"}));E.current=P;const _=i.get(oi);await _.init(P),l.current=_,p.current=!0;const L=i.get(ni);L.setup({world:d}),L.zoomToSelection=!0;try{typeof L.create=="function"&&L.create("select");let N=0;const $=10;for(;N<$&&(!L.selection||!L.selection.select);)await new Promise(B=>setTimeout(B,20)),N++;(!L.selection||!L.selection.select)&&console.warn("Highlighter selection system still initializing (non-blocking)")}catch(N){console.warn("Error during highlighter initialization:",N)}ze.current=L;const V=i.get(si);_e.current=V;try{const N=i.get(ii);if(N.world=d,N.color=new De("#ff0000"),"snapDistance"in N&&(N.snapDistance=.5),"preview"in N){const $=N.preview;$&&($.enabled=!0,$.color&&($.color=new De("#00ff00")))}if("workingPlane"in N){const $=N.workingPlane;$&&typeof $=="object"&&($.visible=!0)}N.list?.onItemAdded&&N.list.onItemAdded.add($=>{const B=$.value||$.distance?.()||0;To(B.toFixed(3)),$.dimensionLabel&&($.dimensionLabel.visible=!0)}),N.enabled=!1,lr.current=N}catch(N){console.error("Failed to initialize measurement tool:",N)}L.events.select.onHighlight.add(R),L.events.select.onClear.add(z),I=()=>{L.events.select.onHighlight.remove?.(R),L.events.select.onClear.remove?.(z)},at()?.controls?.addEventListener("rest",()=>_.core.update(!0));try{const $=(await Pt(()=>import("./thatopen-vendor-byvyd1e5.js").then(Q=>Q.i),__vite__mapDeps([2,3,1]))).IfcImporter,B=new $,Y="/Savora-Viewer/";B.wasm={path:`${Y}web-ifc/`,absolute:!0},b.current=B}catch(N){console.warn("Failed to lazy-load FRAGS.IfcImporter:",N)}o||Le(!0)})().catch(S=>{console.error("Failed to initialize viewer fragments",S)}),()=>{o=!0,(async()=>{const S=p.current;p.current=!1,I?.(),I=null;try{S&&await _e.current?.set?.(!0)}catch{}if(l.current){const w=[...l.current.list.keys()];await Promise.all(w.map(P=>l.current.core.disposeModel(P)))}try{S&&ze.current?.clear?.()}catch{}E.current&&URL.revokeObjectURL(E.current);try{i.dispose()}catch{}try{t.replaceChildren()}catch{}ze.current=null,_e.current=null})()}},[]),c.useEffect(()=>{if(!be)return;const t=x.current,o=l.current;if(!t||!o)return;const i=dr,n=(d,u,h)=>{if(!d)return;let g=u.current;g||(g=h(),u.current=g),g&&g.parentElement!==d&&d.replaceChildren(g)};n(ao.current,nt,()=>{const[d,u]=fn.modelsList({components:t});return jr.current=u,d}),nt.current&&((!nt.current.dataset.initialized||i!==uo.current)&&jr.current?.({components:t}),nt.current.dataset.initialized||(nt.current.dataset.initialized="true",nt.current.style.width="100%")),er.current!==co.current&&(vr.current=null,zt.current=null,co.current=er.current),n(er.current,vr,()=>{const[d,u]=fn.spatialTree({components:t,models:Array.from(o.list.values())});zt.current=u,d.style.width="100%",d.style.height="100%",d.style.overflow="auto";const h=d;return h.queryString=gt.trim()?gt.trim():null,d}),zt.current&&zt.current({components:t,models:Array.from(o.list.values())}),uo.current=i},[be,Z,gt,dr]),c.useEffect(()=>{if(!be)return;const t=x.current,o=l.current,i=zt.current;!t||!o||!i||i({components:t,models:Array.from(o.list.values())})},[be,dr]),c.useEffect(()=>{const t=vr.current;if(!t)return;const o=gt.trim();t.queryString=o||null},[gt]);const is=async()=>{const t=s.current,o=t?.files?.[0];if(!o)return;const i=o.name.split(".").pop()?.toLowerCase(),n=l.current,d=b.current,u=a.current;if(!n||!u){alert("Viewer is still initializing. Please try again in a moment."),t&&(t.value="");return}const h=at(),g=h?.three??null,y=h?.controls??null;let I=!1;try{const R=`${o.name}-${Date.now()}`;let z;if(i==="ifc"){if(!d)throw new Error("IFC importer is not ready.");qe(0),I=!0,Ke.current=!1,Oe(!1);const P=new AbortController;Rt.current=P;const _=new Uint8Array(await o.arrayBuffer()),L=await d.process({bytes:_,progressCallback:(N,$)=>{if(Ke.current)return;const B=typeof N=="number"?N:0,Y=B<=1?B*100:B,Q=Math.max(0,Math.min(100,Y));qe(Number(Q.toFixed(1)))},signal:P.signal});if(Ke.current)throw{__cancelled:!0};let V;if(L instanceof ArrayBuffer){const N=new Uint8Array(L),$=new Uint8Array(N.byteLength);$.set(N),V=$.buffer}else if(L instanceof Uint8Array){const N=new Uint8Array(L.byteLength);N.set(L),V=N.buffer}else{const N=L,$=new Uint8Array(N),B=new Uint8Array($.byteLength);B.set($),V=B.buffer}z=await n.core.load(V,{modelId:R})}else if(i==="frag"){const P=await o.arrayBuffer();z=await n.core.load(P,{modelId:R})}else{alert("Unsupported file type. Please choose a .ifc or .frag file.");return}m.current=R,g?z.useCamera(g):console.warn("World camera not ready; skipping model camera binding."),u.scene.three.add(z.object),await n.core.update(!0),await new Promise(P=>requestAnimationFrame(()=>P()));const T=new rt().setFromObject(z.object),S=new J;T.getCenter(S),(Math.abs(S.x)>1e6||Math.abs(S.y)>1e6||Math.abs(S.z)>1e6)&&z.object.position.sub(S);try{y&&await y.fitToBox(z.object,!0)}catch{const P=new J;T.getSize(P);const L=(Math.max(P.x,P.y,P.z)||10)*2.5;y?y.setLookAt(S.x+L,S.y+L,S.z+L,S.x,S.y,S.z,!0):g&&(g.position.set(S.x+L,S.y+L,S.z+L),g.lookAt(S))}Gn(P=>({...P,[R]:Ji(R,o.name,z.object)})),k(!0),O(P=>[...P,{id:R,label:o.name}]),Ct();const w=x.current;w&&jr.current?.({components:w}),I&&qe(100)}catch(R){R&&(R.__cancelled||R?.name==="AbortError")||(console.error(R),alert("Failed to load model. See console for more details.")),k(!1)}finally{t&&(t.value=""),I&&setTimeout(()=>qe(null),200),Rt.current=null,Oe(!1)}},ls=c.useCallback(()=>{if(we!==null){Ke.current=!0,Oe(!0);try{Rt.current?.abort()}catch{}qe(null)}},[we]),Ct=c.useCallback(()=>{X(!0),K(!1)},[]),Yo=c.useCallback(()=>{X(t=>{const o=!t;return o&&K(!1),o})},[]),as=c.useCallback(()=>{X(!1)},[]),cs=c.useCallback(()=>{K(t=>!t)},[]),Xo=c.useMemo(()=>Math.min(360,Math.max(180,Zt.height*.45)),[Zt.height]),ds=+!Dn+ +!Nn,Ur=!Mn&&ds===0;c.useEffect(()=>{const t=nt.current;t&&(t.style.width="100%",t.style.maxHeight=Ur?"100%":`${Xo}px`,t.style.height=Ur?"100%":"auto")},[Ur,Xo,dr]);const us=c.useCallback(async t=>{const o=w=>{const P=[],_=new Set;if(!w||typeof w!="object")return{terms:P,modelIds:_};for(const[L,V]of Object.entries(w)){if(V==null)continue;const N=L.trim().toLowerCase(),$=Array.isArray(V)?V:[V];if($.length){if(N==="modelid"||N==="modelids"||N==="model"){for(const B of $){const Y=typeof B=="string"?B.trim():String(B??"").trim();Y&&_.add(Y)}continue}if(["text","query","keyword","search"].includes(N)){for(const B of $){if(B==null)continue;const Y=typeof B=="string"?B.trim().toLowerCase():String(B??"").trim().toLowerCase();Y&&P.push({type:"text",value:Y})}continue}for(const B of $){if(B==null)continue;let Y=null;typeof B=="string"?Y=B.trim():(typeof B=="number"||typeof B=="boolean")&&(Y=String(B)),Y&&P.push({type:"field",key:N,value:Y.toLowerCase()})}}}return{terms:P,modelIds:_}},i=l.current;if(!i){console.warn("AI selection requested but fragments are unavailable.");return}if(!p.current){console.warn("AI selection requested before fragments were fully initialized.");return}const n=ze.current,d=_e.current,{terms:u,modelIds:h}=o(t.filter),g=t.mode?.toLowerCase?.(),y=g==="isolate"||g==="focus";if(t.action==="clear"){try{n?.clear?.()}catch{}if(d)try{await d.set(!0)}catch(w){console.warn("Failed to reset visibility while clearing AI selection",w)}try{const w=Ve.current;if(w&&w.mesh&&w.mesh.instanceColor){const P=new De(1,1,1);w.mesh.setColorAt(w.index,P),w.mesh.instanceColor.needsUpdate=!0}}catch{}Ve.current=null,Re.current&&(Re.current.visible=!1),M([]),ke(null);return}if(u.length===0){console.warn("AI selection command did not include usable filters",t);return}const I=++Yt.current,R=[],z=60;for(const w of i.list.values()){const P=typeof w?.modelId=="string"?w.modelId:"";if(h.size&&!h.has(P))continue;let _=[];try{const V=await w.getLocalIds();Array.isArray(V)?_=V.slice():V&&typeof V[Symbol.iterator]=="function"&&(_=Array.from(V))}catch(V){console.warn("Failed to fetch local IDs for model",P,V)}const L={model:w,modelId:P,allIds:_,matched:new Set};if(R.push(L),!!_.length)for(let V=0;V<_.length;V+=z){if(I!==Yt.current)return;const N=_.slice(V,V+z);let $=[];try{$=await w.getItemsData(N,je)}catch(B){console.warn("Failed to retrieve property batch for AI selection",B);continue}N.forEach((B,Y)=>{const Q=$?.[Y];if(!Q)return;let G=[];try{G=Ht(Q).rows}catch(pe){console.warn("Failed to build property rows for AI selection",pe)}const ae=G.map(pe=>pe.searchText),ne=wr(Q,6e3).toLowerCase();u.every(pe=>{if(pe.type==="text")return ae.some(ue=>ue.includes(pe.value))||ne.includes(pe.value);const me=Yi[pe.key]??[pe.key];return ae.some(ue=>me.some(dt=>ue.includes(dt))&&ue.includes(pe.value))?!0:me.some(ue=>ne.includes(ue)&&ne.includes(pe.value))})&&L.matched.add(B)})}}if(I!==Yt.current)return;const T=R.filter(w=>w.matched.size>0);if(!T.length)return;try{const w=Ve.current;if(w&&w.mesh&&w.mesh.instanceColor){const P=new De(1,1,1);w.mesh.setColorAt(w.index,P),w.mesh.instanceColor.needsUpdate=!0}}catch{}if(Ve.current=null,Re.current&&(Re.current.visible=!1),d)try{await d.set(!0)}catch(w){console.warn("Failed to reset hidden state before AI selection",w)}if(n){try{n.clear?.()}catch{}const w=y?16754240:6737151;for(const P of T){const _=Array.from(P.matched);if(_.length)try{typeof n.highlightById=="function"?await n.highlightById(P.model,_,w):typeof n.highlightByID=="function"?await n.highlightByID(P.model,_,w):typeof n.add=="function"&&n.add(P.model,_,w)}catch(L){console.warn("Failed to apply AI highlight for model",P.modelId,L)}}}if(y&&d){const w={};for(const P of R){if(!P.allIds.length||P.matched.size===P.allIds.length)continue;const _=P.allIds.filter(L=>!P.matched.has(L));_.length&&(w[P.modelId]=new Set(_))}if(Object.keys(w).length)try{await d.set(!1,w)}catch(P){console.warn("Failed to isolate AI-selected elements",P)}}const S=T.flatMap(w=>Array.from(w.matched).map(P=>({modelId:w.modelId,localId:P})));M(S),Ct();try{const w=T[0],P=Array.from(w.matched)[0];if(P!==void 0){const[_]=await w.model.getItemsData([P],je);I===Yt.current&&ke(_||null)}}catch(w){console.warn("Failed to fetch properties for AI selection result",w)}},[Ct,M,ke]),pr=c.useCallback(t=>{if(!Qt.current)return;const o=Cr.current;if(!o)return;const i=t.clientX-o.startX,n=t.clientY-o.startY,d=280,u=260;En(h=>{const g=o.width,y=o.height,I=Math.max(d,g+i),R=Math.max(u,y+n);return I===h.width&&R===h.height?h:{width:Math.round(I),height:Math.round(R)}})},[]),Vt=c.useCallback(()=>{Qt.current&&(Qt.current=!1,Cr.current=null,window.removeEventListener("pointermove",pr),window.removeEventListener("pointerup",Vt))},[pr]),fs=c.useCallback(t=>{t.preventDefault(),t.stopPropagation();const o=Sr.current;o&&(Qt.current=!0,Cr.current={startX:t.clientX,startY:t.clientY,width:o.offsetWidth,height:o.offsetHeight},window.addEventListener("pointermove",pr),window.addEventListener("pointerup",Vt))},[pr,Vt]);c.useEffect(()=>()=>{Vt()},[Vt]);const ps=c.useCallback(async()=>{const t=l.current,o=[];if(!t||t.list.size===0||j.length===0)o.push("No models are currently loaded in the viewer.");else{o.push(`Loaded models (${j.length}): ${j.map(n=>`${n.label} [${n.id}]`).join(", ")}`),o.push(`Fragments models in memory: ${t.list.size}`);try{const n=new rt;for(const u of t.list.values())n.expandByObject(u.object);const d=new J;n.getSize(d),o.push(`Scene bounds approx size => x:${d.x.toFixed(2)} y:${d.y.toFixed(2)} z:${d.z.toFixed(2)}`)}catch(n){console.warn("Failed to compute bounds for AI context",n)}const i=j.map(n=>ko[n.id]).filter(n=>!!n);if(i.length){let n=0;const d=new Map;o.push("Model geometry snapshots:");for(const h of i){n+=h.elementCount;for(const{category:y,count:I}of h.categoryCounts)d.set(y,(d.get(y)??0)+I);const g=h.categoryCounts.slice(0,5).map(({category:y,count:I})=>`${y}: ${I}`);o.push(`- ${h.label} [${h.modelId}] â†’ elementsâ‰ˆ${h.elementCount}, instancedâ‰ˆ${h.instancedCount}, meshesâ‰ˆ${h.meshCount}`),g.length&&o.push(`  top categories: ${g.join(" | ")}`),o.push(`  bbox size (approx): x:${h.bboxSize.x.toFixed(2)} y:${h.bboxSize.y.toFixed(2)} z:${h.bboxSize.z.toFixed(2)}`)}const u=Array.from(d.entries()).sort((h,g)=>g[1]-h[1]).slice(0,10).map(([h,g])=>`${h}: ${g}`);o.push(`Global approx element total: ${n}`),u.length&&o.push(`Global top categories: ${u.join(" | ")}`)}else o.push("Geometry summaries are initializing â€” load a model or wait a moment after loading.")}if(v.length){o.push(`Active selection count: ${v.length}`);for(let i=0;i<v.length;i+=1){const n=v[i];o.push(`Selection #${i+1} â†’ modelId:${n.modelId}, localId:${n.localId}`);let d=null;if(i===0&&q&&Object.keys(q).length)d=q;else if(t){const u=t.list.get(n.modelId);if(u)try{const[h]=await u.getItemsData([n.localId],je);d=h||null}catch(h){console.warn("Failed to fetch properties for AI context (multi)",h)}}if(d){o.push("  Property snapshot (compact JSON):"),o.push(`  ${wr(d,4e3)}`);const u=Ht(d).rows;if(u.length){o.push(`  Flattened properties (${u.length} entries):`);for(const h of u.slice(0,120))o.push(`  - ${h.label}: ${h.value}`);u.length>120&&o.push(`  (Truncated ${u.length-120} additional properties)`)}}else o.push("  Properties for this selection are not available yet.")}}else if(o.push("No active selection â€” exporting properties for every loaded element."),t&&t.list.size)for(const i of j){const n=t.list.get(i.id);if(!n){o.push(`Model ${i.label} [${i.id}] could not be found in the fragments registry.`);continue}try{const d=await n.getLocalIds(),u=Array.isArray(d)?d:d?Array.from(d):[];if(!u||u.length===0){o.push(`Model ${i.label} [${i.id}] has no retrievable local IDs.`);continue}o.push(`Model ${i.label} [${i.id}] â€” enumerating ${u.length} items:`);const h=u.length<=40?12:u.length<=120?6:3,g=50;for(let y=0;y<u.length;y+=g){const I=u.slice(y,y+g);let R=[];try{R=await n.getItemsData(I,je)}catch(z){const T=I[0],S=I[I.length-1];o.push(`  Failed to retrieve properties for items ${T}â€“${S}: ${z?.message??z}`);continue}I.forEach((z,T)=>{const S=R?.[T];if(!S){o.push(`- localId:${z} (no data available)`);return}const w=el(S,h).replace(/\s+/g," ").trim();o.push(`- localId:${z} | ${w}`)})}}catch(d){o.push(`Failed to enumerate items for model ${i.label} [${i.id}]: ${d?.message??d}`)}}else o.push("Fragments data is not available to enumerate model items.");if(Tt.length){o.push("ItemsData extracted name/value pairs (last selection):");const i=150,n=Tt.slice(0,i);for(const d of n)o.push(`- ${d.path}: ${d.value}`);Tt.length>i&&o.push(`(Truncated ${Tt.length-i} additional rows)`)}return Mr&&(o.push("ItemsData table snapshot for last selection (tab-separated):"),o.push(Mr)),o.length===0&&o.push("Viewer is idle: no models or selections to describe."),o.join(`
`)},[j,v,q,le,ko,Mr,Tt]),ms=c.useCallback(async()=>{const t=a.current,o=l.current,i=m.current;if(!t||!o||!i||!p.current)return;const n=o.list.get(i);if(!n)return;await o.core.update(!0),await new Promise(h=>requestAnimationFrame(()=>h()));const d=n.object,u=new rt().setFromObject(d);if(!u.isEmpty()){const h=at(),g=h?.controls??null,y=h?.three??null;try{g&&await g.fitToBox(d,!0)}catch{const R=new J,z=new J;u.getCenter(R),u.getSize(z);const S=(Math.max(z.x,z.y,z.z)||10)*2.5;g?g.setLookAt(R.x+S,R.y+S,R.z+S,R.x,R.y,R.z,!0):y&&(y.position.set(R.x+S,R.y+S,R.z+S),y.lookAt(R))}}},[]),hs=c.useCallback(async()=>{const t=Be.current,o=_e.current;if(!t||t.length===0||!o||!p.current){ve(null);return}const i={};for(const n of t)i[n.modelId]||(i[n.modelId]=new Set),i[n.modelId].add(n.localId);try{await o.set(!1,i);try{ze.current?.clear?.()}catch{}M([]),ke(null)}catch(n){console.warn("Failed to hide selected element",n)}finally{ve(null)}},[ve,M,ke]),gs=c.useCallback(async()=>{const t=_e.current;if(!t||!p.current){ve(null);return}try{await t.set(!0)}catch(o){console.warn("Failed to reset hidden items",o)}finally{ve(null)}},[ve]),ys=c.useCallback(()=>{ve(null)},[ve]);c.useEffect(()=>{const t=e.current,o=a.current;if(!t||!o)return;const i=o.renderer?.three.domElement;if(!i)return;const n=new pn,d=async(S,w,P,_)=>{const L=l.current;if(!L){console.warn("âŒ No fragments manager");return}const V=Fr();if(!V){console.warn("Rectangle selection skipped: viewer camera not ready.");return}const N=i.getBoundingClientRect();new mn;const $=new Map,B=10,Y=P-S,Q=_-w;if(Y<3||Q<3){await u((S+P)/2,(w+_)/2);return}let G=0,ae=!0;for(let me=S;me<=P;me+=B)for(let Me=w;Me<=_;Me+=B){const ue=(me-N.left)/N.width*2-1,dt=-((Me-N.top)/N.height)*2+1;n.set(ue,dt);for(const et of L.list.values())try{const St=new pn(ue,dt),Kr=await et.raycast({camera:V,mouse:St,dom:i});if(Kr&&typeof Kr.distance=="number"){G++;const mr=Kr.localId;mr!=null&&Number.isInteger(mr)&&($.has(et.modelId)||$.set(et.modelId,new Set),$.get(et.modelId).add(mr))}}catch(St){ae&&console.warn("âŒ Raycast error on first sample:",St),console.debug("Skipping model due to raycast error:",St)}ae&&(ae=!1)}const ne=[];for(const[me,Me]of $.entries())for(const ue of Me)ne.push({modelId:me,localId:ue});if(ne.length===0){console.warn("âš ï¸ No objects found in rectangle"),M([]),ke(null);return}const We=Be.current;if(!oo(ne,We)&&(M(ne),Ct(),ne.length>0)){const me=ne[0],Me=L.list.get(me.modelId);if(Me)try{const[ue]=await Me.getItemsData([me.localId],je);ke(ue||null)}catch(ue){console.warn("Failed to fetch properties for rectangle selection",ue)}}},u=async(S,w)=>{const P=l.current;if(!P)return;const _=Fr();if(!_){console.warn("Picking skipped: viewer camera not ready.");return}const L=i.getBoundingClientRect();n.x=(S-L.left)/L.width*2-1,n.y=-((w-L.top)/L.height)*2+1;let V=null;const N=new mn;N.setFromCamera(n,_);for(const Q of P.list.values())try{const G=await Q.raycast({camera:_,mouse:n,dom:o.renderer.three.domElement});if(G&&typeof G.distance=="number"){const ae=G.point instanceof J?G.point.clone():N.ray.at(G.distance,new J);(!V||G.distance<V.dist)&&(V={dist:G.distance,model:Q,localId:G.localId,point:ae,object:G.object,instanceId:G.instanceId})}}catch{}if(!V)return;const $=ze.current;if($&&$.enabled!==!1)try{typeof $.clear=="function"&&!Rr.current&&!Nt.current&&$.clear();const Q=6737151,G=$.selection&&$.selection.select;if(!$.onBeforeHighlight||!G)return;typeof $.highlightByID=="function"?await $.highlightByID(V.model.uuid,[V.localId],Q):typeof $.add=="function"?$.add(V.model.uuid,[V.localId]):typeof $.highlight=="function"&&await $.highlight(V.model,[V.localId],Q)}catch(Q){console.warn("Highlighter failed, using fallback:",Q);try{const G=V.object,ae=V.instanceId;if(G&&G.isInstancedMesh&&Number.isInteger(ae)){const ne=Ve.current;if(ne&&ne.mesh&&ne.mesh.instanceColor){const me=new De(1,1,1);try{ne.mesh.setColorAt(ne.index,me),ne.mesh.instanceColor.needsUpdate=!0}catch{}}const We=G,pe=new De(6737151);try{We.setColorAt(ae,pe),We.instanceColor.needsUpdate=!0}catch{}Ve.current={mesh:We,index:ae}}}catch{}}try{const Q=V.point??new J;let G=Re.current;if(!G){G=new ai;const We=new rt,pe=l.current;if(pe&&pe.list.size)for(const St of pe.list.values())We.expandByObject(St.object);const me=new ci;We.getBoundingSphere(me);const Me=isFinite(me.radius)&&me.radius>0?me.radius*.01:.3,ue=Math.max(.05,Math.min(2,Me)),dt=new hn(new di(ue*.5,16,16),new gn({color:16763904,depthTest:!1})),et=new hn(new ui(ue*.8,ue,32),new gn({color:16772744,side:fi,depthTest:!1,transparent:!0,opacity:.9}));et.rotation.x=Math.PI/2,dt.renderOrder=999,et.renderOrder=999,G.add(dt),G.add(et),o.scene.three.add(G),Re.current=G}G.position.copy(Q);const ae=G.children[1],ne=Fr();ne&&ae.lookAt(ne.position),G.visible=!0}catch{}const B=Be.current,Y=[{modelId:V.model.modelId,localId:V.localId}];if(!oo(Y,B)){M(Y),Ct();try{const[Q]=await V.model.getItemsData([V.localId],je);ke(Q||null)}catch{}}},h=async S=>{if(ve(null),S.button===0)if(Ir.current==="rectangle"&&!Ot.current){if(Jt.current=!0,mt.current={x:S.clientX,y:S.clientY},!Ne.current){const P=document.createElement("div");P.style.position="fixed",P.style.border="2px solid #1976d2",P.style.backgroundColor="rgba(25, 118, 210, 0.1)",P.style.pointerEvents="none",P.style.zIndex="10000",document.body.appendChild(P),Ne.current=P}const w=Ne.current;w.style.left=`${S.clientX}px`,w.style.top=`${S.clientY}px`,w.style.width="0px",w.style.height="0px",w.style.display="block"}else await u(S.clientX,S.clientY)},g=S=>{if(!Jt.current||!mt.current||!Ne.current)return;const w=mt.current,P=Ne.current,_=Math.min(S.clientX,w.x),L=Math.min(S.clientY,w.y),V=Math.abs(S.clientX-w.x),N=Math.abs(S.clientY-w.y);P.style.left=`${_}px`,P.style.top=`${L}px`,P.style.width=`${V}px`,P.style.height=`${N}px`},y=async S=>{if(Jt.current&&mt.current&&Ne.current){const w=mt.current,P=Ne.current;P.style.display="none",Jt.current=!1;const _=Math.min(S.clientX,w.x),L=Math.min(S.clientY,w.y),V=Math.max(S.clientX,w.x),N=Math.max(S.clientY,w.y);await d(_,L,V,N),mt.current=null}},I=async S=>{ve(null),!Ot.current&&Ir.current==="click"&&await u(S.clientX,S.clientY)},R=()=>{if(Ot.current){const S=lr.current;S&&typeof S.create=="function"&&S.create()}},z=S=>{S.preventDefault();const w=Be.current;if(!w||w.length===0){ve(null);return}ve({mouseX:S.clientX+2,mouseY:S.clientY-6})},T=S=>{if(Ot.current&&(S.code==="Delete"||S.code==="Backspace")){const w=lr.current;w&&typeof w.delete=="function"&&w.delete()}};return i.addEventListener("pointerdown",h,{capture:!0}),i.addEventListener("pointermove",g),i.addEventListener("pointerup",y),i.addEventListener("click",I),i.addEventListener("dblclick",R),i.addEventListener("contextmenu",z),window.addEventListener("keydown",T),()=>{i.removeEventListener("pointerdown",h,{capture:!0}),i.removeEventListener("pointermove",g),i.removeEventListener("pointerup",y),i.removeEventListener("click",I),i.removeEventListener("dblclick",R),i.removeEventListener("contextmenu",z),window.removeEventListener("keydown",T),Ne.current&&(Ne.current.remove(),Ne.current=null);try{const S=Re.current;S&&(o.scene.three.remove(S),S.traverse(w=>{if(w.geometry&&w.geometry.dispose?.(),w.material){const P=Array.isArray(w.material)?w.material:[w.material];for(const _ of P)_?.dispose?.()}}),Re.current=null)}catch{}try{const S=Ve.current;if(S&&S.mesh&&S.mesh.instanceColor){const w=new De(1,1,1);S.mesh.setColorAt(S.index,w),S.mesh.instanceColor.needsUpdate=!0}Ve.current=null}catch{}}},[]);const bs=c.useCallback(()=>{a.current;const t=at(),o=t?.controls??null,i=t?.three??null;o?o.reset(!0):i&&(i.position.set(10,10,10),i.lookAt(0,0,0))},[]),Hr=c.useCallback(t=>{ir(o=>{const i={...o,[t]:!o[t]},n=a.current;if(!n)return i;const d=n.renderer?.three,u=n.scene?.three;if(!d||!u)return i;const h=[],g=$r.current;if(!i[t]){const y=g.get(t);y&&(u.remove(y),y.dispose(),g.delete(t))}if(i.x){const y=new vt(new J(1,0,0),$e.x);if(h.push(y),!g.has("x")){const I=new to(y,10,16711680);u.add(I),g.set("x",I)}}if(i.y){const y=new vt(new J(0,1,0),$e.y);if(h.push(y),!g.has("y")){const I=new to(y,10,65280);u.add(I),g.set("y",I)}}if(i.z){const y=new vt(new J(0,0,1),$e.z);if(h.push(y),!g.has("z")){const I=new to(y,10,255);u.add(I),g.set("z",I)}}return d.clippingPlanes=h,d.localClippingEnabled=h.length>0,Tr.current=h,i})},[$e]),qr=c.useCallback((t,o)=>{Mo(i=>{const n={...i,[t]:o};return requestAnimationFrame(()=>{const u=a.current;if(!u)return;const h=u.renderer?.three;if(!h)return;const g=[],y=$r.current;if(oe.x){const I=new vt(new J(1,0,0),n.x);g.push(I);const R=y.get("x");R&&(R.plane.constant=n.x)}if(oe.y){const I=new vt(new J(0,1,0),n.y);g.push(I);const R=y.get("y");R&&(R.plane.constant=n.y)}if(oe.z){const I=new vt(new J(0,0,1),n.z);g.push(I);const R=y.get("z");R&&(R.plane.constant=n.z)}h.clippingPlanes=g,Tr.current=g}),n})},[oe]),xs=c.useCallback(()=>{Do(t=>{const o=!t;return ir(o?{x:!0,y:!0,z:!0}:{x:!1,y:!1,z:!1}),o})},[]),ws=c.useCallback(()=>{Un(t=>{const o=!t;Ot.current=o;const i=lr.current;if(i){if(i.enabled=o,!o)try{i.list&&typeof i.list.clear=="function"&&i.list.clear(),To(null)}catch(n){console.warn("Failed to clear measurements:",n)}}else console.warn("âš ï¸ Measurement tool not initialized!");return o})},[]),Is=c.useCallback(()=>{Ln(t=>{const o=!t;Rr.current=o;const i=l.current,n=ze.current,d=_n.current;if(!i)return t;try{if(o){if(!n)return t;const u=n.selection?.select||{};So.current=u,n.enabled=!1;const h=[...i.core.models.materials.list.values()];for(const g of h){if(g.userData.customId)continue;let y;"color"in g?y=g.color.getHex():y=g.lodColor.getHex(),d.set(g,{color:y,transparent:g.transparent,opacity:g.opacity}),g.transparent=!0,g.opacity=.05,g.needsUpdate=!0,"color"in g?g.color.setColorName("white"):g.lodColor.setColorName("white")}if(Object.keys(u).length>0)try{i.highlight({customId:"ghost-selected",color:new De(16750592),renderedFaces:1,opacity:1,transparent:!1},u)}catch(g){console.warn("Failed to apply ghost highlight:",g)}i.core.update(!0)}else{for(const[u,h]of d){const{color:g,transparent:y,opacity:I}=h;u.transparent=y,u.opacity=I,"color"in u?u.color.setHex(g):u.lodColor.setHex(g),u.needsUpdate=!0}d.clear(),n&&(n.enabled=!0),So.current=null,i.resetHighlight(),i.core.update(!0)}}catch(u){return console.warn("Failed to toggle ghost mode:",u),t}return o})},[]),Cs=c.useCallback(()=>{Vn(t=>{const o=!t,i=_e.current,n=ze.current;if(!i)return console.warn("âš ï¸ Hider not available for isolate mode"),t;try{if(o){const d=n?.selection?.select||{},u={};for(const[h,g]of Object.entries(d))g&&typeof g.size=="number"&&g.size>0&&(u[h]=g);if(Object.keys(u).length>0)i.isolate(u);else return console.warn("âš ï¸ No selection to isolate"),t}else i.set(!0)}catch(d){return console.warn("Failed to toggle isolate mode:",d),t}return o})},[]),Ss=c.useCallback(()=>{ir({x:!1,y:!1,z:!1}),Mo({x:0,y:0,z:0}),Do(!1);const t=a.current;if(t){const o=t.renderer?.three,i=t.scene?.three;if(o&&(o.clippingPlanes=[],o.localClippingEnabled=!1),i){const n=$r.current;n.forEach(d=>{i.remove(d),d.dispose()}),n.clear()}}Tr.current=[]},[]),ct=c.useCallback(t=>{const o=a.current,i=l.current,n=m.current,d=at(),u=d?.three;if(!u||!o||!i||!n)return;const h=i.list.get(n);if(!h)return;const g=new rt().setFromObject(h.object);if(g.isEmpty())return;const y=new J,I=new J;g.getCenter(y),g.getSize(I);const z=Math.max(I.x,I.y,I.z)*2||20;let T;switch(t){case"top":T=new J(y.x,y.y,y.z+z);break;case"bottom":T=new J(y.x,y.y,y.z-z);break;case"front":T=new J(y.x,y.y+z,y.z);break;case"back":T=new J(y.x,y.y-z,y.z);break;case"left":T=new J(y.x-z,y.y,y.z);break;case"right":T=new J(y.x+z,y.y,y.z);break;case"iso":T=new J(y.x+z*.7,y.y+z*.7,y.z+z*.7);break;default:return}const S=d?.controls;S&&typeof S.setLookAt=="function"?S.setLookAt(T.x,T.y,T.z,y.x,y.y,y.z,!0):(u.position.copy(T),u.lookAt(y),u.updateProjectionMatrix())},[]);return r.jsxs("div",{style:{width:"100%",height:"100%"},children:[r.jsx(As,{position:"static",children:r.jsxs(Rs,{children:[r.jsx(W,{sx:{flexGrow:1,display:"flex",alignItems:"center",gap:1},children:r.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1},children:[r.jsx(W,{sx:{display:"flex",alignItems:"center",bgcolor:"background.paper",p:"4px 8px",borderRadius:1.5,boxShadow:"0 1px 6px rgba(0,0,0,0.16)"},children:r.jsx("img",{src:"/Savora-Viewer/savora-logo.png",alt:"Savora",style:{height:28,display:"block"}})}),r.jsx(U,{variant:"subtitle1",sx:{fontWeight:700,color:"common.white",ml:.5},children:"Core (Preview)"})]})}),r.jsx(te,{title:"Settings",children:r.jsx(ee,{color:"inherit",onClick:qo,sx:{mr:1},children:r.jsx(zs,{})})}),r.jsx(te,{title:"About",children:r.jsx(ee,{color:"inherit",onClick:Zn,sx:{mr:1},children:r.jsx(Ms,{})})}),r.jsx(ie,{color:"inherit",onClick:Yo,startIcon:r.jsx(Jo,{}),"aria-pressed":Z,sx:{mr:1,borderRadius:1.5,backgroundColor:Z?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Z?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Z?"Close Model Explorer":"Open Model Explorer",children:"Model Explorer"}),r.jsx(ie,{color:"inherit",onClick:Uo,startIcon:r.jsx(Zo,{}),"aria-pressed":Ye,sx:{mr:1,borderRadius:1.5,backgroundColor:Ye?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Ye?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Ye?"Close AI Assistant":"Open AI Assistant",children:"AI Assistant"}),r.jsx(ie,{color:"inherit",onClick:Ko,startIcon:r.jsx(Qo,{}),"aria-pressed":Xe,sx:{mr:1,borderRadius:1.5,backgroundColor:Xe?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Xe?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Xe?"Close IDS Checker":"Open IDS Checker",children:"IDS Checker"}),r.jsx(ie,{color:"inherit",onClick:Wo,startIcon:r.jsx(en,{}),"aria-pressed":Je,sx:{mr:1,borderRadius:1.5,backgroundColor:Je?"rgba(255,255,255,0.18)":"transparent",transition:"background-color 0.2s ease","&:hover":{backgroundColor:Je?"rgba(255,255,255,0.26)":"rgba(255,255,255,0.12)"}},title:Je?"Close IDS Creator":"Open IDS Creator",children:"IDS Creator"})]})}),r.jsx("div",{ref:e,style:{width:"100%",height:"calc(100% - 64px)",background:"#151515",position:"relative"},children:we!==null&&r.jsx("div",{style:{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%, -50%)",zIndex:2e3,pointerEvents:"none"},children:r.jsxs(Ce,{elevation:6,sx:{p:3,minWidth:340,textAlign:"center",pointerEvents:"auto"},children:[r.jsx(U,{variant:"subtitle1",sx:{mb:1},children:"Converting IFCâ€¦"}),r.jsx(Ds,{variant:"determinate",value:Math.max(0,Math.min(100,we)),sx:{height:10,borderRadius:1}}),r.jsxs(U,{variant:"caption",sx:{mt:1,display:"block"},children:[we.toFixed(1),"%"]}),r.jsx("div",{style:{marginTop:12},children:r.jsx(ie,{size:"small",variant:"outlined",color:"inherit",onClick:ls,disabled:At,children:At?"Cancellingâ€¦":"Cancel"})})]})})}),Z&&r.jsx(tn,{nodeRef:Sr,handle:".explorer-header",bounds:"parent",children:r.jsxs(Ce,{ref:Sr,elevation:8,sx:{position:"fixed",top:120,right:30,width:Zt.width,height:re?"auto":Zt.height,minWidth:280,minHeight:re?56:260,maxWidth:"85vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[r.jsxs(W,{className:"explorer-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[r.jsx(U,{variant:"subtitle1",children:"Model Explorer"}),r.jsxs(W,{children:[r.jsx(ee,{size:"small",color:"inherit",onClick:cs,title:re?"Expand panel":"Minimize panel",children:re?r.jsx(Ns,{}):r.jsx(rn,{})}),r.jsx(ee,{size:"small",color:"inherit",onClick:as,title:"Close Model Explorer",children:r.jsx(on,{})})]})]}),!re&&r.jsxs(W,{sx:{flex:1,display:"flex",flexDirection:"column",gap:1,minHeight:0},children:[r.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,px:2,py:1},children:[r.jsx(ie,{variant:"contained",size:"small",onClick:()=>s.current?.click(),disabled:!be,children:"Open IFC / FRAG"}),r.jsx(te,{title:"Open parametric filter",children:r.jsx("span",{children:r.jsx(ie,{variant:"outlined",size:"small",onClick:()=>Ae(!0),disabled:!be,startIcon:r.jsx(Ts,{}),children:"Filter"})})}),!1,r.jsx(U,{variant:"caption",color:"text.secondary"}),r.jsx("input",{ref:s,type:"file",accept:".ifc,.IFC,.frag,.FRAG",style:{display:"none"},onChange:is})]}),r.jsxs(nn,{value:it,onChange:(t,o)=>Tn(o),variant:"fullWidth",sx:{borderBottom:1,borderColor:"divider",minHeight:"auto",".MuiTab-root":{minHeight:48,textTransform:"none",fontWeight:500}},children:[r.jsx(_t,{value:"models",label:"Models"}),r.jsx(_t,{value:"properties",label:"Properties"}),r.jsx(_t,{value:"tree",label:"Model Tree"})]}),r.jsx(W,{role:"tabpanel",hidden:it!=="models",sx:{display:it==="models"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1},children:r.jsx(W,{ref:ao,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,p:1,overflowY:"auto",flex:1,minHeight:0},children:!be&&r.jsx(U,{variant:"body2",color:"text.secondary",children:"Initializing componentsâ€¦"})})}),r.jsx(W,{role:"tabpanel",hidden:it!=="properties",sx:{display:it==="properties"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsxs(nn,{value:st,onChange:(t,o)=>mo(o),variant:"scrollable",allowScrollButtonsMobile:!0,sx:{minHeight:"auto",flexShrink:0,".MuiTabs-flexContainer":{gap:.5},".MuiTab-root":{minHeight:"auto",py:.75}},children:[r.jsx(_t,{value:"favorites",label:`Favourites (${Lr.length})`}),r.jsx(_t,{value:"all",label:`All (${le.length})`})]}),r.jsxs(W,{role:"tabpanel",hidden:st!=="favorites",sx:{display:st==="favorites"?"flex":"none",flexDirection:"column",flex:st==="favorites"?1:0,minHeight:0},children:[Lr.length?r.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(Ce,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Lr.map(_r)})}):r.jsx(Ce,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:Ie.length?"The current selection does not expose any of your favourite properties yet. Try selecting another item.":"Mark properties as favourites from the All tab to pin them here."})}),Vr>0&&Ie.length>0&&r.jsx(jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:Vr===1?"1 favourite property is not available for this selection.":`${Vr} favourite properties are not available for this selection.`})]}),r.jsxs(W,{role:"tabpanel",hidden:st!=="all",sx:{display:st==="all"?"flex":"none",flexDirection:"column",flex:st==="all"?1:0,minHeight:0},children:[r.jsxs(W,{sx:{display:"flex",alignItems:"center",gap:1,flexShrink:0,mb:1},children:[r.jsx(Bt,{size:"small",fullWidth:!0,value:fo,onChange:t=>Rn(t.target.value),placeholder:"Search propertiesâ€¦",disabled:!le.length}),r.jsx(te,{title:"Copy raw element JSON",children:r.jsx("span",{children:r.jsx(ee,{size:"small",onClick:Kn,disabled:!q,color:"primary",children:r.jsx($s,{fontSize:"small"})})})}),r.jsx(te,{title:"Export properties",children:r.jsx("span",{children:r.jsx(ie,{variant:"outlined",size:"small",startIcon:r.jsx(Fs,{}),onClick:qn,disabled:!le.length&&!j.length,children:"Export"})})})]}),le.length?Hn?Fo.length?r.jsx(W,{sx:{position:"relative",flex:1,minHeight:200},children:r.jsx(Ce,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Fo.map(_r)})}):r.jsx(Ce,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:`No properties matched "${ar}".`})}):r.jsxs(W,{sx:{position:"relative",flex:1,minHeight:200},children:[r.jsx(Ce,{variant:"outlined",sx:{position:"absolute",inset:0,p:1,display:"flex",flexDirection:"column",gap:.75,overflow:"auto"},children:Or.map(_r)}),Oo>0&&r.jsx(jt,{severity:"info",variant:"outlined",sx:{position:"absolute",bottom:0,left:0,right:0,m:1,zIndex:1},children:`Displaying the first ${Or.length} properties. ${Oo} more not shown.`})]}):r.jsx(Ce,{variant:"outlined",sx:{p:1,flex:1,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center"},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:"Select an element in the viewer to view its Property Sets / NV_BIM / â€¦ breakdown."})})]})]})}),r.jsx(W,{role:"tabpanel",hidden:it!=="tree",sx:{display:it==="tree"?"flex":"none",flexDirection:"column",flex:1,minHeight:0,px:2,py:1,gap:1},children:r.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:1.25,flex:1,minHeight:0},children:[r.jsx(Bt,{size:"small",fullWidth:!0,value:gt,onChange:t=>zn(t.target.value),placeholder:"Search the model treeâ€¦",disabled:!j.length,sx:{flexShrink:0}}),r.jsxs(W,{sx:{position:"relative",border:"1px solid",borderColor:"divider",borderRadius:1,minHeight:200,maxHeight:"100%",height:"100%",flex:1,overflow:"hidden",bgcolor:"background.paper"},children:[r.jsx(W,{ref:er,sx:{position:"absolute",inset:0,display:"flex",flexDirection:"column",overflow:"auto"}}),(!be||!j.length)&&r.jsx(W,{sx:{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center",textAlign:"center",px:2},children:r.jsx(U,{variant:"body2",color:"text.secondary",children:be?"Load a model to populate the full model tree.":"Viewer is initializing the model treeâ€¦"})})]})]})})]}),r.jsx(W,{onPointerDown:fs,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1}}})]})}),r.jsx(Ce,{elevation:6,sx:{position:"fixed",bottom:20,right:90,zIndex:1700,borderRadius:"50%",backgroundColor:Z?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(ee,{onClick:Yo,title:Z?"Close Model Explorer":"Open Model Explorer",sx:{color:Z?"white":"inherit"},children:r.jsx(Jo,{})})}),r.jsx(Ce,{elevation:6,sx:{position:"fixed",bottom:20,right:30,zIndex:1700,borderRadius:"50%",backgroundColor:Ye?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(ee,{onClick:Uo,title:Ye?"Close AI Assistant":"Open AI Assistant",sx:{color:Ye?"white":"inherit"},children:r.jsx(Zo,{})})}),r.jsx(Ce,{elevation:6,sx:{position:"fixed",bottom:20,right:150,zIndex:1700,borderRadius:"50%",backgroundColor:Xe?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(ee,{onClick:Ko,title:Xe?"Close IDS Checker":"Open IDS Checker",sx:{color:Xe?"white":"inherit"},children:r.jsx(Qo,{})})}),r.jsx(Ce,{elevation:6,sx:{position:"fixed",bottom:20,right:210,zIndex:1700,borderRadius:"50%",backgroundColor:Je?"primary.main":"background.paper",transition:"background-color 0.2s ease"},children:r.jsx(ee,{onClick:Wo,title:Je?"Close IDS Creator":"Open IDS Creator",sx:{color:Je?"white":"inherit"},children:r.jsx(en,{})})}),wt?r.jsx(tn,{handle:".drag-handle",defaultPosition:{x:20,y:-260},children:r.jsxs(Ce,{elevation:8,sx:{position:"absolute",bottom:90,padding:0,display:"flex",flexDirection:"column",gap:0,zIndex:1600,backgroundColor:"background.paper",borderRadius:2,overflow:"hidden",border:"1px solid rgba(0, 0, 0, 0.12)"},children:[r.jsxs(W,{className:"drag-handle",sx:{display:"flex",justifyContent:"space-between",alignItems:"center",px:1.5,py:.75,backgroundColor:"primary.main",color:"white",cursor:"grab","&:active":{cursor:"grabbing"}},children:[r.jsx(U,{variant:"subtitle2",sx:{fontWeight:600},children:"View Controls"}),r.jsxs(W,{sx:{display:"flex",gap:.5},children:[r.jsx(ee,{size:"small",onClick:()=>Nr(!1),title:"Minimize toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(rn,{fontSize:"small"})}),r.jsx(ee,{size:"small",onClick:()=>Nr(!1),title:"Close toolbar",sx:{color:"white","&:hover":{bgcolor:"rgba(255,255,255,0.1)"}},children:r.jsx(on,{fontSize:"small"})})]})]}),r.jsxs(W,{sx:{p:1.5},children:[r.jsxs(W,{sx:{display:"flex",gap:.5},children:[r.jsx(te,{title:"Fit to model",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:ms,disabled:!f,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(sn,{fontSize:"small"})})}),r.jsx(te,{title:"Reset view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:bs,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"primary.main",color:"white",borderColor:"primary.main"}},children:r.jsx(Os,{fontSize:"small"})})})]}),r.jsxs(W,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"View Presets"}),r.jsxs(W,{sx:{display:"grid",gridTemplateColumns:"repeat(4, 1fr)",gap:.5},children:[r.jsx(te,{title:"Top view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("top"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Top"})}),r.jsx(te,{title:"Bottom view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("bottom"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bot"})}),r.jsx(te,{title:"Front view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("front"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Frt"})}),r.jsx(te,{title:"Back view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("back"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Bck"})}),r.jsx(te,{title:"Left view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("left"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Left"})}),r.jsx(te,{title:"Right view",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ie,{size:"small",onClick:()=>ct("right"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem","&:hover":{backgroundColor:"primary.main",color:"white"}},children:"Rgt"})}),r.jsx(te,{title:"Isometric view",PopperProps:{sx:{zIndex:9999}},children:r.jsxs(ie,{size:"small",onClick:()=>ct("iso"),variant:"outlined",sx:{minWidth:"auto",px:.5,fontSize:"0.7rem",gridColumn:"span 2","&:hover":{backgroundColor:"success.main",color:"white"}},children:[r.jsx(Ls,{fontSize:"small",sx:{mr:.5}}),"ISO"]})})]})]}),r.jsxs(W,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Clipping Planes"}),r.jsxs(W,{sx:{display:"flex",gap:.5},children:[r.jsx(te,{title:"Toggle X-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:()=>Hr("x"),sx:{border:"2px solid",borderColor:oe.x?"error.main":"rgba(0, 0, 0, 0.23)",backgroundColor:oe.x?"error.main":"white",color:oe.x?"white":"error.main","&:hover":{backgroundColor:oe.x?"error.dark":"error.light",borderColor:"error.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"X"})})}),r.jsx(te,{title:"Toggle Y-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:()=>Hr("y"),sx:{border:"2px solid",borderColor:oe.y?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:oe.y?"success.main":"white",color:oe.y?"white":"success.main","&:hover":{backgroundColor:oe.y?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Y"})})}),r.jsx(te,{title:"Toggle Z-axis clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:()=>Hr("z"),sx:{border:"2px solid",borderColor:oe.z?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:oe.z?"primary.main":"white",color:oe.z?"white":"primary.main","&:hover":{backgroundColor:oe.z?"primary.dark":"primary.light",borderColor:"primary.main",color:"white"}},children:r.jsx(U,{variant:"caption",sx:{fontWeight:600},children:"Z"})})})]}),oe.x&&r.jsxs(W,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"error.main",display:"block",mb:.5},children:["X Position: ",$e.x.toFixed(1)]}),r.jsx(Yr,{value:$e.x,onChange:(t,o)=>qr("x",o),min:-50,max:50,step:.1,size:"small",sx:{color:"error.main"}})]}),oe.y&&r.jsxs(W,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"success.main",display:"block",mb:.5},children:["Y Position: ",$e.y.toFixed(1)]}),r.jsx(Yr,{value:$e.y,onChange:(t,o)=>qr("y",o),min:-50,max:50,step:.1,size:"small",sx:{color:"success.main"}})]}),oe.z&&r.jsxs(W,{sx:{mt:1},children:[r.jsxs(U,{variant:"caption",sx:{color:"primary.main",display:"block",mb:.5},children:["Z Position: ",$e.z.toFixed(1)]}),r.jsx(Yr,{value:$e.z,onChange:(t,o)=>qr("z",o),min:-50,max:50,step:.1,size:"small",sx:{color:"primary.main"}})]})]}),r.jsxs(W,{sx:{display:"flex",gap:.5},children:[r.jsx(te,{title:"Toggle clipping box",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:xs,sx:{border:"2px solid",borderColor:$t?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:$t?"warning.main":"white",color:$t?"white":"warning.dark","&:hover":{backgroundColor:$t?"warning.dark":"warning.light",borderColor:"warning.main",color:"white"}},children:r.jsx(Vs,{fontSize:"small"})})}),r.jsx(te,{title:"Clear all clipping",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:Ss,disabled:!oe.x&&!oe.y&&!oe.z&&!$t,sx:{border:"2px solid",borderColor:"rgba(0, 0, 0, 0.23)",backgroundColor:"white","&:hover":{backgroundColor:"error.main",color:"white",borderColor:"error.main"},"&:disabled":{backgroundColor:"rgba(0, 0, 0, 0.12)",borderColor:"rgba(0, 0, 0, 0.12)"}},children:r.jsx(_s,{fontSize:"small"})})})]}),r.jsxs(W,{sx:{display:"flex",gap:.5,mt:.5,alignItems:"center"},children:[r.jsx(te,{title:Ft?"Stop measuring":"Start measuring",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:ws,sx:{border:"2px solid",borderColor:Ft?"success.main":"rgba(0, 0, 0, 0.23)",backgroundColor:Ft?"success.main":"white",color:Ft?"white":"success.dark","&:hover":{backgroundColor:Ft?"success.dark":"success.light",borderColor:"success.main",color:"white"}},children:r.jsx(Bs,{fontSize:"small"})})}),No&&r.jsxs(U,{variant:"caption",sx:{ml:.5,px:1,py:.25,backgroundColor:"success.light",color:"success.dark",borderRadius:1,fontWeight:500,fontSize:"0.75rem",whiteSpace:"nowrap"},children:[No," units"]})]}),r.jsxs(W,{sx:{mt:.5},children:[r.jsx(U,{variant:"caption",sx:{color:"text.primary",fontWeight:600,display:"block",mb:.5},children:"Selection Mode"}),r.jsxs(W,{sx:{display:"flex",gap:.5},children:[r.jsx(te,{title:"Click selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:()=>Co("click"),sx:{border:"2px solid",borderColor:xe==="click"?"primary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="click"?"primary.main":"white",color:xe==="click"?"white":"primary.main","&:hover":{backgroundColor:xe==="click"?"primary.dark":"primary.light",borderColor:"primary.main",color:xe==="click"?"white":"primary.dark"}},children:r.jsx(Gs,{fontSize:"small"})})}),r.jsx(te,{title:"Rectangle selection",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:()=>Co("rectangle"),sx:{border:"2px solid",borderColor:xe==="rectangle"?"secondary.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xe==="rectangle"?"secondary.main":"white",color:xe==="rectangle"?"white":"secondary.main","&:hover":{backgroundColor:xe==="rectangle"?"secondary.dark":"secondary.light",borderColor:"secondary.main",color:xe==="rectangle"?"white":"secondary.dark"}},children:r.jsx(Ws,{fontSize:"small"})})}),r.jsx(te,{title:bt?"Disable ghost mode":"Enable ghost mode (make all translucent)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:Is,sx:{border:"2px solid",borderColor:bt?"warning.main":"rgba(0, 0, 0, 0.23)",backgroundColor:bt?"warning.main":"white",color:bt?"white":"warning.dark","&:hover":{backgroundColor:bt?"warning.dark":"warning.light",borderColor:"warning.main",color:bt?"white":"warning.dark"}},children:r.jsx(ln,{fontSize:"small"})})}),r.jsx(te,{title:xt?"Show all objects":"Isolate selection (hide non-selected)",PopperProps:{sx:{zIndex:9999}},children:r.jsx(ee,{size:"small",onClick:Cs,sx:{border:"2px solid",borderColor:xt?"info.main":"rgba(0, 0, 0, 0.23)",backgroundColor:xt?"info.main":"white",color:xt?"white":"info.dark","&:hover":{backgroundColor:xt?"info.dark":"info.light",borderColor:"info.main",color:xt?"white":"info.dark"}},children:r.jsx(an,{fontSize:"small"})})})]}),xe==="rectangle"&&r.jsx(jt,{severity:"info",sx:{mt:.5,py:0,px:1,fontSize:"0.7rem","& .MuiAlert-icon":{fontSize:"0.9rem",py:.25}},children:"Rotation disabled. Use middle-click to pan."})]})]})," "]})}):null,r.jsx(Ce,{elevation:6,sx:{position:"fixed",bottom:20,left:20,zIndex:1600,borderRadius:"50%",bgcolor:wt?"primary.main":"background.paper","&:hover":{bgcolor:wt?"primary.dark":"action.hover"}},children:r.jsx(ee,{onClick:()=>Nr(!wt),title:wt?"Close View Controls":"Open View Controls",sx:{color:wt?"white":"action.active"},children:r.jsx(sn,{})})}),r.jsx(c.Suspense,{fallback:null,children:H&&r.jsx(Ki,{open:H,onClose:()=>Ae(!1),viewerApi:ht.current??null})}),r.jsxs(Xr,{open:On,onClose:ur,fullWidth:!0,maxWidth:"sm",children:[r.jsx(Jr,{children:"Settings"}),r.jsx(Zr,{dividers:!0,children:r.jsxs(W,{sx:{display:"flex",flexDirection:"column",gap:3,py:1},children:[r.jsxs(cn,{component:"fieldset",children:[r.jsx(dn,{component:"legend",sx:{mb:1},children:"AI Provider"}),r.jsxs(un,{value:ye,onChange:t=>es(t.target.value),children:[r.jsx(Gt,{value:"gemini",control:r.jsx(Wt,{}),label:"Google Gemini"}),r.jsx(Gt,{value:"openai",control:r.jsx(Wt,{}),label:"OpenAI (ChatGPT)"}),r.jsx(Gt,{value:"disabled",control:r.jsx(Wt,{}),label:"Disabled (No AI)"})]})]}),ye!=="disabled"&&r.jsxs(r.Fragment,{children:[r.jsx(Bt,{label:"API Key",type:Ar?"text":"password",value:Ge,onChange:t=>Er(t.target.value),fullWidth:!0,placeholder:`Enter your ${ye==="gemini"?"Google Gemini":"OpenAI"} API key`,InputProps:{endAdornment:r.jsx(ee,{onClick:()=>bo(!Ar),edge:"end",size:"small",children:Ar?r.jsx(ln,{}):r.jsx(an,{})})},helperText:ye==="gemini"?"Get your API key from: https://makersuite.google.com/app/apikey":"Get your API key from: https://platform.openai.com/api-keys"}),r.jsx(Bt,{select:!0,label:"Model",value:Dt,onChange:t=>or(t.target.value),fullWidth:!0,SelectProps:{native:!0},helperText:"Select the AI model to use",children:wi(ye).map(t=>r.jsx("option",{value:t,children:t},t))}),r.jsxs(W,{sx:{display:"flex",gap:1,alignItems:"center"},children:[r.jsx(ie,{variant:"outlined",onClick:ts,disabled:!Ge||xo,size:"small",children:xo?"Testing...":"Test Connection"}),Io==="success"&&r.jsx(U,{variant:"body2",color:"success.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ“ Connection successful"}),Io==="error"&&r.jsx(U,{variant:"body2",color:"error.main",sx:{display:"flex",alignItems:"center",gap:.5},children:"âœ— Connection failed"})]}),r.jsx(jt,{severity:"info",variant:"outlined",children:r.jsxs(U,{variant:"body2",children:[r.jsx("strong",{children:"Security Note:"})," Your API key is stored locally in your browser's localStorage and never sent to our servers. All AI requests are made directly from your browser to ",ye==="gemini"?"Google":"OpenAI","."]})})]})]})}),r.jsxs(Qr,{children:[r.jsx(ie,{onClick:ur,children:"Cancel"}),r.jsx(ie,{onClick:Qn,variant:"contained",color:"primary",disabled:ye!=="disabled"&&!Ge,children:"Save"})]})]}),r.jsxs(Xr,{open:Fn,onClose:Ho,fullWidth:!0,maxWidth:"md",children:[r.jsx(Jr,{children:"About Savora Viewer"}),r.jsxs(Zr,{dividers:!0,sx:{maxHeight:"70vh",overflowY:"auto"},children:[r.jsx(U,{variant:"h6",gutterBottom:!0,children:"Version 0.2.1 Preview"}),r.jsxs(U,{variant:"body2",color:"text.secondary",paragraph:!0,children:["A powerful web-based 3D viewer for Building Information Modeling (BIM) files with integrated IDS validation and AI-powered assistance. Built on That Open Company BIM Toolkit and Three.js. ",r.jsx("br",{}),"For bug reporting and more information, visit our ",r.jsx(Us,{href:"https://github.com/savytechlabs/savora-viewer",target:"_blank",rel:"noopener",children:"website"}),". ",r.jsx("br",{}),r.jsx("span",{style:{fontWeight:"bold"},children:"Note: No data is collected or sent to any servers; all processing occurs locally in your browser."})]}),r.jsx(U,{variant:"h6",gutterBottom:!0,sx:{mt:3},children:"Features"}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Viewing"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Multiple format support (IFC, Fragments)",r.jsx("br",{}),"â€¢ Pan, zoom, rotate navigation",r.jsx("br",{}),"â€¢ Selection via point-and-click or rectangular region",r.jsx("br",{}),"â€¢ Orthogonal projection for accurate measurements",r.jsx("br",{}),"â€¢ View management (zoom to fit, home, cube orientation)",r.jsx("br",{}),"â€¢ Toggle performance stats",r.jsx("br",{}),"â€¢ Object measurement tools",r.jsx("br",{}),"â€¢ Clipping planes for sectional views"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"Model Explorer"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Spatial and classification hierarchy navigation",r.jsx("br",{}),"â€¢ Tree-based model structure view",r.jsx("br",{}),"â€¢ Properties panel with expand/collapse",r.jsx("br",{}),"â€¢ Search and filter functionality",r.jsx("br",{}),"â€¢ Property export (CSV, JSON)",r.jsx("br",{}),"â€¢ Favorites system for quick access",r.jsx("br",{}),"â€¢ Parametric filtering with Ghost/Isolate modes"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Checker"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Validate models against Information Delivery Specification (IDS)",r.jsx("br",{}),"â€¢ Load IDS files from local storage",r.jsx("br",{}),"â€¢ Visual feedback: green (pass) and red (fail) indicators",r.jsx("br",{}),"â€¢ Filter models by validation results",r.jsx("br",{}),"â€¢ Export validation reports"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"IDS Creator"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Visual authoring tool for IDS specifications",r.jsx("br",{}),"â€¢ Capture and define validation rules",r.jsx("br",{}),"â€¢ Property picker for easy specification setup",r.jsx("br",{}),"â€¢ Save and load IDS files",r.jsx("br",{}),"â€¢ Integration with IDS Checker for immediate validation"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"BIM AI Assistant"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Natural language queries about model contents",r.jsx("br",{}),"â€¢ Intelligent model analysis and insights",r.jsx("br",{}),"â€¢ Context-aware responses based on selected elements",r.jsx("br",{}),"â€¢ Interactive chat interface",r.jsx("br",{}),"â€¢ Selection and filtering via conversation"]}),r.jsx(U,{variant:"subtitle1",gutterBottom:!0,sx:{mt:2,fontWeight:"bold"},children:"User Experience"}),r.jsxs(U,{variant:"body2",component:"div",sx:{pl:2},children:["â€¢ Floating toolbar for model operations",r.jsx("br",{}),"â€¢ Tooltips and keyboard shortcuts",r.jsx("br",{}),"â€¢ Collapsible side panels",r.jsx("br",{}),"â€¢ Responsive layout",r.jsx("br",{}),"â€¢ Dark theme optimized for long viewing sessions"]})]}),r.jsx(Qr,{children:r.jsx(ie,{onClick:Ho,color:"primary",children:"Close"})})]}),r.jsxs(Xr,{open:Wn,onClose:Go,fullWidth:!0,maxWidth:"sm",children:[r.jsx(Jr,{children:"Export properties"}),r.jsxs(Zr,{dividers:!0,sx:{display:"flex",flexDirection:"column",gap:2},children:[r.jsxs(cn,{component:"fieldset",variant:"standard",children:[r.jsx(dn,{component:"legend",children:"Scope"}),r.jsxs(un,{value:Ze,onChange:t=>Ao(t.target.value),children:[r.jsx(Gt,{value:"selected",control:r.jsx(Wt,{}),label:"Selected items",disabled:!le.length}),r.jsx(Gt,{value:"model",control:r.jsx(Wt,{}),label:"Specific model",disabled:!j.length})]})]}),r.jsx(Hs,{in:Ze==="model",unmountOnExit:!0,children:r.jsx(Bt,{select:!0,fullWidth:!0,label:"Model",value:Qe,onChange:t=>nr(t.target.value),disabled:!j.length,children:j.map(t=>r.jsx(eo,{value:t.id,children:t.label},t.id))})}),Ze==="selected"&&!le.length&&r.jsx(jt,{severity:"warning",variant:"outlined",children:"Select at least one item before exporting the current selection."}),zo&&r.jsx(jt,{severity:"error",variant:"outlined",children:zo})]}),r.jsxs(Qr,{children:[r.jsx(ie,{onClick:Go,disabled:lt,children:"Cancel"}),r.jsx(ie,{variant:"contained",onClick:Yn,disabled:lt||Ze==="selected"&&!le.length||Ze==="model"&&!Qe,children:lt?"Exportingâ€¦":"Export CSV"})]})]}),r.jsxs(c.Suspense,{fallback:null,children:[r.jsx(Hi,{isOpen:Xe,onOpen:os,onClose:ns,viewerApi:Wr,hasModel:j.length>0,expandSignal:Bn}),r.jsx(qi,{isOpen:Je,onClose:()=>vo(!1),viewerApi:Wr,selectedItemData:q,onValidate:ss}),r.jsx(Ui,{getModelDataForAI:ps,isOpen:Ye,onOpen:Xn,onClose:Jn,expandSignal:$n,onRequestSelection:us,onOpenSettings:qo})]}),r.jsxs(qs,{open:!!tr,onClose:ys,anchorReference:"anchorPosition",anchorPosition:tr?{top:tr.mouseY,left:tr.mouseX}:void 0,disableAutoFocus:!0,disableAutoFocusItem:!0,disableEnforceFocus:!0,disablePortal:!0,hideBackdrop:!0,disableScrollLock:!0,disableRestoreFocus:!0,MenuListProps:{autoFocusItem:!1,"aria-label":"Element context menu"},slotProps:{paper:{sx:{pointerEvents:"auto",boxShadow:3}}},TransitionProps:{onExited:()=>{document.body.removeAttribute("aria-hidden")}},children:[r.jsx(eo,{onClick:hs,disabled:v.length===0,children:"Hide selected element"}),r.jsx(eo,{onClick:gs,children:"Reset hidden elements"})]})]})};function wr(e,s=2e3){try{if(e==null)return"null";const a=typeof e=="string"?e:JSON.stringify(e,null,2);return a?a.length<=s?a:`${a.slice(0,s)}
... [truncated ${a.length-s} chars]`:""}catch{return String(e)}}Ks.createRoot(document.getElementById("root")).render(r.jsx(Et.StrictMode,{children:r.jsx(ll,{})}));export{Si as a,_i as b,hl as g,ro as i,bi as l,ml as p,Ii as s,Gi as u};
