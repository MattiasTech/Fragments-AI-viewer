(function(){"use strict";const h=self,D=new Set(["ID","IFC","BIM","MEP","HVAC","URL","CAD"]),R=e=>{if(!e)return"";let t=e.replace(/[_\-]+/g," ");return t=t.replace(/([a-z\d])([A-Z])/g,"$1 $2"),t=t.replace(/([A-Z]+)([A-Z][a-z])/g,"$1 $2"),t=t.replace(/\s+/g," ").trim(),t?t.split(" ").map(s=>{const f=s.toUpperCase();return D.has(f)||f.length<=3&&/^[A-Z]+$/.test(f)?f:/^\d+(\.\d+)?$/.test(s)||!s.length?s:s.charAt(0).toUpperCase()+s.slice(1)}).join(" "):""},E=e=>{if(e==null)return"";if(typeof e=="number")return Number.isFinite(e)?e.toString():"";if(typeof e=="boolean")return e?"true":"false";if(e instanceof Date)return e.toISOString();if(typeof e=="string")return e.trim();try{const t=JSON.stringify(e);return t?t.length>500?`${t.slice(0,500)}â€¦`:t:""}catch{return String(e)}},U=e=>!e||typeof e!="string"?e:e.replace(/[\u2013\u2014\u2212\u2010\u2011]/g,"-").replace(/[\u2018\u2019]/g,"'").replace(/[\u201C\u201D]/g,'"').replace(/[\u00A0\u2000-\u200B]/g," ").trim(),N=e=>{if(e==null)return"";if(typeof e!="object"){const o=E(e);return U(o)}if(e&&typeof e=="object"){const o=e;if("value"in o)return N(o.value);if("Value"in o)return N(o.Value)}if(Array.isArray(e))return e.map(o=>N(o)).filter(Boolean).join(", ");if(typeof e?.x=="number"&&typeof e?.y=="number"&&typeof e?.z=="number")return`${E(e.x)}, ${E(e.y)}, ${E(e.z)}`;const t=E(e);return U(t)},O=(e,t)=>{if(!e||typeof e!="object")return;const o=t.map(a=>a.toLowerCase()),s=new WeakSet,f=[e];for(;f.length;){const a=f.pop();if(!(!a||typeof a!="object")&&!s.has(a)){if(s.add(a),Array.isArray(a)){for(const u of a)u&&typeof u=="object"&&f.push(u);continue}for(const[u,m]of Object.entries(a)){const A=u.toLowerCase();if(o.some(b=>A.includes(b)))if(typeof m=="string"){const b=m.trim();if(b)return b}else{if(typeof m=="number"&&Number.isFinite(m))return m.toString();if(typeof m=="boolean")return m?"true":"false"}m&&typeof m=="object"&&f.push(m)}}}},x=e=>e.replace(/[^a-z0-9]+/gi,"-").replace(/-{2,}/g,"-").replace(/(^-|-$)/g,"").toLowerCase(),G=e=>e?e.trim().replace(/\s+/g,"_").replace(/[^a-zA-Z0-9_.:-]+/g,"_").replace(/_{2,}/g,"_").replace(/^_+|_+$/g,""):"",V=["HasProperties","hasProperties","Properties","properties"],F=["IsDefinedBy","isDefinedBy","psets","Psets","propertySets","PropertySets","property_sets","Property_Sets"],M=new Set(["type","Type","id","ID","expressID","ExpressID","expressId","globalId","GlobalId","GlobalID","guid","Guid","GUID","_t","_type","_id","_guid"]),T=e=>{if(!e||typeof e!="object")return!1;const t=e,o=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return o&&o.toUpperCase()==="IFCPROPERTYSET"?!0:V.some(s=>Array.isArray(t[s]))},B=e=>{if(!e||typeof e!="object")return!1;const t=e,o=typeof t.type=="string"?t.type:typeof t.Type=="string"?t.Type:void 0;return o&&o.toUpperCase()==="IFCPROPERTYSINGLEVALUE"?!0:"NominalValue"in t||"nominalValue"in t},Y=e=>{if(!e||typeof e!="object")return E(e);const t=e,o=["NominalValue","nominalValue","Value","value","DataValue","dataValue","LengthValue","AreaValue","CountValue","VolumeValue","NumberValue","BooleanValue","LogicalValue","TextValue","IntegerValue","UpperBoundValue","LowerBoundValue","EnumerationValues","ListValues"];for(const s of o){if(!(s in t))continue;const f=t[s];if(f!=null)return N(f)}return"NominalValue"in t?N(t.NominalValue):"nominalValue"in t?N(t.nominalValue):"Value"in t?N(t.Value):"value"in t?N(t.value):E(e)},z=e=>{if(!e||typeof e!="object")return[];const t=[],o=new WeakSet,s=new Map,f=n=>{let r;if(typeof n=="string"){const y=n.trim();y.length&&(r=y)}if(!r&&n&&typeof n=="object"){const y=n,c=L(n)??(typeof y.Name=="string"?y.Name:void 0),g=typeof y.id=="string"?y.id:void 0;r=c??g}(!r||!r.length)&&(r="Property Set");const i=R(r)||r,l=x(r)||"property-set",p=(s.get(l)??0)+1;return s.set(l,p),{rawName:r,friendlyName:i,uniqueKey:`${l}-${p}`}},a=(n,r,i)=>{const l=`Property ${i+1}`,p=n&&n.trim().length?n.trim():l;if(B(r)){const c={...r};return c.Name==null&&c.PropertyName==null&&(c.Name=p),c.PropertyName==null&&(c.PropertyName=c.Name??p),c.__rawValue==null&&(c.__rawValue=r),c}if(r&&typeof r=="object"){const c={...r};return c.Name==null&&c.PropertyName==null&&(c.Name=p),c.PropertyName==null&&(c.PropertyName=c.Name??p),c.type==null&&c.Type==null&&(c.type="IFCPROPERTYSINGLEVALUE"),!("NominalValue"in c)&&!("nominalValue"in c)&&!("Value"in c)&&!("value"in c)&&(c.NominalValue=r),c.__rawValue==null&&(c.__rawValue=r),c}return{type:"IFCPROPERTYSINGLEVALUE",Name:p,PropertyName:p,NominalValue:r,__rawValue:r}},u=(n,r)=>{const i=[],l=(p,y)=>{const c=`Property ${i.length+1}`,g=p,I=(typeof p=="string"&&p.trim().length?p.trim():void 0)??L(p)??(typeof g?.Name=="string"?g.Name:void 0)??(typeof g?.PropertyName=="string"?g.PropertyName:void 0)??c;i.push(a(I,y,i.length))};if(r&&typeof r=="object"){const p=r;for(const y of V){const c=p[y];Array.isArray(c)&&c.length&&c.forEach(g=>l(g,g))}}if(!i.length)if(Array.isArray(r))r.forEach(p=>l(p,p));else if(r&&typeof r=="object")for(const[p,y]of Object.entries(r))y!=null&&(M.has(p)||V.includes(p)||F.includes(p)||l(p,y));else r!=null&&l(void 0,r);return{type:"IFCPROPERTYSET",Name:n,HasProperties:i}},m=(n,r)=>{if(!r||typeof r!="object")return;const i=u(n.rawName,r),l=Array.isArray(i.HasProperties)?i.HasProperties:[];if(!l.length)return;const p=n.friendlyName;l.forEach((y,c)=>{const g=y;let I;if(typeof g.Name=="string")I=g.Name;else if(g.Name&&typeof g.Name=="object"){const k=g.Name;typeof k.value=="string"&&(I=k.value)}!I&&typeof g.PropertyName=="string"&&(I=g.PropertyName),I||(I=`Property ${c+1}`);const Z=R(I)||I,q=Y(y);t.push({label:`Property Sets / ${p} / ${Z}`,value:q||"",rawPsetName:n.rawName,rawPropertyName:I})})},A=n=>{if(!(!n||typeof n!="object")&&!o.has(n)){if(o.add(n),Array.isArray(n)){n.forEach(r=>{if(!r||typeof r!="object")return;const i=f(r),l=T(r)?r:u(i.rawName,r);m(i,l),o.add(r)});return}for(const[r,i]of Object.entries(n)){if(i==null)continue;const l=f(r),p=T(i)?i:u(l.rawName,i);m(l,p),i&&typeof i=="object"&&o.add(i)}}},b=n=>{if(!n||typeof n!="object"||o.has(n))return;if(o.add(n),Array.isArray(n)){n.forEach(b);return}let r=!1;for(const i of F)if(Object.prototype.hasOwnProperty.call(n,i)){const l=n[i];A(l),r=!0}if(T(n)){const i=f(n);m(i,n)}!r&&!T(n)&&Object.entries(n).forEach(([i,l])=>{F.includes(i)||M.has(i)||V.includes(i)||l&&typeof l=="object"&&b(l)})};b(e);const d=new Map,P=new Set;for(const n of t){const r=`${n.label}::${n.value}`;if(P.has(r))continue;const i=`${n.rawPsetName||"unknown"}::${n.rawPropertyName||"unknown"}::${n.value}`;d.has(i)||(P.add(r),d.set(i,n))}return Array.from(d.values())},L=e=>{if(!e||typeof e!="object")return;const t=e;let o;if(typeof t.Name=="string")o=t.Name;else if(t.Name&&typeof t.Name=="object"){const u=t.Name;typeof u.value=="string"&&(o=u.value)}const s=typeof t.name=="string"?t.name:void 0,f=o??s;if(!f)return;const a=f.trim();return a.length?a:void 0},K=e=>{if(!e||typeof e!="object")return"IfcProduct";const t=e,o=new Set(["IFCIDENTIFIER","IFCLABEL","IFCTEXT","IFCBOOLEAN","IFCINTEGER","IFCREAL","IFCLENGTHMEASURE","IFCPOSITIVELENGTHMEASURE","IFCAREAMEASURE","IFCVOLUMEMEASURE","IFCPOSITIVERATIOMEASURE","IFCPLANEANGLEMEASURE","IFCPOSITIVEINTEGER","IFCLOGICAL"]);if(t.constructor&&typeof t.constructor=="function"&&t.constructor.name){const a=t.constructor.name.toUpperCase();if(a.startsWith("IFC")&&!o.has(a))return a}if(t._category&&typeof t._category=="object"){const a=t._category;if(a.value&&typeof a.value=="string"){const u=a.value.trim().toUpperCase();if(u.startsWith("IFC")&&!o.has(u))return u}}const s=[t.ifcClass,t.IfcClass,t.type,t.Type,t.expressType,t.ExpressType,t.entity,t.Entity,t.attributes?.ifcClass,t.Attributes?.IfcClass];for(const a of s)if(typeof a=="string"&&a.trim().length){const u=a.trim().toUpperCase();if(!o.has(u))return a.trim()}const f=O(e,["ifcclass","ifc type","type"]);if(f){const a=f.trim().toUpperCase();if(!o.has(a))return f}return"IfcProduct"},H=(e,t,o)=>{const s={},f={},a={};z(e).forEach(d=>{const P=d.label.split("/").map(y=>y.trim()),n=d.rawPsetName??P[1]??"",r=d.rawPropertyName??P[P.length-1]??"",i=G(n),l=G(r);if(!i||!l)return;f[i]||(f[i]={}),l in f[i]||(f[i][l]=d.value);const p=`${i}.${l}`;p in s||(s[p]=d.value)}),s.GlobalId=t,s.ifcClass=o,a.ifcClass=o,a.GlobalId=t,s["Attributes.GlobalId"]=t,s["Attributes.IfcClass"]=o,s["Attributes.ifcClass"]=o;const m=L(e);m&&(a.Name=m,s["Attributes.Name"]=m);const A=O(e,["category","ifccategory"]);A&&(a.Category=A,s["Attributes.Category"]=A);const b=O(e,["type","typename"]);if(b&&(a.Type=b,s["Attributes.Type"]=b),e&&typeof e=="object"&&!Array.isArray(e))for(const[d,P]of Object.entries(e)){if(P==null||typeof P!="object"||Array.isArray(P))continue;const n=N(P);if(!n)continue;const r=String(d).replace(/^_+/,""),i=`Attributes.${R(r)}`;if(i in s||(s[i]=n),r in a||(a[r]=n),/guid|globalid|_guid/i.test(d)){const l=n.trim();l&&!s.GlobalId&&(s.GlobalId=l,a.GlobalId=l,s["Attributes.GlobalId"]=l)}}return{flattened:s,psets:f,attributes:a}};let C=[],w=new Set,_=0,j=0,S=!1;const $=()=>{C=[],w=new Set,_=0,j=0,S=!1},W=e=>{if(e.reset&&$(),typeof e.total=="number"&&!Number.isNaN(e.total)&&(_=e.total),!S){if(Array.isArray(e.elements)&&e.elements.length){for(const o of e.elements){if(S)break;const s=o.globalId?.trim();if(!s||w.has(s))continue;const f=o.data;if(!f||typeof f!="object")continue;const a=o.ifcClass&&o.ifcClass.trim().length?o.ifcClass.trim():K(f),{flattened:u}=H(f,s,a),m={GlobalId:s,ifcClass:a,properties:u};w.add(s),C.push(m)}j=Math.min(C.length,_||C.length);const t={type:"progress",done:j,total:_||Math.max(C.length,j)};h.postMessage(t)}if(e.final){if(S){const t={type:"error",message:"Build cancelled"};h.postMessage(t)}else{const t={type:"done",elements:C};h.postMessage(t)}$()}}};h.onmessage=e=>{const t=e.data;if(t)switch(t.type){case"build-props":W(t);break;case"cancel":S=!0,h.postMessage({type:"error",message:"Build cancelled"}),$();break;default:h.postMessage({type:"error",message:"Unknown message type"})}}})();
