import{cm as f,co as s,cH as De,cF as oe,cp as x,e1 as Pe,cq as I,cs as v,cI as Re,cJ as ke,cK as ze,cr as le,dZ as we,e2 as Be,dL as H,ds as Me,cP as q,e3 as re,dA as ae,cA as Y,dG as Ne,dI as Oe,d3 as Fe,d4 as Ve,d5 as Ee,d6 as Te,dn as ie,e4 as Le,e5 as ce,cO as We,e6 as _e}from"./vendor-CG379c7K.js";const B=["IfcWall","IfcWallStandardCase","IfcSlab","IfcRoof","IfcWindow","IfcDoor","IfcColumn","IfcBeam","IfcStair","IfcStairFlight","IfcRailing","IfcCurtainWall","IfcPlate","IfcMember","IfcBuildingElementProxy","IfcFurnishingElement","IfcFlowTerminal","IfcSpace","IfcDuctSegment","IfcPipeSegment","IfcFlowFitting","IfcFlowController","IfcDiscreteAccessory"],Ge=[{value:"equals",label:"="},{value:"not-equals",label:"≠"},{value:"contains",label:"contains"},{value:"matches",label:"regex"},{value:"greater-than",label:">"},{value:"less-than",label:"<"},{value:"exists",label:"exists"}];function He({open:M,onClose:ue,viewerApi:a}){const N=f.useRef(null),S=f.useMemo(()=>{try{const e=localStorage.getItem("savora_filter_state_v1");return e?JSON.parse(e):null}catch{return null}},[]),[C,de]=f.useState(S?.isMinimized??!1),[D,fe]=f.useState(S?.size||{width:450,height:600}),P=f.useRef(!1),O=f.useRef(null),R=f.useCallback(e=>{if(!P.current)return;const t=O.current;if(!t)return;const n=e.clientX-t.startX,o=e.clientY-t.startY,c=300,l=200;fe(r=>{const d=Math.max(c,t.width+n),i=Math.max(l,t.height+o);return d===r.width&&i===r.height?r:{width:Math.round(d),height:Math.round(i)}})},[]),F=f.useCallback(()=>{P.current&&(P.current=!1,O.current=null,window.removeEventListener("pointermove",R),window.removeEventListener("pointerup",F))},[R]),he=f.useCallback(e=>{e.preventDefault(),e.stopPropagation();const t=N.current;t&&(P.current=!0,O.current={startX:e.clientX,startY:e.clientY,width:t.offsetWidth,height:t.offsetHeight},window.addEventListener("pointermove",R),window.addEventListener("pointerup",F))},[R,F]),[g,V]=f.useState(S?.selectedCategories||[]),[pe,E]=f.useState(B),[X,J]=f.useState(!1),[j,T]=f.useState(S?.rules||[]),[ge,xe]=f.useState([]),[ye,K]=f.useState(!1),[L,Z]=f.useState(S?.ruleValuesCache||{}),[Q,U]=f.useState(null),[k,me]=f.useState(S?.filterMode||"ghost");f.useEffect(()=>{const e={isMinimized:C,selectedCategories:g,rules:j,ruleValuesCache:L,filterMode:k,size:D};localStorage.setItem("savora_filter_state_v1",JSON.stringify(e))},[C,g,j,L,k,D]);const[A,ee]=f.useState(!1),[z,W]=f.useState(null),h=f.useCallback(e=>{if(e==null)return null;const t=e&&typeof e=="object"&&"value"in e?e.value:e;if(t==null)return null;if(typeof t!="object")return t;if("NominalValue"in t)return h(t.NominalValue);if("nominalValue"in t)return h(t.nominalValue);if("Value"in t)return h(t.Value);for(const o of["Label","Name","Description","StringValue","BooleanValue","IntegerValue","RealValue"])if(o in t)return h(t[o]);const n=Object.keys(t);return n.length===1&&typeof t[n[0]]!="object"?t[n[0]]:JSON.stringify(t)},[]),_=f.useCallback((e,t)=>{if(!t)return;if(t==="expressID")return e.expressID;if(!t.includes(".")){let l=e[t];if(l===void 0&&e.attributes&&(l=e.attributes[t]),l===void 0){const r=t.toLowerCase(),d=e.attributes?Object.keys(e.attributes).find(i=>i.toLowerCase()===r):void 0;if(d&&e.attributes&&(l=e.attributes[d]),l===void 0){const i=Object.keys(e).find(u=>u.toLowerCase()===r);i&&(l=e[i])}}return h(l)}const[n,o]=t.split("."),c=e.IsDefinedBy||e.isDefinedBy;if(Array.isArray(c))for(const l of c){const r=l.RelatingPropertyDefinition??l;if(h(r.Name)===n){const i=r.HasProperties||r.hasProperties;if(Array.isArray(i)){for(const u of i)if(h(u.Name)===o)return h(u)}}}if(e.psets&&e.psets[n]&&e.psets[n][o])return h(e.psets[n][o])},[h]),be=async()=>{if(a){J(!0);try{if(a.getLoadedCategories){const o=await a.getLoadedCategories();if(o&&o.length>0){E(o),g.length===0&&V([o[0]]);return}}if(!a.getItemsByCategory)return;const e=[],t=[],n=5;for(let o=0;o<B.length;o+=n)t.push(B.slice(o,o+n));for(const o of t){const c=o.map(async r=>{if(!a.getItemsByCategory)return null;const d=await a.getItemsByCategory([new RegExp(`^${r}$`,"i")]);return Object.values(d).reduce((u,p)=>u+p.length,0)>0?r:null}),l=await Promise.all(c);e.push(...l.filter(r=>r!==null))}E(e.sort()),e.length>0&&g.length===0&&V([e[0]])}catch(e){console.error(e),E(B)}finally{J(!1)}}};f.useEffect(()=>{if(g.length===0||!M||!a)return;let e=!0;return(async()=>{if(!(!a.getItemsByCategory||!a.getItemsDataByModel)){K(!0);try{const n=new Set;["Name","GlobalId","Tag","Description","ObjectType","expressID"].forEach(l=>n.add(l));const o=g.map(l=>new RegExp(`^${l}$`,"i")),c=await a.getItemsByCategory(o);for(const[l,r]of Object.entries(c)){const d=r.slice(0,10);if(d.length===0)continue;const i={attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}},u=await a.getItemsDataByModel(l,d,i);for(const p of u){const y=p.IsDefinedBy||p.isDefinedBy;if(Array.isArray(y))for(const m of y){const b=m.RelatingPropertyDefinition??m,w=h(b.Name);if(!w)continue;const se=b.HasProperties||b.hasProperties;if(Array.isArray(se))for(const ve of se){const ne=h(ve.Name);ne&&n.add(`${w}.${ne}`)}}}}e&&xe(Array.from(n).sort())}catch(n){console.error("Prop discovery failed",n)}finally{e&&K(!1)}}})(),()=>{e=!1}},[g,M,a,h]);const te=f.useCallback((e,t)=>{if(!t.property||t.operator!=="exists"&&t.values.length===0)return!0;const n=_(e,t.property),o=String(n??"").trim().toLowerCase();if(t.operator==="exists")return n!=null&&o!=="";const c=t.operator==="not-equals";let l=c;for(const r of t.values){const d=r.trim().toLowerCase();let i=!1;if(typeof n=="boolean"){const u=d.toLowerCase(),p=u==="false"||u==="0"||u==="no",y=u==="true"||u==="1"||u==="yes";let m=null;p?m=!1:y&&(m=!0),m!==null?i=n===m:i=o===d}else switch(t.operator){case"equals":case"not-equals":i=o===d;break;case"contains":i=o.includes(d);break;case"matches":try{i=new RegExp(d,"i").test(o)}catch{i=!1}break;case"greater-than":i=Number(n)>Number(r);break;case"less-than":i=Number(n)<Number(r);break}if(c){if(i){l=!1;break}}else if(i){l=!0;break}}return l},[_]),G=async(e,t,n=[])=>{if(!(!t||g.length===0||!a)&&!(!a.getItemsByCategory||!a.getItemsDataByModel)){U(e);try{const o=g.map(d=>new RegExp(`^${d}$`,"i")),c=await a.getItemsByCategory(o),l=new Set;let r=t.includes(".");n.forEach(d=>{d.property&&d.property.includes(".")&&(r=!0)});for(const[d,i]of Object.entries(c)){const u=i.slice(0,300);if(u.length===0)continue;const p=r?{attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}}:{attributesDefault:!0,attributes:["GlobalId"]},y=await a.getItemsDataByModel(d,u,p);for(const m of y){if(!n.every(w=>te(m,w)))continue;const b=_(m,t);b!=null&&(typeof b=="number"?l.add(b.toString()):typeof b=="string"&&b.trim()!==""?l.add(b):typeof b=="boolean"&&l.add(b?"True":"False"))}}Z(d=>({...d,[e]:Array.from(l).sort()}))}catch(o){console.warn(o)}finally{U(null)}}},Ie=()=>{const e={id:_e(),property:null,operator:"equals",values:[]};T([...j,e])},je=e=>{T(t=>{const n=t.findIndex(c=>c.id===e),o=t.filter(c=>c.id!==e);if(n!==-1)for(let c=n;c<o.length;c++){const l=o[c];if(l.property){const r=o.slice(0,c);G(l.id,l.property,r)}}return o}),Z(t=>{const n={...t};return delete n[e],n})},$=(e,t)=>{T(n=>{const o=n.map(l=>{if(l.id!==e)return l;const r={...l,...t};return t.property!==void 0&&t.property!==l.property&&(r.values=[]),r}),c=o.findIndex(l=>l.id===e);if(c!==-1){const l=o[c],r=n[c];if(t.property!==void 0&&t.property!==r.property&&l.property){const i=o.slice(0,c);G(e,l.property,i)}if(t.property!==void 0||t.operator!==void 0||t.values!==void 0)for(let i=c+1;i<o.length;i++){const u=o[i];if(u.property){const p=o.slice(0,i);G(u.id,u.property,p)}}}return o})},Ce=async()=>{if(!(!a||!a.getItemsByCategory||!a.getItemsDataByModel)){if(g.length===0){alert("Please select at least one category.");return}ee(!0),W(null);try{const e=g.map(r=>new RegExp(`^${r}$`,"i")),t=await a.getItemsByCategory(e);let n=0,o=[],c=!1;j.forEach(r=>{r.property&&r.property.includes(".")&&(c=!0)});const l=c?{attributesDefault:!0,relations:{IsDefinedBy:{attributes:!0,relations:!0}}}:{attributesDefault:!0,attributes:["GlobalId"]};for(const[r,d]of Object.entries(t)){if(n+=d.length,j.length===0){const u=await a.getItemsDataByModel(r,d,l);for(const p of u){let y=h(p.GlobalId)||h(p._guid);!y&&p.attributes&&(y=h(p.attributes.GlobalId)||h(p.attributes.GlobalID)),y&&o.push(y)}continue}const i=await a.getItemsDataByModel(r,d,l);for(const u of i){let p=h(u.GlobalId)||h(u._guid);if(!p&&u.attributes&&(p=h(u.attributes.GlobalId)||h(u.attributes.GlobalID)),!p)continue;let y=!0;for(const m of j)if(!te(u,m)){y=!1;break}y&&o.push(p)}}W({found:o.length,total:n}),a.clearIsolation&&await a.clearIsolation(),a.clearColors&&await a.clearColors(),o.length>0&&(k==="isolate"?await a.isolate(o):a.ghost?await a.ghost(o):await a.color(o,{r:.9,g:.9,b:.9,a:.5}),a.fitViewTo&&await a.fitViewTo(o))}catch(e){console.error(e),alert("Filter failed: "+e)}finally{ee(!1)}}},Se=async()=>{a&&(a.clearIsolation&&await a.clearIsolation(),a.clearColors&&await a.clearColors(),W(null))};return M?s.jsx(De,{nodeRef:N,handle:".filter-header",bounds:"parent",children:s.jsxs(oe,{ref:N,elevation:8,sx:{position:"fixed",top:120,left:30,width:D.width,height:C?"auto":D.height,minWidth:300,minHeight:C?50:200,maxWidth:"90vw",maxHeight:"85vh",display:"flex",flexDirection:"column",zIndex:1800,boxSizing:"border-box",overflow:"hidden"},children:[s.jsxs(x,{className:"filter-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move"},children:[s.jsxs(x,{sx:{display:"flex",alignItems:"center",gap:1},children:[s.jsx(Pe,{}),s.jsx(I,{variant:"subtitle1",children:"Parametric Filter"})]}),s.jsxs(x,{children:[s.jsx(v,{size:"small",color:"inherit",onClick:()=>de(!C),children:C?s.jsx(Re,{}):s.jsx(ke,{})}),s.jsx(v,{size:"small",color:"inherit",onClick:ue,children:s.jsx(ze,{})})]})]}),!C&&s.jsxs(x,{sx:{p:2,overflowY:"auto",flex:1,display:"flex",flexDirection:"column",gap:2},children:[s.jsxs(x,{children:[s.jsxs(x,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[s.jsx(I,{variant:"subtitle2",color:"primary",children:"1. Categories (Scope)"}),s.jsxs(x,{children:[s.jsx(le,{PopperProps:{sx:{zIndex:2100}},title:s.jsxs(x,{sx:{p:.5},children:[s.jsx(I,{variant:"subtitle2",sx:{fontWeight:"bold",mb:.5},children:"Parametric Filter Guide"}),s.jsxs(I,{variant:"caption",display:"block",children:["• Select ",s.jsx("b",{children:"Categories"})," to define scope."]}),s.jsxs(I,{variant:"caption",display:"block",children:["• Add ",s.jsx("b",{children:"Rules"})," to filter by properties."]}),s.jsx(I,{variant:"caption",display:"block",children:"• Multiple rules are combined (AND)."}),s.jsx(I,{variant:"caption",display:"block",children:"• Dropdown values depend on previous rules."})]}),arrow:!0,placement:"left",children:s.jsx(v,{size:"small",sx:{mr:1,color:"text.secondary"},children:s.jsx(we,{fontSize:"small"})})}),s.jsx(v,{onClick:be,size:"small",disabled:X,children:s.jsx(le,{title:"Scan Model",children:s.jsx(Be,{fontSize:"small"})})})]})]}),s.jsx(H,{multiple:!0,size:"small",options:pe,value:g,onChange:(e,t)=>V(t),disableCloseOnSelect:!0,disabled:X,renderOption:(e,t,{selected:n})=>s.jsxs("li",{...e,children:[s.jsx(re,{style:{marginRight:8},checked:n}),t]}),renderInput:e=>s.jsx(q,{...e,placeholder:g.length===0?"Select Categories...":"",helperText:g.length===0?"Select at least one category":`${g.length} selected`}),renderTags:(e,t)=>e.slice(0,2).map((n,o)=>s.jsx(Me,{label:n,size:"small",...t({index:o})})),componentsProps:{popper:{style:{zIndex:9999}}}}),g.length>2&&s.jsxs(I,{variant:"caption",sx:{ml:1,color:"text.secondary"},children:["(+ ",g.length-2," more)"]})]}),s.jsx(ae,{}),s.jsxs(x,{children:[s.jsxs(x,{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,children:[s.jsx(I,{variant:"subtitle2",color:"primary",children:"2. Property Rules"}),s.jsx(Y,{startIcon:s.jsx(Ne,{}),size:"small",onClick:Ie,children:"Add Rule"})]}),j.length===0&&s.jsxs(I,{variant:"body2",color:"text.secondary",align:"center",sx:{py:2},children:["No property filters applied.",s.jsx("br",{}),"All elements in matching categories will be shown."]}),s.jsx(x,{display:"flex",flexDirection:"column",gap:2,children:j.map((e,t)=>s.jsxs(oe,{variant:"outlined",sx:{p:1.5,position:"relative",bgcolor:"grey.50"},children:[s.jsx(v,{size:"small",onClick:()=>je(e.id),sx:{position:"absolute",top:2,right:2},children:s.jsx(Oe,{fontSize:"small"})}),s.jsxs(I,{variant:"caption",sx:{color:"text.secondary",mb:1,display:"block"},children:["Rule #",t+1," (AND)"]}),s.jsxs(x,{display:"flex",flexDirection:"column",gap:1.5,children:[s.jsx(H,{size:"small",options:ge,value:e.property,onChange:(n,o)=>$(e.id,{property:o}),disabled:g.length===0||ye,freeSolo:!0,groupBy:n=>n.includes(".")?"Property Sets":"Attributes",renderInput:n=>s.jsx(q,{...n,label:"Property",placeholder:"Choose property..."}),componentsProps:{popper:{style:{zIndex:9999}}}}),s.jsxs(x,{display:"flex",gap:1,children:[s.jsxs(Fe,{size:"small",sx:{minWidth:100},children:[s.jsx(Ve,{children:"Operator"}),s.jsx(Ee,{value:e.operator,label:"Operator",onChange:n=>$(e.id,{operator:n.target.value}),MenuProps:{style:{zIndex:9999}},children:Ge.map(n=>s.jsx(Te,{value:n.value,children:n.label},n.value))})]}),s.jsx(H,{fullWidth:!0,multiple:!0,size:"small",freeSolo:!0,options:L[e.id]||[],value:e.values,onChange:(n,o)=>$(e.id,{values:o}),disabled:!e.property||e.operator==="exists",loading:Q===e.id,disableCloseOnSelect:!0,limitTags:2,renderOption:(n,o,{selected:c})=>s.jsxs("li",{...n,children:[s.jsx(re,{style:{marginRight:8},checked:c}),o]}),renderInput:n=>s.jsx(q,{...n,label:"Values (OR)",placeholder:e.operator==="exists"?"N/A":"Select values...",InputProps:{...n.InputProps,endAdornment:s.jsxs(s.Fragment,{children:[Q===e.id?s.jsx(ie,{color:"inherit",size:20}):null,n.InputProps.endAdornment]})}}),componentsProps:{popper:{style:{zIndex:9999}}}})]})]})]},e.id))})]}),s.jsx(ae,{}),s.jsxs(x,{children:[s.jsx(I,{variant:"subtitle2",gutterBottom:!0,children:"Display Mode"}),s.jsxs(Le,{value:k,exclusive:!0,onChange:(e,t)=>t&&me(t),size:"small",fullWidth:!0,color:"primary",children:[s.jsx(ce,{value:"ghost",children:"Ghost (Translucent)"}),s.jsx(ce,{value:"isolate",children:"Isolate (Hide Others)"})]})]}),z&&s.jsxs(We,{severity:z.found>0?"success":"warning",sx:{mt:1},children:["Matched: ",z.found," / ",z.total]}),s.jsxs(x,{sx:{display:"flex",gap:1,mt:1},children:[s.jsx(Y,{variant:"contained",fullWidth:!0,onClick:Ce,disabled:A||g.length===0,children:A?s.jsx(ie,{size:24,color:"inherit"}):"Apply Filter"}),s.jsx(Y,{variant:"outlined",onClick:Se,children:"Clear"})]})]}),s.jsx(x,{onPointerDown:he,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,zIndex:20}})]})}):null}export{He as default};
