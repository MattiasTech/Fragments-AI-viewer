import{dN as He,dO as Ue,dP as We,dQ as ft,dR as mt,cm as h,co as e,cH as nt,cF as rt,cp as w,cq as b,cs as pe,cI as it,cJ as lt,cK as ct,cO as Ye,d3 as Fe,d4 as yt,d5 as Me,d6 as Q,cA as Y,dn as Je,ds as et,cP as we,dF as bt,cR as gt,dp as Ct,dS as Le,dT as $e,dU as Ne,dV as oe,dW as c,dG as xt,dX as Oe,dY as tt,dI as jt,cn as Ae,cr as wt,dZ as It,cy as vt,d_ as St,cG as Tt,cM as kt,cN as st,d$ as Pt,e0 as Et}from"./vendor-CG379c7K.js";import{s as dt,a as ut,c as Dt,d as Ft,l as ot}from"./index-fo5gKbIB.js";import"./thatopen-vendor-BXeQhCq_.js";import"./three-vendor-kQcUiZz9.js";function Mt(g,a){let u;return(...f)=>{clearTimeout(u),u=setTimeout(()=>{g(...f)},a)}}class $t{fileHandle=null;data=[];onDataLoaded=null;saveToFile=Mt(async()=>{if(!this.fileHandle||!this.data.length)return;const a=new We.Workbook,u=a.addWorksheet("CostData");u.columns=Object.keys(this.data[0]).map(m=>({header:m,key:m})),u.addRows(this.data);const f=await a.xlsx.writeBuffer(),R=await this.fileHandle.createWritable();await R.write(f),await R.close(),console.log("Database auto-saved!")},2e3);async initialize(a){this.onDataLoaded=a;const u=await He("cost-db-handle");u&&await u.queryPermission({mode:"readwrite"})==="granted"&&(this.fileHandle=u,await this.loadData())}async connectToFile(){try{const[a]=await window.showOpenFilePicker({types:[{description:"Excel Files",accept:{"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":[".xlsx"]}}]});a&&(await a.requestPermission({mode:"readwrite"}),this.fileHandle=a,await Ue("cost-db-handle",a),await this.loadData())}catch(a){console.error("Error connecting to file:",a)}}async loadData(){if(!this.fileHandle)return;const u=await(await this.fileHandle.getFile()).arrayBuffer(),f=new We.Workbook;await f.xlsx.load(u);const R=f.worksheets[0];if(!R)return;const m=[],$=R.getRow(1);if(!$.values||!Array.isArray($.values))return;const A=$.values.slice(1);R.eachRow((J,W)=>{if(W===1)return;const E={},N=J.values;A.forEach((ie,_)=>{E[ie]=N[_+1]}),m.push(E)}),this.data=m,this.onDataLoaded&&this.onDataLoaded(this.data)}updateData(a){this.data=a,this.saveToFile()}getData(){return this.data}isConnected(){return!!this.fileHandle}}const pt="qto-current-mappings",Ze="qto-template-";async function Nt(g){await Ue(pt,g)}async function ht(){return await He(pt)||[]}async function at(g){await Ue(`${Ze}${g.id}`,g)}async function Ot(){const a=(await ft()).filter(f=>typeof f=="string"&&f.startsWith(Ze)),u=[];for(const f of a){const R=await He(f);R&&u.push(R)}return u.sort((f,R)=>new Date(R.createdAt).getTime()-new Date(f.createdAt).getTime())}async function zt(g){await mt(`${Ze}${g}`)}function Bt(g){return JSON.stringify(g,null,2)}function Rt(g){const a=JSON.parse(g);if(!a.id||!a.name||!Array.isArray(a.mappings))throw new Error("Invalid template format");return a}function Ke(g){if(!g)return null;const a=g.toLowerCase();return a.includes("volume")||a.includes("netvolume")||a.includes("grossvolume")||a.includes("liquidvolume")?"volume":a.includes("area")||a.includes("netarea")||a.includes("grossarea")||a.includes("sidewallarea")||a.includes("footprintarea")||a.includes("netsidearea")||a.includes("grosssidearea")?"area":a.includes("length")||a.includes("netlength")||a.includes("grosslength")||a.includes("perimeter")||a.includes("height")||a.includes("width")||a.includes("depth")||a.includes("diameter")||a.includes("radius")?"length":a.includes("mass")||a.includes("weight")||a.includes("netmass")||a.includes("grossmass")?"weight":a.includes("quantity")||a.includes("count")||a.includes("number")?"count":null}function qt(g){const a=g.toLowerCase();return a.includes("slab")||a.includes("beam")||a.includes("column")?"volume":a.includes("wall")||a.includes("pipe")||a.includes("rebar")||a.includes("reinforcement")?"length":a.includes("wall")||a.includes("door")||a.includes("window")||a.includes("slab")?"area":a.includes("cable")||a.includes("reinforcement")||a.includes("plate")?"weight":(a.includes("fastener")||a.includes("fixture"),"count")}async function At(g,a,u,f,R){const m=`You are an expert in BIM (Building Information Modeling) and construction cost estimation.

I have IFC elements from a BIM model and a cost database. Please suggest the best mappings between IFC classes and cost items.

IFC Classes found in the model:
${g.map((E,N)=>`${N+1}. ${E}`).join(`
`)}

Cost Database Items (WBS Code: Description - Unit):
${a.map((E,N)=>`${N+1}. ${E.wbsCode}: ${E.description} (${E.unit})`).join(`
`)}

Please analyze and return a JSON array of mappings with confidence scores. Format:
[
  {
    "ifcClass": "IfcWall",
    "wbsCode": "3.1.1",
    "confidence": 0.95,
    "reasoning": "Walls map to drywall partition based on description"
  }
]

Rules:
1. Only suggest mappings where you have high confidence (>0.7)
2. Consider the unit of measurement (m, m2, m3, pcs, kg)
3. MEP elements (pipes, ducts, cables) should map to MEP cost items
4. Structural elements (beams, columns, slabs) should map to structural items
5. Architectural elements (walls, doors, windows) should map to architectural items
6. If no good match exists, omit that IFC class from the results

Return ONLY the JSON array, no additional text.`;let $;u==="gemini"?$=await dt(f,m,R):$=await ut(f,m,R);const A=$.match(/\[[\s\S]*\]/);if(!A)throw new Error("AI did not return valid JSON array");return JSON.parse(A[0]).filter(E=>E.ifcClass&&E.wbsCode&&typeof E.confidence=="number"&&E.confidence>=.7&&g.includes(E.ifcClass)&&a.some(N=>N.wbsCode===E.wbsCode))}async function Lt(g,a,u,f,R,m,$){const A={};if(u.attributes&&Object.entries(u.attributes).forEach(([_,H])=>{(typeof H=="number"||typeof H=="string"&&!isNaN(parseFloat(H)))&&(A[`attributes.${_}`]=H)}),u.IsDefinedBy&&Object.entries(u.IsDefinedBy).forEach(([_,H])=>{H&&typeof H=="object"&&Object.entries(H).forEach(([ae,V])=>{(typeof V=="number"||typeof V=="string"&&!isNaN(parseFloat(V)))&&(A[`${_}.${ae}`]=V)})}),Object.keys(A).length===0)throw new Error("No numeric properties found in sample element");const J=`You are an expert in IFC (Industry Foundation Classes) BIM data extraction.

I need to extract quantity from this IFC element for cost estimation:
- IFC Class: ${g}
${a?`- Object Type: ${a}`:""}
- Required Unit: ${f}

Available numeric properties from a sample element:
${Object.entries(A).map(([_,H])=>`  - ${_}: ${H}`).join(`
`)}

Please analyze and suggest the BEST property to use for quantity extraction.

Guidelines:
- For "m" (linear): Use Length, Height, or similar linear properties
- For "m2" (area): Use Area, NetArea, GrossArea, NetSideArea, or similar
- For "m3" (volume): Use Volume, NetVolume, GrossVolume, or similar  
- For "kg" (mass): Use Mass, NetMass, GrossMass, or similar
- For "pcs" (count): Usually count elements as 1 each, but may use Quantity if available
- Consider property naming conventions (e.g., "Qto_*BaseQuantities" are official quantity sets)
- Prefer "Net" values over "Gross" when both exist

Return ONLY a JSON object with this format:
{
  "propertyName": "exact.property.path",
  "reasoning": "brief explanation of why this property is best"
}`;let W;R==="gemini"?W=await dt(m,J,$):W=await ut(m,J,$);const E=W.match(/\{[\s\S]*\}/);if(!E)throw new Error("AI did not return valid JSON");const N=JSON.parse(E[0]);if(!N.propertyName||!N.reasoning)throw new Error("AI response missing required fields");const ie=Ke(N.propertyName);return{propertyName:N.propertyName,reasoning:N.reasoning,quantityType:ie||void 0}}function Wt({open:g,onClose:a,viewerApi:u,costItems:f,onMappingsUpdated:R}){const[m,$]=h.useState([]),[A,J]=h.useState([]),[W,E]=h.useState({}),[N,ie]=h.useState({}),[_,H]=h.useState({}),[ae,V]=h.useState({}),[Ie,ze]=h.useState(()=>Dt("qtoMappingScanScope")||"selected"),[le,ge]=h.useState(!1),[he,ve]=h.useState(!1),[K,ce]=h.useState([]),[Ce,re]=h.useState(""),[Be,k]=h.useState(null),[de,Qe]=h.useState(!1),[Se,Te]=h.useState({width:900,height:700}),fe=h.useRef(null),ue=h.useRef(!1),ke=h.useRef(null),Pe=h.useCallback(t=>{if(!ue.current||!ke.current)return;const s=ke.current,n=t.clientX-s.startX,r=t.clientY-s.startY,d=Math.max(500,s.width+n),p=Math.max(400,s.height+r);Te({width:Math.round(d),height:Math.round(p)})},[]),xe=h.useCallback(()=>{ue.current=!1,ke.current=null,window.removeEventListener("pointermove",Pe),window.removeEventListener("pointerup",xe),document.body.style.cursor=""},[Pe]),me=h.useCallback(t=>{t.preventDefault(),t.stopPropagation();const s=fe.current;s&&(ue.current=!0,ke.current={startX:t.clientX,startY:t.clientY,width:s.offsetWidth,height:s.offsetHeight},document.body.style.cursor="nwse-resize",window.addEventListener("pointermove",Pe),window.addEventListener("pointerup",xe))},[Pe,xe]);h.useEffect(()=>()=>{xe()},[xe]),h.useEffect(()=>{g&&(ht().then($),Ot().then(ce),He("qto_scan_cache").then(t=>{t&&t.classes&&t.classes.length>0&&(console.log("Restoring cached scan data",t),J(t.classes),E(t.counts||{}),ie(t.objectTypes||{}),H(t.properties||{}),V(t.samples||{}))}).catch(t=>console.error("Error loading scan cache:",t)))},[g]);const Ee=t=>{const s=[],n=r=>r&&typeof r=="object"&&"value"in r?r.value:r;if(t.attributes&&Object.entries(t.attributes).forEach(([r,d])=>{const p=n(d);(typeof p=="number"||typeof p=="string"&&!isNaN(parseFloat(p)))&&s.push(r)}),Array.isArray(t.IsDefinedBy))for(const r of t.IsDefinedBy){const d=n(r.Name)||n(r._category);if(d&&r.HasProperties&&Array.isArray(r.HasProperties))for(const p of r.HasProperties){const D=n(p.Name)||n(p._category),q=n(p.NominalValue)||n(p.value);D&&(typeof q=="number"||typeof q=="string"&&!isNaN(parseFloat(q)))&&s.push(`${d}.${D}`)}}return s},_e=async()=>{if(u){ge(!0),k(null);try{let t=[],s=Ie;if(Ie==="selected")if(u.getSelectedGlobalIds){if(t=await u.getSelectedGlobalIds(),t.length===0){k('No elements selected. Please select elements or change scan scope to "All" or "Visible".'),ge(!1);return}}else k("Selected scope not supported. Using all elements instead."),s="all";else if(Ie==="visible")if(u.getVisibleGlobalIds){if(t=await u.getVisibleGlobalIds(),t.length===0){k("No visible elements found. Please ensure elements are visible or change scan scope."),ge(!1);return}}else k("Visible scope not supported. Using all elements instead."),s="all";const n=new Map,r=new Map,d=new Map,p=new Map;if(s==="all"||t.length===0){if(!u.getItemsByCategory||!u.getItemsDataByModel){k("Required API methods not available"),ge(!1);return}const G=await u.getItemsByCategory([/.*/]);for(const[C,j]of Object.entries(G)){if(!j||j.length===0)continue;const be=100;for(let M=0;M<j.length;M+=be){const v=j.slice(M,M+be);try{const S=await u.getItemsDataByModel(C,v,{attributesDefault:!0,attributes:["Name","Description","ObjectType","PredefinedType","Tag"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}});M===0&&S.length>0&&console.log("Sample itemData structure:",S[0]);const z=T=>T&&typeof T=="object"&&"value"in T?T.value:T;for(const T of S){const te=T._category;let L="IfcProduct";if(te&&typeof te=="object"&&te.value?L=te.value:typeof te=="string"&&(L=te),typeof L=="string"&&L.toUpperCase().startsWith("IFC")){if(n.set(L,(n.get(L)||0)+1),!p.has(L)){p.set(L,T);const X=Ee(T);X.length>0&&d.set(L,new Set(X))}const ne=z(T._guid);if(!ne)continue;try{const X=await u.getElementProps(ne);let se;if(X?.psets)for(const y in X.psets){const B=X.psets[y];if(B&&typeof B=="object"&&(se=B.Description||B.Type||B.Profile||B.ObjectType||B.PredefinedType||B.Reference,se&&typeof se=="string"&&se.trim()))break}if(!se&&X?.attributes){const y=X.attributes;se=y.ObjectType||y.PredefinedType||y.Tag||y.Description||y.Name}se&&typeof se=="string"&&se.trim()!==""&&(r.has(L)||r.set(L,new Set),r.get(L).add(se.trim()))}catch{}}}}catch(S){console.warn(`Failed to scan batch in model ${C}:`,S)}}}}else for(let C=0;C<t.length;C+=50){const j=t.slice(C,C+50);for(const be of j)try{const M=await u.getElementProps(be),v=M.ifcClass;if(typeof v=="string"&&v.toUpperCase().startsWith("IFC")){if(n.set(v,(n.get(v)||0)+1),!p.has(v)){const z={attributes:M.attributes,IsDefinedBy:M.psets,constructor:{name:v}};p.set(v,z);const T=[];if(M.attributes){const te=M.attributes;Object.entries(te).forEach(([L,ne])=>{(typeof ne=="number"||typeof ne=="string"&&!isNaN(parseFloat(ne)))&&T.push(L)})}M.psets&&Object.entries(M.psets).forEach(([te,L])=>{L&&typeof L=="object"&&Object.entries(L).forEach(([ne,X])=>{(typeof X=="number"||typeof X=="string"&&!isNaN(parseFloat(X)))&&T.push(`${te}.${ne}`)})}),T.length>0&&d.set(v,new Set(T))}let S;if(M.psets)for(const z in M.psets){const T=M.psets[z];if(T&&typeof T=="object"&&(S=T.Description||T.Type||T.Profile||T.ObjectType||T.PredefinedType||T.Reference,S&&typeof S=="string"&&S.trim()))break}if(!S&&M.attributes){const z=M.attributes;S=z.ObjectType||z.PredefinedType||z.Tag||z.Description||z.Name}S&&typeof S=="string"&&S.trim()!==""&&(r.has(v)||r.set(v,new Set),r.get(v).add(S.trim()))}}catch(M){console.warn(`Failed to get props for ${be}:`,M)}}const D=Array.from(n.keys()).sort(),q={};n.forEach((G,C)=>{q[C]=G});const ye={};r.forEach((G,C)=>{ye[C]=Array.from(G).sort()});const P={};d.forEach((G,C)=>{P[C]=Array.from(G).sort()});const Z={};p.forEach((G,C)=>{Z[C]=G}),J(D),E(q),ie(ye),H(P),V(Z);const ee={classes:D,counts:q,objectTypes:ye,properties:P,samples:Z,timestamp:Date.now()};Ue("qto_scan_cache",ee).catch(G=>console.error("Error saving scan cache:",G)),console.log("Scanned properties by class:",P),D.length===0&&k("No IFC classes found in model. Please ensure the model is loaded correctly.")}catch(t){k(`Failed to scan model: ${t.message}`)}finally{ge(!1)}}},Ve=()=>{$([...m,{ifcClass:"",wbsCode:""}])},Ge=t=>{$(m.filter((s,n)=>n!==t))},je=(t,s,n)=>{const r=[...m];if(s==="objectType"&&n===""){const{objectType:d,...p}=r[t];r[t]=p}else if(s==="quantityProperty"&&n===""){const{quantityProperty:d,quantityType:p,propertyConfidence:D,...q}=r[t];r[t]=q}else if(s==="quantityProperty"&&n){const d=Ke(n);r[t]={...r[t],[s]:n,quantityType:d,propertyConfidence:.6}}else s==="quantityType"?r[t]={...r[t],quantityType:n||void 0}:r[t]={...r[t],[s]:n};$(r)},o=async()=>{const t=ot();if(!t||!t.apiKey){k("Please configure AI API key in Settings first");return}if(A.length===0){k("No IFC classes found in model");return}if(f.length===0){k("Please connect to cost database first");return}ve(!0),k(null);try{const s=await At(A,f,t.provider,t.apiKey,t.model||(t.provider==="gemini"?"gemini-2.5-flash":"gpt-4o-mini")),n=new Set(m.map(d=>d.ifcClass)),r=s.filter(d=>!n.has(d.ifcClass));$([...m,...r])}catch(s){k(`AI suggestion failed: ${s.message}`)}finally{ve(!1)}},l=async t=>{const s=ot();if(!s||!s.apiKey){k("Please configure AI API key in Settings first");return}const n=m[t];if(!n.ifcClass||!n.wbsCode||!u)return;const r=f.find(d=>d.wbsCode===n.wbsCode);if(!r){k("Cost item not found");return}ve(!0),k(null);try{let d=ae[n.ifcClass];if(!d){k(`No sample element found for ${n.ifcClass}. Please scan the model first.`);return}const p=await Lt(n.ifcClass,n.objectType,d,r.unit,s.provider,s.apiKey,s.model||(s.provider==="gemini"?"gemini-2.5-flash":"gpt-4o-mini"));let D=p.quantityType||Ke(p.propertyName);D||(D=qt(n.ifcClass));const q=[...m];q[t]={...q[t],quantityProperty:p.propertyName,quantityType:D,propertyConfidence:.85},$(q),console.log("AI Property Suggestion:",p.reasoning,"Type:",D)}catch(d){k(`AI property suggestion failed: ${d.message}`)}finally{ve(!1)}},i=async()=>{const t=m.filter(s=>s.ifcClass&&s.wbsCode);await Nt(t),R(t),a()},I=async()=>{if(!Ce.trim()){k("Please enter a template name");return}const t={id:Date.now().toString(),name:Ce,createdAt:new Date().toISOString(),mappings:m.filter(s=>s.ifcClass&&s.wbsCode)};await at(t),ce([...K,t]),re(""),alert("Template saved successfully!")},F=async t=>{const s=K.find(n=>n.id===t);s&&$(s.mappings)},U=async t=>{confirm("Delete this template?")&&(await zt(t),ce(K.filter(s=>s.id!==t)))},O=()=>{if(m.length===0){k("No mappings to export");return}const t={id:Date.now().toString(),name:Ce||"Exported Mapping",createdAt:new Date().toISOString(),mappings:m.filter(p=>p.ifcClass&&p.wbsCode)},s=Bt(t),n=new Blob([s],{type:"application/json"}),r=URL.createObjectURL(n),d=document.createElement("a");d.href=r,d.download=`qto-mapping-${t.id}.json`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(r)},x=()=>{const t=document.createElement("input");t.type="file",t.accept=".json",t.onchange=async s=>{const n=s.target.files[0];if(n)try{const r=await n.text(),d=Rt(r);await at(d),ce([...K,d]),$(d.mappings),alert("Template imported successfully!")}catch(r){k(`Import failed: ${r.message}`)}},t.click()};return g?e.jsx(nt,{nodeRef:fe,handle:".mapping-dialog-header",bounds:"parent",children:e.jsxs(rt,{ref:fe,sx:{position:"fixed",top:"50%",left:"50%",transform:"translate(-50%, -50%)",width:Se.width,height:de?"auto":Se.height,maxHeight:de?"auto":"90vh",maxWidth:"90vw",zIndex:1350,display:"flex",flexDirection:"column",boxSizing:"border-box"},elevation:24,children:[e.jsxs(w,{className:"mapping-dialog-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,borderBottom:1,borderColor:"divider",cursor:"move",bgcolor:"background.paper"},children:[e.jsx(b,{variant:"h6",children:"Configure IFC to WBS Mapping"}),e.jsxs(w,{children:[e.jsx(pe,{onClick:()=>Qe(!de),size:"small",sx:{color:"inherit",mr:1},title:de?"Expand":"Minimize",children:de?e.jsx(it,{}):e.jsx(lt,{})}),e.jsx(pe,{onClick:a,size:"small",sx:{color:"inherit"},children:e.jsx(ct,{})})]})]}),!de&&e.jsxs(e.Fragment,{children:[e.jsxs(w,{sx:{flex:1,overflow:"auto",p:2},children:[Be&&e.jsx(Ye,{severity:"error",onClose:()=>k(null),sx:{mb:2},children:Be}),e.jsxs(w,{sx:{mb:2},children:[e.jsx(b,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Map IFC element types to your cost database items. You can map entire classes or specific object types (e.g., HEA200, HEB300) to different WBS codes for granular cost control."}),e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:2,mt:2,mb:1},children:[e.jsxs(Fe,{size:"small",sx:{minWidth:150},children:[e.jsx(yt,{children:"Scan Scope"}),e.jsxs(Me,{value:Ie,label:"Scan Scope",onChange:t=>{const s=t.target.value;ze(s),Ft("qtoMappingScanScope",s),J([]),E({})},MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"selected",children:"Selected Elements"}),e.jsx(Q,{value:"visible",children:"Visible Elements"}),e.jsx(Q,{value:"all",children:"All Elements"})]})]}),e.jsx(Y,{variant:"outlined",size:"small",onClick:_e,disabled:le,startIcon:le?e.jsx(Je,{size:16}):void 0,children:le?"Scanning...":"Scan Model"}),A.length>0&&e.jsxs(b,{variant:"body2",color:"primary",children:["Found ",A.length," IFC classes"]})]})]}),e.jsxs(w,{sx:{mb:2,p:2,bgcolor:"background.paper",border:1,borderColor:"divider",borderRadius:1},children:[e.jsx(b,{variant:"subtitle2",gutterBottom:!0,children:"Templates"}),e.jsx(w,{sx:{display:"flex",gap:1,flexWrap:"wrap",mb:1},children:K.map(t=>e.jsx(et,{label:`${t.name} (${t.mappings.length})`,onClick:()=>F(t.id),onDelete:()=>U(t.id),size:"small"},t.id))}),e.jsxs(w,{sx:{display:"flex",gap:1,mt:1},children:[e.jsx(we,{size:"small",placeholder:"Template name",value:Ce,onChange:t=>re(t.target.value),sx:{flex:1}}),e.jsx(Y,{size:"small",startIcon:e.jsx(bt,{}),onClick:I,children:"Save as Template"}),e.jsx(Y,{size:"small",startIcon:e.jsx(gt,{}),onClick:O,children:"Export"}),e.jsx(Y,{size:"small",startIcon:e.jsx(Ct,{}),onClick:x,children:"Import"})]})]}),e.jsx(Le,{sx:{flex:1,minHeight:0},children:e.jsxs($e,{size:"small",stickyHeader:!0,children:[e.jsx(Ne,{children:e.jsxs(oe,{children:[e.jsx(c,{width:"16%",children:"IFC Class"}),e.jsx(c,{width:"14%",children:"Object Type"}),e.jsx(c,{width:"22%",children:"Cost Item (WBS)"}),e.jsx(c,{width:"28%",children:"Quantity Property"}),e.jsx(c,{width:"12%",children:"Qty Type"}),e.jsx(c,{width:"8%",align:"center",children:e.jsx(pe,{size:"small",onClick:Ve,color:"primary",children:e.jsx(xt,{})})})]})}),e.jsxs(Oe,{children:[m.map((t,s)=>e.jsxs(oe,{children:[e.jsx(c,{children:e.jsx(Fe,{fullWidth:!0,size:"small",children:e.jsxs(Me,{value:t.ifcClass,onChange:n=>je(s,"ifcClass",n.target.value),displayEmpty:!0,MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"",children:e.jsx("em",{children:"Select IFC Class"})}),A.map(n=>e.jsxs(Q,{value:n,children:[n," ",W[n]?`(${W[n]} elements)`:""]},n))]})})}),e.jsxs(c,{children:[e.jsx(Fe,{fullWidth:!0,size:"small",children:e.jsxs(Me,{value:t.objectType||"",onChange:n=>je(s,"objectType",n.target.value),displayEmpty:!0,disabled:!t.ifcClass||!N[t.ifcClass]?.length,MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"",children:e.jsx("em",{children:"All Types"})}),t.ifcClass&&N[t.ifcClass]?.map(n=>e.jsx(Q,{value:n,children:n},n))]})}),t.ifcClass&&N[t.ifcClass]?.length>0&&e.jsxs(b,{variant:"caption",color:"text.secondary",display:"block",sx:{mt:.5},children:[N[t.ifcClass].length," type",N[t.ifcClass].length!==1?"s":""," available"]})]}),e.jsxs(c,{children:[e.jsx(Fe,{fullWidth:!0,size:"small",children:e.jsxs(Me,{value:t.wbsCode,onChange:n=>je(s,"wbsCode",n.target.value),displayEmpty:!0,MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"",children:e.jsx("em",{children:"Select WBS Code"})}),f.map(n=>e.jsxs(Q,{value:n.wbsCode,children:[n.wbsCode,": ",n.description," (",n.unit,")"]},n.wbsCode))]})}),t.confidence&&e.jsxs(b,{variant:"caption",color:"text.secondary",children:["AI Confidence: ",(t.confidence*100).toFixed(0),"%"]})]}),e.jsxs(c,{children:[e.jsxs(w,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(Fe,{fullWidth:!0,size:"small",children:e.jsxs(Me,{value:t.quantityProperty||"",onChange:n=>je(s,"quantityProperty",n.target.value),displayEmpty:!0,disabled:!t.ifcClass||!t.wbsCode,MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"",children:e.jsx("em",{children:"Select Property"})}),t.ifcClass&&_[t.ifcClass]?.map(n=>e.jsx(Q,{value:n,children:n},n))]})}),e.jsx(pe,{size:"small",onClick:()=>l(s),disabled:!t.ifcClass||!t.wbsCode||he||!ae[t.ifcClass],title:"AI suggest property",children:e.jsx(tt,{})})]}),t.ifcClass&&_[t.ifcClass]&&e.jsxs(b,{variant:"caption",color:"text.secondary",display:"block",sx:{mt:.5},children:[_[t.ifcClass].length," properties available"]}),t.quantityProperty&&e.jsxs(w,{sx:{mt:.5},children:[e.jsxs(b,{variant:"caption",color:"success.main",display:"block",children:["âœ“ Extract: ",t.quantityProperty]}),t.quantityType&&e.jsx(et,{label:`Type: ${t.quantityType}`,size:"small",variant:"outlined",sx:{mt:.5,fontSize:"0.7rem"},color:t.quantityType==="length"?"info":t.quantityType==="area"?"warning":t.quantityType==="volume"?"error":t.quantityType==="weight"?"secondary":"default"}),t.propertyConfidence&&e.jsxs(b,{variant:"caption",color:"text.secondary",display:"block",sx:{mt:.5},children:["Confidence: ",(t.propertyConfidence*100).toFixed(0),"%"]})]})]}),e.jsxs(c,{children:[e.jsx(Fe,{fullWidth:!0,size:"small",children:e.jsxs(Me,{value:t.quantityType||"",onChange:n=>je(s,"quantityType",n.target.value),displayEmpty:!0,disabled:!t.quantityProperty,MenuProps:{style:{zIndex:1400}},children:[e.jsx(Q,{value:"",children:e.jsx("em",{children:"Auto"})}),e.jsx(Q,{value:"length",children:"ðŸ“ Length (m)"}),e.jsx(Q,{value:"area",children:"ðŸ“ Area (mÂ²)"}),e.jsx(Q,{value:"volume",children:"ðŸ“¦ Volume (mÂ³)"}),e.jsx(Q,{value:"weight",children:"âš–ï¸ Weight (kg)"}),e.jsx(Q,{value:"count",children:"ðŸ”¢ Count (pcs)"})]})}),t.quantityType&&e.jsxs(b,{variant:"caption",color:"info.main",display:"block",sx:{mt:.5},children:["âœ“ Manual: ",t.quantityType]})]}),e.jsx(c,{align:"center",children:e.jsx(pe,{size:"small",onClick:()=>Ge(s),color:"error",children:e.jsx(jt,{})})})]},s)),m.length===0&&e.jsx(oe,{children:e.jsx(c,{colSpan:6,align:"center",children:e.jsx(b,{variant:"body2",color:"text.secondary",children:"No mappings defined. Click + to add or use AI Suggest."})})})]})]})})]}),e.jsxs(w,{sx:{p:2,display:"flex",alignItems:"center",borderTop:1,borderColor:"divider",bgcolor:"background.paper"},children:[e.jsx(Y,{startIcon:he?e.jsx(Je,{size:16}):e.jsx(tt,{}),onClick:o,disabled:he||le,children:he?"Generating...":"AI Suggest Mappings"}),e.jsx(w,{sx:{flex:1}}),e.jsx(Y,{onClick:a,sx:{mr:1},children:"Cancel"}),e.jsx(Y,{variant:"contained",onClick:i,children:"Save & Apply"})]}),e.jsx(w,{onPointerDown:me,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1},zIndex:10}})]})]})}):null}const Vt=({isOpen:g=!0,onClose:a,viewerApi:u})=>{const[f,R]=h.useState([]),[m,$]=h.useState([]),[A,J]=h.useState([]),[W,E]=h.useState([]),[N,ie]=h.useState("database"),[_,H]=h.useState(!1),[ae,V]=h.useState({current:0,total:0,message:""}),[Ie,ze]=h.useState(!1),[le,ge]=h.useState(!0),[he,ve]=h.useState(new Set),K=h.useMemo(()=>new $t,[]),[ce,Ce]=h.useState(K.isConnected()),[re,Be]=h.useState(!1),k=h.useRef(null),[de,Qe]=h.useState({width:800,height:600}),Se=h.useRef(!1),Te=h.useRef(null),fe=Ae.useCallback(o=>{if(!Se.current||!Te.current)return;const l=Te.current,i=o.clientX-l.startX,I=o.clientY-l.startY,F=Math.max(400,l.width+i),U=Math.max(300,l.height+I);Qe({width:Math.round(F),height:Math.round(U)})},[]),ue=Ae.useCallback(()=>{Se.current=!1,Te.current=null,window.removeEventListener("pointermove",fe),window.removeEventListener("pointerup",ue),document.body.style.cursor=""},[fe]),ke=Ae.useCallback(o=>{o.preventDefault(),o.stopPropagation();const l=k.current;l&&(Se.current=!0,Te.current={startX:o.clientX,startY:o.clientY,width:l.offsetWidth,height:l.offsetHeight},document.body.style.cursor="nwse-resize",window.addEventListener("pointermove",fe),window.addEventListener("pointerup",ue))},[fe,ue]);h.useEffect(()=>()=>{ue()},[ue]),h.useEffect(()=>{K.initialize(o=>{R(o),Ce(K.isConnected())})},[K]),h.useEffect(()=>{g&&ht().then(E)},[g]),h.useEffect(()=>()=>{H(!1),$([]),J([])},[]);const Pe=async()=>{await K.connectToFile(),Ce(K.isConnected())},xe=async()=>{try{const o=new We.Workbook,l=o.addWorksheet("CostData");l.columns=[{header:"wbsCode",key:"wbsCode",width:15},{header:"description",key:"description",width:30},{header:"unit",key:"unit",width:10},{header:"materialCost",key:"materialCost",width:15},{header:"laborCost",key:"laborCost",width:15},{header:"laborHours",key:"laborHours",width:15}];const i=[{wbsCode:"1.1.1",description:"Cable Tray Installation",unit:"m",materialCost:45.5,laborCost:65,laborHours:.5},{wbsCode:"1.1.2",description:"Conduit Installation",unit:"m",materialCost:12.3,laborCost:65,laborHours:.3},{wbsCode:"1.1.3",description:"Light Fixture Installation",unit:"pcs",materialCost:120,laborCost:65,laborHours:1.2},{wbsCode:"1.2.1",description:"Ductwork Installation",unit:"m2",materialCost:85,laborCost:70,laborHours:2.5},{wbsCode:"1.2.2",description:"VAV Box Installation",unit:"pcs",materialCost:850,laborCost:70,laborHours:4},{wbsCode:"1.2.3",description:"Diffuser Installation",unit:"pcs",materialCost:45,laborCost:70,laborHours:.8},{wbsCode:"1.3.1",description:"Pipe Installation DN50",unit:"m",materialCost:35,laborCost:68,laborHours:.6},{wbsCode:"1.3.2",description:"Pipe Installation DN100",unit:"m",materialCost:68,laborCost:68,laborHours:1.2},{wbsCode:"1.3.3",description:"Valve Installation",unit:"pcs",materialCost:250,laborCost:68,laborHours:1.5},{wbsCode:"2.1.1",description:"Concrete Slab m3",unit:"m3",materialCost:450,laborCost:75,laborHours:8},{wbsCode:"2.1.2",description:"Reinforcement kg",unit:"kg",materialCost:1.8,laborCost:75,laborHours:.05},{wbsCode:"2.1.3",description:"Steel Column",unit:"pcs",materialCost:2500,laborCost:80,laborHours:12},{wbsCode:"3.1.1",description:"Drywall Partition",unit:"m2",materialCost:25,laborCost:60,laborHours:1.5},{wbsCode:"3.1.2",description:"Door Installation",unit:"pcs",materialCost:450,laborCost:60,laborHours:3},{wbsCode:"3.1.3",description:"Window Installation",unit:"pcs",materialCost:650,laborCost:60,laborHours:4},{wbsCode:"3.1.4",description:"Flooring Tile",unit:"m2",materialCost:45,laborCost:55,laborHours:1.2}];l.addRows(i),l.getRow(1).font={bold:!0},l.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}};const I=await o.xlsx.writeBuffer(),F=new Blob([I],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),U=URL.createObjectURL(F),O=document.createElement("a");O.href=U,O.download="QTO_CostDatabase_Template.xlsx",document.body.appendChild(O),O.click(),document.body.removeChild(O),URL.revokeObjectURL(U),alert('Template file downloaded! Open it, save it locally, and then click "Connect to Cost Database" to link it to the QTO module.')}catch(o){console.error("Failed to create template:",o),alert("Failed to create template file. See console for details.")}},me=(o,l)=>{const i=[...f];i[l]=o,R(i),K.updateData(i)},Ee=o=>o&&typeof o=="object"&&"value"in o?o.value:o,_e=async()=>{if(!u){alert("Viewer API is not available");return}if(!u.getItemsByCategory||!u.getItemsDataByModel){alert("Viewer API does not support required methods");return}if(W.length===0){alert('No mappings configured! Please go to "CONFIGURE MAPPINGS" and set up IFC class to WBS mappings first.');return}if(f.length===0){alert("No cost database loaded! Please connect to a cost database first.");return}H(!0),V({current:0,total:0,message:"Initializing extraction..."}),console.log("=== EXTRACTION START ==="),console.log("Loaded mappings:",W),console.log("Cost data count:",f.length),console.log("Cost data sample:",f.slice(0,3));try{const o=[...new Set(W.map(r=>r.ifcClass))];V({current:0,total:o.length,message:`Searching for ${o.length} IFC class types...`});const l=await u.getItemsByCategory(o.map(r=>new RegExp(`^${r}$`,"i")));if(console.log("Category map structure:",{keys:Object.keys(l),sample:Object.keys(l).length>0?{key:Object.keys(l)[0],value:l[Object.keys(l)[0]]}:null}),!l||Object.keys(l).length===0){alert("No elements found matching the configured mappings."),H(!1),V({current:0,total:0,message:""});return}const i=new Map,I={},F=Object.keys(l)[0],U=l[F];if(Array.isArray(U))console.log("Simple structure: modelId -> localIds[]"),Object.assign(I,l);else{console.log("Nested structure: ifcClass -> { modelId: localIds[] }");for(const[r,d]of Object.entries(l))if(!(typeof d!="object"||!d)){for(const[p,D]of Object.entries(d))if(!(!D||!Array.isArray(D))){for(const q of D)i.set(`${p}_${q}`,r);I[p]||(I[p]=[]),I[p].push(...D)}}}const O=i.size||Object.values(I).reduce((r,d)=>r+d.length,0);V({current:0,total:O,message:`Found ${O} elements to process...`}),V({current:0,total:O,message:"Pre-caching element properties..."});const x=[];for(const[r,d]of Object.entries(I))if(!(!d||d.length===0))try{const p=await u.getItemsDataByModel(r,d,{attributes:["GlobalId"]});for(const D of p){const q=Ee(D._guid);q&&x.push(q)}}catch(p){console.warn(`Failed to get globalIds for model ${r}:`,p)}if(u.addToCache&&x.length>0){console.log(`Pre-caching ${x.length} elements...`);try{await u.addToCache(x),console.log("Pre-caching complete!")}catch(r){console.warn("Failed to pre-cache elements:",r)}}const t=[];let s=0;for(const[r,d]of Object.entries(I)){if(!d||d.length===0)continue;const p=100;for(let D=0;D<d.length;D+=p){const q=d.slice(D,D+p);V({current:s,total:O,message:`Processing batch ${Math.floor(D/p)+1}/${Math.ceil(d.length/p)} (${s}/${O} elements)...`});try{const ye=await u.getItemsDataByModel(r,q,{attributesDefault:!0,attributes:["Name","Description","GlobalId","ObjectType","PredefinedType","Tag"],relations:{IsDefinedBy:{attributes:!0,relations:!0},IsTypedBy:{attributes:!0,relations:!1}}});for(const P of ye){s++;try{const Z=P._category;let ee="IfcProduct";Z&&typeof Z=="object"&&Z.value?ee=Z.value:typeof Z=="string"&&(ee=Z),s===1&&(console.log("First element structure:",{_category:Z,ifcClass:ee,IsDefinedBy:P.IsDefinedBy,IsDefinedByLength:Array.isArray(P.IsDefinedBy)?P.IsDefinedBy.length:0}),Array.isArray(P.IsDefinedBy)&&P.IsDefinedBy.length>0&&(console.log("First property set structure:",P.IsDefinedBy[0]),console.log("Property set Name:",P.IsDefinedBy[0].Name),P.IsDefinedBy[0].HasProperties&&P.IsDefinedBy[0].HasProperties.length>0&&(console.log("First 3 raw properties:",P.IsDefinedBy[0].HasProperties.slice(0,3)),console.log("First property keys:",Object.keys(P.IsDefinedBy[0].HasProperties[0])))),console.log("Root attributes:",{ObjectType:P.ObjectType,PredefinedType:P.PredefinedType,Tag:P.Tag,Name:P.Name,Description:P.Description}));const G=Ee(P._guid);s===1&&(console.log("=== OPTIMIZED EXTRACTION (using pre-cached getElementProps) ==="),console.log("Elements are pre-cached, so getElementProps calls are fast"));let C,j=null;try{if(j=await u.getElementProps(G),s===1&&(console.log("First element props structure:",{psets:j?.psets?Object.keys(j.psets):[],attributes:j?.attributes?Object.keys(j.attributes):[]}),j?.psets?.NV_PSteel&&console.log("NV_PSteel properties:",j.psets.NV_PSteel)),j?.psets)for(const y in j.psets){const B=j.psets[y];if(B&&typeof B=="object"&&(C=B.Description||B.Type||B.Profile||B.ObjectType||B.PredefinedType||B.Reference,C&&typeof C=="string"&&C.trim())){s<=3&&console.log(`Found object type "${C}" from pset "${y}"`);break}}if(!C&&j?.attributes){const y=j.attributes;C=y.ObjectType||y.PredefinedType||y.Tag||y.Description||y.Name,C&&typeof C=="string"&&s<=3&&console.log(`Found object type "${C}" from attributes`)}}catch(y){console.warn(`Failed to get props for element ${G}:`,y)}s<=3&&console.log(`Element ${s} - Object Type Extraction:`,{ifcClass:ee,objectType:C,hasPsets:j?.psets?Object.keys(j.psets).length:0,hasAttributes:j?.attributes?Object.keys(j.attributes).length:0});const be=Ee(P.Name)||Ee(P.Description);let M=typeof be=="string"?be:ee;C&&typeof C=="string"&&(M=`${M} [${C}]`);let v=W.find(y=>y.ifcClass===ee&&y.objectType&&C&&y.objectType===C);v||(v=W.find(y=>y.ifcClass===ee&&!y.objectType)),s<=3&&console.log(`Element ${s} - Mapping Result:`,{ifcClass:ee,objectType:C,mappingFound:!!v,mapping:v?{ifcClass:v.ifcClass,objectType:v.objectType,wbsCode:v.wbsCode,quantityProperty:v.quantityProperty}:null,availableMappings:W.map(y=>({ifcClass:y.ifcClass,objectType:y.objectType,wbsCode:y.wbsCode}))});const S=v?f.find(y=>y.wbsCode===v.wbsCode):void 0;s===1&&!S&&v&&console.log("Cost item not found:",{wbsCode:v.wbsCode,costDataCount:f.length,costDataSample:f.slice(0,3).map(y=>y.wbsCode)});let z=0,T=S?.unit||"pcs";if(v?.quantityProperty&&j){const y=v.quantityProperty,B=y.split(".");if(B.length===2&&j.psets){const[Re,De]=B,Xe=j.psets[Re];if(Xe&&typeof Xe=="object"){const qe=Xe[De];z=typeof qe=="number"?qe:typeof qe=="string"&&parseFloat(qe)||0,s<=3&&console.log(`Found quantity property ${y} = ${z}`)}}else if(B.length===1&&j.attributes){const Re=B[0],De=j.attributes[Re];z=typeof De=="number"?De:typeof De=="string"&&parseFloat(De)||0,s<=3&&console.log(`Found quantity from attribute ${Re} = ${z}`)}z===0&&s<=3&&console.warn(`Property ${y} not found or zero for ${ee}`,{availablePsets:j?.psets?Object.keys(j.psets):[],samplePset:j?.psets?Object.entries(j.psets)[0]:null})}else z=1;S?.unit&&(T=S.unit),T.toLowerCase()==="pcs"&&(z=1);const te=S?.laborHours||0,L=te>0?(S?.laborCost||0)*te:S?.laborCost||0,ne=S?S.materialCost*z:0,X=S?L*z:0,se=ne+X;t.push({elementId:G||`${r}_${q[ye.indexOf(P)]}`,ifcClass:ee,description:M||ee,quantity:z,unit:T,matchedCostItem:S,materialCost:ne,laborCost:X,totalCost:se})}catch(Z){console.error("Failed to extract quantities for element:",Z)}}}catch(ye){console.error(`Failed to fetch batch data for model ${r}:`,ye)}}}console.log("Extraction complete:",{totalExtracted:t.length,sample:t[0],allIfcClasses:[...new Set(t.map(r=>r.ifcClass))]}),$(t);const n=new Map;t.forEach(r=>{const d=r.matchedCostItem?.wbsCode||`UNMAPPED_${r.ifcClass}`;n.has(d)||n.set(d,{wbsCode:r.matchedCostItem?.wbsCode||`[UNMAPPED] ${r.ifcClass}`,description:r.matchedCostItem?.description||"Not mapped to cost database",unit:r.matchedCostItem?.unit||r.unit,elementCount:0,totalQuantity:0,materialCost:0,laborCost:0,totalCost:0,items:[]});const p=n.get(d);p.elementCount++,p.totalQuantity+=r.quantity,p.materialCost+=r.materialCost||0,p.laborCost+=r.laborCost||0,p.totalCost+=r.totalCost||0,p.items.push(r)}),J(Array.from(n.values())),V({current:O,total:O,message:`Completed! Extracted ${t.length} elements.`}),ie("quantities"),setTimeout(()=>{V({current:0,total:0,message:""})},2e3)}catch(o){console.error("Failed to extract quantities:",o),alert("Failed to extract quantities. See console for details.")}finally{H(!1)}},Ve=()=>{if(m.length===0){console.warn("No quantities to recalculate");return}console.log("Recalculating costs with updated cost database...");const o=m.map(i=>{const I=i.matchedCostItem?f.find(F=>F.wbsCode===i.matchedCostItem.wbsCode):void 0;if(I){const F=I.materialCost*i.quantity,U=I.laborCost*i.quantity,O=F+U;return{...i,matchedCostItem:I,materialCost:F,laborCost:U,totalCost:O}}return i});$(o);const l=new Map;o.forEach(i=>{const I=i.matchedCostItem?.wbsCode||`UNMAPPED_${i.ifcClass}`;l.has(I)||l.set(I,{wbsCode:i.matchedCostItem?.wbsCode||`[UNMAPPED] ${i.ifcClass}`,description:i.matchedCostItem?.description||"Not mapped to cost database",unit:i.matchedCostItem?.unit||i.unit,elementCount:0,totalQuantity:0,materialCost:0,laborCost:0,totalCost:0,items:[]});const F=l.get(I);F.elementCount++,F.totalQuantity+=i.quantity,F.materialCost+=i.materialCost||0,F.laborCost+=i.laborCost||0,F.totalCost+=i.totalCost||0,F.items.push(i)}),J(Array.from(l.values())),console.log("Cost recalculation complete!")};h.useEffect(()=>{m.length>0&&f.length>0&&Ve()},[f]);const Ge=async()=>{try{const o=new We.Workbook,l=o.addWorksheet("Summary");l.columns=[{header:"WBS Code",key:"wbsCode",width:15},{header:"Description",key:"description",width:40},{header:"Unit",key:"unit",width:10},{header:"Element Count",key:"elementCount",width:15},{header:"Total Quantity",key:"totalQuantity",width:15},{header:"Material Cost",key:"materialCost",width:15},{header:"Labor Cost",key:"laborCost",width:15},{header:"Total Cost",key:"totalCost",width:15}],l.getRow(1).font={bold:!0},l.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},A.forEach(x=>{l.addRow({wbsCode:x.wbsCode,description:x.description,unit:x.unit,elementCount:x.elementCount,totalQuantity:x.totalQuantity,materialCost:x.materialCost,laborCost:x.laborCost,totalCost:x.totalCost})}),["F","G","H"].forEach(x=>{l.getColumn(x).numFmt="$#,##0.00"});const i=o.addWorksheet("Details");i.columns=[{header:"Element ID",key:"elementId",width:25},{header:"IFC Class",key:"ifcClass",width:20},{header:"Description",key:"description",width:40},{header:"Quantity",key:"quantity",width:12},{header:"Unit",key:"unit",width:10},{header:"WBS Code",key:"wbsCode",width:15},{header:"Material Cost",key:"materialCost",width:15},{header:"Labor Cost",key:"laborCost",width:15},{header:"Total Cost",key:"totalCost",width:15}],i.getRow(1).font={bold:!0},i.getRow(1).fill={type:"pattern",pattern:"solid",fgColor:{argb:"FF4472C4"}},m.forEach(x=>{i.addRow({elementId:x.elementId,ifcClass:x.ifcClass,description:x.description,quantity:x.quantity,unit:x.unit,wbsCode:x.matchedCostItem?.wbsCode||"[UNMAPPED]",materialCost:x.materialCost||0,laborCost:x.laborCost||0,totalCost:x.totalCost||0})}),["G","H","I"].forEach(x=>{i.getColumn(x).numFmt="$#,##0.00"});const I=await o.xlsx.writeBuffer(),F=new Blob([I],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),U=URL.createObjectURL(F),O=document.createElement("a");O.href=U,O.download=`QTO_Export_${new Date().toISOString().split("T")[0]}.xlsx`,O.click(),URL.revokeObjectURL(U)}catch(o){console.error("Failed to export XLSX:",o),alert("Failed to export to Excel. See console for details.")}},je=()=>{try{let l=`\uFEFFWBS Code,Description,Unit,Element Count,Total Quantity,Material Cost,Labor Cost,Total Cost
`;A.forEach(s=>{l+=`"${s.wbsCode}","${s.description}","${s.unit}",${s.elementCount},${s.totalQuantity},${s.materialCost.toFixed(2)},${s.laborCost.toFixed(2)},${s.totalCost.toFixed(2)}
`});let i=`\uFEFFElement ID,IFC Class,Description,Quantity,Unit,WBS Code,Material Cost,Labor Cost,Total Cost
`;m.forEach(s=>{i+=`"${s.elementId}","${s.ifcClass}","${s.description}",${s.quantity},"${s.unit}","${s.matchedCostItem?.wbsCode||"[UNMAPPED]"}",${(s.materialCost||0).toFixed(2)},${(s.laborCost||0).toFixed(2)},${(s.totalCost||0).toFixed(2)}
`});const I=new Blob([l],{type:"text/csv;charset=utf-8;"}),F=URL.createObjectURL(I),U=document.createElement("a");U.href=F,U.download=`QTO_Summary_${new Date().toISOString().split("T")[0]}.csv`,U.click(),URL.revokeObjectURL(F);const O=new Blob([i],{type:"text/csv;charset=utf-8;"}),x=URL.createObjectURL(O),t=document.createElement("a");t.href=x,t.download=`QTO_Details_${new Date().toISOString().split("T")[0]}.csv`,t.click(),URL.revokeObjectURL(x)}catch(o){console.error("Failed to export CSV:",o),alert("Failed to export to CSV. See console for details.")}};return g?e.jsxs(e.Fragment,{children:[e.jsx(nt,{nodeRef:k,handle:".qto-header",bounds:"parent",children:e.jsxs(rt,{ref:k,sx:{position:"fixed",top:"80px",right:"20px",width:de.width,height:re?"auto":de.height,maxHeight:re?"auto":"90vh",maxWidth:"90vw",zIndex:1300,display:"flex",flexDirection:"column",overflow:"hidden",boxSizing:"border-box"},elevation:8,children:[e.jsxs(w,{className:"qto-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",p:2,borderBottom:1,borderColor:"divider",backgroundColor:"primary.main",color:"primary.contrastText",cursor:"move"},children:[e.jsx(b,{variant:"h6",children:"Quantity Take-Off (QTO)"}),e.jsxs(w,{children:[e.jsx(wt,{title:e.jsxs(w,{sx:{p:1},children:[e.jsx(b,{variant:"subtitle2",sx:{fontWeight:"bold",mb:1},children:"How to use QTO Panel:"}),e.jsxs(b,{variant:"body2",sx:{display:"block",mb:.5},children:["1. ",e.jsx("b",{children:"Connect Database"}),": Load your cost/price list (Excel)."]}),e.jsxs(b,{variant:"body2",sx:{display:"block",mb:.5},children:["2. ",e.jsx("b",{children:"Configure Mappings"}),": Link 3D objects (IFC Classes) to your Cost Items."]}),e.jsxs(b,{variant:"body2",sx:{display:"block",mb:.5},children:["3. ",e.jsx("b",{children:"Extract Quantities"}),": Run the calculation to analyze the model."]}),e.jsxs(b,{variant:"body2",sx:{display:"block"},children:["4. ",e.jsx("b",{children:"Review"}),": See detailed costs and exporting options."]})]}),arrow:!0,placement:"left",children:e.jsx(pe,{size:"small",sx:{color:"inherit",mr:1},children:e.jsx(It,{})})}),e.jsx(pe,{onClick:()=>Be(!re),size:"small",sx:{color:"inherit",mr:1},title:re?"Expand":"Minimize",children:re?e.jsx(it,{}):e.jsx(lt,{})}),a&&e.jsx(pe,{onClick:a,size:"small",sx:{color:"inherit"},children:e.jsx(ct,{})})]})]}),!re&&e.jsxs(w,{sx:{display:"flex",flexDirection:"column",flex:1,overflow:"hidden"},children:[e.jsxs(w,{sx:{px:2,pt:2,pb:1,display:"flex",gap:1,flexWrap:"wrap",borderBottom:1,borderColor:"divider"},children:[e.jsx(Y,{variant:"outlined",size:"small",onClick:Pe,disabled:!u,children:ce?"Reconnect Database":"Connect Database"}),e.jsx(Y,{variant:"outlined",size:"small",onClick:xe,children:"Download Template"}),e.jsxs(Y,{variant:"outlined",size:"small",startIcon:e.jsx(vt,{}),onClick:()=>ze(!0),disabled:!u||!ce,children:["Configure Mappings (",W.length,")"]}),e.jsx(Y,{variant:"contained",size:"small",startIcon:_?e.jsx(Je,{size:16}):e.jsx(St,{}),onClick:_e,disabled:!u||!ce||_||W.length===0,children:_?"Extracting...":"Extract Quantities"})]}),_&&ae.total>0&&e.jsxs(w,{sx:{px:2,pb:2},children:[e.jsxs(w,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(w,{sx:{flex:1,mr:2},children:e.jsx(Tt,{variant:"determinate",value:ae.current/ae.total*100})}),e.jsxs(b,{variant:"caption",color:"text.secondary",sx:{minWidth:80},children:[ae.current,"/",ae.total]})]}),e.jsx(b,{variant:"caption",color:"text.secondary",children:ae.message})]}),e.jsxs(kt,{value:N,onChange:(o,l)=>ie(l),sx:{borderBottom:1,borderColor:"divider",px:2},children:[e.jsx(st,{label:"Cost Database",value:"database"}),e.jsx(st,{label:`Quantities (${m.length})`,value:"quantities"})]}),e.jsx(w,{sx:{p:2,overflowY:"auto",flex:1},children:!ce&&N==="database"?e.jsxs(w,{sx:{textAlign:"center",py:4},children:[e.jsx(b,{variant:"body1",gutterBottom:!0,children:"Connect to your local Excel file to manage cost data"}),e.jsx(b,{variant:"body2",color:"text.secondary",gutterBottom:!0,sx:{mb:3},children:"Don't have a cost database file yet? Download a template to get started."})]}):N==="database"?e.jsxs(w,{children:[e.jsx(b,{variant:"subtitle1",gutterBottom:!0,children:"Cost Database"}),e.jsx(b,{variant:"body2",color:"text.secondary",gutterBottom:!0,children:"Data is being auto-saved to your local Excel file."}),f.length===0?e.jsx(b,{variant:"body2",color:"text.secondary",sx:{mt:2},children:"No data in the database. Add rows to your Excel file and reconnect."}):e.jsx(Le,{sx:{mt:2},children:e.jsxs($e,{size:"small",children:[e.jsx(Ne,{children:e.jsxs(oe,{children:[e.jsx(c,{children:"WBS Code"}),e.jsx(c,{children:"Description"}),e.jsx(c,{children:"Unit"}),e.jsx(c,{children:"Material Cost"}),e.jsx(c,{children:"Labor Cost"}),e.jsx(c,{children:"Labor Hours"})]})}),e.jsx(Oe,{children:f.map((o,l)=>e.jsxs(oe,{children:[e.jsx(c,{children:e.jsx(we,{value:o.wbsCode,onChange:i=>me({...o,wbsCode:i.target.value},l),size:"small",fullWidth:!0})}),e.jsx(c,{children:e.jsx(we,{value:o.description,onChange:i=>me({...o,description:i.target.value},l),size:"small",fullWidth:!0})}),e.jsx(c,{children:e.jsx(we,{value:o.unit,onChange:i=>me({...o,unit:i.target.value},l),size:"small",fullWidth:!0})}),e.jsx(c,{children:e.jsx(we,{type:"number",value:o.materialCost,onChange:i=>me({...o,materialCost:parseFloat(i.target.value)},l),size:"small",fullWidth:!0})}),e.jsx(c,{children:e.jsx(we,{type:"number",value:o.laborCost,onChange:i=>me({...o,laborCost:parseFloat(i.target.value)},l),size:"small",fullWidth:!0})}),e.jsx(c,{children:e.jsx(we,{type:"number",value:o.laborHours,onChange:i=>me({...o,laborHours:parseFloat(i.target.value)},l),size:"small",fullWidth:!0})})]},l))})]})})]}):e.jsx(w,{children:m.length===0?e.jsx(Ye,{severity:"info",children:'No quantities extracted yet. Configure mappings and click "Extract Quantities".'}):e.jsxs(w,{children:[e.jsxs(w,{sx:{mb:2,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsxs(b,{variant:"subtitle2",children:[le?`${A.length} WBS Codes`:`${m.length} Elements`," | Total Cost: $",m.reduce((o,l)=>o+(l.totalCost||0),0).toFixed(2)]}),e.jsxs(w,{sx:{display:"flex",gap:1},children:[e.jsx(Y,{size:"small",variant:"outlined",onClick:Ge,children:"Export XLSX"}),e.jsx(Y,{size:"small",variant:"outlined",onClick:je,children:"Export CSV"}),e.jsx(Y,{size:"small",onClick:()=>ge(!le),children:le?"Show Individual":"Show Grouped"})]})]}),le?e.jsx(Le,{children:e.jsxs($e,{size:"small",children:[e.jsx(Ne,{children:e.jsxs(oe,{children:[e.jsx(c,{width:"50px"}),e.jsx(c,{children:"WBS"}),e.jsx(c,{children:"Description"}),e.jsx(c,{align:"right",children:"Qty"}),e.jsx(c,{children:"Unit"}),e.jsx(c,{align:"right",children:"Total Cost"})]})}),e.jsx(Oe,{children:A.map(o=>{const l=o.wbsCode.startsWith("[UNMAPPED]");return e.jsxs(Ae.Fragment,{children:[e.jsxs(oe,{sx:{backgroundColor:l?"warning.lighter":"action.hover",cursor:"pointer","&:hover":{backgroundColor:l?"warning.light":"action.selected"},borderLeft:l?"4px solid #ff9800":"none"},onClick:()=>{const i=new Set(he);i.has(o.wbsCode)?i.delete(o.wbsCode):i.add(o.wbsCode),ve(i)},children:[e.jsx(c,{children:e.jsx(pe,{size:"small",children:he.has(o.wbsCode)?e.jsx(Pt,{}):e.jsx(Et,{})})}),e.jsx(c,{children:e.jsxs(w,{sx:{display:"flex",alignItems:"center",gap:1},children:[l&&e.jsx(b,{variant:"caption",sx:{color:"orange",fontWeight:"bold"},children:"âš "}),e.jsx("strong",{children:o.wbsCode})]})}),e.jsx(c,{children:e.jsxs(w,{children:[o.description," (",o.elementCount," elements)",l&&e.jsx(b,{variant:"caption",color:"warning.main",display:"block",children:"Configure mappings to assign cost"})]})}),e.jsx(c,{align:"right",children:e.jsx("strong",{children:o.totalQuantity.toFixed(2)})}),e.jsx(c,{children:o.unit}),e.jsx(c,{align:"right",children:e.jsxs(b,{variant:"body2",fontWeight:"bold",color:l?"warning.main":"primary",children:["$",o.totalCost.toFixed(2)]})})]}),he.has(o.wbsCode)&&e.jsx(oe,{children:e.jsx(c,{colSpan:6,sx:{p:2,bgcolor:"background.default"},children:e.jsxs($e,{size:"small",children:[e.jsx(Ne,{children:e.jsxs(oe,{children:[e.jsx(c,{children:"IFC Class"}),e.jsx(c,{children:"Description"}),e.jsx(c,{align:"right",children:"Qty"}),e.jsx(c,{align:"right",children:"Cost"})]})}),e.jsx(Oe,{children:o.items.map((i,I)=>e.jsxs(oe,{children:[e.jsx(c,{children:e.jsx(b,{variant:"caption",children:i.ifcClass})}),e.jsx(c,{children:e.jsx(b,{variant:"caption",children:i.description})}),e.jsx(c,{align:"right",children:e.jsx(b,{variant:"caption",children:i.quantity.toFixed(2)})}),e.jsx(c,{align:"right",children:e.jsxs(b,{variant:"caption",children:["$",i.totalCost?.toFixed(2)]})})]},I))})]})})})]},o.wbsCode)})})]})}):e.jsxs(w,{children:[m.some(o=>!o.matchedCostItem)&&e.jsx(Ye,{severity:"warning",sx:{mb:2},children:'Some elements are not mapped to cost items. Configure mappings in "CONFIGURE MAPPINGS" to assign costs and extract correct quantities.'}),e.jsx(Le,{children:e.jsxs($e,{size:"small",children:[e.jsx(Ne,{children:e.jsxs(oe,{children:[e.jsx(c,{children:"IFC Class"}),e.jsx(c,{children:"Description"}),e.jsx(c,{align:"right",children:"Quantity"}),e.jsx(c,{children:"WBS"}),e.jsx(c,{align:"right",children:"Total Cost"})]})}),e.jsx(Oe,{children:m.map((o,l)=>{const i=!o.matchedCostItem;return e.jsxs(oe,{sx:{backgroundColor:i?"warning.lighter":"inherit"},children:[e.jsx(c,{children:o.ifcClass}),e.jsx(c,{children:o.description}),e.jsxs(c,{align:"right",children:[o.quantity.toFixed(2)," ",o.unit]}),e.jsx(c,{children:o.matchedCostItem?e.jsx(b,{variant:"caption",color:"success.main",fontWeight:"bold",children:o.matchedCostItem.wbsCode}):e.jsx(b,{variant:"caption",color:"warning.main",children:"[UNMAPPED]"})}),e.jsx(c,{align:"right",children:e.jsxs(b,{variant:"body2",fontWeight:"bold",color:i?"warning.main":"primary",children:["$",o.totalCost?.toFixed(2)||"0.00"]})})]},l)})})]})})]})]})})})]}),!re&&e.jsx(w,{onPointerDown:ke,sx:{position:"absolute",bottom:4,right:4,width:16,height:16,cursor:"nwse-resize",borderRight:"2px solid",borderBottom:"2px solid",borderColor:"divider",opacity:.6,"&:hover":{opacity:1},zIndex:10}})]})}),e.jsx(Wt,{open:Ie,onClose:()=>ze(!1),viewerApi:u||null,costItems:f,onMappingsUpdated:o=>E(o)})]}):null};export{Vt as QtoPanel};
