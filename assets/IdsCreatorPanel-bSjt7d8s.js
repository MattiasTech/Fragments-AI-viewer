import{cm as o,cn as Ce,co as e,cH as Ie,cF as ke,cp as d,cq as f,cP as G,cs as b,dC as we,dD as Ne,dm as De,cI as Pe,cJ as qe,cK as Ae,cA as N,dE as Oe,dp as H,dq as J,dF as Re,ds as T,dG as U,dw as se,cQ as $e,dH as ze,dI as Ee,d1 as Le,d2 as Be,d3 as Ve,d4 as _,dz as Y,dA as X,dc as j,d9 as We,dJ as Fe}from"./vendor-NpE_gqg9.js";import{g as ae,p as Me}from"./index-DgR5XBC7.js";import"./thatopen-vendor-byvyd1e5.js";import"./three-vendor-kQcUiZz9.js";const _e=({isOpen:oe,onClose:ce,viewerApi:Ge,selectedItemData:D,onValidate:P})=>{const K=o.useRef(null),Q=o.useRef(null),[C,de]=o.useState(!1),[y,q]=o.useState([]),[c,A]=o.useState(null),[I,Z]=o.useState("new-project.ids"),h=o.useCallback((t,r)=>{q(n=>n.map(l=>l.id===t?r(l):l))},[]),ue=o.useCallback(t=>{q(r=>{const n=r.filter(l=>l.id!==t);return A(l=>l&&l!==t?l:n[0]?.id??null),n})},[]),O=o.useMemo(()=>{if(!D)return null;try{const t=new WeakSet;return JSON.stringify(D,(r,n)=>{if(typeof n=="bigint")return n.toString();if(typeof n=="object"&&n!==null){if(t.has(n))return"[Circular]";t.add(n)}return n},2)}catch(t){return console.warn("Failed to stringify selected item data for IDS creator inspector",t),"Unable to display selected element properties."}},[D]),u=o.useMemo(()=>{if(!O||O.startsWith("Unable"))return null;try{return JSON.parse(O)}catch{return null}},[O]),R=o.useMemo(()=>{if(!u)return[];const t=[],r=l=>l==null?"—":typeof l=="object"?"value"in l?r(l.value):"Value"in l?r(l.Value):l instanceof Date?l.toLocaleString():Array.isArray(l)?`[${l.length} items]`:"[Object]":String(l),n=u.IsDefinedBy||u.isDefinedBy;return Array.isArray(n)&&n.forEach(l=>{if(!l||typeof l!="object")return;const i=l.Name?.value||l.name?.value||l.Name||l.name||l.type;if(!i||typeof i!="string")return;const s=l.HasProperties||l.hasProperties||l.properties||l.Properties;Array.isArray(s)&&s.forEach(a=>{if(!a||typeof a!="object")return;const p=a.Name?.value||a.name?.value||a.Name||a.name;if(!p||typeof p!="string")return;const x=a.NominalValue?.value||a.nominalValue?.value||a.NominalValue||a.nominalValue||a.value||a.Value,S=`${i} / ${p}`;t.push({label:S,value:r(x),psetName:i})})}),t.sort((l,i)=>l.psetName!==i.psetName?l.psetName.localeCompare(i.psetName):l.label.localeCompare(i.label)),t},[u]),ee=o.useCallback(t=>{const r={};if(!t||typeof t!="object")return{};const n=(s,a)=>{const p=typeof s=="string"?s:s?.toString?.()==="[object Object]"?null:String(s);!p||p==="[object Object]"||p==="null"||p==="undefined"||(r[p]||(r[p]=new Set),Array.isArray(a)&&a.forEach(x=>x&&r[p].add(String(x))))},l=s=>{if(!s)return null;if(typeof s=="string")return s;if(typeof s=="number")return String(s);if(typeof s=="object"){if(s.value!==void 0)return l(s.value);if(s.Value!==void 0)return l(s.Value)}return null};try{const s=t.IsDefinedBy||t.isDefinedBy;if(Array.isArray(s))for(const a of s){if(!a||typeof a!="object")continue;const p=l(a.Name)||l(a.name);if(!p)continue;const x=a.HasProperties||a.hasProperties;if(!Array.isArray(x))continue;const S=[];for(const B of x){if(!B||typeof B!="object")continue;const ie=l(B.Name)||l(B.name);ie&&S.push(ie)}S.length>0&&n(p,S)}}catch(s){console.error("Error extracting property sets from IsDefinedBy:",s)}const i={};for(const[s,a]of Object.entries(r))s&&s!=="[object Object]"&&(i[s]=Array.from(a).sort());return i},[]),m=o.useMemo(()=>y.find(t=>t.id===c),[y,c]),pe=o.useCallback(t=>{if(!c)return;const r=t.target.value;h(c,n=>({...n,name:r}))},[c,h]),te=o.useCallback(t=>{if(c){if(!u){alert("Select an element in the viewer first to capture its data.");return}h(c,r=>{let n=u;try{n=JSON.parse(JSON.stringify(u))}catch{n=u}let l=u?.ifcClass;!l&&u?._category?.value&&(l=u._category.value),!l&&u?.constructor?.name&&(l=u.constructor.name);const i={capturedAt:new Date().toISOString(),sourceGlobalId:u?.GlobalId||u?._guid?.value||"unknown",ifcClass:l,sample:n};return t==="applicability"?{...r,applicability:[...r.applicability,i]}:{...r,requirements:[...r.requirements,i]}})}},[c,u,h]),fe=o.useCallback((t,r)=>{c&&h(c,n=>{if(t==="applicability"){const i=[...n.applicability];return i.splice(r,1),{...n,applicability:i}}const l=[...n.requirements];return l.splice(r,1),{...n,requirements:l}})},[c,h]),xe=()=>{const t=`spec-${Date.now()}`,r={id:t,name:"New Specification",description:"",applicability:[],requirements:[]};q(n=>[...n,r]),A(t)},[me,k]=o.useState(!1),[V,re]=o.useState(null),[g,$]=o.useState(null),[w,z]=o.useState(null),[E,ne]=o.useState({}),[W,F]=o.useState("equals"),[M,L]=o.useState("");o.useCallback(t=>{const r=m?.applicability?.[t]?.sample;if(!r)return;const n=ee(r);ne(n),re(t),$(Object.keys(n)[0]??null),z(Object.keys(n)[0]?n[Object.keys(n)[0]][0]??null:null),L(""),k(!0)},[m]);const he=o.useCallback(()=>{if(!c||V==null||!g||!w)return;const t=y.find(i=>i.id===c);if(!t)return;const r=t.applicability?.[V]?.sample;let n;try{const i=r?.IsDefinedBy||r?.isDefinedBy;if(Array.isArray(i)){for(const s of i)if((s?.Name?.value||s?.name?.value)===g){const p=s.HasProperties||s.hasProperties;if(Array.isArray(p)){for(const x of p)if((x?.Name?.value||x?.name?.value)===w){n=x?.NominalValue?.value||x?.nominalValue?.value||x?.NominalValue||x?.nominalValue;break}}break}}}catch(i){console.error("Error extracting property value:",i)}const l={id:`rule-${Date.now()}`,propertyPath:`${g}.${w}`,operator:W,value:M||(n!=null?String(n):""),sample:r??null};h(c,i=>{if((v.current??null)!=null){const s=v.current,a=[...i.requirements];return a[s]=l,v.current=null,{...i,requirements:a}}return{...i,requirements:[...i.requirements,l]}}),k(!1)},[c,V,g,w,W,M,y,h]),v=Ce.useRef(null),le=o.useCallback(t=>{if(!t)return"Captured element";const r=t.sample??t,n=t.sourceGlobalId||r?.GlobalId||r?._guid||r?.guid||r?.Tag&&r.Tag.value||"unknown",l=t.ifcClass||r&&r._category&&r._category.value||r?.ifcClass||"IfcElement",i=r&&(r.Name&&r.Name.value||r.ObjectType||r.Name)||void 0;return n!=="unknown"?`${l} (${n})`:i?`${l} — ${String(i).substring(0,40)}`:`${l} (captured)`},[]),ye=o.useCallback(t=>{c&&h(c,r=>{const n=r.applicability?.[t]??null;if(!n)return r;const l=JSON.parse(JSON.stringify(n));return{...r,requirements:[...r.requirements,l]}})},[c,h]),be=o.useCallback(t=>{if(!m)return;const r=m.requirements[t];let n=null;if(r&&r.sample){const s=m.applicability.findIndex(a=>a&&a.sourceGlobalId===r.sourceGlobalId);n=s>=0?s:null}v.current=t,re(n);const l=r?.sample??(n!=null?m.applicability?.[n]?.sample:null),i=l?ee(l):{};if(ne(i),r&&r.propertyPath){const[s,a]=String(r.propertyPath).split(".");$(s??Object.keys(i)[0]??null),z(a??(s?i[s]?.[0]??null:Object.values(i)[0]?.[0]??null)),F(r.operator??"equals"),L(r.value??"")}else $(Object.keys(i)[0]??null),z(Object.keys(i)[0]?i[Object.keys(i)[0]][0]??null:null),F("equals"),L("");k(!0)},[m]),je=o.useCallback(t=>{c&&h(c,r=>{const n=[...r.requirements];return n.splice(t,1),{...r,requirements:n}})},[c,h]),ge=o.useCallback(()=>{try{const t=ae(y),r=new Blob([t],{type:"application/xml"}),n=URL.createObjectURL(r),l=document.createElement("a");l.href=n,l.download=I.endsWith(".ids")?I:`${I}.ids`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(n)}catch(t){console.error("Failed to generate or save IDS file:",t),alert("Error: Could not save IDS file. See console for details.")}},[y,I]),ve=o.useCallback(()=>{if(P){if(y.length===0){alert("Please add at least one specification before validating.");return}try{const t=ae(y);P(t)}catch(t){console.error("Failed to generate IDS XML for validation:",t),alert("Error: Could not generate IDS XML. See console for details.")}}},[y,P]),Se=o.useCallback(t=>{const r=t.target.files?.[0];if(!r)return;Z(r.name);const n=new FileReader;n.onload=l=>{try{const i=l.target?.result,s=Me(i);q(s),A(s[0]?.id||null)}catch(i){console.error("Failed to parse IDS file:",i),alert("Error: Could not parse IDS file. Ensure it is a valid .ids XML file.")}},n.readAsText(r),t.target.value=""},[]);return oe?e.jsx(Ie,{nodeRef:K,handle:".ids-creator-header",bounds:"parent",children:e.jsxs(ke,{ref:K,elevation:8,sx:{position:"fixed",top:140,left:40,width:900,height:C?"auto":600,minWidth:400,minHeight:C?56:300,maxWidth:"90vw",maxHeight:"80vh",display:"flex",flexDirection:"column",zIndex:1850,boxSizing:"border-box",overflow:"hidden"},children:[e.jsxs(d,{className:"ids-creator-header",sx:{display:"flex",alignItems:"center",justifyContent:"space-between",px:2,py:1,backgroundColor:"primary.main",color:"white",cursor:"move",gap:2},children:[e.jsxs(d,{sx:{display:"flex",alignItems:"center",gap:1,flex:1},children:[e.jsx(f,{variant:"subtitle1",sx:{whiteSpace:"nowrap"},children:"IDS Creator:"}),e.jsx(G,{value:I.replace(/\.ids$/,""),onChange:t=>Z(t.target.value),variant:"outlined",size:"small",placeholder:"filename",sx:{flex:1,maxWidth:300,"& .MuiOutlinedInput-root":{color:"white","& fieldset":{borderColor:"rgba(255, 255, 255, 0.3)"},"&:hover fieldset":{borderColor:"rgba(255, 255, 255, 0.5)"},"&.Mui-focused fieldset":{borderColor:"rgba(255, 255, 255, 0.7)"}},"& .MuiInputBase-input":{py:.75}}}),e.jsx(f,{variant:"body2",sx:{color:"rgba(255, 255, 255, 0.7)"},children:".ids"})]}),e.jsxs(d,{children:[e.jsx("input",{ref:Q,type:"file",accept:".ids, .xml",style:{display:"none"},onChange:Se}),e.jsx(b,{size:"small",color:"inherit",title:"Load IDS File",onClick:()=>Q.current?.click(),children:e.jsx(we,{})}),e.jsx(b,{size:"small",color:"inherit",title:"Save IDS File",onClick:ge,children:e.jsx(Ne,{})}),P&&e.jsx(b,{size:"small",color:"inherit",title:"Validate in IDS Checker",onClick:ve,disabled:y.length===0,children:e.jsx(De,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:()=>de(t=>!t),title:C?"Expand panel":"Minimize panel",children:C?e.jsx(Pe,{}):e.jsx(qe,{})}),e.jsx(b,{size:"small",color:"inherit",onClick:ce,title:"Close IDS Creator",children:e.jsx(Ae,{})})]})]}),!C&&e.jsxs(d,{sx:{flex:1,display:"flex",minHeight:0},children:[e.jsxs(d,{sx:{width:250,borderRight:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column"},children:[e.jsx(d,{sx:{p:1,borderBottom:"1px solid",borderColor:"divider"},children:e.jsx(N,{startIcon:e.jsx(Oe,{}),fullWidth:!0,variant:"outlined",onClick:xe,children:"Add Specification"})}),e.jsx(H,{sx:{overflowY:"auto",flex:1},children:y.map(t=>e.jsx(J,{disablePadding:!0,secondaryAction:e.jsx(b,{edge:"end",size:"small",title:"Delete specification",onClick:r=>{r.stopPropagation(),ue(t.id)},children:e.jsx(U,{fontSize:"small"})}),children:e.jsx(Re,{selected:t.id===c,onClick:()=>A(t.id),children:e.jsx(T,{primary:t.name})})},t.id))})]}),e.jsx(d,{sx:{flex:1,p:2,overflowY:"auto",display:"flex",flexDirection:"column",gap:2},children:m?e.jsxs(e.Fragment,{children:[e.jsx(G,{label:"Specification Name",value:m.name,onChange:pe,variant:"outlined",size:"small"}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Applicability (Which elements?)"}),e.jsxs(d,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture one or more example elements from the viewer to describe what this specification applies to."}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(N,{size:"small",variant:"outlined",onClick:()=>te("applicability"),disabled:!u,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:u?"Current viewer selection will be stored as a template.":"Select an element to enable capture."})]}),m.applicability.length?e.jsx(H,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.applicability.map((t,r)=>{const n=t;n?.ifcClass?`${n.ifcClass}${n.sourceGlobalId||"unknown"}`:n?.sourceGlobalId;const l=n?.capturedAt?new Date(n.capturedAt).toLocaleString():"";return e.jsx(J,{secondaryAction:e.jsxs(d,{sx:{display:"flex",gap:.5,alignItems:"center"},children:[e.jsx(b,{size:"small",title:"Copy to requirements",onClick:()=>ye(r),children:e.jsx($e,{fontSize:"small"})}),e.jsx(b,{edge:"end",size:"small",title:"Remove captured applicability",onClick:()=>fe("applicability",r),children:e.jsx(U,{fontSize:"small"})})]}),children:e.jsx(T,{primary:le(n),secondary:l?`Captured ${l}`:void 0})},`${n?.sourceGlobalId||"entry"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No applicability examples captured yet."})]}),e.jsx(se,{}),e.jsx(f,{variant:"h6",children:"Requirements (What must be true?)"}),e.jsxs(d,{sx:{p:2,border:"1px dashed",borderColor:"divider",borderRadius:1,display:"flex",flexDirection:"column",gap:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:"Capture the same or other elements to store property snapshots you want to enforce as requirements."}),e.jsxs(d,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:[e.jsx(N,{size:"small",variant:"outlined",onClick:()=>te("requirements"),disabled:!u,children:"Use current selection"}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{alignSelf:"center"},children:u?"Snapshot will be added to requirements.":"Select an element to enable capture."})]}),m.requirements.length?e.jsx(H,{dense:!0,sx:{border:"1px solid",borderColor:"divider",borderRadius:1,maxHeight:160,overflowY:"auto"},children:m.requirements.map((t,r)=>{const n=t,l=le(n),i=n?.capturedAt?new Date(n.capturedAt).toLocaleString():"";return e.jsxs(J,{children:[e.jsx(T,{primary:n.propertyPath?`${n.propertyPath} ${n.operator?`(${n.operator})`:""}`:l,secondary:n.propertyPath?`Expected: ${n.value??"(any)"}${i?` — captured ${i}`:""}`:i?`Captured ${i}`:void 0}),e.jsxs(ze,{children:[e.jsx(b,{size:"small",title:"Edit requirement",onClick:()=>be(r),children:e.jsx(Ee,{fontSize:"small"})}),e.jsx(b,{size:"small",title:"Remove requirement",onClick:()=>je(r),children:e.jsx(U,{fontSize:"small"})})]})]},`${n?.id||n?.sourceGlobalId||"req"}-${r}`)})}):e.jsx(f,{variant:"body2",color:"text.secondary",children:"No requirement snapshots captured yet."})]})]}):e.jsx(d,{sx:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%"},children:e.jsx(f,{color:"text.secondary",children:"Load or create a specification to begin."})})}),e.jsxs(d,{sx:{width:300,borderLeft:"1px solid",borderColor:"divider",display:"flex",flexDirection:"column",overflow:"hidden"},children:[e.jsxs(d,{sx:{p:1.5,borderBottom:"1px solid",borderColor:"divider"},children:[e.jsx(f,{variant:"subtitle2",children:"Property Sets"}),e.jsx(f,{variant:"caption",color:"text.secondary",children:R.length>0?`${R.length} properties`:"Select an element"})]}),R.length>0?e.jsx(d,{sx:{flex:1,overflowY:"auto",p:1},children:e.jsx(d,{sx:{display:"flex",flexDirection:"column",gap:1.5},children:R.map((t,r)=>e.jsxs(d,{sx:{display:"flex",flexDirection:"column",gap:.25},children:[e.jsx(f,{variant:"caption",sx:{fontWeight:600,color:"text.secondary"},children:t.label}),e.jsx(f,{variant:"body2",sx:{wordBreak:"break-word"},children:t.value})]},r))})}):D?e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"No property sets found for this element."})}):e.jsx(d,{sx:{flex:1,display:"flex",alignItems:"center",justifyContent:"center",p:2},children:e.jsx(f,{variant:"body2",color:"text.secondary",sx:{textAlign:"center"},children:"Select an element in the viewer to inspect its property sets."})})]})]}),e.jsxs(Le,{open:me,onClose:()=>k(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Be,{children:v.current!=null?"Edit Requirement":"Create Requirement"}),e.jsxs(Ve,{children:[e.jsxs(d,{sx:{display:"flex",gap:2,mt:1},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"pset-label",children:"Property Set"}),e.jsx(X,{labelId:"pset-label",value:g??"",label:"Property Set",onChange:t=>$(String(t.target.value)||null),children:Object.keys(E).length?Object.keys(E).map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]}),e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"prop-label",children:"Property"}),e.jsx(X,{labelId:"prop-label",value:w??"",label:"Property",onChange:t=>z(String(t.target.value)||null),children:g&&E[g]?E[g].map(t=>e.jsx(j,{value:t,children:t},t)):e.jsx(j,{value:"",children:"(none)"})})]})]}),e.jsxs(d,{sx:{display:"flex",gap:2,mt:2},children:[e.jsxs(_,{fullWidth:!0,children:[e.jsx(Y,{id:"op-label",children:"Operator"}),e.jsxs(X,{labelId:"op-label",value:W,label:"Operator",onChange:t=>F(String(t.target.value)),children:[e.jsx(j,{value:"exists",children:"exists"}),e.jsx(j,{value:"equals",children:"equals"}),e.jsx(j,{value:"not-equals",children:"not equals"}),e.jsx(j,{value:"contains",children:"contains"}),e.jsx(j,{value:"matches",children:"matches (regex)"})]})]}),e.jsx(G,{fullWidth:!0,label:"Value (optional)",value:M,onChange:t=>L(t.target.value)})]})]}),e.jsxs(We,{children:[e.jsx(N,{onClick:()=>{k(!1),v.current=null},children:"Cancel"}),e.jsx(N,{variant:"contained",onClick:he,startIcon:e.jsx(Fe,{}),children:v.current!=null?"Save":"Create"})]})]})]})}):null};export{_e as default};
